name: CI & Docs

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Scarica il codice
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Configura Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip' # Cache intelligente delle dipendenze

      # 3. Installa dipendenze di sistema (CRUCIALE per PyQt)
      # Senza queste, "import PyQt5" fallisce e pdoc non pu√≤ generare nulla.
      - name: Install system dependencies for Qt & Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y libegl1 libxkbcommon-x11-0 libdbus-1-3 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0 x11-utils libx11-xcb1 libxcb-shape0 libxcb-cursor0 xvfb make

      # 4. Prepara gli ambienti Python
      # Invece di usare i venv isolati del Makefile per pdoc, installiamo
      # le dipendenze nell'ambiente globale del runner. √à pi√π sicuro per la CI.
      - name: Install Python dependencies
        run: |
          pip install -r ./src/main/requirements.txt
          pip install -r ./src/tests/requirements-test.txt
          pip install pdoc pytest pytest-cov

      # 5. Esegui i TEST usando il Makefile
      # Usiamo xvfb-run per simulare il monitor, altrimenti i test GUI falliscono.
      # NOTA: Dobbiamo assicurarci che il venv dei test esista come si aspetta il Makefile
      - name: Setup Test Venv & Run Tests
        run: |
          make tests_python-setup
          xvfb-run make tests-coverage

      # 6. Genera la DOC usando il Makefile
      # Il Makefile usa "PYTHONPATH=." che va benissimo.
      # Avendo installato i requirements al punto 4, pdoc riuscir√† a importare tutto.
      - name: Generate Documentation
        run: |
          make doc

      # 7. Crea la Landing Page unificata
      - name: Create Index HTML
        run: |
          # Sposta la coverage dentro la cartella docs per averla ordinata
          mkdir -p ../pdoc/docs/coverage
          mv htmlcov/* ../pdoc/docs/coverage/
          
          # Crea la pagina menu
          echo '<!DOCTYPE html><html><head><title>GliAAns Docs</title><style>body{font-family:sans-serif;padding:50px;text-align:center;background:#f4f4f4;} .card{background:white;padding:20px;margin:20px auto;width:300px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);} a{text-decoration:none;color:#333;font-weight:bold;font-size:1.2em;} a:hover{color:#007bff;}</style></head><body><h1>GliAAns Documentation</h1><div class="card"><a href="index.html">üìñ API Documentation</a></div><div class="card"><a href="coverage/index.html">‚úÖ Test Coverage</a></div></body></html>' > ../pdoc/docs/landing.html
          
          # Rinomina index di pdoc per non andare in conflitto, o usa la landing come root
          # (Qui assumo che pdoc generi index.html, quindi rinominiamo la landing in "home.html" o simili se preferisci)
          # Per semplicit√†, sovrascriviamo l'index se necessario o gestiamo i path.
          # Trucco: spostiamo tutto in una cartella pulita per il deploy
          mkdir deploy_folder
          cp -r ../pdoc/docs/* deploy_folder/
          mv deploy_folder/landing.html deploy_folder/index.html

      # 8. Pubblica su GitHub Pages
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: deploy_folder
