name: CI & Docs

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-test-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # Dipendenze di sistema per PyQt + ambiente headless
      - name: Install system dependencies for Qt & Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libegl1 \
            libxkbcommon-x11-0 \
            libdbus-1-3 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libxcb-xfixes0 \
            libxcb-shape0 \
            libxcb-cursor0 \
            libx11-xcb1 \
            x11-utils \
            xvfb \
            make

      # Setup ambiente test tramite Makefile
      - name: Setup test environment
        working-directory: ./src
        run: |
          make tests_python-setup

      # Esegui i test con coverage (GUI-safe)
      - name: Run tests with coverage
        working-directory: ./src
        run: |
          xvfb-run make tests-coverage

      # Genera la documentazione con pdoc
      - name: Generate documentation
        working-directory: ./src
        run: |
          make doc

      - name: Prepare deploy folder
        working-directory: ./src
        run: |
          mkdir -p deploy
          
          # 1. Sposta la coverage e i doc
          mkdir -p pdoc/coverage
          mv ./tests/htmlcov/* pdoc/coverage/
          cp -r pdoc/docs deploy/
          cp -r pdoc/coverage deploy/

          # 2. Crea la Gallery Page (gallery.html)
          cat > deploy/gallery.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>GliAAns-UI Gallery</title>
            <style>
              body { font-family: sans-serif; padding: 50px; text-align: center; background: #f4f4f4; }
              .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 8px; }
              .media-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
              img, video { width: 100%; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
              .back-btn { display: inline-block; margin-top: 30px; text-decoration: none; color: #007bff; font-weight: bold; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>Project Showcase</h1>
              <div class="media-grid">
                <img src="assets/nifti_viewer.png" alt="Screenshot 1">
                <img src="assets/patient_selection.png" alt="Screenshot 2">
                <img src="assets/pipeline.png" alt="Screenshot 3">
              </div>
              <div style="margin-top: 30px;">
                <h3>Demo Video</h3>
                <video controls>
                  <source src="assets/GliAAns-UI.mp4" type="video/mp4">
                  Your browser does not support the video tag.
                </video>
              </div>
              <a href="index.html" class="back-btn">‚Üê Back to Home</a>
            </div>
          </body>
          </html>
          EOF

          # 3. Aggiorna la Landing Page (index.html) aggiungendo il bottone Gallery
          cat > deploy/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>GliAAns-UI Docs</title>
            <style>
              body { font-family: sans-serif; padding: 50px; text-align: center; background: #f4f4f4; }
              .logo { max-width: 150px; margin: 0 auto 20px; display: block; }
              .card { background: white; padding: 20px; margin: 20px auto; width: 300px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s; }
              .card:hover { transform: translateY(-5px); }
              a { text-decoration: none; color: #333; font-weight: bold; font-size: 1.2em; }
              a:hover { color: #007bff; }
            </style>
          </head>
          <body>
            <img src="GliAAns-logo.png" alt="GliAAns Logo" class="logo">
            <h1>GliAAns-UI Code Documentation</h1>
            <div class="card">
              <a href="docs/index.html">Documentation</a>
            </div>
            <div class="card">
              <a href="coverage/index.html">Test Coverage</a>
            </div>
            <div class="card">
              <a href="gallery.html"">Visual Showcase</a>
            </div>
          </body>
          </html>
          EOF

          # 4. Copia le risorse statiche (Loghi, Screenshot, Video)
          cp main/resources/GliAAns-logo.png deploy/
          mkdir -p deploy/assets
          # Assicurati che questi percorsi siano corretti rispetto alla root del repo
          cp docs/assets/*.png deploy/assets/ || true
          cp docs/assets/*.mp4 deploy/assets/ || true

      # Pubblica su GitHub Pages senza toccare la repo
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: src/deploy
          clean: true
