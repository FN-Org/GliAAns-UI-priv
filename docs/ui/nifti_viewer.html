<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>ui.nifti_viewer documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../ui.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;ui</a>

            <img src="https://fn-org.github.io/GliAAns-UI-priv/GliAAns-logo.png" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



                <ul class="memberlist">
            <li>
                    <a class="variable" href="#log">log</a>
            </li>
            <li>
                    <a class="function" href="#compute_mask_numba_mm">compute_mask_numba_mm</a>
            </li>
            <li>
                    <a class="function" href="#apply_overlay_numba">apply_overlay_numba</a>
            </li>
            <li>
                    <a class="class" href="#NiftiViewer">NiftiViewer</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#NiftiViewer.__init__">NiftiViewer</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.threads">threads</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.context">context</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.progress_dialog">progress_dialog</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.img_data">img_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.affine">affine</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.dims">dims</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.is_4d">is_4d</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.current_slices">current_slices</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.current_time">current_time</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.current_coordinates">current_coordinates</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.file_path">file_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.stretch_factors">stretch_factors</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.voxel_sizes">voxel_sizes</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.overlay_data">overlay_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.overlay_dims">overlay_dims</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.overlay_alpha">overlay_alpha</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.overlay_threshold">overlay_threshold</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.overlay_enabled">overlay_enabled</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.overlay_file_path">overlay_file_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.overlay_max">overlay_max</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.overlay_thresholded_data">overlay_thresholded_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.info_text">info_text</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.plane_labels">plane_labels</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.status_bar">status_bar</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.slice_info_label">slice_info_label</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.value_label">value_label</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.coord_label">coord_label</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.colormap">colormap</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.overlay_colors">overlay_colors</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.views">views</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.scenes">scenes</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.pixmap_items">pixmap_items</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.slice_sliders">slice_sliders</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.slice_spins">slice_spins</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.slice_labels">slice_labels</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.coord_displays">coord_displays</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.time_slider">time_slider</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.time_spin">time_spin</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.time_checkbox">time_checkbox</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.time_plot_figure">time_plot_figure</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.time_plot_canvas">time_plot_canvas</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.file_info_label">file_info_label</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.slice_navigation_label">slice_navigation_label</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.time_point_label">time_point_label</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.colormap_combo">colormap_combo</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.overlay_threshold_slider">overlay_threshold_slider</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.display_options_label">display_options_label</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.overlay_alpha_slider">overlay_alpha_slider</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.overlay_info_label">overlay_info_label</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.automaticROI_data">automaticROI_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.automatic_ROI_label">automatic_ROI_label</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.automaticROIbtn">automaticROIbtn</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.automaticROI_overlay">automaticROI_overlay</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.automaticROI_radius_slider">automaticROI_radius_slider</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.automaticROI_radius_label">automaticROI_radius_label</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.automaticROI_diff_label">automaticROI_diff_label</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.AutomaticROI_diff_slider">AutomaticROI_diff_slider</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.automaticROI_sliders_group">automaticROI_sliders_group</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.automaticROI_seed_coordinates">automaticROI_seed_coordinates</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.ROI_save_btn">ROI_save_btn</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.incrementalROI_data">incrementalROI_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.incrementalROI_checkbox">incrementalROI_checkbox</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.incrementalROI_enabled">incrementalROI_enabled</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.addOrigin_btn">addOrigin_btn</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.cancelROI_btn">cancelROI_btn</a>
                        </li>
                        <li>
                                <a class="variable" href="#NiftiViewer.incrementalROI_origins">incrementalROI_origins</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.init_ui">init_ui</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.create_control_panel">create_control_panel</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.format_info_text">format_info_text</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.create_image_display">create_image_display</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.setup_crosshairs">setup_crosshairs</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.setup_connections">setup_connections</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.show_workspace_nii_dialog">show_workspace_nii_dialog</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.open_file">open_file</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.on_file_loaded">on_file_loaded</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.on_load_error">on_load_error</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.on_load_canceled">on_load_canceled</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.initialize_display">initialize_display</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.toggle_overlay">toggle_overlay</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.update_overlay_alpha">update_overlay_alpha</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.update_overlay_threshold">update_overlay_threshold</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.update_overlay_settings">update_overlay_settings</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.slice_changed">slice_changed</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.time_changed">time_changed</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.toggle_time_controls">toggle_time_controls</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.colormap_changed">colormap_changed</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.handle_click_coordinates">handle_click_coordinates</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.screen_to_image_coords">screen_to_image_coords</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.update_coordinates">update_coordinates</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.update_coordinate_displays">update_coordinate_displays</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.update_cross_view_lines">update_cross_view_lines</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.update_display">update_display</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.setup_time_series_plot">setup_time_series_plot</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.hide_time_series_plot">hide_time_series_plot</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.update_time_series_plot">update_time_series_plot</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.apply_colormap_matplotlib">apply_colormap_matplotlib</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.update_all_displays">update_all_displays</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.create_overlay_composite">create_overlay_composite</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.resizeEvent">resizeEvent</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.fit_all_views">fit_all_views</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.update_automaticROI">update_automaticROI</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.automaticROI_clicked">automaticROI_clicked</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.toggle_automaticROI">toggle_automaticROI</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.automaticROI_drawing">automaticROI_drawing</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.ROI_save">ROI_save</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.addOrigin_clicked">addOrigin_clicked</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.toggle_incrementalROI">toggle_incrementalROI</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.closeEvent">closeEvent</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.reset_overlay">reset_overlay</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.resetROI">resetROI</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.pad_volume_to_shape">pad_volume_to_shape</a>
                        </li>
                        <li>
                                <a class="function" href="#NiftiViewer.handle_scroll">handle_scroll</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../ui.html">ui</a><wbr>.nifti_viewer    </h1>

                
                        <input id="mod-nifti_viewer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-nifti_viewer-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">nibabel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nib</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">components.crosshair_graphic_view</span><span class="w"> </span><span class="kn">import</span> <span class="n">CrosshairGraphicsView</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">components.nifti_file_dialog</span><span class="w"> </span><span class="kn">import</span> <span class="n">NiftiFileDialog</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">threads.nifti_utils_threads</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageLoadThread</span><span class="p">,</span> <span class="n">SaveNiftiThread</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="n">log</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">PyQt6</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtCore</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="c1"># Attempt to import all required PyQt6 modules and fallback gracefully if not available</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">PyQt6.QtWidgets</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">QMainWindow</span><span class="p">,</span> <span class="n">QWidget</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QHBoxLayout</span><span class="p">,</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a>                                 <span class="n">QLabel</span><span class="p">,</span> <span class="n">QSlider</span><span class="p">,</span> <span class="n">QPushButton</span><span class="p">,</span> <span class="n">QFileDialog</span><span class="p">,</span> <span class="n">QSpinBox</span><span class="p">,</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a>                                 <span class="n">QGraphicsView</span><span class="p">,</span> <span class="n">QGraphicsScene</span><span class="p">,</span> <span class="n">QGraphicsPixmapItem</span><span class="p">,</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>                                 <span class="n">QStatusBar</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QProgressDialog</span><span class="p">,</span> <span class="n">QGridLayout</span><span class="p">,</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>                                 <span class="n">QSplitter</span><span class="p">,</span> <span class="n">QFrame</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="p">,</span> <span class="n">QCheckBox</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">,</span> <span class="n">QScrollArea</span><span class="p">,</span> <span class="n">QDialog</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">,</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a>                                 <span class="n">QListWidget</span><span class="p">,</span> <span class="n">QDialogButtonBox</span><span class="p">,</span> <span class="n">QListWidgetItem</span><span class="p">,</span> <span class="n">QGroupBox</span><span class="p">)</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">PyQt6.QtCore</span><span class="w"> </span><span class="kn">import</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QPointF</span><span class="p">,</span> <span class="n">QTimer</span><span class="p">,</span> <span class="n">QThread</span><span class="p">,</span> <span class="n">pyqtSignal</span><span class="p">,</span> <span class="n">QSize</span><span class="p">,</span> <span class="n">QCoreApplication</span><span class="p">,</span> <span class="n">QRectF</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">PyQt6.QtGui</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">QPixmap</span><span class="p">,</span> <span class="n">QImage</span><span class="p">,</span> <span class="n">QPainter</span><span class="p">,</span> <span class="n">QColor</span><span class="p">,</span> <span class="n">QPen</span><span class="p">,</span> <span class="n">QPalette</span><span class="p">,</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>                             <span class="n">QBrush</span><span class="p">,</span> <span class="n">QResizeEvent</span><span class="p">,</span> <span class="n">QMouseEvent</span><span class="p">,</span> <span class="n">QTransform</span><span class="p">,</span> <span class="n">QFont</span><span class="p">)</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.figure</span><span class="w"> </span><span class="kn">import</span> <span class="n">Figure</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.backends.backend_qtagg</span><span class="w"> </span><span class="kn">import</span> <span class="n">FigureCanvasQTAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;PyQt6 not available. Install with: pip install PyQt6&quot;</span><span class="p">)</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="c1"># Configure matplotlib to use a non-interactive backend (for thread-safe rendering)</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.cm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cm</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="c1"># JIT optimization for numerical computations</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">njit</span><span class="p">,</span> <span class="n">prange</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_mask_numba_mm</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">radius_mm</span><span class="p">,</span> <span class="n">voxel_sizes</span><span class="p">,</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>                          <span class="n">seed_intensity</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>                          <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span><span class="p">):</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="sd">    Compute a binary spherical mask around a seed point in millimeter space.</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">    This function is compiled with Numba for high-performance execution and</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">    performs voxel-wise checks to include all voxels within a given radius</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">    (in mm) and within a specified intensity difference from a seed value.</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">    Args:</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="sd">        img (np.ndarray): Input 3D image array.</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">        x0, y0, z0 (int): Coordinates of the seed voxel.</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">        radius_mm (float): Radius of the spherical mask in millimeters.</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">        voxel_sizes (tuple[float, float, float]): Physical voxel sizes along each axis.</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">        seed_intensity (float): Intensity value at the seed voxel.</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="sd">        diff (float): Maximum allowed intensity difference from the seed.</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="sd">        x_min, x_max, y_min, y_max, z_min, z_max (int): Bounding box limits in voxel space.</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="sd">    Returns:</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">        np.ndarray: Binary mask (uint8) with 1 where the voxel meets the criteria.</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>    <span class="n">r2</span> <span class="o">=</span> <span class="n">radius_mm</span> <span class="o">*</span> <span class="n">radius_mm</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>    <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="n">voxel_sizes</span>  <span class="c1"># voxel dimensions in mm</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">):</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">):</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span><span class="p">):</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>                <span class="n">dx_mm</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">vx</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>                <span class="n">dy_mm</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">*</span> <span class="n">vy</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>                <span class="n">dz_mm</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">z0</span><span class="p">)</span> <span class="o">*</span> <span class="n">vz</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>                <span class="k">if</span> <span class="n">dx_mm</span> <span class="o">*</span> <span class="n">dx_mm</span> <span class="o">+</span> <span class="n">dy_mm</span> <span class="o">*</span> <span class="n">dy_mm</span> <span class="o">+</span> <span class="n">dz_mm</span> <span class="o">*</span> <span class="n">dz_mm</span> <span class="o">&lt;=</span> <span class="n">r2</span><span class="p">:</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span> <span class="o">-</span> <span class="n">seed_intensity</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>                        <span class="n">mask</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>    <span class="k">return</span> <span class="n">mask</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a><span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a><span class="k">def</span><span class="w"> </span><span class="nf">apply_overlay_numba</span><span class="p">(</span><span class="n">rgba_image</span><span class="p">,</span> <span class="n">overlay_mask</span><span class="p">,</span> <span class="n">overlay_intensity</span><span class="p">,</span> <span class="n">overlay_color</span><span class="p">):</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a><span class="sd">    Apply a semi-transparent overlay to an RGBA image.</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a><span class="sd">    This function adds colorized overlay regions based on the provided mask and</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a><span class="sd">    intensity map, applying blending only on RGB channels.</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a><span class="sd">    Args:</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="sd">        rgba_image (np.ndarray): Base image (H, W, 3) in float format (01 range).</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">        overlay_mask (np.ndarray): Binary mask (H, W) specifying overlay pixels.</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="sd">        overlay_intensity (np.ndarray): Intensity weight map (H, W) for overlay blending.</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="sd">        overlay_color (tuple[float, float, float]): RGB overlay color (01 range).</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a><span class="sd">    Returns:</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="sd">        np.ndarray: Modified RGBA image with overlay applied.</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>    <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">rgba_image</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>            <span class="k">if</span> <span class="n">overlay_mask</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]:</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>                <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>                    <span class="c1"># Apply color to RGB channels only</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>                    <span class="k">if</span> <span class="n">overlay_color</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>                        <span class="n">rgba_image</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rgba_image</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ch</span><span class="p">]</span> <span class="o">+</span> <span class="n">overlay_intensity</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="n">overlay_color</span><span class="p">[</span><span class="n">ch</span><span class="p">])</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>                        <span class="n">rgba_image</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ch</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">overlay_intensity</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">])</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>    <span class="k">return</span> <span class="n">rgba_image</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_slice</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">plane_idx</span><span class="p">,</span> <span class="n">slice_idx</span><span class="p">):</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>    <span class="nb">slice</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>    <span class="k">if</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">slice_idx</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="nb">slice</span><span class="p">)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>    <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">slice_idx</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="nb">slice</span><span class="p">)</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>    <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">slice_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>        <span class="nb">slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="nb">slice</span><span class="p">)</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid plane_idx </span><span class="si">{</span><span class="n">plane_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>    <span class="k">return</span> <span class="nb">slice</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a><span class="k">class</span><span class="w"> </span><span class="nc">NiftiViewer</span><span class="p">(</span><span class="n">QMainWindow</span><span class="p">):</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="sd">    Main application window for viewing and interacting with NIfTI images.</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a><span class="sd">    This class provides a complete NIfTI image viewer with:</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a><span class="sd">      - Triplanar slice visualization (axial, coronal, sagittal)</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a><span class="sd">      - Support for 4D volumes (time series)</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="sd">      - Overlay support for mask visualization</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">      - Interactive ROI drawing and threshold-based segmentation</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">      - Threaded image loading/saving</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a><span class="sd">    Attributes:</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="sd">        context (dict): Optional shared context for multi-component communication.</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="sd">        img_data (np.ndarray): Loaded image data.</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="sd">        overlay_data (np.ndarray): Optional overlay volume.</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">        affine (np.ndarray): Image affine transformation matrix.</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a><span class="sd">        voxel_sizes (tuple[float]): Voxel dimensions (mm).</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a><span class="sd">        current_slices (list[int]): Current indices for each viewing plane.</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a><span class="sd">        current_time (int): Current time frame (for 4D data).</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a><span class="sd">        overlay_alpha (float): Overlay transparency level.</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a><span class="sd">        overlay_threshold (float): Intensity threshold for overlay visibility.</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="sd">        colormap (str): Current colormap name used for visualization.</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a><span class="sd">        Initialize the NIfTI Viewer window and prepare all internal components.</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a><span class="sd">        Args:</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a><span class="sd">            context (dict, optional): Shared context for language translation and inter-component signaling.</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;NIfTI Image Viewer&quot;</span><span class="p">))</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setMinimumSize</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">700</span><span class="p">)</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>        <span class="c1"># === Image data variables ===</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">affine</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># axial, coronal, sagittal slice indices</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># x, y, z voxel coordinates</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stretch_factors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>        <span class="c1"># === Overlay-related attributes ===</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_dims</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha</span> <span class="o">=</span> <span class="mf">0.7</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_file_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_max</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>        <span class="c1"># === UI element placeholders ===</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plane_labels</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_info_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>        <span class="c1"># === Visualization color configuration ===</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_colors</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>            <span class="s2">&quot;gray&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>            <span class="s2">&quot;viridis&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>            <span class="s2">&quot;plasma&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>            <span class="s2">&quot;inferno&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>            <span class="s2">&quot;magma&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>            <span class="s2">&quot;hot&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>            <span class="s2">&quot;cool&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>            <span class="s2">&quot;bone&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>        <span class="p">}</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>        <span class="c1"># === Viewer components ===</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">views</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pixmap_items</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_displays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>        <span class="c1"># === Time-series visualization (for 4D data) ===</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>        <span class="c1"># === Additional UI components ===</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>        <span class="c1"># === Automatic ROI drawing ===</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automatic_ROI_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">AutomaticROI_diff_slider</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_seed_coordinates</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_origins</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>        <span class="c1"># === Initialize and connect the UI ===</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_ui</span><span class="p">()</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setup_connections</span><span class="p">()</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>        <span class="c1"># === Translation setup ===</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_translate_ui</span><span class="p">()</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>        <span class="k">if</span> <span class="n">context</span> <span class="ow">and</span> <span class="s2">&quot;language_changed&quot;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;language_changed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_translate_ui</span><span class="p">)</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a><span class="sd">        Initialize the main user interface of the NIfTI Viewer.</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="sd">        This method builds the primary application layout, including:</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="sd">        - A central widget that contains a horizontal splitter.</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a><span class="sd">        - A left control panel for user interactions (file operations, display options, etc.).</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="sd">        - A right area dedicated to image visualization.</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a><span class="sd">        - A status bar for displaying real-time information (coordinates, intensity values, slice index).</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="sd">        The layout uses a responsive design with adjustable proportions between</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a><span class="sd">        the control panel and the image display area.</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a><span class="sd">        Raises:</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a><span class="sd">            Exception: Propagates exceptions from widget creation or layout setup.</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>        <span class="c1"># Create the central widget that will contain the main splitter</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>        <span class="n">central_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setCentralWidget</span><span class="p">(</span><span class="n">central_widget</span><span class="p">)</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>        <span class="c1"># Create a horizontal splitter for side-by-side layout (control panel + image display)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>        <span class="n">main_splitter</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>        <span class="n">central_widget</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">central_widget</span><span class="p">)</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>        <span class="n">central_widget</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>        <span class="n">central_widget</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">main_splitter</span><span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>        <span class="c1"># Initialize and attach the left control panel to the splitter</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">create_control_panel</span><span class="p">(</span><span class="n">main_splitter</span><span class="p">)</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>        <span class="c1"># Initialize and attach the right image display area to the splitter</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">create_image_display</span><span class="p">(</span><span class="n">main_splitter</span><span class="p">)</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>        <span class="c1"># Define relative sizes and resizing behavior of the splitter sections</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>        <span class="n">main_splitter</span><span class="o">.</span><span class="n">setSizes</span><span class="p">([</span><span class="mi">300</span><span class="p">,</span> <span class="mi">1100</span><span class="p">])</span>  <span class="c1"># Default size proportions</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>        <span class="n">main_splitter</span><span class="o">.</span><span class="n">setStretchFactor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Fix the control panel width</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>        <span class="n">main_splitter</span><span class="o">.</span><span class="n">setStretchFactor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Allow image display to stretch</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>        <span class="c1"># Create and set up the status bar at the bottom of the window</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span> <span class="o">=</span> <span class="n">QStatusBar</span><span class="p">()</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setStatusBar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="p">)</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>        <span class="c1"># Initialize status bar labels for dynamic coordinate and voxel value display</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coordinates: (-, -, -)&quot;</span><span class="p">))</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Value: -&quot;</span><span class="p">))</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_info_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Slice: -/-&quot;</span><span class="p">))</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>        <span class="c1"># Display initial status message when the viewer is ready</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Ready - Open a NIfTI file to begin&quot;</span><span class="p">)</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>        <span class="p">)</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_control_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="sd">        Create the left-side control panel for the NIfTI Viewer interface.</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a><span class="sd">        This method builds an interactive, scrollable control panel that allows</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a><span class="sd">        the user to:</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a><span class="sd">          - Open and display NIfTI files.</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a><span class="sd">          - Navigate through 2D slices in axial, coronal, and sagittal planes.</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a><span class="sd">          - Control time navigation for 4D datasets.</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a><span class="sd">          - Adjust visualization parameters such as colormap and display options.</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a><span class="sd">          - Perform automatic ROI (Region of Interest) generation.</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a><span class="sd">          - Manage overlay images (load, transparency, threshold, enable/disable).</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a><span class="sd">        Args:</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a><span class="sd">            parent (QSplitter): The parent splitter widget where the control panel is added.</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a><span class="sd">        Raises:</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a><span class="sd">            Exception: Propagates exceptions from any UI creation or layout step.</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>        <span class="c1"># Scroll area wrapper (enables vertical scrolling for the control panel)</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>        <span class="n">scroll_area</span> <span class="o">=</span> <span class="n">QScrollArea</span><span class="p">()</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setWidgetResizable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setHorizontalScrollBarPolicy</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ScrollBarPolicy</span><span class="o">.</span><span class="n">ScrollBarAlwaysOff</span><span class="p">)</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setVerticalScrollBarPolicy</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ScrollBarPolicy</span><span class="o">.</span><span class="n">ScrollBarAsNeeded</span><span class="p">)</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>        <span class="c1"># Control panel main content widget and layout</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>        <span class="n">control_content</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>        <span class="n">control_content</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">340</span><span class="p">)</span>  <span class="c1"># Prevent horizontal scrolling</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>        <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">control_content</span><span class="p">)</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>        <span class="c1"># ========================</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>        <span class="c1"># File Operations Group</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>        <span class="c1"># ========================</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>        <span class="n">file_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>        <span class="n">file_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">file_group</span><span class="p">)</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>        <span class="n">file_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>        <span class="c1"># Button to open NIfTI files</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot; Open NIfTI&quot;</span><span class="p">))</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Open NIfTI File&quot;</span><span class="p">))</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>        <span class="n">file_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="p">)</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>        <span class="c1"># Label displaying currently loaded file info</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No file loaded&quot;</span><span class="p">))</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setWordWrap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>        <span class="n">file_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="p">)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">file_group</span><span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>        <span class="c1"># =====================</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>        <span class="c1"># Slice Navigation</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>        <span class="c1"># =====================</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>        <span class="n">slice_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>        <span class="n">slice_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">slice_group</span><span class="p">)</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>        <span class="n">slice_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>        <span class="c1"># Section label</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Slice Navigation:&quot;</span><span class="p">))</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; font-size: 11px;&quot;</span><span class="p">)</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>        <span class="n">slice_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span><span class="p">)</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>        <span class="n">plane_names</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Axial (Z)&quot;</span><span class="p">),</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coronal (Y)&quot;</span><span class="p">),</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Sagittal (X)&quot;</span><span class="p">)</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>        <span class="p">]</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plane_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>        <span class="c1"># Create controls for each anatomical plane</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">plane_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plane_names</span><span class="p">):</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>            <span class="c1"># Label for plane name</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>            <span class="n">label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">plane_name</span><span class="p">)</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plane_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>            <span class="n">label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; margin-top: 10px;&quot;</span><span class="p">)</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>            <span class="n">label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>            <span class="n">slice_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>            <span class="c1"># Container for slider + spinbox + coordinates</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>            <span class="n">controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>            <span class="n">controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">controls_widget</span><span class="p">)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>            <span class="n">controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>            <span class="n">controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>            <span class="c1"># Slice slider</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>            <span class="n">slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>            <span class="n">slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>            <span class="n">slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>            <span class="n">slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>            <span class="n">slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>            <span class="n">controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>            <span class="c1"># Spinbox to match slider</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>            <span class="n">spinbox</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>            <span class="n">controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">spinbox</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>            <span class="c1"># Coordinate label display</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>            <span class="n">coord_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;(-, -)&quot;</span><span class="p">)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="n">coord_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: #4CAF50; font-weight: bold; font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>            <span class="n">coord_label</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>            <span class="n">coord_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>            <span class="n">coord_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>            <span class="n">controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">coord_label</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>            <span class="n">controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>            <span class="n">slice_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">controls_widget</span><span class="p">)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>            <span class="c1"># Store references</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slider</span><span class="p">)</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spinbox</span><span class="p">)</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coord_displays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord_label</span><span class="p">)</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">slice_group</span><span class="p">)</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>        <span class="c1"># ===================</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>        <span class="c1">#  4D Time Controls</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>        <span class="c1"># ===================</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>        <span class="n">time_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_group</span><span class="p">)</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>        <span class="n">time_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>        <span class="c1"># Enable time navigation</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Enable 4D Time Navigation&quot;</span><span class="p">))</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>        <span class="n">time_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="p">)</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>        <span class="c1"># Slider + spinbox controls for time navigation</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>        <span class="n">time_controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>        <span class="n">time_controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">time_controls_widget</span><span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>        <span class="n">time_controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>        <span class="n">time_controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>        <span class="n">time_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>        <span class="n">time_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Time Point:&quot;</span><span class="p">))</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 11px;&quot;</span><span class="p">)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>        <span class="n">time_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="p">)</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>        <span class="n">time_controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>        <span class="n">time_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">time_controls_widget</span><span class="p">)</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_group</span><span class="p">)</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>        <span class="c1"># ======================</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>        <span class="c1">#  Display Options</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>        <span class="c1"># ======================</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>        <span class="n">display_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>        <span class="n">display_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">display_group</span><span class="p">)</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>        <span class="n">display_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Display Options:&quot;</span><span class="p">))</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; font-size: 11px;&quot;</span><span class="p">)</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>        <span class="n">display_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span><span class="p">)</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>        <span class="c1"># Colormap selection dropdown</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>        <span class="n">colormap_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>        <span class="n">colormap_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">colormap_widget</span><span class="p">)</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>        <span class="n">colormap_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>        <span class="n">colormap_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Colormap:&quot;</span><span class="p">))</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px; font-weight: bold;&quot;</span><span class="p">)</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>        <span class="n">colormap_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colormap_label</span><span class="p">)</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">()</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>            <span class="p">[</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="s1">&#39;plasma&#39;</span><span class="p">,</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>             <span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="s1">&#39;hot&#39;</span><span class="p">,</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>             <span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="s1">&#39;bone&#39;</span><span class="p">])</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>        <span class="n">colormap_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="p">)</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>        <span class="n">colormap_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>        <span class="n">display_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">colormap_widget</span><span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">display_group</span><span class="p">)</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>        <span class="c1"># ==========================</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>        <span class="c1"># Automatic ROI Controls</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>        <span class="c1"># ==========================</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>        <span class="c1"># Automatic ROI</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>        <span class="n">automaticROI_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_group</span><span class="p">)</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automatic_ROI_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic ROI:&quot;</span><span class="p">))</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automatic_ROI_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automatic_ROI_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px; font-weight: bold;&quot;</span><span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automatic_ROI_label</span><span class="p">)</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>        <span class="n">automaticROIbtns_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>        <span class="n">automaticROIbtns_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">automaticROIbtns_group</span><span class="p">)</span>  <span class="c1"># Cambiato a verticale</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>        <span class="n">automaticROIbtns_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>        <span class="n">automaticROIbtns_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic ROI&quot;</span><span class="p">))</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic ROI Drawing&quot;</span><span class="p">))</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>        <span class="n">automaticROIbtns_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="p">)</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Fix ROI and add new Origin&quot;</span><span class="p">))</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Increment the current incremental ROI with the current ROI drawing&quot;</span><span class="p">))</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>        <span class="n">automaticROIbtns_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="p">)</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>        <span class="n">automaticROIbtns_group</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">automaticROIbtns_group</span><span class="p">)</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>        <span class="c1"># Incremental ROI checkbox</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Show incremental ROI&quot;</span><span class="p">))</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="p">)</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>        <span class="c1"># Overlay enable/disable checkbox</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Show automatic ROI&quot;</span><span class="p">))</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="p">)</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>        <span class="n">automaticROI_sliders_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="p">)</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>        <span class="n">automaticROI_sliders_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Radius:&quot;</span><span class="p">))</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>        <span class="n">automaticROI_sliders_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_label</span><span class="p">)</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>        <span class="c1"># Radius slider and spinbox container</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>        <span class="n">radius_controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>        <span class="n">radius_controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">radius_controls_widget</span><span class="p">)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>        <span class="n">radius_controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>        <span class="n">radius_controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span>  <span class="c1"># Valore sufficientemente alto per gestire tutti i casi</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>        <span class="n">radius_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span>  <span class="c1"># Valore sufficientemente alto per gestire tutti i casi</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>        <span class="n">radius_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>        <span class="n">radius_controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>        <span class="n">automaticROI_sliders_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">radius_controls_widget</span><span class="p">)</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Difference:&quot;</span><span class="p">))</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>        <span class="n">automaticROI_sliders_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_label</span><span class="p">)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>        <span class="c1"># Difference slider and spinbox container</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>        <span class="n">diff_controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>        <span class="n">diff_controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">diff_controls_widget</span><span class="p">)</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>        <span class="n">diff_controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>        <span class="n">diff_controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">99999</span><span class="p">)</span>  <span class="c1"># Valore molto alto per gestire qualsiasi range di intensit</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>        <span class="n">diff_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">99999</span><span class="p">)</span>  <span class="c1"># Valore molto alto per gestire qualsiasi range di intensit</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>        <span class="n">diff_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>        <span class="n">diff_controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>        <span class="n">automaticROI_sliders_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">diff_controls_widget</span><span class="p">)</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">)</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="p">)</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>        <span class="n">automaticROI_bottom_btns_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>        <span class="n">automaticROIb_bottom_btns_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">automaticROI_bottom_btns_group</span><span class="p">)</span>  <span class="c1"># Cambiato a verticale</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>        <span class="n">automaticROIb_bottom_btns_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>        <span class="n">automaticROIb_bottom_btns_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Save ROI&quot;</span><span class="p">))</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a><span class="s2">                    QPushButton {</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a><span class="s2">                    font-weight: bold;</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a><span class="s2">                    color:#27ae60 }</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a><span class="s2">                    QPushButton:disabled {</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a><span class="s2">                    color:none;</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a><span class="s2">                    font-weight: normal</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a><span class="s2">                    }&quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Save ROI Drawing&quot;</span><span class="p">))</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>        <span class="n">automaticROIb_bottom_btns_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="p">)</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Cancel ROI&quot;</span><span class="p">))</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="s2">                            QPushButton {</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="s2">                            font-weight: bold;</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="s2">                            color:#c0392b }</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="s2">                            QPushButton:disabled {</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a><span class="s2">                            color:none;</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="s2">                            font-weight: normal</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a><span class="s2">                            }&quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Cancel ROI Drawing&quot;</span><span class="p">))</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>        <span class="n">automaticROIb_bottom_btns_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="p">)</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">automaticROI_bottom_btns_group</span><span class="p">)</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_group</span><span class="p">)</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>        <span class="c1"># Overlay controls</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>        <span class="n">overlay_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>        <span class="n">overlay_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">overlay_group</span><span class="p">)</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay Controls:&quot;</span><span class="p">))</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; font-size: 11px;&quot;</span><span class="p">)</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span><span class="p">)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>        <span class="c1"># Overlay file button</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Load Overlay&quot;</span><span class="p">))</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Enable only when base image is loaded</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Load NIfTI Overlay&quot;</span><span class="p">))</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="p">)</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>        <span class="c1"># Overlay enable/disable checkbox</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Show Overlay&quot;</span><span class="p">))</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="p">)</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>        <span class="c1"># Overlay alpha slider</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_overlay_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay Transparency:&quot;</span><span class="p">))</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_overlay_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_overlay_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_overlay_label</span><span class="p">)</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>        <span class="c1"># Alpha slider and spinbox container</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>        <span class="n">alpha_controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>        <span class="n">alpha_controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">alpha_controls_widget</span><span class="p">)</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>        <span class="n">alpha_controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>        <span class="n">alpha_controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">70</span><span class="p">)</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>        <span class="n">alpha_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">70</span><span class="p">)</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>        <span class="n">alpha_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>        <span class="n">alpha_controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">alpha_controls_widget</span><span class="p">)</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>        <span class="c1"># Overlay threshold slider</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay Threshold:&quot;</span><span class="p">))</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_label</span><span class="p">)</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>        <span class="c1"># Threshold slider and spinbox container</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>        <span class="n">threshold_controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>        <span class="n">threshold_controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">threshold_controls_widget</span><span class="p">)</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>        <span class="n">threshold_controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>        <span class="n">threshold_controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>        <span class="n">threshold_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>        <span class="n">threshold_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>        <span class="n">threshold_controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">threshold_controls_widget</span><span class="p">)</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>        <span class="c1"># Overlay info</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No overlay loaded&quot;</span><span class="p">))</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setWordWrap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">)</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>        <span class="c1"># Imposta larghezza massima per prevenire espansione</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="p">)</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">overlay_group</span><span class="p">)</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>        <span class="c1"># Add stretch to push everything to top</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addStretch</span><span class="p">()</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>        <span class="c1"># Set the content inside the QScrollArea</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="n">control_content</span><span class="p">)</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>        <span class="c1"># Set dimensions to eliminate horizontal scrolling</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">240</span><span class="p">)</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">340</span><span class="p">)</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>        <span class="c1"># Signal/slot connections to synchronize slider and spinbox</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>        <span class="c1"># Automatic ROI - Radius</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>        <span class="c1"># Automatic ROI - Difference</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>        <span class="c1"># Overlay - Alpha/Transparency</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>        <span class="c1"># Overlay - Threshold</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>        <span class="c1"># Add scroll area to parent</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>        <span class="n">parent</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">scroll_area</span><span class="p">)</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">format_info_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">max_line_length</span><span class="o">=</span><span class="mi">35</span><span class="p">):</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a><span class="sd">        Format text to prevent horizontal scrolling in the control panel.</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a><span class="sd">        This helper function ensures that long lines of information (such as</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a><span class="sd">        NIfTI file metadata) are wrapped neatly to fit within the UI, avoiding</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a><span class="sd">        horizontal overflow. It also attempts to break lines at logical points</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a><span class="sd">        (e.g., after colons or spaces) for improved readability.</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a><span class="sd">        Args:</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a><span class="sd">            text (str): The text to be formatted.</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a><span class="sd">            max_line_length (int, optional): Maximum number of characters per line</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a><span class="sd">                before wrapping. Defaults to 35.</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a><span class="sd">        Returns:</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a><span class="sd">            str: The formatted text with inserted line breaks for better layout.</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">textwrap</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>        <span class="c1"># Split text into lines to process them individually</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>        <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>        <span class="n">formatted_lines</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>            <span class="c1"># If the line fits within limit, keep it unchanged</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_line_length</span><span class="p">:</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>                <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>                <span class="c1"># Try to split logically around &#39;:&#39; if possible</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>                <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>                    <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">max_line_length</span><span class="p">:</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>                        <span class="c1"># Add the first part and indent the continuation</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>                        <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>                        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">width</span><span class="o">=</span><span class="n">max_line_length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>                        <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">wrapped</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="p">))</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>                        <span class="c1"># If even the key part is long, wrap entire line</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>                        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">max_line_length</span><span class="p">)</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>                        <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wrapped</span><span class="p">)</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>                    <span class="c1"># Wrap normally if no logical split point found</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>                    <span class="n">wrapped</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">max_line_length</span><span class="p">)</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>                    <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wrapped</span><span class="p">)</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>        <span class="c1"># Join all formatted lines back into a single string</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_lines</span><span class="p">)</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_image_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a><span class="sd">        Create the main image display panel with three anatomical views.</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a><span class="sd">        This function builds the right-hand visualization area of the NIfTI viewer,</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a><span class="sd">        which displays axial, coronal, and sagittal image slices. It also prepares</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a><span class="sd">        a fourth panel for displaying image information or time-series plots</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a><span class="sd">        (depending on whether the dataset is 3D or 4D).</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a><span class="sd">        Args:</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a><span class="sd">            parent (QSplitter): The parent splitter widget where the display</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a><span class="sd">                area is added.</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a><span class="sd">        Components:</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a><span class="sd">            - Three synchronized image views with crosshairs.</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a><span class="sd">            - A fourth panel for displaying image metadata or 4D time plots.</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a><span class="sd">            - Dynamically initialized graphics scenes and pixmap items.</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a><span class="sd">        Raises:</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a><span class="sd">            Exception: Propagates initialization errors in UI creation.</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>        <span class="c1"># Create base container and grid layout for the 2x2 view grid</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>        <span class="n">display_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>        <span class="n">display_layout</span> <span class="o">=</span> <span class="n">QGridLayout</span><span class="p">(</span><span class="n">display_widget</span><span class="p">)</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>        <span class="n">display_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>        <span class="c1"># Define positions for the three main anatomical views</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>        <span class="n">view_positions</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>        <span class="n">view_titles</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Axial&quot;</span><span class="p">),</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coronal&quot;</span><span class="p">),</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Sagittal&quot;</span><span class="p">)</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        <span class="p">]</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">view_titles_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>        <span class="c1"># Iterate through each anatomical plane and create a visualization frame</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">view_positions</span><span class="p">):</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>            <span class="c1"># Create container with border style</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>            <span class="n">view_container</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>            <span class="n">view_container</span><span class="o">.</span><span class="n">setFrameStyle</span><span class="p">(</span><span class="n">QFrame</span><span class="o">.</span><span class="n">Shape</span><span class="o">.</span><span class="n">StyledPanel</span><span class="p">)</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>            <span class="n">container_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">view_container</span><span class="p">)</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>            <span class="n">container_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>            <span class="c1"># Title label (Axial, Coronal, Sagittal)</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>            <span class="n">title_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">view_titles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view_titles_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title_label</span><span class="p">)</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>            <span class="n">title_label</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignmentFlag</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>            <span class="n">title_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; padding: 4px;&quot;</span><span class="p">)</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>            <span class="n">container_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">title_label</span><span class="p">)</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>            <span class="c1"># Initialize graphics view for image rendering</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>            <span class="n">view</span> <span class="o">=</span> <span class="n">CrosshairGraphicsView</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>            <span class="n">view</span><span class="o">.</span><span class="n">setMinimumSize</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>            <span class="n">view</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">)</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>            <span class="c1"># Create graphics scene for the view</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>            <span class="n">scene</span> <span class="o">=</span> <span class="n">QGraphicsScene</span><span class="p">()</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>            <span class="n">view</span><span class="o">.</span><span class="n">setScene</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>            <span class="c1"># Create pixmap item (the actual displayed image)</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>            <span class="n">pixmap_item</span> <span class="o">=</span> <span class="n">QGraphicsPixmapItem</span><span class="p">()</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>            <span class="n">scene</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">pixmap_item</span><span class="p">)</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>            <span class="c1"># Add view to its container layout</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>            <span class="n">container_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>            <span class="c1"># Place container in grid layout</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>            <span class="n">display_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">view_container</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>            <span class="c1"># Keep references for later updates/redraws</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pixmap_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pixmap_item</span><span class="p">)</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>        <span class="c1"># ==============================</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>        <span class="c1">#  Fourth Panel (Info / Plot)</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>        <span class="c1"># ==============================</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>        <span class="c1"># Bottom-right panel for metadata or time-series visualization</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_widget</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_widget</span><span class="o">.</span><span class="n">setFrameStyle</span><span class="p">(</span><span class="n">QFrame</span><span class="o">.</span><span class="n">Shape</span><span class="o">.</span><span class="n">StyledPanel</span><span class="p">)</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>        <span class="n">fourth_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fourth_widget</span><span class="p">)</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>        <span class="c1"># Section title</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Image Information&quot;</span><span class="p">))</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignmentFlag</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; padding: 4px;&quot;</span><span class="p">)</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>        <span class="n">fourth_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="p">)</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>        <span class="c1"># Content container allows swapping between info text and plots</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_content</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_content_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fourth_content</span><span class="p">)</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>        <span class="c1"># Default info label (shown when no image is loaded)</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No image loaded&quot;</span><span class="p">))</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignmentFlag</span><span class="o">.</span><span class="n">AlignTop</span><span class="p">)</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: #cccccc; font-size: 11px; padding: 10px;&quot;</span><span class="p">)</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setWordWrap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_content_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="p">)</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>        <span class="c1"># Placeholders for 4D time-series plotting (initialized later)</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_widget</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_indicator_line</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>        <span class="c1"># Add dynamic content area to layout</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>        <span class="n">fourth_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fourth_content</span><span class="p">)</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>        <span class="c1"># Add the fourth widget to the main grid (bottom-right cell)</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>        <span class="n">display_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fourth_widget</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>        <span class="c1"># Attach the full display grid to the parent splitter</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>        <span class="n">parent</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">display_widget</span><span class="p">)</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>        <span class="c1"># Delay setup of interactive crosshairs until UI is ready</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>        <span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_crosshairs</span><span class="p">)</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_crosshairs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a><span class="sd">        Initialize and configure crosshair overlays for all active image views.</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a><span class="sd">        This method ensures that each anatomical view (axial, coronal, sagittal)</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a><span class="sd">        has its own interactive crosshair layer properly initialized.</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a><span class="sd">        Purpose:</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a><span class="sd">            - Enables visual reference lines for voxel coordinates.</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a><span class="sd">            - Synchronizes navigation across views.</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a><span class="sd">        Returns:</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a><span class="sd">            None</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>        <span class="c1"># Iterate over all graphics views and initialize their crosshairs</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">:</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>            <span class="n">view</span><span class="o">.</span><span class="n">setup_crosshairs</span><span class="p">()</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a><span class="sd">        Establish all signal-slot connections for the viewer interface.</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a><span class="sd">        This method binds user interface widgets (buttons, sliders, spin boxes, checkboxes)</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a><span class="sd">        to their respective event handlers to enable interactive control over the</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a><span class="sd">        visualization and processing of NIfTI images.</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a><span class="sd">        Connections include:</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a><span class="sd">            - File operations (open base and overlay images)</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a><span class="sd">            - Slice navigation (sliders and spinboxes)</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a><span class="sd">            - ROI (Region of Interest) automation controls</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a><span class="sd">            - Time series navigation (for 4D datasets)</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a><span class="sd">            - Colormap and overlay adjustments</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a><span class="sd">            - Coordinate updates between synchronized views</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a><span class="sd">        Returns:</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a><span class="sd">            None</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>        <span class="c1"># File-related connections</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">())</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">is_overlay</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_overlay</span><span class="p">)</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_overlay_alpha</span><span class="p">)</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_overlay_threshold</span><span class="p">)</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>        <span class="c1"># Slice navigation connections</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>        <span class="c1"># Connect slice sliders and spinboxes for all anatomical planes</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">slider</span><span class="p">,</span> <span class="n">spinbox</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">)):</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>            <span class="n">slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_changed</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_changed</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>        <span class="c1"># Automatic ROI Drawing controls</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_clicked</span><span class="p">)</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_automaticROI</span><span class="p">)</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_automaticROI</span><span class="p">)</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_save</span><span class="p">)</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_automaticROI</span><span class="p">)</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_clicked</span><span class="p">)</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_incrementalROI</span><span class="p">)</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resetROI</span><span class="p">)</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>        <span class="c1"># Time-series control connections (for 4D images)</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_time_controls</span><span class="p">)</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_changed</span><span class="p">)</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_changed</span><span class="p">)</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>        <span class="c1"># Colormap control</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="o">.</span><span class="n">currentTextChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colormap_changed</span><span class="p">)</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>        <span class="c1"># Coordinate synchronization across views</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">:</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>            <span class="n">view</span><span class="o">.</span><span class="n">coordinate_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_coordinates</span><span class="p">)</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">show_workspace_nii_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_overlay</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a><span class="sd">        Open a workspace-aware file selection dialog for NIfTI files.</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a><span class="sd">        Depending on the mode (`is_overlay`), this dialog either selects</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a><span class="sd">        a base anatomical image or a secondary overlay image from the users workspace.</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a><span class="sd">        Args:</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a><span class="sd">            is_overlay (bool, optional): Whether the dialog is for selecting an overlay file.</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a><span class="sd">                Defaults to False.</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a><span class="sd">        Returns:</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a><span class="sd">            None: If a file is selected, it triggers `open_file()` automatically.</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>        <span class="c1"># Select file using NiftiFileDialog, filtering appropriately</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>        <span class="k">if</span> <span class="n">is_overlay</span><span class="p">:</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">NiftiFileDialog</span><span class="o">.</span><span class="n">get_files</span><span class="p">(</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>                <span class="n">allow_multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>                <span class="n">has_existing_func</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>                <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>                <span class="n">forced_filters</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>            <span class="p">)</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">NiftiFileDialog</span><span class="o">.</span><span class="n">get_files</span><span class="p">(</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>                <span class="n">allow_multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>                <span class="n">has_existing_func</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>                <span class="n">label</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>            <span class="p">)</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>        <span class="c1"># Open file if a valid selection was made</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">is_overlay</span><span class="o">=</span><span class="n">is_overlay</span><span class="p">)</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">open_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_overlay</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a><span class="sd">        Load a NIfTI file (base or overlay) using a background thread.</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a><span class="sd">        This method either opens a file dialog for selecting a NIfTI file</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a><span class="sd">        or loads a specified path directly. The loading process runs in a</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a><span class="sd">        separate thread to keep the UI responsive, with progress reported</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a><span class="sd">        via a modal progress dialog.</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a><span class="sd">        Args:</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a><span class="sd">            file_path (str, optional): Path to the NIfTI file to load. If None,</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a><span class="sd">                a file dialog will be displayed.</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a><span class="sd">            is_overlay (bool, optional): Whether the file being opened is an overlay</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a><span class="sd">                (requires a base image to be already loaded). Defaults to False.</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a><span class="sd">        Raises:</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a><span class="sd">            RuntimeError: If the overlay is loaded without a base image.</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>        <span class="c1"># Prevent overlay loading without a base image</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>        <span class="k">if</span> <span class="n">is_overlay</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>                <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Warning&quot;</span><span class="p">),</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Please load a base image first!&quot;</span><span class="p">)</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>            <span class="p">)</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No base image&quot;</span><span class="p">)</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>            <span class="k">return</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>        <span class="c1"># Show file dialog if no path is provided</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>        <span class="k">if</span> <span class="n">file_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_workspace_nii_dialog</span><span class="p">(</span><span class="n">is_overlay</span><span class="o">=</span><span class="n">is_overlay</span><span class="p">)</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="p">:</span>  <span class="c1"># User canceled the dialog</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>                <span class="k">return</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>        <span class="c1"># Start file loading process</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>        <span class="k">if</span> <span class="n">file_path</span><span class="p">:</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>            <span class="c1"># Create and configure progress dialog</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span> <span class="o">=</span> <span class="n">QProgressDialog</span><span class="p">(</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Loading NIfTI file...&quot;</span><span class="p">),</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Cancel&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="bp">self</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>            <span class="p">)</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">setWindowModality</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WindowModality</span><span class="o">.</span><span class="n">WindowModal</span><span class="p">)</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">setMinimumDuration</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>            <span class="c1"># Launch threaded image loading</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ImageLoadThread</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">is_overlay</span><span class="p">))</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_file_loaded</span><span class="p">)</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_load_error</span><span class="p">)</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>            <span class="c1"># Allow user to cancel the loading process</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">canceled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_load_canceled</span><span class="p">)</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>            <span class="c1"># Save file path to appropriate variable</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>            <span class="k">if</span> <span class="n">is_overlay</span><span class="p">:</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">overlay_file_path</span> <span class="o">=</span> <span class="n">file_path</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_file_loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_data</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">affine</span><span class="p">,</span> <span class="n">is_4d</span><span class="p">,</span> <span class="n">is_overlay</span><span class="p">):</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a><span class="sd">        Handle successful completion of a NIfTI file loading operation.</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a><span class="sd">        This method is called when the background loading thread finishes without errors.</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a><span class="sd">        It manages both base image and overlay image loading results.</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a><span class="sd">        Args:</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a><span class="sd">            img_data (numpy.ndarray): Loaded image data array.</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a><span class="sd">            dims (tuple): Dimensions of the loaded image (e.g., (X, Y, Z) or (X, Y, Z, T)).</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a><span class="sd">            affine (numpy.ndarray): Affine transformation matrix defining voxel-to-world mapping.</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a><span class="sd">            is_4d (bool): Whether the loaded image is a 4D time series.</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a><span class="sd">            is_overlay (bool): Whether the loaded file is an overlay rather than a base image.</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a><span class="sd">        Returns:</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a><span class="sd">            None</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading NIfTI image...&quot;</span><span class="p">)</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>        <span class="c1"># Disconnect progress dialog cancel signal and close it</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">canceled</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Remove the finished thread&quot;</span><span class="p">)</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>        <span class="c1"># Remove the finished thread from active threads list</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>        <span class="n">thread_to_cancel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread_to_cancel</span><span class="p">)</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>        <span class="c1"># ---------------------------------------------------</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>        <span class="c1"># Handle overlay image loading</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>        <span class="c1"># ---------------------------------------------------</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>        <span class="k">if</span> <span class="n">is_overlay</span><span class="p">:</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>            <span class="c1"># Store overlay data and its dimensions</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">=</span> <span class="n">img_data</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_dims</span> <span class="o">=</span> <span class="n">dims</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>            <span class="c1"># Check for dimension mismatch and apply padding if necessary</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;dims&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>                    <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>                    <span class="s2">&quot;Dimensions mismatch!&quot;</span><span class="p">,</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>                    <span class="sa">f</span><span class="s2">&quot;The main image has dimensions </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> and the overlay has dimensions </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>                <span class="p">)</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_volume_to_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>            <span class="c1"># Update overlay information label</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_file_path</span><span class="p">)</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>                <span class="sa">f</span><span class="s2">&quot;Overlay: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span> <span class="o">+</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>                <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_dims</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>            <span class="p">)</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Activate the UI&quot;</span><span class="p">)</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>            <span class="c1"># Enable and activate overlay in UI</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">toggle_overlay</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Update overlay threshold&quot;</span><span class="p">)</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_overlay_threshold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Update display settings&quot;</span><span class="p">)</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>            <span class="c1"># Refresh display with updated overlay settings</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_overlay_settings</span><span class="p">(</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Update all displays&quot;</span><span class="p">)</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Finished loading NIfTI image, updating checkbox&quot;</span><span class="p">)</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating status bar&quot;</span><span class="p">)</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>            <span class="c1"># Update status bar message</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay loaded&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>            <span class="p">)</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>        <span class="c1"># ---------------------------------------------------</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>        <span class="c1"># Handle base image loading</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>        <span class="c1"># ---------------------------------------------------</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>            <span class="c1"># Reset any existing overlay and ROI tools</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reset_overlay</span><span class="p">()</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>            <span class="c1"># Store loaded base image attributes</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="n">dims</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">affine</span> <span class="o">=</span> <span class="n">affine</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="o">=</span> <span class="n">is_4d</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">affine</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># Compute voxel size in mm</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>            <span class="c1"># Compose file information text</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>            <span class="k">if</span> <span class="n">is_4d</span><span class="p">:</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>                <span class="c1"># 4D image information</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>                <span class="n">info_text</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;File&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>                            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>                            <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>                            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;4D Time Series&quot;</span><span class="p">)</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>                <span class="c1"># Enable time-series group and plot setup</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">setup_time_series_plot</span><span class="p">()</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>                <span class="c1"># 3D volume information</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>                <span class="n">info_text</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;File&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>                            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>                            <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>                            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;3D Volume&quot;</span><span class="p">)</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>                <span class="c1"># Disable time controls for 3D data</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hide_time_series_plot</span><span class="p">()</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>            <span class="c1"># Update status bar layout and messages</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">clearMessage</span><span class="p">()</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span><span class="p">)</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">addPermanentWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_info_label</span><span class="p">)</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">addPermanentWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value_label</span><span class="p">)</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>            <span class="c1"># Enable ROI controls</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic ROI&quot;</span><span class="p">))</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>            <span class="c1"># Update information panel</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">info_text</span><span class="p">)</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">info_text</span><span class="p">)</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>            <span class="c1"># Initialize visual display of loaded data</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_display</span><span class="p">()</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">resetROI</span><span class="p">()</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reset_overlay</span><span class="p">()</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_load_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_message</span><span class="p">):</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a><span class="sd">        Handle errors during NIfTI file loading.</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a><span class="sd">        Displays an error message, logs the issue, and cleans up any pending thread.</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a><span class="sd">        Args:</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a><span class="sd">            error_message (str): Error message returned by the worker thread.</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a><span class="sd">        Returns:</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a><span class="sd">            None</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>        <span class="c1"># Disconnect cancel signal and close progress dialog</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">canceled</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>        <span class="c1"># Display critical error dialog</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Error Loading File&quot;</span><span class="p">),</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Failed to load NIfTI file&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="se">\n</span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>        <span class="p">)</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>        <span class="c1"># Log the critical error message</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading NIfTI file: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>        <span class="c1"># Remove failed thread from thread list</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>        <span class="n">thread_to_cancel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>        <span class="k">if</span> <span class="n">thread_to_cancel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread_to_cancel</span><span class="p">)</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_load_canceled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a><span class="sd">        Handle manual cancellation of the NIfTI file loading process.</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a><span class="sd">        Terminates the most recent loading thread and removes it from</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a><span class="sd">        the active thread list to prevent resource leakage.</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a><span class="sd">        Returns:</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a><span class="sd">            None</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a><span class="sd">        Initialize and configure the viewer display after a NIfTI file is loaded.</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a><span class="sd">        Sets up slice navigation controls, initializes time-series sliders for 4D data,</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a><span class="sd">        updates current coordinates, and enables overlay controls.</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a><span class="sd">        Returns:</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a><span class="sd">            None</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>            <span class="k">return</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>        <span class="c1"># Determine spatial dimension order (reverse for display consistency)</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>        <span class="n">spatial_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>        <span class="c1"># Configure slice sliders and spin boxes</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>            <span class="n">max_slice</span> <span class="o">=</span> <span class="n">spatial_dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">max_slice</span><span class="p">)</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">max_slice</span><span class="p">)</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_slice</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># Start in the middle slice</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>        <span class="c1"># Configure time slider and spinbox for 4D datasets</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>            <span class="n">max_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">max_time</span><span class="p">)</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">max_time</span><span class="p">)</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">toggle_time_controls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>        <span class="c1"># Initialize coordinate tracking</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>  <span class="c1"># X coordinate</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># Y coordinate</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Z coordinate</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>        <span class="p">]</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>        <span class="c1"># Update all displays and coordinate readouts</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_coordinate_displays</span><span class="p">()</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>        <span class="c1"># Enable overlay loading button after successful image load</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_overlay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a><span class="sd">        Enable or disable the overlay display on top of the base image.</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a><span class="sd">        Args:</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a><span class="sd">            enabled (bool): Whether to enable (True) or disable (False) the overlay display.</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a><span class="sd">        Behavior:</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a><span class="sd">            - Toggles transparency and threshold controls.</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a><span class="sd">            - Refreshes all active views if overlay data exists.</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a><span class="sd">        Returns:</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a><span class="sd">            None</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>        <span class="c1"># Update internal overlay state</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="o">=</span> <span class="n">enabled</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>        <span class="c1"># Enable or disable overlay-related UI controls</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>        <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>            <span class="c1"># Redraw display if overlay data is available</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Update all display.&quot;</span><span class="p">)</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Update time series plot&quot;</span><span class="p">)</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>            <span class="c1"># Update time series plot if available</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_time_series_plot</span><span class="p">()</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_overlay_alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a><span class="sd">        Update overlay transparency (alpha blending).</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a><span class="sd">        Args:</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a><span class="sd">            value (int): Slider value representing overlay opacity (0100).</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a><span class="sd">        Notes:</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a><span class="sd">            Converts the integer slider value to a float ratio (0.01.0) and</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a><span class="sd">            refreshes the display only if the overlay is active and data is loaded.</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_overlay_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a><span class="sd">        Update overlay intensity threshold.</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a><span class="sd">        Args:</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a><span class="sd">            value (int): Slider value representing overlay threshold (0100).</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a><span class="sd">        Notes:</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a><span class="sd">            Adjusts visibility cutoff for overlay voxels and refreshes display</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a><span class="sd">            when overlay is active and data is present.</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>            <span class="c1"># Determine overlay threshold</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>            <span class="n">threshold_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_max</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>            <span class="c1"># Create boolean mask of overlay pixels above threshold</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">&gt;</span> <span class="n">threshold_value</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>            <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_overlay_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a><span class="sd">        Synchronize overlay alpha and threshold values from the UI controls.</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a><span class="sd">        Notes:</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a><span class="sd">            Reads the slider positions for alpha and threshold,</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a><span class="sd">            updates their internal numeric equivalents, and refreshes</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a><span class="sd">            the image view if the overlay is active.</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;overlay_alpha_slider&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;overlay_threshold_slider&#39;</span><span class="p">):</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>            <span class="c1"># Update visualization only if overlay is active and available</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;overlay_data&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">slice_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a><span class="sd">        Handle slice navigation events from sliders or spinboxes.</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a><span class="sd">        Args:</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a><span class="sd">            plane_idx (int): Index of the anatomical plane (0=axial, 1=coronal, 2=sagittal).</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a><span class="sd">            value (int): New slice index within the volume.</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a><span class="sd">        Notes:</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a><span class="sd">            Updates the current slice, synchronizes the corresponding slider and spinbox,</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a><span class="sd">            recalculates coordinates, and refreshes the associated 2D view.</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>        <span class="c1"># Keep slider and spinbox synchronized</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>        <span class="c1"># Update coordinate system based on selected plane</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>        <span class="k">if</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Axial</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>        <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Coronal</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>        <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sagittal</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>        <span class="c1"># Refresh the corresponding view and UI indicators</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_display</span><span class="p">(</span><span class="n">plane_idx</span><span class="p">)</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_coordinate_displays</span><span class="p">()</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_cross_view_lines</span><span class="p">()</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">time_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a><span class="sd">        Handle time slider or spinbox change for 4D data.</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a><span class="sd">        Args:</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a><span class="sd">            value (int): New time index.</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a><span class="sd">        Notes:</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a><span class="sd">            Updates the current time frame and refreshes all views.</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>        <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_time_controls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">):</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a><span class="sd">        Enable or disable time navigation controls based on data dimensionality.</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a><span class="sd">        Args:</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a><span class="sd">            enabled (bool): Whether to show and enable time controls.</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a><span class="sd">        Notes:</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a><span class="sd">            Time controls are visible only when both 4D data is loaded and</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a><span class="sd">            the toggle checkbox is active.</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>        <span class="n">value</span> <span class="o">=</span> <span class="n">enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">colormap_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colormap_name</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a><span class="sd">        Handle colormap selection change from the dropdown.</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a><span class="sd">        Args:</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a><span class="sd">            colormap_name (str): Name of the selected colormap.</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a><span class="sd">        Notes:</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a><span class="sd">            Updates the active colormap for display and refreshes all views.</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span> <span class="o">=</span> <span class="n">colormap_name</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>        <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_click_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a><span class="sd">        Handle user mouse clicks within a 2D slice view.</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a><span class="sd">        Args:</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a><span class="sd">            view_idx (int): Index of the view where the click occurred (0=axial, 1=coronal, 2=sagittal).</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a><span class="sd">            x (float): X coordinate in screen space.</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a><span class="sd">            y (float): Y coordinate in screen space.</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a><span class="sd">        Notes:</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a><span class="sd">            Converts screen coordinates to image voxel coordinates,</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a><span class="sd">            updates slice positions accordingly, and synchronizes all views.</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>            <span class="k">return</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>        <span class="c1"># Convert click from display to image coordinate space</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>        <span class="n">img_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen_to_image_coords</span><span class="p">(</span><span class="n">view_idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>        <span class="k">if</span> <span class="n">img_coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>            <span class="k">return</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>        <span class="c1"># Update global coordinates</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span> <span class="o">=</span> <span class="n">img_coords</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>        <span class="c1"># Update slice positions based on clicked voxel</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Axial (Z)</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Coronal (Y)</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Sagittal (X)</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>        <span class="c1"># Synchronize controls for all planes</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>        <span class="c1"># Refresh display and coordinate info</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_coordinate_displays</span><span class="p">()</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_cross_view_lines</span><span class="p">()</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">screen_to_image_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a><span class="sd">        Convert 2D screen coordinates from a slice view into 3D voxel coordinates.</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a><span class="sd">        Args:</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a><span class="sd">            view_idx (int): View index (0=axial, 1=coronal, 2=sagittal).</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a><span class="sd">            x (float): X coordinate in view space.</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a><span class="sd">            y (float): Y coordinate in view space.</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a><span class="sd">        Returns:</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a><span class="sd">            list[int] | None: Image-space voxel indices [x, y, z] or None if invalid.</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a><span class="sd">        Notes:</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a><span class="sd">            Applies stretch factor correction, flips orientation for proper display,</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a><span class="sd">            and clamps coordinates to valid volume bounds.</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>        <span class="c1"># Compensate for view stretching</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>        <span class="n">stretch_x</span><span class="p">,</span> <span class="n">stretch_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_factors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">view_idx</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">stretch_x</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">stretch_y</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>        <span class="c1"># Determine image dimensions (ignore time axis if 4D)</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>        <span class="c1"># Map view-specific coordinates to image indices</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>        <span class="k">if</span> <span class="n">view_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Axial (XY plane)</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>            <span class="n">img_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>            <span class="n">img_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Flip Y-axis</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>            <span class="n">img_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>        <span class="k">elif</span> <span class="n">view_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Coronal (XZ plane)</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>            <span class="n">img_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>            <span class="n">img_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>            <span class="n">img_z</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Flip Z-axis</span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>        <span class="k">elif</span> <span class="n">view_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sagittal (YZ plane)</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>            <span class="n">img_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>            <span class="n">img_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>            <span class="n">img_z</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Flip Z-axis</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>        <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">img_x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_y</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_z</span><span class="p">)]</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a><span class="sd">        Update displayed voxel coordinates and value from mouse movement.</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a><span class="sd">        Args:</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a><span class="sd">            view_idx (int): Index of the active view.</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a><span class="sd">            x (float): X mouse position.</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a><span class="sd">            y (float): Y mouse position.</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a><span class="sd">        Notes:</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a><span class="sd">            Displays current voxel indices and intensity in the status bar</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a><span class="sd">            as the user moves the mouse across an image slice.</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a>            <span class="k">return</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>        <span class="n">img_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen_to_image_coords</span><span class="p">(</span><span class="n">view_idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>        <span class="k">if</span> <span class="n">img_coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>            <span class="k">return</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>        <span class="c1"># Retrieve voxel value safely</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">]</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a>            <span class="c1"># Update coordinate and voxel value display</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a>                <span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coordinates&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: (</span><span class="si">{</span><span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">img_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">img_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a>                <span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to update coordinates&quot;</span><span class="p">)</span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_coordinate_displays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a><span class="sd">        Update coordinate display labels beside each view and in the status bar.</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a><span class="sd">        Notes:</span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a><span class="sd">            Shows current voxel positions (X, Y, Z) and value, ensuring real-time</span>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a><span class="sd">            synchronization with slice sliders and mouse navigation.</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a>            <span class="k">return</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a>        <span class="c1"># Update per-view coordinate readouts</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_displays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>  <span class="c1"># Axial</span>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_displays</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>  <span class="c1"># Coronal</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_displays</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>  <span class="c1"># Sagittal</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>        <span class="c1"># Update global coordinate display in status bar</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>            <span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coordinates&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: (</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>        <span class="c1"># Update value label safely</span>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a>                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">]</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>                <span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: -&quot;</span><span class="p">)</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_cross_view_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a><span class="sd">        Update crosshair positions across all views to indicate current voxel location.</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a><span class="sd">        Notes:</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a><span class="sd">            Crosshair lines are synchronized in all 2D projections (axial, coronal, sagittal),</span>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a><span class="sd">            taking into account stretching factors and coordinate flipping.</span>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a>            <span class="k">return</span>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">):</span>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a>            <span class="c1"># Retrieve stretch correction factors (default to 1.0)</span>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a>            <span class="n">stretch_x</span><span class="p">,</span> <span class="n">stretch_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_factors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Axial view</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">stretch_x</span>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">stretch_y</span>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a>                <span class="n">view</span><span class="o">.</span><span class="n">set_crosshair_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a>            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Coronal view</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">stretch_x</span>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">stretch_y</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a>                <span class="n">view</span><span class="o">.</span><span class="n">set_crosshair_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a>            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sagittal view</span>
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">stretch_x</span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">stretch_y</span>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a>                <span class="n">view</span><span class="o">.</span><span class="n">set_crosshair_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="p">):</span>
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update a specific plane display with matplotlib-style rendering in mm scale&quot;&quot;&quot;</span>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a>            <span class="k">return</span>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a>
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Update display: </span><span class="si">{</span><span class="n">plane_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a>            <span class="c1"># Select current 3D volume (for 4D data, use the selected time frame)</span>
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a>                <span class="n">current_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">]</span>
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a>                <span class="n">current_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span>
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a>
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a>            <span class="c1"># Get current slice index for the selected plane</span>
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a>            <span class="n">slice_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a>            <span class="c1"># Extract the corresponding slice depending on the plane</span>
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a>            <span class="k">if</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Axial (XY plane)</span>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">current_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">slice_idx</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># transpose to match orientation</span>
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">slice_data</span><span class="p">)</span>  <span class="c1"># flip vertically for correct visualization</span>
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a>                <span class="n">pixel_spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># spacing in X and Y directions</span>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a>
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a>            <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Coronal (XZ plane)</span>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">current_data</span><span class="p">[:,</span> <span class="n">slice_idx</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">slice_data</span><span class="p">)</span>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a>                <span class="n">pixel_spacing</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># X and Z spacing</span>
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a>
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a>            <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sagittal (YZ plane)</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">current_data</span><span class="p">[</span><span class="n">slice_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">slice_data</span><span class="p">)</span>
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a>                <span class="n">pixel_spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># Y and Z spacing</span>
</span><span id="L-1793"><a href="#L-1793"><span class="linenos">1793</span></a>
</span><span id="L-1794"><a href="#L-1794"><span class="linenos">1794</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1795"><a href="#L-1795"><span class="linenos">1795</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Plane index out of range&quot;</span><span class="p">)</span>
</span><span id="L-1796"><a href="#L-1796"><span class="linenos">1796</span></a>                <span class="k">return</span>  <span class="c1"># Invalid plane index</span>
</span><span id="L-1797"><a href="#L-1797"><span class="linenos">1797</span></a>
</span><span id="L-1798"><a href="#L-1798"><span class="linenos">1798</span></a>            <span class="n">automaticROI_slice</span> <span class="o">=</span> <span class="n">_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span><span class="p">,</span> <span class="n">plane_idx</span><span class="p">,</span> <span class="n">slice_idx</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-1799"><a href="#L-1799"><span class="linenos">1799</span></a>
</span><span id="L-1800"><a href="#L-1800"><span class="linenos">1800</span></a>            <span class="c1"># Prepare overlay if available and enabled</span>
</span><span id="L-1801"><a href="#L-1801"><span class="linenos">1801</span></a>            <span class="n">overlay_slice</span> <span class="o">=</span> <span class="n">_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span><span class="p">,</span><span class="n">plane_idx</span><span class="p">,</span> <span class="n">slice_idx</span><span class="p">)</span>  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-1802"><a href="#L-1802"><span class="linenos">1802</span></a>
</span><span id="L-1803"><a href="#L-1803"><span class="linenos">1803</span></a>            <span class="n">incrementalROI_slice</span> <span class="o">=</span> <span class="n">_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span><span class="p">,</span><span class="n">plane_idx</span><span class="p">,</span> <span class="n">slice_idx</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-1804"><a href="#L-1804"><span class="linenos">1804</span></a>
</span><span id="L-1805"><a href="#L-1805"><span class="linenos">1805</span></a>            <span class="c1"># Prepare RGBA composite for display</span>
</span><span id="L-1806"><a href="#L-1806"><span class="linenos">1806</span></a>            <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">slice_data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1807"><a href="#L-1807"><span class="linenos">1807</span></a>            <span class="n">rgba_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_colormap_matplotlib</span><span class="p">(</span><span class="n">slice_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="L-1808"><a href="#L-1808"><span class="linenos">1808</span></a>
</span><span id="L-1809"><a href="#L-1809"><span class="linenos">1809</span></a>            <span class="k">if</span> <span class="n">automaticROI_slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1810"><a href="#L-1810"><span class="linenos">1810</span></a>                <span class="n">rgba_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_overlay_composite</span><span class="p">(</span><span class="n">rgba_image</span><span class="p">,</span> <span class="n">automaticROI_slice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="L-1811"><a href="#L-1811"><span class="linenos">1811</span></a>
</span><span id="L-1812"><a href="#L-1812"><span class="linenos">1812</span></a>            <span class="k">if</span> <span class="n">overlay_slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1813"><a href="#L-1813"><span class="linenos">1813</span></a>                <span class="n">rgba_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_overlay_composite</span><span class="p">(</span><span class="n">rgba_image</span><span class="p">,</span> <span class="n">overlay_slice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="L-1814"><a href="#L-1814"><span class="linenos">1814</span></a>
</span><span id="L-1815"><a href="#L-1815"><span class="linenos">1815</span></a>            <span class="k">if</span> <span class="n">incrementalROI_slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1816"><a href="#L-1816"><span class="linenos">1816</span></a>                <span class="n">rgba_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_overlay_composite</span><span class="p">(</span><span class="n">rgba_image</span><span class="p">,</span> <span class="n">incrementalROI_slice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="L-1817"><a href="#L-1817"><span class="linenos">1817</span></a>
</span><span id="L-1818"><a href="#L-1818"><span class="linenos">1818</span></a>            <span class="c1"># Convert RGBA data to 8-bit format for QImage</span>
</span><span id="L-1819"><a href="#L-1819"><span class="linenos">1819</span></a>            <span class="n">rgba_data_uint8</span> <span class="o">=</span> <span class="p">(</span><span class="n">rgba_image</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="L-1820"><a href="#L-1820"><span class="linenos">1820</span></a>            <span class="n">qimage</span> <span class="o">=</span> <span class="n">QImage</span><span class="p">(</span><span class="n">rgba_data_uint8</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">QImage</span><span class="o">.</span><span class="n">Format</span><span class="o">.</span><span class="n">Format_RGBA8888</span><span class="p">)</span>
</span><span id="L-1821"><a href="#L-1821"><span class="linenos">1821</span></a>
</span><span id="L-1822"><a href="#L-1822"><span class="linenos">1822</span></a>            <span class="k">if</span> <span class="n">qimage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1823"><a href="#L-1823"><span class="linenos">1823</span></a>                <span class="n">img_w</span><span class="p">,</span> <span class="n">img_h</span> <span class="o">=</span> <span class="n">qimage</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span> <span class="n">qimage</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
</span><span id="L-1824"><a href="#L-1824"><span class="linenos">1824</span></a>
</span><span id="L-1825"><a href="#L-1825"><span class="linenos">1825</span></a>                <span class="c1"># Scale the image according to voxel size ratio (convert to mm scale)</span>
</span><span id="L-1826"><a href="#L-1826"><span class="linenos">1826</span></a>                <span class="n">qimage_scaled</span> <span class="o">=</span> <span class="n">qimage</span><span class="o">.</span><span class="n">scaled</span><span class="p">(</span>
</span><span id="L-1827"><a href="#L-1827"><span class="linenos">1827</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="n">img_w</span><span class="p">),</span>
</span><span id="L-1828"><a href="#L-1828"><span class="linenos">1828</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="n">img_h</span> <span class="o">*</span> <span class="p">(</span><span class="n">pixel_spacing</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">pixel_spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
</span><span id="L-1829"><a href="#L-1829"><span class="linenos">1829</span></a>                    <span class="n">Qt</span><span class="o">.</span><span class="n">AspectRatioMode</span><span class="o">.</span><span class="n">IgnoreAspectRatio</span><span class="p">,</span>
</span><span id="L-1830"><a href="#L-1830"><span class="linenos">1830</span></a>                    <span class="n">Qt</span><span class="o">.</span><span class="n">TransformationMode</span><span class="o">.</span><span class="n">SmoothTransformation</span>
</span><span id="L-1831"><a href="#L-1831"><span class="linenos">1831</span></a>                <span class="p">)</span>
</span><span id="L-1832"><a href="#L-1832"><span class="linenos">1832</span></a>
</span><span id="L-1833"><a href="#L-1833"><span class="linenos">1833</span></a>                <span class="c1"># Store stretch factors for coordinate conversion later</span>
</span><span id="L-1834"><a href="#L-1834"><span class="linenos">1834</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stretch_factors</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pixel_spacing</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">pixel_spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1835"><a href="#L-1835"><span class="linenos">1835</span></a>
</span><span id="L-1836"><a href="#L-1836"><span class="linenos">1836</span></a>                <span class="c1"># Update QGraphicsScene and QGraphicsView with new image</span>
</span><span id="L-1837"><a href="#L-1837"><span class="linenos">1837</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pixmap_items</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">setPixmap</span><span class="p">(</span><span class="n">QPixmap</span><span class="o">.</span><span class="n">fromImage</span><span class="p">(</span><span class="n">qimage_scaled</span><span class="p">))</span>
</span><span id="L-1838"><a href="#L-1838"><span class="linenos">1838</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">setSceneRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qimage_scaled</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span> <span class="n">qimage_scaled</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>
</span><span id="L-1839"><a href="#L-1839"><span class="linenos">1839</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">fitInView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">sceneRect</span><span class="p">(),</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AspectRatioMode</span><span class="o">.</span><span class="n">KeepAspectRatio</span><span class="p">)</span>
</span><span id="L-1840"><a href="#L-1840"><span class="linenos">1840</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated display ended&quot;</span><span class="p">)</span>
</span><span id="L-1841"><a href="#L-1841"><span class="linenos">1841</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1842"><a href="#L-1842"><span class="linenos">1842</span></a>            <span class="c1"># Log any display update errors (e.g. shape mismatch or memory issue)</span>
</span><span id="L-1843"><a href="#L-1843"><span class="linenos">1843</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating display </span><span class="si">{</span><span class="n">plane_idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1844"><a href="#L-1844"><span class="linenos">1844</span></a>
</span><span id="L-1845"><a href="#L-1845"><span class="linenos">1845</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_time_series_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1846"><a href="#L-1846"><span class="linenos">1846</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup time series plot for 4D data&quot;&quot;&quot;</span>
</span><span id="L-1847"><a href="#L-1847"><span class="linenos">1847</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1848"><a href="#L-1848"><span class="linenos">1848</span></a>            <span class="k">return</span>  <span class="c1"># Skip if plot is already initialized</span>
</span><span id="L-1849"><a href="#L-1849"><span class="linenos">1849</span></a>
</span><span id="L-1850"><a href="#L-1850"><span class="linenos">1850</span></a>        <span class="c1"># Hide static info text to make room for plot</span>
</span><span id="L-1851"><a href="#L-1851"><span class="linenos">1851</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
</span><span id="L-1852"><a href="#L-1852"><span class="linenos">1852</span></a>
</span><span id="L-1853"><a href="#L-1853"><span class="linenos">1853</span></a>        <span class="c1"># Initialize matplotlib figure for time series</span>
</span><span id="L-1854"><a href="#L-1854"><span class="linenos">1854</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</span><span id="L-1855"><a href="#L-1855"><span class="linenos">1855</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span><span class="o">.</span><span class="n">set_layout_engine</span><span class="p">(</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</span><span id="L-1856"><a href="#L-1856"><span class="linenos">1856</span></a>
</span><span id="L-1857"><a href="#L-1857"><span class="linenos">1857</span></a>        <span class="c1"># Embed matplotlib canvas inside PyQt interface</span>
</span><span id="L-1858"><a href="#L-1858"><span class="linenos">1858</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span><span class="p">)</span>
</span><span id="L-1859"><a href="#L-1859"><span class="linenos">1859</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
</span><span id="L-1860"><a href="#L-1860"><span class="linenos">1860</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</span><span id="L-1861"><a href="#L-1861"><span class="linenos">1861</span></a>
</span><span id="L-1862"><a href="#L-1862"><span class="linenos">1862</span></a>        <span class="c1"># Update section title and add canvas widget to layout</span>
</span><span id="L-1863"><a href="#L-1863"><span class="linenos">1863</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Tracer Concentration Curve&quot;</span><span class="p">))</span>
</span><span id="L-1864"><a href="#L-1864"><span class="linenos">1864</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_content_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span><span class="p">)</span>
</span><span id="L-1865"><a href="#L-1865"><span class="linenos">1865</span></a>
</span><span id="L-1866"><a href="#L-1866"><span class="linenos">1866</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">hide_time_series_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1867"><a href="#L-1867"><span class="linenos">1867</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Hide time series plot for 3D data&quot;&quot;&quot;</span>
</span><span id="L-1868"><a href="#L-1868"><span class="linenos">1868</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1869"><a href="#L-1869"><span class="linenos">1869</span></a>            <span class="c1"># Clean up plot canvas from layout and delete</span>
</span><span id="L-1870"><a href="#L-1870"><span class="linenos">1870</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fourth_content_layout</span><span class="o">.</span><span class="n">removeWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span><span class="p">)</span>
</span><span id="L-1871"><a href="#L-1871"><span class="linenos">1871</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-1872"><a href="#L-1872"><span class="linenos">1872</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
</span><span id="L-1873"><a href="#L-1873"><span class="linenos">1873</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1874"><a href="#L-1874"><span class="linenos">1874</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1875"><a href="#L-1875"><span class="linenos">1875</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1876"><a href="#L-1876"><span class="linenos">1876</span></a>
</span><span id="L-1877"><a href="#L-1877"><span class="linenos">1877</span></a>        <span class="c1"># Restore title and info text for non-4D files</span>
</span><span id="L-1878"><a href="#L-1878"><span class="linenos">1878</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Image Information&quot;</span><span class="p">))</span>
</span><span id="L-1879"><a href="#L-1879"><span class="linenos">1879</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1880"><a href="#L-1880"><span class="linenos">1880</span></a>
</span><span id="L-1881"><a href="#L-1881"><span class="linenos">1881</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_time_series_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1882"><a href="#L-1882"><span class="linenos">1882</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the time series plot with current voxel or ROI data&quot;&quot;&quot;</span>
</span><span id="L-1883"><a href="#L-1883"><span class="linenos">1883</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1884"><a href="#L-1884"><span class="linenos">1884</span></a>            <span class="k">return</span>
</span><span id="L-1885"><a href="#L-1885"><span class="linenos">1885</span></a>
</span><span id="L-1886"><a href="#L-1886"><span class="linenos">1886</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1887"><a href="#L-1887"><span class="linenos">1887</span></a>            <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span>
</span><span id="L-1888"><a href="#L-1888"><span class="linenos">1888</span></a>            <span class="n">bool_in_mask</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1889"><a href="#L-1889"><span class="linenos">1889</span></a>
</span><span id="L-1890"><a href="#L-1890"><span class="linenos">1890</span></a>            <span class="c1"># Check if overlay is active and apply ROI-based averaging</span>
</span><span id="L-1891"><a href="#L-1891"><span class="linenos">1891</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">:</span>
</span><span id="L-1892"><a href="#L-1892"><span class="linenos">1892</span></a>                <span class="n">overlay_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="L-1893"><a href="#L-1893"><span class="linenos">1893</span></a>                <span class="n">threshold_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span> <span class="o">*</span> <span class="n">overlay_max</span>
</span><span id="L-1894"><a href="#L-1894"><span class="linenos">1894</span></a>                <span class="n">threshold_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">&gt;</span> <span class="n">threshold_value</span>
</span><span id="L-1895"><a href="#L-1895"><span class="linenos">1895</span></a>
</span><span id="L-1896"><a href="#L-1896"><span class="linenos">1896</span></a>                <span class="c1"># If current voxel is inside the thresholded ROI mask</span>
</span><span id="L-1897"><a href="#L-1897"><span class="linenos">1897</span></a>                <span class="k">if</span> <span class="n">threshold_mask</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]]:</span>
</span><span id="L-1898"><a href="#L-1898"><span class="linenos">1898</span></a>                    <span class="n">bool_in_mask</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1899"><a href="#L-1899"><span class="linenos">1899</span></a>                    <span class="n">roi_voxels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">threshold_mask</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># extract time series from ROI voxels</span>
</span><span id="L-1900"><a href="#L-1900"><span class="linenos">1900</span></a>                    <span class="n">time_series</span> <span class="o">=</span> <span class="n">roi_voxels</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># mean intensity over ROI</span>
</span><span id="L-1901"><a href="#L-1901"><span class="linenos">1901</span></a>                    <span class="n">std_series</span> <span class="o">=</span> <span class="n">roi_voxels</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># standard deviation for shaded region</span>
</span><span id="L-1902"><a href="#L-1902"><span class="linenos">1902</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1903"><a href="#L-1903"><span class="linenos">1903</span></a>                    <span class="c1"># Outside mask: show only single voxel time series</span>
</span><span id="L-1904"><a href="#L-1904"><span class="linenos">1904</span></a>                    <span class="n">time_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="L-1905"><a href="#L-1905"><span class="linenos">1905</span></a>                    <span class="n">std_series</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1906"><a href="#L-1906"><span class="linenos">1906</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1907"><a href="#L-1907"><span class="linenos">1907</span></a>                <span class="c1"># If overlay is not enabled, show voxel intensity over time</span>
</span><span id="L-1908"><a href="#L-1908"><span class="linenos">1908</span></a>                <span class="n">time_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="L-1909"><a href="#L-1909"><span class="linenos">1909</span></a>                <span class="n">std_series</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1910"><a href="#L-1910"><span class="linenos">1910</span></a>
</span><span id="L-1911"><a href="#L-1911"><span class="linenos">1911</span></a>            <span class="c1"># X-axis values = time points</span>
</span><span id="L-1912"><a href="#L-1912"><span class="linenos">1912</span></a>            <span class="n">time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="L-1913"><a href="#L-1913"><span class="linenos">1913</span></a>
</span><span id="L-1914"><a href="#L-1914"><span class="linenos">1914</span></a>            <span class="c1"># Clear previous plot content</span>
</span><span id="L-1915"><a href="#L-1915"><span class="linenos">1915</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-1916"><a href="#L-1916"><span class="linenos">1916</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</span><span id="L-1917"><a href="#L-1917"><span class="linenos">1917</span></a>
</span><span id="L-1918"><a href="#L-1918"><span class="linenos">1918</span></a>            <span class="c1"># Plot time series curve</span>
</span><span id="L-1919"><a href="#L-1919"><span class="linenos">1919</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span> <span class="n">time_series</span><span class="p">,</span> <span class="s1">&#39;c-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-1920"><a href="#L-1920"><span class="linenos">1920</span></a>                                     <span class="n">label</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s1">&#39;Concentration&#39;</span><span class="p">))</span>
</span><span id="L-1921"><a href="#L-1921"><span class="linenos">1921</span></a>
</span><span id="L-1922"><a href="#L-1922"><span class="linenos">1922</span></a>            <span class="c1"># Optional shaded error region (ROI variability)</span>
</span><span id="L-1923"><a href="#L-1923"><span class="linenos">1923</span></a>            <span class="k">if</span> <span class="n">std_series</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1924"><a href="#L-1924"><span class="linenos">1924</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span> <span class="n">time_series</span> <span class="o">-</span> <span class="n">std_series</span><span class="p">,</span>
</span><span id="L-1925"><a href="#L-1925"><span class="linenos">1925</span></a>                                                 <span class="n">time_series</span> <span class="o">+</span> <span class="n">std_series</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
</span><span id="L-1926"><a href="#L-1926"><span class="linenos">1926</span></a>
</span><span id="L-1927"><a href="#L-1927"><span class="linenos">1927</span></a>            <span class="c1"># Add vertical yellow line showing current time index</span>
</span><span id="L-1928"><a href="#L-1928"><span class="linenos">1928</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_indicator_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
</span><span id="L-1929"><a href="#L-1929"><span class="linenos">1929</span></a>                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="L-1930"><a href="#L-1930"><span class="linenos">1930</span></a>                <span class="n">label</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s1">&#39;Current Time&#39;</span><span class="p">)</span>
</span><span id="L-1931"><a href="#L-1931"><span class="linenos">1931</span></a>            <span class="p">)</span>
</span><span id="L-1932"><a href="#L-1932"><span class="linenos">1932</span></a>
</span><span id="L-1933"><a href="#L-1933"><span class="linenos">1933</span></a>            <span class="c1"># Set axis labels and title</span>
</span><span id="L-1934"><a href="#L-1934"><span class="linenos">1934</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Time Point&quot;</span><span class="p">),</span>
</span><span id="L-1935"><a href="#L-1935"><span class="linenos">1935</span></a>                                           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="L-1936"><a href="#L-1936"><span class="linenos">1936</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Signal Intensity&quot;</span><span class="p">),</span>
</span><span id="L-1937"><a href="#L-1937"><span class="linenos">1937</span></a>                                           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="L-1938"><a href="#L-1938"><span class="linenos">1938</span></a>
</span><span id="L-1939"><a href="#L-1939"><span class="linenos">1939</span></a>            <span class="c1"># Title reflects whether inside ROI or single voxel</span>
</span><span id="L-1940"><a href="#L-1940"><span class="linenos">1940</span></a>            <span class="k">if</span> <span class="n">bool_in_mask</span><span class="p">:</span>
</span><span id="L-1941"><a href="#L-1941"><span class="linenos">1941</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean in overlay mask&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="L-1942"><a href="#L-1942"><span class="linenos">1942</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1943"><a href="#L-1943"><span class="linenos">1943</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Voxel (</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="L-1944"><a href="#L-1944"><span class="linenos">1944</span></a>
</span><span id="L-1945"><a href="#L-1945"><span class="linenos">1945</span></a>            <span class="c1"># Style axes and legend</span>
</span><span id="L-1946"><a href="#L-1946"><span class="linenos">1946</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="L-1947"><a href="#L-1947"><span class="linenos">1947</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-1948"><a href="#L-1948"><span class="linenos">1948</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</span><span id="L-1949"><a href="#L-1949"><span class="linenos">1949</span></a>
</span><span id="L-1950"><a href="#L-1950"><span class="linenos">1950</span></a>            <span class="c1"># Redraw updated plot on canvas</span>
</span><span id="L-1951"><a href="#L-1951"><span class="linenos">1951</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="L-1952"><a href="#L-1952"><span class="linenos">1952</span></a>
</span><span id="L-1953"><a href="#L-1953"><span class="linenos">1953</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1954"><a href="#L-1954"><span class="linenos">1954</span></a>            <span class="c1"># Log error if plotting fails (e.g., index error)</span>
</span><span id="L-1955"><a href="#L-1955"><span class="linenos">1955</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating time series plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1956"><a href="#L-1956"><span class="linenos">1956</span></a>
</span><span id="L-1957"><a href="#L-1957"><span class="linenos">1957</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_colormap_matplotlib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">colormap_name</span><span class="p">):</span>
</span><span id="L-1958"><a href="#L-1958"><span class="linenos">1958</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply colormap using matplotlib and return QImage&quot;&quot;&quot;</span>
</span><span id="L-1959"><a href="#L-1959"><span class="linenos">1959</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1960"><a href="#L-1960"><span class="linenos">1960</span></a>            <span class="c1"># Retrieve selected colormap from matplotlib</span>
</span><span id="L-1961"><a href="#L-1961"><span class="linenos">1961</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap_name</span><span class="p">)</span>
</span><span id="L-1962"><a href="#L-1962"><span class="linenos">1962</span></a>
</span><span id="L-1963"><a href="#L-1963"><span class="linenos">1963</span></a>            <span class="c1"># Apply colormap to normalized image data</span>
</span><span id="L-1964"><a href="#L-1964"><span class="linenos">1964</span></a>            <span class="n">colored_data</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-1965"><a href="#L-1965"><span class="linenos">1965</span></a>
</span><span id="L-1966"><a href="#L-1966"><span class="linenos">1966</span></a>            <span class="k">return</span> <span class="n">colored_data</span>
</span><span id="L-1967"><a href="#L-1967"><span class="linenos">1967</span></a>
</span><span id="L-1968"><a href="#L-1968"><span class="linenos">1968</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1969"><a href="#L-1969"><span class="linenos">1969</span></a>            <span class="c1"># Log errors (e.g., invalid colormap name)</span>
</span><span id="L-1970"><a href="#L-1970"><span class="linenos">1970</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error applying colormap: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1971"><a href="#L-1971"><span class="linenos">1971</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-1972"><a href="#L-1972"><span class="linenos">1972</span></a>
</span><span id="L-1973"><a href="#L-1973"><span class="linenos">1973</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_all_displays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1974"><a href="#L-1974"><span class="linenos">1974</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update all plane displays&quot;&quot;&quot;</span>
</span><span id="L-1975"><a href="#L-1975"><span class="linenos">1975</span></a>        <span class="c1"># Loop over all 3 orthogonal views (axial, coronal, sagittal)</span>
</span><span id="L-1976"><a href="#L-1976"><span class="linenos">1976</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="L-1977"><a href="#L-1977"><span class="linenos">1977</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_display</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-1978"><a href="#L-1978"><span class="linenos">1978</span></a>
</span><span id="L-1979"><a href="#L-1979"><span class="linenos">1979</span></a>        <span class="c1"># If data is 4D, also update the time-series plot</span>
</span><span id="L-1980"><a href="#L-1980"><span class="linenos">1980</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="L-1981"><a href="#L-1981"><span class="linenos">1981</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_time_series_plot</span><span class="p">()</span>
</span><span id="L-1982"><a href="#L-1982"><span class="linenos">1982</span></a>
</span><span id="L-1983"><a href="#L-1983"><span class="linenos">1983</span></a>        <span class="c1"># Update slice information label in the status bar</span>
</span><span id="L-1984"><a href="#L-1984"><span class="linenos">1984</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1985"><a href="#L-1985"><span class="linenos">1985</span></a>            <span class="n">spatial_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span>
</span><span id="L-1986"><a href="#L-1986"><span class="linenos">1986</span></a>            <span class="c1"># Construct slice position string for each plane (1-based indexing)</span>
</span><span id="L-1987"><a href="#L-1987"><span class="linenos">1987</span></a>            <span class="n">slice_info</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Slices&quot;</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="L-1988"><a href="#L-1988"><span class="linenos">1988</span></a>                         <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">spatial_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> | &quot;</span> \
</span><span id="L-1989"><a href="#L-1989"><span class="linenos">1989</span></a>                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">spatial_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> | &quot;</span> \
</span><span id="L-1990"><a href="#L-1990"><span class="linenos">1990</span></a>                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">spatial_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1991"><a href="#L-1991"><span class="linenos">1991</span></a>            <span class="c1"># Add current time info if applicable</span>
</span><span id="L-1992"><a href="#L-1992"><span class="linenos">1992</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="L-1993"><a href="#L-1993"><span class="linenos">1993</span></a>                <span class="n">slice_info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; | &quot;</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Time&quot;</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="L-1994"><a href="#L-1994"><span class="linenos">1994</span></a>                              <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1995"><a href="#L-1995"><span class="linenos">1995</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">slice_info</span><span class="p">)</span>
</span><span id="L-1996"><a href="#L-1996"><span class="linenos">1996</span></a>
</span><span id="L-1997"><a href="#L-1997"><span class="linenos">1997</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_overlay_composite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rgba_image</span><span class="p">,</span> <span class="n">overlay_slice</span><span class="p">,</span> <span class="n">colormap</span><span class="p">):</span>
</span><span id="L-1998"><a href="#L-1998"><span class="linenos">1998</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a composite image with colormap base and red overlay.&quot;&quot;&quot;</span>
</span><span id="L-1999"><a href="#L-1999"><span class="linenos">1999</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2000"><a href="#L-2000"><span class="linenos">2000</span></a>            <span class="c1"># Convert RGBA base image to float for blending</span>
</span><span id="L-2001"><a href="#L-2001"><span class="linenos">2001</span></a>            <span class="n">rgba_image_float</span> <span class="o">=</span> <span class="n">rgba_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1"># shape (H, W, 4)</span>
</span><span id="L-2002"><a href="#L-2002"><span class="linenos">2002</span></a>
</span><span id="L-2003"><a href="#L-2003"><span class="linenos">2003</span></a>            <span class="k">if</span> <span class="n">overlay_slice</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2004"><a href="#L-2004"><span class="linenos">2004</span></a>
</span><span id="L-2005"><a href="#L-2005"><span class="linenos">2005</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">overlay_slice</span><span class="p">):</span>
</span><span id="L-2006"><a href="#L-2006"><span class="linenos">2006</span></a>                    <span class="c1"># Apply transparency scaling (based on user alpha)</span>
</span><span id="L-2007"><a href="#L-2007"><span class="linenos">2007</span></a>                    <span class="n">overlay_intensity</span> <span class="o">=</span> <span class="n">overlay_slice</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha</span>
</span><span id="L-2008"><a href="#L-2008"><span class="linenos">2008</span></a>
</span><span id="L-2009"><a href="#L-2009"><span class="linenos">2009</span></a>                    <span class="c1"># Retrieve overlay color from dictionary or default (green)</span>
</span><span id="L-2010"><a href="#L-2010"><span class="linenos">2010</span></a>                    <span class="n">overlay_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]))</span>
</span><span id="L-2011"><a href="#L-2011"><span class="linenos">2011</span></a>
</span><span id="L-2012"><a href="#L-2012"><span class="linenos">2012</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Blending overlay color into base image&quot;</span><span class="p">)</span>
</span><span id="L-2013"><a href="#L-2013"><span class="linenos">2013</span></a>                    <span class="c1"># Blend overlay into base image using a numba-accelerated function</span>
</span><span id="L-2014"><a href="#L-2014"><span class="linenos">2014</span></a>                    <span class="n">rgba_image_float</span> <span class="o">=</span> <span class="n">apply_overlay_numba</span><span class="p">(</span><span class="n">rgba_image</span><span class="p">,</span> <span class="n">overlay_slice</span><span class="p">,</span>
</span><span id="L-2015"><a href="#L-2015"><span class="linenos">2015</span></a>                                                           <span class="n">overlay_intensity</span><span class="p">,</span> <span class="n">overlay_color</span><span class="p">)</span>
</span><span id="L-2016"><a href="#L-2016"><span class="linenos">2016</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Blended overlay color into base image&quot;</span><span class="p">)</span>
</span><span id="L-2017"><a href="#L-2017"><span class="linenos">2017</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Clipping values to a valid range&quot;</span><span class="p">)</span>
</span><span id="L-2018"><a href="#L-2018"><span class="linenos">2018</span></a>            <span class="c1"># Clip values to valid range [0, 1]</span>
</span><span id="L-2019"><a href="#L-2019"><span class="linenos">2019</span></a>            <span class="n">rgba_image_overlay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rgba_image_float</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-2020"><a href="#L-2020"><span class="linenos">2020</span></a>
</span><span id="L-2021"><a href="#L-2021"><span class="linenos">2021</span></a>            <span class="k">return</span> <span class="n">rgba_image_overlay</span>
</span><span id="L-2022"><a href="#L-2022"><span class="linenos">2022</span></a>
</span><span id="L-2023"><a href="#L-2023"><span class="linenos">2023</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-2024"><a href="#L-2024"><span class="linenos">2024</span></a>            <span class="c1"># Log errors and return unmodified base image as fallback</span>
</span><span id="L-2025"><a href="#L-2025"><span class="linenos">2025</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating overlay composite: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2026"><a href="#L-2026"><span class="linenos">2026</span></a>            <span class="k">return</span> <span class="n">rgba_image</span>
</span><span id="L-2027"><a href="#L-2027"><span class="linenos">2027</span></a>
</span><span id="L-2028"><a href="#L-2028"><span class="linenos">2028</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">resizeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">QResizeEvent</span><span class="p">):</span>
</span><span id="L-2029"><a href="#L-2029"><span class="linenos">2029</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle window resize to maintain aspect ratios&quot;&quot;&quot;</span>
</span><span id="L-2030"><a href="#L-2030"><span class="linenos">2030</span></a>        <span class="c1"># Call parent resize handler</span>
</span><span id="L-2031"><a href="#L-2031"><span class="linenos">2031</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">resizeEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="L-2032"><a href="#L-2032"><span class="linenos">2032</span></a>        <span class="c1"># Refit all 2D slice views after short delay to prevent flickering</span>
</span><span id="L-2033"><a href="#L-2033"><span class="linenos">2033</span></a>        <span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_all_views</span><span class="p">)</span>
</span><span id="L-2034"><a href="#L-2034"><span class="linenos">2034</span></a>
</span><span id="L-2035"><a href="#L-2035"><span class="linenos">2035</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit_all_views</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2036"><a href="#L-2036"><span class="linenos">2036</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit all views to their scenes while maintaining aspect ratio&quot;&quot;&quot;</span>
</span><span id="L-2037"><a href="#L-2037"><span class="linenos">2037</span></a>        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">:</span>
</span><span id="L-2038"><a href="#L-2038"><span class="linenos">2038</span></a>            <span class="k">if</span> <span class="n">view</span><span class="o">.</span><span class="n">scene</span><span class="p">():</span>
</span><span id="L-2039"><a href="#L-2039"><span class="linenos">2039</span></a>                <span class="c1"># Adjust zoom to fit entire image in view with correct aspect ratio</span>
</span><span id="L-2040"><a href="#L-2040"><span class="linenos">2040</span></a>                <span class="n">view</span><span class="o">.</span><span class="n">fitInView</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">scene</span><span class="p">()</span><span class="o">.</span><span class="n">sceneRect</span><span class="p">(),</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AspectRatioMode</span><span class="o">.</span><span class="n">KeepAspectRatio</span><span class="p">)</span>
</span><span id="L-2041"><a href="#L-2041"><span class="linenos">2041</span></a>
</span><span id="L-2042"><a href="#L-2042"><span class="linenos">2042</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_automaticROI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2043"><a href="#L-2043"><span class="linenos">2043</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the automatic ROI overlay dynamically when parameters change&quot;&quot;&quot;</span>
</span><span id="L-2044"><a href="#L-2044"><span class="linenos">2044</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span><span class="p">:</span>
</span><span id="L-2045"><a href="#L-2045"><span class="linenos">2045</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_drawing</span><span class="p">()</span>
</span><span id="L-2046"><a href="#L-2046"><span class="linenos">2046</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="L-2047"><a href="#L-2047"><span class="linenos">2047</span></a>
</span><span id="L-2048"><a href="#L-2048"><span class="linenos">2048</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">automaticROI_clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2049"><a href="#L-2049"><span class="linenos">2049</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle click on &#39;Automatic ROI&#39; button to start or reset the ROI tool&quot;&quot;&quot;</span>
</span><span id="L-2050"><a href="#L-2050"><span class="linenos">2050</span></a>        <span class="c1"># Save current voxel coordinates as ROI seed point</span>
</span><span id="L-2051"><a href="#L-2051"><span class="linenos">2051</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_seed_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span>
</span><span id="L-2052"><a href="#L-2052"><span class="linenos">2052</span></a>
</span><span id="L-2053"><a href="#L-2053"><span class="linenos">2053</span></a>        <span class="c1"># Compute the maximum allowed ROI radius in millimeters</span>
</span><span id="L-2054"><a href="#L-2054"><span class="linenos">2054</span></a>        <span class="n">dims_voxel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># voxel counts along X, Y, Z</span>
</span><span id="L-2055"><a href="#L-2055"><span class="linenos">2055</span></a>        <span class="n">dims_mm</span> <span class="o">=</span> <span class="n">dims_voxel</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span>  <span class="c1"># real-world dimensions in mm</span>
</span><span id="L-2056"><a href="#L-2056"><span class="linenos">2056</span></a>        <span class="n">max_radius_mm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dims_mm</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># use half of shortest image dimension</span>
</span><span id="L-2057"><a href="#L-2057"><span class="linenos">2057</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_radius_mm</span><span class="p">))</span>
</span><span id="L-2058"><a href="#L-2058"><span class="linenos">2058</span></a>
</span><span id="L-2059"><a href="#L-2059"><span class="linenos">2059</span></a>        <span class="c1"># Initialize radius slider (32 mm default for new ROI)</span>
</span><span id="L-2060"><a href="#L-2060"><span class="linenos">2060</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span>
</span><span id="L-2061"><a href="#L-2061"><span class="linenos">2061</span></a>            <span class="mi">32</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
</span><span id="L-2062"><a href="#L-2062"><span class="linenos">2062</span></a>        <span class="p">)</span>
</span><span id="L-2063"><a href="#L-2063"><span class="linenos">2063</span></a>
</span><span id="L-2064"><a href="#L-2064"><span class="linenos">2064</span></a>        <span class="c1"># Initialize difference (intensity tolerance) slider</span>
</span><span id="L-2065"><a href="#L-2065"><span class="linenos">2065</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="L-2066"><a href="#L-2066"><span class="linenos">2066</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span>
</span><span id="L-2067"><a href="#L-2067"><span class="linenos">2067</span></a>            <span class="nb">int</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
</span><span id="L-2068"><a href="#L-2068"><span class="linenos">2068</span></a>        <span class="p">)</span>
</span><span id="L-2069"><a href="#L-2069"><span class="linenos">2069</span></a>
</span><span id="L-2070"><a href="#L-2070"><span class="linenos">2070</span></a>        <span class="c1"># Show and enable ROI parameter controls</span>
</span><span id="L-2071"><a href="#L-2071"><span class="linenos">2071</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2072"><a href="#L-2072"><span class="linenos">2072</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2073"><a href="#L-2073"><span class="linenos">2073</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Reset Origin&quot;</span><span class="p">))</span>
</span><span id="L-2074"><a href="#L-2074"><span class="linenos">2074</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2075"><a href="#L-2075"><span class="linenos">2075</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2076"><a href="#L-2076"><span class="linenos">2076</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2077"><a href="#L-2077"><span class="linenos">2077</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2078"><a href="#L-2078"><span class="linenos">2078</span></a>
</span><span id="L-2079"><a href="#L-2079"><span class="linenos">2079</span></a>        <span class="c1"># Generate initial automatic ROI mask</span>
</span><span id="L-2080"><a href="#L-2080"><span class="linenos">2080</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_drawing</span><span class="p">()</span>
</span><span id="L-2081"><a href="#L-2081"><span class="linenos">2081</span></a>
</span><span id="L-2082"><a href="#L-2082"><span class="linenos">2082</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2083"><a href="#L-2083"><span class="linenos">2083</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2084"><a href="#L-2084"><span class="linenos">2084</span></a>        <span class="c1"># Ensure overlay display is active</span>
</span><span id="L-2085"><a href="#L-2085"><span class="linenos">2085</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_automaticROI</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2086"><a href="#L-2086"><span class="linenos">2086</span></a>        <span class="c1">#self.overlay_checkbox.setChecked(True)</span>
</span><span id="L-2087"><a href="#L-2087"><span class="linenos">2087</span></a>        <span class="c1">#self.overlay_checkbox.setEnabled(True)</span>
</span><span id="L-2088"><a href="#L-2088"><span class="linenos">2088</span></a>
</span><span id="L-2089"><a href="#L-2089"><span class="linenos">2089</span></a>        <span class="c1"># Refresh all displays</span>
</span><span id="L-2090"><a href="#L-2090"><span class="linenos">2090</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="L-2091"><a href="#L-2091"><span class="linenos">2091</span></a>
</span><span id="L-2092"><a href="#L-2092"><span class="linenos">2092</span></a>
</span><span id="L-2093"><a href="#L-2093"><span class="linenos">2093</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_automaticROI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-2094"><a href="#L-2094"><span class="linenos">2094</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2095"><a href="#L-2095"><span class="linenos">2095</span></a><span class="sd">        Enable or disable the overlay for the automatic ROI on top of the base image.</span>
</span><span id="L-2096"><a href="#L-2096"><span class="linenos">2096</span></a>
</span><span id="L-2097"><a href="#L-2097"><span class="linenos">2097</span></a><span class="sd">        Args:</span>
</span><span id="L-2098"><a href="#L-2098"><span class="linenos">2098</span></a><span class="sd">            enabled (bool): Whether to enable (True) or disable (False) the overlay display.</span>
</span><span id="L-2099"><a href="#L-2099"><span class="linenos">2099</span></a>
</span><span id="L-2100"><a href="#L-2100"><span class="linenos">2100</span></a><span class="sd">        Behavior:</span>
</span><span id="L-2101"><a href="#L-2101"><span class="linenos">2101</span></a><span class="sd">            - Toggles transparency and threshold controls.</span>
</span><span id="L-2102"><a href="#L-2102"><span class="linenos">2102</span></a><span class="sd">            - Refreshes all active views if overlay data exists.</span>
</span><span id="L-2103"><a href="#L-2103"><span class="linenos">2103</span></a>
</span><span id="L-2104"><a href="#L-2104"><span class="linenos">2104</span></a><span class="sd">        Returns:</span>
</span><span id="L-2105"><a href="#L-2105"><span class="linenos">2105</span></a><span class="sd">            None</span>
</span><span id="L-2106"><a href="#L-2106"><span class="linenos">2106</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2107"><a href="#L-2107"><span class="linenos">2107</span></a>
</span><span id="L-2108"><a href="#L-2108"><span class="linenos">2108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
</span><span id="L-2109"><a href="#L-2109"><span class="linenos">2109</span></a>        <span class="c1"># Update internal overlay state</span>
</span><span id="L-2110"><a href="#L-2110"><span class="linenos">2110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="o">=</span> <span class="n">enabled</span>
</span><span id="L-2111"><a href="#L-2111"><span class="linenos">2111</span></a>        <span class="c1"># Enable or disable overlay-related UI controls</span>
</span><span id="L-2112"><a href="#L-2112"><span class="linenos">2112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="L-2113"><a href="#L-2113"><span class="linenos">2113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="L-2114"><a href="#L-2114"><span class="linenos">2114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="L-2115"><a href="#L-2115"><span class="linenos">2115</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="L-2116"><a href="#L-2116"><span class="linenos">2116</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="L-2117"><a href="#L-2117"><span class="linenos">2117</span></a>
</span><span id="L-2118"><a href="#L-2118"><span class="linenos">2118</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
</span><span id="L-2119"><a href="#L-2119"><span class="linenos">2119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
</span><span id="L-2120"><a href="#L-2120"><span class="linenos">2120</span></a>
</span><span id="L-2121"><a href="#L-2121"><span class="linenos">2121</span></a>        <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="L-2122"><a href="#L-2122"><span class="linenos">2122</span></a>            <span class="c1"># Redraw display if overlay data is available</span>
</span><span id="L-2123"><a href="#L-2123"><span class="linenos">2123</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="L-2124"><a href="#L-2124"><span class="linenos">2124</span></a>
</span><span id="L-2125"><a href="#L-2125"><span class="linenos">2125</span></a>            <span class="c1"># Update time series plot if available</span>
</span><span id="L-2126"><a href="#L-2126"><span class="linenos">2126</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_time_series_plot</span><span class="p">()</span>
</span><span id="L-2127"><a href="#L-2127"><span class="linenos">2127</span></a>
</span><span id="L-2128"><a href="#L-2128"><span class="linenos">2128</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">automaticROI_drawing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2129"><a href="#L-2129"><span class="linenos">2129</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate automatic ROI mask around selected seed voxel&quot;&quot;&quot;</span>
</span><span id="L-2130"><a href="#L-2130"><span class="linenos">2130</span></a>        <span class="n">radius_mm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>  <span class="c1"># ROI radius in mm</span>
</span><span id="L-2131"><a href="#L-2131"><span class="linenos">2131</span></a>        <span class="n">difference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span>  <span class="c1"># intensity tolerance</span>
</span><span id="L-2132"><a href="#L-2132"><span class="linenos">2132</span></a>        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_seed_coordinates</span>  <span class="c1"># seed voxel coordinates</span>
</span><span id="L-2133"><a href="#L-2133"><span class="linenos">2133</span></a>
</span><span id="L-2134"><a href="#L-2134"><span class="linenos">2134</span></a>        <span class="c1"># Select proper 3D volume if data is 4D</span>
</span><span id="L-2135"><a href="#L-2135"><span class="linenos">2135</span></a>        <span class="n">img_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span>
</span><span id="L-2136"><a href="#L-2136"><span class="linenos">2136</span></a>
</span><span id="L-2137"><a href="#L-2137"><span class="linenos">2137</span></a>        <span class="c1"># Intensity value at the seed voxel</span>
</span><span id="L-2138"><a href="#L-2138"><span class="linenos">2138</span></a>        <span class="n">seed_intensity</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">]</span>
</span><span id="L-2139"><a href="#L-2139"><span class="linenos">2139</span></a>
</span><span id="L-2140"><a href="#L-2140"><span class="linenos">2140</span></a>        <span class="c1"># Convert radius in mm to radius in voxel units per axis</span>
</span><span id="L-2141"><a href="#L-2141"><span class="linenos">2141</span></a>        <span class="n">rx_vox</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">radius_mm</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="L-2142"><a href="#L-2142"><span class="linenos">2142</span></a>        <span class="n">ry_vox</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">radius_mm</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-2143"><a href="#L-2143"><span class="linenos">2143</span></a>        <span class="n">rz_vox</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">radius_mm</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span><span id="L-2144"><a href="#L-2144"><span class="linenos">2144</span></a>
</span><span id="L-2145"><a href="#L-2145"><span class="linenos">2145</span></a>        <span class="c1"># Compute subvolume limits (ROI bounding box)</span>
</span><span id="L-2146"><a href="#L-2146"><span class="linenos">2146</span></a>        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">rx_vox</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">rx_vox</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-2147"><a href="#L-2147"><span class="linenos">2147</span></a>        <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">ry_vox</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">ry_vox</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-2148"><a href="#L-2148"><span class="linenos">2148</span></a>        <span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">-</span> <span class="n">rz_vox</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">rz_vox</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-2149"><a href="#L-2149"><span class="linenos">2149</span></a>
</span><span id="L-2150"><a href="#L-2150"><span class="linenos">2150</span></a>        <span class="c1"># Compute ROI mask using parallelized Numba function</span>
</span><span id="L-2151"><a href="#L-2151"><span class="linenos">2151</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">compute_mask_numba_mm</span><span class="p">(</span><span class="n">img_data</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span>
</span><span id="L-2152"><a href="#L-2152"><span class="linenos">2152</span></a>                                     <span class="n">radius_mm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">,</span>
</span><span id="L-2153"><a href="#L-2153"><span class="linenos">2153</span></a>                                     <span class="n">seed_intensity</span><span class="p">,</span> <span class="n">difference</span><span class="p">,</span>
</span><span id="L-2154"><a href="#L-2154"><span class="linenos">2154</span></a>                                     <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span><span class="p">)</span>
</span><span id="L-2155"><a href="#L-2155"><span class="linenos">2155</span></a>
</span><span id="L-2156"><a href="#L-2156"><span class="linenos">2156</span></a>        <span class="c1"># Store result as overlay for visualization</span>
</span><span id="L-2157"><a href="#L-2157"><span class="linenos">2157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="o">=</span> <span class="n">mask</span>
</span><span id="L-2158"><a href="#L-2158"><span class="linenos">2158</span></a>
</span><span id="L-2159"><a href="#L-2159"><span class="linenos">2159</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ROI_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2160"><a href="#L-2160"><span class="linenos">2160</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the automatically generated ROI mask to disk&quot;&quot;&quot;</span>
</span><span id="L-2161"><a href="#L-2161"><span class="linenos">2161</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Saving ROI mask to disk&quot;</span><span class="p">)</span>
</span><span id="L-2162"><a href="#L-2162"><span class="linenos">2162</span></a>        <span class="n">original_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span>
</span><span id="L-2163"><a href="#L-2163"><span class="linenos">2163</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">original_path</span><span class="p">:</span>
</span><span id="L-2164"><a href="#L-2164"><span class="linenos">2164</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;No file loaded.&quot;</span><span class="p">)</span>
</span><span id="L-2165"><a href="#L-2165"><span class="linenos">2165</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;No file loaded&quot;</span><span class="p">)</span>
</span><span id="L-2166"><a href="#L-2166"><span class="linenos">2166</span></a>            <span class="k">return</span>
</span><span id="L-2167"><a href="#L-2167"><span class="linenos">2167</span></a>        <span class="c1"># Retrieve workspace path from context</span>
</span><span id="L-2168"><a href="#L-2168"><span class="linenos">2168</span></a>        <span class="n">workspace_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workspace_path&quot;</span><span class="p">)</span>
</span><span id="L-2169"><a href="#L-2169"><span class="linenos">2169</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">workspace_path</span><span class="p">:</span>
</span><span id="L-2170"><a href="#L-2170"><span class="linenos">2170</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;Workspace path is not set.&quot;</span><span class="p">)</span>
</span><span id="L-2171"><a href="#L-2171"><span class="linenos">2171</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Workspace path not set&quot;</span><span class="p">)</span>
</span><span id="L-2172"><a href="#L-2172"><span class="linenos">2172</span></a>            <span class="k">return</span>
</span><span id="L-2173"><a href="#L-2173"><span class="linenos">2173</span></a>
</span><span id="L-2174"><a href="#L-2174"><span class="linenos">2174</span></a>        <span class="c1"># Try to infer subject identifier (sub-XX) from relative file path</span>
</span><span id="L-2175"><a href="#L-2175"><span class="linenos">2175</span></a>        <span class="n">relative_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">original_path</span><span class="p">,</span> <span class="n">workspace_path</span><span class="p">)</span>
</span><span id="L-2176"><a href="#L-2176"><span class="linenos">2176</span></a>        <span class="n">parts</span> <span class="o">=</span> <span class="n">relative_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
</span><span id="L-2177"><a href="#L-2177"><span class="linenos">2177</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2178"><a href="#L-2178"><span class="linenos">2178</span></a>            <span class="n">subject</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">part</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span> <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sub-&quot;</span><span class="p">))</span>
</span><span id="L-2179"><a href="#L-2179"><span class="linenos">2179</span></a>        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
</span><span id="L-2180"><a href="#L-2180"><span class="linenos">2180</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;Could not determine subject from path.&quot;</span><span class="p">)</span>
</span><span id="L-2181"><a href="#L-2181"><span class="linenos">2181</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not determine subject from path.&quot;</span><span class="p">)</span>
</span><span id="L-2182"><a href="#L-2182"><span class="linenos">2182</span></a>            <span class="k">return</span>
</span><span id="L-2183"><a href="#L-2183"><span class="linenos">2183</span></a>
</span><span id="L-2184"><a href="#L-2184"><span class="linenos">2184</span></a>
</span><span id="L-2185"><a href="#L-2185"><span class="linenos">2185</span></a>        <span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workspace_path</span><span class="p">,</span> <span class="s2">&quot;derivatives&quot;</span><span class="p">,</span> <span class="s2">&quot;manual_masks&quot;</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;anat&quot;</span><span class="p">)</span>
</span><span id="L-2186"><a href="#L-2186"><span class="linenos">2186</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Save dir: </span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2187"><a href="#L-2187"><span class="linenos">2187</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">original_path</span><span class="p">)</span>
</span><span id="L-2188"><a href="#L-2188"><span class="linenos">2188</span></a>        <span class="n">base_name</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nii.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nii&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-2189"><a href="#L-2189"><span class="linenos">2189</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base filename: </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2190"><a href="#L-2190"><span class="linenos">2190</span></a>        <span class="c1"># Prepare filenames and output paths</span>
</span><span id="L-2191"><a href="#L-2191"><span class="linenos">2191</span></a>        <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_next_file_id</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="L-2192"><a href="#L-2192"><span class="linenos">2192</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Obtained version: </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2193"><a href="#L-2193"><span class="linenos">2193</span></a>        <span class="n">new_base</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_ROI_v</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">_mask&quot;</span>
</span><span id="L-2194"><a href="#L-2194"><span class="linenos">2194</span></a>        <span class="n">new_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_base</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span>
</span><span id="L-2195"><a href="#L-2195"><span class="linenos">2195</span></a>
</span><span id="L-2196"><a href="#L-2196"><span class="linenos">2196</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Show confirmation dialog&quot;</span><span class="p">)</span>
</span><span id="L-2197"><a href="#L-2197"><span class="linenos">2197</span></a>        <span class="c1"># Show confirmation dialog before saving</span>
</span><span id="L-2198"><a href="#L-2198"><span class="linenos">2198</span></a>        <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-2199"><a href="#L-2199"><span class="linenos">2199</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Icon</span><span class="o">.</span><span class="n">Question</span><span class="p">)</span>
</span><span id="L-2200"><a href="#L-2200"><span class="linenos">2200</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Confirm Save&quot;</span><span class="p">)</span>
</span><span id="L-2201"><a href="#L-2201"><span class="linenos">2201</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Do you want to save the automatic ROI?&quot;</span><span class="p">)</span>
</span><span id="L-2202"><a href="#L-2202"><span class="linenos">2202</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setInformativeText</span><span class="p">(</span>
</span><span id="L-2203"><a href="#L-2203"><span class="linenos">2203</span></a>            <span class="sa">f</span><span class="s2">&quot;File will be saved as:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="L-2204"><a href="#L-2204"><span class="linenos">2204</span></a>            <span class="sa">f</span><span class="s2">&quot;Location:</span><span class="se">\n</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="L-2205"><a href="#L-2205"><span class="linenos">2205</span></a>        <span class="p">)</span>
</span><span id="L-2206"><a href="#L-2206"><span class="linenos">2206</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span><span class="p">)</span>
</span><span id="L-2207"><a href="#L-2207"><span class="linenos">2207</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setDefaultButton</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span><span class="p">)</span>
</span><span id="L-2208"><a href="#L-2208"><span class="linenos">2208</span></a>
</span><span id="L-2209"><a href="#L-2209"><span class="linenos">2209</span></a>        <span class="c1"># Wait for user response</span>
</span><span id="L-2210"><a href="#L-2210"><span class="linenos">2210</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
</span><span id="L-2211"><a href="#L-2211"><span class="linenos">2211</span></a>        <span class="k">if</span> <span class="n">response</span> <span class="o">!=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
</span><span id="L-2212"><a href="#L-2212"><span class="linenos">2212</span></a>            <span class="k">return</span>  <span class="c1"># User canceled</span>
</span><span id="L-2213"><a href="#L-2213"><span class="linenos">2213</span></a>
</span><span id="L-2214"><a href="#L-2214"><span class="linenos">2214</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Make dir&quot;</span><span class="p">)</span>
</span><span id="L-2215"><a href="#L-2215"><span class="linenos">2215</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2216"><a href="#L-2216"><span class="linenos">2216</span></a>        <span class="n">full_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
</span><span id="L-2217"><a href="#L-2217"><span class="linenos">2217</span></a>        <span class="n">json_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_base</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
</span><span id="L-2218"><a href="#L-2218"><span class="linenos">2218</span></a>
</span><span id="L-2219"><a href="#L-2219"><span class="linenos">2219</span></a>        <span class="n">origin_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-2220"><a href="#L-2220"><span class="linenos">2220</span></a>
</span><span id="L-2221"><a href="#L-2221"><span class="linenos">2221</span></a>        <span class="n">total_ROI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="L-2222"><a href="#L-2222"><span class="linenos">2222</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2223"><a href="#L-2223"><span class="linenos">2223</span></a>            <span class="n">total_ROI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span><span class="p">,</span> <span class="n">total_ROI</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="L-2224"><a href="#L-2224"><span class="linenos">2224</span></a>            <span class="n">origin_dict</span><span class="p">[</span><span class="s2">&quot;Original overlay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_file_path</span>
</span><span id="L-2225"><a href="#L-2225"><span class="linenos">2225</span></a>            <span class="n">origin_dict</span><span class="p">[</span><span class="s2">&quot;Original overlay threshold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span>
</span><span id="L-2226"><a href="#L-2226"><span class="linenos">2226</span></a>            
</span><span id="L-2227"><a href="#L-2227"><span class="linenos">2227</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">:</span>
</span><span id="L-2228"><a href="#L-2228"><span class="linenos">2228</span></a>            <span class="n">total_ROI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span><span class="p">,</span><span class="n">total_ROI</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="L-2229"><a href="#L-2229"><span class="linenos">2229</span></a>            <span class="n">origin_dict</span><span class="p">[</span><span class="s2">&quot;Automatic drawing parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_origins</span>
</span><span id="L-2230"><a href="#L-2230"><span class="linenos">2230</span></a>
</span><span id="L-2231"><a href="#L-2231"><span class="linenos">2231</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span><span class="p">:</span>
</span><span id="L-2232"><a href="#L-2232"><span class="linenos">2232</span></a>            <span class="n">total_ROI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span><span class="p">,</span> <span class="n">total_ROI</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="L-2233"><a href="#L-2233"><span class="linenos">2233</span></a>            <span class="n">new_params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-2234"><a href="#L-2234"><span class="linenos">2234</span></a>                <span class="s2">&quot;Seed&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_seed_coordinates</span><span class="p">),</span>  <span class="c1"># assicurati che sia JSON-safe</span>
</span><span id="L-2235"><a href="#L-2235"><span class="linenos">2235</span></a>                <span class="s2">&quot;Radius&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
</span><span id="L-2236"><a href="#L-2236"><span class="linenos">2236</span></a>                <span class="s2">&quot;Difference&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
</span><span id="L-2237"><a href="#L-2237"><span class="linenos">2237</span></a>            <span class="p">}</span>
</span><span id="L-2238"><a href="#L-2238"><span class="linenos">2238</span></a>            <span class="k">if</span> <span class="s2">&quot;Automatic drawing parameters&quot;</span> <span class="ow">in</span> <span class="n">origin_dict</span><span class="p">:</span>
</span><span id="L-2239"><a href="#L-2239"><span class="linenos">2239</span></a>                <span class="n">origin_dict</span><span class="p">[</span><span class="s2">&quot;Automatic drawing parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>
</span><span id="L-2240"><a href="#L-2240"><span class="linenos">2240</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2241"><a href="#L-2241"><span class="linenos">2241</span></a>                <span class="n">origin_dict</span><span class="p">[</span><span class="s2">&quot;Automatic drawing parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_params</span><span class="p">]</span>
</span><span id="L-2242"><a href="#L-2242"><span class="linenos">2242</span></a>
</span><span id="L-2243"><a href="#L-2243"><span class="linenos">2243</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Start thread&quot;</span><span class="p">)</span>
</span><span id="L-2244"><a href="#L-2244"><span class="linenos">2244</span></a>        <span class="c1"># Start threaded save operation</span>
</span><span id="L-2245"><a href="#L-2245"><span class="linenos">2245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SaveNiftiThread</span><span class="p">(</span><span class="n">total_ROI</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span>
</span><span id="L-2246"><a href="#L-2246"><span class="linenos">2246</span></a>                                            <span class="n">full_save_path</span><span class="p">,</span> <span class="n">json_save_path</span><span class="p">,</span>
</span><span id="L-2247"><a href="#L-2247"><span class="linenos">2247</span></a>                                            <span class="n">relative_path</span><span class="p">,</span> <span class="n">origin_dict</span><span class="p">))</span>
</span><span id="L-2248"><a href="#L-2248"><span class="linenos">2248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">success</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_ROI_saved</span><span class="p">)</span>
</span><span id="L-2249"><a href="#L-2249"><span class="linenos">2249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_ROI_saving_error</span><span class="p">)</span>
</span><span id="L-2250"><a href="#L-2250"><span class="linenos">2250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-2251"><a href="#L-2251"><span class="linenos">2251</span></a>
</span><span id="L-2252"><a href="#L-2252"><span class="linenos">2252</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_on_ROI_saved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">json_path</span><span class="p">):</span>
</span><span id="L-2253"><a href="#L-2253"><span class="linenos">2253</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback executed when ROI save completes successfully&quot;&quot;&quot;</span>
</span><span id="L-2254"><a href="#L-2254"><span class="linenos">2254</span></a>        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-2255"><a href="#L-2255"><span class="linenos">2255</span></a>                                <span class="s2">&quot;ROI Saved&quot;</span><span class="p">,</span>
</span><span id="L-2256"><a href="#L-2256"><span class="linenos">2256</span></a>                                <span class="sa">f</span><span class="s2">&quot;ROI saved in:</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> and metadata saved in:</span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2"> successfully!&quot;</span><span class="p">)</span>
</span><span id="L-2257"><a href="#L-2257"><span class="linenos">2257</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROI saved in:</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> and metadata saved in:</span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2"> successfully!&quot;</span><span class="p">)</span>
</span><span id="L-2258"><a href="#L-2258"><span class="linenos">2258</span></a>
</span><span id="L-2259"><a href="#L-2259"><span class="linenos">2259</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_on_ROI_saving_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
</span><span id="L-2260"><a href="#L-2260"><span class="linenos">2260</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback executed when ROI saving fails&quot;&quot;&quot;</span>
</span><span id="L-2261"><a href="#L-2261"><span class="linenos">2261</span></a>        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
</span><span id="L-2262"><a href="#L-2262"><span class="linenos">2262</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="L-2263"><a href="#L-2263"><span class="linenos">2263</span></a>            <span class="s2">&quot;Error when saving ROI&quot;</span><span class="p">,</span>
</span><span id="L-2264"><a href="#L-2264"><span class="linenos">2264</span></a>            <span class="sa">f</span><span class="s2">&quot;Error when saving: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2265"><a href="#L-2265"><span class="linenos">2265</span></a>        <span class="p">)</span>
</span><span id="L-2266"><a href="#L-2266"><span class="linenos">2266</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error when saving ROI: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2267"><a href="#L-2267"><span class="linenos">2267</span></a>
</span><span id="L-2268"><a href="#L-2268"><span class="linenos">2268</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_next_file_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">folder_path</span><span class="p">):</span>
</span><span id="L-2269"><a href="#L-2269"><span class="linenos">2269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2270"><a href="#L-2270"><span class="linenos">2270</span></a><span class="sd">        Generates the next available numeric ID based on the files present in the folder.</span>
</span><span id="L-2271"><a href="#L-2271"><span class="linenos">2271</span></a>
</span><span id="L-2272"><a href="#L-2272"><span class="linenos">2272</span></a><span class="sd">        Looks for files with names matching the pattern &#39;something_idNUM_other.extension&#39;</span>
</span><span id="L-2273"><a href="#L-2273"><span class="linenos">2273</span></a><span class="sd">        (where NUM is an integer), and returns the next available number.</span>
</span><span id="L-2274"><a href="#L-2274"><span class="linenos">2274</span></a>
</span><span id="L-2275"><a href="#L-2275"><span class="linenos">2275</span></a><span class="sd">        Args:</span>
</span><span id="L-2276"><a href="#L-2276"><span class="linenos">2276</span></a><span class="sd">            folder_path (str): Path to the folder to scan.</span>
</span><span id="L-2277"><a href="#L-2277"><span class="linenos">2277</span></a>
</span><span id="L-2278"><a href="#L-2278"><span class="linenos">2278</span></a><span class="sd">        Returns:</span>
</span><span id="L-2279"><a href="#L-2279"><span class="linenos">2279</span></a><span class="sd">            int: The next available numeric ID.</span>
</span><span id="L-2280"><a href="#L-2280"><span class="linenos">2280</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2281"><a href="#L-2281"><span class="linenos">2281</span></a>        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;_v(\d+)_&quot;</span><span class="p">)</span>
</span><span id="L-2282"><a href="#L-2282"><span class="linenos">2282</span></a>        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2283"><a href="#L-2283"><span class="linenos">2283</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Searching versions&quot;</span><span class="p">)</span>
</span><span id="L-2284"><a href="#L-2284"><span class="linenos">2284</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
</span><span id="L-2285"><a href="#L-2285"><span class="linenos">2285</span></a>            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
</span><span id="L-2286"><a href="#L-2286"><span class="linenos">2286</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)):</span>
</span><span id="L-2287"><a href="#L-2287"><span class="linenos">2287</span></a>                    <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-2288"><a href="#L-2288"><span class="linenos">2288</span></a>                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
</span><span id="L-2289"><a href="#L-2289"><span class="linenos">2289</span></a>                        <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
</span><span id="L-2290"><a href="#L-2290"><span class="linenos">2290</span></a>
</span><span id="L-2291"><a href="#L-2291"><span class="linenos">2291</span></a>            <span class="n">next_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">ids</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="L-2292"><a href="#L-2292"><span class="linenos">2292</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Next v: </span><span class="si">{</span><span class="n">next_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2293"><a href="#L-2293"><span class="linenos">2293</span></a>            <span class="k">return</span> <span class="n">next_id</span>
</span><span id="L-2294"><a href="#L-2294"><span class="linenos">2294</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2295"><a href="#L-2295"><span class="linenos">2295</span></a>            <span class="k">return</span> <span class="mi">1</span>
</span><span id="L-2296"><a href="#L-2296"><span class="linenos">2296</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">addOrigin_clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2297"><a href="#L-2297"><span class="linenos">2297</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="L-2298"><a href="#L-2298"><span class="linenos">2298</span></a>
</span><span id="L-2299"><a href="#L-2299"><span class="linenos">2299</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2300"><a href="#L-2300"><span class="linenos">2300</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="L-2301"><a href="#L-2301"><span class="linenos">2301</span></a>
</span><span id="L-2302"><a href="#L-2302"><span class="linenos">2302</span></a>        <span class="c1">#if self.overlay_enabled and self.overlay_data is not None:</span>
</span><span id="L-2303"><a href="#L-2303"><span class="linenos">2303</span></a>        <span class="c1">#    self.incrementalROI_data = np.logical_or(self.incrementalROI_data, self.overlay_data).astype(np.uint8)</span>
</span><span id="L-2304"><a href="#L-2304"><span class="linenos">2304</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2305"><a href="#L-2305"><span class="linenos">2305</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2306"><a href="#L-2306"><span class="linenos">2306</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_incrementalROI</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2307"><a href="#L-2307"><span class="linenos">2307</span></a>
</span><span id="L-2308"><a href="#L-2308"><span class="linenos">2308</span></a>        <span class="n">new_params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-2309"><a href="#L-2309"><span class="linenos">2309</span></a>            <span class="s2">&quot;Seed&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_seed_coordinates</span><span class="p">),</span>
</span><span id="L-2310"><a href="#L-2310"><span class="linenos">2310</span></a>            <span class="s2">&quot;Radius&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
</span><span id="L-2311"><a href="#L-2311"><span class="linenos">2311</span></a>            <span class="s2">&quot;Difference&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
</span><span id="L-2312"><a href="#L-2312"><span class="linenos">2312</span></a>        <span class="p">}</span>
</span><span id="L-2313"><a href="#L-2313"><span class="linenos">2313</span></a>
</span><span id="L-2314"><a href="#L-2314"><span class="linenos">2314</span></a>        <span class="c1"># Mantieni lista incrementale</span>
</span><span id="L-2315"><a href="#L-2315"><span class="linenos">2315</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>
</span><span id="L-2316"><a href="#L-2316"><span class="linenos">2316</span></a>
</span><span id="L-2317"><a href="#L-2317"><span class="linenos">2317</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_incrementalROI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">enabled</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-2318"><a href="#L-2318"><span class="linenos">2318</span></a>
</span><span id="L-2319"><a href="#L-2319"><span class="linenos">2319</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span> <span class="o">=</span> <span class="n">enabled</span>
</span><span id="L-2320"><a href="#L-2320"><span class="linenos">2320</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
</span><span id="L-2321"><a href="#L-2321"><span class="linenos">2321</span></a>
</span><span id="L-2322"><a href="#L-2322"><span class="linenos">2322</span></a>        <span class="c1"># Enable or disable overlay-related UI controls</span>
</span><span id="L-2323"><a href="#L-2323"><span class="linenos">2323</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">)</span>
</span><span id="L-2324"><a href="#L-2324"><span class="linenos">2324</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">)</span>
</span><span id="L-2325"><a href="#L-2325"><span class="linenos">2325</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">)</span>
</span><span id="L-2326"><a href="#L-2326"><span class="linenos">2326</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">)</span>
</span><span id="L-2327"><a href="#L-2327"><span class="linenos">2327</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">)</span>
</span><span id="L-2328"><a href="#L-2328"><span class="linenos">2328</span></a>
</span><span id="L-2329"><a href="#L-2329"><span class="linenos">2329</span></a>        <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="L-2330"><a href="#L-2330"><span class="linenos">2330</span></a>            <span class="c1"># Redraw display if overlay data is available</span>
</span><span id="L-2331"><a href="#L-2331"><span class="linenos">2331</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="L-2332"><a href="#L-2332"><span class="linenos">2332</span></a>
</span><span id="L-2333"><a href="#L-2333"><span class="linenos">2333</span></a>            <span class="c1"># Update time series plot if available</span>
</span><span id="L-2334"><a href="#L-2334"><span class="linenos">2334</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_time_series_plot</span><span class="p">()</span>
</span><span id="L-2335"><a href="#L-2335"><span class="linenos">2335</span></a>
</span><span id="L-2336"><a href="#L-2336"><span class="linenos">2336</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span id="L-2337"><a href="#L-2337"><span class="linenos">2337</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up on application exit&quot;&quot;&quot;</span>
</span><span id="L-2338"><a href="#L-2338"><span class="linenos">2338</span></a>        <span class="c1"># Stop and delete all active threads</span>
</span><span id="L-2339"><a href="#L-2339"><span class="linenos">2339</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;threads&#39;</span><span class="p">):</span>
</span><span id="L-2340"><a href="#L-2340"><span class="linenos">2340</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
</span><span id="L-2341"><a href="#L-2341"><span class="linenos">2341</span></a>                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">isRunning</span><span class="p">():</span>
</span><span id="L-2342"><a href="#L-2342"><span class="linenos">2342</span></a>                    <span class="n">t</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="L-2343"><a href="#L-2343"><span class="linenos">2343</span></a>                    <span class="n">t</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</span><span id="L-2344"><a href="#L-2344"><span class="linenos">2344</span></a>                <span class="n">t</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
</span><span id="L-2345"><a href="#L-2345"><span class="linenos">2345</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-2346"><a href="#L-2346"><span class="linenos">2346</span></a>
</span><span id="L-2347"><a href="#L-2347"><span class="linenos">2347</span></a>        <span class="c1"># Clear large data arrays to release memory</span>
</span><span id="L-2348"><a href="#L-2348"><span class="linenos">2348</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2349"><a href="#L-2349"><span class="linenos">2349</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2350"><a href="#L-2350"><span class="linenos">2350</span></a>
</span><span id="L-2351"><a href="#L-2351"><span class="linenos">2351</span></a>        <span class="c1"># Trigger garbage collection</span>
</span><span id="L-2352"><a href="#L-2352"><span class="linenos">2352</span></a>        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="L-2353"><a href="#L-2353"><span class="linenos">2353</span></a>
</span><span id="L-2354"><a href="#L-2354"><span class="linenos">2354</span></a>        <span class="c1"># Accept the close event to exit</span>
</span><span id="L-2355"><a href="#L-2355"><span class="linenos">2355</span></a>        <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span><span id="L-2356"><a href="#L-2356"><span class="linenos">2356</span></a>
</span><span id="L-2357"><a href="#L-2357"><span class="linenos">2357</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset_overlay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2358"><a href="#L-2358"><span class="linenos">2358</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset all overlay-related UI elements and internal variables.&quot;&quot;&quot;</span>
</span><span id="L-2359"><a href="#L-2359"><span class="linenos">2359</span></a>        <span class="c1"># Disable the automatic ROI overlay mode</span>
</span><span id="L-2360"><a href="#L-2360"><span class="linenos">2360</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2361"><a href="#L-2361"><span class="linenos">2361</span></a>        <span class="c1"># Disable the &quot;Save ROI&quot; button since theres no active overlay</span>
</span><span id="L-2362"><a href="#L-2362"><span class="linenos">2362</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2363"><a href="#L-2363"><span class="linenos">2363</span></a>        <span class="c1"># Clear all overlay-related data</span>
</span><span id="L-2364"><a href="#L-2364"><span class="linenos">2364</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2365"><a href="#L-2365"><span class="linenos">2365</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2366"><a href="#L-2366"><span class="linenos">2366</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_dims</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2367"><a href="#L-2367"><span class="linenos">2367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_file_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2368"><a href="#L-2368"><span class="linenos">2368</span></a>        <span class="c1"># Hide and disable the overlay parameter sliders group (radius/difference)</span>
</span><span id="L-2369"><a href="#L-2369"><span class="linenos">2369</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2370"><a href="#L-2370"><span class="linenos">2370</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2371"><a href="#L-2371"><span class="linenos">2371</span></a>        <span class="c1"># Ensure overlay visualization is turned off</span>
</span><span id="L-2372"><a href="#L-2372"><span class="linenos">2372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_overlay</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2373"><a href="#L-2373"><span class="linenos">2373</span></a>        <span class="c1"># Disable and uncheck the overlay checkbox in UI</span>
</span><span id="L-2374"><a href="#L-2374"><span class="linenos">2374</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2375"><a href="#L-2375"><span class="linenos">2375</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2376"><a href="#L-2376"><span class="linenos">2376</span></a>        <span class="c1"># Reset overlay info label to default text</span>
</span><span id="L-2377"><a href="#L-2377"><span class="linenos">2377</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
</span><span id="L-2378"><a href="#L-2378"><span class="linenos">2378</span></a>            <span class="sa">f</span><span class="s2">&quot;Overlay:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
</span><span id="L-2379"><a href="#L-2379"><span class="linenos">2379</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span>
</span><span id="L-2380"><a href="#L-2380"><span class="linenos">2380</span></a>        <span class="p">)</span>
</span><span id="L-2381"><a href="#L-2381"><span class="linenos">2381</span></a>
</span><span id="L-2382"><a href="#L-2382"><span class="linenos">2382</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">resetROI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2383"><a href="#L-2383"><span class="linenos">2383</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset all ROI-related UI elements and internal variables.&quot;&quot;&quot;</span>
</span><span id="L-2384"><a href="#L-2384"><span class="linenos">2384</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2385"><a href="#L-2385"><span class="linenos">2385</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2386"><a href="#L-2386"><span class="linenos">2386</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2387"><a href="#L-2387"><span class="linenos">2387</span></a>
</span><span id="L-2388"><a href="#L-2388"><span class="linenos">2388</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_incrementalROI</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2389"><a href="#L-2389"><span class="linenos">2389</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2390"><a href="#L-2390"><span class="linenos">2390</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2391"><a href="#L-2391"><span class="linenos">2391</span></a>
</span><span id="L-2392"><a href="#L-2392"><span class="linenos">2392</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_automaticROI</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2393"><a href="#L-2393"><span class="linenos">2393</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2394"><a href="#L-2394"><span class="linenos">2394</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2395"><a href="#L-2395"><span class="linenos">2395</span></a>
</span><span id="L-2396"><a href="#L-2396"><span class="linenos">2396</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2397"><a href="#L-2397"><span class="linenos">2397</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2398"><a href="#L-2398"><span class="linenos">2398</span></a>
</span><span id="L-2399"><a href="#L-2399"><span class="linenos">2399</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2400"><a href="#L-2400"><span class="linenos">2400</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2401"><a href="#L-2401"><span class="linenos">2401</span></a>
</span><span id="L-2402"><a href="#L-2402"><span class="linenos">2402</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic ROI&quot;</span><span class="p">))</span>
</span><span id="L-2403"><a href="#L-2403"><span class="linenos">2403</span></a>
</span><span id="L-2404"><a href="#L-2404"><span class="linenos">2404</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2405"><a href="#L-2405"><span class="linenos">2405</span></a>
</span><span id="L-2406"><a href="#L-2406"><span class="linenos">2406</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_origins</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2407"><a href="#L-2407"><span class="linenos">2407</span></a>
</span><span id="L-2408"><a href="#L-2408"><span class="linenos">2408</span></a>
</span><span id="L-2409"><a href="#L-2409"><span class="linenos">2409</span></a>
</span><span id="L-2410"><a href="#L-2410"><span class="linenos">2410</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pad_volume_to_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">,</span> <span class="n">constant_value</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-2411"><a href="#L-2411"><span class="linenos">2411</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2412"><a href="#L-2412"><span class="linenos">2412</span></a><span class="sd">        Pad a 3D volume (NumPy array) symmetrically to match a desired target shape.</span>
</span><span id="L-2413"><a href="#L-2413"><span class="linenos">2413</span></a>
</span><span id="L-2414"><a href="#L-2414"><span class="linenos">2414</span></a><span class="sd">        Args:</span>
</span><span id="L-2415"><a href="#L-2415"><span class="linenos">2415</span></a><span class="sd">            volume (np.ndarray): Input 3D volume to pad.</span>
</span><span id="L-2416"><a href="#L-2416"><span class="linenos">2416</span></a><span class="sd">            target_shape (tuple[int]): Desired (X, Y, Z) dimensions after padding.</span>
</span><span id="L-2417"><a href="#L-2417"><span class="linenos">2417</span></a><span class="sd">            constant_value (int or float, optional): Value used for padding. Defaults to 0.</span>
</span><span id="L-2418"><a href="#L-2418"><span class="linenos">2418</span></a>
</span><span id="L-2419"><a href="#L-2419"><span class="linenos">2419</span></a><span class="sd">        Returns:</span>
</span><span id="L-2420"><a href="#L-2420"><span class="linenos">2420</span></a><span class="sd">            np.ndarray: The padded 3D array with dimensions matching target_shape.</span>
</span><span id="L-2421"><a href="#L-2421"><span class="linenos">2421</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2422"><a href="#L-2422"><span class="linenos">2422</span></a>        <span class="n">current_shape</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-2423"><a href="#L-2423"><span class="linenos">2423</span></a>        <span class="n">pads</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store pad widths for each axis</span>
</span><span id="L-2424"><a href="#L-2424"><span class="linenos">2424</span></a>
</span><span id="L-2425"><a href="#L-2425"><span class="linenos">2425</span></a>        <span class="c1"># Compute symmetric padding for each axis</span>
</span><span id="L-2426"><a href="#L-2426"><span class="linenos">2426</span></a>        <span class="k">for</span> <span class="n">cur</span><span class="p">,</span> <span class="n">tgt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">current_shape</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">):</span>
</span><span id="L-2427"><a href="#L-2427"><span class="linenos">2427</span></a>            <span class="n">diff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tgt</span> <span class="o">-</span> <span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Calculate missing voxels along this axis</span>
</span><span id="L-2428"><a href="#L-2428"><span class="linenos">2428</span></a>            <span class="n">pad_before</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># Padding before the data</span>
</span><span id="L-2429"><a href="#L-2429"><span class="linenos">2429</span></a>            <span class="n">pad_after</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">-</span> <span class="n">pad_before</span>  <span class="c1"># Padding after the data</span>
</span><span id="L-2430"><a href="#L-2430"><span class="linenos">2430</span></a>            <span class="n">pads</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pad_before</span><span class="p">,</span> <span class="n">pad_after</span><span class="p">))</span>  <span class="c1"># Add as (before, after) pair</span>
</span><span id="L-2431"><a href="#L-2431"><span class="linenos">2431</span></a>
</span><span id="L-2432"><a href="#L-2432"><span class="linenos">2432</span></a>        <span class="c1"># Apply constant padding and return result</span>
</span><span id="L-2433"><a href="#L-2433"><span class="linenos">2433</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">volume</span><span class="p">,</span> <span class="n">pads</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="n">constant_value</span><span class="p">)</span>
</span><span id="L-2434"><a href="#L-2434"><span class="linenos">2434</span></a>
</span><span id="L-2435"><a href="#L-2435"><span class="linenos">2435</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_scroll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">plane_idx</span><span class="p">,</span><span class="n">delta</span><span class="p">):</span>
</span><span id="L-2436"><a href="#L-2436"><span class="linenos">2436</span></a>        <span class="k">if</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Axial (XY plane)</span>
</span><span id="L-2437"><a href="#L-2437"><span class="linenos">2437</span></a>            <span class="k">if</span> <span class="n">delta</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-2438"><a href="#L-2438"><span class="linenos">2438</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2439"><a href="#L-2439"><span class="linenos">2439</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2440"><a href="#L-2440"><span class="linenos">2440</span></a>            <span class="k">elif</span> <span class="n">delta</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-2441"><a href="#L-2441"><span class="linenos">2441</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2442"><a href="#L-2442"><span class="linenos">2442</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2443"><a href="#L-2443"><span class="linenos">2443</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2444"><a href="#L-2444"><span class="linenos">2444</span></a>                <span class="k">return</span>
</span><span id="L-2445"><a href="#L-2445"><span class="linenos">2445</span></a>        <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Coronal (XZ plane)</span>
</span><span id="L-2446"><a href="#L-2446"><span class="linenos">2446</span></a>            <span class="k">if</span> <span class="n">delta</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-2447"><a href="#L-2447"><span class="linenos">2447</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2448"><a href="#L-2448"><span class="linenos">2448</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2449"><a href="#L-2449"><span class="linenos">2449</span></a>            <span class="k">elif</span> <span class="n">delta</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-2450"><a href="#L-2450"><span class="linenos">2450</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2451"><a href="#L-2451"><span class="linenos">2451</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2452"><a href="#L-2452"><span class="linenos">2452</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2453"><a href="#L-2453"><span class="linenos">2453</span></a>                <span class="k">return</span>
</span><span id="L-2454"><a href="#L-2454"><span class="linenos">2454</span></a>        <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sagittal (YZ plane)</span>
</span><span id="L-2455"><a href="#L-2455"><span class="linenos">2455</span></a>            <span class="k">if</span> <span class="n">delta</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-2456"><a href="#L-2456"><span class="linenos">2456</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2457"><a href="#L-2457"><span class="linenos">2457</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2458"><a href="#L-2458"><span class="linenos">2458</span></a>            <span class="k">elif</span> <span class="n">delta</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-2459"><a href="#L-2459"><span class="linenos">2459</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2460"><a href="#L-2460"><span class="linenos">2460</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2461"><a href="#L-2461"><span class="linenos">2461</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2462"><a href="#L-2462"><span class="linenos">2462</span></a>                <span class="k">return</span>
</span><span id="L-2463"><a href="#L-2463"><span class="linenos">2463</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2464"><a href="#L-2464"><span class="linenos">2464</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Plane index out of range&quot;</span><span class="p">)</span>
</span><span id="L-2465"><a href="#L-2465"><span class="linenos">2465</span></a>            <span class="k">return</span>
</span><span id="L-2466"><a href="#L-2466"><span class="linenos">2466</span></a>            <span class="c1"># Synchronize controls for all planes</span>
</span><span id="L-2467"><a href="#L-2467"><span class="linenos">2467</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="L-2468"><a href="#L-2468"><span class="linenos">2468</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-2469"><a href="#L-2469"><span class="linenos">2469</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-2470"><a href="#L-2470"><span class="linenos">2470</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_cross_view_lines</span><span class="p">()</span>
</span><span id="L-2471"><a href="#L-2471"><span class="linenos">2471</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_coordinate_displays</span><span class="p">()</span>
</span><span id="L-2472"><a href="#L-2472"><span class="linenos">2472</span></a>
</span><span id="L-2473"><a href="#L-2473"><span class="linenos">2473</span></a>
</span><span id="L-2474"><a href="#L-2474"><span class="linenos">2474</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_translate_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2475"><a href="#L-2475"><span class="linenos">2475</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2476"><a href="#L-2476"><span class="linenos">2476</span></a><span class="sd">        Update all UI texts for internationalization (i18n).</span>
</span><span id="L-2477"><a href="#L-2477"><span class="linenos">2477</span></a>
</span><span id="L-2478"><a href="#L-2478"><span class="linenos">2478</span></a><span class="sd">        This function ensures that all interface elements are dynamically translated</span>
</span><span id="L-2479"><a href="#L-2479"><span class="linenos">2479</span></a><span class="sd">        using Qts translation system. It is typically called when initializing</span>
</span><span id="L-2480"><a href="#L-2480"><span class="linenos">2480</span></a><span class="sd">        or changing the application language.</span>
</span><span id="L-2481"><a href="#L-2481"><span class="linenos">2481</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2482"><a href="#L-2482"><span class="linenos">2482</span></a>        <span class="c1"># Set the main window title</span>
</span><span id="L-2483"><a href="#L-2483"><span class="linenos">2483</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;NIfTI Image Viewer&quot;</span><span class="p">))</span>
</span><span id="L-2484"><a href="#L-2484"><span class="linenos">2484</span></a>
</span><span id="L-2485"><a href="#L-2485"><span class="linenos">2485</span></a>        <span class="c1"># Status bar initial message</span>
</span><span id="L-2486"><a href="#L-2486"><span class="linenos">2486</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
</span><span id="L-2487"><a href="#L-2487"><span class="linenos">2487</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Ready - Open a NIfTI file to begin&quot;</span><span class="p">))</span>
</span><span id="L-2488"><a href="#L-2488"><span class="linenos">2488</span></a>
</span><span id="L-2489"><a href="#L-2489"><span class="linenos">2489</span></a>        <span class="c1"># Initialize coordinate and value display labels</span>
</span><span id="L-2490"><a href="#L-2490"><span class="linenos">2490</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coordinates: (-, -, -)&quot;</span><span class="p">))</span>
</span><span id="L-2491"><a href="#L-2491"><span class="linenos">2491</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Value: -&quot;</span><span class="p">))</span>
</span><span id="L-2492"><a href="#L-2492"><span class="linenos">2492</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Slice: -/-&quot;</span><span class="p">))</span>
</span><span id="L-2493"><a href="#L-2493"><span class="linenos">2493</span></a>
</span><span id="L-2494"><a href="#L-2494"><span class="linenos">2494</span></a>        <span class="c1"># File open button label</span>
</span><span id="L-2495"><a href="#L-2495"><span class="linenos">2495</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot; Open NIfTI File&quot;</span><span class="p">))</span>
</span><span id="L-2496"><a href="#L-2496"><span class="linenos">2496</span></a>
</span><span id="L-2497"><a href="#L-2497"><span class="linenos">2497</span></a>        <span class="c1"># Default file information message</span>
</span><span id="L-2498"><a href="#L-2498"><span class="linenos">2498</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No file loaded&quot;</span><span class="p">))</span>
</span><span id="L-2499"><a href="#L-2499"><span class="linenos">2499</span></a>
</span><span id="L-2500"><a href="#L-2500"><span class="linenos">2500</span></a>        <span class="c1"># Plane labels for orthogonal slice views</span>
</span><span id="L-2501"><a href="#L-2501"><span class="linenos">2501</span></a>        <span class="n">plane_names</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-2502"><a href="#L-2502"><span class="linenos">2502</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Axial (Z)&quot;</span><span class="p">),</span>
</span><span id="L-2503"><a href="#L-2503"><span class="linenos">2503</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coronal (Y)&quot;</span><span class="p">),</span>
</span><span id="L-2504"><a href="#L-2504"><span class="linenos">2504</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Sagittal (X)&quot;</span><span class="p">)</span>
</span><span id="L-2505"><a href="#L-2505"><span class="linenos">2505</span></a>        <span class="p">]</span>
</span><span id="L-2506"><a href="#L-2506"><span class="linenos">2506</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plane_names</span><span class="p">):</span>
</span><span id="L-2507"><a href="#L-2507"><span class="linenos">2507</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plane_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
</span><span id="L-2508"><a href="#L-2508"><span class="linenos">2508</span></a>
</span><span id="L-2509"><a href="#L-2509"><span class="linenos">2509</span></a>        <span class="c1"># Time navigation controls</span>
</span><span id="L-2510"><a href="#L-2510"><span class="linenos">2510</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Enable 4D Time Navigation&quot;</span><span class="p">))</span>
</span><span id="L-2511"><a href="#L-2511"><span class="linenos">2511</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Time Point:&quot;</span><span class="p">))</span>
</span><span id="L-2512"><a href="#L-2512"><span class="linenos">2512</span></a>
</span><span id="L-2513"><a href="#L-2513"><span class="linenos">2513</span></a>        <span class="c1"># Display options section label</span>
</span><span id="L-2514"><a href="#L-2514"><span class="linenos">2514</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Display Options:&quot;</span><span class="p">))</span>
</span><span id="L-2515"><a href="#L-2515"><span class="linenos">2515</span></a>
</span><span id="L-2516"><a href="#L-2516"><span class="linenos">2516</span></a>        <span class="c1"># Populate color map combo box options</span>
</span><span id="L-2517"><a href="#L-2517"><span class="linenos">2517</span></a>        <span class="n">colormap_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="s1">&#39;bone&#39;</span><span class="p">]</span>
</span><span id="L-2518"><a href="#L-2518"><span class="linenos">2518</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">colormap_names</span><span class="p">):</span>
</span><span id="L-2519"><a href="#L-2519"><span class="linenos">2519</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="o">.</span><span class="n">setItemText</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-2520"><a href="#L-2520"><span class="linenos">2520</span></a>
</span><span id="L-2521"><a href="#L-2521"><span class="linenos">2521</span></a>        <span class="c1"># Label for colormap and overlay control sections</span>
</span><span id="L-2522"><a href="#L-2522"><span class="linenos">2522</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Colormap:&quot;</span><span class="p">))</span>
</span><span id="L-2523"><a href="#L-2523"><span class="linenos">2523</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay Controls:&quot;</span><span class="p">))</span>
</span><span id="L-2524"><a href="#L-2524"><span class="linenos">2524</span></a>
</span><span id="L-2525"><a href="#L-2525"><span class="linenos">2525</span></a>        <span class="c1"># Overlay loading and visibility controls</span>
</span><span id="L-2526"><a href="#L-2526"><span class="linenos">2526</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Load NIfTI Overlay&quot;</span><span class="p">))</span>
</span><span id="L-2527"><a href="#L-2527"><span class="linenos">2527</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Show Overlay&quot;</span><span class="p">))</span>
</span><span id="L-2528"><a href="#L-2528"><span class="linenos">2528</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_overlay_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay Transparency:&quot;</span><span class="p">))</span>
</span><span id="L-2529"><a href="#L-2529"><span class="linenos">2529</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay Threshold:&quot;</span><span class="p">))</span>
</span><span id="L-2530"><a href="#L-2530"><span class="linenos">2530</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No overlay loaded&quot;</span><span class="p">))</span>
</span><span id="L-2531"><a href="#L-2531"><span class="linenos">2531</span></a>
</span><span id="L-2532"><a href="#L-2532"><span class="linenos">2532</span></a>        <span class="c1"># Titles for image view panels</span>
</span><span id="L-2533"><a href="#L-2533"><span class="linenos">2533</span></a>        <span class="n">view_titles</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-2534"><a href="#L-2534"><span class="linenos">2534</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Axial&quot;</span><span class="p">),</span>
</span><span id="L-2535"><a href="#L-2535"><span class="linenos">2535</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coronal&quot;</span><span class="p">),</span>
</span><span id="L-2536"><a href="#L-2536"><span class="linenos">2536</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Sagittal&quot;</span><span class="p">)</span>
</span><span id="L-2537"><a href="#L-2537"><span class="linenos">2537</span></a>        <span class="p">]</span>
</span><span id="L-2538"><a href="#L-2538"><span class="linenos">2538</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">view_titles</span><span class="p">):</span>
</span><span id="L-2539"><a href="#L-2539"><span class="linenos">2539</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view_titles_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="L-2540"><a href="#L-2540"><span class="linenos">2540</span></a>
</span><span id="L-2541"><a href="#L-2541"><span class="linenos">2541</span></a>        <span class="c1"># Update fourth view title and general info text</span>
</span><span id="L-2542"><a href="#L-2542"><span class="linenos">2542</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="o">.</span><span class="n">text</span><span class="p">()))</span>
</span><span id="L-2543"><a href="#L-2543"><span class="linenos">2543</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No image loaded&quot;</span><span class="p">))</span>
</span><span id="L-2544"><a href="#L-2544"><span class="linenos">2544</span></a>
</span><span id="L-2545"><a href="#L-2545"><span class="linenos">2545</span></a>        <span class="c1"># If an image file is already loaded, update the displayed metadata</span>
</span><span id="L-2546"><a href="#L-2546"><span class="linenos">2546</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">:</span>
</span><span id="L-2547"><a href="#L-2547"><span class="linenos">2547</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="L-2548"><a href="#L-2548"><span class="linenos">2548</span></a>            <span class="n">dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span>
</span><span id="L-2549"><a href="#L-2549"><span class="linenos">2549</span></a>            <span class="c1"># Distinguish between 3D and 4D datasets</span>
</span><span id="L-2550"><a href="#L-2550"><span class="linenos">2550</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="L-2551"><a href="#L-2551"><span class="linenos">2551</span></a>                <span class="n">info_text</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-2552"><a href="#L-2552"><span class="linenos">2552</span></a>                        <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;File&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
</span><span id="L-2553"><a href="#L-2553"><span class="linenos">2553</span></a>                        <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span> <span class="o">+</span>
</span><span id="L-2554"><a href="#L-2554"><span class="linenos">2554</span></a>                        <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
</span><span id="L-2555"><a href="#L-2555"><span class="linenos">2555</span></a>                        <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;4D Time Series&quot;</span><span class="p">)</span>
</span><span id="L-2556"><a href="#L-2556"><span class="linenos">2556</span></a>                <span class="p">)</span>
</span><span id="L-2557"><a href="#L-2557"><span class="linenos">2557</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2558"><a href="#L-2558"><span class="linenos">2558</span></a>                <span class="n">info_text</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-2559"><a href="#L-2559"><span class="linenos">2559</span></a>                        <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;File&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
</span><span id="L-2560"><a href="#L-2560"><span class="linenos">2560</span></a>                        <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span> <span class="o">+</span>
</span><span id="L-2561"><a href="#L-2561"><span class="linenos">2561</span></a>                        <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
</span><span id="L-2562"><a href="#L-2562"><span class="linenos">2562</span></a>                        <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;3D Volume&quot;</span><span class="p">)</span>
</span><span id="L-2563"><a href="#L-2563"><span class="linenos">2563</span></a>                <span class="p">)</span>
</span><span id="L-2564"><a href="#L-2564"><span class="linenos">2564</span></a>
</span><span id="L-2565"><a href="#L-2565"><span class="linenos">2565</span></a>            <span class="c1"># Update file info labels and sidebar text</span>
</span><span id="L-2566"><a href="#L-2566"><span class="linenos">2566</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">info_text</span><span class="p">)</span>
</span><span id="L-2567"><a href="#L-2567"><span class="linenos">2567</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">info_text</span><span class="p">)</span>
</span><span id="L-2568"><a href="#L-2568"><span class="linenos">2568</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2569"><a href="#L-2569"><span class="linenos">2569</span></a>            <span class="c1"># Fallback text shown when no NIfTI file is loaded</span>
</span><span id="L-2570"><a href="#L-2570"><span class="linenos">2570</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No file loaded&quot;</span><span class="p">))</span>
</span><span id="L-2571"><a href="#L-2571"><span class="linenos">2571</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No image loaded&quot;</span><span class="p">))</span>
</span></pre></div>


            </section>
                <section id="log">
                    <div class="attr variable">
            <span class="name">log</span>        =
<span class="default_value">&lt;Logger GliAAns-UI (WARNING)&gt;</span>

        
    </div>
    <a class="headerlink" href="#log"></a>
    
    

                </section>
                <section id="compute_mask_numba_mm">
                            <input id="compute_mask_numba_mm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-njit">@njit(parallel=True)</div>

        <span class="def">def</span>
        <span class="name">compute_mask_numba_mm</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">img</span>,</span><span class="param">	<span class="n">x0</span>,</span><span class="param">	<span class="n">y0</span>,</span><span class="param">	<span class="n">z0</span>,</span><span class="param">	<span class="n">radius_mm</span>,</span><span class="param">	<span class="n">voxel_sizes</span>,</span><span class="param">	<span class="n">seed_intensity</span>,</span><span class="param">	<span class="n">diff</span>,</span><span class="param">	<span class="n">x_min</span>,</span><span class="param">	<span class="n">x_max</span>,</span><span class="param">	<span class="n">y_min</span>,</span><span class="param">	<span class="n">y_max</span>,</span><span class="param">	<span class="n">z_min</span>,</span><span class="param">	<span class="n">z_max</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="compute_mask_numba_mm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#compute_mask_numba_mm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="compute_mask_numba_mm-47"><a href="#compute_mask_numba_mm-47"><span class="linenos">47</span></a><span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="compute_mask_numba_mm-48"><a href="#compute_mask_numba_mm-48"><span class="linenos">48</span></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_mask_numba_mm</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">radius_mm</span><span class="p">,</span> <span class="n">voxel_sizes</span><span class="p">,</span>
</span><span id="compute_mask_numba_mm-49"><a href="#compute_mask_numba_mm-49"><span class="linenos">49</span></a>                          <span class="n">seed_intensity</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span>
</span><span id="compute_mask_numba_mm-50"><a href="#compute_mask_numba_mm-50"><span class="linenos">50</span></a>                          <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span><span class="p">):</span>
</span><span id="compute_mask_numba_mm-51"><a href="#compute_mask_numba_mm-51"><span class="linenos">51</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="compute_mask_numba_mm-52"><a href="#compute_mask_numba_mm-52"><span class="linenos">52</span></a><span class="sd">    Compute a binary spherical mask around a seed point in millimeter space.</span>
</span><span id="compute_mask_numba_mm-53"><a href="#compute_mask_numba_mm-53"><span class="linenos">53</span></a>
</span><span id="compute_mask_numba_mm-54"><a href="#compute_mask_numba_mm-54"><span class="linenos">54</span></a><span class="sd">    This function is compiled with Numba for high-performance execution and</span>
</span><span id="compute_mask_numba_mm-55"><a href="#compute_mask_numba_mm-55"><span class="linenos">55</span></a><span class="sd">    performs voxel-wise checks to include all voxels within a given radius</span>
</span><span id="compute_mask_numba_mm-56"><a href="#compute_mask_numba_mm-56"><span class="linenos">56</span></a><span class="sd">    (in mm) and within a specified intensity difference from a seed value.</span>
</span><span id="compute_mask_numba_mm-57"><a href="#compute_mask_numba_mm-57"><span class="linenos">57</span></a>
</span><span id="compute_mask_numba_mm-58"><a href="#compute_mask_numba_mm-58"><span class="linenos">58</span></a><span class="sd">    Args:</span>
</span><span id="compute_mask_numba_mm-59"><a href="#compute_mask_numba_mm-59"><span class="linenos">59</span></a><span class="sd">        img (np.ndarray): Input 3D image array.</span>
</span><span id="compute_mask_numba_mm-60"><a href="#compute_mask_numba_mm-60"><span class="linenos">60</span></a><span class="sd">        x0, y0, z0 (int): Coordinates of the seed voxel.</span>
</span><span id="compute_mask_numba_mm-61"><a href="#compute_mask_numba_mm-61"><span class="linenos">61</span></a><span class="sd">        radius_mm (float): Radius of the spherical mask in millimeters.</span>
</span><span id="compute_mask_numba_mm-62"><a href="#compute_mask_numba_mm-62"><span class="linenos">62</span></a><span class="sd">        voxel_sizes (tuple[float, float, float]): Physical voxel sizes along each axis.</span>
</span><span id="compute_mask_numba_mm-63"><a href="#compute_mask_numba_mm-63"><span class="linenos">63</span></a><span class="sd">        seed_intensity (float): Intensity value at the seed voxel.</span>
</span><span id="compute_mask_numba_mm-64"><a href="#compute_mask_numba_mm-64"><span class="linenos">64</span></a><span class="sd">        diff (float): Maximum allowed intensity difference from the seed.</span>
</span><span id="compute_mask_numba_mm-65"><a href="#compute_mask_numba_mm-65"><span class="linenos">65</span></a><span class="sd">        x_min, x_max, y_min, y_max, z_min, z_max (int): Bounding box limits in voxel space.</span>
</span><span id="compute_mask_numba_mm-66"><a href="#compute_mask_numba_mm-66"><span class="linenos">66</span></a>
</span><span id="compute_mask_numba_mm-67"><a href="#compute_mask_numba_mm-67"><span class="linenos">67</span></a><span class="sd">    Returns:</span>
</span><span id="compute_mask_numba_mm-68"><a href="#compute_mask_numba_mm-68"><span class="linenos">68</span></a><span class="sd">        np.ndarray: Binary mask (uint8) with 1 where the voxel meets the criteria.</span>
</span><span id="compute_mask_numba_mm-69"><a href="#compute_mask_numba_mm-69"><span class="linenos">69</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="compute_mask_numba_mm-70"><a href="#compute_mask_numba_mm-70"><span class="linenos">70</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="compute_mask_numba_mm-71"><a href="#compute_mask_numba_mm-71"><span class="linenos">71</span></a>    <span class="n">r2</span> <span class="o">=</span> <span class="n">radius_mm</span> <span class="o">*</span> <span class="n">radius_mm</span>
</span><span id="compute_mask_numba_mm-72"><a href="#compute_mask_numba_mm-72"><span class="linenos">72</span></a>    <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="n">voxel_sizes</span>  <span class="c1"># voxel dimensions in mm</span>
</span><span id="compute_mask_numba_mm-73"><a href="#compute_mask_numba_mm-73"><span class="linenos">73</span></a>
</span><span id="compute_mask_numba_mm-74"><a href="#compute_mask_numba_mm-74"><span class="linenos">74</span></a>    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">):</span>
</span><span id="compute_mask_numba_mm-75"><a href="#compute_mask_numba_mm-75"><span class="linenos">75</span></a>        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">):</span>
</span><span id="compute_mask_numba_mm-76"><a href="#compute_mask_numba_mm-76"><span class="linenos">76</span></a>            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span><span class="p">):</span>
</span><span id="compute_mask_numba_mm-77"><a href="#compute_mask_numba_mm-77"><span class="linenos">77</span></a>                <span class="n">dx_mm</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">vx</span>
</span><span id="compute_mask_numba_mm-78"><a href="#compute_mask_numba_mm-78"><span class="linenos">78</span></a>                <span class="n">dy_mm</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">*</span> <span class="n">vy</span>
</span><span id="compute_mask_numba_mm-79"><a href="#compute_mask_numba_mm-79"><span class="linenos">79</span></a>                <span class="n">dz_mm</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">z0</span><span class="p">)</span> <span class="o">*</span> <span class="n">vz</span>
</span><span id="compute_mask_numba_mm-80"><a href="#compute_mask_numba_mm-80"><span class="linenos">80</span></a>                <span class="k">if</span> <span class="n">dx_mm</span> <span class="o">*</span> <span class="n">dx_mm</span> <span class="o">+</span> <span class="n">dy_mm</span> <span class="o">*</span> <span class="n">dy_mm</span> <span class="o">+</span> <span class="n">dz_mm</span> <span class="o">*</span> <span class="n">dz_mm</span> <span class="o">&lt;=</span> <span class="n">r2</span><span class="p">:</span>
</span><span id="compute_mask_numba_mm-81"><a href="#compute_mask_numba_mm-81"><span class="linenos">81</span></a>                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span> <span class="o">-</span> <span class="n">seed_intensity</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="compute_mask_numba_mm-82"><a href="#compute_mask_numba_mm-82"><span class="linenos">82</span></a>                        <span class="n">mask</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="compute_mask_numba_mm-83"><a href="#compute_mask_numba_mm-83"><span class="linenos">83</span></a>    <span class="k">return</span> <span class="n">mask</span>
</span></pre></div>


            <div class="docstring"><p>Compute a binary spherical mask around a seed point in millimeter space.</p>

<p>This function is compiled with Numba for high-performance execution and
performs voxel-wise checks to include all voxels within a given radius
(in mm) and within a specified intensity difference from a seed value.</p>

<p>Args:
    img (np.ndarray): Input 3D image array.
    x0, y0, z0 (int): Coordinates of the seed voxel.
    radius_mm (float): Radius of the spherical mask in millimeters.
    voxel_sizes (tuple[float, float, float]): Physical voxel sizes along each axis.
    seed_intensity (float): Intensity value at the seed voxel.
    diff (float): Maximum allowed intensity difference from the seed.
    x_min, x_max, y_min, y_max, z_min, z_max (int): Bounding box limits in voxel space.</p>

<p>Returns:
    np.ndarray: Binary mask (uint8) with 1 where the voxel meets the criteria.</p>
</div>


                </section>
                <section id="apply_overlay_numba">
                            <input id="apply_overlay_numba-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-njit">@njit(parallel=True)</div>

        <span class="def">def</span>
        <span class="name">apply_overlay_numba</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">rgba_image</span>, </span><span class="param"><span class="n">overlay_mask</span>, </span><span class="param"><span class="n">overlay_intensity</span>, </span><span class="param"><span class="n">overlay_color</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="apply_overlay_numba-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#apply_overlay_numba"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="apply_overlay_numba-86"><a href="#apply_overlay_numba-86"><span class="linenos"> 86</span></a><span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="apply_overlay_numba-87"><a href="#apply_overlay_numba-87"><span class="linenos"> 87</span></a><span class="k">def</span><span class="w"> </span><span class="nf">apply_overlay_numba</span><span class="p">(</span><span class="n">rgba_image</span><span class="p">,</span> <span class="n">overlay_mask</span><span class="p">,</span> <span class="n">overlay_intensity</span><span class="p">,</span> <span class="n">overlay_color</span><span class="p">):</span>
</span><span id="apply_overlay_numba-88"><a href="#apply_overlay_numba-88"><span class="linenos"> 88</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="apply_overlay_numba-89"><a href="#apply_overlay_numba-89"><span class="linenos"> 89</span></a><span class="sd">    Apply a semi-transparent overlay to an RGBA image.</span>
</span><span id="apply_overlay_numba-90"><a href="#apply_overlay_numba-90"><span class="linenos"> 90</span></a>
</span><span id="apply_overlay_numba-91"><a href="#apply_overlay_numba-91"><span class="linenos"> 91</span></a><span class="sd">    This function adds colorized overlay regions based on the provided mask and</span>
</span><span id="apply_overlay_numba-92"><a href="#apply_overlay_numba-92"><span class="linenos"> 92</span></a><span class="sd">    intensity map, applying blending only on RGB channels.</span>
</span><span id="apply_overlay_numba-93"><a href="#apply_overlay_numba-93"><span class="linenos"> 93</span></a>
</span><span id="apply_overlay_numba-94"><a href="#apply_overlay_numba-94"><span class="linenos"> 94</span></a><span class="sd">    Args:</span>
</span><span id="apply_overlay_numba-95"><a href="#apply_overlay_numba-95"><span class="linenos"> 95</span></a><span class="sd">        rgba_image (np.ndarray): Base image (H, W, 3) in float format (01 range).</span>
</span><span id="apply_overlay_numba-96"><a href="#apply_overlay_numba-96"><span class="linenos"> 96</span></a><span class="sd">        overlay_mask (np.ndarray): Binary mask (H, W) specifying overlay pixels.</span>
</span><span id="apply_overlay_numba-97"><a href="#apply_overlay_numba-97"><span class="linenos"> 97</span></a><span class="sd">        overlay_intensity (np.ndarray): Intensity weight map (H, W) for overlay blending.</span>
</span><span id="apply_overlay_numba-98"><a href="#apply_overlay_numba-98"><span class="linenos"> 98</span></a><span class="sd">        overlay_color (tuple[float, float, float]): RGB overlay color (01 range).</span>
</span><span id="apply_overlay_numba-99"><a href="#apply_overlay_numba-99"><span class="linenos"> 99</span></a>
</span><span id="apply_overlay_numba-100"><a href="#apply_overlay_numba-100"><span class="linenos">100</span></a><span class="sd">    Returns:</span>
</span><span id="apply_overlay_numba-101"><a href="#apply_overlay_numba-101"><span class="linenos">101</span></a><span class="sd">        np.ndarray: Modified RGBA image with overlay applied.</span>
</span><span id="apply_overlay_numba-102"><a href="#apply_overlay_numba-102"><span class="linenos">102</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="apply_overlay_numba-103"><a href="#apply_overlay_numba-103"><span class="linenos">103</span></a>    <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">rgba_image</span><span class="o">.</span><span class="n">shape</span>
</span><span id="apply_overlay_numba-104"><a href="#apply_overlay_numba-104"><span class="linenos">104</span></a>    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
</span><span id="apply_overlay_numba-105"><a href="#apply_overlay_numba-105"><span class="linenos">105</span></a>        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
</span><span id="apply_overlay_numba-106"><a href="#apply_overlay_numba-106"><span class="linenos">106</span></a>            <span class="k">if</span> <span class="n">overlay_mask</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]:</span>
</span><span id="apply_overlay_numba-107"><a href="#apply_overlay_numba-107"><span class="linenos">107</span></a>                <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="apply_overlay_numba-108"><a href="#apply_overlay_numba-108"><span class="linenos">108</span></a>                    <span class="c1"># Apply color to RGB channels only</span>
</span><span id="apply_overlay_numba-109"><a href="#apply_overlay_numba-109"><span class="linenos">109</span></a>                    <span class="k">if</span> <span class="n">overlay_color</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="apply_overlay_numba-110"><a href="#apply_overlay_numba-110"><span class="linenos">110</span></a>                        <span class="n">rgba_image</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rgba_image</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ch</span><span class="p">]</span> <span class="o">+</span> <span class="n">overlay_intensity</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="n">overlay_color</span><span class="p">[</span><span class="n">ch</span><span class="p">])</span>
</span><span id="apply_overlay_numba-111"><a href="#apply_overlay_numba-111"><span class="linenos">111</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="apply_overlay_numba-112"><a href="#apply_overlay_numba-112"><span class="linenos">112</span></a>                        <span class="n">rgba_image</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ch</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">overlay_intensity</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">])</span>
</span><span id="apply_overlay_numba-113"><a href="#apply_overlay_numba-113"><span class="linenos">113</span></a>    <span class="k">return</span> <span class="n">rgba_image</span>
</span></pre></div>


            <div class="docstring"><p>Apply a semi-transparent overlay to an RGBA image.</p>

<p>This function adds colorized overlay regions based on the provided mask and
intensity map, applying blending only on RGB channels.</p>

<p>Args:
    rgba_image (np.ndarray): Base image (H, W, 3) in float format (01 range).
    overlay_mask (np.ndarray): Binary mask (H, W) specifying overlay pixels.
    overlay_intensity (np.ndarray): Intensity weight map (H, W) for overlay blending.
    overlay_color (tuple[float, float, float]): RGB overlay color (01 range).</p>

<p>Returns:
    np.ndarray: Modified RGBA image with overlay applied.</p>
</div>


                </section>
                <section id="NiftiViewer">
                            <input id="NiftiViewer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">NiftiViewer</span><wbr>(<span class="base">PyQt6.QtWidgets.QMainWindow</span>):

                <label class="view-source-button" for="NiftiViewer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer-131"><a href="#NiftiViewer-131"><span class="linenos"> 131</span></a><span class="k">class</span><span class="w"> </span><span class="nc">NiftiViewer</span><span class="p">(</span><span class="n">QMainWindow</span><span class="p">):</span>
</span><span id="NiftiViewer-132"><a href="#NiftiViewer-132"><span class="linenos"> 132</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-133"><a href="#NiftiViewer-133"><span class="linenos"> 133</span></a><span class="sd">    Main application window for viewing and interacting with NIfTI images.</span>
</span><span id="NiftiViewer-134"><a href="#NiftiViewer-134"><span class="linenos"> 134</span></a>
</span><span id="NiftiViewer-135"><a href="#NiftiViewer-135"><span class="linenos"> 135</span></a><span class="sd">    This class provides a complete NIfTI image viewer with:</span>
</span><span id="NiftiViewer-136"><a href="#NiftiViewer-136"><span class="linenos"> 136</span></a><span class="sd">      - Triplanar slice visualization (axial, coronal, sagittal)</span>
</span><span id="NiftiViewer-137"><a href="#NiftiViewer-137"><span class="linenos"> 137</span></a><span class="sd">      - Support for 4D volumes (time series)</span>
</span><span id="NiftiViewer-138"><a href="#NiftiViewer-138"><span class="linenos"> 138</span></a><span class="sd">      - Overlay support for mask visualization</span>
</span><span id="NiftiViewer-139"><a href="#NiftiViewer-139"><span class="linenos"> 139</span></a><span class="sd">      - Interactive ROI drawing and threshold-based segmentation</span>
</span><span id="NiftiViewer-140"><a href="#NiftiViewer-140"><span class="linenos"> 140</span></a><span class="sd">      - Threaded image loading/saving</span>
</span><span id="NiftiViewer-141"><a href="#NiftiViewer-141"><span class="linenos"> 141</span></a>
</span><span id="NiftiViewer-142"><a href="#NiftiViewer-142"><span class="linenos"> 142</span></a><span class="sd">    Attributes:</span>
</span><span id="NiftiViewer-143"><a href="#NiftiViewer-143"><span class="linenos"> 143</span></a><span class="sd">        context (dict): Optional shared context for multi-component communication.</span>
</span><span id="NiftiViewer-144"><a href="#NiftiViewer-144"><span class="linenos"> 144</span></a><span class="sd">        img_data (np.ndarray): Loaded image data.</span>
</span><span id="NiftiViewer-145"><a href="#NiftiViewer-145"><span class="linenos"> 145</span></a><span class="sd">        overlay_data (np.ndarray): Optional overlay volume.</span>
</span><span id="NiftiViewer-146"><a href="#NiftiViewer-146"><span class="linenos"> 146</span></a><span class="sd">        affine (np.ndarray): Image affine transformation matrix.</span>
</span><span id="NiftiViewer-147"><a href="#NiftiViewer-147"><span class="linenos"> 147</span></a><span class="sd">        voxel_sizes (tuple[float]): Voxel dimensions (mm).</span>
</span><span id="NiftiViewer-148"><a href="#NiftiViewer-148"><span class="linenos"> 148</span></a><span class="sd">        current_slices (list[int]): Current indices for each viewing plane.</span>
</span><span id="NiftiViewer-149"><a href="#NiftiViewer-149"><span class="linenos"> 149</span></a><span class="sd">        current_time (int): Current time frame (for 4D data).</span>
</span><span id="NiftiViewer-150"><a href="#NiftiViewer-150"><span class="linenos"> 150</span></a><span class="sd">        overlay_alpha (float): Overlay transparency level.</span>
</span><span id="NiftiViewer-151"><a href="#NiftiViewer-151"><span class="linenos"> 151</span></a><span class="sd">        overlay_threshold (float): Intensity threshold for overlay visibility.</span>
</span><span id="NiftiViewer-152"><a href="#NiftiViewer-152"><span class="linenos"> 152</span></a><span class="sd">        colormap (str): Current colormap name used for visualization.</span>
</span><span id="NiftiViewer-153"><a href="#NiftiViewer-153"><span class="linenos"> 153</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-154"><a href="#NiftiViewer-154"><span class="linenos"> 154</span></a>
</span><span id="NiftiViewer-155"><a href="#NiftiViewer-155"><span class="linenos"> 155</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="NiftiViewer-156"><a href="#NiftiViewer-156"><span class="linenos"> 156</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-157"><a href="#NiftiViewer-157"><span class="linenos"> 157</span></a><span class="sd">        Initialize the NIfTI Viewer window and prepare all internal components.</span>
</span><span id="NiftiViewer-158"><a href="#NiftiViewer-158"><span class="linenos"> 158</span></a>
</span><span id="NiftiViewer-159"><a href="#NiftiViewer-159"><span class="linenos"> 159</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-160"><a href="#NiftiViewer-160"><span class="linenos"> 160</span></a><span class="sd">            context (dict, optional): Shared context for language translation and inter-component signaling.</span>
</span><span id="NiftiViewer-161"><a href="#NiftiViewer-161"><span class="linenos"> 161</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-162"><a href="#NiftiViewer-162"><span class="linenos"> 162</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="NiftiViewer-163"><a href="#NiftiViewer-163"><span class="linenos"> 163</span></a>
</span><span id="NiftiViewer-164"><a href="#NiftiViewer-164"><span class="linenos"> 164</span></a>
</span><span id="NiftiViewer-165"><a href="#NiftiViewer-165"><span class="linenos"> 165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer-166"><a href="#NiftiViewer-166"><span class="linenos"> 166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
</span><span id="NiftiViewer-167"><a href="#NiftiViewer-167"><span class="linenos"> 167</span></a>
</span><span id="NiftiViewer-168"><a href="#NiftiViewer-168"><span class="linenos"> 168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-169"><a href="#NiftiViewer-169"><span class="linenos"> 169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;NIfTI Image Viewer&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-170"><a href="#NiftiViewer-170"><span class="linenos"> 170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setMinimumSize</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">700</span><span class="p">)</span>
</span><span id="NiftiViewer-171"><a href="#NiftiViewer-171"><span class="linenos"> 171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="NiftiViewer-172"><a href="#NiftiViewer-172"><span class="linenos"> 172</span></a>
</span><span id="NiftiViewer-173"><a href="#NiftiViewer-173"><span class="linenos"> 173</span></a>        <span class="c1"># === Image data variables ===</span>
</span><span id="NiftiViewer-174"><a href="#NiftiViewer-174"><span class="linenos"> 174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-175"><a href="#NiftiViewer-175"><span class="linenos"> 175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">affine</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-176"><a href="#NiftiViewer-176"><span class="linenos"> 176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-177"><a href="#NiftiViewer-177"><span class="linenos"> 177</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="NiftiViewer-178"><a href="#NiftiViewer-178"><span class="linenos"> 178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># axial, coronal, sagittal slice indices</span>
</span><span id="NiftiViewer-179"><a href="#NiftiViewer-179"><span class="linenos"> 179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="NiftiViewer-180"><a href="#NiftiViewer-180"><span class="linenos"> 180</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># x, y, z voxel coordinates</span>
</span><span id="NiftiViewer-181"><a href="#NiftiViewer-181"><span class="linenos"> 181</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-182"><a href="#NiftiViewer-182"><span class="linenos"> 182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stretch_factors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="NiftiViewer-183"><a href="#NiftiViewer-183"><span class="linenos"> 183</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-184"><a href="#NiftiViewer-184"><span class="linenos"> 184</span></a>
</span><span id="NiftiViewer-185"><a href="#NiftiViewer-185"><span class="linenos"> 185</span></a>        <span class="c1"># === Overlay-related attributes ===</span>
</span><span id="NiftiViewer-186"><a href="#NiftiViewer-186"><span class="linenos"> 186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-187"><a href="#NiftiViewer-187"><span class="linenos"> 187</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_dims</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-188"><a href="#NiftiViewer-188"><span class="linenos"> 188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha</span> <span class="o">=</span> <span class="mf">0.7</span>
</span><span id="NiftiViewer-189"><a href="#NiftiViewer-189"><span class="linenos"> 189</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="NiftiViewer-190"><a href="#NiftiViewer-190"><span class="linenos"> 190</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="NiftiViewer-191"><a href="#NiftiViewer-191"><span class="linenos"> 191</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_file_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-192"><a href="#NiftiViewer-192"><span class="linenos"> 192</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_max</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="NiftiViewer-193"><a href="#NiftiViewer-193"><span class="linenos"> 193</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-194"><a href="#NiftiViewer-194"><span class="linenos"> 194</span></a>
</span><span id="NiftiViewer-195"><a href="#NiftiViewer-195"><span class="linenos"> 195</span></a>        <span class="c1"># === UI element placeholders ===</span>
</span><span id="NiftiViewer-196"><a href="#NiftiViewer-196"><span class="linenos"> 196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-197"><a href="#NiftiViewer-197"><span class="linenos"> 197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plane_labels</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-198"><a href="#NiftiViewer-198"><span class="linenos"> 198</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-199"><a href="#NiftiViewer-199"><span class="linenos"> 199</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_info_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-200"><a href="#NiftiViewer-200"><span class="linenos"> 200</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-201"><a href="#NiftiViewer-201"><span class="linenos"> 201</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-202"><a href="#NiftiViewer-202"><span class="linenos"> 202</span></a>
</span><span id="NiftiViewer-203"><a href="#NiftiViewer-203"><span class="linenos"> 203</span></a>        <span class="c1"># === Visualization color configuration ===</span>
</span><span id="NiftiViewer-204"><a href="#NiftiViewer-204"><span class="linenos"> 204</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
</span><span id="NiftiViewer-205"><a href="#NiftiViewer-205"><span class="linenos"> 205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_colors</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="NiftiViewer-206"><a href="#NiftiViewer-206"><span class="linenos"> 206</span></a>            <span class="s2">&quot;gray&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span>
</span><span id="NiftiViewer-207"><a href="#NiftiViewer-207"><span class="linenos"> 207</span></a>            <span class="s2">&quot;viridis&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span>
</span><span id="NiftiViewer-208"><a href="#NiftiViewer-208"><span class="linenos"> 208</span></a>            <span class="s2">&quot;plasma&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span>
</span><span id="NiftiViewer-209"><a href="#NiftiViewer-209"><span class="linenos"> 209</span></a>            <span class="s2">&quot;inferno&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span>
</span><span id="NiftiViewer-210"><a href="#NiftiViewer-210"><span class="linenos"> 210</span></a>            <span class="s2">&quot;magma&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span>
</span><span id="NiftiViewer-211"><a href="#NiftiViewer-211"><span class="linenos"> 211</span></a>            <span class="s2">&quot;hot&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span>
</span><span id="NiftiViewer-212"><a href="#NiftiViewer-212"><span class="linenos"> 212</span></a>            <span class="s2">&quot;cool&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span>
</span><span id="NiftiViewer-213"><a href="#NiftiViewer-213"><span class="linenos"> 213</span></a>            <span class="s2">&quot;bone&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
</span><span id="NiftiViewer-214"><a href="#NiftiViewer-214"><span class="linenos"> 214</span></a>        <span class="p">}</span>
</span><span id="NiftiViewer-215"><a href="#NiftiViewer-215"><span class="linenos"> 215</span></a>
</span><span id="NiftiViewer-216"><a href="#NiftiViewer-216"><span class="linenos"> 216</span></a>        <span class="c1"># === Viewer components ===</span>
</span><span id="NiftiViewer-217"><a href="#NiftiViewer-217"><span class="linenos"> 217</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">views</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer-218"><a href="#NiftiViewer-218"><span class="linenos"> 218</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer-219"><a href="#NiftiViewer-219"><span class="linenos"> 219</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pixmap_items</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer-220"><a href="#NiftiViewer-220"><span class="linenos"> 220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer-221"><a href="#NiftiViewer-221"><span class="linenos"> 221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer-222"><a href="#NiftiViewer-222"><span class="linenos"> 222</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer-223"><a href="#NiftiViewer-223"><span class="linenos"> 223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_displays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer-224"><a href="#NiftiViewer-224"><span class="linenos"> 224</span></a>
</span><span id="NiftiViewer-225"><a href="#NiftiViewer-225"><span class="linenos"> 225</span></a>        <span class="c1"># === Time-series visualization (for 4D data) ===</span>
</span><span id="NiftiViewer-226"><a href="#NiftiViewer-226"><span class="linenos"> 226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-227"><a href="#NiftiViewer-227"><span class="linenos"> 227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-228"><a href="#NiftiViewer-228"><span class="linenos"> 228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-229"><a href="#NiftiViewer-229"><span class="linenos"> 229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-230"><a href="#NiftiViewer-230"><span class="linenos"> 230</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-231"><a href="#NiftiViewer-231"><span class="linenos"> 231</span></a>
</span><span id="NiftiViewer-232"><a href="#NiftiViewer-232"><span class="linenos"> 232</span></a>        <span class="c1"># === Additional UI components ===</span>
</span><span id="NiftiViewer-233"><a href="#NiftiViewer-233"><span class="linenos"> 233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-234"><a href="#NiftiViewer-234"><span class="linenos"> 234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-235"><a href="#NiftiViewer-235"><span class="linenos"> 235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-236"><a href="#NiftiViewer-236"><span class="linenos"> 236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-237"><a href="#NiftiViewer-237"><span class="linenos"> 237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-238"><a href="#NiftiViewer-238"><span class="linenos"> 238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-239"><a href="#NiftiViewer-239"><span class="linenos"> 239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-240"><a href="#NiftiViewer-240"><span class="linenos"> 240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-241"><a href="#NiftiViewer-241"><span class="linenos"> 241</span></a>
</span><span id="NiftiViewer-242"><a href="#NiftiViewer-242"><span class="linenos"> 242</span></a>        <span class="c1"># === Automatic ROI drawing ===</span>
</span><span id="NiftiViewer-243"><a href="#NiftiViewer-243"><span class="linenos"> 243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-244"><a href="#NiftiViewer-244"><span class="linenos"> 244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automatic_ROI_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-245"><a href="#NiftiViewer-245"><span class="linenos"> 245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-246"><a href="#NiftiViewer-246"><span class="linenos"> 246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="NiftiViewer-247"><a href="#NiftiViewer-247"><span class="linenos"> 247</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-248"><a href="#NiftiViewer-248"><span class="linenos"> 248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-249"><a href="#NiftiViewer-249"><span class="linenos"> 249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-250"><a href="#NiftiViewer-250"><span class="linenos"> 250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">AutomaticROI_diff_slider</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-251"><a href="#NiftiViewer-251"><span class="linenos"> 251</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-252"><a href="#NiftiViewer-252"><span class="linenos"> 252</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_seed_coordinates</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-253"><a href="#NiftiViewer-253"><span class="linenos"> 253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-254"><a href="#NiftiViewer-254"><span class="linenos"> 254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-255"><a href="#NiftiViewer-255"><span class="linenos"> 255</span></a>
</span><span id="NiftiViewer-256"><a href="#NiftiViewer-256"><span class="linenos"> 256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-257"><a href="#NiftiViewer-257"><span class="linenos"> 257</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-258"><a href="#NiftiViewer-258"><span class="linenos"> 258</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="NiftiViewer-259"><a href="#NiftiViewer-259"><span class="linenos"> 259</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-260"><a href="#NiftiViewer-260"><span class="linenos"> 260</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-261"><a href="#NiftiViewer-261"><span class="linenos"> 261</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_origins</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer-262"><a href="#NiftiViewer-262"><span class="linenos"> 262</span></a>
</span><span id="NiftiViewer-263"><a href="#NiftiViewer-263"><span class="linenos"> 263</span></a>        <span class="c1"># === Initialize and connect the UI ===</span>
</span><span id="NiftiViewer-264"><a href="#NiftiViewer-264"><span class="linenos"> 264</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_ui</span><span class="p">()</span>
</span><span id="NiftiViewer-265"><a href="#NiftiViewer-265"><span class="linenos"> 265</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setup_connections</span><span class="p">()</span>
</span><span id="NiftiViewer-266"><a href="#NiftiViewer-266"><span class="linenos"> 266</span></a>
</span><span id="NiftiViewer-267"><a href="#NiftiViewer-267"><span class="linenos"> 267</span></a>        <span class="c1"># === Translation setup ===</span>
</span><span id="NiftiViewer-268"><a href="#NiftiViewer-268"><span class="linenos"> 268</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_translate_ui</span><span class="p">()</span>
</span><span id="NiftiViewer-269"><a href="#NiftiViewer-269"><span class="linenos"> 269</span></a>        <span class="k">if</span> <span class="n">context</span> <span class="ow">and</span> <span class="s2">&quot;language_changed&quot;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
</span><span id="NiftiViewer-270"><a href="#NiftiViewer-270"><span class="linenos"> 270</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;language_changed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_translate_ui</span><span class="p">)</span>
</span><span id="NiftiViewer-271"><a href="#NiftiViewer-271"><span class="linenos"> 271</span></a>
</span><span id="NiftiViewer-272"><a href="#NiftiViewer-272"><span class="linenos"> 272</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-273"><a href="#NiftiViewer-273"><span class="linenos"> 273</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-274"><a href="#NiftiViewer-274"><span class="linenos"> 274</span></a><span class="sd">        Initialize the main user interface of the NIfTI Viewer.</span>
</span><span id="NiftiViewer-275"><a href="#NiftiViewer-275"><span class="linenos"> 275</span></a>
</span><span id="NiftiViewer-276"><a href="#NiftiViewer-276"><span class="linenos"> 276</span></a><span class="sd">        This method builds the primary application layout, including:</span>
</span><span id="NiftiViewer-277"><a href="#NiftiViewer-277"><span class="linenos"> 277</span></a><span class="sd">        - A central widget that contains a horizontal splitter.</span>
</span><span id="NiftiViewer-278"><a href="#NiftiViewer-278"><span class="linenos"> 278</span></a><span class="sd">        - A left control panel for user interactions (file operations, display options, etc.).</span>
</span><span id="NiftiViewer-279"><a href="#NiftiViewer-279"><span class="linenos"> 279</span></a><span class="sd">        - A right area dedicated to image visualization.</span>
</span><span id="NiftiViewer-280"><a href="#NiftiViewer-280"><span class="linenos"> 280</span></a><span class="sd">        - A status bar for displaying real-time information (coordinates, intensity values, slice index).</span>
</span><span id="NiftiViewer-281"><a href="#NiftiViewer-281"><span class="linenos"> 281</span></a>
</span><span id="NiftiViewer-282"><a href="#NiftiViewer-282"><span class="linenos"> 282</span></a><span class="sd">        The layout uses a responsive design with adjustable proportions between</span>
</span><span id="NiftiViewer-283"><a href="#NiftiViewer-283"><span class="linenos"> 283</span></a><span class="sd">        the control panel and the image display area.</span>
</span><span id="NiftiViewer-284"><a href="#NiftiViewer-284"><span class="linenos"> 284</span></a>
</span><span id="NiftiViewer-285"><a href="#NiftiViewer-285"><span class="linenos"> 285</span></a><span class="sd">        Raises:</span>
</span><span id="NiftiViewer-286"><a href="#NiftiViewer-286"><span class="linenos"> 286</span></a><span class="sd">            Exception: Propagates exceptions from widget creation or layout setup.</span>
</span><span id="NiftiViewer-287"><a href="#NiftiViewer-287"><span class="linenos"> 287</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-288"><a href="#NiftiViewer-288"><span class="linenos"> 288</span></a>        <span class="c1"># Create the central widget that will contain the main splitter</span>
</span><span id="NiftiViewer-289"><a href="#NiftiViewer-289"><span class="linenos"> 289</span></a>        <span class="n">central_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer-290"><a href="#NiftiViewer-290"><span class="linenos"> 290</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setCentralWidget</span><span class="p">(</span><span class="n">central_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-291"><a href="#NiftiViewer-291"><span class="linenos"> 291</span></a>
</span><span id="NiftiViewer-292"><a href="#NiftiViewer-292"><span class="linenos"> 292</span></a>        <span class="c1"># Create a horizontal splitter for side-by-side layout (control panel + image display)</span>
</span><span id="NiftiViewer-293"><a href="#NiftiViewer-293"><span class="linenos"> 293</span></a>        <span class="n">main_splitter</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="NiftiViewer-294"><a href="#NiftiViewer-294"><span class="linenos"> 294</span></a>        <span class="n">central_widget</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">central_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-295"><a href="#NiftiViewer-295"><span class="linenos"> 295</span></a>        <span class="n">central_widget</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer-296"><a href="#NiftiViewer-296"><span class="linenos"> 296</span></a>        <span class="n">central_widget</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">main_splitter</span><span class="p">)</span>
</span><span id="NiftiViewer-297"><a href="#NiftiViewer-297"><span class="linenos"> 297</span></a>
</span><span id="NiftiViewer-298"><a href="#NiftiViewer-298"><span class="linenos"> 298</span></a>        <span class="c1"># Initialize and attach the left control panel to the splitter</span>
</span><span id="NiftiViewer-299"><a href="#NiftiViewer-299"><span class="linenos"> 299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">create_control_panel</span><span class="p">(</span><span class="n">main_splitter</span><span class="p">)</span>
</span><span id="NiftiViewer-300"><a href="#NiftiViewer-300"><span class="linenos"> 300</span></a>
</span><span id="NiftiViewer-301"><a href="#NiftiViewer-301"><span class="linenos"> 301</span></a>        <span class="c1"># Initialize and attach the right image display area to the splitter</span>
</span><span id="NiftiViewer-302"><a href="#NiftiViewer-302"><span class="linenos"> 302</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">create_image_display</span><span class="p">(</span><span class="n">main_splitter</span><span class="p">)</span>
</span><span id="NiftiViewer-303"><a href="#NiftiViewer-303"><span class="linenos"> 303</span></a>
</span><span id="NiftiViewer-304"><a href="#NiftiViewer-304"><span class="linenos"> 304</span></a>        <span class="c1"># Define relative sizes and resizing behavior of the splitter sections</span>
</span><span id="NiftiViewer-305"><a href="#NiftiViewer-305"><span class="linenos"> 305</span></a>        <span class="n">main_splitter</span><span class="o">.</span><span class="n">setSizes</span><span class="p">([</span><span class="mi">300</span><span class="p">,</span> <span class="mi">1100</span><span class="p">])</span>  <span class="c1"># Default size proportions</span>
</span><span id="NiftiViewer-306"><a href="#NiftiViewer-306"><span class="linenos"> 306</span></a>        <span class="n">main_splitter</span><span class="o">.</span><span class="n">setStretchFactor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Fix the control panel width</span>
</span><span id="NiftiViewer-307"><a href="#NiftiViewer-307"><span class="linenos"> 307</span></a>        <span class="n">main_splitter</span><span class="o">.</span><span class="n">setStretchFactor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Allow image display to stretch</span>
</span><span id="NiftiViewer-308"><a href="#NiftiViewer-308"><span class="linenos"> 308</span></a>
</span><span id="NiftiViewer-309"><a href="#NiftiViewer-309"><span class="linenos"> 309</span></a>        <span class="c1"># Create and set up the status bar at the bottom of the window</span>
</span><span id="NiftiViewer-310"><a href="#NiftiViewer-310"><span class="linenos"> 310</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span> <span class="o">=</span> <span class="n">QStatusBar</span><span class="p">()</span>
</span><span id="NiftiViewer-311"><a href="#NiftiViewer-311"><span class="linenos"> 311</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setStatusBar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="p">)</span>
</span><span id="NiftiViewer-312"><a href="#NiftiViewer-312"><span class="linenos"> 312</span></a>
</span><span id="NiftiViewer-313"><a href="#NiftiViewer-313"><span class="linenos"> 313</span></a>        <span class="c1"># Initialize status bar labels for dynamic coordinate and voxel value display</span>
</span><span id="NiftiViewer-314"><a href="#NiftiViewer-314"><span class="linenos"> 314</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coordinates: (-, -, -)&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-315"><a href="#NiftiViewer-315"><span class="linenos"> 315</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Value: -&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-316"><a href="#NiftiViewer-316"><span class="linenos"> 316</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_info_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Slice: -/-&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-317"><a href="#NiftiViewer-317"><span class="linenos"> 317</span></a>
</span><span id="NiftiViewer-318"><a href="#NiftiViewer-318"><span class="linenos"> 318</span></a>        <span class="c1"># Display initial status message when the viewer is ready</span>
</span><span id="NiftiViewer-319"><a href="#NiftiViewer-319"><span class="linenos"> 319</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
</span><span id="NiftiViewer-320"><a href="#NiftiViewer-320"><span class="linenos"> 320</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Ready - Open a NIfTI file to begin&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-321"><a href="#NiftiViewer-321"><span class="linenos"> 321</span></a>        <span class="p">)</span>
</span><span id="NiftiViewer-322"><a href="#NiftiViewer-322"><span class="linenos"> 322</span></a>
</span><span id="NiftiViewer-323"><a href="#NiftiViewer-323"><span class="linenos"> 323</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_control_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
</span><span id="NiftiViewer-324"><a href="#NiftiViewer-324"><span class="linenos"> 324</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-325"><a href="#NiftiViewer-325"><span class="linenos"> 325</span></a><span class="sd">        Create the left-side control panel for the NIfTI Viewer interface.</span>
</span><span id="NiftiViewer-326"><a href="#NiftiViewer-326"><span class="linenos"> 326</span></a>
</span><span id="NiftiViewer-327"><a href="#NiftiViewer-327"><span class="linenos"> 327</span></a><span class="sd">        This method builds an interactive, scrollable control panel that allows</span>
</span><span id="NiftiViewer-328"><a href="#NiftiViewer-328"><span class="linenos"> 328</span></a><span class="sd">        the user to:</span>
</span><span id="NiftiViewer-329"><a href="#NiftiViewer-329"><span class="linenos"> 329</span></a><span class="sd">          - Open and display NIfTI files.</span>
</span><span id="NiftiViewer-330"><a href="#NiftiViewer-330"><span class="linenos"> 330</span></a><span class="sd">          - Navigate through 2D slices in axial, coronal, and sagittal planes.</span>
</span><span id="NiftiViewer-331"><a href="#NiftiViewer-331"><span class="linenos"> 331</span></a><span class="sd">          - Control time navigation for 4D datasets.</span>
</span><span id="NiftiViewer-332"><a href="#NiftiViewer-332"><span class="linenos"> 332</span></a><span class="sd">          - Adjust visualization parameters such as colormap and display options.</span>
</span><span id="NiftiViewer-333"><a href="#NiftiViewer-333"><span class="linenos"> 333</span></a><span class="sd">          - Perform automatic ROI (Region of Interest) generation.</span>
</span><span id="NiftiViewer-334"><a href="#NiftiViewer-334"><span class="linenos"> 334</span></a><span class="sd">          - Manage overlay images (load, transparency, threshold, enable/disable).</span>
</span><span id="NiftiViewer-335"><a href="#NiftiViewer-335"><span class="linenos"> 335</span></a>
</span><span id="NiftiViewer-336"><a href="#NiftiViewer-336"><span class="linenos"> 336</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-337"><a href="#NiftiViewer-337"><span class="linenos"> 337</span></a><span class="sd">            parent (QSplitter): The parent splitter widget where the control panel is added.</span>
</span><span id="NiftiViewer-338"><a href="#NiftiViewer-338"><span class="linenos"> 338</span></a>
</span><span id="NiftiViewer-339"><a href="#NiftiViewer-339"><span class="linenos"> 339</span></a><span class="sd">        Raises:</span>
</span><span id="NiftiViewer-340"><a href="#NiftiViewer-340"><span class="linenos"> 340</span></a><span class="sd">            Exception: Propagates exceptions from any UI creation or layout step.</span>
</span><span id="NiftiViewer-341"><a href="#NiftiViewer-341"><span class="linenos"> 341</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-342"><a href="#NiftiViewer-342"><span class="linenos"> 342</span></a>
</span><span id="NiftiViewer-343"><a href="#NiftiViewer-343"><span class="linenos"> 343</span></a>        <span class="c1"># Scroll area wrapper (enables vertical scrolling for the control panel)</span>
</span><span id="NiftiViewer-344"><a href="#NiftiViewer-344"><span class="linenos"> 344</span></a>        <span class="n">scroll_area</span> <span class="o">=</span> <span class="n">QScrollArea</span><span class="p">()</span>
</span><span id="NiftiViewer-345"><a href="#NiftiViewer-345"><span class="linenos"> 345</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setWidgetResizable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-346"><a href="#NiftiViewer-346"><span class="linenos"> 346</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setHorizontalScrollBarPolicy</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ScrollBarPolicy</span><span class="o">.</span><span class="n">ScrollBarAlwaysOff</span><span class="p">)</span>
</span><span id="NiftiViewer-347"><a href="#NiftiViewer-347"><span class="linenos"> 347</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setVerticalScrollBarPolicy</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ScrollBarPolicy</span><span class="o">.</span><span class="n">ScrollBarAsNeeded</span><span class="p">)</span>
</span><span id="NiftiViewer-348"><a href="#NiftiViewer-348"><span class="linenos"> 348</span></a>
</span><span id="NiftiViewer-349"><a href="#NiftiViewer-349"><span class="linenos"> 349</span></a>        <span class="c1"># Control panel main content widget and layout</span>
</span><span id="NiftiViewer-350"><a href="#NiftiViewer-350"><span class="linenos"> 350</span></a>        <span class="n">control_content</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer-351"><a href="#NiftiViewer-351"><span class="linenos"> 351</span></a>        <span class="n">control_content</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">340</span><span class="p">)</span>  <span class="c1"># Prevent horizontal scrolling</span>
</span><span id="NiftiViewer-352"><a href="#NiftiViewer-352"><span class="linenos"> 352</span></a>        <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">control_content</span><span class="p">)</span>
</span><span id="NiftiViewer-353"><a href="#NiftiViewer-353"><span class="linenos"> 353</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span><span id="NiftiViewer-354"><a href="#NiftiViewer-354"><span class="linenos"> 354</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="NiftiViewer-355"><a href="#NiftiViewer-355"><span class="linenos"> 355</span></a>
</span><span id="NiftiViewer-356"><a href="#NiftiViewer-356"><span class="linenos"> 356</span></a>        <span class="c1"># ========================</span>
</span><span id="NiftiViewer-357"><a href="#NiftiViewer-357"><span class="linenos"> 357</span></a>        <span class="c1"># File Operations Group</span>
</span><span id="NiftiViewer-358"><a href="#NiftiViewer-358"><span class="linenos"> 358</span></a>        <span class="c1"># ========================</span>
</span><span id="NiftiViewer-359"><a href="#NiftiViewer-359"><span class="linenos"> 359</span></a>        <span class="n">file_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer-360"><a href="#NiftiViewer-360"><span class="linenos"> 360</span></a>        <span class="n">file_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">file_group</span><span class="p">)</span>
</span><span id="NiftiViewer-361"><a href="#NiftiViewer-361"><span class="linenos"> 361</span></a>        <span class="n">file_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer-362"><a href="#NiftiViewer-362"><span class="linenos"> 362</span></a>
</span><span id="NiftiViewer-363"><a href="#NiftiViewer-363"><span class="linenos"> 363</span></a>        <span class="c1"># Button to open NIfTI files</span>
</span><span id="NiftiViewer-364"><a href="#NiftiViewer-364"><span class="linenos"> 364</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot; Open NIfTI&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-365"><a href="#NiftiViewer-365"><span class="linenos"> 365</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
</span><span id="NiftiViewer-366"><a href="#NiftiViewer-366"><span class="linenos"> 366</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
</span><span id="NiftiViewer-367"><a href="#NiftiViewer-367"><span class="linenos"> 367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-368"><a href="#NiftiViewer-368"><span class="linenos"> 368</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Open NIfTI File&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-369"><a href="#NiftiViewer-369"><span class="linenos"> 369</span></a>        <span class="n">file_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="p">)</span>
</span><span id="NiftiViewer-370"><a href="#NiftiViewer-370"><span class="linenos"> 370</span></a>
</span><span id="NiftiViewer-371"><a href="#NiftiViewer-371"><span class="linenos"> 371</span></a>        <span class="c1"># Label displaying currently loaded file info</span>
</span><span id="NiftiViewer-372"><a href="#NiftiViewer-372"><span class="linenos"> 372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No file loaded&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-373"><a href="#NiftiViewer-373"><span class="linenos"> 373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setWordWrap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-374"><a href="#NiftiViewer-374"><span class="linenos"> 374</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-375"><a href="#NiftiViewer-375"><span class="linenos"> 375</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">)</span>
</span><span id="NiftiViewer-376"><a href="#NiftiViewer-376"><span class="linenos"> 376</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="NiftiViewer-377"><a href="#NiftiViewer-377"><span class="linenos"> 377</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
</span><span id="NiftiViewer-378"><a href="#NiftiViewer-378"><span class="linenos"> 378</span></a>        <span class="n">file_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="p">)</span>
</span><span id="NiftiViewer-379"><a href="#NiftiViewer-379"><span class="linenos"> 379</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">file_group</span><span class="p">)</span>
</span><span id="NiftiViewer-380"><a href="#NiftiViewer-380"><span class="linenos"> 380</span></a>
</span><span id="NiftiViewer-381"><a href="#NiftiViewer-381"><span class="linenos"> 381</span></a>        <span class="c1"># =====================</span>
</span><span id="NiftiViewer-382"><a href="#NiftiViewer-382"><span class="linenos"> 382</span></a>        <span class="c1"># Slice Navigation</span>
</span><span id="NiftiViewer-383"><a href="#NiftiViewer-383"><span class="linenos"> 383</span></a>        <span class="c1"># =====================</span>
</span><span id="NiftiViewer-384"><a href="#NiftiViewer-384"><span class="linenos"> 384</span></a>        <span class="n">slice_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer-385"><a href="#NiftiViewer-385"><span class="linenos"> 385</span></a>        <span class="n">slice_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">slice_group</span><span class="p">)</span>
</span><span id="NiftiViewer-386"><a href="#NiftiViewer-386"><span class="linenos"> 386</span></a>        <span class="n">slice_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer-387"><a href="#NiftiViewer-387"><span class="linenos"> 387</span></a>
</span><span id="NiftiViewer-388"><a href="#NiftiViewer-388"><span class="linenos"> 388</span></a>        <span class="c1"># Section label</span>
</span><span id="NiftiViewer-389"><a href="#NiftiViewer-389"><span class="linenos"> 389</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Slice Navigation:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-390"><a href="#NiftiViewer-390"><span class="linenos"> 390</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-391"><a href="#NiftiViewer-391"><span class="linenos"> 391</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="NiftiViewer-392"><a href="#NiftiViewer-392"><span class="linenos"> 392</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; font-size: 11px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-393"><a href="#NiftiViewer-393"><span class="linenos"> 393</span></a>        <span class="n">slice_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span><span class="p">)</span>
</span><span id="NiftiViewer-394"><a href="#NiftiViewer-394"><span class="linenos"> 394</span></a>
</span><span id="NiftiViewer-395"><a href="#NiftiViewer-395"><span class="linenos"> 395</span></a>        <span class="n">plane_names</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="NiftiViewer-396"><a href="#NiftiViewer-396"><span class="linenos"> 396</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Axial (Z)&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer-397"><a href="#NiftiViewer-397"><span class="linenos"> 397</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coronal (Y)&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer-398"><a href="#NiftiViewer-398"><span class="linenos"> 398</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Sagittal (X)&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-399"><a href="#NiftiViewer-399"><span class="linenos"> 399</span></a>        <span class="p">]</span>
</span><span id="NiftiViewer-400"><a href="#NiftiViewer-400"><span class="linenos"> 400</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plane_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer-401"><a href="#NiftiViewer-401"><span class="linenos"> 401</span></a>
</span><span id="NiftiViewer-402"><a href="#NiftiViewer-402"><span class="linenos"> 402</span></a>        <span class="c1"># Create controls for each anatomical plane</span>
</span><span id="NiftiViewer-403"><a href="#NiftiViewer-403"><span class="linenos"> 403</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">plane_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plane_names</span><span class="p">):</span>
</span><span id="NiftiViewer-404"><a href="#NiftiViewer-404"><span class="linenos"> 404</span></a>            <span class="c1"># Label for plane name</span>
</span><span id="NiftiViewer-405"><a href="#NiftiViewer-405"><span class="linenos"> 405</span></a>            <span class="n">label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">plane_name</span><span class="p">)</span>
</span><span id="NiftiViewer-406"><a href="#NiftiViewer-406"><span class="linenos"> 406</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plane_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="NiftiViewer-407"><a href="#NiftiViewer-407"><span class="linenos"> 407</span></a>            <span class="n">label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; margin-top: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-408"><a href="#NiftiViewer-408"><span class="linenos"> 408</span></a>            <span class="n">label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-409"><a href="#NiftiViewer-409"><span class="linenos"> 409</span></a>            <span class="n">slice_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="NiftiViewer-410"><a href="#NiftiViewer-410"><span class="linenos"> 410</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="NiftiViewer-411"><a href="#NiftiViewer-411"><span class="linenos"> 411</span></a>
</span><span id="NiftiViewer-412"><a href="#NiftiViewer-412"><span class="linenos"> 412</span></a>            <span class="c1"># Container for slider + spinbox + coordinates</span>
</span><span id="NiftiViewer-413"><a href="#NiftiViewer-413"><span class="linenos"> 413</span></a>            <span class="n">controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer-414"><a href="#NiftiViewer-414"><span class="linenos"> 414</span></a>            <span class="n">controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-415"><a href="#NiftiViewer-415"><span class="linenos"> 415</span></a>            <span class="n">controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-416"><a href="#NiftiViewer-416"><span class="linenos"> 416</span></a>            <span class="n">controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer-417"><a href="#NiftiViewer-417"><span class="linenos"> 417</span></a>
</span><span id="NiftiViewer-418"><a href="#NiftiViewer-418"><span class="linenos"> 418</span></a>            <span class="c1"># Slice slider</span>
</span><span id="NiftiViewer-419"><a href="#NiftiViewer-419"><span class="linenos"> 419</span></a>            <span class="n">slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="NiftiViewer-420"><a href="#NiftiViewer-420"><span class="linenos"> 420</span></a>            <span class="n">slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-421"><a href="#NiftiViewer-421"><span class="linenos"> 421</span></a>            <span class="n">slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="NiftiViewer-422"><a href="#NiftiViewer-422"><span class="linenos"> 422</span></a>            <span class="n">slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="NiftiViewer-423"><a href="#NiftiViewer-423"><span class="linenos"> 423</span></a>            <span class="n">slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-424"><a href="#NiftiViewer-424"><span class="linenos"> 424</span></a>            <span class="n">controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer-425"><a href="#NiftiViewer-425"><span class="linenos"> 425</span></a>
</span><span id="NiftiViewer-426"><a href="#NiftiViewer-426"><span class="linenos"> 426</span></a>            <span class="c1"># Spinbox to match slider</span>
</span><span id="NiftiViewer-427"><a href="#NiftiViewer-427"><span class="linenos"> 427</span></a>            <span class="n">spinbox</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="NiftiViewer-428"><a href="#NiftiViewer-428"><span class="linenos"> 428</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-429"><a href="#NiftiViewer-429"><span class="linenos"> 429</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="NiftiViewer-430"><a href="#NiftiViewer-430"><span class="linenos"> 430</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="NiftiViewer-431"><a href="#NiftiViewer-431"><span class="linenos"> 431</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="NiftiViewer-432"><a href="#NiftiViewer-432"><span class="linenos"> 432</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="NiftiViewer-433"><a href="#NiftiViewer-433"><span class="linenos"> 433</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-434"><a href="#NiftiViewer-434"><span class="linenos"> 434</span></a>            <span class="n">controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">spinbox</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-435"><a href="#NiftiViewer-435"><span class="linenos"> 435</span></a>
</span><span id="NiftiViewer-436"><a href="#NiftiViewer-436"><span class="linenos"> 436</span></a>            <span class="c1"># Coordinate label display</span>
</span><span id="NiftiViewer-437"><a href="#NiftiViewer-437"><span class="linenos"> 437</span></a>            <span class="n">coord_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;(-, -)&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-438"><a href="#NiftiViewer-438"><span class="linenos"> 438</span></a>            <span class="n">coord_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: #4CAF50; font-weight: bold; font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-439"><a href="#NiftiViewer-439"><span class="linenos"> 439</span></a>            <span class="n">coord_label</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span>
</span><span id="NiftiViewer-440"><a href="#NiftiViewer-440"><span class="linenos"> 440</span></a>            <span class="n">coord_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="NiftiViewer-441"><a href="#NiftiViewer-441"><span class="linenos"> 441</span></a>            <span class="n">coord_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-442"><a href="#NiftiViewer-442"><span class="linenos"> 442</span></a>            <span class="n">controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">coord_label</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-443"><a href="#NiftiViewer-443"><span class="linenos"> 443</span></a>
</span><span id="NiftiViewer-444"><a href="#NiftiViewer-444"><span class="linenos"> 444</span></a>            <span class="n">controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-445"><a href="#NiftiViewer-445"><span class="linenos"> 445</span></a>            <span class="n">slice_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-446"><a href="#NiftiViewer-446"><span class="linenos"> 446</span></a>
</span><span id="NiftiViewer-447"><a href="#NiftiViewer-447"><span class="linenos"> 447</span></a>            <span class="c1"># Store references</span>
</span><span id="NiftiViewer-448"><a href="#NiftiViewer-448"><span class="linenos"> 448</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slider</span><span class="p">)</span>
</span><span id="NiftiViewer-449"><a href="#NiftiViewer-449"><span class="linenos"> 449</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spinbox</span><span class="p">)</span>
</span><span id="NiftiViewer-450"><a href="#NiftiViewer-450"><span class="linenos"> 450</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coord_displays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord_label</span><span class="p">)</span>
</span><span id="NiftiViewer-451"><a href="#NiftiViewer-451"><span class="linenos"> 451</span></a>
</span><span id="NiftiViewer-452"><a href="#NiftiViewer-452"><span class="linenos"> 452</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">slice_group</span><span class="p">)</span>
</span><span id="NiftiViewer-453"><a href="#NiftiViewer-453"><span class="linenos"> 453</span></a>
</span><span id="NiftiViewer-454"><a href="#NiftiViewer-454"><span class="linenos"> 454</span></a>        <span class="c1"># ===================</span>
</span><span id="NiftiViewer-455"><a href="#NiftiViewer-455"><span class="linenos"> 455</span></a>        <span class="c1">#  4D Time Controls</span>
</span><span id="NiftiViewer-456"><a href="#NiftiViewer-456"><span class="linenos"> 456</span></a>        <span class="c1"># ===================</span>
</span><span id="NiftiViewer-457"><a href="#NiftiViewer-457"><span class="linenos"> 457</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer-458"><a href="#NiftiViewer-458"><span class="linenos"> 458</span></a>        <span class="n">time_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_group</span><span class="p">)</span>
</span><span id="NiftiViewer-459"><a href="#NiftiViewer-459"><span class="linenos"> 459</span></a>        <span class="n">time_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer-460"><a href="#NiftiViewer-460"><span class="linenos"> 460</span></a>
</span><span id="NiftiViewer-461"><a href="#NiftiViewer-461"><span class="linenos"> 461</span></a>        <span class="c1"># Enable time navigation</span>
</span><span id="NiftiViewer-462"><a href="#NiftiViewer-462"><span class="linenos"> 462</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Enable 4D Time Navigation&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-463"><a href="#NiftiViewer-463"><span class="linenos"> 463</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-464"><a href="#NiftiViewer-464"><span class="linenos"> 464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-465"><a href="#NiftiViewer-465"><span class="linenos"> 465</span></a>        <span class="n">time_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="p">)</span>
</span><span id="NiftiViewer-466"><a href="#NiftiViewer-466"><span class="linenos"> 466</span></a>
</span><span id="NiftiViewer-467"><a href="#NiftiViewer-467"><span class="linenos"> 467</span></a>        <span class="c1"># Slider + spinbox controls for time navigation</span>
</span><span id="NiftiViewer-468"><a href="#NiftiViewer-468"><span class="linenos"> 468</span></a>        <span class="n">time_controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer-469"><a href="#NiftiViewer-469"><span class="linenos"> 469</span></a>        <span class="n">time_controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">time_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-470"><a href="#NiftiViewer-470"><span class="linenos"> 470</span></a>        <span class="n">time_controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-471"><a href="#NiftiViewer-471"><span class="linenos"> 471</span></a>        <span class="n">time_controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer-472"><a href="#NiftiViewer-472"><span class="linenos"> 472</span></a>
</span><span id="NiftiViewer-473"><a href="#NiftiViewer-473"><span class="linenos"> 473</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="NiftiViewer-474"><a href="#NiftiViewer-474"><span class="linenos"> 474</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-475"><a href="#NiftiViewer-475"><span class="linenos"> 475</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-476"><a href="#NiftiViewer-476"><span class="linenos"> 476</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-477"><a href="#NiftiViewer-477"><span class="linenos"> 477</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-478"><a href="#NiftiViewer-478"><span class="linenos"> 478</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-479"><a href="#NiftiViewer-479"><span class="linenos"> 479</span></a>        <span class="n">time_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer-480"><a href="#NiftiViewer-480"><span class="linenos"> 480</span></a>
</span><span id="NiftiViewer-481"><a href="#NiftiViewer-481"><span class="linenos"> 481</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="NiftiViewer-482"><a href="#NiftiViewer-482"><span class="linenos"> 482</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-483"><a href="#NiftiViewer-483"><span class="linenos"> 483</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-484"><a href="#NiftiViewer-484"><span class="linenos"> 484</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-485"><a href="#NiftiViewer-485"><span class="linenos"> 485</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-486"><a href="#NiftiViewer-486"><span class="linenos"> 486</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
</span><span id="NiftiViewer-487"><a href="#NiftiViewer-487"><span class="linenos"> 487</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="NiftiViewer-488"><a href="#NiftiViewer-488"><span class="linenos"> 488</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-489"><a href="#NiftiViewer-489"><span class="linenos"> 489</span></a>        <span class="n">time_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-490"><a href="#NiftiViewer-490"><span class="linenos"> 490</span></a>
</span><span id="NiftiViewer-491"><a href="#NiftiViewer-491"><span class="linenos"> 491</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Time Point:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-492"><a href="#NiftiViewer-492"><span class="linenos"> 492</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-493"><a href="#NiftiViewer-493"><span class="linenos"> 493</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="NiftiViewer-494"><a href="#NiftiViewer-494"><span class="linenos"> 494</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 11px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-495"><a href="#NiftiViewer-495"><span class="linenos"> 495</span></a>        <span class="n">time_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="p">)</span>
</span><span id="NiftiViewer-496"><a href="#NiftiViewer-496"><span class="linenos"> 496</span></a>        <span class="n">time_controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-497"><a href="#NiftiViewer-497"><span class="linenos"> 497</span></a>        <span class="n">time_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">time_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-498"><a href="#NiftiViewer-498"><span class="linenos"> 498</span></a>
</span><span id="NiftiViewer-499"><a href="#NiftiViewer-499"><span class="linenos"> 499</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-500"><a href="#NiftiViewer-500"><span class="linenos"> 500</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_group</span><span class="p">)</span>
</span><span id="NiftiViewer-501"><a href="#NiftiViewer-501"><span class="linenos"> 501</span></a>
</span><span id="NiftiViewer-502"><a href="#NiftiViewer-502"><span class="linenos"> 502</span></a>        <span class="c1"># ======================</span>
</span><span id="NiftiViewer-503"><a href="#NiftiViewer-503"><span class="linenos"> 503</span></a>        <span class="c1">#  Display Options</span>
</span><span id="NiftiViewer-504"><a href="#NiftiViewer-504"><span class="linenos"> 504</span></a>        <span class="c1"># ======================</span>
</span><span id="NiftiViewer-505"><a href="#NiftiViewer-505"><span class="linenos"> 505</span></a>        <span class="n">display_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer-506"><a href="#NiftiViewer-506"><span class="linenos"> 506</span></a>        <span class="n">display_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">display_group</span><span class="p">)</span>
</span><span id="NiftiViewer-507"><a href="#NiftiViewer-507"><span class="linenos"> 507</span></a>        <span class="n">display_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer-508"><a href="#NiftiViewer-508"><span class="linenos"> 508</span></a>
</span><span id="NiftiViewer-509"><a href="#NiftiViewer-509"><span class="linenos"> 509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Display Options:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-510"><a href="#NiftiViewer-510"><span class="linenos"> 510</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-511"><a href="#NiftiViewer-511"><span class="linenos"> 511</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="NiftiViewer-512"><a href="#NiftiViewer-512"><span class="linenos"> 512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; font-size: 11px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-513"><a href="#NiftiViewer-513"><span class="linenos"> 513</span></a>        <span class="n">display_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span><span class="p">)</span>
</span><span id="NiftiViewer-514"><a href="#NiftiViewer-514"><span class="linenos"> 514</span></a>
</span><span id="NiftiViewer-515"><a href="#NiftiViewer-515"><span class="linenos"> 515</span></a>        <span class="c1"># Colormap selection dropdown</span>
</span><span id="NiftiViewer-516"><a href="#NiftiViewer-516"><span class="linenos"> 516</span></a>        <span class="n">colormap_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer-517"><a href="#NiftiViewer-517"><span class="linenos"> 517</span></a>        <span class="n">colormap_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">colormap_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-518"><a href="#NiftiViewer-518"><span class="linenos"> 518</span></a>        <span class="n">colormap_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-519"><a href="#NiftiViewer-519"><span class="linenos"> 519</span></a>        <span class="n">colormap_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer-520"><a href="#NiftiViewer-520"><span class="linenos"> 520</span></a>
</span><span id="NiftiViewer-521"><a href="#NiftiViewer-521"><span class="linenos"> 521</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Colormap:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-522"><a href="#NiftiViewer-522"><span class="linenos"> 522</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-523"><a href="#NiftiViewer-523"><span class="linenos"> 523</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px; font-weight: bold;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-524"><a href="#NiftiViewer-524"><span class="linenos"> 524</span></a>        <span class="n">colormap_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colormap_label</span><span class="p">)</span>
</span><span id="NiftiViewer-525"><a href="#NiftiViewer-525"><span class="linenos"> 525</span></a>
</span><span id="NiftiViewer-526"><a href="#NiftiViewer-526"><span class="linenos"> 526</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">()</span>
</span><span id="NiftiViewer-527"><a href="#NiftiViewer-527"><span class="linenos"> 527</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span>
</span><span id="NiftiViewer-528"><a href="#NiftiViewer-528"><span class="linenos"> 528</span></a>            <span class="p">[</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="s1">&#39;plasma&#39;</span><span class="p">,</span>
</span><span id="NiftiViewer-529"><a href="#NiftiViewer-529"><span class="linenos"> 529</span></a>             <span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="s1">&#39;hot&#39;</span><span class="p">,</span>
</span><span id="NiftiViewer-530"><a href="#NiftiViewer-530"><span class="linenos"> 530</span></a>             <span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="s1">&#39;bone&#39;</span><span class="p">])</span>
</span><span id="NiftiViewer-531"><a href="#NiftiViewer-531"><span class="linenos"> 531</span></a>
</span><span id="NiftiViewer-532"><a href="#NiftiViewer-532"><span class="linenos"> 532</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-533"><a href="#NiftiViewer-533"><span class="linenos"> 533</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
</span><span id="NiftiViewer-534"><a href="#NiftiViewer-534"><span class="linenos"> 534</span></a>        <span class="n">colormap_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="p">)</span>
</span><span id="NiftiViewer-535"><a href="#NiftiViewer-535"><span class="linenos"> 535</span></a>        <span class="n">colormap_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-536"><a href="#NiftiViewer-536"><span class="linenos"> 536</span></a>        <span class="n">display_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">colormap_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-537"><a href="#NiftiViewer-537"><span class="linenos"> 537</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">display_group</span><span class="p">)</span>
</span><span id="NiftiViewer-538"><a href="#NiftiViewer-538"><span class="linenos"> 538</span></a>
</span><span id="NiftiViewer-539"><a href="#NiftiViewer-539"><span class="linenos"> 539</span></a>        <span class="c1"># ==========================</span>
</span><span id="NiftiViewer-540"><a href="#NiftiViewer-540"><span class="linenos"> 540</span></a>        <span class="c1"># Automatic ROI Controls</span>
</span><span id="NiftiViewer-541"><a href="#NiftiViewer-541"><span class="linenos"> 541</span></a>        <span class="c1"># ==========================</span>
</span><span id="NiftiViewer-542"><a href="#NiftiViewer-542"><span class="linenos"> 542</span></a>        <span class="c1"># Automatic ROI</span>
</span><span id="NiftiViewer-543"><a href="#NiftiViewer-543"><span class="linenos"> 543</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer-544"><a href="#NiftiViewer-544"><span class="linenos"> 544</span></a>        <span class="n">automaticROI_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_group</span><span class="p">)</span>
</span><span id="NiftiViewer-545"><a href="#NiftiViewer-545"><span class="linenos"> 545</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer-546"><a href="#NiftiViewer-546"><span class="linenos"> 546</span></a>
</span><span id="NiftiViewer-547"><a href="#NiftiViewer-547"><span class="linenos"> 547</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automatic_ROI_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic ROI:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-548"><a href="#NiftiViewer-548"><span class="linenos"> 548</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automatic_ROI_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-549"><a href="#NiftiViewer-549"><span class="linenos"> 549</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automatic_ROI_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px; font-weight: bold;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-550"><a href="#NiftiViewer-550"><span class="linenos"> 550</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automatic_ROI_label</span><span class="p">)</span>
</span><span id="NiftiViewer-551"><a href="#NiftiViewer-551"><span class="linenos"> 551</span></a>
</span><span id="NiftiViewer-552"><a href="#NiftiViewer-552"><span class="linenos"> 552</span></a>        <span class="n">automaticROIbtns_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer-553"><a href="#NiftiViewer-553"><span class="linenos"> 553</span></a>        <span class="n">automaticROIbtns_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">automaticROIbtns_group</span><span class="p">)</span>  <span class="c1"># Cambiato a verticale</span>
</span><span id="NiftiViewer-554"><a href="#NiftiViewer-554"><span class="linenos"> 554</span></a>        <span class="n">automaticROIbtns_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-555"><a href="#NiftiViewer-555"><span class="linenos"> 555</span></a>        <span class="n">automaticROIbtns_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer-556"><a href="#NiftiViewer-556"><span class="linenos"> 556</span></a>
</span><span id="NiftiViewer-557"><a href="#NiftiViewer-557"><span class="linenos"> 557</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic ROI&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-558"><a href="#NiftiViewer-558"><span class="linenos"> 558</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-559"><a href="#NiftiViewer-559"><span class="linenos"> 559</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-560"><a href="#NiftiViewer-560"><span class="linenos"> 560</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="NiftiViewer-561"><a href="#NiftiViewer-561"><span class="linenos"> 561</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic ROI Drawing&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-562"><a href="#NiftiViewer-562"><span class="linenos"> 562</span></a>        <span class="n">automaticROIbtns_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="p">)</span>
</span><span id="NiftiViewer-563"><a href="#NiftiViewer-563"><span class="linenos"> 563</span></a>
</span><span id="NiftiViewer-564"><a href="#NiftiViewer-564"><span class="linenos"> 564</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Fix ROI and add new Origin&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-565"><a href="#NiftiViewer-565"><span class="linenos"> 565</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-566"><a href="#NiftiViewer-566"><span class="linenos"> 566</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-567"><a href="#NiftiViewer-567"><span class="linenos"> 567</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="NiftiViewer-568"><a href="#NiftiViewer-568"><span class="linenos"> 568</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Increment the current incremental ROI with the current ROI drawing&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-569"><a href="#NiftiViewer-569"><span class="linenos"> 569</span></a>        <span class="n">automaticROIbtns_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="p">)</span>
</span><span id="NiftiViewer-570"><a href="#NiftiViewer-570"><span class="linenos"> 570</span></a>
</span><span id="NiftiViewer-571"><a href="#NiftiViewer-571"><span class="linenos"> 571</span></a>        <span class="n">automaticROIbtns_group</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-572"><a href="#NiftiViewer-572"><span class="linenos"> 572</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">automaticROIbtns_group</span><span class="p">)</span>
</span><span id="NiftiViewer-573"><a href="#NiftiViewer-573"><span class="linenos"> 573</span></a>
</span><span id="NiftiViewer-574"><a href="#NiftiViewer-574"><span class="linenos"> 574</span></a>        <span class="c1"># Incremental ROI checkbox</span>
</span><span id="NiftiViewer-575"><a href="#NiftiViewer-575"><span class="linenos"> 575</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span>
</span><span id="NiftiViewer-576"><a href="#NiftiViewer-576"><span class="linenos"> 576</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Show incremental ROI&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-577"><a href="#NiftiViewer-577"><span class="linenos"> 577</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-578"><a href="#NiftiViewer-578"><span class="linenos"> 578</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-579"><a href="#NiftiViewer-579"><span class="linenos"> 579</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-580"><a href="#NiftiViewer-580"><span class="linenos"> 580</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="p">)</span>
</span><span id="NiftiViewer-581"><a href="#NiftiViewer-581"><span class="linenos"> 581</span></a>
</span><span id="NiftiViewer-582"><a href="#NiftiViewer-582"><span class="linenos"> 582</span></a>        <span class="c1"># Overlay enable/disable checkbox</span>
</span><span id="NiftiViewer-583"><a href="#NiftiViewer-583"><span class="linenos"> 583</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Show automatic ROI&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-584"><a href="#NiftiViewer-584"><span class="linenos"> 584</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-585"><a href="#NiftiViewer-585"><span class="linenos"> 585</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-586"><a href="#NiftiViewer-586"><span class="linenos"> 586</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-587"><a href="#NiftiViewer-587"><span class="linenos"> 587</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="p">)</span>
</span><span id="NiftiViewer-588"><a href="#NiftiViewer-588"><span class="linenos"> 588</span></a>
</span><span id="NiftiViewer-589"><a href="#NiftiViewer-589"><span class="linenos"> 589</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer-590"><a href="#NiftiViewer-590"><span class="linenos"> 590</span></a>        <span class="n">automaticROI_sliders_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="p">)</span>
</span><span id="NiftiViewer-591"><a href="#NiftiViewer-591"><span class="linenos"> 591</span></a>        <span class="n">automaticROI_sliders_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-592"><a href="#NiftiViewer-592"><span class="linenos"> 592</span></a>
</span><span id="NiftiViewer-593"><a href="#NiftiViewer-593"><span class="linenos"> 593</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Radius:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-594"><a href="#NiftiViewer-594"><span class="linenos"> 594</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-595"><a href="#NiftiViewer-595"><span class="linenos"> 595</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-596"><a href="#NiftiViewer-596"><span class="linenos"> 596</span></a>        <span class="n">automaticROI_sliders_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_label</span><span class="p">)</span>
</span><span id="NiftiViewer-597"><a href="#NiftiViewer-597"><span class="linenos"> 597</span></a>
</span><span id="NiftiViewer-598"><a href="#NiftiViewer-598"><span class="linenos"> 598</span></a>        <span class="c1"># Radius slider and spinbox container</span>
</span><span id="NiftiViewer-599"><a href="#NiftiViewer-599"><span class="linenos"> 599</span></a>        <span class="n">radius_controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer-600"><a href="#NiftiViewer-600"><span class="linenos"> 600</span></a>        <span class="n">radius_controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">radius_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-601"><a href="#NiftiViewer-601"><span class="linenos"> 601</span></a>        <span class="n">radius_controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-602"><a href="#NiftiViewer-602"><span class="linenos"> 602</span></a>        <span class="n">radius_controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer-603"><a href="#NiftiViewer-603"><span class="linenos"> 603</span></a>
</span><span id="NiftiViewer-604"><a href="#NiftiViewer-604"><span class="linenos"> 604</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="NiftiViewer-605"><a href="#NiftiViewer-605"><span class="linenos"> 605</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-606"><a href="#NiftiViewer-606"><span class="linenos"> 606</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span>  <span class="c1"># Valore sufficientemente alto per gestire tutti i casi</span>
</span><span id="NiftiViewer-607"><a href="#NiftiViewer-607"><span class="linenos"> 607</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</span><span id="NiftiViewer-608"><a href="#NiftiViewer-608"><span class="linenos"> 608</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-609"><a href="#NiftiViewer-609"><span class="linenos"> 609</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-610"><a href="#NiftiViewer-610"><span class="linenos"> 610</span></a>        <span class="n">radius_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer-611"><a href="#NiftiViewer-611"><span class="linenos"> 611</span></a>
</span><span id="NiftiViewer-612"><a href="#NiftiViewer-612"><span class="linenos"> 612</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="NiftiViewer-613"><a href="#NiftiViewer-613"><span class="linenos"> 613</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-614"><a href="#NiftiViewer-614"><span class="linenos"> 614</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span>  <span class="c1"># Valore sufficientemente alto per gestire tutti i casi</span>
</span><span id="NiftiViewer-615"><a href="#NiftiViewer-615"><span class="linenos"> 615</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</span><span id="NiftiViewer-616"><a href="#NiftiViewer-616"><span class="linenos"> 616</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="NiftiViewer-617"><a href="#NiftiViewer-617"><span class="linenos"> 617</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="NiftiViewer-618"><a href="#NiftiViewer-618"><span class="linenos"> 618</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-619"><a href="#NiftiViewer-619"><span class="linenos"> 619</span></a>        <span class="n">radius_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-620"><a href="#NiftiViewer-620"><span class="linenos"> 620</span></a>
</span><span id="NiftiViewer-621"><a href="#NiftiViewer-621"><span class="linenos"> 621</span></a>        <span class="n">radius_controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-622"><a href="#NiftiViewer-622"><span class="linenos"> 622</span></a>        <span class="n">automaticROI_sliders_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">radius_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-623"><a href="#NiftiViewer-623"><span class="linenos"> 623</span></a>
</span><span id="NiftiViewer-624"><a href="#NiftiViewer-624"><span class="linenos"> 624</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Difference:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-625"><a href="#NiftiViewer-625"><span class="linenos"> 625</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-626"><a href="#NiftiViewer-626"><span class="linenos"> 626</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-627"><a href="#NiftiViewer-627"><span class="linenos"> 627</span></a>        <span class="n">automaticROI_sliders_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_label</span><span class="p">)</span>
</span><span id="NiftiViewer-628"><a href="#NiftiViewer-628"><span class="linenos"> 628</span></a>
</span><span id="NiftiViewer-629"><a href="#NiftiViewer-629"><span class="linenos"> 629</span></a>        <span class="c1"># Difference slider and spinbox container</span>
</span><span id="NiftiViewer-630"><a href="#NiftiViewer-630"><span class="linenos"> 630</span></a>        <span class="n">diff_controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer-631"><a href="#NiftiViewer-631"><span class="linenos"> 631</span></a>        <span class="n">diff_controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">diff_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-632"><a href="#NiftiViewer-632"><span class="linenos"> 632</span></a>        <span class="n">diff_controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-633"><a href="#NiftiViewer-633"><span class="linenos"> 633</span></a>        <span class="n">diff_controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer-634"><a href="#NiftiViewer-634"><span class="linenos"> 634</span></a>
</span><span id="NiftiViewer-635"><a href="#NiftiViewer-635"><span class="linenos"> 635</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="NiftiViewer-636"><a href="#NiftiViewer-636"><span class="linenos"> 636</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-637"><a href="#NiftiViewer-637"><span class="linenos"> 637</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">99999</span><span class="p">)</span>  <span class="c1"># Valore molto alto per gestire qualsiasi range di intensit</span>
</span><span id="NiftiViewer-638"><a href="#NiftiViewer-638"><span class="linenos"> 638</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span><span id="NiftiViewer-639"><a href="#NiftiViewer-639"><span class="linenos"> 639</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-640"><a href="#NiftiViewer-640"><span class="linenos"> 640</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-641"><a href="#NiftiViewer-641"><span class="linenos"> 641</span></a>        <span class="n">diff_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer-642"><a href="#NiftiViewer-642"><span class="linenos"> 642</span></a>
</span><span id="NiftiViewer-643"><a href="#NiftiViewer-643"><span class="linenos"> 643</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="NiftiViewer-644"><a href="#NiftiViewer-644"><span class="linenos"> 644</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-645"><a href="#NiftiViewer-645"><span class="linenos"> 645</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">99999</span><span class="p">)</span>  <span class="c1"># Valore molto alto per gestire qualsiasi range di intensit</span>
</span><span id="NiftiViewer-646"><a href="#NiftiViewer-646"><span class="linenos"> 646</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span><span id="NiftiViewer-647"><a href="#NiftiViewer-647"><span class="linenos"> 647</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="NiftiViewer-648"><a href="#NiftiViewer-648"><span class="linenos"> 648</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="NiftiViewer-649"><a href="#NiftiViewer-649"><span class="linenos"> 649</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-650"><a href="#NiftiViewer-650"><span class="linenos"> 650</span></a>        <span class="n">diff_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-651"><a href="#NiftiViewer-651"><span class="linenos"> 651</span></a>
</span><span id="NiftiViewer-652"><a href="#NiftiViewer-652"><span class="linenos"> 652</span></a>        <span class="n">diff_controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-653"><a href="#NiftiViewer-653"><span class="linenos"> 653</span></a>        <span class="n">automaticROI_sliders_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">diff_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-654"><a href="#NiftiViewer-654"><span class="linenos"> 654</span></a>
</span><span id="NiftiViewer-655"><a href="#NiftiViewer-655"><span class="linenos"> 655</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-656"><a href="#NiftiViewer-656"><span class="linenos"> 656</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">)</span>
</span><span id="NiftiViewer-657"><a href="#NiftiViewer-657"><span class="linenos"> 657</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="p">)</span>
</span><span id="NiftiViewer-658"><a href="#NiftiViewer-658"><span class="linenos"> 658</span></a>
</span><span id="NiftiViewer-659"><a href="#NiftiViewer-659"><span class="linenos"> 659</span></a>        <span class="n">automaticROI_bottom_btns_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer-660"><a href="#NiftiViewer-660"><span class="linenos"> 660</span></a>        <span class="n">automaticROIb_bottom_btns_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">automaticROI_bottom_btns_group</span><span class="p">)</span>  <span class="c1"># Cambiato a verticale</span>
</span><span id="NiftiViewer-661"><a href="#NiftiViewer-661"><span class="linenos"> 661</span></a>        <span class="n">automaticROIb_bottom_btns_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-662"><a href="#NiftiViewer-662"><span class="linenos"> 662</span></a>        <span class="n">automaticROIb_bottom_btns_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer-663"><a href="#NiftiViewer-663"><span class="linenos"> 663</span></a>
</span><span id="NiftiViewer-664"><a href="#NiftiViewer-664"><span class="linenos"> 664</span></a>
</span><span id="NiftiViewer-665"><a href="#NiftiViewer-665"><span class="linenos"> 665</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Save ROI&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-666"><a href="#NiftiViewer-666"><span class="linenos"> 666</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-667"><a href="#NiftiViewer-667"><span class="linenos"> 667</span></a><span class="s2">                    QPushButton {</span>
</span><span id="NiftiViewer-668"><a href="#NiftiViewer-668"><span class="linenos"> 668</span></a><span class="s2">                    font-weight: bold;</span>
</span><span id="NiftiViewer-669"><a href="#NiftiViewer-669"><span class="linenos"> 669</span></a><span class="s2">                    color:#27ae60 }</span>
</span><span id="NiftiViewer-670"><a href="#NiftiViewer-670"><span class="linenos"> 670</span></a><span class="s2">                    QPushButton:disabled {</span>
</span><span id="NiftiViewer-671"><a href="#NiftiViewer-671"><span class="linenos"> 671</span></a><span class="s2">                    color:none;</span>
</span><span id="NiftiViewer-672"><a href="#NiftiViewer-672"><span class="linenos"> 672</span></a><span class="s2">                    font-weight: normal</span>
</span><span id="NiftiViewer-673"><a href="#NiftiViewer-673"><span class="linenos"> 673</span></a><span class="s2">                    }&quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-674"><a href="#NiftiViewer-674"><span class="linenos"> 674</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-675"><a href="#NiftiViewer-675"><span class="linenos"> 675</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-676"><a href="#NiftiViewer-676"><span class="linenos"> 676</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="NiftiViewer-677"><a href="#NiftiViewer-677"><span class="linenos"> 677</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Save ROI Drawing&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-678"><a href="#NiftiViewer-678"><span class="linenos"> 678</span></a>        <span class="n">automaticROIb_bottom_btns_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="p">)</span>
</span><span id="NiftiViewer-679"><a href="#NiftiViewer-679"><span class="linenos"> 679</span></a>
</span><span id="NiftiViewer-680"><a href="#NiftiViewer-680"><span class="linenos"> 680</span></a>
</span><span id="NiftiViewer-681"><a href="#NiftiViewer-681"><span class="linenos"> 681</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Cancel ROI&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-682"><a href="#NiftiViewer-682"><span class="linenos"> 682</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-683"><a href="#NiftiViewer-683"><span class="linenos"> 683</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-684"><a href="#NiftiViewer-684"><span class="linenos"> 684</span></a><span class="s2">                            QPushButton {</span>
</span><span id="NiftiViewer-685"><a href="#NiftiViewer-685"><span class="linenos"> 685</span></a><span class="s2">                            font-weight: bold;</span>
</span><span id="NiftiViewer-686"><a href="#NiftiViewer-686"><span class="linenos"> 686</span></a><span class="s2">                            color:#c0392b }</span>
</span><span id="NiftiViewer-687"><a href="#NiftiViewer-687"><span class="linenos"> 687</span></a><span class="s2">                            QPushButton:disabled {</span>
</span><span id="NiftiViewer-688"><a href="#NiftiViewer-688"><span class="linenos"> 688</span></a><span class="s2">                            color:none;</span>
</span><span id="NiftiViewer-689"><a href="#NiftiViewer-689"><span class="linenos"> 689</span></a><span class="s2">                            font-weight: normal</span>
</span><span id="NiftiViewer-690"><a href="#NiftiViewer-690"><span class="linenos"> 690</span></a><span class="s2">                            }&quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-691"><a href="#NiftiViewer-691"><span class="linenos"> 691</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-692"><a href="#NiftiViewer-692"><span class="linenos"> 692</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="NiftiViewer-693"><a href="#NiftiViewer-693"><span class="linenos"> 693</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Cancel ROI Drawing&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-694"><a href="#NiftiViewer-694"><span class="linenos"> 694</span></a>        <span class="n">automaticROIb_bottom_btns_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="p">)</span>
</span><span id="NiftiViewer-695"><a href="#NiftiViewer-695"><span class="linenos"> 695</span></a>
</span><span id="NiftiViewer-696"><a href="#NiftiViewer-696"><span class="linenos"> 696</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">automaticROI_bottom_btns_group</span><span class="p">)</span>
</span><span id="NiftiViewer-697"><a href="#NiftiViewer-697"><span class="linenos"> 697</span></a>
</span><span id="NiftiViewer-698"><a href="#NiftiViewer-698"><span class="linenos"> 698</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_group</span><span class="p">)</span>
</span><span id="NiftiViewer-699"><a href="#NiftiViewer-699"><span class="linenos"> 699</span></a>
</span><span id="NiftiViewer-700"><a href="#NiftiViewer-700"><span class="linenos"> 700</span></a>        <span class="c1"># Overlay controls</span>
</span><span id="NiftiViewer-701"><a href="#NiftiViewer-701"><span class="linenos"> 701</span></a>        <span class="n">overlay_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer-702"><a href="#NiftiViewer-702"><span class="linenos"> 702</span></a>        <span class="n">overlay_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">overlay_group</span><span class="p">)</span>
</span><span id="NiftiViewer-703"><a href="#NiftiViewer-703"><span class="linenos"> 703</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer-704"><a href="#NiftiViewer-704"><span class="linenos"> 704</span></a>
</span><span id="NiftiViewer-705"><a href="#NiftiViewer-705"><span class="linenos"> 705</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay Controls:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-706"><a href="#NiftiViewer-706"><span class="linenos"> 706</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-707"><a href="#NiftiViewer-707"><span class="linenos"> 707</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="NiftiViewer-708"><a href="#NiftiViewer-708"><span class="linenos"> 708</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; font-size: 11px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-709"><a href="#NiftiViewer-709"><span class="linenos"> 709</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span><span class="p">)</span>
</span><span id="NiftiViewer-710"><a href="#NiftiViewer-710"><span class="linenos"> 710</span></a>
</span><span id="NiftiViewer-711"><a href="#NiftiViewer-711"><span class="linenos"> 711</span></a>        <span class="c1"># Overlay file button</span>
</span><span id="NiftiViewer-712"><a href="#NiftiViewer-712"><span class="linenos"> 712</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Load Overlay&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-713"><a href="#NiftiViewer-713"><span class="linenos"> 713</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="NiftiViewer-714"><a href="#NiftiViewer-714"><span class="linenos"> 714</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
</span><span id="NiftiViewer-715"><a href="#NiftiViewer-715"><span class="linenos"> 715</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Enable only when base image is loaded</span>
</span><span id="NiftiViewer-716"><a href="#NiftiViewer-716"><span class="linenos"> 716</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-717"><a href="#NiftiViewer-717"><span class="linenos"> 717</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Load NIfTI Overlay&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-718"><a href="#NiftiViewer-718"><span class="linenos"> 718</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="p">)</span>
</span><span id="NiftiViewer-719"><a href="#NiftiViewer-719"><span class="linenos"> 719</span></a>
</span><span id="NiftiViewer-720"><a href="#NiftiViewer-720"><span class="linenos"> 720</span></a>        <span class="c1"># Overlay enable/disable checkbox</span>
</span><span id="NiftiViewer-721"><a href="#NiftiViewer-721"><span class="linenos"> 721</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Show Overlay&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-722"><a href="#NiftiViewer-722"><span class="linenos"> 722</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-723"><a href="#NiftiViewer-723"><span class="linenos"> 723</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-724"><a href="#NiftiViewer-724"><span class="linenos"> 724</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="p">)</span>
</span><span id="NiftiViewer-725"><a href="#NiftiViewer-725"><span class="linenos"> 725</span></a>
</span><span id="NiftiViewer-726"><a href="#NiftiViewer-726"><span class="linenos"> 726</span></a>        <span class="c1"># Overlay alpha slider</span>
</span><span id="NiftiViewer-727"><a href="#NiftiViewer-727"><span class="linenos"> 727</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_overlay_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay Transparency:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-728"><a href="#NiftiViewer-728"><span class="linenos"> 728</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_overlay_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-729"><a href="#NiftiViewer-729"><span class="linenos"> 729</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_overlay_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-730"><a href="#NiftiViewer-730"><span class="linenos"> 730</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_overlay_label</span><span class="p">)</span>
</span><span id="NiftiViewer-731"><a href="#NiftiViewer-731"><span class="linenos"> 731</span></a>
</span><span id="NiftiViewer-732"><a href="#NiftiViewer-732"><span class="linenos"> 732</span></a>        <span class="c1"># Alpha slider and spinbox container</span>
</span><span id="NiftiViewer-733"><a href="#NiftiViewer-733"><span class="linenos"> 733</span></a>        <span class="n">alpha_controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer-734"><a href="#NiftiViewer-734"><span class="linenos"> 734</span></a>        <span class="n">alpha_controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">alpha_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-735"><a href="#NiftiViewer-735"><span class="linenos"> 735</span></a>        <span class="n">alpha_controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-736"><a href="#NiftiViewer-736"><span class="linenos"> 736</span></a>        <span class="n">alpha_controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer-737"><a href="#NiftiViewer-737"><span class="linenos"> 737</span></a>
</span><span id="NiftiViewer-738"><a href="#NiftiViewer-738"><span class="linenos"> 738</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="NiftiViewer-739"><a href="#NiftiViewer-739"><span class="linenos"> 739</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="NiftiViewer-740"><a href="#NiftiViewer-740"><span class="linenos"> 740</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="NiftiViewer-741"><a href="#NiftiViewer-741"><span class="linenos"> 741</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">70</span><span class="p">)</span>
</span><span id="NiftiViewer-742"><a href="#NiftiViewer-742"><span class="linenos"> 742</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-743"><a href="#NiftiViewer-743"><span class="linenos"> 743</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-744"><a href="#NiftiViewer-744"><span class="linenos"> 744</span></a>        <span class="n">alpha_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer-745"><a href="#NiftiViewer-745"><span class="linenos"> 745</span></a>
</span><span id="NiftiViewer-746"><a href="#NiftiViewer-746"><span class="linenos"> 746</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="NiftiViewer-747"><a href="#NiftiViewer-747"><span class="linenos"> 747</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="NiftiViewer-748"><a href="#NiftiViewer-748"><span class="linenos"> 748</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="NiftiViewer-749"><a href="#NiftiViewer-749"><span class="linenos"> 749</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">70</span><span class="p">)</span>
</span><span id="NiftiViewer-750"><a href="#NiftiViewer-750"><span class="linenos"> 750</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-751"><a href="#NiftiViewer-751"><span class="linenos"> 751</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="NiftiViewer-752"><a href="#NiftiViewer-752"><span class="linenos"> 752</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="NiftiViewer-753"><a href="#NiftiViewer-753"><span class="linenos"> 753</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-754"><a href="#NiftiViewer-754"><span class="linenos"> 754</span></a>        <span class="n">alpha_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-755"><a href="#NiftiViewer-755"><span class="linenos"> 755</span></a>
</span><span id="NiftiViewer-756"><a href="#NiftiViewer-756"><span class="linenos"> 756</span></a>        <span class="n">alpha_controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-757"><a href="#NiftiViewer-757"><span class="linenos"> 757</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">alpha_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-758"><a href="#NiftiViewer-758"><span class="linenos"> 758</span></a>
</span><span id="NiftiViewer-759"><a href="#NiftiViewer-759"><span class="linenos"> 759</span></a>        <span class="c1"># Overlay threshold slider</span>
</span><span id="NiftiViewer-760"><a href="#NiftiViewer-760"><span class="linenos"> 760</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay Threshold:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-761"><a href="#NiftiViewer-761"><span class="linenos"> 761</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-762"><a href="#NiftiViewer-762"><span class="linenos"> 762</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-763"><a href="#NiftiViewer-763"><span class="linenos"> 763</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_label</span><span class="p">)</span>
</span><span id="NiftiViewer-764"><a href="#NiftiViewer-764"><span class="linenos"> 764</span></a>
</span><span id="NiftiViewer-765"><a href="#NiftiViewer-765"><span class="linenos"> 765</span></a>        <span class="c1"># Threshold slider and spinbox container</span>
</span><span id="NiftiViewer-766"><a href="#NiftiViewer-766"><span class="linenos"> 766</span></a>        <span class="n">threshold_controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer-767"><a href="#NiftiViewer-767"><span class="linenos"> 767</span></a>        <span class="n">threshold_controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">threshold_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-768"><a href="#NiftiViewer-768"><span class="linenos"> 768</span></a>        <span class="n">threshold_controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-769"><a href="#NiftiViewer-769"><span class="linenos"> 769</span></a>        <span class="n">threshold_controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer-770"><a href="#NiftiViewer-770"><span class="linenos"> 770</span></a>
</span><span id="NiftiViewer-771"><a href="#NiftiViewer-771"><span class="linenos"> 771</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="NiftiViewer-772"><a href="#NiftiViewer-772"><span class="linenos"> 772</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-773"><a href="#NiftiViewer-773"><span class="linenos"> 773</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="NiftiViewer-774"><a href="#NiftiViewer-774"><span class="linenos"> 774</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="NiftiViewer-775"><a href="#NiftiViewer-775"><span class="linenos"> 775</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-776"><a href="#NiftiViewer-776"><span class="linenos"> 776</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-777"><a href="#NiftiViewer-777"><span class="linenos"> 777</span></a>        <span class="n">threshold_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer-778"><a href="#NiftiViewer-778"><span class="linenos"> 778</span></a>
</span><span id="NiftiViewer-779"><a href="#NiftiViewer-779"><span class="linenos"> 779</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="NiftiViewer-780"><a href="#NiftiViewer-780"><span class="linenos"> 780</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-781"><a href="#NiftiViewer-781"><span class="linenos"> 781</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="NiftiViewer-782"><a href="#NiftiViewer-782"><span class="linenos"> 782</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="NiftiViewer-783"><a href="#NiftiViewer-783"><span class="linenos"> 783</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-784"><a href="#NiftiViewer-784"><span class="linenos"> 784</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="NiftiViewer-785"><a href="#NiftiViewer-785"><span class="linenos"> 785</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="NiftiViewer-786"><a href="#NiftiViewer-786"><span class="linenos"> 786</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-787"><a href="#NiftiViewer-787"><span class="linenos"> 787</span></a>        <span class="n">threshold_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-788"><a href="#NiftiViewer-788"><span class="linenos"> 788</span></a>
</span><span id="NiftiViewer-789"><a href="#NiftiViewer-789"><span class="linenos"> 789</span></a>        <span class="n">threshold_controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer-790"><a href="#NiftiViewer-790"><span class="linenos"> 790</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">threshold_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-791"><a href="#NiftiViewer-791"><span class="linenos"> 791</span></a>
</span><span id="NiftiViewer-792"><a href="#NiftiViewer-792"><span class="linenos"> 792</span></a>        <span class="c1"># Overlay info</span>
</span><span id="NiftiViewer-793"><a href="#NiftiViewer-793"><span class="linenos"> 793</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No overlay loaded&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-794"><a href="#NiftiViewer-794"><span class="linenos"> 794</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setWordWrap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-795"><a href="#NiftiViewer-795"><span class="linenos"> 795</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-796"><a href="#NiftiViewer-796"><span class="linenos"> 796</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">)</span>
</span><span id="NiftiViewer-797"><a href="#NiftiViewer-797"><span class="linenos"> 797</span></a>        <span class="c1"># Imposta larghezza massima per prevenire espansione</span>
</span><span id="NiftiViewer-798"><a href="#NiftiViewer-798"><span class="linenos"> 798</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="NiftiViewer-799"><a href="#NiftiViewer-799"><span class="linenos"> 799</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span id="NiftiViewer-800"><a href="#NiftiViewer-800"><span class="linenos"> 800</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="p">)</span>
</span><span id="NiftiViewer-801"><a href="#NiftiViewer-801"><span class="linenos"> 801</span></a>
</span><span id="NiftiViewer-802"><a href="#NiftiViewer-802"><span class="linenos"> 802</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">overlay_group</span><span class="p">)</span>
</span><span id="NiftiViewer-803"><a href="#NiftiViewer-803"><span class="linenos"> 803</span></a>
</span><span id="NiftiViewer-804"><a href="#NiftiViewer-804"><span class="linenos"> 804</span></a>        <span class="c1"># Add stretch to push everything to top</span>
</span><span id="NiftiViewer-805"><a href="#NiftiViewer-805"><span class="linenos"> 805</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addStretch</span><span class="p">()</span>
</span><span id="NiftiViewer-806"><a href="#NiftiViewer-806"><span class="linenos"> 806</span></a>
</span><span id="NiftiViewer-807"><a href="#NiftiViewer-807"><span class="linenos"> 807</span></a>        <span class="c1"># Set the content inside the QScrollArea</span>
</span><span id="NiftiViewer-808"><a href="#NiftiViewer-808"><span class="linenos"> 808</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="n">control_content</span><span class="p">)</span>
</span><span id="NiftiViewer-809"><a href="#NiftiViewer-809"><span class="linenos"> 809</span></a>
</span><span id="NiftiViewer-810"><a href="#NiftiViewer-810"><span class="linenos"> 810</span></a>        <span class="c1"># Set dimensions to eliminate horizontal scrolling</span>
</span><span id="NiftiViewer-811"><a href="#NiftiViewer-811"><span class="linenos"> 811</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">240</span><span class="p">)</span>
</span><span id="NiftiViewer-812"><a href="#NiftiViewer-812"><span class="linenos"> 812</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">340</span><span class="p">)</span>
</span><span id="NiftiViewer-813"><a href="#NiftiViewer-813"><span class="linenos"> 813</span></a>
</span><span id="NiftiViewer-814"><a href="#NiftiViewer-814"><span class="linenos"> 814</span></a>        <span class="c1"># Signal/slot connections to synchronize slider and spinbox</span>
</span><span id="NiftiViewer-815"><a href="#NiftiViewer-815"><span class="linenos"> 815</span></a>
</span><span id="NiftiViewer-816"><a href="#NiftiViewer-816"><span class="linenos"> 816</span></a>        <span class="c1"># Automatic ROI - Radius</span>
</span><span id="NiftiViewer-817"><a href="#NiftiViewer-817"><span class="linenos"> 817</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer-818"><a href="#NiftiViewer-818"><span class="linenos"> 818</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer-819"><a href="#NiftiViewer-819"><span class="linenos"> 819</span></a>
</span><span id="NiftiViewer-820"><a href="#NiftiViewer-820"><span class="linenos"> 820</span></a>        <span class="c1"># Automatic ROI - Difference</span>
</span><span id="NiftiViewer-821"><a href="#NiftiViewer-821"><span class="linenos"> 821</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer-822"><a href="#NiftiViewer-822"><span class="linenos"> 822</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer-823"><a href="#NiftiViewer-823"><span class="linenos"> 823</span></a>
</span><span id="NiftiViewer-824"><a href="#NiftiViewer-824"><span class="linenos"> 824</span></a>        <span class="c1"># Overlay - Alpha/Transparency</span>
</span><span id="NiftiViewer-825"><a href="#NiftiViewer-825"><span class="linenos"> 825</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer-826"><a href="#NiftiViewer-826"><span class="linenos"> 826</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer-827"><a href="#NiftiViewer-827"><span class="linenos"> 827</span></a>
</span><span id="NiftiViewer-828"><a href="#NiftiViewer-828"><span class="linenos"> 828</span></a>        <span class="c1"># Overlay - Threshold</span>
</span><span id="NiftiViewer-829"><a href="#NiftiViewer-829"><span class="linenos"> 829</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer-830"><a href="#NiftiViewer-830"><span class="linenos"> 830</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer-831"><a href="#NiftiViewer-831"><span class="linenos"> 831</span></a>
</span><span id="NiftiViewer-832"><a href="#NiftiViewer-832"><span class="linenos"> 832</span></a>        <span class="c1"># Add scroll area to parent</span>
</span><span id="NiftiViewer-833"><a href="#NiftiViewer-833"><span class="linenos"> 833</span></a>        <span class="n">parent</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">scroll_area</span><span class="p">)</span>
</span><span id="NiftiViewer-834"><a href="#NiftiViewer-834"><span class="linenos"> 834</span></a>
</span><span id="NiftiViewer-835"><a href="#NiftiViewer-835"><span class="linenos"> 835</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">format_info_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">max_line_length</span><span class="o">=</span><span class="mi">35</span><span class="p">):</span>
</span><span id="NiftiViewer-836"><a href="#NiftiViewer-836"><span class="linenos"> 836</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-837"><a href="#NiftiViewer-837"><span class="linenos"> 837</span></a><span class="sd">        Format text to prevent horizontal scrolling in the control panel.</span>
</span><span id="NiftiViewer-838"><a href="#NiftiViewer-838"><span class="linenos"> 838</span></a>
</span><span id="NiftiViewer-839"><a href="#NiftiViewer-839"><span class="linenos"> 839</span></a><span class="sd">        This helper function ensures that long lines of information (such as</span>
</span><span id="NiftiViewer-840"><a href="#NiftiViewer-840"><span class="linenos"> 840</span></a><span class="sd">        NIfTI file metadata) are wrapped neatly to fit within the UI, avoiding</span>
</span><span id="NiftiViewer-841"><a href="#NiftiViewer-841"><span class="linenos"> 841</span></a><span class="sd">        horizontal overflow. It also attempts to break lines at logical points</span>
</span><span id="NiftiViewer-842"><a href="#NiftiViewer-842"><span class="linenos"> 842</span></a><span class="sd">        (e.g., after colons or spaces) for improved readability.</span>
</span><span id="NiftiViewer-843"><a href="#NiftiViewer-843"><span class="linenos"> 843</span></a>
</span><span id="NiftiViewer-844"><a href="#NiftiViewer-844"><span class="linenos"> 844</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-845"><a href="#NiftiViewer-845"><span class="linenos"> 845</span></a><span class="sd">            text (str): The text to be formatted.</span>
</span><span id="NiftiViewer-846"><a href="#NiftiViewer-846"><span class="linenos"> 846</span></a><span class="sd">            max_line_length (int, optional): Maximum number of characters per line</span>
</span><span id="NiftiViewer-847"><a href="#NiftiViewer-847"><span class="linenos"> 847</span></a><span class="sd">                before wrapping. Defaults to 35.</span>
</span><span id="NiftiViewer-848"><a href="#NiftiViewer-848"><span class="linenos"> 848</span></a>
</span><span id="NiftiViewer-849"><a href="#NiftiViewer-849"><span class="linenos"> 849</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer-850"><a href="#NiftiViewer-850"><span class="linenos"> 850</span></a><span class="sd">            str: The formatted text with inserted line breaks for better layout.</span>
</span><span id="NiftiViewer-851"><a href="#NiftiViewer-851"><span class="linenos"> 851</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-852"><a href="#NiftiViewer-852"><span class="linenos"> 852</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">textwrap</span>
</span><span id="NiftiViewer-853"><a href="#NiftiViewer-853"><span class="linenos"> 853</span></a>
</span><span id="NiftiViewer-854"><a href="#NiftiViewer-854"><span class="linenos"> 854</span></a>        <span class="c1"># Split text into lines to process them individually</span>
</span><span id="NiftiViewer-855"><a href="#NiftiViewer-855"><span class="linenos"> 855</span></a>        <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer-856"><a href="#NiftiViewer-856"><span class="linenos"> 856</span></a>        <span class="n">formatted_lines</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer-857"><a href="#NiftiViewer-857"><span class="linenos"> 857</span></a>
</span><span id="NiftiViewer-858"><a href="#NiftiViewer-858"><span class="linenos"> 858</span></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span id="NiftiViewer-859"><a href="#NiftiViewer-859"><span class="linenos"> 859</span></a>            <span class="c1"># If the line fits within limit, keep it unchanged</span>
</span><span id="NiftiViewer-860"><a href="#NiftiViewer-860"><span class="linenos"> 860</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_line_length</span><span class="p">:</span>
</span><span id="NiftiViewer-861"><a href="#NiftiViewer-861"><span class="linenos"> 861</span></a>                <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="NiftiViewer-862"><a href="#NiftiViewer-862"><span class="linenos"> 862</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-863"><a href="#NiftiViewer-863"><span class="linenos"> 863</span></a>                <span class="c1"># Try to split logically around &#39;:&#39; if possible</span>
</span><span id="NiftiViewer-864"><a href="#NiftiViewer-864"><span class="linenos"> 864</span></a>                <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
</span><span id="NiftiViewer-865"><a href="#NiftiViewer-865"><span class="linenos"> 865</span></a>                    <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer-866"><a href="#NiftiViewer-866"><span class="linenos"> 866</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">max_line_length</span><span class="p">:</span>
</span><span id="NiftiViewer-867"><a href="#NiftiViewer-867"><span class="linenos"> 867</span></a>                        <span class="c1"># Add the first part and indent the continuation</span>
</span><span id="NiftiViewer-868"><a href="#NiftiViewer-868"><span class="linenos"> 868</span></a>                        <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer-869"><a href="#NiftiViewer-869"><span class="linenos"> 869</span></a>                        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">width</span><span class="o">=</span><span class="n">max_line_length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="NiftiViewer-870"><a href="#NiftiViewer-870"><span class="linenos"> 870</span></a>                        <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">wrapped</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="p">))</span>
</span><span id="NiftiViewer-871"><a href="#NiftiViewer-871"><span class="linenos"> 871</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-872"><a href="#NiftiViewer-872"><span class="linenos"> 872</span></a>                        <span class="c1"># If even the key part is long, wrap entire line</span>
</span><span id="NiftiViewer-873"><a href="#NiftiViewer-873"><span class="linenos"> 873</span></a>                        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">max_line_length</span><span class="p">)</span>
</span><span id="NiftiViewer-874"><a href="#NiftiViewer-874"><span class="linenos"> 874</span></a>                        <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wrapped</span><span class="p">)</span>
</span><span id="NiftiViewer-875"><a href="#NiftiViewer-875"><span class="linenos"> 875</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-876"><a href="#NiftiViewer-876"><span class="linenos"> 876</span></a>                    <span class="c1"># Wrap normally if no logical split point found</span>
</span><span id="NiftiViewer-877"><a href="#NiftiViewer-877"><span class="linenos"> 877</span></a>                    <span class="n">wrapped</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">max_line_length</span><span class="p">)</span>
</span><span id="NiftiViewer-878"><a href="#NiftiViewer-878"><span class="linenos"> 878</span></a>                    <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wrapped</span><span class="p">)</span>
</span><span id="NiftiViewer-879"><a href="#NiftiViewer-879"><span class="linenos"> 879</span></a>
</span><span id="NiftiViewer-880"><a href="#NiftiViewer-880"><span class="linenos"> 880</span></a>        <span class="c1"># Join all formatted lines back into a single string</span>
</span><span id="NiftiViewer-881"><a href="#NiftiViewer-881"><span class="linenos"> 881</span></a>        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_lines</span><span class="p">)</span>
</span><span id="NiftiViewer-882"><a href="#NiftiViewer-882"><span class="linenos"> 882</span></a>
</span><span id="NiftiViewer-883"><a href="#NiftiViewer-883"><span class="linenos"> 883</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_image_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
</span><span id="NiftiViewer-884"><a href="#NiftiViewer-884"><span class="linenos"> 884</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-885"><a href="#NiftiViewer-885"><span class="linenos"> 885</span></a><span class="sd">        Create the main image display panel with three anatomical views.</span>
</span><span id="NiftiViewer-886"><a href="#NiftiViewer-886"><span class="linenos"> 886</span></a>
</span><span id="NiftiViewer-887"><a href="#NiftiViewer-887"><span class="linenos"> 887</span></a><span class="sd">        This function builds the right-hand visualization area of the NIfTI viewer,</span>
</span><span id="NiftiViewer-888"><a href="#NiftiViewer-888"><span class="linenos"> 888</span></a><span class="sd">        which displays axial, coronal, and sagittal image slices. It also prepares</span>
</span><span id="NiftiViewer-889"><a href="#NiftiViewer-889"><span class="linenos"> 889</span></a><span class="sd">        a fourth panel for displaying image information or time-series plots</span>
</span><span id="NiftiViewer-890"><a href="#NiftiViewer-890"><span class="linenos"> 890</span></a><span class="sd">        (depending on whether the dataset is 3D or 4D).</span>
</span><span id="NiftiViewer-891"><a href="#NiftiViewer-891"><span class="linenos"> 891</span></a>
</span><span id="NiftiViewer-892"><a href="#NiftiViewer-892"><span class="linenos"> 892</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-893"><a href="#NiftiViewer-893"><span class="linenos"> 893</span></a><span class="sd">            parent (QSplitter): The parent splitter widget where the display</span>
</span><span id="NiftiViewer-894"><a href="#NiftiViewer-894"><span class="linenos"> 894</span></a><span class="sd">                area is added.</span>
</span><span id="NiftiViewer-895"><a href="#NiftiViewer-895"><span class="linenos"> 895</span></a>
</span><span id="NiftiViewer-896"><a href="#NiftiViewer-896"><span class="linenos"> 896</span></a><span class="sd">        Components:</span>
</span><span id="NiftiViewer-897"><a href="#NiftiViewer-897"><span class="linenos"> 897</span></a><span class="sd">            - Three synchronized image views with crosshairs.</span>
</span><span id="NiftiViewer-898"><a href="#NiftiViewer-898"><span class="linenos"> 898</span></a><span class="sd">            - A fourth panel for displaying image metadata or 4D time plots.</span>
</span><span id="NiftiViewer-899"><a href="#NiftiViewer-899"><span class="linenos"> 899</span></a><span class="sd">            - Dynamically initialized graphics scenes and pixmap items.</span>
</span><span id="NiftiViewer-900"><a href="#NiftiViewer-900"><span class="linenos"> 900</span></a>
</span><span id="NiftiViewer-901"><a href="#NiftiViewer-901"><span class="linenos"> 901</span></a><span class="sd">        Raises:</span>
</span><span id="NiftiViewer-902"><a href="#NiftiViewer-902"><span class="linenos"> 902</span></a><span class="sd">            Exception: Propagates initialization errors in UI creation.</span>
</span><span id="NiftiViewer-903"><a href="#NiftiViewer-903"><span class="linenos"> 903</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-904"><a href="#NiftiViewer-904"><span class="linenos"> 904</span></a>        <span class="c1"># Create base container and grid layout for the 2x2 view grid</span>
</span><span id="NiftiViewer-905"><a href="#NiftiViewer-905"><span class="linenos"> 905</span></a>        <span class="n">display_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer-906"><a href="#NiftiViewer-906"><span class="linenos"> 906</span></a>        <span class="n">display_layout</span> <span class="o">=</span> <span class="n">QGridLayout</span><span class="p">(</span><span class="n">display_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-907"><a href="#NiftiViewer-907"><span class="linenos"> 907</span></a>        <span class="n">display_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer-908"><a href="#NiftiViewer-908"><span class="linenos"> 908</span></a>
</span><span id="NiftiViewer-909"><a href="#NiftiViewer-909"><span class="linenos"> 909</span></a>        <span class="c1"># Define positions for the three main anatomical views</span>
</span><span id="NiftiViewer-910"><a href="#NiftiViewer-910"><span class="linenos"> 910</span></a>        <span class="n">view_positions</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="NiftiViewer-911"><a href="#NiftiViewer-911"><span class="linenos"> 911</span></a>        <span class="n">view_titles</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="NiftiViewer-912"><a href="#NiftiViewer-912"><span class="linenos"> 912</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Axial&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer-913"><a href="#NiftiViewer-913"><span class="linenos"> 913</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coronal&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer-914"><a href="#NiftiViewer-914"><span class="linenos"> 914</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Sagittal&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-915"><a href="#NiftiViewer-915"><span class="linenos"> 915</span></a>        <span class="p">]</span>
</span><span id="NiftiViewer-916"><a href="#NiftiViewer-916"><span class="linenos"> 916</span></a>
</span><span id="NiftiViewer-917"><a href="#NiftiViewer-917"><span class="linenos"> 917</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">view_titles_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer-918"><a href="#NiftiViewer-918"><span class="linenos"> 918</span></a>
</span><span id="NiftiViewer-919"><a href="#NiftiViewer-919"><span class="linenos"> 919</span></a>        <span class="c1"># Iterate through each anatomical plane and create a visualization frame</span>
</span><span id="NiftiViewer-920"><a href="#NiftiViewer-920"><span class="linenos"> 920</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">view_positions</span><span class="p">):</span>
</span><span id="NiftiViewer-921"><a href="#NiftiViewer-921"><span class="linenos"> 921</span></a>            <span class="c1"># Create container with border style</span>
</span><span id="NiftiViewer-922"><a href="#NiftiViewer-922"><span class="linenos"> 922</span></a>            <span class="n">view_container</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer-923"><a href="#NiftiViewer-923"><span class="linenos"> 923</span></a>            <span class="n">view_container</span><span class="o">.</span><span class="n">setFrameStyle</span><span class="p">(</span><span class="n">QFrame</span><span class="o">.</span><span class="n">Shape</span><span class="o">.</span><span class="n">StyledPanel</span><span class="p">)</span>
</span><span id="NiftiViewer-924"><a href="#NiftiViewer-924"><span class="linenos"> 924</span></a>            <span class="n">container_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">view_container</span><span class="p">)</span>
</span><span id="NiftiViewer-925"><a href="#NiftiViewer-925"><span class="linenos"> 925</span></a>            <span class="n">container_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="NiftiViewer-926"><a href="#NiftiViewer-926"><span class="linenos"> 926</span></a>
</span><span id="NiftiViewer-927"><a href="#NiftiViewer-927"><span class="linenos"> 927</span></a>            <span class="c1"># Title label (Axial, Coronal, Sagittal)</span>
</span><span id="NiftiViewer-928"><a href="#NiftiViewer-928"><span class="linenos"> 928</span></a>            <span class="n">title_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">view_titles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="NiftiViewer-929"><a href="#NiftiViewer-929"><span class="linenos"> 929</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view_titles_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title_label</span><span class="p">)</span>
</span><span id="NiftiViewer-930"><a href="#NiftiViewer-930"><span class="linenos"> 930</span></a>            <span class="n">title_label</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignmentFlag</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
</span><span id="NiftiViewer-931"><a href="#NiftiViewer-931"><span class="linenos"> 931</span></a>            <span class="n">title_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; padding: 4px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-932"><a href="#NiftiViewer-932"><span class="linenos"> 932</span></a>            <span class="n">container_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">title_label</span><span class="p">)</span>
</span><span id="NiftiViewer-933"><a href="#NiftiViewer-933"><span class="linenos"> 933</span></a>
</span><span id="NiftiViewer-934"><a href="#NiftiViewer-934"><span class="linenos"> 934</span></a>            <span class="c1"># Initialize graphics view for image rendering</span>
</span><span id="NiftiViewer-935"><a href="#NiftiViewer-935"><span class="linenos"> 935</span></a>            <span class="n">view</span> <span class="o">=</span> <span class="n">CrosshairGraphicsView</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span id="NiftiViewer-936"><a href="#NiftiViewer-936"><span class="linenos"> 936</span></a>            <span class="n">view</span><span class="o">.</span><span class="n">setMinimumSize</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</span><span id="NiftiViewer-937"><a href="#NiftiViewer-937"><span class="linenos"> 937</span></a>            <span class="n">view</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">)</span>
</span><span id="NiftiViewer-938"><a href="#NiftiViewer-938"><span class="linenos"> 938</span></a>
</span><span id="NiftiViewer-939"><a href="#NiftiViewer-939"><span class="linenos"> 939</span></a>            <span class="c1"># Create graphics scene for the view</span>
</span><span id="NiftiViewer-940"><a href="#NiftiViewer-940"><span class="linenos"> 940</span></a>            <span class="n">scene</span> <span class="o">=</span> <span class="n">QGraphicsScene</span><span class="p">()</span>
</span><span id="NiftiViewer-941"><a href="#NiftiViewer-941"><span class="linenos"> 941</span></a>            <span class="n">view</span><span class="o">.</span><span class="n">setScene</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
</span><span id="NiftiViewer-942"><a href="#NiftiViewer-942"><span class="linenos"> 942</span></a>
</span><span id="NiftiViewer-943"><a href="#NiftiViewer-943"><span class="linenos"> 943</span></a>            <span class="c1"># Create pixmap item (the actual displayed image)</span>
</span><span id="NiftiViewer-944"><a href="#NiftiViewer-944"><span class="linenos"> 944</span></a>            <span class="n">pixmap_item</span> <span class="o">=</span> <span class="n">QGraphicsPixmapItem</span><span class="p">()</span>
</span><span id="NiftiViewer-945"><a href="#NiftiViewer-945"><span class="linenos"> 945</span></a>            <span class="n">scene</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">pixmap_item</span><span class="p">)</span>
</span><span id="NiftiViewer-946"><a href="#NiftiViewer-946"><span class="linenos"> 946</span></a>
</span><span id="NiftiViewer-947"><a href="#NiftiViewer-947"><span class="linenos"> 947</span></a>            <span class="c1"># Add view to its container layout</span>
</span><span id="NiftiViewer-948"><a href="#NiftiViewer-948"><span class="linenos"> 948</span></a>            <span class="n">container_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span><span id="NiftiViewer-949"><a href="#NiftiViewer-949"><span class="linenos"> 949</span></a>
</span><span id="NiftiViewer-950"><a href="#NiftiViewer-950"><span class="linenos"> 950</span></a>            <span class="c1"># Place container in grid layout</span>
</span><span id="NiftiViewer-951"><a href="#NiftiViewer-951"><span class="linenos"> 951</span></a>            <span class="n">display_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">view_container</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
</span><span id="NiftiViewer-952"><a href="#NiftiViewer-952"><span class="linenos"> 952</span></a>
</span><span id="NiftiViewer-953"><a href="#NiftiViewer-953"><span class="linenos"> 953</span></a>            <span class="c1"># Keep references for later updates/redraws</span>
</span><span id="NiftiViewer-954"><a href="#NiftiViewer-954"><span class="linenos"> 954</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span><span id="NiftiViewer-955"><a href="#NiftiViewer-955"><span class="linenos"> 955</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
</span><span id="NiftiViewer-956"><a href="#NiftiViewer-956"><span class="linenos"> 956</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pixmap_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pixmap_item</span><span class="p">)</span>
</span><span id="NiftiViewer-957"><a href="#NiftiViewer-957"><span class="linenos"> 957</span></a>
</span><span id="NiftiViewer-958"><a href="#NiftiViewer-958"><span class="linenos"> 958</span></a>        <span class="c1"># ==============================</span>
</span><span id="NiftiViewer-959"><a href="#NiftiViewer-959"><span class="linenos"> 959</span></a>        <span class="c1">#  Fourth Panel (Info / Plot)</span>
</span><span id="NiftiViewer-960"><a href="#NiftiViewer-960"><span class="linenos"> 960</span></a>        <span class="c1"># ==============================</span>
</span><span id="NiftiViewer-961"><a href="#NiftiViewer-961"><span class="linenos"> 961</span></a>        <span class="c1"># Bottom-right panel for metadata or time-series visualization</span>
</span><span id="NiftiViewer-962"><a href="#NiftiViewer-962"><span class="linenos"> 962</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_widget</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer-963"><a href="#NiftiViewer-963"><span class="linenos"> 963</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_widget</span><span class="o">.</span><span class="n">setFrameStyle</span><span class="p">(</span><span class="n">QFrame</span><span class="o">.</span><span class="n">Shape</span><span class="o">.</span><span class="n">StyledPanel</span><span class="p">)</span>
</span><span id="NiftiViewer-964"><a href="#NiftiViewer-964"><span class="linenos"> 964</span></a>        <span class="n">fourth_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fourth_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-965"><a href="#NiftiViewer-965"><span class="linenos"> 965</span></a>
</span><span id="NiftiViewer-966"><a href="#NiftiViewer-966"><span class="linenos"> 966</span></a>        <span class="c1"># Section title</span>
</span><span id="NiftiViewer-967"><a href="#NiftiViewer-967"><span class="linenos"> 967</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Image Information&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-968"><a href="#NiftiViewer-968"><span class="linenos"> 968</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignmentFlag</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
</span><span id="NiftiViewer-969"><a href="#NiftiViewer-969"><span class="linenos"> 969</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; padding: 4px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-970"><a href="#NiftiViewer-970"><span class="linenos"> 970</span></a>        <span class="n">fourth_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="p">)</span>
</span><span id="NiftiViewer-971"><a href="#NiftiViewer-971"><span class="linenos"> 971</span></a>
</span><span id="NiftiViewer-972"><a href="#NiftiViewer-972"><span class="linenos"> 972</span></a>        <span class="c1"># Content container allows swapping between info text and plots</span>
</span><span id="NiftiViewer-973"><a href="#NiftiViewer-973"><span class="linenos"> 973</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_content</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer-974"><a href="#NiftiViewer-974"><span class="linenos"> 974</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_content_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fourth_content</span><span class="p">)</span>
</span><span id="NiftiViewer-975"><a href="#NiftiViewer-975"><span class="linenos"> 975</span></a>
</span><span id="NiftiViewer-976"><a href="#NiftiViewer-976"><span class="linenos"> 976</span></a>        <span class="c1"># Default info label (shown when no image is loaded)</span>
</span><span id="NiftiViewer-977"><a href="#NiftiViewer-977"><span class="linenos"> 977</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No image loaded&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-978"><a href="#NiftiViewer-978"><span class="linenos"> 978</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignmentFlag</span><span class="o">.</span><span class="n">AlignTop</span><span class="p">)</span>
</span><span id="NiftiViewer-979"><a href="#NiftiViewer-979"><span class="linenos"> 979</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: #cccccc; font-size: 11px; padding: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-980"><a href="#NiftiViewer-980"><span class="linenos"> 980</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setWordWrap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-981"><a href="#NiftiViewer-981"><span class="linenos"> 981</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_content_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="p">)</span>
</span><span id="NiftiViewer-982"><a href="#NiftiViewer-982"><span class="linenos"> 982</span></a>
</span><span id="NiftiViewer-983"><a href="#NiftiViewer-983"><span class="linenos"> 983</span></a>        <span class="c1"># Placeholders for 4D time-series plotting (initialized later)</span>
</span><span id="NiftiViewer-984"><a href="#NiftiViewer-984"><span class="linenos"> 984</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_widget</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-985"><a href="#NiftiViewer-985"><span class="linenos"> 985</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-986"><a href="#NiftiViewer-986"><span class="linenos"> 986</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_indicator_line</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-987"><a href="#NiftiViewer-987"><span class="linenos"> 987</span></a>
</span><span id="NiftiViewer-988"><a href="#NiftiViewer-988"><span class="linenos"> 988</span></a>        <span class="c1"># Add dynamic content area to layout</span>
</span><span id="NiftiViewer-989"><a href="#NiftiViewer-989"><span class="linenos"> 989</span></a>        <span class="n">fourth_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fourth_content</span><span class="p">)</span>
</span><span id="NiftiViewer-990"><a href="#NiftiViewer-990"><span class="linenos"> 990</span></a>
</span><span id="NiftiViewer-991"><a href="#NiftiViewer-991"><span class="linenos"> 991</span></a>        <span class="c1"># Add the fourth widget to the main grid (bottom-right cell)</span>
</span><span id="NiftiViewer-992"><a href="#NiftiViewer-992"><span class="linenos"> 992</span></a>        <span class="n">display_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fourth_widget</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer-993"><a href="#NiftiViewer-993"><span class="linenos"> 993</span></a>
</span><span id="NiftiViewer-994"><a href="#NiftiViewer-994"><span class="linenos"> 994</span></a>        <span class="c1"># Attach the full display grid to the parent splitter</span>
</span><span id="NiftiViewer-995"><a href="#NiftiViewer-995"><span class="linenos"> 995</span></a>        <span class="n">parent</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">display_widget</span><span class="p">)</span>
</span><span id="NiftiViewer-996"><a href="#NiftiViewer-996"><span class="linenos"> 996</span></a>
</span><span id="NiftiViewer-997"><a href="#NiftiViewer-997"><span class="linenos"> 997</span></a>        <span class="c1"># Delay setup of interactive crosshairs until UI is ready</span>
</span><span id="NiftiViewer-998"><a href="#NiftiViewer-998"><span class="linenos"> 998</span></a>        <span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_crosshairs</span><span class="p">)</span>
</span><span id="NiftiViewer-999"><a href="#NiftiViewer-999"><span class="linenos"> 999</span></a>
</span><span id="NiftiViewer-1000"><a href="#NiftiViewer-1000"><span class="linenos">1000</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_crosshairs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-1001"><a href="#NiftiViewer-1001"><span class="linenos">1001</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1002"><a href="#NiftiViewer-1002"><span class="linenos">1002</span></a><span class="sd">        Initialize and configure crosshair overlays for all active image views.</span>
</span><span id="NiftiViewer-1003"><a href="#NiftiViewer-1003"><span class="linenos">1003</span></a>
</span><span id="NiftiViewer-1004"><a href="#NiftiViewer-1004"><span class="linenos">1004</span></a><span class="sd">        This method ensures that each anatomical view (axial, coronal, sagittal)</span>
</span><span id="NiftiViewer-1005"><a href="#NiftiViewer-1005"><span class="linenos">1005</span></a><span class="sd">        has its own interactive crosshair layer properly initialized.</span>
</span><span id="NiftiViewer-1006"><a href="#NiftiViewer-1006"><span class="linenos">1006</span></a>
</span><span id="NiftiViewer-1007"><a href="#NiftiViewer-1007"><span class="linenos">1007</span></a><span class="sd">        Purpose:</span>
</span><span id="NiftiViewer-1008"><a href="#NiftiViewer-1008"><span class="linenos">1008</span></a><span class="sd">            - Enables visual reference lines for voxel coordinates.</span>
</span><span id="NiftiViewer-1009"><a href="#NiftiViewer-1009"><span class="linenos">1009</span></a><span class="sd">            - Synchronizes navigation across views.</span>
</span><span id="NiftiViewer-1010"><a href="#NiftiViewer-1010"><span class="linenos">1010</span></a>
</span><span id="NiftiViewer-1011"><a href="#NiftiViewer-1011"><span class="linenos">1011</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer-1012"><a href="#NiftiViewer-1012"><span class="linenos">1012</span></a><span class="sd">            None</span>
</span><span id="NiftiViewer-1013"><a href="#NiftiViewer-1013"><span class="linenos">1013</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1014"><a href="#NiftiViewer-1014"><span class="linenos">1014</span></a>        <span class="c1"># Iterate over all graphics views and initialize their crosshairs</span>
</span><span id="NiftiViewer-1015"><a href="#NiftiViewer-1015"><span class="linenos">1015</span></a>        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">:</span>
</span><span id="NiftiViewer-1016"><a href="#NiftiViewer-1016"><span class="linenos">1016</span></a>            <span class="n">view</span><span class="o">.</span><span class="n">setup_crosshairs</span><span class="p">()</span>
</span><span id="NiftiViewer-1017"><a href="#NiftiViewer-1017"><span class="linenos">1017</span></a>
</span><span id="NiftiViewer-1018"><a href="#NiftiViewer-1018"><span class="linenos">1018</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-1019"><a href="#NiftiViewer-1019"><span class="linenos">1019</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1020"><a href="#NiftiViewer-1020"><span class="linenos">1020</span></a><span class="sd">        Establish all signal-slot connections for the viewer interface.</span>
</span><span id="NiftiViewer-1021"><a href="#NiftiViewer-1021"><span class="linenos">1021</span></a>
</span><span id="NiftiViewer-1022"><a href="#NiftiViewer-1022"><span class="linenos">1022</span></a><span class="sd">        This method binds user interface widgets (buttons, sliders, spin boxes, checkboxes)</span>
</span><span id="NiftiViewer-1023"><a href="#NiftiViewer-1023"><span class="linenos">1023</span></a><span class="sd">        to their respective event handlers to enable interactive control over the</span>
</span><span id="NiftiViewer-1024"><a href="#NiftiViewer-1024"><span class="linenos">1024</span></a><span class="sd">        visualization and processing of NIfTI images.</span>
</span><span id="NiftiViewer-1025"><a href="#NiftiViewer-1025"><span class="linenos">1025</span></a>
</span><span id="NiftiViewer-1026"><a href="#NiftiViewer-1026"><span class="linenos">1026</span></a><span class="sd">        Connections include:</span>
</span><span id="NiftiViewer-1027"><a href="#NiftiViewer-1027"><span class="linenos">1027</span></a><span class="sd">            - File operations (open base and overlay images)</span>
</span><span id="NiftiViewer-1028"><a href="#NiftiViewer-1028"><span class="linenos">1028</span></a><span class="sd">            - Slice navigation (sliders and spinboxes)</span>
</span><span id="NiftiViewer-1029"><a href="#NiftiViewer-1029"><span class="linenos">1029</span></a><span class="sd">            - ROI (Region of Interest) automation controls</span>
</span><span id="NiftiViewer-1030"><a href="#NiftiViewer-1030"><span class="linenos">1030</span></a><span class="sd">            - Time series navigation (for 4D datasets)</span>
</span><span id="NiftiViewer-1031"><a href="#NiftiViewer-1031"><span class="linenos">1031</span></a><span class="sd">            - Colormap and overlay adjustments</span>
</span><span id="NiftiViewer-1032"><a href="#NiftiViewer-1032"><span class="linenos">1032</span></a><span class="sd">            - Coordinate updates between synchronized views</span>
</span><span id="NiftiViewer-1033"><a href="#NiftiViewer-1033"><span class="linenos">1033</span></a>
</span><span id="NiftiViewer-1034"><a href="#NiftiViewer-1034"><span class="linenos">1034</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer-1035"><a href="#NiftiViewer-1035"><span class="linenos">1035</span></a><span class="sd">            None</span>
</span><span id="NiftiViewer-1036"><a href="#NiftiViewer-1036"><span class="linenos">1036</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1037"><a href="#NiftiViewer-1037"><span class="linenos">1037</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1038"><a href="#NiftiViewer-1038"><span class="linenos">1038</span></a>        <span class="c1"># File-related connections</span>
</span><span id="NiftiViewer-1039"><a href="#NiftiViewer-1039"><span class="linenos">1039</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1040"><a href="#NiftiViewer-1040"><span class="linenos">1040</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">())</span>
</span><span id="NiftiViewer-1041"><a href="#NiftiViewer-1041"><span class="linenos">1041</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">is_overlay</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="NiftiViewer-1042"><a href="#NiftiViewer-1042"><span class="linenos">1042</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_overlay</span><span class="p">)</span>
</span><span id="NiftiViewer-1043"><a href="#NiftiViewer-1043"><span class="linenos">1043</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_overlay_alpha</span><span class="p">)</span>
</span><span id="NiftiViewer-1044"><a href="#NiftiViewer-1044"><span class="linenos">1044</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_overlay_threshold</span><span class="p">)</span>
</span><span id="NiftiViewer-1045"><a href="#NiftiViewer-1045"><span class="linenos">1045</span></a>
</span><span id="NiftiViewer-1046"><a href="#NiftiViewer-1046"><span class="linenos">1046</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1047"><a href="#NiftiViewer-1047"><span class="linenos">1047</span></a>        <span class="c1"># Slice navigation connections</span>
</span><span id="NiftiViewer-1048"><a href="#NiftiViewer-1048"><span class="linenos">1048</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1049"><a href="#NiftiViewer-1049"><span class="linenos">1049</span></a>        <span class="c1"># Connect slice sliders and spinboxes for all anatomical planes</span>
</span><span id="NiftiViewer-1050"><a href="#NiftiViewer-1050"><span class="linenos">1050</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">slider</span><span class="p">,</span> <span class="n">spinbox</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">)):</span>
</span><span id="NiftiViewer-1051"><a href="#NiftiViewer-1051"><span class="linenos">1051</span></a>            <span class="n">slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_changed</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</span><span id="NiftiViewer-1052"><a href="#NiftiViewer-1052"><span class="linenos">1052</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_changed</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</span><span id="NiftiViewer-1053"><a href="#NiftiViewer-1053"><span class="linenos">1053</span></a>
</span><span id="NiftiViewer-1054"><a href="#NiftiViewer-1054"><span class="linenos">1054</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1055"><a href="#NiftiViewer-1055"><span class="linenos">1055</span></a>        <span class="c1"># Automatic ROI Drawing controls</span>
</span><span id="NiftiViewer-1056"><a href="#NiftiViewer-1056"><span class="linenos">1056</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1057"><a href="#NiftiViewer-1057"><span class="linenos">1057</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_clicked</span><span class="p">)</span>
</span><span id="NiftiViewer-1058"><a href="#NiftiViewer-1058"><span class="linenos">1058</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_automaticROI</span><span class="p">)</span>
</span><span id="NiftiViewer-1059"><a href="#NiftiViewer-1059"><span class="linenos">1059</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_automaticROI</span><span class="p">)</span>
</span><span id="NiftiViewer-1060"><a href="#NiftiViewer-1060"><span class="linenos">1060</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_save</span><span class="p">)</span>
</span><span id="NiftiViewer-1061"><a href="#NiftiViewer-1061"><span class="linenos">1061</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_automaticROI</span><span class="p">)</span>
</span><span id="NiftiViewer-1062"><a href="#NiftiViewer-1062"><span class="linenos">1062</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_clicked</span><span class="p">)</span>
</span><span id="NiftiViewer-1063"><a href="#NiftiViewer-1063"><span class="linenos">1063</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_incrementalROI</span><span class="p">)</span>
</span><span id="NiftiViewer-1064"><a href="#NiftiViewer-1064"><span class="linenos">1064</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resetROI</span><span class="p">)</span>
</span><span id="NiftiViewer-1065"><a href="#NiftiViewer-1065"><span class="linenos">1065</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1066"><a href="#NiftiViewer-1066"><span class="linenos">1066</span></a>        <span class="c1"># Time-series control connections (for 4D images)</span>
</span><span id="NiftiViewer-1067"><a href="#NiftiViewer-1067"><span class="linenos">1067</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1068"><a href="#NiftiViewer-1068"><span class="linenos">1068</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_time_controls</span><span class="p">)</span>
</span><span id="NiftiViewer-1069"><a href="#NiftiViewer-1069"><span class="linenos">1069</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_changed</span><span class="p">)</span>
</span><span id="NiftiViewer-1070"><a href="#NiftiViewer-1070"><span class="linenos">1070</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_changed</span><span class="p">)</span>
</span><span id="NiftiViewer-1071"><a href="#NiftiViewer-1071"><span class="linenos">1071</span></a>
</span><span id="NiftiViewer-1072"><a href="#NiftiViewer-1072"><span class="linenos">1072</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1073"><a href="#NiftiViewer-1073"><span class="linenos">1073</span></a>        <span class="c1"># Colormap control</span>
</span><span id="NiftiViewer-1074"><a href="#NiftiViewer-1074"><span class="linenos">1074</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1075"><a href="#NiftiViewer-1075"><span class="linenos">1075</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="o">.</span><span class="n">currentTextChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colormap_changed</span><span class="p">)</span>
</span><span id="NiftiViewer-1076"><a href="#NiftiViewer-1076"><span class="linenos">1076</span></a>
</span><span id="NiftiViewer-1077"><a href="#NiftiViewer-1077"><span class="linenos">1077</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1078"><a href="#NiftiViewer-1078"><span class="linenos">1078</span></a>        <span class="c1"># Coordinate synchronization across views</span>
</span><span id="NiftiViewer-1079"><a href="#NiftiViewer-1079"><span class="linenos">1079</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1080"><a href="#NiftiViewer-1080"><span class="linenos">1080</span></a>        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">:</span>
</span><span id="NiftiViewer-1081"><a href="#NiftiViewer-1081"><span class="linenos">1081</span></a>            <span class="n">view</span><span class="o">.</span><span class="n">coordinate_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_coordinates</span><span class="p">)</span>
</span><span id="NiftiViewer-1082"><a href="#NiftiViewer-1082"><span class="linenos">1082</span></a>
</span><span id="NiftiViewer-1083"><a href="#NiftiViewer-1083"><span class="linenos">1083</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">show_workspace_nii_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_overlay</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="NiftiViewer-1084"><a href="#NiftiViewer-1084"><span class="linenos">1084</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1085"><a href="#NiftiViewer-1085"><span class="linenos">1085</span></a><span class="sd">        Open a workspace-aware file selection dialog for NIfTI files.</span>
</span><span id="NiftiViewer-1086"><a href="#NiftiViewer-1086"><span class="linenos">1086</span></a>
</span><span id="NiftiViewer-1087"><a href="#NiftiViewer-1087"><span class="linenos">1087</span></a><span class="sd">        Depending on the mode (`is_overlay`), this dialog either selects</span>
</span><span id="NiftiViewer-1088"><a href="#NiftiViewer-1088"><span class="linenos">1088</span></a><span class="sd">        a base anatomical image or a secondary overlay image from the users workspace.</span>
</span><span id="NiftiViewer-1089"><a href="#NiftiViewer-1089"><span class="linenos">1089</span></a>
</span><span id="NiftiViewer-1090"><a href="#NiftiViewer-1090"><span class="linenos">1090</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-1091"><a href="#NiftiViewer-1091"><span class="linenos">1091</span></a><span class="sd">            is_overlay (bool, optional): Whether the dialog is for selecting an overlay file.</span>
</span><span id="NiftiViewer-1092"><a href="#NiftiViewer-1092"><span class="linenos">1092</span></a><span class="sd">                Defaults to False.</span>
</span><span id="NiftiViewer-1093"><a href="#NiftiViewer-1093"><span class="linenos">1093</span></a>
</span><span id="NiftiViewer-1094"><a href="#NiftiViewer-1094"><span class="linenos">1094</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer-1095"><a href="#NiftiViewer-1095"><span class="linenos">1095</span></a><span class="sd">            None: If a file is selected, it triggers `open_file()` automatically.</span>
</span><span id="NiftiViewer-1096"><a href="#NiftiViewer-1096"><span class="linenos">1096</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1097"><a href="#NiftiViewer-1097"><span class="linenos">1097</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1098"><a href="#NiftiViewer-1098"><span class="linenos">1098</span></a>        <span class="c1"># Select file using NiftiFileDialog, filtering appropriately</span>
</span><span id="NiftiViewer-1099"><a href="#NiftiViewer-1099"><span class="linenos">1099</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1100"><a href="#NiftiViewer-1100"><span class="linenos">1100</span></a>        <span class="k">if</span> <span class="n">is_overlay</span><span class="p">:</span>
</span><span id="NiftiViewer-1101"><a href="#NiftiViewer-1101"><span class="linenos">1101</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">NiftiFileDialog</span><span class="o">.</span><span class="n">get_files</span><span class="p">(</span>
</span><span id="NiftiViewer-1102"><a href="#NiftiViewer-1102"><span class="linenos">1102</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
</span><span id="NiftiViewer-1103"><a href="#NiftiViewer-1103"><span class="linenos">1103</span></a>                <span class="n">allow_multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="NiftiViewer-1104"><a href="#NiftiViewer-1104"><span class="linenos">1104</span></a>                <span class="n">has_existing_func</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="NiftiViewer-1105"><a href="#NiftiViewer-1105"><span class="linenos">1105</span></a>                <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="NiftiViewer-1106"><a href="#NiftiViewer-1106"><span class="linenos">1106</span></a>                <span class="n">forced_filters</span><span class="o">=</span><span class="kc">None</span>
</span><span id="NiftiViewer-1107"><a href="#NiftiViewer-1107"><span class="linenos">1107</span></a>            <span class="p">)</span>
</span><span id="NiftiViewer-1108"><a href="#NiftiViewer-1108"><span class="linenos">1108</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-1109"><a href="#NiftiViewer-1109"><span class="linenos">1109</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">NiftiFileDialog</span><span class="o">.</span><span class="n">get_files</span><span class="p">(</span>
</span><span id="NiftiViewer-1110"><a href="#NiftiViewer-1110"><span class="linenos">1110</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
</span><span id="NiftiViewer-1111"><a href="#NiftiViewer-1111"><span class="linenos">1111</span></a>                <span class="n">allow_multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="NiftiViewer-1112"><a href="#NiftiViewer-1112"><span class="linenos">1112</span></a>                <span class="n">has_existing_func</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="NiftiViewer-1113"><a href="#NiftiViewer-1113"><span class="linenos">1113</span></a>                <span class="n">label</span><span class="o">=</span><span class="kc">None</span>
</span><span id="NiftiViewer-1114"><a href="#NiftiViewer-1114"><span class="linenos">1114</span></a>            <span class="p">)</span>
</span><span id="NiftiViewer-1115"><a href="#NiftiViewer-1115"><span class="linenos">1115</span></a>
</span><span id="NiftiViewer-1116"><a href="#NiftiViewer-1116"><span class="linenos">1116</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1117"><a href="#NiftiViewer-1117"><span class="linenos">1117</span></a>        <span class="c1"># Open file if a valid selection was made</span>
</span><span id="NiftiViewer-1118"><a href="#NiftiViewer-1118"><span class="linenos">1118</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1119"><a href="#NiftiViewer-1119"><span class="linenos">1119</span></a>        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
</span><span id="NiftiViewer-1120"><a href="#NiftiViewer-1120"><span class="linenos">1120</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">is_overlay</span><span class="o">=</span><span class="n">is_overlay</span><span class="p">)</span>
</span><span id="NiftiViewer-1121"><a href="#NiftiViewer-1121"><span class="linenos">1121</span></a>
</span><span id="NiftiViewer-1122"><a href="#NiftiViewer-1122"><span class="linenos">1122</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">open_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_overlay</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="NiftiViewer-1123"><a href="#NiftiViewer-1123"><span class="linenos">1123</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1124"><a href="#NiftiViewer-1124"><span class="linenos">1124</span></a><span class="sd">        Load a NIfTI file (base or overlay) using a background thread.</span>
</span><span id="NiftiViewer-1125"><a href="#NiftiViewer-1125"><span class="linenos">1125</span></a>
</span><span id="NiftiViewer-1126"><a href="#NiftiViewer-1126"><span class="linenos">1126</span></a><span class="sd">        This method either opens a file dialog for selecting a NIfTI file</span>
</span><span id="NiftiViewer-1127"><a href="#NiftiViewer-1127"><span class="linenos">1127</span></a><span class="sd">        or loads a specified path directly. The loading process runs in a</span>
</span><span id="NiftiViewer-1128"><a href="#NiftiViewer-1128"><span class="linenos">1128</span></a><span class="sd">        separate thread to keep the UI responsive, with progress reported</span>
</span><span id="NiftiViewer-1129"><a href="#NiftiViewer-1129"><span class="linenos">1129</span></a><span class="sd">        via a modal progress dialog.</span>
</span><span id="NiftiViewer-1130"><a href="#NiftiViewer-1130"><span class="linenos">1130</span></a>
</span><span id="NiftiViewer-1131"><a href="#NiftiViewer-1131"><span class="linenos">1131</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-1132"><a href="#NiftiViewer-1132"><span class="linenos">1132</span></a><span class="sd">            file_path (str, optional): Path to the NIfTI file to load. If None,</span>
</span><span id="NiftiViewer-1133"><a href="#NiftiViewer-1133"><span class="linenos">1133</span></a><span class="sd">                a file dialog will be displayed.</span>
</span><span id="NiftiViewer-1134"><a href="#NiftiViewer-1134"><span class="linenos">1134</span></a><span class="sd">            is_overlay (bool, optional): Whether the file being opened is an overlay</span>
</span><span id="NiftiViewer-1135"><a href="#NiftiViewer-1135"><span class="linenos">1135</span></a><span class="sd">                (requires a base image to be already loaded). Defaults to False.</span>
</span><span id="NiftiViewer-1136"><a href="#NiftiViewer-1136"><span class="linenos">1136</span></a>
</span><span id="NiftiViewer-1137"><a href="#NiftiViewer-1137"><span class="linenos">1137</span></a><span class="sd">        Raises:</span>
</span><span id="NiftiViewer-1138"><a href="#NiftiViewer-1138"><span class="linenos">1138</span></a><span class="sd">            RuntimeError: If the overlay is loaded without a base image.</span>
</span><span id="NiftiViewer-1139"><a href="#NiftiViewer-1139"><span class="linenos">1139</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1140"><a href="#NiftiViewer-1140"><span class="linenos">1140</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1141"><a href="#NiftiViewer-1141"><span class="linenos">1141</span></a>        <span class="c1"># Prevent overlay loading without a base image</span>
</span><span id="NiftiViewer-1142"><a href="#NiftiViewer-1142"><span class="linenos">1142</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1143"><a href="#NiftiViewer-1143"><span class="linenos">1143</span></a>        <span class="k">if</span> <span class="n">is_overlay</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1144"><a href="#NiftiViewer-1144"><span class="linenos">1144</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="NiftiViewer-1145"><a href="#NiftiViewer-1145"><span class="linenos">1145</span></a>                <span class="bp">self</span><span class="p">,</span>
</span><span id="NiftiViewer-1146"><a href="#NiftiViewer-1146"><span class="linenos">1146</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Warning&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer-1147"><a href="#NiftiViewer-1147"><span class="linenos">1147</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Please load a base image first!&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1148"><a href="#NiftiViewer-1148"><span class="linenos">1148</span></a>            <span class="p">)</span>
</span><span id="NiftiViewer-1149"><a href="#NiftiViewer-1149"><span class="linenos">1149</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No base image&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1150"><a href="#NiftiViewer-1150"><span class="linenos">1150</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer-1151"><a href="#NiftiViewer-1151"><span class="linenos">1151</span></a>
</span><span id="NiftiViewer-1152"><a href="#NiftiViewer-1152"><span class="linenos">1152</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1153"><a href="#NiftiViewer-1153"><span class="linenos">1153</span></a>        <span class="c1"># Show file dialog if no path is provided</span>
</span><span id="NiftiViewer-1154"><a href="#NiftiViewer-1154"><span class="linenos">1154</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1155"><a href="#NiftiViewer-1155"><span class="linenos">1155</span></a>        <span class="k">if</span> <span class="n">file_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1156"><a href="#NiftiViewer-1156"><span class="linenos">1156</span></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_workspace_nii_dialog</span><span class="p">(</span><span class="n">is_overlay</span><span class="o">=</span><span class="n">is_overlay</span><span class="p">)</span>
</span><span id="NiftiViewer-1157"><a href="#NiftiViewer-1157"><span class="linenos">1157</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="p">:</span>  <span class="c1"># User canceled the dialog</span>
</span><span id="NiftiViewer-1158"><a href="#NiftiViewer-1158"><span class="linenos">1158</span></a>                <span class="k">return</span>
</span><span id="NiftiViewer-1159"><a href="#NiftiViewer-1159"><span class="linenos">1159</span></a>
</span><span id="NiftiViewer-1160"><a href="#NiftiViewer-1160"><span class="linenos">1160</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1161"><a href="#NiftiViewer-1161"><span class="linenos">1161</span></a>        <span class="c1"># Start file loading process</span>
</span><span id="NiftiViewer-1162"><a href="#NiftiViewer-1162"><span class="linenos">1162</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer-1163"><a href="#NiftiViewer-1163"><span class="linenos">1163</span></a>        <span class="k">if</span> <span class="n">file_path</span><span class="p">:</span>
</span><span id="NiftiViewer-1164"><a href="#NiftiViewer-1164"><span class="linenos">1164</span></a>            <span class="c1"># Create and configure progress dialog</span>
</span><span id="NiftiViewer-1165"><a href="#NiftiViewer-1165"><span class="linenos">1165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span> <span class="o">=</span> <span class="n">QProgressDialog</span><span class="p">(</span>
</span><span id="NiftiViewer-1166"><a href="#NiftiViewer-1166"><span class="linenos">1166</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Loading NIfTI file...&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer-1167"><a href="#NiftiViewer-1167"><span class="linenos">1167</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Cancel&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="bp">self</span>
</span><span id="NiftiViewer-1168"><a href="#NiftiViewer-1168"><span class="linenos">1168</span></a>            <span class="p">)</span>
</span><span id="NiftiViewer-1169"><a href="#NiftiViewer-1169"><span class="linenos">1169</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">setWindowModality</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WindowModality</span><span class="o">.</span><span class="n">WindowModal</span><span class="p">)</span>
</span><span id="NiftiViewer-1170"><a href="#NiftiViewer-1170"><span class="linenos">1170</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">setMinimumDuration</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-1171"><a href="#NiftiViewer-1171"><span class="linenos">1171</span></a>
</span><span id="NiftiViewer-1172"><a href="#NiftiViewer-1172"><span class="linenos">1172</span></a>            <span class="c1"># Launch threaded image loading</span>
</span><span id="NiftiViewer-1173"><a href="#NiftiViewer-1173"><span class="linenos">1173</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ImageLoadThread</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">is_overlay</span><span class="p">))</span>
</span><span id="NiftiViewer-1174"><a href="#NiftiViewer-1174"><span class="linenos">1174</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_file_loaded</span><span class="p">)</span>
</span><span id="NiftiViewer-1175"><a href="#NiftiViewer-1175"><span class="linenos">1175</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_load_error</span><span class="p">)</span>
</span><span id="NiftiViewer-1176"><a href="#NiftiViewer-1176"><span class="linenos">1176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer-1177"><a href="#NiftiViewer-1177"><span class="linenos">1177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="NiftiViewer-1178"><a href="#NiftiViewer-1178"><span class="linenos">1178</span></a>
</span><span id="NiftiViewer-1179"><a href="#NiftiViewer-1179"><span class="linenos">1179</span></a>            <span class="c1"># Allow user to cancel the loading process</span>
</span><span id="NiftiViewer-1180"><a href="#NiftiViewer-1180"><span class="linenos">1180</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">canceled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_load_canceled</span><span class="p">)</span>
</span><span id="NiftiViewer-1181"><a href="#NiftiViewer-1181"><span class="linenos">1181</span></a>
</span><span id="NiftiViewer-1182"><a href="#NiftiViewer-1182"><span class="linenos">1182</span></a>            <span class="c1"># Save file path to appropriate variable</span>
</span><span id="NiftiViewer-1183"><a href="#NiftiViewer-1183"><span class="linenos">1183</span></a>            <span class="k">if</span> <span class="n">is_overlay</span><span class="p">:</span>
</span><span id="NiftiViewer-1184"><a href="#NiftiViewer-1184"><span class="linenos">1184</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">overlay_file_path</span> <span class="o">=</span> <span class="n">file_path</span>
</span><span id="NiftiViewer-1185"><a href="#NiftiViewer-1185"><span class="linenos">1185</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-1186"><a href="#NiftiViewer-1186"><span class="linenos">1186</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span>
</span><span id="NiftiViewer-1187"><a href="#NiftiViewer-1187"><span class="linenos">1187</span></a>
</span><span id="NiftiViewer-1188"><a href="#NiftiViewer-1188"><span class="linenos">1188</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_file_loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_data</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">affine</span><span class="p">,</span> <span class="n">is_4d</span><span class="p">,</span> <span class="n">is_overlay</span><span class="p">):</span>
</span><span id="NiftiViewer-1189"><a href="#NiftiViewer-1189"><span class="linenos">1189</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1190"><a href="#NiftiViewer-1190"><span class="linenos">1190</span></a><span class="sd">        Handle successful completion of a NIfTI file loading operation.</span>
</span><span id="NiftiViewer-1191"><a href="#NiftiViewer-1191"><span class="linenos">1191</span></a>
</span><span id="NiftiViewer-1192"><a href="#NiftiViewer-1192"><span class="linenos">1192</span></a><span class="sd">        This method is called when the background loading thread finishes without errors.</span>
</span><span id="NiftiViewer-1193"><a href="#NiftiViewer-1193"><span class="linenos">1193</span></a><span class="sd">        It manages both base image and overlay image loading results.</span>
</span><span id="NiftiViewer-1194"><a href="#NiftiViewer-1194"><span class="linenos">1194</span></a>
</span><span id="NiftiViewer-1195"><a href="#NiftiViewer-1195"><span class="linenos">1195</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-1196"><a href="#NiftiViewer-1196"><span class="linenos">1196</span></a><span class="sd">            img_data (numpy.ndarray): Loaded image data array.</span>
</span><span id="NiftiViewer-1197"><a href="#NiftiViewer-1197"><span class="linenos">1197</span></a><span class="sd">            dims (tuple): Dimensions of the loaded image (e.g., (X, Y, Z) or (X, Y, Z, T)).</span>
</span><span id="NiftiViewer-1198"><a href="#NiftiViewer-1198"><span class="linenos">1198</span></a><span class="sd">            affine (numpy.ndarray): Affine transformation matrix defining voxel-to-world mapping.</span>
</span><span id="NiftiViewer-1199"><a href="#NiftiViewer-1199"><span class="linenos">1199</span></a><span class="sd">            is_4d (bool): Whether the loaded image is a 4D time series.</span>
</span><span id="NiftiViewer-1200"><a href="#NiftiViewer-1200"><span class="linenos">1200</span></a><span class="sd">            is_overlay (bool): Whether the loaded file is an overlay rather than a base image.</span>
</span><span id="NiftiViewer-1201"><a href="#NiftiViewer-1201"><span class="linenos">1201</span></a>
</span><span id="NiftiViewer-1202"><a href="#NiftiViewer-1202"><span class="linenos">1202</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer-1203"><a href="#NiftiViewer-1203"><span class="linenos">1203</span></a><span class="sd">            None</span>
</span><span id="NiftiViewer-1204"><a href="#NiftiViewer-1204"><span class="linenos">1204</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1205"><a href="#NiftiViewer-1205"><span class="linenos">1205</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading NIfTI image...&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1206"><a href="#NiftiViewer-1206"><span class="linenos">1206</span></a>        <span class="c1"># Disconnect progress dialog cancel signal and close it</span>
</span><span id="NiftiViewer-1207"><a href="#NiftiViewer-1207"><span class="linenos">1207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">canceled</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</span><span id="NiftiViewer-1208"><a href="#NiftiViewer-1208"><span class="linenos">1208</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="NiftiViewer-1209"><a href="#NiftiViewer-1209"><span class="linenos">1209</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Remove the finished thread&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1210"><a href="#NiftiViewer-1210"><span class="linenos">1210</span></a>        <span class="c1"># Remove the finished thread from active threads list</span>
</span><span id="NiftiViewer-1211"><a href="#NiftiViewer-1211"><span class="linenos">1211</span></a>        <span class="n">thread_to_cancel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span>
</span><span id="NiftiViewer-1212"><a href="#NiftiViewer-1212"><span class="linenos">1212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread_to_cancel</span><span class="p">)</span>
</span><span id="NiftiViewer-1213"><a href="#NiftiViewer-1213"><span class="linenos">1213</span></a>
</span><span id="NiftiViewer-1214"><a href="#NiftiViewer-1214"><span class="linenos">1214</span></a>        <span class="c1"># ---------------------------------------------------</span>
</span><span id="NiftiViewer-1215"><a href="#NiftiViewer-1215"><span class="linenos">1215</span></a>        <span class="c1"># Handle overlay image loading</span>
</span><span id="NiftiViewer-1216"><a href="#NiftiViewer-1216"><span class="linenos">1216</span></a>        <span class="c1"># ---------------------------------------------------</span>
</span><span id="NiftiViewer-1217"><a href="#NiftiViewer-1217"><span class="linenos">1217</span></a>        <span class="k">if</span> <span class="n">is_overlay</span><span class="p">:</span>
</span><span id="NiftiViewer-1218"><a href="#NiftiViewer-1218"><span class="linenos">1218</span></a>            <span class="c1"># Store overlay data and its dimensions</span>
</span><span id="NiftiViewer-1219"><a href="#NiftiViewer-1219"><span class="linenos">1219</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">=</span> <span class="n">img_data</span>
</span><span id="NiftiViewer-1220"><a href="#NiftiViewer-1220"><span class="linenos">1220</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_dims</span> <span class="o">=</span> <span class="n">dims</span>
</span><span id="NiftiViewer-1221"><a href="#NiftiViewer-1221"><span class="linenos">1221</span></a>
</span><span id="NiftiViewer-1222"><a href="#NiftiViewer-1222"><span class="linenos">1222</span></a>            <span class="c1"># Check for dimension mismatch and apply padding if necessary</span>
</span><span id="NiftiViewer-1223"><a href="#NiftiViewer-1223"><span class="linenos">1223</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;dims&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
</span><span id="NiftiViewer-1224"><a href="#NiftiViewer-1224"><span class="linenos">1224</span></a>                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="NiftiViewer-1225"><a href="#NiftiViewer-1225"><span class="linenos">1225</span></a>                    <span class="bp">self</span><span class="p">,</span>
</span><span id="NiftiViewer-1226"><a href="#NiftiViewer-1226"><span class="linenos">1226</span></a>                    <span class="s2">&quot;Dimensions mismatch!&quot;</span><span class="p">,</span>
</span><span id="NiftiViewer-1227"><a href="#NiftiViewer-1227"><span class="linenos">1227</span></a>                    <span class="sa">f</span><span class="s2">&quot;The main image has dimensions </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> and the overlay has dimensions </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="NiftiViewer-1228"><a href="#NiftiViewer-1228"><span class="linenos">1228</span></a>                <span class="p">)</span>
</span><span id="NiftiViewer-1229"><a href="#NiftiViewer-1229"><span class="linenos">1229</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_volume_to_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="NiftiViewer-1230"><a href="#NiftiViewer-1230"><span class="linenos">1230</span></a>
</span><span id="NiftiViewer-1231"><a href="#NiftiViewer-1231"><span class="linenos">1231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="NiftiViewer-1232"><a href="#NiftiViewer-1232"><span class="linenos">1232</span></a>
</span><span id="NiftiViewer-1233"><a href="#NiftiViewer-1233"><span class="linenos">1233</span></a>            <span class="c1"># Update overlay information label</span>
</span><span id="NiftiViewer-1234"><a href="#NiftiViewer-1234"><span class="linenos">1234</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_file_path</span><span class="p">)</span>
</span><span id="NiftiViewer-1235"><a href="#NiftiViewer-1235"><span class="linenos">1235</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
</span><span id="NiftiViewer-1236"><a href="#NiftiViewer-1236"><span class="linenos">1236</span></a>                <span class="sa">f</span><span class="s2">&quot;Overlay: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
</span><span id="NiftiViewer-1237"><a href="#NiftiViewer-1237"><span class="linenos">1237</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span> <span class="o">+</span>
</span><span id="NiftiViewer-1238"><a href="#NiftiViewer-1238"><span class="linenos">1238</span></a>                <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_dims</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="NiftiViewer-1239"><a href="#NiftiViewer-1239"><span class="linenos">1239</span></a>            <span class="p">)</span>
</span><span id="NiftiViewer-1240"><a href="#NiftiViewer-1240"><span class="linenos">1240</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Activate the UI&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1241"><a href="#NiftiViewer-1241"><span class="linenos">1241</span></a>            <span class="c1"># Enable and activate overlay in UI</span>
</span><span id="NiftiViewer-1242"><a href="#NiftiViewer-1242"><span class="linenos">1242</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">toggle_overlay</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-1243"><a href="#NiftiViewer-1243"><span class="linenos">1243</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Update overlay threshold&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1244"><a href="#NiftiViewer-1244"><span class="linenos">1244</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_overlay_threshold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-1245"><a href="#NiftiViewer-1245"><span class="linenos">1245</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Update display settings&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1246"><a href="#NiftiViewer-1246"><span class="linenos">1246</span></a>            <span class="c1"># Refresh display with updated overlay settings</span>
</span><span id="NiftiViewer-1247"><a href="#NiftiViewer-1247"><span class="linenos">1247</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_overlay_settings</span><span class="p">(</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-1248"><a href="#NiftiViewer-1248"><span class="linenos">1248</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Update all displays&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1249"><a href="#NiftiViewer-1249"><span class="linenos">1249</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-1250"><a href="#NiftiViewer-1250"><span class="linenos">1250</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Finished loading NIfTI image, updating checkbox&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1251"><a href="#NiftiViewer-1251"><span class="linenos">1251</span></a>
</span><span id="NiftiViewer-1252"><a href="#NiftiViewer-1252"><span class="linenos">1252</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-1253"><a href="#NiftiViewer-1253"><span class="linenos">1253</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-1254"><a href="#NiftiViewer-1254"><span class="linenos">1254</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating status bar&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1255"><a href="#NiftiViewer-1255"><span class="linenos">1255</span></a>            <span class="c1"># Update status bar message</span>
</span><span id="NiftiViewer-1256"><a href="#NiftiViewer-1256"><span class="linenos">1256</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
</span><span id="NiftiViewer-1257"><a href="#NiftiViewer-1257"><span class="linenos">1257</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay loaded&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="NiftiViewer-1258"><a href="#NiftiViewer-1258"><span class="linenos">1258</span></a>            <span class="p">)</span>
</span><span id="NiftiViewer-1259"><a href="#NiftiViewer-1259"><span class="linenos">1259</span></a>
</span><span id="NiftiViewer-1260"><a href="#NiftiViewer-1260"><span class="linenos">1260</span></a>        <span class="c1"># ---------------------------------------------------</span>
</span><span id="NiftiViewer-1261"><a href="#NiftiViewer-1261"><span class="linenos">1261</span></a>        <span class="c1"># Handle base image loading</span>
</span><span id="NiftiViewer-1262"><a href="#NiftiViewer-1262"><span class="linenos">1262</span></a>        <span class="c1"># ---------------------------------------------------</span>
</span><span id="NiftiViewer-1263"><a href="#NiftiViewer-1263"><span class="linenos">1263</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-1264"><a href="#NiftiViewer-1264"><span class="linenos">1264</span></a>            <span class="c1"># Reset any existing overlay and ROI tools</span>
</span><span id="NiftiViewer-1265"><a href="#NiftiViewer-1265"><span class="linenos">1265</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reset_overlay</span><span class="p">()</span>
</span><span id="NiftiViewer-1266"><a href="#NiftiViewer-1266"><span class="linenos">1266</span></a>
</span><span id="NiftiViewer-1267"><a href="#NiftiViewer-1267"><span class="linenos">1267</span></a>            <span class="c1"># Store loaded base image attributes</span>
</span><span id="NiftiViewer-1268"><a href="#NiftiViewer-1268"><span class="linenos">1268</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span>
</span><span id="NiftiViewer-1269"><a href="#NiftiViewer-1269"><span class="linenos">1269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="n">dims</span>
</span><span id="NiftiViewer-1270"><a href="#NiftiViewer-1270"><span class="linenos">1270</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">affine</span> <span class="o">=</span> <span class="n">affine</span>
</span><span id="NiftiViewer-1271"><a href="#NiftiViewer-1271"><span class="linenos">1271</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="o">=</span> <span class="n">is_4d</span>
</span><span id="NiftiViewer-1272"><a href="#NiftiViewer-1272"><span class="linenos">1272</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">affine</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># Compute voxel size in mm</span>
</span><span id="NiftiViewer-1273"><a href="#NiftiViewer-1273"><span class="linenos">1273</span></a>
</span><span id="NiftiViewer-1274"><a href="#NiftiViewer-1274"><span class="linenos">1274</span></a>            <span class="c1"># Compose file information text</span>
</span><span id="NiftiViewer-1275"><a href="#NiftiViewer-1275"><span class="linenos">1275</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="NiftiViewer-1276"><a href="#NiftiViewer-1276"><span class="linenos">1276</span></a>            <span class="k">if</span> <span class="n">is_4d</span><span class="p">:</span>
</span><span id="NiftiViewer-1277"><a href="#NiftiViewer-1277"><span class="linenos">1277</span></a>                <span class="c1"># 4D image information</span>
</span><span id="NiftiViewer-1278"><a href="#NiftiViewer-1278"><span class="linenos">1278</span></a>                <span class="n">info_text</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;File&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
</span><span id="NiftiViewer-1279"><a href="#NiftiViewer-1279"><span class="linenos">1279</span></a>                            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="NiftiViewer-1280"><a href="#NiftiViewer-1280"><span class="linenos">1280</span></a>                            <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
</span><span id="NiftiViewer-1281"><a href="#NiftiViewer-1281"><span class="linenos">1281</span></a>                            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;4D Time Series&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1282"><a href="#NiftiViewer-1282"><span class="linenos">1282</span></a>
</span><span id="NiftiViewer-1283"><a href="#NiftiViewer-1283"><span class="linenos">1283</span></a>                <span class="c1"># Enable time-series group and plot setup</span>
</span><span id="NiftiViewer-1284"><a href="#NiftiViewer-1284"><span class="linenos">1284</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-1285"><a href="#NiftiViewer-1285"><span class="linenos">1285</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-1286"><a href="#NiftiViewer-1286"><span class="linenos">1286</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-1287"><a href="#NiftiViewer-1287"><span class="linenos">1287</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">setup_time_series_plot</span><span class="p">()</span>
</span><span id="NiftiViewer-1288"><a href="#NiftiViewer-1288"><span class="linenos">1288</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-1289"><a href="#NiftiViewer-1289"><span class="linenos">1289</span></a>                <span class="c1"># 3D volume information</span>
</span><span id="NiftiViewer-1290"><a href="#NiftiViewer-1290"><span class="linenos">1290</span></a>                <span class="n">info_text</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;File&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
</span><span id="NiftiViewer-1291"><a href="#NiftiViewer-1291"><span class="linenos">1291</span></a>                            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="NiftiViewer-1292"><a href="#NiftiViewer-1292"><span class="linenos">1292</span></a>                            <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
</span><span id="NiftiViewer-1293"><a href="#NiftiViewer-1293"><span class="linenos">1293</span></a>                            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;3D Volume&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1294"><a href="#NiftiViewer-1294"><span class="linenos">1294</span></a>
</span><span id="NiftiViewer-1295"><a href="#NiftiViewer-1295"><span class="linenos">1295</span></a>                <span class="c1"># Disable time controls for 3D data</span>
</span><span id="NiftiViewer-1296"><a href="#NiftiViewer-1296"><span class="linenos">1296</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-1297"><a href="#NiftiViewer-1297"><span class="linenos">1297</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-1298"><a href="#NiftiViewer-1298"><span class="linenos">1298</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-1299"><a href="#NiftiViewer-1299"><span class="linenos">1299</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hide_time_series_plot</span><span class="p">()</span>
</span><span id="NiftiViewer-1300"><a href="#NiftiViewer-1300"><span class="linenos">1300</span></a>
</span><span id="NiftiViewer-1301"><a href="#NiftiViewer-1301"><span class="linenos">1301</span></a>            <span class="c1"># Update status bar layout and messages</span>
</span><span id="NiftiViewer-1302"><a href="#NiftiViewer-1302"><span class="linenos">1302</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">clearMessage</span><span class="p">()</span>
</span><span id="NiftiViewer-1303"><a href="#NiftiViewer-1303"><span class="linenos">1303</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span><span class="p">)</span>
</span><span id="NiftiViewer-1304"><a href="#NiftiViewer-1304"><span class="linenos">1304</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">addPermanentWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_info_label</span><span class="p">)</span>
</span><span id="NiftiViewer-1305"><a href="#NiftiViewer-1305"><span class="linenos">1305</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">addPermanentWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value_label</span><span class="p">)</span>
</span><span id="NiftiViewer-1306"><a href="#NiftiViewer-1306"><span class="linenos">1306</span></a>
</span><span id="NiftiViewer-1307"><a href="#NiftiViewer-1307"><span class="linenos">1307</span></a>            <span class="c1"># Enable ROI controls</span>
</span><span id="NiftiViewer-1308"><a href="#NiftiViewer-1308"><span class="linenos">1308</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-1309"><a href="#NiftiViewer-1309"><span class="linenos">1309</span></a>
</span><span id="NiftiViewer-1310"><a href="#NiftiViewer-1310"><span class="linenos">1310</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic ROI&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-1311"><a href="#NiftiViewer-1311"><span class="linenos">1311</span></a>
</span><span id="NiftiViewer-1312"><a href="#NiftiViewer-1312"><span class="linenos">1312</span></a>            <span class="c1"># Update information panel</span>
</span><span id="NiftiViewer-1313"><a href="#NiftiViewer-1313"><span class="linenos">1313</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">info_text</span><span class="p">)</span>
</span><span id="NiftiViewer-1314"><a href="#NiftiViewer-1314"><span class="linenos">1314</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">info_text</span><span class="p">)</span>
</span><span id="NiftiViewer-1315"><a href="#NiftiViewer-1315"><span class="linenos">1315</span></a>
</span><span id="NiftiViewer-1316"><a href="#NiftiViewer-1316"><span class="linenos">1316</span></a>            <span class="c1"># Initialize visual display of loaded data</span>
</span><span id="NiftiViewer-1317"><a href="#NiftiViewer-1317"><span class="linenos">1317</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_display</span><span class="p">()</span>
</span><span id="NiftiViewer-1318"><a href="#NiftiViewer-1318"><span class="linenos">1318</span></a>
</span><span id="NiftiViewer-1319"><a href="#NiftiViewer-1319"><span class="linenos">1319</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">resetROI</span><span class="p">()</span>
</span><span id="NiftiViewer-1320"><a href="#NiftiViewer-1320"><span class="linenos">1320</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reset_overlay</span><span class="p">()</span>
</span><span id="NiftiViewer-1321"><a href="#NiftiViewer-1321"><span class="linenos">1321</span></a>
</span><span id="NiftiViewer-1322"><a href="#NiftiViewer-1322"><span class="linenos">1322</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_load_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_message</span><span class="p">):</span>
</span><span id="NiftiViewer-1323"><a href="#NiftiViewer-1323"><span class="linenos">1323</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1324"><a href="#NiftiViewer-1324"><span class="linenos">1324</span></a><span class="sd">        Handle errors during NIfTI file loading.</span>
</span><span id="NiftiViewer-1325"><a href="#NiftiViewer-1325"><span class="linenos">1325</span></a>
</span><span id="NiftiViewer-1326"><a href="#NiftiViewer-1326"><span class="linenos">1326</span></a><span class="sd">        Displays an error message, logs the issue, and cleans up any pending thread.</span>
</span><span id="NiftiViewer-1327"><a href="#NiftiViewer-1327"><span class="linenos">1327</span></a>
</span><span id="NiftiViewer-1328"><a href="#NiftiViewer-1328"><span class="linenos">1328</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-1329"><a href="#NiftiViewer-1329"><span class="linenos">1329</span></a><span class="sd">            error_message (str): Error message returned by the worker thread.</span>
</span><span id="NiftiViewer-1330"><a href="#NiftiViewer-1330"><span class="linenos">1330</span></a>
</span><span id="NiftiViewer-1331"><a href="#NiftiViewer-1331"><span class="linenos">1331</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer-1332"><a href="#NiftiViewer-1332"><span class="linenos">1332</span></a><span class="sd">            None</span>
</span><span id="NiftiViewer-1333"><a href="#NiftiViewer-1333"><span class="linenos">1333</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1334"><a href="#NiftiViewer-1334"><span class="linenos">1334</span></a>        <span class="c1"># Disconnect cancel signal and close progress dialog</span>
</span><span id="NiftiViewer-1335"><a href="#NiftiViewer-1335"><span class="linenos">1335</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">canceled</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</span><span id="NiftiViewer-1336"><a href="#NiftiViewer-1336"><span class="linenos">1336</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="NiftiViewer-1337"><a href="#NiftiViewer-1337"><span class="linenos">1337</span></a>
</span><span id="NiftiViewer-1338"><a href="#NiftiViewer-1338"><span class="linenos">1338</span></a>        <span class="c1"># Display critical error dialog</span>
</span><span id="NiftiViewer-1339"><a href="#NiftiViewer-1339"><span class="linenos">1339</span></a>        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
</span><span id="NiftiViewer-1340"><a href="#NiftiViewer-1340"><span class="linenos">1340</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="NiftiViewer-1341"><a href="#NiftiViewer-1341"><span class="linenos">1341</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Error Loading File&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer-1342"><a href="#NiftiViewer-1342"><span class="linenos">1342</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Failed to load NIfTI file&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="se">\n</span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="NiftiViewer-1343"><a href="#NiftiViewer-1343"><span class="linenos">1343</span></a>        <span class="p">)</span>
</span><span id="NiftiViewer-1344"><a href="#NiftiViewer-1344"><span class="linenos">1344</span></a>
</span><span id="NiftiViewer-1345"><a href="#NiftiViewer-1345"><span class="linenos">1345</span></a>        <span class="c1"># Log the critical error message</span>
</span><span id="NiftiViewer-1346"><a href="#NiftiViewer-1346"><span class="linenos">1346</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading NIfTI file: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1347"><a href="#NiftiViewer-1347"><span class="linenos">1347</span></a>
</span><span id="NiftiViewer-1348"><a href="#NiftiViewer-1348"><span class="linenos">1348</span></a>        <span class="c1"># Remove failed thread from thread list</span>
</span><span id="NiftiViewer-1349"><a href="#NiftiViewer-1349"><span class="linenos">1349</span></a>        <span class="n">thread_to_cancel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span>
</span><span id="NiftiViewer-1350"><a href="#NiftiViewer-1350"><span class="linenos">1350</span></a>        <span class="k">if</span> <span class="n">thread_to_cancel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
</span><span id="NiftiViewer-1351"><a href="#NiftiViewer-1351"><span class="linenos">1351</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread_to_cancel</span><span class="p">)</span>
</span><span id="NiftiViewer-1352"><a href="#NiftiViewer-1352"><span class="linenos">1352</span></a>
</span><span id="NiftiViewer-1353"><a href="#NiftiViewer-1353"><span class="linenos">1353</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_load_canceled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-1354"><a href="#NiftiViewer-1354"><span class="linenos">1354</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1355"><a href="#NiftiViewer-1355"><span class="linenos">1355</span></a><span class="sd">        Handle manual cancellation of the NIfTI file loading process.</span>
</span><span id="NiftiViewer-1356"><a href="#NiftiViewer-1356"><span class="linenos">1356</span></a>
</span><span id="NiftiViewer-1357"><a href="#NiftiViewer-1357"><span class="linenos">1357</span></a><span class="sd">        Terminates the most recent loading thread and removes it from</span>
</span><span id="NiftiViewer-1358"><a href="#NiftiViewer-1358"><span class="linenos">1358</span></a><span class="sd">        the active thread list to prevent resource leakage.</span>
</span><span id="NiftiViewer-1359"><a href="#NiftiViewer-1359"><span class="linenos">1359</span></a>
</span><span id="NiftiViewer-1360"><a href="#NiftiViewer-1360"><span class="linenos">1360</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer-1361"><a href="#NiftiViewer-1361"><span class="linenos">1361</span></a><span class="sd">            None</span>
</span><span id="NiftiViewer-1362"><a href="#NiftiViewer-1362"><span class="linenos">1362</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1363"><a href="#NiftiViewer-1363"><span class="linenos">1363</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="NiftiViewer-1364"><a href="#NiftiViewer-1364"><span class="linenos">1364</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="NiftiViewer-1365"><a href="#NiftiViewer-1365"><span class="linenos">1365</span></a>
</span><span id="NiftiViewer-1366"><a href="#NiftiViewer-1366"><span class="linenos">1366</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-1367"><a href="#NiftiViewer-1367"><span class="linenos">1367</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1368"><a href="#NiftiViewer-1368"><span class="linenos">1368</span></a><span class="sd">        Initialize and configure the viewer display after a NIfTI file is loaded.</span>
</span><span id="NiftiViewer-1369"><a href="#NiftiViewer-1369"><span class="linenos">1369</span></a>
</span><span id="NiftiViewer-1370"><a href="#NiftiViewer-1370"><span class="linenos">1370</span></a><span class="sd">        Sets up slice navigation controls, initializes time-series sliders for 4D data,</span>
</span><span id="NiftiViewer-1371"><a href="#NiftiViewer-1371"><span class="linenos">1371</span></a><span class="sd">        updates current coordinates, and enables overlay controls.</span>
</span><span id="NiftiViewer-1372"><a href="#NiftiViewer-1372"><span class="linenos">1372</span></a>
</span><span id="NiftiViewer-1373"><a href="#NiftiViewer-1373"><span class="linenos">1373</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer-1374"><a href="#NiftiViewer-1374"><span class="linenos">1374</span></a><span class="sd">            None</span>
</span><span id="NiftiViewer-1375"><a href="#NiftiViewer-1375"><span class="linenos">1375</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1376"><a href="#NiftiViewer-1376"><span class="linenos">1376</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1377"><a href="#NiftiViewer-1377"><span class="linenos">1377</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer-1378"><a href="#NiftiViewer-1378"><span class="linenos">1378</span></a>
</span><span id="NiftiViewer-1379"><a href="#NiftiViewer-1379"><span class="linenos">1379</span></a>        <span class="c1"># Determine spatial dimension order (reverse for display consistency)</span>
</span><span id="NiftiViewer-1380"><a href="#NiftiViewer-1380"><span class="linenos">1380</span></a>        <span class="n">spatial_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="NiftiViewer-1381"><a href="#NiftiViewer-1381"><span class="linenos">1381</span></a>
</span><span id="NiftiViewer-1382"><a href="#NiftiViewer-1382"><span class="linenos">1382</span></a>        <span class="c1"># Configure slice sliders and spin boxes</span>
</span><span id="NiftiViewer-1383"><a href="#NiftiViewer-1383"><span class="linenos">1383</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="NiftiViewer-1384"><a href="#NiftiViewer-1384"><span class="linenos">1384</span></a>            <span class="n">max_slice</span> <span class="o">=</span> <span class="n">spatial_dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="NiftiViewer-1385"><a href="#NiftiViewer-1385"><span class="linenos">1385</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">max_slice</span><span class="p">)</span>
</span><span id="NiftiViewer-1386"><a href="#NiftiViewer-1386"><span class="linenos">1386</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">max_slice</span><span class="p">)</span>
</span><span id="NiftiViewer-1387"><a href="#NiftiViewer-1387"><span class="linenos">1387</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_slice</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># Start in the middle slice</span>
</span><span id="NiftiViewer-1388"><a href="#NiftiViewer-1388"><span class="linenos">1388</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="NiftiViewer-1389"><a href="#NiftiViewer-1389"><span class="linenos">1389</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="NiftiViewer-1390"><a href="#NiftiViewer-1390"><span class="linenos">1390</span></a>
</span><span id="NiftiViewer-1391"><a href="#NiftiViewer-1391"><span class="linenos">1391</span></a>        <span class="c1"># Configure time slider and spinbox for 4D datasets</span>
</span><span id="NiftiViewer-1392"><a href="#NiftiViewer-1392"><span class="linenos">1392</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="NiftiViewer-1393"><a href="#NiftiViewer-1393"><span class="linenos">1393</span></a>            <span class="n">max_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="NiftiViewer-1394"><a href="#NiftiViewer-1394"><span class="linenos">1394</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">max_time</span><span class="p">)</span>
</span><span id="NiftiViewer-1395"><a href="#NiftiViewer-1395"><span class="linenos">1395</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">max_time</span><span class="p">)</span>
</span><span id="NiftiViewer-1396"><a href="#NiftiViewer-1396"><span class="linenos">1396</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="NiftiViewer-1397"><a href="#NiftiViewer-1397"><span class="linenos">1397</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-1398"><a href="#NiftiViewer-1398"><span class="linenos">1398</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-1399"><a href="#NiftiViewer-1399"><span class="linenos">1399</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">toggle_time_controls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span>
</span><span id="NiftiViewer-1400"><a href="#NiftiViewer-1400"><span class="linenos">1400</span></a>
</span><span id="NiftiViewer-1401"><a href="#NiftiViewer-1401"><span class="linenos">1401</span></a>        <span class="c1"># Initialize coordinate tracking</span>
</span><span id="NiftiViewer-1402"><a href="#NiftiViewer-1402"><span class="linenos">1402</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="NiftiViewer-1403"><a href="#NiftiViewer-1403"><span class="linenos">1403</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>  <span class="c1"># X coordinate</span>
</span><span id="NiftiViewer-1404"><a href="#NiftiViewer-1404"><span class="linenos">1404</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># Y coordinate</span>
</span><span id="NiftiViewer-1405"><a href="#NiftiViewer-1405"><span class="linenos">1405</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Z coordinate</span>
</span><span id="NiftiViewer-1406"><a href="#NiftiViewer-1406"><span class="linenos">1406</span></a>        <span class="p">]</span>
</span><span id="NiftiViewer-1407"><a href="#NiftiViewer-1407"><span class="linenos">1407</span></a>
</span><span id="NiftiViewer-1408"><a href="#NiftiViewer-1408"><span class="linenos">1408</span></a>        <span class="c1"># Update all displays and coordinate readouts</span>
</span><span id="NiftiViewer-1409"><a href="#NiftiViewer-1409"><span class="linenos">1409</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-1410"><a href="#NiftiViewer-1410"><span class="linenos">1410</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_coordinate_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-1411"><a href="#NiftiViewer-1411"><span class="linenos">1411</span></a>
</span><span id="NiftiViewer-1412"><a href="#NiftiViewer-1412"><span class="linenos">1412</span></a>        <span class="c1"># Enable overlay loading button after successful image load</span>
</span><span id="NiftiViewer-1413"><a href="#NiftiViewer-1413"><span class="linenos">1413</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-1414"><a href="#NiftiViewer-1414"><span class="linenos">1414</span></a>
</span><span id="NiftiViewer-1415"><a href="#NiftiViewer-1415"><span class="linenos">1415</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_overlay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="NiftiViewer-1416"><a href="#NiftiViewer-1416"><span class="linenos">1416</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1417"><a href="#NiftiViewer-1417"><span class="linenos">1417</span></a><span class="sd">        Enable or disable the overlay display on top of the base image.</span>
</span><span id="NiftiViewer-1418"><a href="#NiftiViewer-1418"><span class="linenos">1418</span></a>
</span><span id="NiftiViewer-1419"><a href="#NiftiViewer-1419"><span class="linenos">1419</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-1420"><a href="#NiftiViewer-1420"><span class="linenos">1420</span></a><span class="sd">            enabled (bool): Whether to enable (True) or disable (False) the overlay display.</span>
</span><span id="NiftiViewer-1421"><a href="#NiftiViewer-1421"><span class="linenos">1421</span></a>
</span><span id="NiftiViewer-1422"><a href="#NiftiViewer-1422"><span class="linenos">1422</span></a><span class="sd">        Behavior:</span>
</span><span id="NiftiViewer-1423"><a href="#NiftiViewer-1423"><span class="linenos">1423</span></a><span class="sd">            - Toggles transparency and threshold controls.</span>
</span><span id="NiftiViewer-1424"><a href="#NiftiViewer-1424"><span class="linenos">1424</span></a><span class="sd">            - Refreshes all active views if overlay data exists.</span>
</span><span id="NiftiViewer-1425"><a href="#NiftiViewer-1425"><span class="linenos">1425</span></a>
</span><span id="NiftiViewer-1426"><a href="#NiftiViewer-1426"><span class="linenos">1426</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer-1427"><a href="#NiftiViewer-1427"><span class="linenos">1427</span></a><span class="sd">            None</span>
</span><span id="NiftiViewer-1428"><a href="#NiftiViewer-1428"><span class="linenos">1428</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1429"><a href="#NiftiViewer-1429"><span class="linenos">1429</span></a>        <span class="c1"># Update internal overlay state</span>
</span><span id="NiftiViewer-1430"><a href="#NiftiViewer-1430"><span class="linenos">1430</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="o">=</span> <span class="n">enabled</span>
</span><span id="NiftiViewer-1431"><a href="#NiftiViewer-1431"><span class="linenos">1431</span></a>
</span><span id="NiftiViewer-1432"><a href="#NiftiViewer-1432"><span class="linenos">1432</span></a>        <span class="c1"># Enable or disable overlay-related UI controls</span>
</span><span id="NiftiViewer-1433"><a href="#NiftiViewer-1433"><span class="linenos">1433</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-1434"><a href="#NiftiViewer-1434"><span class="linenos">1434</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-1435"><a href="#NiftiViewer-1435"><span class="linenos">1435</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-1436"><a href="#NiftiViewer-1436"><span class="linenos">1436</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-1437"><a href="#NiftiViewer-1437"><span class="linenos">1437</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-1438"><a href="#NiftiViewer-1438"><span class="linenos">1438</span></a>
</span><span id="NiftiViewer-1439"><a href="#NiftiViewer-1439"><span class="linenos">1439</span></a>
</span><span id="NiftiViewer-1440"><a href="#NiftiViewer-1440"><span class="linenos">1440</span></a>        <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="NiftiViewer-1441"><a href="#NiftiViewer-1441"><span class="linenos">1441</span></a>            <span class="c1"># Redraw display if overlay data is available</span>
</span><span id="NiftiViewer-1442"><a href="#NiftiViewer-1442"><span class="linenos">1442</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Update all display.&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1443"><a href="#NiftiViewer-1443"><span class="linenos">1443</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-1444"><a href="#NiftiViewer-1444"><span class="linenos">1444</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Update time series plot&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1445"><a href="#NiftiViewer-1445"><span class="linenos">1445</span></a>            <span class="c1"># Update time series plot if available</span>
</span><span id="NiftiViewer-1446"><a href="#NiftiViewer-1446"><span class="linenos">1446</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_time_series_plot</span><span class="p">()</span>
</span><span id="NiftiViewer-1447"><a href="#NiftiViewer-1447"><span class="linenos">1447</span></a>
</span><span id="NiftiViewer-1448"><a href="#NiftiViewer-1448"><span class="linenos">1448</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_overlay_alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="NiftiViewer-1449"><a href="#NiftiViewer-1449"><span class="linenos">1449</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1450"><a href="#NiftiViewer-1450"><span class="linenos">1450</span></a><span class="sd">        Update overlay transparency (alpha blending).</span>
</span><span id="NiftiViewer-1451"><a href="#NiftiViewer-1451"><span class="linenos">1451</span></a>
</span><span id="NiftiViewer-1452"><a href="#NiftiViewer-1452"><span class="linenos">1452</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-1453"><a href="#NiftiViewer-1453"><span class="linenos">1453</span></a><span class="sd">            value (int): Slider value representing overlay opacity (0100).</span>
</span><span id="NiftiViewer-1454"><a href="#NiftiViewer-1454"><span class="linenos">1454</span></a>
</span><span id="NiftiViewer-1455"><a href="#NiftiViewer-1455"><span class="linenos">1455</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer-1456"><a href="#NiftiViewer-1456"><span class="linenos">1456</span></a><span class="sd">            Converts the integer slider value to a float ratio (0.01.0) and</span>
</span><span id="NiftiViewer-1457"><a href="#NiftiViewer-1457"><span class="linenos">1457</span></a><span class="sd">            refreshes the display only if the overlay is active and data is loaded.</span>
</span><span id="NiftiViewer-1458"><a href="#NiftiViewer-1458"><span class="linenos">1458</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1459"><a href="#NiftiViewer-1459"><span class="linenos">1459</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="NiftiViewer-1460"><a href="#NiftiViewer-1460"><span class="linenos">1460</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="NiftiViewer-1461"><a href="#NiftiViewer-1461"><span class="linenos">1461</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-1462"><a href="#NiftiViewer-1462"><span class="linenos">1462</span></a>
</span><span id="NiftiViewer-1463"><a href="#NiftiViewer-1463"><span class="linenos">1463</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_overlay_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="NiftiViewer-1464"><a href="#NiftiViewer-1464"><span class="linenos">1464</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1465"><a href="#NiftiViewer-1465"><span class="linenos">1465</span></a><span class="sd">        Update overlay intensity threshold.</span>
</span><span id="NiftiViewer-1466"><a href="#NiftiViewer-1466"><span class="linenos">1466</span></a>
</span><span id="NiftiViewer-1467"><a href="#NiftiViewer-1467"><span class="linenos">1467</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-1468"><a href="#NiftiViewer-1468"><span class="linenos">1468</span></a><span class="sd">            value (int): Slider value representing overlay threshold (0100).</span>
</span><span id="NiftiViewer-1469"><a href="#NiftiViewer-1469"><span class="linenos">1469</span></a>
</span><span id="NiftiViewer-1470"><a href="#NiftiViewer-1470"><span class="linenos">1470</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer-1471"><a href="#NiftiViewer-1471"><span class="linenos">1471</span></a><span class="sd">            Adjusts visibility cutoff for overlay voxels and refreshes display</span>
</span><span id="NiftiViewer-1472"><a href="#NiftiViewer-1472"><span class="linenos">1472</span></a><span class="sd">            when overlay is active and data is present.</span>
</span><span id="NiftiViewer-1473"><a href="#NiftiViewer-1473"><span class="linenos">1473</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1474"><a href="#NiftiViewer-1474"><span class="linenos">1474</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="NiftiViewer-1475"><a href="#NiftiViewer-1475"><span class="linenos">1475</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1476"><a href="#NiftiViewer-1476"><span class="linenos">1476</span></a>            <span class="c1"># Determine overlay threshold</span>
</span><span id="NiftiViewer-1477"><a href="#NiftiViewer-1477"><span class="linenos">1477</span></a>            <span class="n">threshold_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_max</span>
</span><span id="NiftiViewer-1478"><a href="#NiftiViewer-1478"><span class="linenos">1478</span></a>            <span class="c1"># Create boolean mask of overlay pixels above threshold</span>
</span><span id="NiftiViewer-1479"><a href="#NiftiViewer-1479"><span class="linenos">1479</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">&gt;</span> <span class="n">threshold_value</span>
</span><span id="NiftiViewer-1480"><a href="#NiftiViewer-1480"><span class="linenos">1480</span></a>            <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="NiftiViewer-1481"><a href="#NiftiViewer-1481"><span class="linenos">1481</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-1482"><a href="#NiftiViewer-1482"><span class="linenos">1482</span></a>
</span><span id="NiftiViewer-1483"><a href="#NiftiViewer-1483"><span class="linenos">1483</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_overlay_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="NiftiViewer-1484"><a href="#NiftiViewer-1484"><span class="linenos">1484</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1485"><a href="#NiftiViewer-1485"><span class="linenos">1485</span></a><span class="sd">        Synchronize overlay alpha and threshold values from the UI controls.</span>
</span><span id="NiftiViewer-1486"><a href="#NiftiViewer-1486"><span class="linenos">1486</span></a>
</span><span id="NiftiViewer-1487"><a href="#NiftiViewer-1487"><span class="linenos">1487</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer-1488"><a href="#NiftiViewer-1488"><span class="linenos">1488</span></a><span class="sd">            Reads the slider positions for alpha and threshold,</span>
</span><span id="NiftiViewer-1489"><a href="#NiftiViewer-1489"><span class="linenos">1489</span></a><span class="sd">            updates their internal numeric equivalents, and refreshes</span>
</span><span id="NiftiViewer-1490"><a href="#NiftiViewer-1490"><span class="linenos">1490</span></a><span class="sd">            the image view if the overlay is active.</span>
</span><span id="NiftiViewer-1491"><a href="#NiftiViewer-1491"><span class="linenos">1491</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1492"><a href="#NiftiViewer-1492"><span class="linenos">1492</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;overlay_alpha_slider&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;overlay_threshold_slider&#39;</span><span class="p">):</span>
</span><span id="NiftiViewer-1493"><a href="#NiftiViewer-1493"><span class="linenos">1493</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="NiftiViewer-1494"><a href="#NiftiViewer-1494"><span class="linenos">1494</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="NiftiViewer-1495"><a href="#NiftiViewer-1495"><span class="linenos">1495</span></a>
</span><span id="NiftiViewer-1496"><a href="#NiftiViewer-1496"><span class="linenos">1496</span></a>            <span class="c1"># Update visualization only if overlay is active and available</span>
</span><span id="NiftiViewer-1497"><a href="#NiftiViewer-1497"><span class="linenos">1497</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;overlay_data&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="NiftiViewer-1498"><a href="#NiftiViewer-1498"><span class="linenos">1498</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-1499"><a href="#NiftiViewer-1499"><span class="linenos">1499</span></a>
</span><span id="NiftiViewer-1500"><a href="#NiftiViewer-1500"><span class="linenos">1500</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">slice_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="NiftiViewer-1501"><a href="#NiftiViewer-1501"><span class="linenos">1501</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1502"><a href="#NiftiViewer-1502"><span class="linenos">1502</span></a><span class="sd">        Handle slice navigation events from sliders or spinboxes.</span>
</span><span id="NiftiViewer-1503"><a href="#NiftiViewer-1503"><span class="linenos">1503</span></a>
</span><span id="NiftiViewer-1504"><a href="#NiftiViewer-1504"><span class="linenos">1504</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-1505"><a href="#NiftiViewer-1505"><span class="linenos">1505</span></a><span class="sd">            plane_idx (int): Index of the anatomical plane (0=axial, 1=coronal, 2=sagittal).</span>
</span><span id="NiftiViewer-1506"><a href="#NiftiViewer-1506"><span class="linenos">1506</span></a><span class="sd">            value (int): New slice index within the volume.</span>
</span><span id="NiftiViewer-1507"><a href="#NiftiViewer-1507"><span class="linenos">1507</span></a>
</span><span id="NiftiViewer-1508"><a href="#NiftiViewer-1508"><span class="linenos">1508</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer-1509"><a href="#NiftiViewer-1509"><span class="linenos">1509</span></a><span class="sd">            Updates the current slice, synchronizes the corresponding slider and spinbox,</span>
</span><span id="NiftiViewer-1510"><a href="#NiftiViewer-1510"><span class="linenos">1510</span></a><span class="sd">            recalculates coordinates, and refreshes the associated 2D view.</span>
</span><span id="NiftiViewer-1511"><a href="#NiftiViewer-1511"><span class="linenos">1511</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1512"><a href="#NiftiViewer-1512"><span class="linenos">1512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="NiftiViewer-1513"><a href="#NiftiViewer-1513"><span class="linenos">1513</span></a>
</span><span id="NiftiViewer-1514"><a href="#NiftiViewer-1514"><span class="linenos">1514</span></a>        <span class="c1"># Keep slider and spinbox synchronized</span>
</span><span id="NiftiViewer-1515"><a href="#NiftiViewer-1515"><span class="linenos">1515</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer-1516"><a href="#NiftiViewer-1516"><span class="linenos">1516</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer-1517"><a href="#NiftiViewer-1517"><span class="linenos">1517</span></a>
</span><span id="NiftiViewer-1518"><a href="#NiftiViewer-1518"><span class="linenos">1518</span></a>        <span class="c1"># Update coordinate system based on selected plane</span>
</span><span id="NiftiViewer-1519"><a href="#NiftiViewer-1519"><span class="linenos">1519</span></a>        <span class="k">if</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Axial</span>
</span><span id="NiftiViewer-1520"><a href="#NiftiViewer-1520"><span class="linenos">1520</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="NiftiViewer-1521"><a href="#NiftiViewer-1521"><span class="linenos">1521</span></a>        <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Coronal</span>
</span><span id="NiftiViewer-1522"><a href="#NiftiViewer-1522"><span class="linenos">1522</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="NiftiViewer-1523"><a href="#NiftiViewer-1523"><span class="linenos">1523</span></a>        <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sagittal</span>
</span><span id="NiftiViewer-1524"><a href="#NiftiViewer-1524"><span class="linenos">1524</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="NiftiViewer-1525"><a href="#NiftiViewer-1525"><span class="linenos">1525</span></a>
</span><span id="NiftiViewer-1526"><a href="#NiftiViewer-1526"><span class="linenos">1526</span></a>        <span class="c1"># Refresh the corresponding view and UI indicators</span>
</span><span id="NiftiViewer-1527"><a href="#NiftiViewer-1527"><span class="linenos">1527</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_display</span><span class="p">(</span><span class="n">plane_idx</span><span class="p">)</span>
</span><span id="NiftiViewer-1528"><a href="#NiftiViewer-1528"><span class="linenos">1528</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_coordinate_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-1529"><a href="#NiftiViewer-1529"><span class="linenos">1529</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_cross_view_lines</span><span class="p">()</span>
</span><span id="NiftiViewer-1530"><a href="#NiftiViewer-1530"><span class="linenos">1530</span></a>
</span><span id="NiftiViewer-1531"><a href="#NiftiViewer-1531"><span class="linenos">1531</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">time_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="NiftiViewer-1532"><a href="#NiftiViewer-1532"><span class="linenos">1532</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1533"><a href="#NiftiViewer-1533"><span class="linenos">1533</span></a><span class="sd">        Handle time slider or spinbox change for 4D data.</span>
</span><span id="NiftiViewer-1534"><a href="#NiftiViewer-1534"><span class="linenos">1534</span></a>
</span><span id="NiftiViewer-1535"><a href="#NiftiViewer-1535"><span class="linenos">1535</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-1536"><a href="#NiftiViewer-1536"><span class="linenos">1536</span></a><span class="sd">            value (int): New time index.</span>
</span><span id="NiftiViewer-1537"><a href="#NiftiViewer-1537"><span class="linenos">1537</span></a>
</span><span id="NiftiViewer-1538"><a href="#NiftiViewer-1538"><span class="linenos">1538</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer-1539"><a href="#NiftiViewer-1539"><span class="linenos">1539</span></a><span class="sd">            Updates the current time frame and refreshes all views.</span>
</span><span id="NiftiViewer-1540"><a href="#NiftiViewer-1540"><span class="linenos">1540</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1541"><a href="#NiftiViewer-1541"><span class="linenos">1541</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="NiftiViewer-1542"><a href="#NiftiViewer-1542"><span class="linenos">1542</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer-1543"><a href="#NiftiViewer-1543"><span class="linenos">1543</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer-1544"><a href="#NiftiViewer-1544"><span class="linenos">1544</span></a>        <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="NiftiViewer-1545"><a href="#NiftiViewer-1545"><span class="linenos">1545</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-1546"><a href="#NiftiViewer-1546"><span class="linenos">1546</span></a>
</span><span id="NiftiViewer-1547"><a href="#NiftiViewer-1547"><span class="linenos">1547</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_time_controls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">):</span>
</span><span id="NiftiViewer-1548"><a href="#NiftiViewer-1548"><span class="linenos">1548</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1549"><a href="#NiftiViewer-1549"><span class="linenos">1549</span></a><span class="sd">        Enable or disable time navigation controls based on data dimensionality.</span>
</span><span id="NiftiViewer-1550"><a href="#NiftiViewer-1550"><span class="linenos">1550</span></a>
</span><span id="NiftiViewer-1551"><a href="#NiftiViewer-1551"><span class="linenos">1551</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-1552"><a href="#NiftiViewer-1552"><span class="linenos">1552</span></a><span class="sd">            enabled (bool): Whether to show and enable time controls.</span>
</span><span id="NiftiViewer-1553"><a href="#NiftiViewer-1553"><span class="linenos">1553</span></a>
</span><span id="NiftiViewer-1554"><a href="#NiftiViewer-1554"><span class="linenos">1554</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer-1555"><a href="#NiftiViewer-1555"><span class="linenos">1555</span></a><span class="sd">            Time controls are visible only when both 4D data is loaded and</span>
</span><span id="NiftiViewer-1556"><a href="#NiftiViewer-1556"><span class="linenos">1556</span></a><span class="sd">            the toggle checkbox is active.</span>
</span><span id="NiftiViewer-1557"><a href="#NiftiViewer-1557"><span class="linenos">1557</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1558"><a href="#NiftiViewer-1558"><span class="linenos">1558</span></a>        <span class="n">value</span> <span class="o">=</span> <span class="n">enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span>
</span><span id="NiftiViewer-1559"><a href="#NiftiViewer-1559"><span class="linenos">1559</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer-1560"><a href="#NiftiViewer-1560"><span class="linenos">1560</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer-1561"><a href="#NiftiViewer-1561"><span class="linenos">1561</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer-1562"><a href="#NiftiViewer-1562"><span class="linenos">1562</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer-1563"><a href="#NiftiViewer-1563"><span class="linenos">1563</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer-1564"><a href="#NiftiViewer-1564"><span class="linenos">1564</span></a>
</span><span id="NiftiViewer-1565"><a href="#NiftiViewer-1565"><span class="linenos">1565</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">colormap_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colormap_name</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="NiftiViewer-1566"><a href="#NiftiViewer-1566"><span class="linenos">1566</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1567"><a href="#NiftiViewer-1567"><span class="linenos">1567</span></a><span class="sd">        Handle colormap selection change from the dropdown.</span>
</span><span id="NiftiViewer-1568"><a href="#NiftiViewer-1568"><span class="linenos">1568</span></a>
</span><span id="NiftiViewer-1569"><a href="#NiftiViewer-1569"><span class="linenos">1569</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-1570"><a href="#NiftiViewer-1570"><span class="linenos">1570</span></a><span class="sd">            colormap_name (str): Name of the selected colormap.</span>
</span><span id="NiftiViewer-1571"><a href="#NiftiViewer-1571"><span class="linenos">1571</span></a>
</span><span id="NiftiViewer-1572"><a href="#NiftiViewer-1572"><span class="linenos">1572</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer-1573"><a href="#NiftiViewer-1573"><span class="linenos">1573</span></a><span class="sd">            Updates the active colormap for display and refreshes all views.</span>
</span><span id="NiftiViewer-1574"><a href="#NiftiViewer-1574"><span class="linenos">1574</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1575"><a href="#NiftiViewer-1575"><span class="linenos">1575</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span> <span class="o">=</span> <span class="n">colormap_name</span>
</span><span id="NiftiViewer-1576"><a href="#NiftiViewer-1576"><span class="linenos">1576</span></a>        <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="NiftiViewer-1577"><a href="#NiftiViewer-1577"><span class="linenos">1577</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-1578"><a href="#NiftiViewer-1578"><span class="linenos">1578</span></a>
</span><span id="NiftiViewer-1579"><a href="#NiftiViewer-1579"><span class="linenos">1579</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_click_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="NiftiViewer-1580"><a href="#NiftiViewer-1580"><span class="linenos">1580</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1581"><a href="#NiftiViewer-1581"><span class="linenos">1581</span></a><span class="sd">        Handle user mouse clicks within a 2D slice view.</span>
</span><span id="NiftiViewer-1582"><a href="#NiftiViewer-1582"><span class="linenos">1582</span></a>
</span><span id="NiftiViewer-1583"><a href="#NiftiViewer-1583"><span class="linenos">1583</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-1584"><a href="#NiftiViewer-1584"><span class="linenos">1584</span></a><span class="sd">            view_idx (int): Index of the view where the click occurred (0=axial, 1=coronal, 2=sagittal).</span>
</span><span id="NiftiViewer-1585"><a href="#NiftiViewer-1585"><span class="linenos">1585</span></a><span class="sd">            x (float): X coordinate in screen space.</span>
</span><span id="NiftiViewer-1586"><a href="#NiftiViewer-1586"><span class="linenos">1586</span></a><span class="sd">            y (float): Y coordinate in screen space.</span>
</span><span id="NiftiViewer-1587"><a href="#NiftiViewer-1587"><span class="linenos">1587</span></a>
</span><span id="NiftiViewer-1588"><a href="#NiftiViewer-1588"><span class="linenos">1588</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer-1589"><a href="#NiftiViewer-1589"><span class="linenos">1589</span></a><span class="sd">            Converts screen coordinates to image voxel coordinates,</span>
</span><span id="NiftiViewer-1590"><a href="#NiftiViewer-1590"><span class="linenos">1590</span></a><span class="sd">            updates slice positions accordingly, and synchronizes all views.</span>
</span><span id="NiftiViewer-1591"><a href="#NiftiViewer-1591"><span class="linenos">1591</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1592"><a href="#NiftiViewer-1592"><span class="linenos">1592</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1593"><a href="#NiftiViewer-1593"><span class="linenos">1593</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer-1594"><a href="#NiftiViewer-1594"><span class="linenos">1594</span></a>
</span><span id="NiftiViewer-1595"><a href="#NiftiViewer-1595"><span class="linenos">1595</span></a>        <span class="c1"># Convert click from display to image coordinate space</span>
</span><span id="NiftiViewer-1596"><a href="#NiftiViewer-1596"><span class="linenos">1596</span></a>        <span class="n">img_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen_to_image_coords</span><span class="p">(</span><span class="n">view_idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="NiftiViewer-1597"><a href="#NiftiViewer-1597"><span class="linenos">1597</span></a>        <span class="k">if</span> <span class="n">img_coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1598"><a href="#NiftiViewer-1598"><span class="linenos">1598</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer-1599"><a href="#NiftiViewer-1599"><span class="linenos">1599</span></a>
</span><span id="NiftiViewer-1600"><a href="#NiftiViewer-1600"><span class="linenos">1600</span></a>        <span class="c1"># Update global coordinates</span>
</span><span id="NiftiViewer-1601"><a href="#NiftiViewer-1601"><span class="linenos">1601</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span> <span class="o">=</span> <span class="n">img_coords</span>
</span><span id="NiftiViewer-1602"><a href="#NiftiViewer-1602"><span class="linenos">1602</span></a>
</span><span id="NiftiViewer-1603"><a href="#NiftiViewer-1603"><span class="linenos">1603</span></a>        <span class="c1"># Update slice positions based on clicked voxel</span>
</span><span id="NiftiViewer-1604"><a href="#NiftiViewer-1604"><span class="linenos">1604</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Axial (Z)</span>
</span><span id="NiftiViewer-1605"><a href="#NiftiViewer-1605"><span class="linenos">1605</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Coronal (Y)</span>
</span><span id="NiftiViewer-1606"><a href="#NiftiViewer-1606"><span class="linenos">1606</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Sagittal (X)</span>
</span><span id="NiftiViewer-1607"><a href="#NiftiViewer-1607"><span class="linenos">1607</span></a>
</span><span id="NiftiViewer-1608"><a href="#NiftiViewer-1608"><span class="linenos">1608</span></a>        <span class="c1"># Synchronize controls for all planes</span>
</span><span id="NiftiViewer-1609"><a href="#NiftiViewer-1609"><span class="linenos">1609</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="NiftiViewer-1610"><a href="#NiftiViewer-1610"><span class="linenos">1610</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="NiftiViewer-1611"><a href="#NiftiViewer-1611"><span class="linenos">1611</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="NiftiViewer-1612"><a href="#NiftiViewer-1612"><span class="linenos">1612</span></a>
</span><span id="NiftiViewer-1613"><a href="#NiftiViewer-1613"><span class="linenos">1613</span></a>        <span class="c1"># Refresh display and coordinate info</span>
</span><span id="NiftiViewer-1614"><a href="#NiftiViewer-1614"><span class="linenos">1614</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-1615"><a href="#NiftiViewer-1615"><span class="linenos">1615</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_coordinate_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-1616"><a href="#NiftiViewer-1616"><span class="linenos">1616</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_cross_view_lines</span><span class="p">()</span>
</span><span id="NiftiViewer-1617"><a href="#NiftiViewer-1617"><span class="linenos">1617</span></a>
</span><span id="NiftiViewer-1618"><a href="#NiftiViewer-1618"><span class="linenos">1618</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">screen_to_image_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="NiftiViewer-1619"><a href="#NiftiViewer-1619"><span class="linenos">1619</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1620"><a href="#NiftiViewer-1620"><span class="linenos">1620</span></a><span class="sd">        Convert 2D screen coordinates from a slice view into 3D voxel coordinates.</span>
</span><span id="NiftiViewer-1621"><a href="#NiftiViewer-1621"><span class="linenos">1621</span></a>
</span><span id="NiftiViewer-1622"><a href="#NiftiViewer-1622"><span class="linenos">1622</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-1623"><a href="#NiftiViewer-1623"><span class="linenos">1623</span></a><span class="sd">            view_idx (int): View index (0=axial, 1=coronal, 2=sagittal).</span>
</span><span id="NiftiViewer-1624"><a href="#NiftiViewer-1624"><span class="linenos">1624</span></a><span class="sd">            x (float): X coordinate in view space.</span>
</span><span id="NiftiViewer-1625"><a href="#NiftiViewer-1625"><span class="linenos">1625</span></a><span class="sd">            y (float): Y coordinate in view space.</span>
</span><span id="NiftiViewer-1626"><a href="#NiftiViewer-1626"><span class="linenos">1626</span></a>
</span><span id="NiftiViewer-1627"><a href="#NiftiViewer-1627"><span class="linenos">1627</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer-1628"><a href="#NiftiViewer-1628"><span class="linenos">1628</span></a><span class="sd">            list[int] | None: Image-space voxel indices [x, y, z] or None if invalid.</span>
</span><span id="NiftiViewer-1629"><a href="#NiftiViewer-1629"><span class="linenos">1629</span></a>
</span><span id="NiftiViewer-1630"><a href="#NiftiViewer-1630"><span class="linenos">1630</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer-1631"><a href="#NiftiViewer-1631"><span class="linenos">1631</span></a><span class="sd">            Applies stretch factor correction, flips orientation for proper display,</span>
</span><span id="NiftiViewer-1632"><a href="#NiftiViewer-1632"><span class="linenos">1632</span></a><span class="sd">            and clamps coordinates to valid volume bounds.</span>
</span><span id="NiftiViewer-1633"><a href="#NiftiViewer-1633"><span class="linenos">1633</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1634"><a href="#NiftiViewer-1634"><span class="linenos">1634</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1635"><a href="#NiftiViewer-1635"><span class="linenos">1635</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="NiftiViewer-1636"><a href="#NiftiViewer-1636"><span class="linenos">1636</span></a>
</span><span id="NiftiViewer-1637"><a href="#NiftiViewer-1637"><span class="linenos">1637</span></a>        <span class="c1"># Compensate for view stretching</span>
</span><span id="NiftiViewer-1638"><a href="#NiftiViewer-1638"><span class="linenos">1638</span></a>        <span class="n">stretch_x</span><span class="p">,</span> <span class="n">stretch_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_factors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">view_idx</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
</span><span id="NiftiViewer-1639"><a href="#NiftiViewer-1639"><span class="linenos">1639</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">stretch_x</span>
</span><span id="NiftiViewer-1640"><a href="#NiftiViewer-1640"><span class="linenos">1640</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">stretch_y</span>
</span><span id="NiftiViewer-1641"><a href="#NiftiViewer-1641"><span class="linenos">1641</span></a>
</span><span id="NiftiViewer-1642"><a href="#NiftiViewer-1642"><span class="linenos">1642</span></a>        <span class="c1"># Determine image dimensions (ignore time axis if 4D)</span>
</span><span id="NiftiViewer-1643"><a href="#NiftiViewer-1643"><span class="linenos">1643</span></a>        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="NiftiViewer-1644"><a href="#NiftiViewer-1644"><span class="linenos">1644</span></a>
</span><span id="NiftiViewer-1645"><a href="#NiftiViewer-1645"><span class="linenos">1645</span></a>        <span class="c1"># Map view-specific coordinates to image indices</span>
</span><span id="NiftiViewer-1646"><a href="#NiftiViewer-1646"><span class="linenos">1646</span></a>        <span class="k">if</span> <span class="n">view_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Axial (XY plane)</span>
</span><span id="NiftiViewer-1647"><a href="#NiftiViewer-1647"><span class="linenos">1647</span></a>            <span class="n">img_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer-1648"><a href="#NiftiViewer-1648"><span class="linenos">1648</span></a>            <span class="n">img_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Flip Y-axis</span>
</span><span id="NiftiViewer-1649"><a href="#NiftiViewer-1649"><span class="linenos">1649</span></a>            <span class="n">img_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="NiftiViewer-1650"><a href="#NiftiViewer-1650"><span class="linenos">1650</span></a>        <span class="k">elif</span> <span class="n">view_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Coronal (XZ plane)</span>
</span><span id="NiftiViewer-1651"><a href="#NiftiViewer-1651"><span class="linenos">1651</span></a>            <span class="n">img_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer-1652"><a href="#NiftiViewer-1652"><span class="linenos">1652</span></a>            <span class="n">img_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="NiftiViewer-1653"><a href="#NiftiViewer-1653"><span class="linenos">1653</span></a>            <span class="n">img_z</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Flip Z-axis</span>
</span><span id="NiftiViewer-1654"><a href="#NiftiViewer-1654"><span class="linenos">1654</span></a>        <span class="k">elif</span> <span class="n">view_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sagittal (YZ plane)</span>
</span><span id="NiftiViewer-1655"><a href="#NiftiViewer-1655"><span class="linenos">1655</span></a>            <span class="n">img_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="NiftiViewer-1656"><a href="#NiftiViewer-1656"><span class="linenos">1656</span></a>            <span class="n">img_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer-1657"><a href="#NiftiViewer-1657"><span class="linenos">1657</span></a>            <span class="n">img_z</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Flip Z-axis</span>
</span><span id="NiftiViewer-1658"><a href="#NiftiViewer-1658"><span class="linenos">1658</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-1659"><a href="#NiftiViewer-1659"><span class="linenos">1659</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="NiftiViewer-1660"><a href="#NiftiViewer-1660"><span class="linenos">1660</span></a>
</span><span id="NiftiViewer-1661"><a href="#NiftiViewer-1661"><span class="linenos">1661</span></a>        <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">img_x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_y</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_z</span><span class="p">)]</span>
</span><span id="NiftiViewer-1662"><a href="#NiftiViewer-1662"><span class="linenos">1662</span></a>
</span><span id="NiftiViewer-1663"><a href="#NiftiViewer-1663"><span class="linenos">1663</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="NiftiViewer-1664"><a href="#NiftiViewer-1664"><span class="linenos">1664</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1665"><a href="#NiftiViewer-1665"><span class="linenos">1665</span></a><span class="sd">        Update displayed voxel coordinates and value from mouse movement.</span>
</span><span id="NiftiViewer-1666"><a href="#NiftiViewer-1666"><span class="linenos">1666</span></a>
</span><span id="NiftiViewer-1667"><a href="#NiftiViewer-1667"><span class="linenos">1667</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-1668"><a href="#NiftiViewer-1668"><span class="linenos">1668</span></a><span class="sd">            view_idx (int): Index of the active view.</span>
</span><span id="NiftiViewer-1669"><a href="#NiftiViewer-1669"><span class="linenos">1669</span></a><span class="sd">            x (float): X mouse position.</span>
</span><span id="NiftiViewer-1670"><a href="#NiftiViewer-1670"><span class="linenos">1670</span></a><span class="sd">            y (float): Y mouse position.</span>
</span><span id="NiftiViewer-1671"><a href="#NiftiViewer-1671"><span class="linenos">1671</span></a>
</span><span id="NiftiViewer-1672"><a href="#NiftiViewer-1672"><span class="linenos">1672</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer-1673"><a href="#NiftiViewer-1673"><span class="linenos">1673</span></a><span class="sd">            Displays current voxel indices and intensity in the status bar</span>
</span><span id="NiftiViewer-1674"><a href="#NiftiViewer-1674"><span class="linenos">1674</span></a><span class="sd">            as the user moves the mouse across an image slice.</span>
</span><span id="NiftiViewer-1675"><a href="#NiftiViewer-1675"><span class="linenos">1675</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1676"><a href="#NiftiViewer-1676"><span class="linenos">1676</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1677"><a href="#NiftiViewer-1677"><span class="linenos">1677</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer-1678"><a href="#NiftiViewer-1678"><span class="linenos">1678</span></a>
</span><span id="NiftiViewer-1679"><a href="#NiftiViewer-1679"><span class="linenos">1679</span></a>        <span class="n">img_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen_to_image_coords</span><span class="p">(</span><span class="n">view_idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="NiftiViewer-1680"><a href="#NiftiViewer-1680"><span class="linenos">1680</span></a>        <span class="k">if</span> <span class="n">img_coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1681"><a href="#NiftiViewer-1681"><span class="linenos">1681</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer-1682"><a href="#NiftiViewer-1682"><span class="linenos">1682</span></a>
</span><span id="NiftiViewer-1683"><a href="#NiftiViewer-1683"><span class="linenos">1683</span></a>        <span class="c1"># Retrieve voxel value safely</span>
</span><span id="NiftiViewer-1684"><a href="#NiftiViewer-1684"><span class="linenos">1684</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NiftiViewer-1685"><a href="#NiftiViewer-1685"><span class="linenos">1685</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="NiftiViewer-1686"><a href="#NiftiViewer-1686"><span class="linenos">1686</span></a>                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">]</span>
</span><span id="NiftiViewer-1687"><a href="#NiftiViewer-1687"><span class="linenos">1687</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-1688"><a href="#NiftiViewer-1688"><span class="linenos">1688</span></a>                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</span><span id="NiftiViewer-1689"><a href="#NiftiViewer-1689"><span class="linenos">1689</span></a>
</span><span id="NiftiViewer-1690"><a href="#NiftiViewer-1690"><span class="linenos">1690</span></a>            <span class="c1"># Update coordinate and voxel value display</span>
</span><span id="NiftiViewer-1691"><a href="#NiftiViewer-1691"><span class="linenos">1691</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
</span><span id="NiftiViewer-1692"><a href="#NiftiViewer-1692"><span class="linenos">1692</span></a>                <span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coordinates&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: (</span><span class="si">{</span><span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">img_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">img_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1693"><a href="#NiftiViewer-1693"><span class="linenos">1693</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
</span><span id="NiftiViewer-1694"><a href="#NiftiViewer-1694"><span class="linenos">1694</span></a>                <span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1695"><a href="#NiftiViewer-1695"><span class="linenos">1695</span></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span id="NiftiViewer-1696"><a href="#NiftiViewer-1696"><span class="linenos">1696</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to update coordinates&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1697"><a href="#NiftiViewer-1697"><span class="linenos">1697</span></a>
</span><span id="NiftiViewer-1698"><a href="#NiftiViewer-1698"><span class="linenos">1698</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_coordinate_displays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-1699"><a href="#NiftiViewer-1699"><span class="linenos">1699</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1700"><a href="#NiftiViewer-1700"><span class="linenos">1700</span></a><span class="sd">        Update coordinate display labels beside each view and in the status bar.</span>
</span><span id="NiftiViewer-1701"><a href="#NiftiViewer-1701"><span class="linenos">1701</span></a>
</span><span id="NiftiViewer-1702"><a href="#NiftiViewer-1702"><span class="linenos">1702</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer-1703"><a href="#NiftiViewer-1703"><span class="linenos">1703</span></a><span class="sd">            Shows current voxel positions (X, Y, Z) and value, ensuring real-time</span>
</span><span id="NiftiViewer-1704"><a href="#NiftiViewer-1704"><span class="linenos">1704</span></a><span class="sd">            synchronization with slice sliders and mouse navigation.</span>
</span><span id="NiftiViewer-1705"><a href="#NiftiViewer-1705"><span class="linenos">1705</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1706"><a href="#NiftiViewer-1706"><span class="linenos">1706</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1707"><a href="#NiftiViewer-1707"><span class="linenos">1707</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer-1708"><a href="#NiftiViewer-1708"><span class="linenos">1708</span></a>
</span><span id="NiftiViewer-1709"><a href="#NiftiViewer-1709"><span class="linenos">1709</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span>
</span><span id="NiftiViewer-1710"><a href="#NiftiViewer-1710"><span class="linenos">1710</span></a>
</span><span id="NiftiViewer-1711"><a href="#NiftiViewer-1711"><span class="linenos">1711</span></a>        <span class="c1"># Update per-view coordinate readouts</span>
</span><span id="NiftiViewer-1712"><a href="#NiftiViewer-1712"><span class="linenos">1712</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_displays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>  <span class="c1"># Axial</span>
</span><span id="NiftiViewer-1713"><a href="#NiftiViewer-1713"><span class="linenos">1713</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_displays</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>  <span class="c1"># Coronal</span>
</span><span id="NiftiViewer-1714"><a href="#NiftiViewer-1714"><span class="linenos">1714</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_displays</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>  <span class="c1"># Sagittal</span>
</span><span id="NiftiViewer-1715"><a href="#NiftiViewer-1715"><span class="linenos">1715</span></a>
</span><span id="NiftiViewer-1716"><a href="#NiftiViewer-1716"><span class="linenos">1716</span></a>        <span class="c1"># Update global coordinate display in status bar</span>
</span><span id="NiftiViewer-1717"><a href="#NiftiViewer-1717"><span class="linenos">1717</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
</span><span id="NiftiViewer-1718"><a href="#NiftiViewer-1718"><span class="linenos">1718</span></a>            <span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coordinates&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: (</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1719"><a href="#NiftiViewer-1719"><span class="linenos">1719</span></a>
</span><span id="NiftiViewer-1720"><a href="#NiftiViewer-1720"><span class="linenos">1720</span></a>        <span class="c1"># Update value label safely</span>
</span><span id="NiftiViewer-1721"><a href="#NiftiViewer-1721"><span class="linenos">1721</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NiftiViewer-1722"><a href="#NiftiViewer-1722"><span class="linenos">1722</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="NiftiViewer-1723"><a href="#NiftiViewer-1723"><span class="linenos">1723</span></a>                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">]</span>
</span><span id="NiftiViewer-1724"><a href="#NiftiViewer-1724"><span class="linenos">1724</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-1725"><a href="#NiftiViewer-1725"><span class="linenos">1725</span></a>                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</span><span id="NiftiViewer-1726"><a href="#NiftiViewer-1726"><span class="linenos">1726</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
</span><span id="NiftiViewer-1727"><a href="#NiftiViewer-1727"><span class="linenos">1727</span></a>                <span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1728"><a href="#NiftiViewer-1728"><span class="linenos">1728</span></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span id="NiftiViewer-1729"><a href="#NiftiViewer-1729"><span class="linenos">1729</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: -&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1730"><a href="#NiftiViewer-1730"><span class="linenos">1730</span></a>
</span><span id="NiftiViewer-1731"><a href="#NiftiViewer-1731"><span class="linenos">1731</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_cross_view_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-1732"><a href="#NiftiViewer-1732"><span class="linenos">1732</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1733"><a href="#NiftiViewer-1733"><span class="linenos">1733</span></a><span class="sd">        Update crosshair positions across all views to indicate current voxel location.</span>
</span><span id="NiftiViewer-1734"><a href="#NiftiViewer-1734"><span class="linenos">1734</span></a>
</span><span id="NiftiViewer-1735"><a href="#NiftiViewer-1735"><span class="linenos">1735</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer-1736"><a href="#NiftiViewer-1736"><span class="linenos">1736</span></a><span class="sd">            Crosshair lines are synchronized in all 2D projections (axial, coronal, sagittal),</span>
</span><span id="NiftiViewer-1737"><a href="#NiftiViewer-1737"><span class="linenos">1737</span></a><span class="sd">            taking into account stretching factors and coordinate flipping.</span>
</span><span id="NiftiViewer-1738"><a href="#NiftiViewer-1738"><span class="linenos">1738</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1739"><a href="#NiftiViewer-1739"><span class="linenos">1739</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1740"><a href="#NiftiViewer-1740"><span class="linenos">1740</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer-1741"><a href="#NiftiViewer-1741"><span class="linenos">1741</span></a>
</span><span id="NiftiViewer-1742"><a href="#NiftiViewer-1742"><span class="linenos">1742</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span>
</span><span id="NiftiViewer-1743"><a href="#NiftiViewer-1743"><span class="linenos">1743</span></a>
</span><span id="NiftiViewer-1744"><a href="#NiftiViewer-1744"><span class="linenos">1744</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">):</span>
</span><span id="NiftiViewer-1745"><a href="#NiftiViewer-1745"><span class="linenos">1745</span></a>            <span class="c1"># Retrieve stretch correction factors (default to 1.0)</span>
</span><span id="NiftiViewer-1746"><a href="#NiftiViewer-1746"><span class="linenos">1746</span></a>            <span class="n">stretch_x</span><span class="p">,</span> <span class="n">stretch_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_factors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
</span><span id="NiftiViewer-1747"><a href="#NiftiViewer-1747"><span class="linenos">1747</span></a>
</span><span id="NiftiViewer-1748"><a href="#NiftiViewer-1748"><span class="linenos">1748</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Axial view</span>
</span><span id="NiftiViewer-1749"><a href="#NiftiViewer-1749"><span class="linenos">1749</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">stretch_x</span>
</span><span id="NiftiViewer-1750"><a href="#NiftiViewer-1750"><span class="linenos">1750</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">stretch_y</span>
</span><span id="NiftiViewer-1751"><a href="#NiftiViewer-1751"><span class="linenos">1751</span></a>                <span class="n">view</span><span class="o">.</span><span class="n">set_crosshair_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="NiftiViewer-1752"><a href="#NiftiViewer-1752"><span class="linenos">1752</span></a>
</span><span id="NiftiViewer-1753"><a href="#NiftiViewer-1753"><span class="linenos">1753</span></a>            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Coronal view</span>
</span><span id="NiftiViewer-1754"><a href="#NiftiViewer-1754"><span class="linenos">1754</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">stretch_x</span>
</span><span id="NiftiViewer-1755"><a href="#NiftiViewer-1755"><span class="linenos">1755</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">stretch_y</span>
</span><span id="NiftiViewer-1756"><a href="#NiftiViewer-1756"><span class="linenos">1756</span></a>                <span class="n">view</span><span class="o">.</span><span class="n">set_crosshair_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="NiftiViewer-1757"><a href="#NiftiViewer-1757"><span class="linenos">1757</span></a>
</span><span id="NiftiViewer-1758"><a href="#NiftiViewer-1758"><span class="linenos">1758</span></a>            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sagittal view</span>
</span><span id="NiftiViewer-1759"><a href="#NiftiViewer-1759"><span class="linenos">1759</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">stretch_x</span>
</span><span id="NiftiViewer-1760"><a href="#NiftiViewer-1760"><span class="linenos">1760</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">stretch_y</span>
</span><span id="NiftiViewer-1761"><a href="#NiftiViewer-1761"><span class="linenos">1761</span></a>                <span class="n">view</span><span class="o">.</span><span class="n">set_crosshair_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="NiftiViewer-1762"><a href="#NiftiViewer-1762"><span class="linenos">1762</span></a>
</span><span id="NiftiViewer-1763"><a href="#NiftiViewer-1763"><span class="linenos">1763</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="p">):</span>
</span><span id="NiftiViewer-1764"><a href="#NiftiViewer-1764"><span class="linenos">1764</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update a specific plane display with matplotlib-style rendering in mm scale&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1765"><a href="#NiftiViewer-1765"><span class="linenos">1765</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1766"><a href="#NiftiViewer-1766"><span class="linenos">1766</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer-1767"><a href="#NiftiViewer-1767"><span class="linenos">1767</span></a>
</span><span id="NiftiViewer-1768"><a href="#NiftiViewer-1768"><span class="linenos">1768</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NiftiViewer-1769"><a href="#NiftiViewer-1769"><span class="linenos">1769</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Update display: </span><span class="si">{</span><span class="n">plane_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1770"><a href="#NiftiViewer-1770"><span class="linenos">1770</span></a>            <span class="c1"># Select current 3D volume (for 4D data, use the selected time frame)</span>
</span><span id="NiftiViewer-1771"><a href="#NiftiViewer-1771"><span class="linenos">1771</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="NiftiViewer-1772"><a href="#NiftiViewer-1772"><span class="linenos">1772</span></a>                <span class="n">current_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">]</span>
</span><span id="NiftiViewer-1773"><a href="#NiftiViewer-1773"><span class="linenos">1773</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-1774"><a href="#NiftiViewer-1774"><span class="linenos">1774</span></a>                <span class="n">current_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span>
</span><span id="NiftiViewer-1775"><a href="#NiftiViewer-1775"><span class="linenos">1775</span></a>
</span><span id="NiftiViewer-1776"><a href="#NiftiViewer-1776"><span class="linenos">1776</span></a>            <span class="c1"># Get current slice index for the selected plane</span>
</span><span id="NiftiViewer-1777"><a href="#NiftiViewer-1777"><span class="linenos">1777</span></a>            <span class="n">slice_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span>
</span><span id="NiftiViewer-1778"><a href="#NiftiViewer-1778"><span class="linenos">1778</span></a>
</span><span id="NiftiViewer-1779"><a href="#NiftiViewer-1779"><span class="linenos">1779</span></a>            <span class="c1"># Extract the corresponding slice depending on the plane</span>
</span><span id="NiftiViewer-1780"><a href="#NiftiViewer-1780"><span class="linenos">1780</span></a>            <span class="k">if</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Axial (XY plane)</span>
</span><span id="NiftiViewer-1781"><a href="#NiftiViewer-1781"><span class="linenos">1781</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">current_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">slice_idx</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># transpose to match orientation</span>
</span><span id="NiftiViewer-1782"><a href="#NiftiViewer-1782"><span class="linenos">1782</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">slice_data</span><span class="p">)</span>  <span class="c1"># flip vertically for correct visualization</span>
</span><span id="NiftiViewer-1783"><a href="#NiftiViewer-1783"><span class="linenos">1783</span></a>                <span class="n">pixel_spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># spacing in X and Y directions</span>
</span><span id="NiftiViewer-1784"><a href="#NiftiViewer-1784"><span class="linenos">1784</span></a>
</span><span id="NiftiViewer-1785"><a href="#NiftiViewer-1785"><span class="linenos">1785</span></a>            <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Coronal (XZ plane)</span>
</span><span id="NiftiViewer-1786"><a href="#NiftiViewer-1786"><span class="linenos">1786</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">current_data</span><span class="p">[:,</span> <span class="n">slice_idx</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
</span><span id="NiftiViewer-1787"><a href="#NiftiViewer-1787"><span class="linenos">1787</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">slice_data</span><span class="p">)</span>
</span><span id="NiftiViewer-1788"><a href="#NiftiViewer-1788"><span class="linenos">1788</span></a>                <span class="n">pixel_spacing</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># X and Z spacing</span>
</span><span id="NiftiViewer-1789"><a href="#NiftiViewer-1789"><span class="linenos">1789</span></a>
</span><span id="NiftiViewer-1790"><a href="#NiftiViewer-1790"><span class="linenos">1790</span></a>            <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sagittal (YZ plane)</span>
</span><span id="NiftiViewer-1791"><a href="#NiftiViewer-1791"><span class="linenos">1791</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">current_data</span><span class="p">[</span><span class="n">slice_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
</span><span id="NiftiViewer-1792"><a href="#NiftiViewer-1792"><span class="linenos">1792</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">slice_data</span><span class="p">)</span>
</span><span id="NiftiViewer-1793"><a href="#NiftiViewer-1793"><span class="linenos">1793</span></a>                <span class="n">pixel_spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># Y and Z spacing</span>
</span><span id="NiftiViewer-1794"><a href="#NiftiViewer-1794"><span class="linenos">1794</span></a>
</span><span id="NiftiViewer-1795"><a href="#NiftiViewer-1795"><span class="linenos">1795</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-1796"><a href="#NiftiViewer-1796"><span class="linenos">1796</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Plane index out of range&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1797"><a href="#NiftiViewer-1797"><span class="linenos">1797</span></a>                <span class="k">return</span>  <span class="c1"># Invalid plane index</span>
</span><span id="NiftiViewer-1798"><a href="#NiftiViewer-1798"><span class="linenos">1798</span></a>
</span><span id="NiftiViewer-1799"><a href="#NiftiViewer-1799"><span class="linenos">1799</span></a>            <span class="n">automaticROI_slice</span> <span class="o">=</span> <span class="n">_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span><span class="p">,</span> <span class="n">plane_idx</span><span class="p">,</span> <span class="n">slice_idx</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="NiftiViewer-1800"><a href="#NiftiViewer-1800"><span class="linenos">1800</span></a>
</span><span id="NiftiViewer-1801"><a href="#NiftiViewer-1801"><span class="linenos">1801</span></a>            <span class="c1"># Prepare overlay if available and enabled</span>
</span><span id="NiftiViewer-1802"><a href="#NiftiViewer-1802"><span class="linenos">1802</span></a>            <span class="n">overlay_slice</span> <span class="o">=</span> <span class="n">_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span><span class="p">,</span><span class="n">plane_idx</span><span class="p">,</span> <span class="n">slice_idx</span><span class="p">)</span>  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="NiftiViewer-1803"><a href="#NiftiViewer-1803"><span class="linenos">1803</span></a>
</span><span id="NiftiViewer-1804"><a href="#NiftiViewer-1804"><span class="linenos">1804</span></a>            <span class="n">incrementalROI_slice</span> <span class="o">=</span> <span class="n">_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span><span class="p">,</span><span class="n">plane_idx</span><span class="p">,</span> <span class="n">slice_idx</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="NiftiViewer-1805"><a href="#NiftiViewer-1805"><span class="linenos">1805</span></a>
</span><span id="NiftiViewer-1806"><a href="#NiftiViewer-1806"><span class="linenos">1806</span></a>            <span class="c1"># Prepare RGBA composite for display</span>
</span><span id="NiftiViewer-1807"><a href="#NiftiViewer-1807"><span class="linenos">1807</span></a>            <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">slice_data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="NiftiViewer-1808"><a href="#NiftiViewer-1808"><span class="linenos">1808</span></a>            <span class="n">rgba_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_colormap_matplotlib</span><span class="p">(</span><span class="n">slice_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="NiftiViewer-1809"><a href="#NiftiViewer-1809"><span class="linenos">1809</span></a>
</span><span id="NiftiViewer-1810"><a href="#NiftiViewer-1810"><span class="linenos">1810</span></a>            <span class="k">if</span> <span class="n">automaticROI_slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1811"><a href="#NiftiViewer-1811"><span class="linenos">1811</span></a>                <span class="n">rgba_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_overlay_composite</span><span class="p">(</span><span class="n">rgba_image</span><span class="p">,</span> <span class="n">automaticROI_slice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="NiftiViewer-1812"><a href="#NiftiViewer-1812"><span class="linenos">1812</span></a>
</span><span id="NiftiViewer-1813"><a href="#NiftiViewer-1813"><span class="linenos">1813</span></a>            <span class="k">if</span> <span class="n">overlay_slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1814"><a href="#NiftiViewer-1814"><span class="linenos">1814</span></a>                <span class="n">rgba_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_overlay_composite</span><span class="p">(</span><span class="n">rgba_image</span><span class="p">,</span> <span class="n">overlay_slice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="NiftiViewer-1815"><a href="#NiftiViewer-1815"><span class="linenos">1815</span></a>
</span><span id="NiftiViewer-1816"><a href="#NiftiViewer-1816"><span class="linenos">1816</span></a>            <span class="k">if</span> <span class="n">incrementalROI_slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1817"><a href="#NiftiViewer-1817"><span class="linenos">1817</span></a>                <span class="n">rgba_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_overlay_composite</span><span class="p">(</span><span class="n">rgba_image</span><span class="p">,</span> <span class="n">incrementalROI_slice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="NiftiViewer-1818"><a href="#NiftiViewer-1818"><span class="linenos">1818</span></a>
</span><span id="NiftiViewer-1819"><a href="#NiftiViewer-1819"><span class="linenos">1819</span></a>            <span class="c1"># Convert RGBA data to 8-bit format for QImage</span>
</span><span id="NiftiViewer-1820"><a href="#NiftiViewer-1820"><span class="linenos">1820</span></a>            <span class="n">rgba_data_uint8</span> <span class="o">=</span> <span class="p">(</span><span class="n">rgba_image</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="NiftiViewer-1821"><a href="#NiftiViewer-1821"><span class="linenos">1821</span></a>            <span class="n">qimage</span> <span class="o">=</span> <span class="n">QImage</span><span class="p">(</span><span class="n">rgba_data_uint8</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">QImage</span><span class="o">.</span><span class="n">Format</span><span class="o">.</span><span class="n">Format_RGBA8888</span><span class="p">)</span>
</span><span id="NiftiViewer-1822"><a href="#NiftiViewer-1822"><span class="linenos">1822</span></a>
</span><span id="NiftiViewer-1823"><a href="#NiftiViewer-1823"><span class="linenos">1823</span></a>            <span class="k">if</span> <span class="n">qimage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1824"><a href="#NiftiViewer-1824"><span class="linenos">1824</span></a>                <span class="n">img_w</span><span class="p">,</span> <span class="n">img_h</span> <span class="o">=</span> <span class="n">qimage</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span> <span class="n">qimage</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
</span><span id="NiftiViewer-1825"><a href="#NiftiViewer-1825"><span class="linenos">1825</span></a>
</span><span id="NiftiViewer-1826"><a href="#NiftiViewer-1826"><span class="linenos">1826</span></a>                <span class="c1"># Scale the image according to voxel size ratio (convert to mm scale)</span>
</span><span id="NiftiViewer-1827"><a href="#NiftiViewer-1827"><span class="linenos">1827</span></a>                <span class="n">qimage_scaled</span> <span class="o">=</span> <span class="n">qimage</span><span class="o">.</span><span class="n">scaled</span><span class="p">(</span>
</span><span id="NiftiViewer-1828"><a href="#NiftiViewer-1828"><span class="linenos">1828</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="n">img_w</span><span class="p">),</span>
</span><span id="NiftiViewer-1829"><a href="#NiftiViewer-1829"><span class="linenos">1829</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="n">img_h</span> <span class="o">*</span> <span class="p">(</span><span class="n">pixel_spacing</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">pixel_spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
</span><span id="NiftiViewer-1830"><a href="#NiftiViewer-1830"><span class="linenos">1830</span></a>                    <span class="n">Qt</span><span class="o">.</span><span class="n">AspectRatioMode</span><span class="o">.</span><span class="n">IgnoreAspectRatio</span><span class="p">,</span>
</span><span id="NiftiViewer-1831"><a href="#NiftiViewer-1831"><span class="linenos">1831</span></a>                    <span class="n">Qt</span><span class="o">.</span><span class="n">TransformationMode</span><span class="o">.</span><span class="n">SmoothTransformation</span>
</span><span id="NiftiViewer-1832"><a href="#NiftiViewer-1832"><span class="linenos">1832</span></a>                <span class="p">)</span>
</span><span id="NiftiViewer-1833"><a href="#NiftiViewer-1833"><span class="linenos">1833</span></a>
</span><span id="NiftiViewer-1834"><a href="#NiftiViewer-1834"><span class="linenos">1834</span></a>                <span class="c1"># Store stretch factors for coordinate conversion later</span>
</span><span id="NiftiViewer-1835"><a href="#NiftiViewer-1835"><span class="linenos">1835</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stretch_factors</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pixel_spacing</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">pixel_spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="NiftiViewer-1836"><a href="#NiftiViewer-1836"><span class="linenos">1836</span></a>
</span><span id="NiftiViewer-1837"><a href="#NiftiViewer-1837"><span class="linenos">1837</span></a>                <span class="c1"># Update QGraphicsScene and QGraphicsView with new image</span>
</span><span id="NiftiViewer-1838"><a href="#NiftiViewer-1838"><span class="linenos">1838</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pixmap_items</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">setPixmap</span><span class="p">(</span><span class="n">QPixmap</span><span class="o">.</span><span class="n">fromImage</span><span class="p">(</span><span class="n">qimage_scaled</span><span class="p">))</span>
</span><span id="NiftiViewer-1839"><a href="#NiftiViewer-1839"><span class="linenos">1839</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">setSceneRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qimage_scaled</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span> <span class="n">qimage_scaled</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>
</span><span id="NiftiViewer-1840"><a href="#NiftiViewer-1840"><span class="linenos">1840</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">fitInView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">sceneRect</span><span class="p">(),</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AspectRatioMode</span><span class="o">.</span><span class="n">KeepAspectRatio</span><span class="p">)</span>
</span><span id="NiftiViewer-1841"><a href="#NiftiViewer-1841"><span class="linenos">1841</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated display ended&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1842"><a href="#NiftiViewer-1842"><span class="linenos">1842</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="NiftiViewer-1843"><a href="#NiftiViewer-1843"><span class="linenos">1843</span></a>            <span class="c1"># Log any display update errors (e.g. shape mismatch or memory issue)</span>
</span><span id="NiftiViewer-1844"><a href="#NiftiViewer-1844"><span class="linenos">1844</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating display </span><span class="si">{</span><span class="n">plane_idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1845"><a href="#NiftiViewer-1845"><span class="linenos">1845</span></a>
</span><span id="NiftiViewer-1846"><a href="#NiftiViewer-1846"><span class="linenos">1846</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_time_series_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-1847"><a href="#NiftiViewer-1847"><span class="linenos">1847</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup time series plot for 4D data&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1848"><a href="#NiftiViewer-1848"><span class="linenos">1848</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1849"><a href="#NiftiViewer-1849"><span class="linenos">1849</span></a>            <span class="k">return</span>  <span class="c1"># Skip if plot is already initialized</span>
</span><span id="NiftiViewer-1850"><a href="#NiftiViewer-1850"><span class="linenos">1850</span></a>
</span><span id="NiftiViewer-1851"><a href="#NiftiViewer-1851"><span class="linenos">1851</span></a>        <span class="c1"># Hide static info text to make room for plot</span>
</span><span id="NiftiViewer-1852"><a href="#NiftiViewer-1852"><span class="linenos">1852</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
</span><span id="NiftiViewer-1853"><a href="#NiftiViewer-1853"><span class="linenos">1853</span></a>
</span><span id="NiftiViewer-1854"><a href="#NiftiViewer-1854"><span class="linenos">1854</span></a>        <span class="c1"># Initialize matplotlib figure for time series</span>
</span><span id="NiftiViewer-1855"><a href="#NiftiViewer-1855"><span class="linenos">1855</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer-1856"><a href="#NiftiViewer-1856"><span class="linenos">1856</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span><span class="o">.</span><span class="n">set_layout_engine</span><span class="p">(</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer-1857"><a href="#NiftiViewer-1857"><span class="linenos">1857</span></a>
</span><span id="NiftiViewer-1858"><a href="#NiftiViewer-1858"><span class="linenos">1858</span></a>        <span class="c1"># Embed matplotlib canvas inside PyQt interface</span>
</span><span id="NiftiViewer-1859"><a href="#NiftiViewer-1859"><span class="linenos">1859</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span><span class="p">)</span>
</span><span id="NiftiViewer-1860"><a href="#NiftiViewer-1860"><span class="linenos">1860</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
</span><span id="NiftiViewer-1861"><a href="#NiftiViewer-1861"><span class="linenos">1861</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer-1862"><a href="#NiftiViewer-1862"><span class="linenos">1862</span></a>
</span><span id="NiftiViewer-1863"><a href="#NiftiViewer-1863"><span class="linenos">1863</span></a>        <span class="c1"># Update section title and add canvas widget to layout</span>
</span><span id="NiftiViewer-1864"><a href="#NiftiViewer-1864"><span class="linenos">1864</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Tracer Concentration Curve&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-1865"><a href="#NiftiViewer-1865"><span class="linenos">1865</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_content_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span><span class="p">)</span>
</span><span id="NiftiViewer-1866"><a href="#NiftiViewer-1866"><span class="linenos">1866</span></a>
</span><span id="NiftiViewer-1867"><a href="#NiftiViewer-1867"><span class="linenos">1867</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">hide_time_series_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-1868"><a href="#NiftiViewer-1868"><span class="linenos">1868</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Hide time series plot for 3D data&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1869"><a href="#NiftiViewer-1869"><span class="linenos">1869</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1870"><a href="#NiftiViewer-1870"><span class="linenos">1870</span></a>            <span class="c1"># Clean up plot canvas from layout and delete</span>
</span><span id="NiftiViewer-1871"><a href="#NiftiViewer-1871"><span class="linenos">1871</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fourth_content_layout</span><span class="o">.</span><span class="n">removeWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span><span class="p">)</span>
</span><span id="NiftiViewer-1872"><a href="#NiftiViewer-1872"><span class="linenos">1872</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="NiftiViewer-1873"><a href="#NiftiViewer-1873"><span class="linenos">1873</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
</span><span id="NiftiViewer-1874"><a href="#NiftiViewer-1874"><span class="linenos">1874</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-1875"><a href="#NiftiViewer-1875"><span class="linenos">1875</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-1876"><a href="#NiftiViewer-1876"><span class="linenos">1876</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-1877"><a href="#NiftiViewer-1877"><span class="linenos">1877</span></a>
</span><span id="NiftiViewer-1878"><a href="#NiftiViewer-1878"><span class="linenos">1878</span></a>        <span class="c1"># Restore title and info text for non-4D files</span>
</span><span id="NiftiViewer-1879"><a href="#NiftiViewer-1879"><span class="linenos">1879</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Image Information&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-1880"><a href="#NiftiViewer-1880"><span class="linenos">1880</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="NiftiViewer-1881"><a href="#NiftiViewer-1881"><span class="linenos">1881</span></a>
</span><span id="NiftiViewer-1882"><a href="#NiftiViewer-1882"><span class="linenos">1882</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_time_series_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-1883"><a href="#NiftiViewer-1883"><span class="linenos">1883</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the time series plot with current voxel or ROI data&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1884"><a href="#NiftiViewer-1884"><span class="linenos">1884</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1885"><a href="#NiftiViewer-1885"><span class="linenos">1885</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer-1886"><a href="#NiftiViewer-1886"><span class="linenos">1886</span></a>
</span><span id="NiftiViewer-1887"><a href="#NiftiViewer-1887"><span class="linenos">1887</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NiftiViewer-1888"><a href="#NiftiViewer-1888"><span class="linenos">1888</span></a>            <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span>
</span><span id="NiftiViewer-1889"><a href="#NiftiViewer-1889"><span class="linenos">1889</span></a>            <span class="n">bool_in_mask</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="NiftiViewer-1890"><a href="#NiftiViewer-1890"><span class="linenos">1890</span></a>
</span><span id="NiftiViewer-1891"><a href="#NiftiViewer-1891"><span class="linenos">1891</span></a>            <span class="c1"># Check if overlay is active and apply ROI-based averaging</span>
</span><span id="NiftiViewer-1892"><a href="#NiftiViewer-1892"><span class="linenos">1892</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">:</span>
</span><span id="NiftiViewer-1893"><a href="#NiftiViewer-1893"><span class="linenos">1893</span></a>                <span class="n">overlay_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="NiftiViewer-1894"><a href="#NiftiViewer-1894"><span class="linenos">1894</span></a>                <span class="n">threshold_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span> <span class="o">*</span> <span class="n">overlay_max</span>
</span><span id="NiftiViewer-1895"><a href="#NiftiViewer-1895"><span class="linenos">1895</span></a>                <span class="n">threshold_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">&gt;</span> <span class="n">threshold_value</span>
</span><span id="NiftiViewer-1896"><a href="#NiftiViewer-1896"><span class="linenos">1896</span></a>
</span><span id="NiftiViewer-1897"><a href="#NiftiViewer-1897"><span class="linenos">1897</span></a>                <span class="c1"># If current voxel is inside the thresholded ROI mask</span>
</span><span id="NiftiViewer-1898"><a href="#NiftiViewer-1898"><span class="linenos">1898</span></a>                <span class="k">if</span> <span class="n">threshold_mask</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]]:</span>
</span><span id="NiftiViewer-1899"><a href="#NiftiViewer-1899"><span class="linenos">1899</span></a>                    <span class="n">bool_in_mask</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="NiftiViewer-1900"><a href="#NiftiViewer-1900"><span class="linenos">1900</span></a>                    <span class="n">roi_voxels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">threshold_mask</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># extract time series from ROI voxels</span>
</span><span id="NiftiViewer-1901"><a href="#NiftiViewer-1901"><span class="linenos">1901</span></a>                    <span class="n">time_series</span> <span class="o">=</span> <span class="n">roi_voxels</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># mean intensity over ROI</span>
</span><span id="NiftiViewer-1902"><a href="#NiftiViewer-1902"><span class="linenos">1902</span></a>                    <span class="n">std_series</span> <span class="o">=</span> <span class="n">roi_voxels</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># standard deviation for shaded region</span>
</span><span id="NiftiViewer-1903"><a href="#NiftiViewer-1903"><span class="linenos">1903</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-1904"><a href="#NiftiViewer-1904"><span class="linenos">1904</span></a>                    <span class="c1"># Outside mask: show only single voxel time series</span>
</span><span id="NiftiViewer-1905"><a href="#NiftiViewer-1905"><span class="linenos">1905</span></a>                    <span class="n">time_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="NiftiViewer-1906"><a href="#NiftiViewer-1906"><span class="linenos">1906</span></a>                    <span class="n">std_series</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-1907"><a href="#NiftiViewer-1907"><span class="linenos">1907</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-1908"><a href="#NiftiViewer-1908"><span class="linenos">1908</span></a>                <span class="c1"># If overlay is not enabled, show voxel intensity over time</span>
</span><span id="NiftiViewer-1909"><a href="#NiftiViewer-1909"><span class="linenos">1909</span></a>                <span class="n">time_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="NiftiViewer-1910"><a href="#NiftiViewer-1910"><span class="linenos">1910</span></a>                <span class="n">std_series</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-1911"><a href="#NiftiViewer-1911"><span class="linenos">1911</span></a>
</span><span id="NiftiViewer-1912"><a href="#NiftiViewer-1912"><span class="linenos">1912</span></a>            <span class="c1"># X-axis values = time points</span>
</span><span id="NiftiViewer-1913"><a href="#NiftiViewer-1913"><span class="linenos">1913</span></a>            <span class="n">time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="NiftiViewer-1914"><a href="#NiftiViewer-1914"><span class="linenos">1914</span></a>
</span><span id="NiftiViewer-1915"><a href="#NiftiViewer-1915"><span class="linenos">1915</span></a>            <span class="c1"># Clear previous plot content</span>
</span><span id="NiftiViewer-1916"><a href="#NiftiViewer-1916"><span class="linenos">1916</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="NiftiViewer-1917"><a href="#NiftiViewer-1917"><span class="linenos">1917</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer-1918"><a href="#NiftiViewer-1918"><span class="linenos">1918</span></a>
</span><span id="NiftiViewer-1919"><a href="#NiftiViewer-1919"><span class="linenos">1919</span></a>            <span class="c1"># Plot time series curve</span>
</span><span id="NiftiViewer-1920"><a href="#NiftiViewer-1920"><span class="linenos">1920</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span> <span class="n">time_series</span><span class="p">,</span> <span class="s1">&#39;c-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="NiftiViewer-1921"><a href="#NiftiViewer-1921"><span class="linenos">1921</span></a>                                     <span class="n">label</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s1">&#39;Concentration&#39;</span><span class="p">))</span>
</span><span id="NiftiViewer-1922"><a href="#NiftiViewer-1922"><span class="linenos">1922</span></a>
</span><span id="NiftiViewer-1923"><a href="#NiftiViewer-1923"><span class="linenos">1923</span></a>            <span class="c1"># Optional shaded error region (ROI variability)</span>
</span><span id="NiftiViewer-1924"><a href="#NiftiViewer-1924"><span class="linenos">1924</span></a>            <span class="k">if</span> <span class="n">std_series</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1925"><a href="#NiftiViewer-1925"><span class="linenos">1925</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span> <span class="n">time_series</span> <span class="o">-</span> <span class="n">std_series</span><span class="p">,</span>
</span><span id="NiftiViewer-1926"><a href="#NiftiViewer-1926"><span class="linenos">1926</span></a>                                                 <span class="n">time_series</span> <span class="o">+</span> <span class="n">std_series</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer-1927"><a href="#NiftiViewer-1927"><span class="linenos">1927</span></a>
</span><span id="NiftiViewer-1928"><a href="#NiftiViewer-1928"><span class="linenos">1928</span></a>            <span class="c1"># Add vertical yellow line showing current time index</span>
</span><span id="NiftiViewer-1929"><a href="#NiftiViewer-1929"><span class="linenos">1929</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_indicator_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
</span><span id="NiftiViewer-1930"><a href="#NiftiViewer-1930"><span class="linenos">1930</span></a>                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="NiftiViewer-1931"><a href="#NiftiViewer-1931"><span class="linenos">1931</span></a>                <span class="n">label</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s1">&#39;Current Time&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer-1932"><a href="#NiftiViewer-1932"><span class="linenos">1932</span></a>            <span class="p">)</span>
</span><span id="NiftiViewer-1933"><a href="#NiftiViewer-1933"><span class="linenos">1933</span></a>
</span><span id="NiftiViewer-1934"><a href="#NiftiViewer-1934"><span class="linenos">1934</span></a>            <span class="c1"># Set axis labels and title</span>
</span><span id="NiftiViewer-1935"><a href="#NiftiViewer-1935"><span class="linenos">1935</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Time Point&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer-1936"><a href="#NiftiViewer-1936"><span class="linenos">1936</span></a>                                           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer-1937"><a href="#NiftiViewer-1937"><span class="linenos">1937</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Signal Intensity&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer-1938"><a href="#NiftiViewer-1938"><span class="linenos">1938</span></a>                                           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer-1939"><a href="#NiftiViewer-1939"><span class="linenos">1939</span></a>
</span><span id="NiftiViewer-1940"><a href="#NiftiViewer-1940"><span class="linenos">1940</span></a>            <span class="c1"># Title reflects whether inside ROI or single voxel</span>
</span><span id="NiftiViewer-1941"><a href="#NiftiViewer-1941"><span class="linenos">1941</span></a>            <span class="k">if</span> <span class="n">bool_in_mask</span><span class="p">:</span>
</span><span id="NiftiViewer-1942"><a href="#NiftiViewer-1942"><span class="linenos">1942</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean in overlay mask&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer-1943"><a href="#NiftiViewer-1943"><span class="linenos">1943</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-1944"><a href="#NiftiViewer-1944"><span class="linenos">1944</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Voxel (</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer-1945"><a href="#NiftiViewer-1945"><span class="linenos">1945</span></a>
</span><span id="NiftiViewer-1946"><a href="#NiftiViewer-1946"><span class="linenos">1946</span></a>            <span class="c1"># Style axes and legend</span>
</span><span id="NiftiViewer-1947"><a href="#NiftiViewer-1947"><span class="linenos">1947</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer-1948"><a href="#NiftiViewer-1948"><span class="linenos">1948</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="NiftiViewer-1949"><a href="#NiftiViewer-1949"><span class="linenos">1949</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer-1950"><a href="#NiftiViewer-1950"><span class="linenos">1950</span></a>
</span><span id="NiftiViewer-1951"><a href="#NiftiViewer-1951"><span class="linenos">1951</span></a>            <span class="c1"># Redraw updated plot on canvas</span>
</span><span id="NiftiViewer-1952"><a href="#NiftiViewer-1952"><span class="linenos">1952</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="NiftiViewer-1953"><a href="#NiftiViewer-1953"><span class="linenos">1953</span></a>
</span><span id="NiftiViewer-1954"><a href="#NiftiViewer-1954"><span class="linenos">1954</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="NiftiViewer-1955"><a href="#NiftiViewer-1955"><span class="linenos">1955</span></a>            <span class="c1"># Log error if plotting fails (e.g., index error)</span>
</span><span id="NiftiViewer-1956"><a href="#NiftiViewer-1956"><span class="linenos">1956</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating time series plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1957"><a href="#NiftiViewer-1957"><span class="linenos">1957</span></a>
</span><span id="NiftiViewer-1958"><a href="#NiftiViewer-1958"><span class="linenos">1958</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_colormap_matplotlib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">colormap_name</span><span class="p">):</span>
</span><span id="NiftiViewer-1959"><a href="#NiftiViewer-1959"><span class="linenos">1959</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply colormap using matplotlib and return QImage&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1960"><a href="#NiftiViewer-1960"><span class="linenos">1960</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NiftiViewer-1961"><a href="#NiftiViewer-1961"><span class="linenos">1961</span></a>            <span class="c1"># Retrieve selected colormap from matplotlib</span>
</span><span id="NiftiViewer-1962"><a href="#NiftiViewer-1962"><span class="linenos">1962</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap_name</span><span class="p">)</span>
</span><span id="NiftiViewer-1963"><a href="#NiftiViewer-1963"><span class="linenos">1963</span></a>
</span><span id="NiftiViewer-1964"><a href="#NiftiViewer-1964"><span class="linenos">1964</span></a>            <span class="c1"># Apply colormap to normalized image data</span>
</span><span id="NiftiViewer-1965"><a href="#NiftiViewer-1965"><span class="linenos">1965</span></a>            <span class="n">colored_data</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="NiftiViewer-1966"><a href="#NiftiViewer-1966"><span class="linenos">1966</span></a>
</span><span id="NiftiViewer-1967"><a href="#NiftiViewer-1967"><span class="linenos">1967</span></a>            <span class="k">return</span> <span class="n">colored_data</span>
</span><span id="NiftiViewer-1968"><a href="#NiftiViewer-1968"><span class="linenos">1968</span></a>
</span><span id="NiftiViewer-1969"><a href="#NiftiViewer-1969"><span class="linenos">1969</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="NiftiViewer-1970"><a href="#NiftiViewer-1970"><span class="linenos">1970</span></a>            <span class="c1"># Log errors (e.g., invalid colormap name)</span>
</span><span id="NiftiViewer-1971"><a href="#NiftiViewer-1971"><span class="linenos">1971</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error applying colormap: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-1972"><a href="#NiftiViewer-1972"><span class="linenos">1972</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="NiftiViewer-1973"><a href="#NiftiViewer-1973"><span class="linenos">1973</span></a>
</span><span id="NiftiViewer-1974"><a href="#NiftiViewer-1974"><span class="linenos">1974</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_all_displays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-1975"><a href="#NiftiViewer-1975"><span class="linenos">1975</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update all plane displays&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-1976"><a href="#NiftiViewer-1976"><span class="linenos">1976</span></a>        <span class="c1"># Loop over all 3 orthogonal views (axial, coronal, sagittal)</span>
</span><span id="NiftiViewer-1977"><a href="#NiftiViewer-1977"><span class="linenos">1977</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="NiftiViewer-1978"><a href="#NiftiViewer-1978"><span class="linenos">1978</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_display</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="NiftiViewer-1979"><a href="#NiftiViewer-1979"><span class="linenos">1979</span></a>
</span><span id="NiftiViewer-1980"><a href="#NiftiViewer-1980"><span class="linenos">1980</span></a>        <span class="c1"># If data is 4D, also update the time-series plot</span>
</span><span id="NiftiViewer-1981"><a href="#NiftiViewer-1981"><span class="linenos">1981</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="NiftiViewer-1982"><a href="#NiftiViewer-1982"><span class="linenos">1982</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_time_series_plot</span><span class="p">()</span>
</span><span id="NiftiViewer-1983"><a href="#NiftiViewer-1983"><span class="linenos">1983</span></a>
</span><span id="NiftiViewer-1984"><a href="#NiftiViewer-1984"><span class="linenos">1984</span></a>        <span class="c1"># Update slice information label in the status bar</span>
</span><span id="NiftiViewer-1985"><a href="#NiftiViewer-1985"><span class="linenos">1985</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-1986"><a href="#NiftiViewer-1986"><span class="linenos">1986</span></a>            <span class="n">spatial_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span>
</span><span id="NiftiViewer-1987"><a href="#NiftiViewer-1987"><span class="linenos">1987</span></a>            <span class="c1"># Construct slice position string for each plane (1-based indexing)</span>
</span><span id="NiftiViewer-1988"><a href="#NiftiViewer-1988"><span class="linenos">1988</span></a>            <span class="n">slice_info</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Slices&quot;</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="NiftiViewer-1989"><a href="#NiftiViewer-1989"><span class="linenos">1989</span></a>                         <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">spatial_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> | &quot;</span> \
</span><span id="NiftiViewer-1990"><a href="#NiftiViewer-1990"><span class="linenos">1990</span></a>                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">spatial_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> | &quot;</span> \
</span><span id="NiftiViewer-1991"><a href="#NiftiViewer-1991"><span class="linenos">1991</span></a>                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">spatial_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="NiftiViewer-1992"><a href="#NiftiViewer-1992"><span class="linenos">1992</span></a>            <span class="c1"># Add current time info if applicable</span>
</span><span id="NiftiViewer-1993"><a href="#NiftiViewer-1993"><span class="linenos">1993</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="NiftiViewer-1994"><a href="#NiftiViewer-1994"><span class="linenos">1994</span></a>                <span class="n">slice_info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; | &quot;</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Time&quot;</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="NiftiViewer-1995"><a href="#NiftiViewer-1995"><span class="linenos">1995</span></a>                              <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="NiftiViewer-1996"><a href="#NiftiViewer-1996"><span class="linenos">1996</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">slice_info</span><span class="p">)</span>
</span><span id="NiftiViewer-1997"><a href="#NiftiViewer-1997"><span class="linenos">1997</span></a>
</span><span id="NiftiViewer-1998"><a href="#NiftiViewer-1998"><span class="linenos">1998</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_overlay_composite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rgba_image</span><span class="p">,</span> <span class="n">overlay_slice</span><span class="p">,</span> <span class="n">colormap</span><span class="p">):</span>
</span><span id="NiftiViewer-1999"><a href="#NiftiViewer-1999"><span class="linenos">1999</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a composite image with colormap base and red overlay.&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2000"><a href="#NiftiViewer-2000"><span class="linenos">2000</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NiftiViewer-2001"><a href="#NiftiViewer-2001"><span class="linenos">2001</span></a>            <span class="c1"># Convert RGBA base image to float for blending</span>
</span><span id="NiftiViewer-2002"><a href="#NiftiViewer-2002"><span class="linenos">2002</span></a>            <span class="n">rgba_image_float</span> <span class="o">=</span> <span class="n">rgba_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1"># shape (H, W, 4)</span>
</span><span id="NiftiViewer-2003"><a href="#NiftiViewer-2003"><span class="linenos">2003</span></a>
</span><span id="NiftiViewer-2004"><a href="#NiftiViewer-2004"><span class="linenos">2004</span></a>            <span class="k">if</span> <span class="n">overlay_slice</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NiftiViewer-2005"><a href="#NiftiViewer-2005"><span class="linenos">2005</span></a>
</span><span id="NiftiViewer-2006"><a href="#NiftiViewer-2006"><span class="linenos">2006</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">overlay_slice</span><span class="p">):</span>
</span><span id="NiftiViewer-2007"><a href="#NiftiViewer-2007"><span class="linenos">2007</span></a>                    <span class="c1"># Apply transparency scaling (based on user alpha)</span>
</span><span id="NiftiViewer-2008"><a href="#NiftiViewer-2008"><span class="linenos">2008</span></a>                    <span class="n">overlay_intensity</span> <span class="o">=</span> <span class="n">overlay_slice</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha</span>
</span><span id="NiftiViewer-2009"><a href="#NiftiViewer-2009"><span class="linenos">2009</span></a>
</span><span id="NiftiViewer-2010"><a href="#NiftiViewer-2010"><span class="linenos">2010</span></a>                    <span class="c1"># Retrieve overlay color from dictionary or default (green)</span>
</span><span id="NiftiViewer-2011"><a href="#NiftiViewer-2011"><span class="linenos">2011</span></a>                    <span class="n">overlay_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]))</span>
</span><span id="NiftiViewer-2012"><a href="#NiftiViewer-2012"><span class="linenos">2012</span></a>
</span><span id="NiftiViewer-2013"><a href="#NiftiViewer-2013"><span class="linenos">2013</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Blending overlay color into base image&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2014"><a href="#NiftiViewer-2014"><span class="linenos">2014</span></a>                    <span class="c1"># Blend overlay into base image using a numba-accelerated function</span>
</span><span id="NiftiViewer-2015"><a href="#NiftiViewer-2015"><span class="linenos">2015</span></a>                    <span class="n">rgba_image_float</span> <span class="o">=</span> <span class="n">apply_overlay_numba</span><span class="p">(</span><span class="n">rgba_image</span><span class="p">,</span> <span class="n">overlay_slice</span><span class="p">,</span>
</span><span id="NiftiViewer-2016"><a href="#NiftiViewer-2016"><span class="linenos">2016</span></a>                                                           <span class="n">overlay_intensity</span><span class="p">,</span> <span class="n">overlay_color</span><span class="p">)</span>
</span><span id="NiftiViewer-2017"><a href="#NiftiViewer-2017"><span class="linenos">2017</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Blended overlay color into base image&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2018"><a href="#NiftiViewer-2018"><span class="linenos">2018</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Clipping values to a valid range&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2019"><a href="#NiftiViewer-2019"><span class="linenos">2019</span></a>            <span class="c1"># Clip values to valid range [0, 1]</span>
</span><span id="NiftiViewer-2020"><a href="#NiftiViewer-2020"><span class="linenos">2020</span></a>            <span class="n">rgba_image_overlay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rgba_image_float</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer-2021"><a href="#NiftiViewer-2021"><span class="linenos">2021</span></a>
</span><span id="NiftiViewer-2022"><a href="#NiftiViewer-2022"><span class="linenos">2022</span></a>            <span class="k">return</span> <span class="n">rgba_image_overlay</span>
</span><span id="NiftiViewer-2023"><a href="#NiftiViewer-2023"><span class="linenos">2023</span></a>
</span><span id="NiftiViewer-2024"><a href="#NiftiViewer-2024"><span class="linenos">2024</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="NiftiViewer-2025"><a href="#NiftiViewer-2025"><span class="linenos">2025</span></a>            <span class="c1"># Log errors and return unmodified base image as fallback</span>
</span><span id="NiftiViewer-2026"><a href="#NiftiViewer-2026"><span class="linenos">2026</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating overlay composite: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2027"><a href="#NiftiViewer-2027"><span class="linenos">2027</span></a>            <span class="k">return</span> <span class="n">rgba_image</span>
</span><span id="NiftiViewer-2028"><a href="#NiftiViewer-2028"><span class="linenos">2028</span></a>
</span><span id="NiftiViewer-2029"><a href="#NiftiViewer-2029"><span class="linenos">2029</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">resizeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">QResizeEvent</span><span class="p">):</span>
</span><span id="NiftiViewer-2030"><a href="#NiftiViewer-2030"><span class="linenos">2030</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle window resize to maintain aspect ratios&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2031"><a href="#NiftiViewer-2031"><span class="linenos">2031</span></a>        <span class="c1"># Call parent resize handler</span>
</span><span id="NiftiViewer-2032"><a href="#NiftiViewer-2032"><span class="linenos">2032</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">resizeEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="NiftiViewer-2033"><a href="#NiftiViewer-2033"><span class="linenos">2033</span></a>        <span class="c1"># Refit all 2D slice views after short delay to prevent flickering</span>
</span><span id="NiftiViewer-2034"><a href="#NiftiViewer-2034"><span class="linenos">2034</span></a>        <span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_all_views</span><span class="p">)</span>
</span><span id="NiftiViewer-2035"><a href="#NiftiViewer-2035"><span class="linenos">2035</span></a>
</span><span id="NiftiViewer-2036"><a href="#NiftiViewer-2036"><span class="linenos">2036</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit_all_views</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-2037"><a href="#NiftiViewer-2037"><span class="linenos">2037</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit all views to their scenes while maintaining aspect ratio&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2038"><a href="#NiftiViewer-2038"><span class="linenos">2038</span></a>        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">:</span>
</span><span id="NiftiViewer-2039"><a href="#NiftiViewer-2039"><span class="linenos">2039</span></a>            <span class="k">if</span> <span class="n">view</span><span class="o">.</span><span class="n">scene</span><span class="p">():</span>
</span><span id="NiftiViewer-2040"><a href="#NiftiViewer-2040"><span class="linenos">2040</span></a>                <span class="c1"># Adjust zoom to fit entire image in view with correct aspect ratio</span>
</span><span id="NiftiViewer-2041"><a href="#NiftiViewer-2041"><span class="linenos">2041</span></a>                <span class="n">view</span><span class="o">.</span><span class="n">fitInView</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">scene</span><span class="p">()</span><span class="o">.</span><span class="n">sceneRect</span><span class="p">(),</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AspectRatioMode</span><span class="o">.</span><span class="n">KeepAspectRatio</span><span class="p">)</span>
</span><span id="NiftiViewer-2042"><a href="#NiftiViewer-2042"><span class="linenos">2042</span></a>
</span><span id="NiftiViewer-2043"><a href="#NiftiViewer-2043"><span class="linenos">2043</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_automaticROI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-2044"><a href="#NiftiViewer-2044"><span class="linenos">2044</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the automatic ROI overlay dynamically when parameters change&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2045"><a href="#NiftiViewer-2045"><span class="linenos">2045</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span><span class="p">:</span>
</span><span id="NiftiViewer-2046"><a href="#NiftiViewer-2046"><span class="linenos">2046</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_drawing</span><span class="p">()</span>
</span><span id="NiftiViewer-2047"><a href="#NiftiViewer-2047"><span class="linenos">2047</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-2048"><a href="#NiftiViewer-2048"><span class="linenos">2048</span></a>
</span><span id="NiftiViewer-2049"><a href="#NiftiViewer-2049"><span class="linenos">2049</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">automaticROI_clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-2050"><a href="#NiftiViewer-2050"><span class="linenos">2050</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle click on &#39;Automatic ROI&#39; button to start or reset the ROI tool&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2051"><a href="#NiftiViewer-2051"><span class="linenos">2051</span></a>        <span class="c1"># Save current voxel coordinates as ROI seed point</span>
</span><span id="NiftiViewer-2052"><a href="#NiftiViewer-2052"><span class="linenos">2052</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_seed_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span>
</span><span id="NiftiViewer-2053"><a href="#NiftiViewer-2053"><span class="linenos">2053</span></a>
</span><span id="NiftiViewer-2054"><a href="#NiftiViewer-2054"><span class="linenos">2054</span></a>        <span class="c1"># Compute the maximum allowed ROI radius in millimeters</span>
</span><span id="NiftiViewer-2055"><a href="#NiftiViewer-2055"><span class="linenos">2055</span></a>        <span class="n">dims_voxel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># voxel counts along X, Y, Z</span>
</span><span id="NiftiViewer-2056"><a href="#NiftiViewer-2056"><span class="linenos">2056</span></a>        <span class="n">dims_mm</span> <span class="o">=</span> <span class="n">dims_voxel</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span>  <span class="c1"># real-world dimensions in mm</span>
</span><span id="NiftiViewer-2057"><a href="#NiftiViewer-2057"><span class="linenos">2057</span></a>        <span class="n">max_radius_mm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dims_mm</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># use half of shortest image dimension</span>
</span><span id="NiftiViewer-2058"><a href="#NiftiViewer-2058"><span class="linenos">2058</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_radius_mm</span><span class="p">))</span>
</span><span id="NiftiViewer-2059"><a href="#NiftiViewer-2059"><span class="linenos">2059</span></a>
</span><span id="NiftiViewer-2060"><a href="#NiftiViewer-2060"><span class="linenos">2060</span></a>        <span class="c1"># Initialize radius slider (32 mm default for new ROI)</span>
</span><span id="NiftiViewer-2061"><a href="#NiftiViewer-2061"><span class="linenos">2061</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span>
</span><span id="NiftiViewer-2062"><a href="#NiftiViewer-2062"><span class="linenos">2062</span></a>            <span class="mi">32</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
</span><span id="NiftiViewer-2063"><a href="#NiftiViewer-2063"><span class="linenos">2063</span></a>        <span class="p">)</span>
</span><span id="NiftiViewer-2064"><a href="#NiftiViewer-2064"><span class="linenos">2064</span></a>
</span><span id="NiftiViewer-2065"><a href="#NiftiViewer-2065"><span class="linenos">2065</span></a>        <span class="c1"># Initialize difference (intensity tolerance) slider</span>
</span><span id="NiftiViewer-2066"><a href="#NiftiViewer-2066"><span class="linenos">2066</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="NiftiViewer-2067"><a href="#NiftiViewer-2067"><span class="linenos">2067</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span>
</span><span id="NiftiViewer-2068"><a href="#NiftiViewer-2068"><span class="linenos">2068</span></a>            <span class="nb">int</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
</span><span id="NiftiViewer-2069"><a href="#NiftiViewer-2069"><span class="linenos">2069</span></a>        <span class="p">)</span>
</span><span id="NiftiViewer-2070"><a href="#NiftiViewer-2070"><span class="linenos">2070</span></a>
</span><span id="NiftiViewer-2071"><a href="#NiftiViewer-2071"><span class="linenos">2071</span></a>        <span class="c1"># Show and enable ROI parameter controls</span>
</span><span id="NiftiViewer-2072"><a href="#NiftiViewer-2072"><span class="linenos">2072</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-2073"><a href="#NiftiViewer-2073"><span class="linenos">2073</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-2074"><a href="#NiftiViewer-2074"><span class="linenos">2074</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Reset Origin&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2075"><a href="#NiftiViewer-2075"><span class="linenos">2075</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="NiftiViewer-2076"><a href="#NiftiViewer-2076"><span class="linenos">2076</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-2077"><a href="#NiftiViewer-2077"><span class="linenos">2077</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-2078"><a href="#NiftiViewer-2078"><span class="linenos">2078</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-2079"><a href="#NiftiViewer-2079"><span class="linenos">2079</span></a>
</span><span id="NiftiViewer-2080"><a href="#NiftiViewer-2080"><span class="linenos">2080</span></a>        <span class="c1"># Generate initial automatic ROI mask</span>
</span><span id="NiftiViewer-2081"><a href="#NiftiViewer-2081"><span class="linenos">2081</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_drawing</span><span class="p">()</span>
</span><span id="NiftiViewer-2082"><a href="#NiftiViewer-2082"><span class="linenos">2082</span></a>
</span><span id="NiftiViewer-2083"><a href="#NiftiViewer-2083"><span class="linenos">2083</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-2084"><a href="#NiftiViewer-2084"><span class="linenos">2084</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-2085"><a href="#NiftiViewer-2085"><span class="linenos">2085</span></a>        <span class="c1"># Ensure overlay display is active</span>
</span><span id="NiftiViewer-2086"><a href="#NiftiViewer-2086"><span class="linenos">2086</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_automaticROI</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-2087"><a href="#NiftiViewer-2087"><span class="linenos">2087</span></a>        <span class="c1">#self.overlay_checkbox.setChecked(True)</span>
</span><span id="NiftiViewer-2088"><a href="#NiftiViewer-2088"><span class="linenos">2088</span></a>        <span class="c1">#self.overlay_checkbox.setEnabled(True)</span>
</span><span id="NiftiViewer-2089"><a href="#NiftiViewer-2089"><span class="linenos">2089</span></a>
</span><span id="NiftiViewer-2090"><a href="#NiftiViewer-2090"><span class="linenos">2090</span></a>        <span class="c1"># Refresh all displays</span>
</span><span id="NiftiViewer-2091"><a href="#NiftiViewer-2091"><span class="linenos">2091</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-2092"><a href="#NiftiViewer-2092"><span class="linenos">2092</span></a>
</span><span id="NiftiViewer-2093"><a href="#NiftiViewer-2093"><span class="linenos">2093</span></a>
</span><span id="NiftiViewer-2094"><a href="#NiftiViewer-2094"><span class="linenos">2094</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_automaticROI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="NiftiViewer-2095"><a href="#NiftiViewer-2095"><span class="linenos">2095</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2096"><a href="#NiftiViewer-2096"><span class="linenos">2096</span></a><span class="sd">        Enable or disable the overlay for the automatic ROI on top of the base image.</span>
</span><span id="NiftiViewer-2097"><a href="#NiftiViewer-2097"><span class="linenos">2097</span></a>
</span><span id="NiftiViewer-2098"><a href="#NiftiViewer-2098"><span class="linenos">2098</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-2099"><a href="#NiftiViewer-2099"><span class="linenos">2099</span></a><span class="sd">            enabled (bool): Whether to enable (True) or disable (False) the overlay display.</span>
</span><span id="NiftiViewer-2100"><a href="#NiftiViewer-2100"><span class="linenos">2100</span></a>
</span><span id="NiftiViewer-2101"><a href="#NiftiViewer-2101"><span class="linenos">2101</span></a><span class="sd">        Behavior:</span>
</span><span id="NiftiViewer-2102"><a href="#NiftiViewer-2102"><span class="linenos">2102</span></a><span class="sd">            - Toggles transparency and threshold controls.</span>
</span><span id="NiftiViewer-2103"><a href="#NiftiViewer-2103"><span class="linenos">2103</span></a><span class="sd">            - Refreshes all active views if overlay data exists.</span>
</span><span id="NiftiViewer-2104"><a href="#NiftiViewer-2104"><span class="linenos">2104</span></a>
</span><span id="NiftiViewer-2105"><a href="#NiftiViewer-2105"><span class="linenos">2105</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer-2106"><a href="#NiftiViewer-2106"><span class="linenos">2106</span></a><span class="sd">            None</span>
</span><span id="NiftiViewer-2107"><a href="#NiftiViewer-2107"><span class="linenos">2107</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2108"><a href="#NiftiViewer-2108"><span class="linenos">2108</span></a>
</span><span id="NiftiViewer-2109"><a href="#NiftiViewer-2109"><span class="linenos">2109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-2110"><a href="#NiftiViewer-2110"><span class="linenos">2110</span></a>        <span class="c1"># Update internal overlay state</span>
</span><span id="NiftiViewer-2111"><a href="#NiftiViewer-2111"><span class="linenos">2111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="o">=</span> <span class="n">enabled</span>
</span><span id="NiftiViewer-2112"><a href="#NiftiViewer-2112"><span class="linenos">2112</span></a>        <span class="c1"># Enable or disable overlay-related UI controls</span>
</span><span id="NiftiViewer-2113"><a href="#NiftiViewer-2113"><span class="linenos">2113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-2114"><a href="#NiftiViewer-2114"><span class="linenos">2114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-2115"><a href="#NiftiViewer-2115"><span class="linenos">2115</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-2116"><a href="#NiftiViewer-2116"><span class="linenos">2116</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-2117"><a href="#NiftiViewer-2117"><span class="linenos">2117</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-2118"><a href="#NiftiViewer-2118"><span class="linenos">2118</span></a>
</span><span id="NiftiViewer-2119"><a href="#NiftiViewer-2119"><span class="linenos">2119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-2120"><a href="#NiftiViewer-2120"><span class="linenos">2120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-2121"><a href="#NiftiViewer-2121"><span class="linenos">2121</span></a>
</span><span id="NiftiViewer-2122"><a href="#NiftiViewer-2122"><span class="linenos">2122</span></a>        <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="NiftiViewer-2123"><a href="#NiftiViewer-2123"><span class="linenos">2123</span></a>            <span class="c1"># Redraw display if overlay data is available</span>
</span><span id="NiftiViewer-2124"><a href="#NiftiViewer-2124"><span class="linenos">2124</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-2125"><a href="#NiftiViewer-2125"><span class="linenos">2125</span></a>
</span><span id="NiftiViewer-2126"><a href="#NiftiViewer-2126"><span class="linenos">2126</span></a>            <span class="c1"># Update time series plot if available</span>
</span><span id="NiftiViewer-2127"><a href="#NiftiViewer-2127"><span class="linenos">2127</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_time_series_plot</span><span class="p">()</span>
</span><span id="NiftiViewer-2128"><a href="#NiftiViewer-2128"><span class="linenos">2128</span></a>
</span><span id="NiftiViewer-2129"><a href="#NiftiViewer-2129"><span class="linenos">2129</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">automaticROI_drawing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-2130"><a href="#NiftiViewer-2130"><span class="linenos">2130</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate automatic ROI mask around selected seed voxel&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2131"><a href="#NiftiViewer-2131"><span class="linenos">2131</span></a>        <span class="n">radius_mm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>  <span class="c1"># ROI radius in mm</span>
</span><span id="NiftiViewer-2132"><a href="#NiftiViewer-2132"><span class="linenos">2132</span></a>        <span class="n">difference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span>  <span class="c1"># intensity tolerance</span>
</span><span id="NiftiViewer-2133"><a href="#NiftiViewer-2133"><span class="linenos">2133</span></a>        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_seed_coordinates</span>  <span class="c1"># seed voxel coordinates</span>
</span><span id="NiftiViewer-2134"><a href="#NiftiViewer-2134"><span class="linenos">2134</span></a>
</span><span id="NiftiViewer-2135"><a href="#NiftiViewer-2135"><span class="linenos">2135</span></a>        <span class="c1"># Select proper 3D volume if data is 4D</span>
</span><span id="NiftiViewer-2136"><a href="#NiftiViewer-2136"><span class="linenos">2136</span></a>        <span class="n">img_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span>
</span><span id="NiftiViewer-2137"><a href="#NiftiViewer-2137"><span class="linenos">2137</span></a>
</span><span id="NiftiViewer-2138"><a href="#NiftiViewer-2138"><span class="linenos">2138</span></a>        <span class="c1"># Intensity value at the seed voxel</span>
</span><span id="NiftiViewer-2139"><a href="#NiftiViewer-2139"><span class="linenos">2139</span></a>        <span class="n">seed_intensity</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">]</span>
</span><span id="NiftiViewer-2140"><a href="#NiftiViewer-2140"><span class="linenos">2140</span></a>
</span><span id="NiftiViewer-2141"><a href="#NiftiViewer-2141"><span class="linenos">2141</span></a>        <span class="c1"># Convert radius in mm to radius in voxel units per axis</span>
</span><span id="NiftiViewer-2142"><a href="#NiftiViewer-2142"><span class="linenos">2142</span></a>        <span class="n">rx_vox</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">radius_mm</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="NiftiViewer-2143"><a href="#NiftiViewer-2143"><span class="linenos">2143</span></a>        <span class="n">ry_vox</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">radius_mm</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="NiftiViewer-2144"><a href="#NiftiViewer-2144"><span class="linenos">2144</span></a>        <span class="n">rz_vox</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">radius_mm</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span><span id="NiftiViewer-2145"><a href="#NiftiViewer-2145"><span class="linenos">2145</span></a>
</span><span id="NiftiViewer-2146"><a href="#NiftiViewer-2146"><span class="linenos">2146</span></a>        <span class="c1"># Compute subvolume limits (ROI bounding box)</span>
</span><span id="NiftiViewer-2147"><a href="#NiftiViewer-2147"><span class="linenos">2147</span></a>        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">rx_vox</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">rx_vox</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer-2148"><a href="#NiftiViewer-2148"><span class="linenos">2148</span></a>        <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">ry_vox</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">ry_vox</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer-2149"><a href="#NiftiViewer-2149"><span class="linenos">2149</span></a>        <span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">-</span> <span class="n">rz_vox</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">rz_vox</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer-2150"><a href="#NiftiViewer-2150"><span class="linenos">2150</span></a>
</span><span id="NiftiViewer-2151"><a href="#NiftiViewer-2151"><span class="linenos">2151</span></a>        <span class="c1"># Compute ROI mask using parallelized Numba function</span>
</span><span id="NiftiViewer-2152"><a href="#NiftiViewer-2152"><span class="linenos">2152</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">compute_mask_numba_mm</span><span class="p">(</span><span class="n">img_data</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span>
</span><span id="NiftiViewer-2153"><a href="#NiftiViewer-2153"><span class="linenos">2153</span></a>                                     <span class="n">radius_mm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">,</span>
</span><span id="NiftiViewer-2154"><a href="#NiftiViewer-2154"><span class="linenos">2154</span></a>                                     <span class="n">seed_intensity</span><span class="p">,</span> <span class="n">difference</span><span class="p">,</span>
</span><span id="NiftiViewer-2155"><a href="#NiftiViewer-2155"><span class="linenos">2155</span></a>                                     <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span><span class="p">)</span>
</span><span id="NiftiViewer-2156"><a href="#NiftiViewer-2156"><span class="linenos">2156</span></a>
</span><span id="NiftiViewer-2157"><a href="#NiftiViewer-2157"><span class="linenos">2157</span></a>        <span class="c1"># Store result as overlay for visualization</span>
</span><span id="NiftiViewer-2158"><a href="#NiftiViewer-2158"><span class="linenos">2158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="o">=</span> <span class="n">mask</span>
</span><span id="NiftiViewer-2159"><a href="#NiftiViewer-2159"><span class="linenos">2159</span></a>
</span><span id="NiftiViewer-2160"><a href="#NiftiViewer-2160"><span class="linenos">2160</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ROI_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-2161"><a href="#NiftiViewer-2161"><span class="linenos">2161</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the automatically generated ROI mask to disk&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2162"><a href="#NiftiViewer-2162"><span class="linenos">2162</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Saving ROI mask to disk&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2163"><a href="#NiftiViewer-2163"><span class="linenos">2163</span></a>        <span class="n">original_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span>
</span><span id="NiftiViewer-2164"><a href="#NiftiViewer-2164"><span class="linenos">2164</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">original_path</span><span class="p">:</span>
</span><span id="NiftiViewer-2165"><a href="#NiftiViewer-2165"><span class="linenos">2165</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;No file loaded.&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2166"><a href="#NiftiViewer-2166"><span class="linenos">2166</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;No file loaded&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2167"><a href="#NiftiViewer-2167"><span class="linenos">2167</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer-2168"><a href="#NiftiViewer-2168"><span class="linenos">2168</span></a>        <span class="c1"># Retrieve workspace path from context</span>
</span><span id="NiftiViewer-2169"><a href="#NiftiViewer-2169"><span class="linenos">2169</span></a>        <span class="n">workspace_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workspace_path&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2170"><a href="#NiftiViewer-2170"><span class="linenos">2170</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">workspace_path</span><span class="p">:</span>
</span><span id="NiftiViewer-2171"><a href="#NiftiViewer-2171"><span class="linenos">2171</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;Workspace path is not set.&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2172"><a href="#NiftiViewer-2172"><span class="linenos">2172</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Workspace path not set&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2173"><a href="#NiftiViewer-2173"><span class="linenos">2173</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer-2174"><a href="#NiftiViewer-2174"><span class="linenos">2174</span></a>
</span><span id="NiftiViewer-2175"><a href="#NiftiViewer-2175"><span class="linenos">2175</span></a>        <span class="c1"># Try to infer subject identifier (sub-XX) from relative file path</span>
</span><span id="NiftiViewer-2176"><a href="#NiftiViewer-2176"><span class="linenos">2176</span></a>        <span class="n">relative_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">original_path</span><span class="p">,</span> <span class="n">workspace_path</span><span class="p">)</span>
</span><span id="NiftiViewer-2177"><a href="#NiftiViewer-2177"><span class="linenos">2177</span></a>        <span class="n">parts</span> <span class="o">=</span> <span class="n">relative_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
</span><span id="NiftiViewer-2178"><a href="#NiftiViewer-2178"><span class="linenos">2178</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NiftiViewer-2179"><a href="#NiftiViewer-2179"><span class="linenos">2179</span></a>            <span class="n">subject</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">part</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span> <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sub-&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2180"><a href="#NiftiViewer-2180"><span class="linenos">2180</span></a>        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
</span><span id="NiftiViewer-2181"><a href="#NiftiViewer-2181"><span class="linenos">2181</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;Could not determine subject from path.&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2182"><a href="#NiftiViewer-2182"><span class="linenos">2182</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not determine subject from path.&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2183"><a href="#NiftiViewer-2183"><span class="linenos">2183</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer-2184"><a href="#NiftiViewer-2184"><span class="linenos">2184</span></a>
</span><span id="NiftiViewer-2185"><a href="#NiftiViewer-2185"><span class="linenos">2185</span></a>
</span><span id="NiftiViewer-2186"><a href="#NiftiViewer-2186"><span class="linenos">2186</span></a>        <span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workspace_path</span><span class="p">,</span> <span class="s2">&quot;derivatives&quot;</span><span class="p">,</span> <span class="s2">&quot;manual_masks&quot;</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;anat&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2187"><a href="#NiftiViewer-2187"><span class="linenos">2187</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Save dir: </span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2188"><a href="#NiftiViewer-2188"><span class="linenos">2188</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">original_path</span><span class="p">)</span>
</span><span id="NiftiViewer-2189"><a href="#NiftiViewer-2189"><span class="linenos">2189</span></a>        <span class="n">base_name</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nii.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nii&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2190"><a href="#NiftiViewer-2190"><span class="linenos">2190</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base filename: </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2191"><a href="#NiftiViewer-2191"><span class="linenos">2191</span></a>        <span class="c1"># Prepare filenames and output paths</span>
</span><span id="NiftiViewer-2192"><a href="#NiftiViewer-2192"><span class="linenos">2192</span></a>        <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_next_file_id</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="NiftiViewer-2193"><a href="#NiftiViewer-2193"><span class="linenos">2193</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Obtained version: </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2194"><a href="#NiftiViewer-2194"><span class="linenos">2194</span></a>        <span class="n">new_base</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_ROI_v</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">_mask&quot;</span>
</span><span id="NiftiViewer-2195"><a href="#NiftiViewer-2195"><span class="linenos">2195</span></a>        <span class="n">new_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_base</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span>
</span><span id="NiftiViewer-2196"><a href="#NiftiViewer-2196"><span class="linenos">2196</span></a>
</span><span id="NiftiViewer-2197"><a href="#NiftiViewer-2197"><span class="linenos">2197</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Show confirmation dialog&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2198"><a href="#NiftiViewer-2198"><span class="linenos">2198</span></a>        <span class="c1"># Show confirmation dialog before saving</span>
</span><span id="NiftiViewer-2199"><a href="#NiftiViewer-2199"><span class="linenos">2199</span></a>        <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="NiftiViewer-2200"><a href="#NiftiViewer-2200"><span class="linenos">2200</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Icon</span><span class="o">.</span><span class="n">Question</span><span class="p">)</span>
</span><span id="NiftiViewer-2201"><a href="#NiftiViewer-2201"><span class="linenos">2201</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Confirm Save&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2202"><a href="#NiftiViewer-2202"><span class="linenos">2202</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Do you want to save the automatic ROI?&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2203"><a href="#NiftiViewer-2203"><span class="linenos">2203</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setInformativeText</span><span class="p">(</span>
</span><span id="NiftiViewer-2204"><a href="#NiftiViewer-2204"><span class="linenos">2204</span></a>            <span class="sa">f</span><span class="s2">&quot;File will be saved as:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="NiftiViewer-2205"><a href="#NiftiViewer-2205"><span class="linenos">2205</span></a>            <span class="sa">f</span><span class="s2">&quot;Location:</span><span class="se">\n</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="NiftiViewer-2206"><a href="#NiftiViewer-2206"><span class="linenos">2206</span></a>        <span class="p">)</span>
</span><span id="NiftiViewer-2207"><a href="#NiftiViewer-2207"><span class="linenos">2207</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span><span class="p">)</span>
</span><span id="NiftiViewer-2208"><a href="#NiftiViewer-2208"><span class="linenos">2208</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setDefaultButton</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span><span class="p">)</span>
</span><span id="NiftiViewer-2209"><a href="#NiftiViewer-2209"><span class="linenos">2209</span></a>
</span><span id="NiftiViewer-2210"><a href="#NiftiViewer-2210"><span class="linenos">2210</span></a>        <span class="c1"># Wait for user response</span>
</span><span id="NiftiViewer-2211"><a href="#NiftiViewer-2211"><span class="linenos">2211</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
</span><span id="NiftiViewer-2212"><a href="#NiftiViewer-2212"><span class="linenos">2212</span></a>        <span class="k">if</span> <span class="n">response</span> <span class="o">!=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
</span><span id="NiftiViewer-2213"><a href="#NiftiViewer-2213"><span class="linenos">2213</span></a>            <span class="k">return</span>  <span class="c1"># User canceled</span>
</span><span id="NiftiViewer-2214"><a href="#NiftiViewer-2214"><span class="linenos">2214</span></a>
</span><span id="NiftiViewer-2215"><a href="#NiftiViewer-2215"><span class="linenos">2215</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Make dir&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2216"><a href="#NiftiViewer-2216"><span class="linenos">2216</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-2217"><a href="#NiftiViewer-2217"><span class="linenos">2217</span></a>        <span class="n">full_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
</span><span id="NiftiViewer-2218"><a href="#NiftiViewer-2218"><span class="linenos">2218</span></a>        <span class="n">json_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_base</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2219"><a href="#NiftiViewer-2219"><span class="linenos">2219</span></a>
</span><span id="NiftiViewer-2220"><a href="#NiftiViewer-2220"><span class="linenos">2220</span></a>        <span class="n">origin_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="NiftiViewer-2221"><a href="#NiftiViewer-2221"><span class="linenos">2221</span></a>
</span><span id="NiftiViewer-2222"><a href="#NiftiViewer-2222"><span class="linenos">2222</span></a>        <span class="n">total_ROI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="NiftiViewer-2223"><a href="#NiftiViewer-2223"><span class="linenos">2223</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-2224"><a href="#NiftiViewer-2224"><span class="linenos">2224</span></a>            <span class="n">total_ROI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span><span class="p">,</span> <span class="n">total_ROI</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="NiftiViewer-2225"><a href="#NiftiViewer-2225"><span class="linenos">2225</span></a>            <span class="n">origin_dict</span><span class="p">[</span><span class="s2">&quot;Original overlay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_file_path</span>
</span><span id="NiftiViewer-2226"><a href="#NiftiViewer-2226"><span class="linenos">2226</span></a>            <span class="n">origin_dict</span><span class="p">[</span><span class="s2">&quot;Original overlay threshold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span>
</span><span id="NiftiViewer-2227"><a href="#NiftiViewer-2227"><span class="linenos">2227</span></a>            
</span><span id="NiftiViewer-2228"><a href="#NiftiViewer-2228"><span class="linenos">2228</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">:</span>
</span><span id="NiftiViewer-2229"><a href="#NiftiViewer-2229"><span class="linenos">2229</span></a>            <span class="n">total_ROI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span><span class="p">,</span><span class="n">total_ROI</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="NiftiViewer-2230"><a href="#NiftiViewer-2230"><span class="linenos">2230</span></a>            <span class="n">origin_dict</span><span class="p">[</span><span class="s2">&quot;Automatic drawing parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_origins</span>
</span><span id="NiftiViewer-2231"><a href="#NiftiViewer-2231"><span class="linenos">2231</span></a>
</span><span id="NiftiViewer-2232"><a href="#NiftiViewer-2232"><span class="linenos">2232</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span><span class="p">:</span>
</span><span id="NiftiViewer-2233"><a href="#NiftiViewer-2233"><span class="linenos">2233</span></a>            <span class="n">total_ROI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span><span class="p">,</span> <span class="n">total_ROI</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="NiftiViewer-2234"><a href="#NiftiViewer-2234"><span class="linenos">2234</span></a>            <span class="n">new_params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="NiftiViewer-2235"><a href="#NiftiViewer-2235"><span class="linenos">2235</span></a>                <span class="s2">&quot;Seed&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_seed_coordinates</span><span class="p">),</span>  <span class="c1"># assicurati che sia JSON-safe</span>
</span><span id="NiftiViewer-2236"><a href="#NiftiViewer-2236"><span class="linenos">2236</span></a>                <span class="s2">&quot;Radius&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
</span><span id="NiftiViewer-2237"><a href="#NiftiViewer-2237"><span class="linenos">2237</span></a>                <span class="s2">&quot;Difference&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
</span><span id="NiftiViewer-2238"><a href="#NiftiViewer-2238"><span class="linenos">2238</span></a>            <span class="p">}</span>
</span><span id="NiftiViewer-2239"><a href="#NiftiViewer-2239"><span class="linenos">2239</span></a>            <span class="k">if</span> <span class="s2">&quot;Automatic drawing parameters&quot;</span> <span class="ow">in</span> <span class="n">origin_dict</span><span class="p">:</span>
</span><span id="NiftiViewer-2240"><a href="#NiftiViewer-2240"><span class="linenos">2240</span></a>                <span class="n">origin_dict</span><span class="p">[</span><span class="s2">&quot;Automatic drawing parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>
</span><span id="NiftiViewer-2241"><a href="#NiftiViewer-2241"><span class="linenos">2241</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-2242"><a href="#NiftiViewer-2242"><span class="linenos">2242</span></a>                <span class="n">origin_dict</span><span class="p">[</span><span class="s2">&quot;Automatic drawing parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_params</span><span class="p">]</span>
</span><span id="NiftiViewer-2243"><a href="#NiftiViewer-2243"><span class="linenos">2243</span></a>
</span><span id="NiftiViewer-2244"><a href="#NiftiViewer-2244"><span class="linenos">2244</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Start thread&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2245"><a href="#NiftiViewer-2245"><span class="linenos">2245</span></a>        <span class="c1"># Start threaded save operation</span>
</span><span id="NiftiViewer-2246"><a href="#NiftiViewer-2246"><span class="linenos">2246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SaveNiftiThread</span><span class="p">(</span><span class="n">total_ROI</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span>
</span><span id="NiftiViewer-2247"><a href="#NiftiViewer-2247"><span class="linenos">2247</span></a>                                            <span class="n">full_save_path</span><span class="p">,</span> <span class="n">json_save_path</span><span class="p">,</span>
</span><span id="NiftiViewer-2248"><a href="#NiftiViewer-2248"><span class="linenos">2248</span></a>                                            <span class="n">relative_path</span><span class="p">,</span> <span class="n">origin_dict</span><span class="p">))</span>
</span><span id="NiftiViewer-2249"><a href="#NiftiViewer-2249"><span class="linenos">2249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">success</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_ROI_saved</span><span class="p">)</span>
</span><span id="NiftiViewer-2250"><a href="#NiftiViewer-2250"><span class="linenos">2250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_ROI_saving_error</span><span class="p">)</span>
</span><span id="NiftiViewer-2251"><a href="#NiftiViewer-2251"><span class="linenos">2251</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="NiftiViewer-2252"><a href="#NiftiViewer-2252"><span class="linenos">2252</span></a>
</span><span id="NiftiViewer-2253"><a href="#NiftiViewer-2253"><span class="linenos">2253</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_on_ROI_saved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">json_path</span><span class="p">):</span>
</span><span id="NiftiViewer-2254"><a href="#NiftiViewer-2254"><span class="linenos">2254</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback executed when ROI save completes successfully&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2255"><a href="#NiftiViewer-2255"><span class="linenos">2255</span></a>        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="NiftiViewer-2256"><a href="#NiftiViewer-2256"><span class="linenos">2256</span></a>                                <span class="s2">&quot;ROI Saved&quot;</span><span class="p">,</span>
</span><span id="NiftiViewer-2257"><a href="#NiftiViewer-2257"><span class="linenos">2257</span></a>                                <span class="sa">f</span><span class="s2">&quot;ROI saved in:</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> and metadata saved in:</span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2"> successfully!&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2258"><a href="#NiftiViewer-2258"><span class="linenos">2258</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROI saved in:</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> and metadata saved in:</span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2"> successfully!&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2259"><a href="#NiftiViewer-2259"><span class="linenos">2259</span></a>
</span><span id="NiftiViewer-2260"><a href="#NiftiViewer-2260"><span class="linenos">2260</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_on_ROI_saving_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
</span><span id="NiftiViewer-2261"><a href="#NiftiViewer-2261"><span class="linenos">2261</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback executed when ROI saving fails&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2262"><a href="#NiftiViewer-2262"><span class="linenos">2262</span></a>        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
</span><span id="NiftiViewer-2263"><a href="#NiftiViewer-2263"><span class="linenos">2263</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="NiftiViewer-2264"><a href="#NiftiViewer-2264"><span class="linenos">2264</span></a>            <span class="s2">&quot;Error when saving ROI&quot;</span><span class="p">,</span>
</span><span id="NiftiViewer-2265"><a href="#NiftiViewer-2265"><span class="linenos">2265</span></a>            <span class="sa">f</span><span class="s2">&quot;Error when saving: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="NiftiViewer-2266"><a href="#NiftiViewer-2266"><span class="linenos">2266</span></a>        <span class="p">)</span>
</span><span id="NiftiViewer-2267"><a href="#NiftiViewer-2267"><span class="linenos">2267</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error when saving ROI: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2268"><a href="#NiftiViewer-2268"><span class="linenos">2268</span></a>
</span><span id="NiftiViewer-2269"><a href="#NiftiViewer-2269"><span class="linenos">2269</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_next_file_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">folder_path</span><span class="p">):</span>
</span><span id="NiftiViewer-2270"><a href="#NiftiViewer-2270"><span class="linenos">2270</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2271"><a href="#NiftiViewer-2271"><span class="linenos">2271</span></a><span class="sd">        Generates the next available numeric ID based on the files present in the folder.</span>
</span><span id="NiftiViewer-2272"><a href="#NiftiViewer-2272"><span class="linenos">2272</span></a>
</span><span id="NiftiViewer-2273"><a href="#NiftiViewer-2273"><span class="linenos">2273</span></a><span class="sd">        Looks for files with names matching the pattern &#39;something_idNUM_other.extension&#39;</span>
</span><span id="NiftiViewer-2274"><a href="#NiftiViewer-2274"><span class="linenos">2274</span></a><span class="sd">        (where NUM is an integer), and returns the next available number.</span>
</span><span id="NiftiViewer-2275"><a href="#NiftiViewer-2275"><span class="linenos">2275</span></a>
</span><span id="NiftiViewer-2276"><a href="#NiftiViewer-2276"><span class="linenos">2276</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-2277"><a href="#NiftiViewer-2277"><span class="linenos">2277</span></a><span class="sd">            folder_path (str): Path to the folder to scan.</span>
</span><span id="NiftiViewer-2278"><a href="#NiftiViewer-2278"><span class="linenos">2278</span></a>
</span><span id="NiftiViewer-2279"><a href="#NiftiViewer-2279"><span class="linenos">2279</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer-2280"><a href="#NiftiViewer-2280"><span class="linenos">2280</span></a><span class="sd">            int: The next available numeric ID.</span>
</span><span id="NiftiViewer-2281"><a href="#NiftiViewer-2281"><span class="linenos">2281</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2282"><a href="#NiftiViewer-2282"><span class="linenos">2282</span></a>        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;_v(\d+)_&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2283"><a href="#NiftiViewer-2283"><span class="linenos">2283</span></a>        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer-2284"><a href="#NiftiViewer-2284"><span class="linenos">2284</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Searching versions&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2285"><a href="#NiftiViewer-2285"><span class="linenos">2285</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
</span><span id="NiftiViewer-2286"><a href="#NiftiViewer-2286"><span class="linenos">2286</span></a>            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
</span><span id="NiftiViewer-2287"><a href="#NiftiViewer-2287"><span class="linenos">2287</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)):</span>
</span><span id="NiftiViewer-2288"><a href="#NiftiViewer-2288"><span class="linenos">2288</span></a>                    <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="NiftiViewer-2289"><a href="#NiftiViewer-2289"><span class="linenos">2289</span></a>                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
</span><span id="NiftiViewer-2290"><a href="#NiftiViewer-2290"><span class="linenos">2290</span></a>                        <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
</span><span id="NiftiViewer-2291"><a href="#NiftiViewer-2291"><span class="linenos">2291</span></a>
</span><span id="NiftiViewer-2292"><a href="#NiftiViewer-2292"><span class="linenos">2292</span></a>            <span class="n">next_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">ids</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="NiftiViewer-2293"><a href="#NiftiViewer-2293"><span class="linenos">2293</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Next v: </span><span class="si">{</span><span class="n">next_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2294"><a href="#NiftiViewer-2294"><span class="linenos">2294</span></a>            <span class="k">return</span> <span class="n">next_id</span>
</span><span id="NiftiViewer-2295"><a href="#NiftiViewer-2295"><span class="linenos">2295</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-2296"><a href="#NiftiViewer-2296"><span class="linenos">2296</span></a>            <span class="k">return</span> <span class="mi">1</span>
</span><span id="NiftiViewer-2297"><a href="#NiftiViewer-2297"><span class="linenos">2297</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">addOrigin_clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-2298"><a href="#NiftiViewer-2298"><span class="linenos">2298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="NiftiViewer-2299"><a href="#NiftiViewer-2299"><span class="linenos">2299</span></a>
</span><span id="NiftiViewer-2300"><a href="#NiftiViewer-2300"><span class="linenos">2300</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer-2301"><a href="#NiftiViewer-2301"><span class="linenos">2301</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="NiftiViewer-2302"><a href="#NiftiViewer-2302"><span class="linenos">2302</span></a>
</span><span id="NiftiViewer-2303"><a href="#NiftiViewer-2303"><span class="linenos">2303</span></a>        <span class="c1">#if self.overlay_enabled and self.overlay_data is not None:</span>
</span><span id="NiftiViewer-2304"><a href="#NiftiViewer-2304"><span class="linenos">2304</span></a>        <span class="c1">#    self.incrementalROI_data = np.logical_or(self.incrementalROI_data, self.overlay_data).astype(np.uint8)</span>
</span><span id="NiftiViewer-2305"><a href="#NiftiViewer-2305"><span class="linenos">2305</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-2306"><a href="#NiftiViewer-2306"><span class="linenos">2306</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-2307"><a href="#NiftiViewer-2307"><span class="linenos">2307</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_incrementalROI</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-2308"><a href="#NiftiViewer-2308"><span class="linenos">2308</span></a>
</span><span id="NiftiViewer-2309"><a href="#NiftiViewer-2309"><span class="linenos">2309</span></a>        <span class="n">new_params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="NiftiViewer-2310"><a href="#NiftiViewer-2310"><span class="linenos">2310</span></a>            <span class="s2">&quot;Seed&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_seed_coordinates</span><span class="p">),</span>
</span><span id="NiftiViewer-2311"><a href="#NiftiViewer-2311"><span class="linenos">2311</span></a>            <span class="s2">&quot;Radius&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
</span><span id="NiftiViewer-2312"><a href="#NiftiViewer-2312"><span class="linenos">2312</span></a>            <span class="s2">&quot;Difference&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
</span><span id="NiftiViewer-2313"><a href="#NiftiViewer-2313"><span class="linenos">2313</span></a>        <span class="p">}</span>
</span><span id="NiftiViewer-2314"><a href="#NiftiViewer-2314"><span class="linenos">2314</span></a>
</span><span id="NiftiViewer-2315"><a href="#NiftiViewer-2315"><span class="linenos">2315</span></a>        <span class="c1"># Mantieni lista incrementale</span>
</span><span id="NiftiViewer-2316"><a href="#NiftiViewer-2316"><span class="linenos">2316</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>
</span><span id="NiftiViewer-2317"><a href="#NiftiViewer-2317"><span class="linenos">2317</span></a>
</span><span id="NiftiViewer-2318"><a href="#NiftiViewer-2318"><span class="linenos">2318</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_incrementalROI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">enabled</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="NiftiViewer-2319"><a href="#NiftiViewer-2319"><span class="linenos">2319</span></a>
</span><span id="NiftiViewer-2320"><a href="#NiftiViewer-2320"><span class="linenos">2320</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span> <span class="o">=</span> <span class="n">enabled</span>
</span><span id="NiftiViewer-2321"><a href="#NiftiViewer-2321"><span class="linenos">2321</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-2322"><a href="#NiftiViewer-2322"><span class="linenos">2322</span></a>
</span><span id="NiftiViewer-2323"><a href="#NiftiViewer-2323"><span class="linenos">2323</span></a>        <span class="c1"># Enable or disable overlay-related UI controls</span>
</span><span id="NiftiViewer-2324"><a href="#NiftiViewer-2324"><span class="linenos">2324</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-2325"><a href="#NiftiViewer-2325"><span class="linenos">2325</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-2326"><a href="#NiftiViewer-2326"><span class="linenos">2326</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-2327"><a href="#NiftiViewer-2327"><span class="linenos">2327</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-2328"><a href="#NiftiViewer-2328"><span class="linenos">2328</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer-2329"><a href="#NiftiViewer-2329"><span class="linenos">2329</span></a>
</span><span id="NiftiViewer-2330"><a href="#NiftiViewer-2330"><span class="linenos">2330</span></a>        <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="NiftiViewer-2331"><a href="#NiftiViewer-2331"><span class="linenos">2331</span></a>            <span class="c1"># Redraw display if overlay data is available</span>
</span><span id="NiftiViewer-2332"><a href="#NiftiViewer-2332"><span class="linenos">2332</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-2333"><a href="#NiftiViewer-2333"><span class="linenos">2333</span></a>
</span><span id="NiftiViewer-2334"><a href="#NiftiViewer-2334"><span class="linenos">2334</span></a>            <span class="c1"># Update time series plot if available</span>
</span><span id="NiftiViewer-2335"><a href="#NiftiViewer-2335"><span class="linenos">2335</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_time_series_plot</span><span class="p">()</span>
</span><span id="NiftiViewer-2336"><a href="#NiftiViewer-2336"><span class="linenos">2336</span></a>
</span><span id="NiftiViewer-2337"><a href="#NiftiViewer-2337"><span class="linenos">2337</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span id="NiftiViewer-2338"><a href="#NiftiViewer-2338"><span class="linenos">2338</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up on application exit&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2339"><a href="#NiftiViewer-2339"><span class="linenos">2339</span></a>        <span class="c1"># Stop and delete all active threads</span>
</span><span id="NiftiViewer-2340"><a href="#NiftiViewer-2340"><span class="linenos">2340</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;threads&#39;</span><span class="p">):</span>
</span><span id="NiftiViewer-2341"><a href="#NiftiViewer-2341"><span class="linenos">2341</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
</span><span id="NiftiViewer-2342"><a href="#NiftiViewer-2342"><span class="linenos">2342</span></a>                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">isRunning</span><span class="p">():</span>
</span><span id="NiftiViewer-2343"><a href="#NiftiViewer-2343"><span class="linenos">2343</span></a>                    <span class="n">t</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="NiftiViewer-2344"><a href="#NiftiViewer-2344"><span class="linenos">2344</span></a>                    <span class="n">t</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</span><span id="NiftiViewer-2345"><a href="#NiftiViewer-2345"><span class="linenos">2345</span></a>                <span class="n">t</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
</span><span id="NiftiViewer-2346"><a href="#NiftiViewer-2346"><span class="linenos">2346</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="NiftiViewer-2347"><a href="#NiftiViewer-2347"><span class="linenos">2347</span></a>
</span><span id="NiftiViewer-2348"><a href="#NiftiViewer-2348"><span class="linenos">2348</span></a>        <span class="c1"># Clear large data arrays to release memory</span>
</span><span id="NiftiViewer-2349"><a href="#NiftiViewer-2349"><span class="linenos">2349</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-2350"><a href="#NiftiViewer-2350"><span class="linenos">2350</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-2351"><a href="#NiftiViewer-2351"><span class="linenos">2351</span></a>
</span><span id="NiftiViewer-2352"><a href="#NiftiViewer-2352"><span class="linenos">2352</span></a>        <span class="c1"># Trigger garbage collection</span>
</span><span id="NiftiViewer-2353"><a href="#NiftiViewer-2353"><span class="linenos">2353</span></a>        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="NiftiViewer-2354"><a href="#NiftiViewer-2354"><span class="linenos">2354</span></a>
</span><span id="NiftiViewer-2355"><a href="#NiftiViewer-2355"><span class="linenos">2355</span></a>        <span class="c1"># Accept the close event to exit</span>
</span><span id="NiftiViewer-2356"><a href="#NiftiViewer-2356"><span class="linenos">2356</span></a>        <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span><span id="NiftiViewer-2357"><a href="#NiftiViewer-2357"><span class="linenos">2357</span></a>
</span><span id="NiftiViewer-2358"><a href="#NiftiViewer-2358"><span class="linenos">2358</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset_overlay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-2359"><a href="#NiftiViewer-2359"><span class="linenos">2359</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset all overlay-related UI elements and internal variables.&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2360"><a href="#NiftiViewer-2360"><span class="linenos">2360</span></a>        <span class="c1"># Disable the automatic ROI overlay mode</span>
</span><span id="NiftiViewer-2361"><a href="#NiftiViewer-2361"><span class="linenos">2361</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="NiftiViewer-2362"><a href="#NiftiViewer-2362"><span class="linenos">2362</span></a>        <span class="c1"># Disable the &quot;Save ROI&quot; button since theres no active overlay</span>
</span><span id="NiftiViewer-2363"><a href="#NiftiViewer-2363"><span class="linenos">2363</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2364"><a href="#NiftiViewer-2364"><span class="linenos">2364</span></a>        <span class="c1"># Clear all overlay-related data</span>
</span><span id="NiftiViewer-2365"><a href="#NiftiViewer-2365"><span class="linenos">2365</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-2366"><a href="#NiftiViewer-2366"><span class="linenos">2366</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-2367"><a href="#NiftiViewer-2367"><span class="linenos">2367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_dims</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-2368"><a href="#NiftiViewer-2368"><span class="linenos">2368</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_file_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-2369"><a href="#NiftiViewer-2369"><span class="linenos">2369</span></a>        <span class="c1"># Hide and disable the overlay parameter sliders group (radius/difference)</span>
</span><span id="NiftiViewer-2370"><a href="#NiftiViewer-2370"><span class="linenos">2370</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2371"><a href="#NiftiViewer-2371"><span class="linenos">2371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2372"><a href="#NiftiViewer-2372"><span class="linenos">2372</span></a>        <span class="c1"># Ensure overlay visualization is turned off</span>
</span><span id="NiftiViewer-2373"><a href="#NiftiViewer-2373"><span class="linenos">2373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_overlay</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2374"><a href="#NiftiViewer-2374"><span class="linenos">2374</span></a>        <span class="c1"># Disable and uncheck the overlay checkbox in UI</span>
</span><span id="NiftiViewer-2375"><a href="#NiftiViewer-2375"><span class="linenos">2375</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2376"><a href="#NiftiViewer-2376"><span class="linenos">2376</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2377"><a href="#NiftiViewer-2377"><span class="linenos">2377</span></a>        <span class="c1"># Reset overlay info label to default text</span>
</span><span id="NiftiViewer-2378"><a href="#NiftiViewer-2378"><span class="linenos">2378</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
</span><span id="NiftiViewer-2379"><a href="#NiftiViewer-2379"><span class="linenos">2379</span></a>            <span class="sa">f</span><span class="s2">&quot;Overlay:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
</span><span id="NiftiViewer-2380"><a href="#NiftiViewer-2380"><span class="linenos">2380</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2381"><a href="#NiftiViewer-2381"><span class="linenos">2381</span></a>        <span class="p">)</span>
</span><span id="NiftiViewer-2382"><a href="#NiftiViewer-2382"><span class="linenos">2382</span></a>
</span><span id="NiftiViewer-2383"><a href="#NiftiViewer-2383"><span class="linenos">2383</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">resetROI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-2384"><a href="#NiftiViewer-2384"><span class="linenos">2384</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset all ROI-related UI elements and internal variables.&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2385"><a href="#NiftiViewer-2385"><span class="linenos">2385</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2386"><a href="#NiftiViewer-2386"><span class="linenos">2386</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2387"><a href="#NiftiViewer-2387"><span class="linenos">2387</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2388"><a href="#NiftiViewer-2388"><span class="linenos">2388</span></a>
</span><span id="NiftiViewer-2389"><a href="#NiftiViewer-2389"><span class="linenos">2389</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_incrementalROI</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2390"><a href="#NiftiViewer-2390"><span class="linenos">2390</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2391"><a href="#NiftiViewer-2391"><span class="linenos">2391</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2392"><a href="#NiftiViewer-2392"><span class="linenos">2392</span></a>
</span><span id="NiftiViewer-2393"><a href="#NiftiViewer-2393"><span class="linenos">2393</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_automaticROI</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2394"><a href="#NiftiViewer-2394"><span class="linenos">2394</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2395"><a href="#NiftiViewer-2395"><span class="linenos">2395</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2396"><a href="#NiftiViewer-2396"><span class="linenos">2396</span></a>
</span><span id="NiftiViewer-2397"><a href="#NiftiViewer-2397"><span class="linenos">2397</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-2398"><a href="#NiftiViewer-2398"><span class="linenos">2398</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer-2399"><a href="#NiftiViewer-2399"><span class="linenos">2399</span></a>
</span><span id="NiftiViewer-2400"><a href="#NiftiViewer-2400"><span class="linenos">2400</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2401"><a href="#NiftiViewer-2401"><span class="linenos">2401</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer-2402"><a href="#NiftiViewer-2402"><span class="linenos">2402</span></a>
</span><span id="NiftiViewer-2403"><a href="#NiftiViewer-2403"><span class="linenos">2403</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic ROI&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2404"><a href="#NiftiViewer-2404"><span class="linenos">2404</span></a>
</span><span id="NiftiViewer-2405"><a href="#NiftiViewer-2405"><span class="linenos">2405</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer-2406"><a href="#NiftiViewer-2406"><span class="linenos">2406</span></a>
</span><span id="NiftiViewer-2407"><a href="#NiftiViewer-2407"><span class="linenos">2407</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_origins</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer-2408"><a href="#NiftiViewer-2408"><span class="linenos">2408</span></a>
</span><span id="NiftiViewer-2409"><a href="#NiftiViewer-2409"><span class="linenos">2409</span></a>
</span><span id="NiftiViewer-2410"><a href="#NiftiViewer-2410"><span class="linenos">2410</span></a>
</span><span id="NiftiViewer-2411"><a href="#NiftiViewer-2411"><span class="linenos">2411</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pad_volume_to_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">,</span> <span class="n">constant_value</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="NiftiViewer-2412"><a href="#NiftiViewer-2412"><span class="linenos">2412</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2413"><a href="#NiftiViewer-2413"><span class="linenos">2413</span></a><span class="sd">        Pad a 3D volume (NumPy array) symmetrically to match a desired target shape.</span>
</span><span id="NiftiViewer-2414"><a href="#NiftiViewer-2414"><span class="linenos">2414</span></a>
</span><span id="NiftiViewer-2415"><a href="#NiftiViewer-2415"><span class="linenos">2415</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer-2416"><a href="#NiftiViewer-2416"><span class="linenos">2416</span></a><span class="sd">            volume (np.ndarray): Input 3D volume to pad.</span>
</span><span id="NiftiViewer-2417"><a href="#NiftiViewer-2417"><span class="linenos">2417</span></a><span class="sd">            target_shape (tuple[int]): Desired (X, Y, Z) dimensions after padding.</span>
</span><span id="NiftiViewer-2418"><a href="#NiftiViewer-2418"><span class="linenos">2418</span></a><span class="sd">            constant_value (int or float, optional): Value used for padding. Defaults to 0.</span>
</span><span id="NiftiViewer-2419"><a href="#NiftiViewer-2419"><span class="linenos">2419</span></a>
</span><span id="NiftiViewer-2420"><a href="#NiftiViewer-2420"><span class="linenos">2420</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer-2421"><a href="#NiftiViewer-2421"><span class="linenos">2421</span></a><span class="sd">            np.ndarray: The padded 3D array with dimensions matching target_shape.</span>
</span><span id="NiftiViewer-2422"><a href="#NiftiViewer-2422"><span class="linenos">2422</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2423"><a href="#NiftiViewer-2423"><span class="linenos">2423</span></a>        <span class="n">current_shape</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">shape</span>
</span><span id="NiftiViewer-2424"><a href="#NiftiViewer-2424"><span class="linenos">2424</span></a>        <span class="n">pads</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store pad widths for each axis</span>
</span><span id="NiftiViewer-2425"><a href="#NiftiViewer-2425"><span class="linenos">2425</span></a>
</span><span id="NiftiViewer-2426"><a href="#NiftiViewer-2426"><span class="linenos">2426</span></a>        <span class="c1"># Compute symmetric padding for each axis</span>
</span><span id="NiftiViewer-2427"><a href="#NiftiViewer-2427"><span class="linenos">2427</span></a>        <span class="k">for</span> <span class="n">cur</span><span class="p">,</span> <span class="n">tgt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">current_shape</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">):</span>
</span><span id="NiftiViewer-2428"><a href="#NiftiViewer-2428"><span class="linenos">2428</span></a>            <span class="n">diff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tgt</span> <span class="o">-</span> <span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Calculate missing voxels along this axis</span>
</span><span id="NiftiViewer-2429"><a href="#NiftiViewer-2429"><span class="linenos">2429</span></a>            <span class="n">pad_before</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># Padding before the data</span>
</span><span id="NiftiViewer-2430"><a href="#NiftiViewer-2430"><span class="linenos">2430</span></a>            <span class="n">pad_after</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">-</span> <span class="n">pad_before</span>  <span class="c1"># Padding after the data</span>
</span><span id="NiftiViewer-2431"><a href="#NiftiViewer-2431"><span class="linenos">2431</span></a>            <span class="n">pads</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pad_before</span><span class="p">,</span> <span class="n">pad_after</span><span class="p">))</span>  <span class="c1"># Add as (before, after) pair</span>
</span><span id="NiftiViewer-2432"><a href="#NiftiViewer-2432"><span class="linenos">2432</span></a>
</span><span id="NiftiViewer-2433"><a href="#NiftiViewer-2433"><span class="linenos">2433</span></a>        <span class="c1"># Apply constant padding and return result</span>
</span><span id="NiftiViewer-2434"><a href="#NiftiViewer-2434"><span class="linenos">2434</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">volume</span><span class="p">,</span> <span class="n">pads</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="n">constant_value</span><span class="p">)</span>
</span><span id="NiftiViewer-2435"><a href="#NiftiViewer-2435"><span class="linenos">2435</span></a>
</span><span id="NiftiViewer-2436"><a href="#NiftiViewer-2436"><span class="linenos">2436</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_scroll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">plane_idx</span><span class="p">,</span><span class="n">delta</span><span class="p">):</span>
</span><span id="NiftiViewer-2437"><a href="#NiftiViewer-2437"><span class="linenos">2437</span></a>        <span class="k">if</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Axial (XY plane)</span>
</span><span id="NiftiViewer-2438"><a href="#NiftiViewer-2438"><span class="linenos">2438</span></a>            <span class="k">if</span> <span class="n">delta</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="NiftiViewer-2439"><a href="#NiftiViewer-2439"><span class="linenos">2439</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer-2440"><a href="#NiftiViewer-2440"><span class="linenos">2440</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer-2441"><a href="#NiftiViewer-2441"><span class="linenos">2441</span></a>            <span class="k">elif</span> <span class="n">delta</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="NiftiViewer-2442"><a href="#NiftiViewer-2442"><span class="linenos">2442</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-2443"><a href="#NiftiViewer-2443"><span class="linenos">2443</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-2444"><a href="#NiftiViewer-2444"><span class="linenos">2444</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-2445"><a href="#NiftiViewer-2445"><span class="linenos">2445</span></a>                <span class="k">return</span>
</span><span id="NiftiViewer-2446"><a href="#NiftiViewer-2446"><span class="linenos">2446</span></a>        <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Coronal (XZ plane)</span>
</span><span id="NiftiViewer-2447"><a href="#NiftiViewer-2447"><span class="linenos">2447</span></a>            <span class="k">if</span> <span class="n">delta</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="NiftiViewer-2448"><a href="#NiftiViewer-2448"><span class="linenos">2448</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer-2449"><a href="#NiftiViewer-2449"><span class="linenos">2449</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer-2450"><a href="#NiftiViewer-2450"><span class="linenos">2450</span></a>            <span class="k">elif</span> <span class="n">delta</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="NiftiViewer-2451"><a href="#NiftiViewer-2451"><span class="linenos">2451</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-2452"><a href="#NiftiViewer-2452"><span class="linenos">2452</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-2453"><a href="#NiftiViewer-2453"><span class="linenos">2453</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-2454"><a href="#NiftiViewer-2454"><span class="linenos">2454</span></a>                <span class="k">return</span>
</span><span id="NiftiViewer-2455"><a href="#NiftiViewer-2455"><span class="linenos">2455</span></a>        <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sagittal (YZ plane)</span>
</span><span id="NiftiViewer-2456"><a href="#NiftiViewer-2456"><span class="linenos">2456</span></a>            <span class="k">if</span> <span class="n">delta</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="NiftiViewer-2457"><a href="#NiftiViewer-2457"><span class="linenos">2457</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer-2458"><a href="#NiftiViewer-2458"><span class="linenos">2458</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer-2459"><a href="#NiftiViewer-2459"><span class="linenos">2459</span></a>            <span class="k">elif</span> <span class="n">delta</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="NiftiViewer-2460"><a href="#NiftiViewer-2460"><span class="linenos">2460</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-2461"><a href="#NiftiViewer-2461"><span class="linenos">2461</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer-2462"><a href="#NiftiViewer-2462"><span class="linenos">2462</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-2463"><a href="#NiftiViewer-2463"><span class="linenos">2463</span></a>                <span class="k">return</span>
</span><span id="NiftiViewer-2464"><a href="#NiftiViewer-2464"><span class="linenos">2464</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-2465"><a href="#NiftiViewer-2465"><span class="linenos">2465</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Plane index out of range&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2466"><a href="#NiftiViewer-2466"><span class="linenos">2466</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer-2467"><a href="#NiftiViewer-2467"><span class="linenos">2467</span></a>            <span class="c1"># Synchronize controls for all planes</span>
</span><span id="NiftiViewer-2468"><a href="#NiftiViewer-2468"><span class="linenos">2468</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="NiftiViewer-2469"><a href="#NiftiViewer-2469"><span class="linenos">2469</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="NiftiViewer-2470"><a href="#NiftiViewer-2470"><span class="linenos">2470</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="NiftiViewer-2471"><a href="#NiftiViewer-2471"><span class="linenos">2471</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_cross_view_lines</span><span class="p">()</span>
</span><span id="NiftiViewer-2472"><a href="#NiftiViewer-2472"><span class="linenos">2472</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_coordinate_displays</span><span class="p">()</span>
</span><span id="NiftiViewer-2473"><a href="#NiftiViewer-2473"><span class="linenos">2473</span></a>
</span><span id="NiftiViewer-2474"><a href="#NiftiViewer-2474"><span class="linenos">2474</span></a>
</span><span id="NiftiViewer-2475"><a href="#NiftiViewer-2475"><span class="linenos">2475</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_translate_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer-2476"><a href="#NiftiViewer-2476"><span class="linenos">2476</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2477"><a href="#NiftiViewer-2477"><span class="linenos">2477</span></a><span class="sd">        Update all UI texts for internationalization (i18n).</span>
</span><span id="NiftiViewer-2478"><a href="#NiftiViewer-2478"><span class="linenos">2478</span></a>
</span><span id="NiftiViewer-2479"><a href="#NiftiViewer-2479"><span class="linenos">2479</span></a><span class="sd">        This function ensures that all interface elements are dynamically translated</span>
</span><span id="NiftiViewer-2480"><a href="#NiftiViewer-2480"><span class="linenos">2480</span></a><span class="sd">        using Qts translation system. It is typically called when initializing</span>
</span><span id="NiftiViewer-2481"><a href="#NiftiViewer-2481"><span class="linenos">2481</span></a><span class="sd">        or changing the application language.</span>
</span><span id="NiftiViewer-2482"><a href="#NiftiViewer-2482"><span class="linenos">2482</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer-2483"><a href="#NiftiViewer-2483"><span class="linenos">2483</span></a>        <span class="c1"># Set the main window title</span>
</span><span id="NiftiViewer-2484"><a href="#NiftiViewer-2484"><span class="linenos">2484</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;NIfTI Image Viewer&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2485"><a href="#NiftiViewer-2485"><span class="linenos">2485</span></a>
</span><span id="NiftiViewer-2486"><a href="#NiftiViewer-2486"><span class="linenos">2486</span></a>        <span class="c1"># Status bar initial message</span>
</span><span id="NiftiViewer-2487"><a href="#NiftiViewer-2487"><span class="linenos">2487</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
</span><span id="NiftiViewer-2488"><a href="#NiftiViewer-2488"><span class="linenos">2488</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Ready - Open a NIfTI file to begin&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2489"><a href="#NiftiViewer-2489"><span class="linenos">2489</span></a>
</span><span id="NiftiViewer-2490"><a href="#NiftiViewer-2490"><span class="linenos">2490</span></a>        <span class="c1"># Initialize coordinate and value display labels</span>
</span><span id="NiftiViewer-2491"><a href="#NiftiViewer-2491"><span class="linenos">2491</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coordinates: (-, -, -)&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2492"><a href="#NiftiViewer-2492"><span class="linenos">2492</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Value: -&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2493"><a href="#NiftiViewer-2493"><span class="linenos">2493</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Slice: -/-&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2494"><a href="#NiftiViewer-2494"><span class="linenos">2494</span></a>
</span><span id="NiftiViewer-2495"><a href="#NiftiViewer-2495"><span class="linenos">2495</span></a>        <span class="c1"># File open button label</span>
</span><span id="NiftiViewer-2496"><a href="#NiftiViewer-2496"><span class="linenos">2496</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot; Open NIfTI File&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2497"><a href="#NiftiViewer-2497"><span class="linenos">2497</span></a>
</span><span id="NiftiViewer-2498"><a href="#NiftiViewer-2498"><span class="linenos">2498</span></a>        <span class="c1"># Default file information message</span>
</span><span id="NiftiViewer-2499"><a href="#NiftiViewer-2499"><span class="linenos">2499</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No file loaded&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2500"><a href="#NiftiViewer-2500"><span class="linenos">2500</span></a>
</span><span id="NiftiViewer-2501"><a href="#NiftiViewer-2501"><span class="linenos">2501</span></a>        <span class="c1"># Plane labels for orthogonal slice views</span>
</span><span id="NiftiViewer-2502"><a href="#NiftiViewer-2502"><span class="linenos">2502</span></a>        <span class="n">plane_names</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="NiftiViewer-2503"><a href="#NiftiViewer-2503"><span class="linenos">2503</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Axial (Z)&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer-2504"><a href="#NiftiViewer-2504"><span class="linenos">2504</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coronal (Y)&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer-2505"><a href="#NiftiViewer-2505"><span class="linenos">2505</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Sagittal (X)&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2506"><a href="#NiftiViewer-2506"><span class="linenos">2506</span></a>        <span class="p">]</span>
</span><span id="NiftiViewer-2507"><a href="#NiftiViewer-2507"><span class="linenos">2507</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plane_names</span><span class="p">):</span>
</span><span id="NiftiViewer-2508"><a href="#NiftiViewer-2508"><span class="linenos">2508</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plane_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
</span><span id="NiftiViewer-2509"><a href="#NiftiViewer-2509"><span class="linenos">2509</span></a>
</span><span id="NiftiViewer-2510"><a href="#NiftiViewer-2510"><span class="linenos">2510</span></a>        <span class="c1"># Time navigation controls</span>
</span><span id="NiftiViewer-2511"><a href="#NiftiViewer-2511"><span class="linenos">2511</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Enable 4D Time Navigation&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2512"><a href="#NiftiViewer-2512"><span class="linenos">2512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Time Point:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2513"><a href="#NiftiViewer-2513"><span class="linenos">2513</span></a>
</span><span id="NiftiViewer-2514"><a href="#NiftiViewer-2514"><span class="linenos">2514</span></a>        <span class="c1"># Display options section label</span>
</span><span id="NiftiViewer-2515"><a href="#NiftiViewer-2515"><span class="linenos">2515</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Display Options:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2516"><a href="#NiftiViewer-2516"><span class="linenos">2516</span></a>
</span><span id="NiftiViewer-2517"><a href="#NiftiViewer-2517"><span class="linenos">2517</span></a>        <span class="c1"># Populate color map combo box options</span>
</span><span id="NiftiViewer-2518"><a href="#NiftiViewer-2518"><span class="linenos">2518</span></a>        <span class="n">colormap_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="s1">&#39;bone&#39;</span><span class="p">]</span>
</span><span id="NiftiViewer-2519"><a href="#NiftiViewer-2519"><span class="linenos">2519</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">colormap_names</span><span class="p">):</span>
</span><span id="NiftiViewer-2520"><a href="#NiftiViewer-2520"><span class="linenos">2520</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="o">.</span><span class="n">setItemText</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="NiftiViewer-2521"><a href="#NiftiViewer-2521"><span class="linenos">2521</span></a>
</span><span id="NiftiViewer-2522"><a href="#NiftiViewer-2522"><span class="linenos">2522</span></a>        <span class="c1"># Label for colormap and overlay control sections</span>
</span><span id="NiftiViewer-2523"><a href="#NiftiViewer-2523"><span class="linenos">2523</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Colormap:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2524"><a href="#NiftiViewer-2524"><span class="linenos">2524</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay Controls:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2525"><a href="#NiftiViewer-2525"><span class="linenos">2525</span></a>
</span><span id="NiftiViewer-2526"><a href="#NiftiViewer-2526"><span class="linenos">2526</span></a>        <span class="c1"># Overlay loading and visibility controls</span>
</span><span id="NiftiViewer-2527"><a href="#NiftiViewer-2527"><span class="linenos">2527</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Load NIfTI Overlay&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2528"><a href="#NiftiViewer-2528"><span class="linenos">2528</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Show Overlay&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2529"><a href="#NiftiViewer-2529"><span class="linenos">2529</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_overlay_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay Transparency:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2530"><a href="#NiftiViewer-2530"><span class="linenos">2530</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay Threshold:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2531"><a href="#NiftiViewer-2531"><span class="linenos">2531</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No overlay loaded&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2532"><a href="#NiftiViewer-2532"><span class="linenos">2532</span></a>
</span><span id="NiftiViewer-2533"><a href="#NiftiViewer-2533"><span class="linenos">2533</span></a>        <span class="c1"># Titles for image view panels</span>
</span><span id="NiftiViewer-2534"><a href="#NiftiViewer-2534"><span class="linenos">2534</span></a>        <span class="n">view_titles</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="NiftiViewer-2535"><a href="#NiftiViewer-2535"><span class="linenos">2535</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Axial&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer-2536"><a href="#NiftiViewer-2536"><span class="linenos">2536</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coronal&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer-2537"><a href="#NiftiViewer-2537"><span class="linenos">2537</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Sagittal&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2538"><a href="#NiftiViewer-2538"><span class="linenos">2538</span></a>        <span class="p">]</span>
</span><span id="NiftiViewer-2539"><a href="#NiftiViewer-2539"><span class="linenos">2539</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">view_titles</span><span class="p">):</span>
</span><span id="NiftiViewer-2540"><a href="#NiftiViewer-2540"><span class="linenos">2540</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view_titles_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="NiftiViewer-2541"><a href="#NiftiViewer-2541"><span class="linenos">2541</span></a>
</span><span id="NiftiViewer-2542"><a href="#NiftiViewer-2542"><span class="linenos">2542</span></a>        <span class="c1"># Update fourth view title and general info text</span>
</span><span id="NiftiViewer-2543"><a href="#NiftiViewer-2543"><span class="linenos">2543</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="o">.</span><span class="n">text</span><span class="p">()))</span>
</span><span id="NiftiViewer-2544"><a href="#NiftiViewer-2544"><span class="linenos">2544</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No image loaded&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2545"><a href="#NiftiViewer-2545"><span class="linenos">2545</span></a>
</span><span id="NiftiViewer-2546"><a href="#NiftiViewer-2546"><span class="linenos">2546</span></a>        <span class="c1"># If an image file is already loaded, update the displayed metadata</span>
</span><span id="NiftiViewer-2547"><a href="#NiftiViewer-2547"><span class="linenos">2547</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">:</span>
</span><span id="NiftiViewer-2548"><a href="#NiftiViewer-2548"><span class="linenos">2548</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="NiftiViewer-2549"><a href="#NiftiViewer-2549"><span class="linenos">2549</span></a>            <span class="n">dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span>
</span><span id="NiftiViewer-2550"><a href="#NiftiViewer-2550"><span class="linenos">2550</span></a>            <span class="c1"># Distinguish between 3D and 4D datasets</span>
</span><span id="NiftiViewer-2551"><a href="#NiftiViewer-2551"><span class="linenos">2551</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="NiftiViewer-2552"><a href="#NiftiViewer-2552"><span class="linenos">2552</span></a>                <span class="n">info_text</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="NiftiViewer-2553"><a href="#NiftiViewer-2553"><span class="linenos">2553</span></a>                        <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;File&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
</span><span id="NiftiViewer-2554"><a href="#NiftiViewer-2554"><span class="linenos">2554</span></a>                        <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span> <span class="o">+</span>
</span><span id="NiftiViewer-2555"><a href="#NiftiViewer-2555"><span class="linenos">2555</span></a>                        <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
</span><span id="NiftiViewer-2556"><a href="#NiftiViewer-2556"><span class="linenos">2556</span></a>                        <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;4D Time Series&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2557"><a href="#NiftiViewer-2557"><span class="linenos">2557</span></a>                <span class="p">)</span>
</span><span id="NiftiViewer-2558"><a href="#NiftiViewer-2558"><span class="linenos">2558</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-2559"><a href="#NiftiViewer-2559"><span class="linenos">2559</span></a>                <span class="n">info_text</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="NiftiViewer-2560"><a href="#NiftiViewer-2560"><span class="linenos">2560</span></a>                        <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;File&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
</span><span id="NiftiViewer-2561"><a href="#NiftiViewer-2561"><span class="linenos">2561</span></a>                        <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span> <span class="o">+</span>
</span><span id="NiftiViewer-2562"><a href="#NiftiViewer-2562"><span class="linenos">2562</span></a>                        <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
</span><span id="NiftiViewer-2563"><a href="#NiftiViewer-2563"><span class="linenos">2563</span></a>                        <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;3D Volume&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer-2564"><a href="#NiftiViewer-2564"><span class="linenos">2564</span></a>                <span class="p">)</span>
</span><span id="NiftiViewer-2565"><a href="#NiftiViewer-2565"><span class="linenos">2565</span></a>
</span><span id="NiftiViewer-2566"><a href="#NiftiViewer-2566"><span class="linenos">2566</span></a>            <span class="c1"># Update file info labels and sidebar text</span>
</span><span id="NiftiViewer-2567"><a href="#NiftiViewer-2567"><span class="linenos">2567</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">info_text</span><span class="p">)</span>
</span><span id="NiftiViewer-2568"><a href="#NiftiViewer-2568"><span class="linenos">2568</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">info_text</span><span class="p">)</span>
</span><span id="NiftiViewer-2569"><a href="#NiftiViewer-2569"><span class="linenos">2569</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer-2570"><a href="#NiftiViewer-2570"><span class="linenos">2570</span></a>            <span class="c1"># Fallback text shown when no NIfTI file is loaded</span>
</span><span id="NiftiViewer-2571"><a href="#NiftiViewer-2571"><span class="linenos">2571</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No file loaded&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer-2572"><a href="#NiftiViewer-2572"><span class="linenos">2572</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No image loaded&quot;</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Main application window for viewing and interacting with NIfTI images.</p>

<p>This class provides a complete NIfTI image viewer with:</p>

<ul>
<li>Triplanar slice visualization (axial, coronal, sagittal)</li>
<li>Support for 4D volumes (time series)</li>
<li>Overlay support for mask visualization</li>
<li>Interactive ROI drawing and threshold-based segmentation</li>
<li>Threaded image loading/saving</li>
</ul>

<p>Attributes:
    context (dict): Optional shared context for multi-component communication.
    img_data (np.ndarray): Loaded image data.
    overlay_data (np.ndarray): Optional overlay volume.
    affine (np.ndarray): Image affine transformation matrix.
    voxel_sizes (tuple[float]): Voxel dimensions (mm).
    current_slices (list[int]): Current indices for each viewing plane.
    current_time (int): Current time frame (for 4D data).
    overlay_alpha (float): Overlay transparency level.
    overlay_threshold (float): Intensity threshold for overlay visibility.
    colormap (str): Current colormap name used for visualization.</p>
</div>


                            <div id="NiftiViewer.__init__" class="classattr">
                                        <input id="NiftiViewer.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">NiftiViewer</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">context</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="NiftiViewer.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.__init__-155"><a href="#NiftiViewer.__init__-155"><span class="linenos">155</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="NiftiViewer.__init__-156"><a href="#NiftiViewer.__init__-156"><span class="linenos">156</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.__init__-157"><a href="#NiftiViewer.__init__-157"><span class="linenos">157</span></a><span class="sd">        Initialize the NIfTI Viewer window and prepare all internal components.</span>
</span><span id="NiftiViewer.__init__-158"><a href="#NiftiViewer.__init__-158"><span class="linenos">158</span></a>
</span><span id="NiftiViewer.__init__-159"><a href="#NiftiViewer.__init__-159"><span class="linenos">159</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.__init__-160"><a href="#NiftiViewer.__init__-160"><span class="linenos">160</span></a><span class="sd">            context (dict, optional): Shared context for language translation and inter-component signaling.</span>
</span><span id="NiftiViewer.__init__-161"><a href="#NiftiViewer.__init__-161"><span class="linenos">161</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.__init__-162"><a href="#NiftiViewer.__init__-162"><span class="linenos">162</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="NiftiViewer.__init__-163"><a href="#NiftiViewer.__init__-163"><span class="linenos">163</span></a>
</span><span id="NiftiViewer.__init__-164"><a href="#NiftiViewer.__init__-164"><span class="linenos">164</span></a>
</span><span id="NiftiViewer.__init__-165"><a href="#NiftiViewer.__init__-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer.__init__-166"><a href="#NiftiViewer.__init__-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
</span><span id="NiftiViewer.__init__-167"><a href="#NiftiViewer.__init__-167"><span class="linenos">167</span></a>
</span><span id="NiftiViewer.__init__-168"><a href="#NiftiViewer.__init__-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-169"><a href="#NiftiViewer.__init__-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;NIfTI Image Viewer&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.__init__-170"><a href="#NiftiViewer.__init__-170"><span class="linenos">170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setMinimumSize</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">700</span><span class="p">)</span>
</span><span id="NiftiViewer.__init__-171"><a href="#NiftiViewer.__init__-171"><span class="linenos">171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="NiftiViewer.__init__-172"><a href="#NiftiViewer.__init__-172"><span class="linenos">172</span></a>
</span><span id="NiftiViewer.__init__-173"><a href="#NiftiViewer.__init__-173"><span class="linenos">173</span></a>        <span class="c1"># === Image data variables ===</span>
</span><span id="NiftiViewer.__init__-174"><a href="#NiftiViewer.__init__-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-175"><a href="#NiftiViewer.__init__-175"><span class="linenos">175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">affine</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-176"><a href="#NiftiViewer.__init__-176"><span class="linenos">176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-177"><a href="#NiftiViewer.__init__-177"><span class="linenos">177</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="NiftiViewer.__init__-178"><a href="#NiftiViewer.__init__-178"><span class="linenos">178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># axial, coronal, sagittal slice indices</span>
</span><span id="NiftiViewer.__init__-179"><a href="#NiftiViewer.__init__-179"><span class="linenos">179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="NiftiViewer.__init__-180"><a href="#NiftiViewer.__init__-180"><span class="linenos">180</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># x, y, z voxel coordinates</span>
</span><span id="NiftiViewer.__init__-181"><a href="#NiftiViewer.__init__-181"><span class="linenos">181</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-182"><a href="#NiftiViewer.__init__-182"><span class="linenos">182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stretch_factors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="NiftiViewer.__init__-183"><a href="#NiftiViewer.__init__-183"><span class="linenos">183</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-184"><a href="#NiftiViewer.__init__-184"><span class="linenos">184</span></a>
</span><span id="NiftiViewer.__init__-185"><a href="#NiftiViewer.__init__-185"><span class="linenos">185</span></a>        <span class="c1"># === Overlay-related attributes ===</span>
</span><span id="NiftiViewer.__init__-186"><a href="#NiftiViewer.__init__-186"><span class="linenos">186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-187"><a href="#NiftiViewer.__init__-187"><span class="linenos">187</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_dims</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-188"><a href="#NiftiViewer.__init__-188"><span class="linenos">188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha</span> <span class="o">=</span> <span class="mf">0.7</span>
</span><span id="NiftiViewer.__init__-189"><a href="#NiftiViewer.__init__-189"><span class="linenos">189</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="NiftiViewer.__init__-190"><a href="#NiftiViewer.__init__-190"><span class="linenos">190</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="NiftiViewer.__init__-191"><a href="#NiftiViewer.__init__-191"><span class="linenos">191</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_file_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-192"><a href="#NiftiViewer.__init__-192"><span class="linenos">192</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_max</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="NiftiViewer.__init__-193"><a href="#NiftiViewer.__init__-193"><span class="linenos">193</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-194"><a href="#NiftiViewer.__init__-194"><span class="linenos">194</span></a>
</span><span id="NiftiViewer.__init__-195"><a href="#NiftiViewer.__init__-195"><span class="linenos">195</span></a>        <span class="c1"># === UI element placeholders ===</span>
</span><span id="NiftiViewer.__init__-196"><a href="#NiftiViewer.__init__-196"><span class="linenos">196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-197"><a href="#NiftiViewer.__init__-197"><span class="linenos">197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plane_labels</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-198"><a href="#NiftiViewer.__init__-198"><span class="linenos">198</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-199"><a href="#NiftiViewer.__init__-199"><span class="linenos">199</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_info_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-200"><a href="#NiftiViewer.__init__-200"><span class="linenos">200</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-201"><a href="#NiftiViewer.__init__-201"><span class="linenos">201</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-202"><a href="#NiftiViewer.__init__-202"><span class="linenos">202</span></a>
</span><span id="NiftiViewer.__init__-203"><a href="#NiftiViewer.__init__-203"><span class="linenos">203</span></a>        <span class="c1"># === Visualization color configuration ===</span>
</span><span id="NiftiViewer.__init__-204"><a href="#NiftiViewer.__init__-204"><span class="linenos">204</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
</span><span id="NiftiViewer.__init__-205"><a href="#NiftiViewer.__init__-205"><span class="linenos">205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_colors</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="NiftiViewer.__init__-206"><a href="#NiftiViewer.__init__-206"><span class="linenos">206</span></a>            <span class="s2">&quot;gray&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span>
</span><span id="NiftiViewer.__init__-207"><a href="#NiftiViewer.__init__-207"><span class="linenos">207</span></a>            <span class="s2">&quot;viridis&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span>
</span><span id="NiftiViewer.__init__-208"><a href="#NiftiViewer.__init__-208"><span class="linenos">208</span></a>            <span class="s2">&quot;plasma&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span>
</span><span id="NiftiViewer.__init__-209"><a href="#NiftiViewer.__init__-209"><span class="linenos">209</span></a>            <span class="s2">&quot;inferno&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span>
</span><span id="NiftiViewer.__init__-210"><a href="#NiftiViewer.__init__-210"><span class="linenos">210</span></a>            <span class="s2">&quot;magma&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span>
</span><span id="NiftiViewer.__init__-211"><a href="#NiftiViewer.__init__-211"><span class="linenos">211</span></a>            <span class="s2">&quot;hot&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span>
</span><span id="NiftiViewer.__init__-212"><a href="#NiftiViewer.__init__-212"><span class="linenos">212</span></a>            <span class="s2">&quot;cool&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span>
</span><span id="NiftiViewer.__init__-213"><a href="#NiftiViewer.__init__-213"><span class="linenos">213</span></a>            <span class="s2">&quot;bone&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
</span><span id="NiftiViewer.__init__-214"><a href="#NiftiViewer.__init__-214"><span class="linenos">214</span></a>        <span class="p">}</span>
</span><span id="NiftiViewer.__init__-215"><a href="#NiftiViewer.__init__-215"><span class="linenos">215</span></a>
</span><span id="NiftiViewer.__init__-216"><a href="#NiftiViewer.__init__-216"><span class="linenos">216</span></a>        <span class="c1"># === Viewer components ===</span>
</span><span id="NiftiViewer.__init__-217"><a href="#NiftiViewer.__init__-217"><span class="linenos">217</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">views</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer.__init__-218"><a href="#NiftiViewer.__init__-218"><span class="linenos">218</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer.__init__-219"><a href="#NiftiViewer.__init__-219"><span class="linenos">219</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pixmap_items</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer.__init__-220"><a href="#NiftiViewer.__init__-220"><span class="linenos">220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer.__init__-221"><a href="#NiftiViewer.__init__-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer.__init__-222"><a href="#NiftiViewer.__init__-222"><span class="linenos">222</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer.__init__-223"><a href="#NiftiViewer.__init__-223"><span class="linenos">223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_displays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer.__init__-224"><a href="#NiftiViewer.__init__-224"><span class="linenos">224</span></a>
</span><span id="NiftiViewer.__init__-225"><a href="#NiftiViewer.__init__-225"><span class="linenos">225</span></a>        <span class="c1"># === Time-series visualization (for 4D data) ===</span>
</span><span id="NiftiViewer.__init__-226"><a href="#NiftiViewer.__init__-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-227"><a href="#NiftiViewer.__init__-227"><span class="linenos">227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-228"><a href="#NiftiViewer.__init__-228"><span class="linenos">228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-229"><a href="#NiftiViewer.__init__-229"><span class="linenos">229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-230"><a href="#NiftiViewer.__init__-230"><span class="linenos">230</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-231"><a href="#NiftiViewer.__init__-231"><span class="linenos">231</span></a>
</span><span id="NiftiViewer.__init__-232"><a href="#NiftiViewer.__init__-232"><span class="linenos">232</span></a>        <span class="c1"># === Additional UI components ===</span>
</span><span id="NiftiViewer.__init__-233"><a href="#NiftiViewer.__init__-233"><span class="linenos">233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-234"><a href="#NiftiViewer.__init__-234"><span class="linenos">234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-235"><a href="#NiftiViewer.__init__-235"><span class="linenos">235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-236"><a href="#NiftiViewer.__init__-236"><span class="linenos">236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-237"><a href="#NiftiViewer.__init__-237"><span class="linenos">237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-238"><a href="#NiftiViewer.__init__-238"><span class="linenos">238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-239"><a href="#NiftiViewer.__init__-239"><span class="linenos">239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-240"><a href="#NiftiViewer.__init__-240"><span class="linenos">240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-241"><a href="#NiftiViewer.__init__-241"><span class="linenos">241</span></a>
</span><span id="NiftiViewer.__init__-242"><a href="#NiftiViewer.__init__-242"><span class="linenos">242</span></a>        <span class="c1"># === Automatic ROI drawing ===</span>
</span><span id="NiftiViewer.__init__-243"><a href="#NiftiViewer.__init__-243"><span class="linenos">243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-244"><a href="#NiftiViewer.__init__-244"><span class="linenos">244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automatic_ROI_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-245"><a href="#NiftiViewer.__init__-245"><span class="linenos">245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-246"><a href="#NiftiViewer.__init__-246"><span class="linenos">246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="NiftiViewer.__init__-247"><a href="#NiftiViewer.__init__-247"><span class="linenos">247</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-248"><a href="#NiftiViewer.__init__-248"><span class="linenos">248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-249"><a href="#NiftiViewer.__init__-249"><span class="linenos">249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-250"><a href="#NiftiViewer.__init__-250"><span class="linenos">250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">AutomaticROI_diff_slider</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-251"><a href="#NiftiViewer.__init__-251"><span class="linenos">251</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-252"><a href="#NiftiViewer.__init__-252"><span class="linenos">252</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_seed_coordinates</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-253"><a href="#NiftiViewer.__init__-253"><span class="linenos">253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-254"><a href="#NiftiViewer.__init__-254"><span class="linenos">254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-255"><a href="#NiftiViewer.__init__-255"><span class="linenos">255</span></a>
</span><span id="NiftiViewer.__init__-256"><a href="#NiftiViewer.__init__-256"><span class="linenos">256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-257"><a href="#NiftiViewer.__init__-257"><span class="linenos">257</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-258"><a href="#NiftiViewer.__init__-258"><span class="linenos">258</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="NiftiViewer.__init__-259"><a href="#NiftiViewer.__init__-259"><span class="linenos">259</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-260"><a href="#NiftiViewer.__init__-260"><span class="linenos">260</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.__init__-261"><a href="#NiftiViewer.__init__-261"><span class="linenos">261</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_origins</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer.__init__-262"><a href="#NiftiViewer.__init__-262"><span class="linenos">262</span></a>
</span><span id="NiftiViewer.__init__-263"><a href="#NiftiViewer.__init__-263"><span class="linenos">263</span></a>        <span class="c1"># === Initialize and connect the UI ===</span>
</span><span id="NiftiViewer.__init__-264"><a href="#NiftiViewer.__init__-264"><span class="linenos">264</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_ui</span><span class="p">()</span>
</span><span id="NiftiViewer.__init__-265"><a href="#NiftiViewer.__init__-265"><span class="linenos">265</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setup_connections</span><span class="p">()</span>
</span><span id="NiftiViewer.__init__-266"><a href="#NiftiViewer.__init__-266"><span class="linenos">266</span></a>
</span><span id="NiftiViewer.__init__-267"><a href="#NiftiViewer.__init__-267"><span class="linenos">267</span></a>        <span class="c1"># === Translation setup ===</span>
</span><span id="NiftiViewer.__init__-268"><a href="#NiftiViewer.__init__-268"><span class="linenos">268</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_translate_ui</span><span class="p">()</span>
</span><span id="NiftiViewer.__init__-269"><a href="#NiftiViewer.__init__-269"><span class="linenos">269</span></a>        <span class="k">if</span> <span class="n">context</span> <span class="ow">and</span> <span class="s2">&quot;language_changed&quot;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
</span><span id="NiftiViewer.__init__-270"><a href="#NiftiViewer.__init__-270"><span class="linenos">270</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;language_changed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_translate_ui</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the NIfTI Viewer window and prepare all internal components.</p>

<p>Args:
    context (dict, optional): Shared context for language translation and inter-component signaling.</p>
</div>


                            </div>
                            <div id="NiftiViewer.threads" class="classattr">
                                <div class="attr variable">
            <span class="name">threads</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.threads"></a>
    
    

                            </div>
                            <div id="NiftiViewer.context" class="classattr">
                                <div class="attr variable">
            <span class="name">context</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.context"></a>
    
    

                            </div>
                            <div id="NiftiViewer.progress_dialog" class="classattr">
                                <div class="attr variable">
            <span class="name">progress_dialog</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.progress_dialog"></a>
    
    

                            </div>
                            <div id="NiftiViewer.img_data" class="classattr">
                                <div class="attr variable">
            <span class="name">img_data</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.img_data"></a>
    
    

                            </div>
                            <div id="NiftiViewer.affine" class="classattr">
                                <div class="attr variable">
            <span class="name">affine</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.affine"></a>
    
    

                            </div>
                            <div id="NiftiViewer.dims" class="classattr">
                                <div class="attr variable">
            <span class="name">dims</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.dims"></a>
    
    

                            </div>
                            <div id="NiftiViewer.is_4d" class="classattr">
                                <div class="attr variable">
            <span class="name">is_4d</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.is_4d"></a>
    
    

                            </div>
                            <div id="NiftiViewer.current_slices" class="classattr">
                                <div class="attr variable">
            <span class="name">current_slices</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.current_slices"></a>
    
    

                            </div>
                            <div id="NiftiViewer.current_time" class="classattr">
                                <div class="attr variable">
            <span class="name">current_time</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.current_time"></a>
    
    

                            </div>
                            <div id="NiftiViewer.current_coordinates" class="classattr">
                                <div class="attr variable">
            <span class="name">current_coordinates</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.current_coordinates"></a>
    
    

                            </div>
                            <div id="NiftiViewer.file_path" class="classattr">
                                <div class="attr variable">
            <span class="name">file_path</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.file_path"></a>
    
    

                            </div>
                            <div id="NiftiViewer.stretch_factors" class="classattr">
                                <div class="attr variable">
            <span class="name">stretch_factors</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.stretch_factors"></a>
    
    

                            </div>
                            <div id="NiftiViewer.voxel_sizes" class="classattr">
                                <div class="attr variable">
            <span class="name">voxel_sizes</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.voxel_sizes"></a>
    
    

                            </div>
                            <div id="NiftiViewer.overlay_data" class="classattr">
                                <div class="attr variable">
            <span class="name">overlay_data</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.overlay_data"></a>
    
    

                            </div>
                            <div id="NiftiViewer.overlay_dims" class="classattr">
                                <div class="attr variable">
            <span class="name">overlay_dims</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.overlay_dims"></a>
    
    

                            </div>
                            <div id="NiftiViewer.overlay_alpha" class="classattr">
                                <div class="attr variable">
            <span class="name">overlay_alpha</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.overlay_alpha"></a>
    
    

                            </div>
                            <div id="NiftiViewer.overlay_threshold" class="classattr">
                                <div class="attr variable">
            <span class="name">overlay_threshold</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.overlay_threshold"></a>
    
    

                            </div>
                            <div id="NiftiViewer.overlay_enabled" class="classattr">
                                <div class="attr variable">
            <span class="name">overlay_enabled</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.overlay_enabled"></a>
    
    

                            </div>
                            <div id="NiftiViewer.overlay_file_path" class="classattr">
                                <div class="attr variable">
            <span class="name">overlay_file_path</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.overlay_file_path"></a>
    
    

                            </div>
                            <div id="NiftiViewer.overlay_max" class="classattr">
                                <div class="attr variable">
            <span class="name">overlay_max</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.overlay_max"></a>
    
    

                            </div>
                            <div id="NiftiViewer.overlay_thresholded_data" class="classattr">
                                <div class="attr variable">
            <span class="name">overlay_thresholded_data</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.overlay_thresholded_data"></a>
    
    

                            </div>
                            <div id="NiftiViewer.info_text" class="classattr">
                                <div class="attr variable">
            <span class="name">info_text</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.info_text"></a>
    
    

                            </div>
                            <div id="NiftiViewer.plane_labels" class="classattr">
                                <div class="attr variable">
            <span class="name">plane_labels</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.plane_labels"></a>
    
    

                            </div>
                            <div id="NiftiViewer.status_bar" class="classattr">
                                <div class="attr variable">
            <span class="name">status_bar</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.status_bar"></a>
    
    

                            </div>
                            <div id="NiftiViewer.slice_info_label" class="classattr">
                                <div class="attr variable">
            <span class="name">slice_info_label</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.slice_info_label"></a>
    
    

                            </div>
                            <div id="NiftiViewer.value_label" class="classattr">
                                <div class="attr variable">
            <span class="name">value_label</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.value_label"></a>
    
    

                            </div>
                            <div id="NiftiViewer.coord_label" class="classattr">
                                <div class="attr variable">
            <span class="name">coord_label</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.coord_label"></a>
    
    

                            </div>
                            <div id="NiftiViewer.colormap" class="classattr">
                                <div class="attr variable">
            <span class="name">colormap</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.colormap"></a>
    
    

                            </div>
                            <div id="NiftiViewer.overlay_colors" class="classattr">
                                <div class="attr variable">
            <span class="name">overlay_colors</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.overlay_colors"></a>
    
    

                            </div>
                            <div id="NiftiViewer.views" class="classattr">
                                <div class="attr variable">
            <span class="name">views</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.views"></a>
    
    

                            </div>
                            <div id="NiftiViewer.scenes" class="classattr">
                                <div class="attr variable">
            <span class="name">scenes</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.scenes"></a>
    
    

                            </div>
                            <div id="NiftiViewer.pixmap_items" class="classattr">
                                <div class="attr variable">
            <span class="name">pixmap_items</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.pixmap_items"></a>
    
    

                            </div>
                            <div id="NiftiViewer.slice_sliders" class="classattr">
                                <div class="attr variable">
            <span class="name">slice_sliders</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.slice_sliders"></a>
    
    

                            </div>
                            <div id="NiftiViewer.slice_spins" class="classattr">
                                <div class="attr variable">
            <span class="name">slice_spins</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.slice_spins"></a>
    
    

                            </div>
                            <div id="NiftiViewer.slice_labels" class="classattr">
                                <div class="attr variable">
            <span class="name">slice_labels</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.slice_labels"></a>
    
    

                            </div>
                            <div id="NiftiViewer.coord_displays" class="classattr">
                                <div class="attr variable">
            <span class="name">coord_displays</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.coord_displays"></a>
    
    

                            </div>
                            <div id="NiftiViewer.time_slider" class="classattr">
                                <div class="attr variable">
            <span class="name">time_slider</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.time_slider"></a>
    
    

                            </div>
                            <div id="NiftiViewer.time_spin" class="classattr">
                                <div class="attr variable">
            <span class="name">time_spin</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.time_spin"></a>
    
    

                            </div>
                            <div id="NiftiViewer.time_checkbox" class="classattr">
                                <div class="attr variable">
            <span class="name">time_checkbox</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.time_checkbox"></a>
    
    

                            </div>
                            <div id="NiftiViewer.time_plot_figure" class="classattr">
                                <div class="attr variable">
            <span class="name">time_plot_figure</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.time_plot_figure"></a>
    
    

                            </div>
                            <div id="NiftiViewer.time_plot_canvas" class="classattr">
                                <div class="attr variable">
            <span class="name">time_plot_canvas</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.time_plot_canvas"></a>
    
    

                            </div>
                            <div id="NiftiViewer.file_info_label" class="classattr">
                                <div class="attr variable">
            <span class="name">file_info_label</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.file_info_label"></a>
    
    

                            </div>
                            <div id="NiftiViewer.slice_navigation_label" class="classattr">
                                <div class="attr variable">
            <span class="name">slice_navigation_label</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.slice_navigation_label"></a>
    
    

                            </div>
                            <div id="NiftiViewer.time_point_label" class="classattr">
                                <div class="attr variable">
            <span class="name">time_point_label</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.time_point_label"></a>
    
    

                            </div>
                            <div id="NiftiViewer.colormap_combo" class="classattr">
                                <div class="attr variable">
            <span class="name">colormap_combo</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.colormap_combo"></a>
    
    

                            </div>
                            <div id="NiftiViewer.overlay_threshold_slider" class="classattr">
                                <div class="attr variable">
            <span class="name">overlay_threshold_slider</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.overlay_threshold_slider"></a>
    
    

                            </div>
                            <div id="NiftiViewer.display_options_label" class="classattr">
                                <div class="attr variable">
            <span class="name">display_options_label</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.display_options_label"></a>
    
    

                            </div>
                            <div id="NiftiViewer.overlay_alpha_slider" class="classattr">
                                <div class="attr variable">
            <span class="name">overlay_alpha_slider</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.overlay_alpha_slider"></a>
    
    

                            </div>
                            <div id="NiftiViewer.overlay_info_label" class="classattr">
                                <div class="attr variable">
            <span class="name">overlay_info_label</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.overlay_info_label"></a>
    
    

                            </div>
                            <div id="NiftiViewer.automaticROI_data" class="classattr">
                                <div class="attr variable">
            <span class="name">automaticROI_data</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.automaticROI_data"></a>
    
    

                            </div>
                            <div id="NiftiViewer.automatic_ROI_label" class="classattr">
                                <div class="attr variable">
            <span class="name">automatic_ROI_label</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.automatic_ROI_label"></a>
    
    

                            </div>
                            <div id="NiftiViewer.automaticROIbtn" class="classattr">
                                <div class="attr variable">
            <span class="name">automaticROIbtn</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.automaticROIbtn"></a>
    
    

                            </div>
                            <div id="NiftiViewer.automaticROI_overlay" class="classattr">
                                <div class="attr variable">
            <span class="name">automaticROI_overlay</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.automaticROI_overlay"></a>
    
    

                            </div>
                            <div id="NiftiViewer.automaticROI_radius_slider" class="classattr">
                                <div class="attr variable">
            <span class="name">automaticROI_radius_slider</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.automaticROI_radius_slider"></a>
    
    

                            </div>
                            <div id="NiftiViewer.automaticROI_radius_label" class="classattr">
                                <div class="attr variable">
            <span class="name">automaticROI_radius_label</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.automaticROI_radius_label"></a>
    
    

                            </div>
                            <div id="NiftiViewer.automaticROI_diff_label" class="classattr">
                                <div class="attr variable">
            <span class="name">automaticROI_diff_label</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.automaticROI_diff_label"></a>
    
    

                            </div>
                            <div id="NiftiViewer.AutomaticROI_diff_slider" class="classattr">
                                <div class="attr variable">
            <span class="name">AutomaticROI_diff_slider</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.AutomaticROI_diff_slider"></a>
    
    

                            </div>
                            <div id="NiftiViewer.automaticROI_sliders_group" class="classattr">
                                <div class="attr variable">
            <span class="name">automaticROI_sliders_group</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.automaticROI_sliders_group"></a>
    
    

                            </div>
                            <div id="NiftiViewer.automaticROI_seed_coordinates" class="classattr">
                                <div class="attr variable">
            <span class="name">automaticROI_seed_coordinates</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.automaticROI_seed_coordinates"></a>
    
    

                            </div>
                            <div id="NiftiViewer.ROI_save_btn" class="classattr">
                                <div class="attr variable">
            <span class="name">ROI_save_btn</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.ROI_save_btn"></a>
    
    

                            </div>
                            <div id="NiftiViewer.incrementalROI_data" class="classattr">
                                <div class="attr variable">
            <span class="name">incrementalROI_data</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.incrementalROI_data"></a>
    
    

                            </div>
                            <div id="NiftiViewer.incrementalROI_checkbox" class="classattr">
                                <div class="attr variable">
            <span class="name">incrementalROI_checkbox</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.incrementalROI_checkbox"></a>
    
    

                            </div>
                            <div id="NiftiViewer.incrementalROI_enabled" class="classattr">
                                <div class="attr variable">
            <span class="name">incrementalROI_enabled</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.incrementalROI_enabled"></a>
    
    

                            </div>
                            <div id="NiftiViewer.addOrigin_btn" class="classattr">
                                <div class="attr variable">
            <span class="name">addOrigin_btn</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.addOrigin_btn"></a>
    
    

                            </div>
                            <div id="NiftiViewer.cancelROI_btn" class="classattr">
                                <div class="attr variable">
            <span class="name">cancelROI_btn</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.cancelROI_btn"></a>
    
    

                            </div>
                            <div id="NiftiViewer.incrementalROI_origins" class="classattr">
                                <div class="attr variable">
            <span class="name">incrementalROI_origins</span>

        
    </div>
    <a class="headerlink" href="#NiftiViewer.incrementalROI_origins"></a>
    
    

                            </div>
                            <div id="NiftiViewer.init_ui" class="classattr">
                                        <input id="NiftiViewer.init_ui-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">init_ui</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.init_ui-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.init_ui"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.init_ui-272"><a href="#NiftiViewer.init_ui-272"><span class="linenos">272</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.init_ui-273"><a href="#NiftiViewer.init_ui-273"><span class="linenos">273</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.init_ui-274"><a href="#NiftiViewer.init_ui-274"><span class="linenos">274</span></a><span class="sd">        Initialize the main user interface of the NIfTI Viewer.</span>
</span><span id="NiftiViewer.init_ui-275"><a href="#NiftiViewer.init_ui-275"><span class="linenos">275</span></a>
</span><span id="NiftiViewer.init_ui-276"><a href="#NiftiViewer.init_ui-276"><span class="linenos">276</span></a><span class="sd">        This method builds the primary application layout, including:</span>
</span><span id="NiftiViewer.init_ui-277"><a href="#NiftiViewer.init_ui-277"><span class="linenos">277</span></a><span class="sd">        - A central widget that contains a horizontal splitter.</span>
</span><span id="NiftiViewer.init_ui-278"><a href="#NiftiViewer.init_ui-278"><span class="linenos">278</span></a><span class="sd">        - A left control panel for user interactions (file operations, display options, etc.).</span>
</span><span id="NiftiViewer.init_ui-279"><a href="#NiftiViewer.init_ui-279"><span class="linenos">279</span></a><span class="sd">        - A right area dedicated to image visualization.</span>
</span><span id="NiftiViewer.init_ui-280"><a href="#NiftiViewer.init_ui-280"><span class="linenos">280</span></a><span class="sd">        - A status bar for displaying real-time information (coordinates, intensity values, slice index).</span>
</span><span id="NiftiViewer.init_ui-281"><a href="#NiftiViewer.init_ui-281"><span class="linenos">281</span></a>
</span><span id="NiftiViewer.init_ui-282"><a href="#NiftiViewer.init_ui-282"><span class="linenos">282</span></a><span class="sd">        The layout uses a responsive design with adjustable proportions between</span>
</span><span id="NiftiViewer.init_ui-283"><a href="#NiftiViewer.init_ui-283"><span class="linenos">283</span></a><span class="sd">        the control panel and the image display area.</span>
</span><span id="NiftiViewer.init_ui-284"><a href="#NiftiViewer.init_ui-284"><span class="linenos">284</span></a>
</span><span id="NiftiViewer.init_ui-285"><a href="#NiftiViewer.init_ui-285"><span class="linenos">285</span></a><span class="sd">        Raises:</span>
</span><span id="NiftiViewer.init_ui-286"><a href="#NiftiViewer.init_ui-286"><span class="linenos">286</span></a><span class="sd">            Exception: Propagates exceptions from widget creation or layout setup.</span>
</span><span id="NiftiViewer.init_ui-287"><a href="#NiftiViewer.init_ui-287"><span class="linenos">287</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.init_ui-288"><a href="#NiftiViewer.init_ui-288"><span class="linenos">288</span></a>        <span class="c1"># Create the central widget that will contain the main splitter</span>
</span><span id="NiftiViewer.init_ui-289"><a href="#NiftiViewer.init_ui-289"><span class="linenos">289</span></a>        <span class="n">central_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer.init_ui-290"><a href="#NiftiViewer.init_ui-290"><span class="linenos">290</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setCentralWidget</span><span class="p">(</span><span class="n">central_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.init_ui-291"><a href="#NiftiViewer.init_ui-291"><span class="linenos">291</span></a>
</span><span id="NiftiViewer.init_ui-292"><a href="#NiftiViewer.init_ui-292"><span class="linenos">292</span></a>        <span class="c1"># Create a horizontal splitter for side-by-side layout (control panel + image display)</span>
</span><span id="NiftiViewer.init_ui-293"><a href="#NiftiViewer.init_ui-293"><span class="linenos">293</span></a>        <span class="n">main_splitter</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="NiftiViewer.init_ui-294"><a href="#NiftiViewer.init_ui-294"><span class="linenos">294</span></a>        <span class="n">central_widget</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">central_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.init_ui-295"><a href="#NiftiViewer.init_ui-295"><span class="linenos">295</span></a>        <span class="n">central_widget</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer.init_ui-296"><a href="#NiftiViewer.init_ui-296"><span class="linenos">296</span></a>        <span class="n">central_widget</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">main_splitter</span><span class="p">)</span>
</span><span id="NiftiViewer.init_ui-297"><a href="#NiftiViewer.init_ui-297"><span class="linenos">297</span></a>
</span><span id="NiftiViewer.init_ui-298"><a href="#NiftiViewer.init_ui-298"><span class="linenos">298</span></a>        <span class="c1"># Initialize and attach the left control panel to the splitter</span>
</span><span id="NiftiViewer.init_ui-299"><a href="#NiftiViewer.init_ui-299"><span class="linenos">299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">create_control_panel</span><span class="p">(</span><span class="n">main_splitter</span><span class="p">)</span>
</span><span id="NiftiViewer.init_ui-300"><a href="#NiftiViewer.init_ui-300"><span class="linenos">300</span></a>
</span><span id="NiftiViewer.init_ui-301"><a href="#NiftiViewer.init_ui-301"><span class="linenos">301</span></a>        <span class="c1"># Initialize and attach the right image display area to the splitter</span>
</span><span id="NiftiViewer.init_ui-302"><a href="#NiftiViewer.init_ui-302"><span class="linenos">302</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">create_image_display</span><span class="p">(</span><span class="n">main_splitter</span><span class="p">)</span>
</span><span id="NiftiViewer.init_ui-303"><a href="#NiftiViewer.init_ui-303"><span class="linenos">303</span></a>
</span><span id="NiftiViewer.init_ui-304"><a href="#NiftiViewer.init_ui-304"><span class="linenos">304</span></a>        <span class="c1"># Define relative sizes and resizing behavior of the splitter sections</span>
</span><span id="NiftiViewer.init_ui-305"><a href="#NiftiViewer.init_ui-305"><span class="linenos">305</span></a>        <span class="n">main_splitter</span><span class="o">.</span><span class="n">setSizes</span><span class="p">([</span><span class="mi">300</span><span class="p">,</span> <span class="mi">1100</span><span class="p">])</span>  <span class="c1"># Default size proportions</span>
</span><span id="NiftiViewer.init_ui-306"><a href="#NiftiViewer.init_ui-306"><span class="linenos">306</span></a>        <span class="n">main_splitter</span><span class="o">.</span><span class="n">setStretchFactor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Fix the control panel width</span>
</span><span id="NiftiViewer.init_ui-307"><a href="#NiftiViewer.init_ui-307"><span class="linenos">307</span></a>        <span class="n">main_splitter</span><span class="o">.</span><span class="n">setStretchFactor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Allow image display to stretch</span>
</span><span id="NiftiViewer.init_ui-308"><a href="#NiftiViewer.init_ui-308"><span class="linenos">308</span></a>
</span><span id="NiftiViewer.init_ui-309"><a href="#NiftiViewer.init_ui-309"><span class="linenos">309</span></a>        <span class="c1"># Create and set up the status bar at the bottom of the window</span>
</span><span id="NiftiViewer.init_ui-310"><a href="#NiftiViewer.init_ui-310"><span class="linenos">310</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span> <span class="o">=</span> <span class="n">QStatusBar</span><span class="p">()</span>
</span><span id="NiftiViewer.init_ui-311"><a href="#NiftiViewer.init_ui-311"><span class="linenos">311</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setStatusBar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="p">)</span>
</span><span id="NiftiViewer.init_ui-312"><a href="#NiftiViewer.init_ui-312"><span class="linenos">312</span></a>
</span><span id="NiftiViewer.init_ui-313"><a href="#NiftiViewer.init_ui-313"><span class="linenos">313</span></a>        <span class="c1"># Initialize status bar labels for dynamic coordinate and voxel value display</span>
</span><span id="NiftiViewer.init_ui-314"><a href="#NiftiViewer.init_ui-314"><span class="linenos">314</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coordinates: (-, -, -)&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.init_ui-315"><a href="#NiftiViewer.init_ui-315"><span class="linenos">315</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Value: -&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.init_ui-316"><a href="#NiftiViewer.init_ui-316"><span class="linenos">316</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_info_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Slice: -/-&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.init_ui-317"><a href="#NiftiViewer.init_ui-317"><span class="linenos">317</span></a>
</span><span id="NiftiViewer.init_ui-318"><a href="#NiftiViewer.init_ui-318"><span class="linenos">318</span></a>        <span class="c1"># Display initial status message when the viewer is ready</span>
</span><span id="NiftiViewer.init_ui-319"><a href="#NiftiViewer.init_ui-319"><span class="linenos">319</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
</span><span id="NiftiViewer.init_ui-320"><a href="#NiftiViewer.init_ui-320"><span class="linenos">320</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Ready - Open a NIfTI file to begin&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.init_ui-321"><a href="#NiftiViewer.init_ui-321"><span class="linenos">321</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the main user interface of the NIfTI Viewer.</p>

<p>This method builds the primary application layout, including:</p>

<ul>
<li>A central widget that contains a horizontal splitter.</li>
<li>A left control panel for user interactions (file operations, display options, etc.).</li>
<li>A right area dedicated to image visualization.</li>
<li>A status bar for displaying real-time information (coordinates, intensity values, slice index).</li>
</ul>

<p>The layout uses a responsive design with adjustable proportions between
the control panel and the image display area.</p>

<p>Raises:
    Exception: Propagates exceptions from widget creation or layout setup.</p>
</div>


                            </div>
                            <div id="NiftiViewer.create_control_panel" class="classattr">
                                        <input id="NiftiViewer.create_control_panel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_control_panel</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">parent</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.create_control_panel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.create_control_panel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.create_control_panel-323"><a href="#NiftiViewer.create_control_panel-323"><span class="linenos">323</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_control_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
</span><span id="NiftiViewer.create_control_panel-324"><a href="#NiftiViewer.create_control_panel-324"><span class="linenos">324</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.create_control_panel-325"><a href="#NiftiViewer.create_control_panel-325"><span class="linenos">325</span></a><span class="sd">        Create the left-side control panel for the NIfTI Viewer interface.</span>
</span><span id="NiftiViewer.create_control_panel-326"><a href="#NiftiViewer.create_control_panel-326"><span class="linenos">326</span></a>
</span><span id="NiftiViewer.create_control_panel-327"><a href="#NiftiViewer.create_control_panel-327"><span class="linenos">327</span></a><span class="sd">        This method builds an interactive, scrollable control panel that allows</span>
</span><span id="NiftiViewer.create_control_panel-328"><a href="#NiftiViewer.create_control_panel-328"><span class="linenos">328</span></a><span class="sd">        the user to:</span>
</span><span id="NiftiViewer.create_control_panel-329"><a href="#NiftiViewer.create_control_panel-329"><span class="linenos">329</span></a><span class="sd">          - Open and display NIfTI files.</span>
</span><span id="NiftiViewer.create_control_panel-330"><a href="#NiftiViewer.create_control_panel-330"><span class="linenos">330</span></a><span class="sd">          - Navigate through 2D slices in axial, coronal, and sagittal planes.</span>
</span><span id="NiftiViewer.create_control_panel-331"><a href="#NiftiViewer.create_control_panel-331"><span class="linenos">331</span></a><span class="sd">          - Control time navigation for 4D datasets.</span>
</span><span id="NiftiViewer.create_control_panel-332"><a href="#NiftiViewer.create_control_panel-332"><span class="linenos">332</span></a><span class="sd">          - Adjust visualization parameters such as colormap and display options.</span>
</span><span id="NiftiViewer.create_control_panel-333"><a href="#NiftiViewer.create_control_panel-333"><span class="linenos">333</span></a><span class="sd">          - Perform automatic ROI (Region of Interest) generation.</span>
</span><span id="NiftiViewer.create_control_panel-334"><a href="#NiftiViewer.create_control_panel-334"><span class="linenos">334</span></a><span class="sd">          - Manage overlay images (load, transparency, threshold, enable/disable).</span>
</span><span id="NiftiViewer.create_control_panel-335"><a href="#NiftiViewer.create_control_panel-335"><span class="linenos">335</span></a>
</span><span id="NiftiViewer.create_control_panel-336"><a href="#NiftiViewer.create_control_panel-336"><span class="linenos">336</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.create_control_panel-337"><a href="#NiftiViewer.create_control_panel-337"><span class="linenos">337</span></a><span class="sd">            parent (QSplitter): The parent splitter widget where the control panel is added.</span>
</span><span id="NiftiViewer.create_control_panel-338"><a href="#NiftiViewer.create_control_panel-338"><span class="linenos">338</span></a>
</span><span id="NiftiViewer.create_control_panel-339"><a href="#NiftiViewer.create_control_panel-339"><span class="linenos">339</span></a><span class="sd">        Raises:</span>
</span><span id="NiftiViewer.create_control_panel-340"><a href="#NiftiViewer.create_control_panel-340"><span class="linenos">340</span></a><span class="sd">            Exception: Propagates exceptions from any UI creation or layout step.</span>
</span><span id="NiftiViewer.create_control_panel-341"><a href="#NiftiViewer.create_control_panel-341"><span class="linenos">341</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.create_control_panel-342"><a href="#NiftiViewer.create_control_panel-342"><span class="linenos">342</span></a>
</span><span id="NiftiViewer.create_control_panel-343"><a href="#NiftiViewer.create_control_panel-343"><span class="linenos">343</span></a>        <span class="c1"># Scroll area wrapper (enables vertical scrolling for the control panel)</span>
</span><span id="NiftiViewer.create_control_panel-344"><a href="#NiftiViewer.create_control_panel-344"><span class="linenos">344</span></a>        <span class="n">scroll_area</span> <span class="o">=</span> <span class="n">QScrollArea</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-345"><a href="#NiftiViewer.create_control_panel-345"><span class="linenos">345</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setWidgetResizable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-346"><a href="#NiftiViewer.create_control_panel-346"><span class="linenos">346</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setHorizontalScrollBarPolicy</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ScrollBarPolicy</span><span class="o">.</span><span class="n">ScrollBarAlwaysOff</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-347"><a href="#NiftiViewer.create_control_panel-347"><span class="linenos">347</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setVerticalScrollBarPolicy</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ScrollBarPolicy</span><span class="o">.</span><span class="n">ScrollBarAsNeeded</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-348"><a href="#NiftiViewer.create_control_panel-348"><span class="linenos">348</span></a>
</span><span id="NiftiViewer.create_control_panel-349"><a href="#NiftiViewer.create_control_panel-349"><span class="linenos">349</span></a>        <span class="c1"># Control panel main content widget and layout</span>
</span><span id="NiftiViewer.create_control_panel-350"><a href="#NiftiViewer.create_control_panel-350"><span class="linenos">350</span></a>        <span class="n">control_content</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-351"><a href="#NiftiViewer.create_control_panel-351"><span class="linenos">351</span></a>        <span class="n">control_content</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">340</span><span class="p">)</span>  <span class="c1"># Prevent horizontal scrolling</span>
</span><span id="NiftiViewer.create_control_panel-352"><a href="#NiftiViewer.create_control_panel-352"><span class="linenos">352</span></a>        <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">control_content</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-353"><a href="#NiftiViewer.create_control_panel-353"><span class="linenos">353</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-354"><a href="#NiftiViewer.create_control_panel-354"><span class="linenos">354</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-355"><a href="#NiftiViewer.create_control_panel-355"><span class="linenos">355</span></a>
</span><span id="NiftiViewer.create_control_panel-356"><a href="#NiftiViewer.create_control_panel-356"><span class="linenos">356</span></a>        <span class="c1"># ========================</span>
</span><span id="NiftiViewer.create_control_panel-357"><a href="#NiftiViewer.create_control_panel-357"><span class="linenos">357</span></a>        <span class="c1"># File Operations Group</span>
</span><span id="NiftiViewer.create_control_panel-358"><a href="#NiftiViewer.create_control_panel-358"><span class="linenos">358</span></a>        <span class="c1"># ========================</span>
</span><span id="NiftiViewer.create_control_panel-359"><a href="#NiftiViewer.create_control_panel-359"><span class="linenos">359</span></a>        <span class="n">file_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-360"><a href="#NiftiViewer.create_control_panel-360"><span class="linenos">360</span></a>        <span class="n">file_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">file_group</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-361"><a href="#NiftiViewer.create_control_panel-361"><span class="linenos">361</span></a>        <span class="n">file_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-362"><a href="#NiftiViewer.create_control_panel-362"><span class="linenos">362</span></a>
</span><span id="NiftiViewer.create_control_panel-363"><a href="#NiftiViewer.create_control_panel-363"><span class="linenos">363</span></a>        <span class="c1"># Button to open NIfTI files</span>
</span><span id="NiftiViewer.create_control_panel-364"><a href="#NiftiViewer.create_control_panel-364"><span class="linenos">364</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot; Open NIfTI&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-365"><a href="#NiftiViewer.create_control_panel-365"><span class="linenos">365</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-366"><a href="#NiftiViewer.create_control_panel-366"><span class="linenos">366</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-367"><a href="#NiftiViewer.create_control_panel-367"><span class="linenos">367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-368"><a href="#NiftiViewer.create_control_panel-368"><span class="linenos">368</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Open NIfTI File&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-369"><a href="#NiftiViewer.create_control_panel-369"><span class="linenos">369</span></a>        <span class="n">file_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-370"><a href="#NiftiViewer.create_control_panel-370"><span class="linenos">370</span></a>
</span><span id="NiftiViewer.create_control_panel-371"><a href="#NiftiViewer.create_control_panel-371"><span class="linenos">371</span></a>        <span class="c1"># Label displaying currently loaded file info</span>
</span><span id="NiftiViewer.create_control_panel-372"><a href="#NiftiViewer.create_control_panel-372"><span class="linenos">372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No file loaded&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-373"><a href="#NiftiViewer.create_control_panel-373"><span class="linenos">373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setWordWrap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-374"><a href="#NiftiViewer.create_control_panel-374"><span class="linenos">374</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-375"><a href="#NiftiViewer.create_control_panel-375"><span class="linenos">375</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-376"><a href="#NiftiViewer.create_control_panel-376"><span class="linenos">376</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-377"><a href="#NiftiViewer.create_control_panel-377"><span class="linenos">377</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-378"><a href="#NiftiViewer.create_control_panel-378"><span class="linenos">378</span></a>        <span class="n">file_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-379"><a href="#NiftiViewer.create_control_panel-379"><span class="linenos">379</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">file_group</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-380"><a href="#NiftiViewer.create_control_panel-380"><span class="linenos">380</span></a>
</span><span id="NiftiViewer.create_control_panel-381"><a href="#NiftiViewer.create_control_panel-381"><span class="linenos">381</span></a>        <span class="c1"># =====================</span>
</span><span id="NiftiViewer.create_control_panel-382"><a href="#NiftiViewer.create_control_panel-382"><span class="linenos">382</span></a>        <span class="c1"># Slice Navigation</span>
</span><span id="NiftiViewer.create_control_panel-383"><a href="#NiftiViewer.create_control_panel-383"><span class="linenos">383</span></a>        <span class="c1"># =====================</span>
</span><span id="NiftiViewer.create_control_panel-384"><a href="#NiftiViewer.create_control_panel-384"><span class="linenos">384</span></a>        <span class="n">slice_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-385"><a href="#NiftiViewer.create_control_panel-385"><span class="linenos">385</span></a>        <span class="n">slice_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">slice_group</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-386"><a href="#NiftiViewer.create_control_panel-386"><span class="linenos">386</span></a>        <span class="n">slice_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-387"><a href="#NiftiViewer.create_control_panel-387"><span class="linenos">387</span></a>
</span><span id="NiftiViewer.create_control_panel-388"><a href="#NiftiViewer.create_control_panel-388"><span class="linenos">388</span></a>        <span class="c1"># Section label</span>
</span><span id="NiftiViewer.create_control_panel-389"><a href="#NiftiViewer.create_control_panel-389"><span class="linenos">389</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Slice Navigation:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-390"><a href="#NiftiViewer.create_control_panel-390"><span class="linenos">390</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-391"><a href="#NiftiViewer.create_control_panel-391"><span class="linenos">391</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-392"><a href="#NiftiViewer.create_control_panel-392"><span class="linenos">392</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; font-size: 11px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-393"><a href="#NiftiViewer.create_control_panel-393"><span class="linenos">393</span></a>        <span class="n">slice_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_navigation_label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-394"><a href="#NiftiViewer.create_control_panel-394"><span class="linenos">394</span></a>
</span><span id="NiftiViewer.create_control_panel-395"><a href="#NiftiViewer.create_control_panel-395"><span class="linenos">395</span></a>        <span class="n">plane_names</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="NiftiViewer.create_control_panel-396"><a href="#NiftiViewer.create_control_panel-396"><span class="linenos">396</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Axial (Z)&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer.create_control_panel-397"><a href="#NiftiViewer.create_control_panel-397"><span class="linenos">397</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coronal (Y)&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer.create_control_panel-398"><a href="#NiftiViewer.create_control_panel-398"><span class="linenos">398</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Sagittal (X)&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-399"><a href="#NiftiViewer.create_control_panel-399"><span class="linenos">399</span></a>        <span class="p">]</span>
</span><span id="NiftiViewer.create_control_panel-400"><a href="#NiftiViewer.create_control_panel-400"><span class="linenos">400</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plane_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer.create_control_panel-401"><a href="#NiftiViewer.create_control_panel-401"><span class="linenos">401</span></a>
</span><span id="NiftiViewer.create_control_panel-402"><a href="#NiftiViewer.create_control_panel-402"><span class="linenos">402</span></a>        <span class="c1"># Create controls for each anatomical plane</span>
</span><span id="NiftiViewer.create_control_panel-403"><a href="#NiftiViewer.create_control_panel-403"><span class="linenos">403</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">plane_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plane_names</span><span class="p">):</span>
</span><span id="NiftiViewer.create_control_panel-404"><a href="#NiftiViewer.create_control_panel-404"><span class="linenos">404</span></a>            <span class="c1"># Label for plane name</span>
</span><span id="NiftiViewer.create_control_panel-405"><a href="#NiftiViewer.create_control_panel-405"><span class="linenos">405</span></a>            <span class="n">label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">plane_name</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-406"><a href="#NiftiViewer.create_control_panel-406"><span class="linenos">406</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plane_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-407"><a href="#NiftiViewer.create_control_panel-407"><span class="linenos">407</span></a>            <span class="n">label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; margin-top: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-408"><a href="#NiftiViewer.create_control_panel-408"><span class="linenos">408</span></a>            <span class="n">label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-409"><a href="#NiftiViewer.create_control_panel-409"><span class="linenos">409</span></a>            <span class="n">slice_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-410"><a href="#NiftiViewer.create_control_panel-410"><span class="linenos">410</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-411"><a href="#NiftiViewer.create_control_panel-411"><span class="linenos">411</span></a>
</span><span id="NiftiViewer.create_control_panel-412"><a href="#NiftiViewer.create_control_panel-412"><span class="linenos">412</span></a>            <span class="c1"># Container for slider + spinbox + coordinates</span>
</span><span id="NiftiViewer.create_control_panel-413"><a href="#NiftiViewer.create_control_panel-413"><span class="linenos">413</span></a>            <span class="n">controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-414"><a href="#NiftiViewer.create_control_panel-414"><span class="linenos">414</span></a>            <span class="n">controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-415"><a href="#NiftiViewer.create_control_panel-415"><span class="linenos">415</span></a>            <span class="n">controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-416"><a href="#NiftiViewer.create_control_panel-416"><span class="linenos">416</span></a>            <span class="n">controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-417"><a href="#NiftiViewer.create_control_panel-417"><span class="linenos">417</span></a>
</span><span id="NiftiViewer.create_control_panel-418"><a href="#NiftiViewer.create_control_panel-418"><span class="linenos">418</span></a>            <span class="c1"># Slice slider</span>
</span><span id="NiftiViewer.create_control_panel-419"><a href="#NiftiViewer.create_control_panel-419"><span class="linenos">419</span></a>            <span class="n">slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-420"><a href="#NiftiViewer.create_control_panel-420"><span class="linenos">420</span></a>            <span class="n">slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-421"><a href="#NiftiViewer.create_control_panel-421"><span class="linenos">421</span></a>            <span class="n">slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-422"><a href="#NiftiViewer.create_control_panel-422"><span class="linenos">422</span></a>            <span class="n">slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-423"><a href="#NiftiViewer.create_control_panel-423"><span class="linenos">423</span></a>            <span class="n">slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-424"><a href="#NiftiViewer.create_control_panel-424"><span class="linenos">424</span></a>            <span class="n">controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-425"><a href="#NiftiViewer.create_control_panel-425"><span class="linenos">425</span></a>
</span><span id="NiftiViewer.create_control_panel-426"><a href="#NiftiViewer.create_control_panel-426"><span class="linenos">426</span></a>            <span class="c1"># Spinbox to match slider</span>
</span><span id="NiftiViewer.create_control_panel-427"><a href="#NiftiViewer.create_control_panel-427"><span class="linenos">427</span></a>            <span class="n">spinbox</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-428"><a href="#NiftiViewer.create_control_panel-428"><span class="linenos">428</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-429"><a href="#NiftiViewer.create_control_panel-429"><span class="linenos">429</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-430"><a href="#NiftiViewer.create_control_panel-430"><span class="linenos">430</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-431"><a href="#NiftiViewer.create_control_panel-431"><span class="linenos">431</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-432"><a href="#NiftiViewer.create_control_panel-432"><span class="linenos">432</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-433"><a href="#NiftiViewer.create_control_panel-433"><span class="linenos">433</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-434"><a href="#NiftiViewer.create_control_panel-434"><span class="linenos">434</span></a>            <span class="n">controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">spinbox</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-435"><a href="#NiftiViewer.create_control_panel-435"><span class="linenos">435</span></a>
</span><span id="NiftiViewer.create_control_panel-436"><a href="#NiftiViewer.create_control_panel-436"><span class="linenos">436</span></a>            <span class="c1"># Coordinate label display</span>
</span><span id="NiftiViewer.create_control_panel-437"><a href="#NiftiViewer.create_control_panel-437"><span class="linenos">437</span></a>            <span class="n">coord_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;(-, -)&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-438"><a href="#NiftiViewer.create_control_panel-438"><span class="linenos">438</span></a>            <span class="n">coord_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: #4CAF50; font-weight: bold; font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-439"><a href="#NiftiViewer.create_control_panel-439"><span class="linenos">439</span></a>            <span class="n">coord_label</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-440"><a href="#NiftiViewer.create_control_panel-440"><span class="linenos">440</span></a>            <span class="n">coord_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-441"><a href="#NiftiViewer.create_control_panel-441"><span class="linenos">441</span></a>            <span class="n">coord_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-442"><a href="#NiftiViewer.create_control_panel-442"><span class="linenos">442</span></a>            <span class="n">controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">coord_label</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-443"><a href="#NiftiViewer.create_control_panel-443"><span class="linenos">443</span></a>
</span><span id="NiftiViewer.create_control_panel-444"><a href="#NiftiViewer.create_control_panel-444"><span class="linenos">444</span></a>            <span class="n">controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-445"><a href="#NiftiViewer.create_control_panel-445"><span class="linenos">445</span></a>            <span class="n">slice_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-446"><a href="#NiftiViewer.create_control_panel-446"><span class="linenos">446</span></a>
</span><span id="NiftiViewer.create_control_panel-447"><a href="#NiftiViewer.create_control_panel-447"><span class="linenos">447</span></a>            <span class="c1"># Store references</span>
</span><span id="NiftiViewer.create_control_panel-448"><a href="#NiftiViewer.create_control_panel-448"><span class="linenos">448</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slider</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-449"><a href="#NiftiViewer.create_control_panel-449"><span class="linenos">449</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spinbox</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-450"><a href="#NiftiViewer.create_control_panel-450"><span class="linenos">450</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coord_displays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord_label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-451"><a href="#NiftiViewer.create_control_panel-451"><span class="linenos">451</span></a>
</span><span id="NiftiViewer.create_control_panel-452"><a href="#NiftiViewer.create_control_panel-452"><span class="linenos">452</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">slice_group</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-453"><a href="#NiftiViewer.create_control_panel-453"><span class="linenos">453</span></a>
</span><span id="NiftiViewer.create_control_panel-454"><a href="#NiftiViewer.create_control_panel-454"><span class="linenos">454</span></a>        <span class="c1"># ===================</span>
</span><span id="NiftiViewer.create_control_panel-455"><a href="#NiftiViewer.create_control_panel-455"><span class="linenos">455</span></a>        <span class="c1">#  4D Time Controls</span>
</span><span id="NiftiViewer.create_control_panel-456"><a href="#NiftiViewer.create_control_panel-456"><span class="linenos">456</span></a>        <span class="c1"># ===================</span>
</span><span id="NiftiViewer.create_control_panel-457"><a href="#NiftiViewer.create_control_panel-457"><span class="linenos">457</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-458"><a href="#NiftiViewer.create_control_panel-458"><span class="linenos">458</span></a>        <span class="n">time_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_group</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-459"><a href="#NiftiViewer.create_control_panel-459"><span class="linenos">459</span></a>        <span class="n">time_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-460"><a href="#NiftiViewer.create_control_panel-460"><span class="linenos">460</span></a>
</span><span id="NiftiViewer.create_control_panel-461"><a href="#NiftiViewer.create_control_panel-461"><span class="linenos">461</span></a>        <span class="c1"># Enable time navigation</span>
</span><span id="NiftiViewer.create_control_panel-462"><a href="#NiftiViewer.create_control_panel-462"><span class="linenos">462</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Enable 4D Time Navigation&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-463"><a href="#NiftiViewer.create_control_panel-463"><span class="linenos">463</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-464"><a href="#NiftiViewer.create_control_panel-464"><span class="linenos">464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-465"><a href="#NiftiViewer.create_control_panel-465"><span class="linenos">465</span></a>        <span class="n">time_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-466"><a href="#NiftiViewer.create_control_panel-466"><span class="linenos">466</span></a>
</span><span id="NiftiViewer.create_control_panel-467"><a href="#NiftiViewer.create_control_panel-467"><span class="linenos">467</span></a>        <span class="c1"># Slider + spinbox controls for time navigation</span>
</span><span id="NiftiViewer.create_control_panel-468"><a href="#NiftiViewer.create_control_panel-468"><span class="linenos">468</span></a>        <span class="n">time_controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-469"><a href="#NiftiViewer.create_control_panel-469"><span class="linenos">469</span></a>        <span class="n">time_controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">time_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-470"><a href="#NiftiViewer.create_control_panel-470"><span class="linenos">470</span></a>        <span class="n">time_controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-471"><a href="#NiftiViewer.create_control_panel-471"><span class="linenos">471</span></a>        <span class="n">time_controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-472"><a href="#NiftiViewer.create_control_panel-472"><span class="linenos">472</span></a>
</span><span id="NiftiViewer.create_control_panel-473"><a href="#NiftiViewer.create_control_panel-473"><span class="linenos">473</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-474"><a href="#NiftiViewer.create_control_panel-474"><span class="linenos">474</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-475"><a href="#NiftiViewer.create_control_panel-475"><span class="linenos">475</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-476"><a href="#NiftiViewer.create_control_panel-476"><span class="linenos">476</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-477"><a href="#NiftiViewer.create_control_panel-477"><span class="linenos">477</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-478"><a href="#NiftiViewer.create_control_panel-478"><span class="linenos">478</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-479"><a href="#NiftiViewer.create_control_panel-479"><span class="linenos">479</span></a>        <span class="n">time_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-480"><a href="#NiftiViewer.create_control_panel-480"><span class="linenos">480</span></a>
</span><span id="NiftiViewer.create_control_panel-481"><a href="#NiftiViewer.create_control_panel-481"><span class="linenos">481</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-482"><a href="#NiftiViewer.create_control_panel-482"><span class="linenos">482</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-483"><a href="#NiftiViewer.create_control_panel-483"><span class="linenos">483</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-484"><a href="#NiftiViewer.create_control_panel-484"><span class="linenos">484</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-485"><a href="#NiftiViewer.create_control_panel-485"><span class="linenos">485</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-486"><a href="#NiftiViewer.create_control_panel-486"><span class="linenos">486</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-487"><a href="#NiftiViewer.create_control_panel-487"><span class="linenos">487</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-488"><a href="#NiftiViewer.create_control_panel-488"><span class="linenos">488</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-489"><a href="#NiftiViewer.create_control_panel-489"><span class="linenos">489</span></a>        <span class="n">time_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-490"><a href="#NiftiViewer.create_control_panel-490"><span class="linenos">490</span></a>
</span><span id="NiftiViewer.create_control_panel-491"><a href="#NiftiViewer.create_control_panel-491"><span class="linenos">491</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Time Point:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-492"><a href="#NiftiViewer.create_control_panel-492"><span class="linenos">492</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-493"><a href="#NiftiViewer.create_control_panel-493"><span class="linenos">493</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-494"><a href="#NiftiViewer.create_control_panel-494"><span class="linenos">494</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 11px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-495"><a href="#NiftiViewer.create_control_panel-495"><span class="linenos">495</span></a>        <span class="n">time_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-496"><a href="#NiftiViewer.create_control_panel-496"><span class="linenos">496</span></a>        <span class="n">time_controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-497"><a href="#NiftiViewer.create_control_panel-497"><span class="linenos">497</span></a>        <span class="n">time_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">time_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-498"><a href="#NiftiViewer.create_control_panel-498"><span class="linenos">498</span></a>
</span><span id="NiftiViewer.create_control_panel-499"><a href="#NiftiViewer.create_control_panel-499"><span class="linenos">499</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-500"><a href="#NiftiViewer.create_control_panel-500"><span class="linenos">500</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_group</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-501"><a href="#NiftiViewer.create_control_panel-501"><span class="linenos">501</span></a>
</span><span id="NiftiViewer.create_control_panel-502"><a href="#NiftiViewer.create_control_panel-502"><span class="linenos">502</span></a>        <span class="c1"># ======================</span>
</span><span id="NiftiViewer.create_control_panel-503"><a href="#NiftiViewer.create_control_panel-503"><span class="linenos">503</span></a>        <span class="c1">#  Display Options</span>
</span><span id="NiftiViewer.create_control_panel-504"><a href="#NiftiViewer.create_control_panel-504"><span class="linenos">504</span></a>        <span class="c1"># ======================</span>
</span><span id="NiftiViewer.create_control_panel-505"><a href="#NiftiViewer.create_control_panel-505"><span class="linenos">505</span></a>        <span class="n">display_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-506"><a href="#NiftiViewer.create_control_panel-506"><span class="linenos">506</span></a>        <span class="n">display_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">display_group</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-507"><a href="#NiftiViewer.create_control_panel-507"><span class="linenos">507</span></a>        <span class="n">display_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-508"><a href="#NiftiViewer.create_control_panel-508"><span class="linenos">508</span></a>
</span><span id="NiftiViewer.create_control_panel-509"><a href="#NiftiViewer.create_control_panel-509"><span class="linenos">509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Display Options:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-510"><a href="#NiftiViewer.create_control_panel-510"><span class="linenos">510</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-511"><a href="#NiftiViewer.create_control_panel-511"><span class="linenos">511</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-512"><a href="#NiftiViewer.create_control_panel-512"><span class="linenos">512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; font-size: 11px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-513"><a href="#NiftiViewer.create_control_panel-513"><span class="linenos">513</span></a>        <span class="n">display_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_options_label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-514"><a href="#NiftiViewer.create_control_panel-514"><span class="linenos">514</span></a>
</span><span id="NiftiViewer.create_control_panel-515"><a href="#NiftiViewer.create_control_panel-515"><span class="linenos">515</span></a>        <span class="c1"># Colormap selection dropdown</span>
</span><span id="NiftiViewer.create_control_panel-516"><a href="#NiftiViewer.create_control_panel-516"><span class="linenos">516</span></a>        <span class="n">colormap_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-517"><a href="#NiftiViewer.create_control_panel-517"><span class="linenos">517</span></a>        <span class="n">colormap_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">colormap_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-518"><a href="#NiftiViewer.create_control_panel-518"><span class="linenos">518</span></a>        <span class="n">colormap_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-519"><a href="#NiftiViewer.create_control_panel-519"><span class="linenos">519</span></a>        <span class="n">colormap_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-520"><a href="#NiftiViewer.create_control_panel-520"><span class="linenos">520</span></a>
</span><span id="NiftiViewer.create_control_panel-521"><a href="#NiftiViewer.create_control_panel-521"><span class="linenos">521</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Colormap:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-522"><a href="#NiftiViewer.create_control_panel-522"><span class="linenos">522</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-523"><a href="#NiftiViewer.create_control_panel-523"><span class="linenos">523</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px; font-weight: bold;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-524"><a href="#NiftiViewer.create_control_panel-524"><span class="linenos">524</span></a>        <span class="n">colormap_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colormap_label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-525"><a href="#NiftiViewer.create_control_panel-525"><span class="linenos">525</span></a>
</span><span id="NiftiViewer.create_control_panel-526"><a href="#NiftiViewer.create_control_panel-526"><span class="linenos">526</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-527"><a href="#NiftiViewer.create_control_panel-527"><span class="linenos">527</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span>
</span><span id="NiftiViewer.create_control_panel-528"><a href="#NiftiViewer.create_control_panel-528"><span class="linenos">528</span></a>            <span class="p">[</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="s1">&#39;plasma&#39;</span><span class="p">,</span>
</span><span id="NiftiViewer.create_control_panel-529"><a href="#NiftiViewer.create_control_panel-529"><span class="linenos">529</span></a>             <span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="s1">&#39;hot&#39;</span><span class="p">,</span>
</span><span id="NiftiViewer.create_control_panel-530"><a href="#NiftiViewer.create_control_panel-530"><span class="linenos">530</span></a>             <span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="s1">&#39;bone&#39;</span><span class="p">])</span>
</span><span id="NiftiViewer.create_control_panel-531"><a href="#NiftiViewer.create_control_panel-531"><span class="linenos">531</span></a>
</span><span id="NiftiViewer.create_control_panel-532"><a href="#NiftiViewer.create_control_panel-532"><span class="linenos">532</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-533"><a href="#NiftiViewer.create_control_panel-533"><span class="linenos">533</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-534"><a href="#NiftiViewer.create_control_panel-534"><span class="linenos">534</span></a>        <span class="n">colormap_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-535"><a href="#NiftiViewer.create_control_panel-535"><span class="linenos">535</span></a>        <span class="n">colormap_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-536"><a href="#NiftiViewer.create_control_panel-536"><span class="linenos">536</span></a>        <span class="n">display_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">colormap_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-537"><a href="#NiftiViewer.create_control_panel-537"><span class="linenos">537</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">display_group</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-538"><a href="#NiftiViewer.create_control_panel-538"><span class="linenos">538</span></a>
</span><span id="NiftiViewer.create_control_panel-539"><a href="#NiftiViewer.create_control_panel-539"><span class="linenos">539</span></a>        <span class="c1"># ==========================</span>
</span><span id="NiftiViewer.create_control_panel-540"><a href="#NiftiViewer.create_control_panel-540"><span class="linenos">540</span></a>        <span class="c1"># Automatic ROI Controls</span>
</span><span id="NiftiViewer.create_control_panel-541"><a href="#NiftiViewer.create_control_panel-541"><span class="linenos">541</span></a>        <span class="c1"># ==========================</span>
</span><span id="NiftiViewer.create_control_panel-542"><a href="#NiftiViewer.create_control_panel-542"><span class="linenos">542</span></a>        <span class="c1"># Automatic ROI</span>
</span><span id="NiftiViewer.create_control_panel-543"><a href="#NiftiViewer.create_control_panel-543"><span class="linenos">543</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-544"><a href="#NiftiViewer.create_control_panel-544"><span class="linenos">544</span></a>        <span class="n">automaticROI_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_group</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-545"><a href="#NiftiViewer.create_control_panel-545"><span class="linenos">545</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-546"><a href="#NiftiViewer.create_control_panel-546"><span class="linenos">546</span></a>
</span><span id="NiftiViewer.create_control_panel-547"><a href="#NiftiViewer.create_control_panel-547"><span class="linenos">547</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automatic_ROI_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic ROI:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-548"><a href="#NiftiViewer.create_control_panel-548"><span class="linenos">548</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automatic_ROI_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-549"><a href="#NiftiViewer.create_control_panel-549"><span class="linenos">549</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automatic_ROI_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px; font-weight: bold;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-550"><a href="#NiftiViewer.create_control_panel-550"><span class="linenos">550</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automatic_ROI_label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-551"><a href="#NiftiViewer.create_control_panel-551"><span class="linenos">551</span></a>
</span><span id="NiftiViewer.create_control_panel-552"><a href="#NiftiViewer.create_control_panel-552"><span class="linenos">552</span></a>        <span class="n">automaticROIbtns_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-553"><a href="#NiftiViewer.create_control_panel-553"><span class="linenos">553</span></a>        <span class="n">automaticROIbtns_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">automaticROIbtns_group</span><span class="p">)</span>  <span class="c1"># Cambiato a verticale</span>
</span><span id="NiftiViewer.create_control_panel-554"><a href="#NiftiViewer.create_control_panel-554"><span class="linenos">554</span></a>        <span class="n">automaticROIbtns_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-555"><a href="#NiftiViewer.create_control_panel-555"><span class="linenos">555</span></a>        <span class="n">automaticROIbtns_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-556"><a href="#NiftiViewer.create_control_panel-556"><span class="linenos">556</span></a>
</span><span id="NiftiViewer.create_control_panel-557"><a href="#NiftiViewer.create_control_panel-557"><span class="linenos">557</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic ROI&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-558"><a href="#NiftiViewer.create_control_panel-558"><span class="linenos">558</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-559"><a href="#NiftiViewer.create_control_panel-559"><span class="linenos">559</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-560"><a href="#NiftiViewer.create_control_panel-560"><span class="linenos">560</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-561"><a href="#NiftiViewer.create_control_panel-561"><span class="linenos">561</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic ROI Drawing&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-562"><a href="#NiftiViewer.create_control_panel-562"><span class="linenos">562</span></a>        <span class="n">automaticROIbtns_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-563"><a href="#NiftiViewer.create_control_panel-563"><span class="linenos">563</span></a>
</span><span id="NiftiViewer.create_control_panel-564"><a href="#NiftiViewer.create_control_panel-564"><span class="linenos">564</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Fix ROI and add new Origin&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-565"><a href="#NiftiViewer.create_control_panel-565"><span class="linenos">565</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-566"><a href="#NiftiViewer.create_control_panel-566"><span class="linenos">566</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-567"><a href="#NiftiViewer.create_control_panel-567"><span class="linenos">567</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-568"><a href="#NiftiViewer.create_control_panel-568"><span class="linenos">568</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Increment the current incremental ROI with the current ROI drawing&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-569"><a href="#NiftiViewer.create_control_panel-569"><span class="linenos">569</span></a>        <span class="n">automaticROIbtns_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-570"><a href="#NiftiViewer.create_control_panel-570"><span class="linenos">570</span></a>
</span><span id="NiftiViewer.create_control_panel-571"><a href="#NiftiViewer.create_control_panel-571"><span class="linenos">571</span></a>        <span class="n">automaticROIbtns_group</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-572"><a href="#NiftiViewer.create_control_panel-572"><span class="linenos">572</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">automaticROIbtns_group</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-573"><a href="#NiftiViewer.create_control_panel-573"><span class="linenos">573</span></a>
</span><span id="NiftiViewer.create_control_panel-574"><a href="#NiftiViewer.create_control_panel-574"><span class="linenos">574</span></a>        <span class="c1"># Incremental ROI checkbox</span>
</span><span id="NiftiViewer.create_control_panel-575"><a href="#NiftiViewer.create_control_panel-575"><span class="linenos">575</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span>
</span><span id="NiftiViewer.create_control_panel-576"><a href="#NiftiViewer.create_control_panel-576"><span class="linenos">576</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Show incremental ROI&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-577"><a href="#NiftiViewer.create_control_panel-577"><span class="linenos">577</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-578"><a href="#NiftiViewer.create_control_panel-578"><span class="linenos">578</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-579"><a href="#NiftiViewer.create_control_panel-579"><span class="linenos">579</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-580"><a href="#NiftiViewer.create_control_panel-580"><span class="linenos">580</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-581"><a href="#NiftiViewer.create_control_panel-581"><span class="linenos">581</span></a>
</span><span id="NiftiViewer.create_control_panel-582"><a href="#NiftiViewer.create_control_panel-582"><span class="linenos">582</span></a>        <span class="c1"># Overlay enable/disable checkbox</span>
</span><span id="NiftiViewer.create_control_panel-583"><a href="#NiftiViewer.create_control_panel-583"><span class="linenos">583</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Show automatic ROI&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-584"><a href="#NiftiViewer.create_control_panel-584"><span class="linenos">584</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-585"><a href="#NiftiViewer.create_control_panel-585"><span class="linenos">585</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-586"><a href="#NiftiViewer.create_control_panel-586"><span class="linenos">586</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-587"><a href="#NiftiViewer.create_control_panel-587"><span class="linenos">587</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-588"><a href="#NiftiViewer.create_control_panel-588"><span class="linenos">588</span></a>
</span><span id="NiftiViewer.create_control_panel-589"><a href="#NiftiViewer.create_control_panel-589"><span class="linenos">589</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-590"><a href="#NiftiViewer.create_control_panel-590"><span class="linenos">590</span></a>        <span class="n">automaticROI_sliders_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-591"><a href="#NiftiViewer.create_control_panel-591"><span class="linenos">591</span></a>        <span class="n">automaticROI_sliders_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-592"><a href="#NiftiViewer.create_control_panel-592"><span class="linenos">592</span></a>
</span><span id="NiftiViewer.create_control_panel-593"><a href="#NiftiViewer.create_control_panel-593"><span class="linenos">593</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Radius:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-594"><a href="#NiftiViewer.create_control_panel-594"><span class="linenos">594</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-595"><a href="#NiftiViewer.create_control_panel-595"><span class="linenos">595</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-596"><a href="#NiftiViewer.create_control_panel-596"><span class="linenos">596</span></a>        <span class="n">automaticROI_sliders_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-597"><a href="#NiftiViewer.create_control_panel-597"><span class="linenos">597</span></a>
</span><span id="NiftiViewer.create_control_panel-598"><a href="#NiftiViewer.create_control_panel-598"><span class="linenos">598</span></a>        <span class="c1"># Radius slider and spinbox container</span>
</span><span id="NiftiViewer.create_control_panel-599"><a href="#NiftiViewer.create_control_panel-599"><span class="linenos">599</span></a>        <span class="n">radius_controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-600"><a href="#NiftiViewer.create_control_panel-600"><span class="linenos">600</span></a>        <span class="n">radius_controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">radius_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-601"><a href="#NiftiViewer.create_control_panel-601"><span class="linenos">601</span></a>        <span class="n">radius_controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-602"><a href="#NiftiViewer.create_control_panel-602"><span class="linenos">602</span></a>        <span class="n">radius_controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-603"><a href="#NiftiViewer.create_control_panel-603"><span class="linenos">603</span></a>
</span><span id="NiftiViewer.create_control_panel-604"><a href="#NiftiViewer.create_control_panel-604"><span class="linenos">604</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-605"><a href="#NiftiViewer.create_control_panel-605"><span class="linenos">605</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-606"><a href="#NiftiViewer.create_control_panel-606"><span class="linenos">606</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span>  <span class="c1"># Valore sufficientemente alto per gestire tutti i casi</span>
</span><span id="NiftiViewer.create_control_panel-607"><a href="#NiftiViewer.create_control_panel-607"><span class="linenos">607</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-608"><a href="#NiftiViewer.create_control_panel-608"><span class="linenos">608</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-609"><a href="#NiftiViewer.create_control_panel-609"><span class="linenos">609</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-610"><a href="#NiftiViewer.create_control_panel-610"><span class="linenos">610</span></a>        <span class="n">radius_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-611"><a href="#NiftiViewer.create_control_panel-611"><span class="linenos">611</span></a>
</span><span id="NiftiViewer.create_control_panel-612"><a href="#NiftiViewer.create_control_panel-612"><span class="linenos">612</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-613"><a href="#NiftiViewer.create_control_panel-613"><span class="linenos">613</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-614"><a href="#NiftiViewer.create_control_panel-614"><span class="linenos">614</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span>  <span class="c1"># Valore sufficientemente alto per gestire tutti i casi</span>
</span><span id="NiftiViewer.create_control_panel-615"><a href="#NiftiViewer.create_control_panel-615"><span class="linenos">615</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-616"><a href="#NiftiViewer.create_control_panel-616"><span class="linenos">616</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-617"><a href="#NiftiViewer.create_control_panel-617"><span class="linenos">617</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-618"><a href="#NiftiViewer.create_control_panel-618"><span class="linenos">618</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-619"><a href="#NiftiViewer.create_control_panel-619"><span class="linenos">619</span></a>        <span class="n">radius_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-620"><a href="#NiftiViewer.create_control_panel-620"><span class="linenos">620</span></a>
</span><span id="NiftiViewer.create_control_panel-621"><a href="#NiftiViewer.create_control_panel-621"><span class="linenos">621</span></a>        <span class="n">radius_controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-622"><a href="#NiftiViewer.create_control_panel-622"><span class="linenos">622</span></a>        <span class="n">automaticROI_sliders_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">radius_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-623"><a href="#NiftiViewer.create_control_panel-623"><span class="linenos">623</span></a>
</span><span id="NiftiViewer.create_control_panel-624"><a href="#NiftiViewer.create_control_panel-624"><span class="linenos">624</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Difference:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-625"><a href="#NiftiViewer.create_control_panel-625"><span class="linenos">625</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-626"><a href="#NiftiViewer.create_control_panel-626"><span class="linenos">626</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-627"><a href="#NiftiViewer.create_control_panel-627"><span class="linenos">627</span></a>        <span class="n">automaticROI_sliders_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-628"><a href="#NiftiViewer.create_control_panel-628"><span class="linenos">628</span></a>
</span><span id="NiftiViewer.create_control_panel-629"><a href="#NiftiViewer.create_control_panel-629"><span class="linenos">629</span></a>        <span class="c1"># Difference slider and spinbox container</span>
</span><span id="NiftiViewer.create_control_panel-630"><a href="#NiftiViewer.create_control_panel-630"><span class="linenos">630</span></a>        <span class="n">diff_controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-631"><a href="#NiftiViewer.create_control_panel-631"><span class="linenos">631</span></a>        <span class="n">diff_controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">diff_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-632"><a href="#NiftiViewer.create_control_panel-632"><span class="linenos">632</span></a>        <span class="n">diff_controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-633"><a href="#NiftiViewer.create_control_panel-633"><span class="linenos">633</span></a>        <span class="n">diff_controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-634"><a href="#NiftiViewer.create_control_panel-634"><span class="linenos">634</span></a>
</span><span id="NiftiViewer.create_control_panel-635"><a href="#NiftiViewer.create_control_panel-635"><span class="linenos">635</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-636"><a href="#NiftiViewer.create_control_panel-636"><span class="linenos">636</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-637"><a href="#NiftiViewer.create_control_panel-637"><span class="linenos">637</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">99999</span><span class="p">)</span>  <span class="c1"># Valore molto alto per gestire qualsiasi range di intensit</span>
</span><span id="NiftiViewer.create_control_panel-638"><a href="#NiftiViewer.create_control_panel-638"><span class="linenos">638</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-639"><a href="#NiftiViewer.create_control_panel-639"><span class="linenos">639</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-640"><a href="#NiftiViewer.create_control_panel-640"><span class="linenos">640</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-641"><a href="#NiftiViewer.create_control_panel-641"><span class="linenos">641</span></a>        <span class="n">diff_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-642"><a href="#NiftiViewer.create_control_panel-642"><span class="linenos">642</span></a>
</span><span id="NiftiViewer.create_control_panel-643"><a href="#NiftiViewer.create_control_panel-643"><span class="linenos">643</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-644"><a href="#NiftiViewer.create_control_panel-644"><span class="linenos">644</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-645"><a href="#NiftiViewer.create_control_panel-645"><span class="linenos">645</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">99999</span><span class="p">)</span>  <span class="c1"># Valore molto alto per gestire qualsiasi range di intensit</span>
</span><span id="NiftiViewer.create_control_panel-646"><a href="#NiftiViewer.create_control_panel-646"><span class="linenos">646</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-647"><a href="#NiftiViewer.create_control_panel-647"><span class="linenos">647</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-648"><a href="#NiftiViewer.create_control_panel-648"><span class="linenos">648</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-649"><a href="#NiftiViewer.create_control_panel-649"><span class="linenos">649</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-650"><a href="#NiftiViewer.create_control_panel-650"><span class="linenos">650</span></a>        <span class="n">diff_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-651"><a href="#NiftiViewer.create_control_panel-651"><span class="linenos">651</span></a>
</span><span id="NiftiViewer.create_control_panel-652"><a href="#NiftiViewer.create_control_panel-652"><span class="linenos">652</span></a>        <span class="n">diff_controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-653"><a href="#NiftiViewer.create_control_panel-653"><span class="linenos">653</span></a>        <span class="n">automaticROI_sliders_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">diff_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-654"><a href="#NiftiViewer.create_control_panel-654"><span class="linenos">654</span></a>
</span><span id="NiftiViewer.create_control_panel-655"><a href="#NiftiViewer.create_control_panel-655"><span class="linenos">655</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-656"><a href="#NiftiViewer.create_control_panel-656"><span class="linenos">656</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-657"><a href="#NiftiViewer.create_control_panel-657"><span class="linenos">657</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-658"><a href="#NiftiViewer.create_control_panel-658"><span class="linenos">658</span></a>
</span><span id="NiftiViewer.create_control_panel-659"><a href="#NiftiViewer.create_control_panel-659"><span class="linenos">659</span></a>        <span class="n">automaticROI_bottom_btns_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-660"><a href="#NiftiViewer.create_control_panel-660"><span class="linenos">660</span></a>        <span class="n">automaticROIb_bottom_btns_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">automaticROI_bottom_btns_group</span><span class="p">)</span>  <span class="c1"># Cambiato a verticale</span>
</span><span id="NiftiViewer.create_control_panel-661"><a href="#NiftiViewer.create_control_panel-661"><span class="linenos">661</span></a>        <span class="n">automaticROIb_bottom_btns_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-662"><a href="#NiftiViewer.create_control_panel-662"><span class="linenos">662</span></a>        <span class="n">automaticROIb_bottom_btns_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-663"><a href="#NiftiViewer.create_control_panel-663"><span class="linenos">663</span></a>
</span><span id="NiftiViewer.create_control_panel-664"><a href="#NiftiViewer.create_control_panel-664"><span class="linenos">664</span></a>
</span><span id="NiftiViewer.create_control_panel-665"><a href="#NiftiViewer.create_control_panel-665"><span class="linenos">665</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Save ROI&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-666"><a href="#NiftiViewer.create_control_panel-666"><span class="linenos">666</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.create_control_panel-667"><a href="#NiftiViewer.create_control_panel-667"><span class="linenos">667</span></a><span class="s2">                    QPushButton {</span>
</span><span id="NiftiViewer.create_control_panel-668"><a href="#NiftiViewer.create_control_panel-668"><span class="linenos">668</span></a><span class="s2">                    font-weight: bold;</span>
</span><span id="NiftiViewer.create_control_panel-669"><a href="#NiftiViewer.create_control_panel-669"><span class="linenos">669</span></a><span class="s2">                    color:#27ae60 }</span>
</span><span id="NiftiViewer.create_control_panel-670"><a href="#NiftiViewer.create_control_panel-670"><span class="linenos">670</span></a><span class="s2">                    QPushButton:disabled {</span>
</span><span id="NiftiViewer.create_control_panel-671"><a href="#NiftiViewer.create_control_panel-671"><span class="linenos">671</span></a><span class="s2">                    color:none;</span>
</span><span id="NiftiViewer.create_control_panel-672"><a href="#NiftiViewer.create_control_panel-672"><span class="linenos">672</span></a><span class="s2">                    font-weight: normal</span>
</span><span id="NiftiViewer.create_control_panel-673"><a href="#NiftiViewer.create_control_panel-673"><span class="linenos">673</span></a><span class="s2">                    }&quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-674"><a href="#NiftiViewer.create_control_panel-674"><span class="linenos">674</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-675"><a href="#NiftiViewer.create_control_panel-675"><span class="linenos">675</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-676"><a href="#NiftiViewer.create_control_panel-676"><span class="linenos">676</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-677"><a href="#NiftiViewer.create_control_panel-677"><span class="linenos">677</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Save ROI Drawing&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-678"><a href="#NiftiViewer.create_control_panel-678"><span class="linenos">678</span></a>        <span class="n">automaticROIb_bottom_btns_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-679"><a href="#NiftiViewer.create_control_panel-679"><span class="linenos">679</span></a>
</span><span id="NiftiViewer.create_control_panel-680"><a href="#NiftiViewer.create_control_panel-680"><span class="linenos">680</span></a>
</span><span id="NiftiViewer.create_control_panel-681"><a href="#NiftiViewer.create_control_panel-681"><span class="linenos">681</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Cancel ROI&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-682"><a href="#NiftiViewer.create_control_panel-682"><span class="linenos">682</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-683"><a href="#NiftiViewer.create_control_panel-683"><span class="linenos">683</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.create_control_panel-684"><a href="#NiftiViewer.create_control_panel-684"><span class="linenos">684</span></a><span class="s2">                            QPushButton {</span>
</span><span id="NiftiViewer.create_control_panel-685"><a href="#NiftiViewer.create_control_panel-685"><span class="linenos">685</span></a><span class="s2">                            font-weight: bold;</span>
</span><span id="NiftiViewer.create_control_panel-686"><a href="#NiftiViewer.create_control_panel-686"><span class="linenos">686</span></a><span class="s2">                            color:#c0392b }</span>
</span><span id="NiftiViewer.create_control_panel-687"><a href="#NiftiViewer.create_control_panel-687"><span class="linenos">687</span></a><span class="s2">                            QPushButton:disabled {</span>
</span><span id="NiftiViewer.create_control_panel-688"><a href="#NiftiViewer.create_control_panel-688"><span class="linenos">688</span></a><span class="s2">                            color:none;</span>
</span><span id="NiftiViewer.create_control_panel-689"><a href="#NiftiViewer.create_control_panel-689"><span class="linenos">689</span></a><span class="s2">                            font-weight: normal</span>
</span><span id="NiftiViewer.create_control_panel-690"><a href="#NiftiViewer.create_control_panel-690"><span class="linenos">690</span></a><span class="s2">                            }&quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-691"><a href="#NiftiViewer.create_control_panel-691"><span class="linenos">691</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-692"><a href="#NiftiViewer.create_control_panel-692"><span class="linenos">692</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-693"><a href="#NiftiViewer.create_control_panel-693"><span class="linenos">693</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Cancel ROI Drawing&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-694"><a href="#NiftiViewer.create_control_panel-694"><span class="linenos">694</span></a>        <span class="n">automaticROIb_bottom_btns_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-695"><a href="#NiftiViewer.create_control_panel-695"><span class="linenos">695</span></a>
</span><span id="NiftiViewer.create_control_panel-696"><a href="#NiftiViewer.create_control_panel-696"><span class="linenos">696</span></a>        <span class="n">automaticROI_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">automaticROI_bottom_btns_group</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-697"><a href="#NiftiViewer.create_control_panel-697"><span class="linenos">697</span></a>
</span><span id="NiftiViewer.create_control_panel-698"><a href="#NiftiViewer.create_control_panel-698"><span class="linenos">698</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_group</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-699"><a href="#NiftiViewer.create_control_panel-699"><span class="linenos">699</span></a>
</span><span id="NiftiViewer.create_control_panel-700"><a href="#NiftiViewer.create_control_panel-700"><span class="linenos">700</span></a>        <span class="c1"># Overlay controls</span>
</span><span id="NiftiViewer.create_control_panel-701"><a href="#NiftiViewer.create_control_panel-701"><span class="linenos">701</span></a>        <span class="n">overlay_group</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-702"><a href="#NiftiViewer.create_control_panel-702"><span class="linenos">702</span></a>        <span class="n">overlay_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">overlay_group</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-703"><a href="#NiftiViewer.create_control_panel-703"><span class="linenos">703</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-704"><a href="#NiftiViewer.create_control_panel-704"><span class="linenos">704</span></a>
</span><span id="NiftiViewer.create_control_panel-705"><a href="#NiftiViewer.create_control_panel-705"><span class="linenos">705</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay Controls:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-706"><a href="#NiftiViewer.create_control_panel-706"><span class="linenos">706</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-707"><a href="#NiftiViewer.create_control_panel-707"><span class="linenos">707</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-708"><a href="#NiftiViewer.create_control_panel-708"><span class="linenos">708</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; font-size: 11px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-709"><a href="#NiftiViewer.create_control_panel-709"><span class="linenos">709</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_control_label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-710"><a href="#NiftiViewer.create_control_panel-710"><span class="linenos">710</span></a>
</span><span id="NiftiViewer.create_control_panel-711"><a href="#NiftiViewer.create_control_panel-711"><span class="linenos">711</span></a>        <span class="c1"># Overlay file button</span>
</span><span id="NiftiViewer.create_control_panel-712"><a href="#NiftiViewer.create_control_panel-712"><span class="linenos">712</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Load Overlay&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-713"><a href="#NiftiViewer.create_control_panel-713"><span class="linenos">713</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-714"><a href="#NiftiViewer.create_control_panel-714"><span class="linenos">714</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-715"><a href="#NiftiViewer.create_control_panel-715"><span class="linenos">715</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Enable only when base image is loaded</span>
</span><span id="NiftiViewer.create_control_panel-716"><a href="#NiftiViewer.create_control_panel-716"><span class="linenos">716</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-717"><a href="#NiftiViewer.create_control_panel-717"><span class="linenos">717</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Load NIfTI Overlay&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-718"><a href="#NiftiViewer.create_control_panel-718"><span class="linenos">718</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-719"><a href="#NiftiViewer.create_control_panel-719"><span class="linenos">719</span></a>
</span><span id="NiftiViewer.create_control_panel-720"><a href="#NiftiViewer.create_control_panel-720"><span class="linenos">720</span></a>        <span class="c1"># Overlay enable/disable checkbox</span>
</span><span id="NiftiViewer.create_control_panel-721"><a href="#NiftiViewer.create_control_panel-721"><span class="linenos">721</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Show Overlay&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-722"><a href="#NiftiViewer.create_control_panel-722"><span class="linenos">722</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-723"><a href="#NiftiViewer.create_control_panel-723"><span class="linenos">723</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-724"><a href="#NiftiViewer.create_control_panel-724"><span class="linenos">724</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-725"><a href="#NiftiViewer.create_control_panel-725"><span class="linenos">725</span></a>
</span><span id="NiftiViewer.create_control_panel-726"><a href="#NiftiViewer.create_control_panel-726"><span class="linenos">726</span></a>        <span class="c1"># Overlay alpha slider</span>
</span><span id="NiftiViewer.create_control_panel-727"><a href="#NiftiViewer.create_control_panel-727"><span class="linenos">727</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_overlay_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay Transparency:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-728"><a href="#NiftiViewer.create_control_panel-728"><span class="linenos">728</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_overlay_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-729"><a href="#NiftiViewer.create_control_panel-729"><span class="linenos">729</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_overlay_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-730"><a href="#NiftiViewer.create_control_panel-730"><span class="linenos">730</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_overlay_label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-731"><a href="#NiftiViewer.create_control_panel-731"><span class="linenos">731</span></a>
</span><span id="NiftiViewer.create_control_panel-732"><a href="#NiftiViewer.create_control_panel-732"><span class="linenos">732</span></a>        <span class="c1"># Alpha slider and spinbox container</span>
</span><span id="NiftiViewer.create_control_panel-733"><a href="#NiftiViewer.create_control_panel-733"><span class="linenos">733</span></a>        <span class="n">alpha_controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-734"><a href="#NiftiViewer.create_control_panel-734"><span class="linenos">734</span></a>        <span class="n">alpha_controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">alpha_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-735"><a href="#NiftiViewer.create_control_panel-735"><span class="linenos">735</span></a>        <span class="n">alpha_controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-736"><a href="#NiftiViewer.create_control_panel-736"><span class="linenos">736</span></a>        <span class="n">alpha_controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-737"><a href="#NiftiViewer.create_control_panel-737"><span class="linenos">737</span></a>
</span><span id="NiftiViewer.create_control_panel-738"><a href="#NiftiViewer.create_control_panel-738"><span class="linenos">738</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-739"><a href="#NiftiViewer.create_control_panel-739"><span class="linenos">739</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-740"><a href="#NiftiViewer.create_control_panel-740"><span class="linenos">740</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-741"><a href="#NiftiViewer.create_control_panel-741"><span class="linenos">741</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">70</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-742"><a href="#NiftiViewer.create_control_panel-742"><span class="linenos">742</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-743"><a href="#NiftiViewer.create_control_panel-743"><span class="linenos">743</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-744"><a href="#NiftiViewer.create_control_panel-744"><span class="linenos">744</span></a>        <span class="n">alpha_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-745"><a href="#NiftiViewer.create_control_panel-745"><span class="linenos">745</span></a>
</span><span id="NiftiViewer.create_control_panel-746"><a href="#NiftiViewer.create_control_panel-746"><span class="linenos">746</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-747"><a href="#NiftiViewer.create_control_panel-747"><span class="linenos">747</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-748"><a href="#NiftiViewer.create_control_panel-748"><span class="linenos">748</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-749"><a href="#NiftiViewer.create_control_panel-749"><span class="linenos">749</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">70</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-750"><a href="#NiftiViewer.create_control_panel-750"><span class="linenos">750</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-751"><a href="#NiftiViewer.create_control_panel-751"><span class="linenos">751</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-752"><a href="#NiftiViewer.create_control_panel-752"><span class="linenos">752</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-753"><a href="#NiftiViewer.create_control_panel-753"><span class="linenos">753</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-754"><a href="#NiftiViewer.create_control_panel-754"><span class="linenos">754</span></a>        <span class="n">alpha_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-755"><a href="#NiftiViewer.create_control_panel-755"><span class="linenos">755</span></a>
</span><span id="NiftiViewer.create_control_panel-756"><a href="#NiftiViewer.create_control_panel-756"><span class="linenos">756</span></a>        <span class="n">alpha_controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-757"><a href="#NiftiViewer.create_control_panel-757"><span class="linenos">757</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">alpha_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-758"><a href="#NiftiViewer.create_control_panel-758"><span class="linenos">758</span></a>
</span><span id="NiftiViewer.create_control_panel-759"><a href="#NiftiViewer.create_control_panel-759"><span class="linenos">759</span></a>        <span class="c1"># Overlay threshold slider</span>
</span><span id="NiftiViewer.create_control_panel-760"><a href="#NiftiViewer.create_control_panel-760"><span class="linenos">760</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay Threshold:&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-761"><a href="#NiftiViewer.create_control_panel-761"><span class="linenos">761</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-762"><a href="#NiftiViewer.create_control_panel-762"><span class="linenos">762</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-763"><a href="#NiftiViewer.create_control_panel-763"><span class="linenos">763</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-764"><a href="#NiftiViewer.create_control_panel-764"><span class="linenos">764</span></a>
</span><span id="NiftiViewer.create_control_panel-765"><a href="#NiftiViewer.create_control_panel-765"><span class="linenos">765</span></a>        <span class="c1"># Threshold slider and spinbox container</span>
</span><span id="NiftiViewer.create_control_panel-766"><a href="#NiftiViewer.create_control_panel-766"><span class="linenos">766</span></a>        <span class="n">threshold_controls_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-767"><a href="#NiftiViewer.create_control_panel-767"><span class="linenos">767</span></a>        <span class="n">threshold_controls_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">threshold_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-768"><a href="#NiftiViewer.create_control_panel-768"><span class="linenos">768</span></a>        <span class="n">threshold_controls_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-769"><a href="#NiftiViewer.create_control_panel-769"><span class="linenos">769</span></a>        <span class="n">threshold_controls_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-770"><a href="#NiftiViewer.create_control_panel-770"><span class="linenos">770</span></a>
</span><span id="NiftiViewer.create_control_panel-771"><a href="#NiftiViewer.create_control_panel-771"><span class="linenos">771</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-772"><a href="#NiftiViewer.create_control_panel-772"><span class="linenos">772</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-773"><a href="#NiftiViewer.create_control_panel-773"><span class="linenos">773</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-774"><a href="#NiftiViewer.create_control_panel-774"><span class="linenos">774</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-775"><a href="#NiftiViewer.create_control_panel-775"><span class="linenos">775</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-776"><a href="#NiftiViewer.create_control_panel-776"><span class="linenos">776</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-777"><a href="#NiftiViewer.create_control_panel-777"><span class="linenos">777</span></a>        <span class="n">threshold_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-778"><a href="#NiftiViewer.create_control_panel-778"><span class="linenos">778</span></a>
</span><span id="NiftiViewer.create_control_panel-779"><a href="#NiftiViewer.create_control_panel-779"><span class="linenos">779</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-780"><a href="#NiftiViewer.create_control_panel-780"><span class="linenos">780</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-781"><a href="#NiftiViewer.create_control_panel-781"><span class="linenos">781</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-782"><a href="#NiftiViewer.create_control_panel-782"><span class="linenos">782</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-783"><a href="#NiftiViewer.create_control_panel-783"><span class="linenos">783</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-784"><a href="#NiftiViewer.create_control_panel-784"><span class="linenos">784</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-785"><a href="#NiftiViewer.create_control_panel-785"><span class="linenos">785</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-786"><a href="#NiftiViewer.create_control_panel-786"><span class="linenos">786</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-787"><a href="#NiftiViewer.create_control_panel-787"><span class="linenos">787</span></a>        <span class="n">threshold_controls_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-788"><a href="#NiftiViewer.create_control_panel-788"><span class="linenos">788</span></a>
</span><span id="NiftiViewer.create_control_panel-789"><a href="#NiftiViewer.create_control_panel-789"><span class="linenos">789</span></a>        <span class="n">threshold_controls_widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-790"><a href="#NiftiViewer.create_control_panel-790"><span class="linenos">790</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">threshold_controls_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-791"><a href="#NiftiViewer.create_control_panel-791"><span class="linenos">791</span></a>
</span><span id="NiftiViewer.create_control_panel-792"><a href="#NiftiViewer.create_control_panel-792"><span class="linenos">792</span></a>        <span class="c1"># Overlay info</span>
</span><span id="NiftiViewer.create_control_panel-793"><a href="#NiftiViewer.create_control_panel-793"><span class="linenos">793</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No overlay loaded&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_control_panel-794"><a href="#NiftiViewer.create_control_panel-794"><span class="linenos">794</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setWordWrap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-795"><a href="#NiftiViewer.create_control_panel-795"><span class="linenos">795</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-size: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-796"><a href="#NiftiViewer.create_control_panel-796"><span class="linenos">796</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Ignored</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-797"><a href="#NiftiViewer.create_control_panel-797"><span class="linenos">797</span></a>        <span class="c1"># Imposta larghezza massima per prevenire espansione</span>
</span><span id="NiftiViewer.create_control_panel-798"><a href="#NiftiViewer.create_control_panel-798"><span class="linenos">798</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">320</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-799"><a href="#NiftiViewer.create_control_panel-799"><span class="linenos">799</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-800"><a href="#NiftiViewer.create_control_panel-800"><span class="linenos">800</span></a>        <span class="n">overlay_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-801"><a href="#NiftiViewer.create_control_panel-801"><span class="linenos">801</span></a>
</span><span id="NiftiViewer.create_control_panel-802"><a href="#NiftiViewer.create_control_panel-802"><span class="linenos">802</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">overlay_group</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-803"><a href="#NiftiViewer.create_control_panel-803"><span class="linenos">803</span></a>
</span><span id="NiftiViewer.create_control_panel-804"><a href="#NiftiViewer.create_control_panel-804"><span class="linenos">804</span></a>        <span class="c1"># Add stretch to push everything to top</span>
</span><span id="NiftiViewer.create_control_panel-805"><a href="#NiftiViewer.create_control_panel-805"><span class="linenos">805</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addStretch</span><span class="p">()</span>
</span><span id="NiftiViewer.create_control_panel-806"><a href="#NiftiViewer.create_control_panel-806"><span class="linenos">806</span></a>
</span><span id="NiftiViewer.create_control_panel-807"><a href="#NiftiViewer.create_control_panel-807"><span class="linenos">807</span></a>        <span class="c1"># Set the content inside the QScrollArea</span>
</span><span id="NiftiViewer.create_control_panel-808"><a href="#NiftiViewer.create_control_panel-808"><span class="linenos">808</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="n">control_content</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-809"><a href="#NiftiViewer.create_control_panel-809"><span class="linenos">809</span></a>
</span><span id="NiftiViewer.create_control_panel-810"><a href="#NiftiViewer.create_control_panel-810"><span class="linenos">810</span></a>        <span class="c1"># Set dimensions to eliminate horizontal scrolling</span>
</span><span id="NiftiViewer.create_control_panel-811"><a href="#NiftiViewer.create_control_panel-811"><span class="linenos">811</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">240</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-812"><a href="#NiftiViewer.create_control_panel-812"><span class="linenos">812</span></a>        <span class="n">scroll_area</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">340</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-813"><a href="#NiftiViewer.create_control_panel-813"><span class="linenos">813</span></a>
</span><span id="NiftiViewer.create_control_panel-814"><a href="#NiftiViewer.create_control_panel-814"><span class="linenos">814</span></a>        <span class="c1"># Signal/slot connections to synchronize slider and spinbox</span>
</span><span id="NiftiViewer.create_control_panel-815"><a href="#NiftiViewer.create_control_panel-815"><span class="linenos">815</span></a>
</span><span id="NiftiViewer.create_control_panel-816"><a href="#NiftiViewer.create_control_panel-816"><span class="linenos">816</span></a>        <span class="c1"># Automatic ROI - Radius</span>
</span><span id="NiftiViewer.create_control_panel-817"><a href="#NiftiViewer.create_control_panel-817"><span class="linenos">817</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-818"><a href="#NiftiViewer.create_control_panel-818"><span class="linenos">818</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-819"><a href="#NiftiViewer.create_control_panel-819"><span class="linenos">819</span></a>
</span><span id="NiftiViewer.create_control_panel-820"><a href="#NiftiViewer.create_control_panel-820"><span class="linenos">820</span></a>        <span class="c1"># Automatic ROI - Difference</span>
</span><span id="NiftiViewer.create_control_panel-821"><a href="#NiftiViewer.create_control_panel-821"><span class="linenos">821</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-822"><a href="#NiftiViewer.create_control_panel-822"><span class="linenos">822</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-823"><a href="#NiftiViewer.create_control_panel-823"><span class="linenos">823</span></a>
</span><span id="NiftiViewer.create_control_panel-824"><a href="#NiftiViewer.create_control_panel-824"><span class="linenos">824</span></a>        <span class="c1"># Overlay - Alpha/Transparency</span>
</span><span id="NiftiViewer.create_control_panel-825"><a href="#NiftiViewer.create_control_panel-825"><span class="linenos">825</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-826"><a href="#NiftiViewer.create_control_panel-826"><span class="linenos">826</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-827"><a href="#NiftiViewer.create_control_panel-827"><span class="linenos">827</span></a>
</span><span id="NiftiViewer.create_control_panel-828"><a href="#NiftiViewer.create_control_panel-828"><span class="linenos">828</span></a>        <span class="c1"># Overlay - Threshold</span>
</span><span id="NiftiViewer.create_control_panel-829"><a href="#NiftiViewer.create_control_panel-829"><span class="linenos">829</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-830"><a href="#NiftiViewer.create_control_panel-830"><span class="linenos">830</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer.create_control_panel-831"><a href="#NiftiViewer.create_control_panel-831"><span class="linenos">831</span></a>
</span><span id="NiftiViewer.create_control_panel-832"><a href="#NiftiViewer.create_control_panel-832"><span class="linenos">832</span></a>        <span class="c1"># Add scroll area to parent</span>
</span><span id="NiftiViewer.create_control_panel-833"><a href="#NiftiViewer.create_control_panel-833"><span class="linenos">833</span></a>        <span class="n">parent</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">scroll_area</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create the left-side control panel for the NIfTI Viewer interface.</p>

<p>This method builds an interactive, scrollable control panel that allows
the user to:</p>

<ul>
<li>Open and display NIfTI files.</li>
<li>Navigate through 2D slices in axial, coronal, and sagittal planes.</li>
<li>Control time navigation for 4D datasets.</li>
<li>Adjust visualization parameters such as colormap and display options.</li>
<li>Perform automatic ROI (Region of Interest) generation.</li>
<li>Manage overlay images (load, transparency, threshold, enable/disable).</li>
</ul>

<p>Args:
    parent (QSplitter): The parent splitter widget where the control panel is added.</p>

<p>Raises:
    Exception: Propagates exceptions from any UI creation or layout step.</p>
</div>


                            </div>
                            <div id="NiftiViewer.format_info_text" class="classattr">
                                        <input id="NiftiViewer.format_info_text-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">format_info_text</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">text</span>, </span><span class="param"><span class="n">max_line_length</span><span class="o">=</span><span class="mi">35</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.format_info_text-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.format_info_text"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.format_info_text-835"><a href="#NiftiViewer.format_info_text-835"><span class="linenos">835</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">format_info_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">max_line_length</span><span class="o">=</span><span class="mi">35</span><span class="p">):</span>
</span><span id="NiftiViewer.format_info_text-836"><a href="#NiftiViewer.format_info_text-836"><span class="linenos">836</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.format_info_text-837"><a href="#NiftiViewer.format_info_text-837"><span class="linenos">837</span></a><span class="sd">        Format text to prevent horizontal scrolling in the control panel.</span>
</span><span id="NiftiViewer.format_info_text-838"><a href="#NiftiViewer.format_info_text-838"><span class="linenos">838</span></a>
</span><span id="NiftiViewer.format_info_text-839"><a href="#NiftiViewer.format_info_text-839"><span class="linenos">839</span></a><span class="sd">        This helper function ensures that long lines of information (such as</span>
</span><span id="NiftiViewer.format_info_text-840"><a href="#NiftiViewer.format_info_text-840"><span class="linenos">840</span></a><span class="sd">        NIfTI file metadata) are wrapped neatly to fit within the UI, avoiding</span>
</span><span id="NiftiViewer.format_info_text-841"><a href="#NiftiViewer.format_info_text-841"><span class="linenos">841</span></a><span class="sd">        horizontal overflow. It also attempts to break lines at logical points</span>
</span><span id="NiftiViewer.format_info_text-842"><a href="#NiftiViewer.format_info_text-842"><span class="linenos">842</span></a><span class="sd">        (e.g., after colons or spaces) for improved readability.</span>
</span><span id="NiftiViewer.format_info_text-843"><a href="#NiftiViewer.format_info_text-843"><span class="linenos">843</span></a>
</span><span id="NiftiViewer.format_info_text-844"><a href="#NiftiViewer.format_info_text-844"><span class="linenos">844</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.format_info_text-845"><a href="#NiftiViewer.format_info_text-845"><span class="linenos">845</span></a><span class="sd">            text (str): The text to be formatted.</span>
</span><span id="NiftiViewer.format_info_text-846"><a href="#NiftiViewer.format_info_text-846"><span class="linenos">846</span></a><span class="sd">            max_line_length (int, optional): Maximum number of characters per line</span>
</span><span id="NiftiViewer.format_info_text-847"><a href="#NiftiViewer.format_info_text-847"><span class="linenos">847</span></a><span class="sd">                before wrapping. Defaults to 35.</span>
</span><span id="NiftiViewer.format_info_text-848"><a href="#NiftiViewer.format_info_text-848"><span class="linenos">848</span></a>
</span><span id="NiftiViewer.format_info_text-849"><a href="#NiftiViewer.format_info_text-849"><span class="linenos">849</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer.format_info_text-850"><a href="#NiftiViewer.format_info_text-850"><span class="linenos">850</span></a><span class="sd">            str: The formatted text with inserted line breaks for better layout.</span>
</span><span id="NiftiViewer.format_info_text-851"><a href="#NiftiViewer.format_info_text-851"><span class="linenos">851</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.format_info_text-852"><a href="#NiftiViewer.format_info_text-852"><span class="linenos">852</span></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">textwrap</span>
</span><span id="NiftiViewer.format_info_text-853"><a href="#NiftiViewer.format_info_text-853"><span class="linenos">853</span></a>
</span><span id="NiftiViewer.format_info_text-854"><a href="#NiftiViewer.format_info_text-854"><span class="linenos">854</span></a>        <span class="c1"># Split text into lines to process them individually</span>
</span><span id="NiftiViewer.format_info_text-855"><a href="#NiftiViewer.format_info_text-855"><span class="linenos">855</span></a>        <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer.format_info_text-856"><a href="#NiftiViewer.format_info_text-856"><span class="linenos">856</span></a>        <span class="n">formatted_lines</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer.format_info_text-857"><a href="#NiftiViewer.format_info_text-857"><span class="linenos">857</span></a>
</span><span id="NiftiViewer.format_info_text-858"><a href="#NiftiViewer.format_info_text-858"><span class="linenos">858</span></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span id="NiftiViewer.format_info_text-859"><a href="#NiftiViewer.format_info_text-859"><span class="linenos">859</span></a>            <span class="c1"># If the line fits within limit, keep it unchanged</span>
</span><span id="NiftiViewer.format_info_text-860"><a href="#NiftiViewer.format_info_text-860"><span class="linenos">860</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_line_length</span><span class="p">:</span>
</span><span id="NiftiViewer.format_info_text-861"><a href="#NiftiViewer.format_info_text-861"><span class="linenos">861</span></a>                <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="NiftiViewer.format_info_text-862"><a href="#NiftiViewer.format_info_text-862"><span class="linenos">862</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.format_info_text-863"><a href="#NiftiViewer.format_info_text-863"><span class="linenos">863</span></a>                <span class="c1"># Try to split logically around &#39;:&#39; if possible</span>
</span><span id="NiftiViewer.format_info_text-864"><a href="#NiftiViewer.format_info_text-864"><span class="linenos">864</span></a>                <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
</span><span id="NiftiViewer.format_info_text-865"><a href="#NiftiViewer.format_info_text-865"><span class="linenos">865</span></a>                    <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer.format_info_text-866"><a href="#NiftiViewer.format_info_text-866"><span class="linenos">866</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">max_line_length</span><span class="p">:</span>
</span><span id="NiftiViewer.format_info_text-867"><a href="#NiftiViewer.format_info_text-867"><span class="linenos">867</span></a>                        <span class="c1"># Add the first part and indent the continuation</span>
</span><span id="NiftiViewer.format_info_text-868"><a href="#NiftiViewer.format_info_text-868"><span class="linenos">868</span></a>                        <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer.format_info_text-869"><a href="#NiftiViewer.format_info_text-869"><span class="linenos">869</span></a>                        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">width</span><span class="o">=</span><span class="n">max_line_length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="NiftiViewer.format_info_text-870"><a href="#NiftiViewer.format_info_text-870"><span class="linenos">870</span></a>                        <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">wrapped</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="p">))</span>
</span><span id="NiftiViewer.format_info_text-871"><a href="#NiftiViewer.format_info_text-871"><span class="linenos">871</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.format_info_text-872"><a href="#NiftiViewer.format_info_text-872"><span class="linenos">872</span></a>                        <span class="c1"># If even the key part is long, wrap entire line</span>
</span><span id="NiftiViewer.format_info_text-873"><a href="#NiftiViewer.format_info_text-873"><span class="linenos">873</span></a>                        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">max_line_length</span><span class="p">)</span>
</span><span id="NiftiViewer.format_info_text-874"><a href="#NiftiViewer.format_info_text-874"><span class="linenos">874</span></a>                        <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wrapped</span><span class="p">)</span>
</span><span id="NiftiViewer.format_info_text-875"><a href="#NiftiViewer.format_info_text-875"><span class="linenos">875</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.format_info_text-876"><a href="#NiftiViewer.format_info_text-876"><span class="linenos">876</span></a>                    <span class="c1"># Wrap normally if no logical split point found</span>
</span><span id="NiftiViewer.format_info_text-877"><a href="#NiftiViewer.format_info_text-877"><span class="linenos">877</span></a>                    <span class="n">wrapped</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">max_line_length</span><span class="p">)</span>
</span><span id="NiftiViewer.format_info_text-878"><a href="#NiftiViewer.format_info_text-878"><span class="linenos">878</span></a>                    <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wrapped</span><span class="p">)</span>
</span><span id="NiftiViewer.format_info_text-879"><a href="#NiftiViewer.format_info_text-879"><span class="linenos">879</span></a>
</span><span id="NiftiViewer.format_info_text-880"><a href="#NiftiViewer.format_info_text-880"><span class="linenos">880</span></a>        <span class="c1"># Join all formatted lines back into a single string</span>
</span><span id="NiftiViewer.format_info_text-881"><a href="#NiftiViewer.format_info_text-881"><span class="linenos">881</span></a>        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_lines</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Format text to prevent horizontal scrolling in the control panel.</p>

<p>This helper function ensures that long lines of information (such as
NIfTI file metadata) are wrapped neatly to fit within the UI, avoiding
horizontal overflow. It also attempts to break lines at logical points
(e.g., after colons or spaces) for improved readability.</p>

<p>Args:
    text (str): The text to be formatted.
    max_line_length (int, optional): Maximum number of characters per line
        before wrapping. Defaults to 35.</p>

<p>Returns:
    str: The formatted text with inserted line breaks for better layout.</p>
</div>


                            </div>
                            <div id="NiftiViewer.create_image_display" class="classattr">
                                        <input id="NiftiViewer.create_image_display-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_image_display</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">parent</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.create_image_display-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.create_image_display"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.create_image_display-883"><a href="#NiftiViewer.create_image_display-883"><span class="linenos">883</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_image_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
</span><span id="NiftiViewer.create_image_display-884"><a href="#NiftiViewer.create_image_display-884"><span class="linenos">884</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.create_image_display-885"><a href="#NiftiViewer.create_image_display-885"><span class="linenos">885</span></a><span class="sd">        Create the main image display panel with three anatomical views.</span>
</span><span id="NiftiViewer.create_image_display-886"><a href="#NiftiViewer.create_image_display-886"><span class="linenos">886</span></a>
</span><span id="NiftiViewer.create_image_display-887"><a href="#NiftiViewer.create_image_display-887"><span class="linenos">887</span></a><span class="sd">        This function builds the right-hand visualization area of the NIfTI viewer,</span>
</span><span id="NiftiViewer.create_image_display-888"><a href="#NiftiViewer.create_image_display-888"><span class="linenos">888</span></a><span class="sd">        which displays axial, coronal, and sagittal image slices. It also prepares</span>
</span><span id="NiftiViewer.create_image_display-889"><a href="#NiftiViewer.create_image_display-889"><span class="linenos">889</span></a><span class="sd">        a fourth panel for displaying image information or time-series plots</span>
</span><span id="NiftiViewer.create_image_display-890"><a href="#NiftiViewer.create_image_display-890"><span class="linenos">890</span></a><span class="sd">        (depending on whether the dataset is 3D or 4D).</span>
</span><span id="NiftiViewer.create_image_display-891"><a href="#NiftiViewer.create_image_display-891"><span class="linenos">891</span></a>
</span><span id="NiftiViewer.create_image_display-892"><a href="#NiftiViewer.create_image_display-892"><span class="linenos">892</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.create_image_display-893"><a href="#NiftiViewer.create_image_display-893"><span class="linenos">893</span></a><span class="sd">            parent (QSplitter): The parent splitter widget where the display</span>
</span><span id="NiftiViewer.create_image_display-894"><a href="#NiftiViewer.create_image_display-894"><span class="linenos">894</span></a><span class="sd">                area is added.</span>
</span><span id="NiftiViewer.create_image_display-895"><a href="#NiftiViewer.create_image_display-895"><span class="linenos">895</span></a>
</span><span id="NiftiViewer.create_image_display-896"><a href="#NiftiViewer.create_image_display-896"><span class="linenos">896</span></a><span class="sd">        Components:</span>
</span><span id="NiftiViewer.create_image_display-897"><a href="#NiftiViewer.create_image_display-897"><span class="linenos">897</span></a><span class="sd">            - Three synchronized image views with crosshairs.</span>
</span><span id="NiftiViewer.create_image_display-898"><a href="#NiftiViewer.create_image_display-898"><span class="linenos">898</span></a><span class="sd">            - A fourth panel for displaying image metadata or 4D time plots.</span>
</span><span id="NiftiViewer.create_image_display-899"><a href="#NiftiViewer.create_image_display-899"><span class="linenos">899</span></a><span class="sd">            - Dynamically initialized graphics scenes and pixmap items.</span>
</span><span id="NiftiViewer.create_image_display-900"><a href="#NiftiViewer.create_image_display-900"><span class="linenos">900</span></a>
</span><span id="NiftiViewer.create_image_display-901"><a href="#NiftiViewer.create_image_display-901"><span class="linenos">901</span></a><span class="sd">        Raises:</span>
</span><span id="NiftiViewer.create_image_display-902"><a href="#NiftiViewer.create_image_display-902"><span class="linenos">902</span></a><span class="sd">            Exception: Propagates initialization errors in UI creation.</span>
</span><span id="NiftiViewer.create_image_display-903"><a href="#NiftiViewer.create_image_display-903"><span class="linenos">903</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.create_image_display-904"><a href="#NiftiViewer.create_image_display-904"><span class="linenos">904</span></a>        <span class="c1"># Create base container and grid layout for the 2x2 view grid</span>
</span><span id="NiftiViewer.create_image_display-905"><a href="#NiftiViewer.create_image_display-905"><span class="linenos">905</span></a>        <span class="n">display_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer.create_image_display-906"><a href="#NiftiViewer.create_image_display-906"><span class="linenos">906</span></a>        <span class="n">display_layout</span> <span class="o">=</span> <span class="n">QGridLayout</span><span class="p">(</span><span class="n">display_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-907"><a href="#NiftiViewer.create_image_display-907"><span class="linenos">907</span></a>        <span class="n">display_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-908"><a href="#NiftiViewer.create_image_display-908"><span class="linenos">908</span></a>
</span><span id="NiftiViewer.create_image_display-909"><a href="#NiftiViewer.create_image_display-909"><span class="linenos">909</span></a>        <span class="c1"># Define positions for the three main anatomical views</span>
</span><span id="NiftiViewer.create_image_display-910"><a href="#NiftiViewer.create_image_display-910"><span class="linenos">910</span></a>        <span class="n">view_positions</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="NiftiViewer.create_image_display-911"><a href="#NiftiViewer.create_image_display-911"><span class="linenos">911</span></a>        <span class="n">view_titles</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="NiftiViewer.create_image_display-912"><a href="#NiftiViewer.create_image_display-912"><span class="linenos">912</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Axial&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer.create_image_display-913"><a href="#NiftiViewer.create_image_display-913"><span class="linenos">913</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coronal&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer.create_image_display-914"><a href="#NiftiViewer.create_image_display-914"><span class="linenos">914</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Sagittal&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-915"><a href="#NiftiViewer.create_image_display-915"><span class="linenos">915</span></a>        <span class="p">]</span>
</span><span id="NiftiViewer.create_image_display-916"><a href="#NiftiViewer.create_image_display-916"><span class="linenos">916</span></a>
</span><span id="NiftiViewer.create_image_display-917"><a href="#NiftiViewer.create_image_display-917"><span class="linenos">917</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">view_titles_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NiftiViewer.create_image_display-918"><a href="#NiftiViewer.create_image_display-918"><span class="linenos">918</span></a>
</span><span id="NiftiViewer.create_image_display-919"><a href="#NiftiViewer.create_image_display-919"><span class="linenos">919</span></a>        <span class="c1"># Iterate through each anatomical plane and create a visualization frame</span>
</span><span id="NiftiViewer.create_image_display-920"><a href="#NiftiViewer.create_image_display-920"><span class="linenos">920</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">view_positions</span><span class="p">):</span>
</span><span id="NiftiViewer.create_image_display-921"><a href="#NiftiViewer.create_image_display-921"><span class="linenos">921</span></a>            <span class="c1"># Create container with border style</span>
</span><span id="NiftiViewer.create_image_display-922"><a href="#NiftiViewer.create_image_display-922"><span class="linenos">922</span></a>            <span class="n">view_container</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer.create_image_display-923"><a href="#NiftiViewer.create_image_display-923"><span class="linenos">923</span></a>            <span class="n">view_container</span><span class="o">.</span><span class="n">setFrameStyle</span><span class="p">(</span><span class="n">QFrame</span><span class="o">.</span><span class="n">Shape</span><span class="o">.</span><span class="n">StyledPanel</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-924"><a href="#NiftiViewer.create_image_display-924"><span class="linenos">924</span></a>            <span class="n">container_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">view_container</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-925"><a href="#NiftiViewer.create_image_display-925"><span class="linenos">925</span></a>            <span class="n">container_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-926"><a href="#NiftiViewer.create_image_display-926"><span class="linenos">926</span></a>
</span><span id="NiftiViewer.create_image_display-927"><a href="#NiftiViewer.create_image_display-927"><span class="linenos">927</span></a>            <span class="c1"># Title label (Axial, Coronal, Sagittal)</span>
</span><span id="NiftiViewer.create_image_display-928"><a href="#NiftiViewer.create_image_display-928"><span class="linenos">928</span></a>            <span class="n">title_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">view_titles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="NiftiViewer.create_image_display-929"><a href="#NiftiViewer.create_image_display-929"><span class="linenos">929</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view_titles_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title_label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-930"><a href="#NiftiViewer.create_image_display-930"><span class="linenos">930</span></a>            <span class="n">title_label</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignmentFlag</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-931"><a href="#NiftiViewer.create_image_display-931"><span class="linenos">931</span></a>            <span class="n">title_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; padding: 4px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-932"><a href="#NiftiViewer.create_image_display-932"><span class="linenos">932</span></a>            <span class="n">container_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">title_label</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-933"><a href="#NiftiViewer.create_image_display-933"><span class="linenos">933</span></a>
</span><span id="NiftiViewer.create_image_display-934"><a href="#NiftiViewer.create_image_display-934"><span class="linenos">934</span></a>            <span class="c1"># Initialize graphics view for image rendering</span>
</span><span id="NiftiViewer.create_image_display-935"><a href="#NiftiViewer.create_image_display-935"><span class="linenos">935</span></a>            <span class="n">view</span> <span class="o">=</span> <span class="n">CrosshairGraphicsView</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-936"><a href="#NiftiViewer.create_image_display-936"><span class="linenos">936</span></a>            <span class="n">view</span><span class="o">.</span><span class="n">setMinimumSize</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-937"><a href="#NiftiViewer.create_image_display-937"><span class="linenos">937</span></a>            <span class="n">view</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-938"><a href="#NiftiViewer.create_image_display-938"><span class="linenos">938</span></a>
</span><span id="NiftiViewer.create_image_display-939"><a href="#NiftiViewer.create_image_display-939"><span class="linenos">939</span></a>            <span class="c1"># Create graphics scene for the view</span>
</span><span id="NiftiViewer.create_image_display-940"><a href="#NiftiViewer.create_image_display-940"><span class="linenos">940</span></a>            <span class="n">scene</span> <span class="o">=</span> <span class="n">QGraphicsScene</span><span class="p">()</span>
</span><span id="NiftiViewer.create_image_display-941"><a href="#NiftiViewer.create_image_display-941"><span class="linenos">941</span></a>            <span class="n">view</span><span class="o">.</span><span class="n">setScene</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-942"><a href="#NiftiViewer.create_image_display-942"><span class="linenos">942</span></a>
</span><span id="NiftiViewer.create_image_display-943"><a href="#NiftiViewer.create_image_display-943"><span class="linenos">943</span></a>            <span class="c1"># Create pixmap item (the actual displayed image)</span>
</span><span id="NiftiViewer.create_image_display-944"><a href="#NiftiViewer.create_image_display-944"><span class="linenos">944</span></a>            <span class="n">pixmap_item</span> <span class="o">=</span> <span class="n">QGraphicsPixmapItem</span><span class="p">()</span>
</span><span id="NiftiViewer.create_image_display-945"><a href="#NiftiViewer.create_image_display-945"><span class="linenos">945</span></a>            <span class="n">scene</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">pixmap_item</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-946"><a href="#NiftiViewer.create_image_display-946"><span class="linenos">946</span></a>
</span><span id="NiftiViewer.create_image_display-947"><a href="#NiftiViewer.create_image_display-947"><span class="linenos">947</span></a>            <span class="c1"># Add view to its container layout</span>
</span><span id="NiftiViewer.create_image_display-948"><a href="#NiftiViewer.create_image_display-948"><span class="linenos">948</span></a>            <span class="n">container_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-949"><a href="#NiftiViewer.create_image_display-949"><span class="linenos">949</span></a>
</span><span id="NiftiViewer.create_image_display-950"><a href="#NiftiViewer.create_image_display-950"><span class="linenos">950</span></a>            <span class="c1"># Place container in grid layout</span>
</span><span id="NiftiViewer.create_image_display-951"><a href="#NiftiViewer.create_image_display-951"><span class="linenos">951</span></a>            <span class="n">display_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">view_container</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-952"><a href="#NiftiViewer.create_image_display-952"><span class="linenos">952</span></a>
</span><span id="NiftiViewer.create_image_display-953"><a href="#NiftiViewer.create_image_display-953"><span class="linenos">953</span></a>            <span class="c1"># Keep references for later updates/redraws</span>
</span><span id="NiftiViewer.create_image_display-954"><a href="#NiftiViewer.create_image_display-954"><span class="linenos">954</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-955"><a href="#NiftiViewer.create_image_display-955"><span class="linenos">955</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-956"><a href="#NiftiViewer.create_image_display-956"><span class="linenos">956</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pixmap_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pixmap_item</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-957"><a href="#NiftiViewer.create_image_display-957"><span class="linenos">957</span></a>
</span><span id="NiftiViewer.create_image_display-958"><a href="#NiftiViewer.create_image_display-958"><span class="linenos">958</span></a>        <span class="c1"># ==============================</span>
</span><span id="NiftiViewer.create_image_display-959"><a href="#NiftiViewer.create_image_display-959"><span class="linenos">959</span></a>        <span class="c1">#  Fourth Panel (Info / Plot)</span>
</span><span id="NiftiViewer.create_image_display-960"><a href="#NiftiViewer.create_image_display-960"><span class="linenos">960</span></a>        <span class="c1"># ==============================</span>
</span><span id="NiftiViewer.create_image_display-961"><a href="#NiftiViewer.create_image_display-961"><span class="linenos">961</span></a>        <span class="c1"># Bottom-right panel for metadata or time-series visualization</span>
</span><span id="NiftiViewer.create_image_display-962"><a href="#NiftiViewer.create_image_display-962"><span class="linenos">962</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_widget</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
</span><span id="NiftiViewer.create_image_display-963"><a href="#NiftiViewer.create_image_display-963"><span class="linenos">963</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_widget</span><span class="o">.</span><span class="n">setFrameStyle</span><span class="p">(</span><span class="n">QFrame</span><span class="o">.</span><span class="n">Shape</span><span class="o">.</span><span class="n">StyledPanel</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-964"><a href="#NiftiViewer.create_image_display-964"><span class="linenos">964</span></a>        <span class="n">fourth_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fourth_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-965"><a href="#NiftiViewer.create_image_display-965"><span class="linenos">965</span></a>
</span><span id="NiftiViewer.create_image_display-966"><a href="#NiftiViewer.create_image_display-966"><span class="linenos">966</span></a>        <span class="c1"># Section title</span>
</span><span id="NiftiViewer.create_image_display-967"><a href="#NiftiViewer.create_image_display-967"><span class="linenos">967</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Image Information&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_image_display-968"><a href="#NiftiViewer.create_image_display-968"><span class="linenos">968</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignmentFlag</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-969"><a href="#NiftiViewer.create_image_display-969"><span class="linenos">969</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;font-weight: bold; padding: 4px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-970"><a href="#NiftiViewer.create_image_display-970"><span class="linenos">970</span></a>        <span class="n">fourth_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-971"><a href="#NiftiViewer.create_image_display-971"><span class="linenos">971</span></a>
</span><span id="NiftiViewer.create_image_display-972"><a href="#NiftiViewer.create_image_display-972"><span class="linenos">972</span></a>        <span class="c1"># Content container allows swapping between info text and plots</span>
</span><span id="NiftiViewer.create_image_display-973"><a href="#NiftiViewer.create_image_display-973"><span class="linenos">973</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_content</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span><span id="NiftiViewer.create_image_display-974"><a href="#NiftiViewer.create_image_display-974"><span class="linenos">974</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_content_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fourth_content</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-975"><a href="#NiftiViewer.create_image_display-975"><span class="linenos">975</span></a>
</span><span id="NiftiViewer.create_image_display-976"><a href="#NiftiViewer.create_image_display-976"><span class="linenos">976</span></a>        <span class="c1"># Default info label (shown when no image is loaded)</span>
</span><span id="NiftiViewer.create_image_display-977"><a href="#NiftiViewer.create_image_display-977"><span class="linenos">977</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;No image loaded&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.create_image_display-978"><a href="#NiftiViewer.create_image_display-978"><span class="linenos">978</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignmentFlag</span><span class="o">.</span><span class="n">AlignTop</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-979"><a href="#NiftiViewer.create_image_display-979"><span class="linenos">979</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: #cccccc; font-size: 11px; padding: 10px;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-980"><a href="#NiftiViewer.create_image_display-980"><span class="linenos">980</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setWordWrap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-981"><a href="#NiftiViewer.create_image_display-981"><span class="linenos">981</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_content_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-982"><a href="#NiftiViewer.create_image_display-982"><span class="linenos">982</span></a>
</span><span id="NiftiViewer.create_image_display-983"><a href="#NiftiViewer.create_image_display-983"><span class="linenos">983</span></a>        <span class="c1"># Placeholders for 4D time-series plotting (initialized later)</span>
</span><span id="NiftiViewer.create_image_display-984"><a href="#NiftiViewer.create_image_display-984"><span class="linenos">984</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_widget</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.create_image_display-985"><a href="#NiftiViewer.create_image_display-985"><span class="linenos">985</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.create_image_display-986"><a href="#NiftiViewer.create_image_display-986"><span class="linenos">986</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_indicator_line</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.create_image_display-987"><a href="#NiftiViewer.create_image_display-987"><span class="linenos">987</span></a>
</span><span id="NiftiViewer.create_image_display-988"><a href="#NiftiViewer.create_image_display-988"><span class="linenos">988</span></a>        <span class="c1"># Add dynamic content area to layout</span>
</span><span id="NiftiViewer.create_image_display-989"><a href="#NiftiViewer.create_image_display-989"><span class="linenos">989</span></a>        <span class="n">fourth_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fourth_content</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-990"><a href="#NiftiViewer.create_image_display-990"><span class="linenos">990</span></a>
</span><span id="NiftiViewer.create_image_display-991"><a href="#NiftiViewer.create_image_display-991"><span class="linenos">991</span></a>        <span class="c1"># Add the fourth widget to the main grid (bottom-right cell)</span>
</span><span id="NiftiViewer.create_image_display-992"><a href="#NiftiViewer.create_image_display-992"><span class="linenos">992</span></a>        <span class="n">display_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fourth_widget</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-993"><a href="#NiftiViewer.create_image_display-993"><span class="linenos">993</span></a>
</span><span id="NiftiViewer.create_image_display-994"><a href="#NiftiViewer.create_image_display-994"><span class="linenos">994</span></a>        <span class="c1"># Attach the full display grid to the parent splitter</span>
</span><span id="NiftiViewer.create_image_display-995"><a href="#NiftiViewer.create_image_display-995"><span class="linenos">995</span></a>        <span class="n">parent</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">display_widget</span><span class="p">)</span>
</span><span id="NiftiViewer.create_image_display-996"><a href="#NiftiViewer.create_image_display-996"><span class="linenos">996</span></a>
</span><span id="NiftiViewer.create_image_display-997"><a href="#NiftiViewer.create_image_display-997"><span class="linenos">997</span></a>        <span class="c1"># Delay setup of interactive crosshairs until UI is ready</span>
</span><span id="NiftiViewer.create_image_display-998"><a href="#NiftiViewer.create_image_display-998"><span class="linenos">998</span></a>        <span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_crosshairs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create the main image display panel with three anatomical views.</p>

<p>This function builds the right-hand visualization area of the NIfTI viewer,
which displays axial, coronal, and sagittal image slices. It also prepares
a fourth panel for displaying image information or time-series plots
(depending on whether the dataset is 3D or 4D).</p>

<p>Args:
    parent (QSplitter): The parent splitter widget where the display
        area is added.</p>

<p>Components:
    - Three synchronized image views with crosshairs.
    - A fourth panel for displaying image metadata or 4D time plots.
    - Dynamically initialized graphics scenes and pixmap items.</p>

<p>Raises:
    Exception: Propagates initialization errors in UI creation.</p>
</div>


                            </div>
                            <div id="NiftiViewer.setup_crosshairs" class="classattr">
                                        <input id="NiftiViewer.setup_crosshairs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_crosshairs</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.setup_crosshairs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.setup_crosshairs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.setup_crosshairs-1000"><a href="#NiftiViewer.setup_crosshairs-1000"><span class="linenos">1000</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_crosshairs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.setup_crosshairs-1001"><a href="#NiftiViewer.setup_crosshairs-1001"><span class="linenos">1001</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.setup_crosshairs-1002"><a href="#NiftiViewer.setup_crosshairs-1002"><span class="linenos">1002</span></a><span class="sd">        Initialize and configure crosshair overlays for all active image views.</span>
</span><span id="NiftiViewer.setup_crosshairs-1003"><a href="#NiftiViewer.setup_crosshairs-1003"><span class="linenos">1003</span></a>
</span><span id="NiftiViewer.setup_crosshairs-1004"><a href="#NiftiViewer.setup_crosshairs-1004"><span class="linenos">1004</span></a><span class="sd">        This method ensures that each anatomical view (axial, coronal, sagittal)</span>
</span><span id="NiftiViewer.setup_crosshairs-1005"><a href="#NiftiViewer.setup_crosshairs-1005"><span class="linenos">1005</span></a><span class="sd">        has its own interactive crosshair layer properly initialized.</span>
</span><span id="NiftiViewer.setup_crosshairs-1006"><a href="#NiftiViewer.setup_crosshairs-1006"><span class="linenos">1006</span></a>
</span><span id="NiftiViewer.setup_crosshairs-1007"><a href="#NiftiViewer.setup_crosshairs-1007"><span class="linenos">1007</span></a><span class="sd">        Purpose:</span>
</span><span id="NiftiViewer.setup_crosshairs-1008"><a href="#NiftiViewer.setup_crosshairs-1008"><span class="linenos">1008</span></a><span class="sd">            - Enables visual reference lines for voxel coordinates.</span>
</span><span id="NiftiViewer.setup_crosshairs-1009"><a href="#NiftiViewer.setup_crosshairs-1009"><span class="linenos">1009</span></a><span class="sd">            - Synchronizes navigation across views.</span>
</span><span id="NiftiViewer.setup_crosshairs-1010"><a href="#NiftiViewer.setup_crosshairs-1010"><span class="linenos">1010</span></a>
</span><span id="NiftiViewer.setup_crosshairs-1011"><a href="#NiftiViewer.setup_crosshairs-1011"><span class="linenos">1011</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer.setup_crosshairs-1012"><a href="#NiftiViewer.setup_crosshairs-1012"><span class="linenos">1012</span></a><span class="sd">            None</span>
</span><span id="NiftiViewer.setup_crosshairs-1013"><a href="#NiftiViewer.setup_crosshairs-1013"><span class="linenos">1013</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.setup_crosshairs-1014"><a href="#NiftiViewer.setup_crosshairs-1014"><span class="linenos">1014</span></a>        <span class="c1"># Iterate over all graphics views and initialize their crosshairs</span>
</span><span id="NiftiViewer.setup_crosshairs-1015"><a href="#NiftiViewer.setup_crosshairs-1015"><span class="linenos">1015</span></a>        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">:</span>
</span><span id="NiftiViewer.setup_crosshairs-1016"><a href="#NiftiViewer.setup_crosshairs-1016"><span class="linenos">1016</span></a>            <span class="n">view</span><span class="o">.</span><span class="n">setup_crosshairs</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Initialize and configure crosshair overlays for all active image views.</p>

<p>This method ensures that each anatomical view (axial, coronal, sagittal)
has its own interactive crosshair layer properly initialized.</p>

<p>Purpose:
    - Enables visual reference lines for voxel coordinates.
    - Synchronizes navigation across views.</p>

<p>Returns:
    None</p>
</div>


                            </div>
                            <div id="NiftiViewer.setup_connections" class="classattr">
                                        <input id="NiftiViewer.setup_connections-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_connections</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.setup_connections-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.setup_connections"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.setup_connections-1018"><a href="#NiftiViewer.setup_connections-1018"><span class="linenos">1018</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.setup_connections-1019"><a href="#NiftiViewer.setup_connections-1019"><span class="linenos">1019</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.setup_connections-1020"><a href="#NiftiViewer.setup_connections-1020"><span class="linenos">1020</span></a><span class="sd">        Establish all signal-slot connections for the viewer interface.</span>
</span><span id="NiftiViewer.setup_connections-1021"><a href="#NiftiViewer.setup_connections-1021"><span class="linenos">1021</span></a>
</span><span id="NiftiViewer.setup_connections-1022"><a href="#NiftiViewer.setup_connections-1022"><span class="linenos">1022</span></a><span class="sd">        This method binds user interface widgets (buttons, sliders, spin boxes, checkboxes)</span>
</span><span id="NiftiViewer.setup_connections-1023"><a href="#NiftiViewer.setup_connections-1023"><span class="linenos">1023</span></a><span class="sd">        to their respective event handlers to enable interactive control over the</span>
</span><span id="NiftiViewer.setup_connections-1024"><a href="#NiftiViewer.setup_connections-1024"><span class="linenos">1024</span></a><span class="sd">        visualization and processing of NIfTI images.</span>
</span><span id="NiftiViewer.setup_connections-1025"><a href="#NiftiViewer.setup_connections-1025"><span class="linenos">1025</span></a>
</span><span id="NiftiViewer.setup_connections-1026"><a href="#NiftiViewer.setup_connections-1026"><span class="linenos">1026</span></a><span class="sd">        Connections include:</span>
</span><span id="NiftiViewer.setup_connections-1027"><a href="#NiftiViewer.setup_connections-1027"><span class="linenos">1027</span></a><span class="sd">            - File operations (open base and overlay images)</span>
</span><span id="NiftiViewer.setup_connections-1028"><a href="#NiftiViewer.setup_connections-1028"><span class="linenos">1028</span></a><span class="sd">            - Slice navigation (sliders and spinboxes)</span>
</span><span id="NiftiViewer.setup_connections-1029"><a href="#NiftiViewer.setup_connections-1029"><span class="linenos">1029</span></a><span class="sd">            - ROI (Region of Interest) automation controls</span>
</span><span id="NiftiViewer.setup_connections-1030"><a href="#NiftiViewer.setup_connections-1030"><span class="linenos">1030</span></a><span class="sd">            - Time series navigation (for 4D datasets)</span>
</span><span id="NiftiViewer.setup_connections-1031"><a href="#NiftiViewer.setup_connections-1031"><span class="linenos">1031</span></a><span class="sd">            - Colormap and overlay adjustments</span>
</span><span id="NiftiViewer.setup_connections-1032"><a href="#NiftiViewer.setup_connections-1032"><span class="linenos">1032</span></a><span class="sd">            - Coordinate updates between synchronized views</span>
</span><span id="NiftiViewer.setup_connections-1033"><a href="#NiftiViewer.setup_connections-1033"><span class="linenos">1033</span></a>
</span><span id="NiftiViewer.setup_connections-1034"><a href="#NiftiViewer.setup_connections-1034"><span class="linenos">1034</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer.setup_connections-1035"><a href="#NiftiViewer.setup_connections-1035"><span class="linenos">1035</span></a><span class="sd">            None</span>
</span><span id="NiftiViewer.setup_connections-1036"><a href="#NiftiViewer.setup_connections-1036"><span class="linenos">1036</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.setup_connections-1037"><a href="#NiftiViewer.setup_connections-1037"><span class="linenos">1037</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.setup_connections-1038"><a href="#NiftiViewer.setup_connections-1038"><span class="linenos">1038</span></a>        <span class="c1"># File-related connections</span>
</span><span id="NiftiViewer.setup_connections-1039"><a href="#NiftiViewer.setup_connections-1039"><span class="linenos">1039</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.setup_connections-1040"><a href="#NiftiViewer.setup_connections-1040"><span class="linenos">1040</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">open_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">())</span>
</span><span id="NiftiViewer.setup_connections-1041"><a href="#NiftiViewer.setup_connections-1041"><span class="linenos">1041</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">is_overlay</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="NiftiViewer.setup_connections-1042"><a href="#NiftiViewer.setup_connections-1042"><span class="linenos">1042</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_overlay</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_connections-1043"><a href="#NiftiViewer.setup_connections-1043"><span class="linenos">1043</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_overlay_alpha</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_connections-1044"><a href="#NiftiViewer.setup_connections-1044"><span class="linenos">1044</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_overlay_threshold</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_connections-1045"><a href="#NiftiViewer.setup_connections-1045"><span class="linenos">1045</span></a>
</span><span id="NiftiViewer.setup_connections-1046"><a href="#NiftiViewer.setup_connections-1046"><span class="linenos">1046</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.setup_connections-1047"><a href="#NiftiViewer.setup_connections-1047"><span class="linenos">1047</span></a>        <span class="c1"># Slice navigation connections</span>
</span><span id="NiftiViewer.setup_connections-1048"><a href="#NiftiViewer.setup_connections-1048"><span class="linenos">1048</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.setup_connections-1049"><a href="#NiftiViewer.setup_connections-1049"><span class="linenos">1049</span></a>        <span class="c1"># Connect slice sliders and spinboxes for all anatomical planes</span>
</span><span id="NiftiViewer.setup_connections-1050"><a href="#NiftiViewer.setup_connections-1050"><span class="linenos">1050</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">slider</span><span class="p">,</span> <span class="n">spinbox</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">)):</span>
</span><span id="NiftiViewer.setup_connections-1051"><a href="#NiftiViewer.setup_connections-1051"><span class="linenos">1051</span></a>            <span class="n">slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_changed</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</span><span id="NiftiViewer.setup_connections-1052"><a href="#NiftiViewer.setup_connections-1052"><span class="linenos">1052</span></a>            <span class="n">spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_changed</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</span><span id="NiftiViewer.setup_connections-1053"><a href="#NiftiViewer.setup_connections-1053"><span class="linenos">1053</span></a>
</span><span id="NiftiViewer.setup_connections-1054"><a href="#NiftiViewer.setup_connections-1054"><span class="linenos">1054</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.setup_connections-1055"><a href="#NiftiViewer.setup_connections-1055"><span class="linenos">1055</span></a>        <span class="c1"># Automatic ROI Drawing controls</span>
</span><span id="NiftiViewer.setup_connections-1056"><a href="#NiftiViewer.setup_connections-1056"><span class="linenos">1056</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.setup_connections-1057"><a href="#NiftiViewer.setup_connections-1057"><span class="linenos">1057</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_clicked</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_connections-1058"><a href="#NiftiViewer.setup_connections-1058"><span class="linenos">1058</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_automaticROI</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_connections-1059"><a href="#NiftiViewer.setup_connections-1059"><span class="linenos">1059</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_automaticROI</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_connections-1060"><a href="#NiftiViewer.setup_connections-1060"><span class="linenos">1060</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_save</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_connections-1061"><a href="#NiftiViewer.setup_connections-1061"><span class="linenos">1061</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_automaticROI</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_connections-1062"><a href="#NiftiViewer.setup_connections-1062"><span class="linenos">1062</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_clicked</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_connections-1063"><a href="#NiftiViewer.setup_connections-1063"><span class="linenos">1063</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_incrementalROI</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_connections-1064"><a href="#NiftiViewer.setup_connections-1064"><span class="linenos">1064</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resetROI</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_connections-1065"><a href="#NiftiViewer.setup_connections-1065"><span class="linenos">1065</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.setup_connections-1066"><a href="#NiftiViewer.setup_connections-1066"><span class="linenos">1066</span></a>        <span class="c1"># Time-series control connections (for 4D images)</span>
</span><span id="NiftiViewer.setup_connections-1067"><a href="#NiftiViewer.setup_connections-1067"><span class="linenos">1067</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.setup_connections-1068"><a href="#NiftiViewer.setup_connections-1068"><span class="linenos">1068</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_time_controls</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_connections-1069"><a href="#NiftiViewer.setup_connections-1069"><span class="linenos">1069</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_changed</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_connections-1070"><a href="#NiftiViewer.setup_connections-1070"><span class="linenos">1070</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_changed</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_connections-1071"><a href="#NiftiViewer.setup_connections-1071"><span class="linenos">1071</span></a>
</span><span id="NiftiViewer.setup_connections-1072"><a href="#NiftiViewer.setup_connections-1072"><span class="linenos">1072</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.setup_connections-1073"><a href="#NiftiViewer.setup_connections-1073"><span class="linenos">1073</span></a>        <span class="c1"># Colormap control</span>
</span><span id="NiftiViewer.setup_connections-1074"><a href="#NiftiViewer.setup_connections-1074"><span class="linenos">1074</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.setup_connections-1075"><a href="#NiftiViewer.setup_connections-1075"><span class="linenos">1075</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap_combo</span><span class="o">.</span><span class="n">currentTextChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colormap_changed</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_connections-1076"><a href="#NiftiViewer.setup_connections-1076"><span class="linenos">1076</span></a>
</span><span id="NiftiViewer.setup_connections-1077"><a href="#NiftiViewer.setup_connections-1077"><span class="linenos">1077</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.setup_connections-1078"><a href="#NiftiViewer.setup_connections-1078"><span class="linenos">1078</span></a>        <span class="c1"># Coordinate synchronization across views</span>
</span><span id="NiftiViewer.setup_connections-1079"><a href="#NiftiViewer.setup_connections-1079"><span class="linenos">1079</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.setup_connections-1080"><a href="#NiftiViewer.setup_connections-1080"><span class="linenos">1080</span></a>        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">:</span>
</span><span id="NiftiViewer.setup_connections-1081"><a href="#NiftiViewer.setup_connections-1081"><span class="linenos">1081</span></a>            <span class="n">view</span><span class="o">.</span><span class="n">coordinate_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_coordinates</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Establish all signal-slot connections for the viewer interface.</p>

<p>This method binds user interface widgets (buttons, sliders, spin boxes, checkboxes)
to their respective event handlers to enable interactive control over the
visualization and processing of NIfTI images.</p>

<p>Connections include:
    - File operations (open base and overlay images)
    - Slice navigation (sliders and spinboxes)
    - ROI (Region of Interest) automation controls
    - Time series navigation (for 4D datasets)
    - Colormap and overlay adjustments
    - Coordinate updates between synchronized views</p>

<p>Returns:
    None</p>
</div>


                            </div>
                            <div id="NiftiViewer.show_workspace_nii_dialog" class="classattr">
                                        <input id="NiftiViewer.show_workspace_nii_dialog-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">show_workspace_nii_dialog</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">is_overlay</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.show_workspace_nii_dialog-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.show_workspace_nii_dialog"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.show_workspace_nii_dialog-1083"><a href="#NiftiViewer.show_workspace_nii_dialog-1083"><span class="linenos">1083</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">show_workspace_nii_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_overlay</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1084"><a href="#NiftiViewer.show_workspace_nii_dialog-1084"><span class="linenos">1084</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1085"><a href="#NiftiViewer.show_workspace_nii_dialog-1085"><span class="linenos">1085</span></a><span class="sd">        Open a workspace-aware file selection dialog for NIfTI files.</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1086"><a href="#NiftiViewer.show_workspace_nii_dialog-1086"><span class="linenos">1086</span></a>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1087"><a href="#NiftiViewer.show_workspace_nii_dialog-1087"><span class="linenos">1087</span></a><span class="sd">        Depending on the mode (`is_overlay`), this dialog either selects</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1088"><a href="#NiftiViewer.show_workspace_nii_dialog-1088"><span class="linenos">1088</span></a><span class="sd">        a base anatomical image or a secondary overlay image from the users workspace.</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1089"><a href="#NiftiViewer.show_workspace_nii_dialog-1089"><span class="linenos">1089</span></a>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1090"><a href="#NiftiViewer.show_workspace_nii_dialog-1090"><span class="linenos">1090</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1091"><a href="#NiftiViewer.show_workspace_nii_dialog-1091"><span class="linenos">1091</span></a><span class="sd">            is_overlay (bool, optional): Whether the dialog is for selecting an overlay file.</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1092"><a href="#NiftiViewer.show_workspace_nii_dialog-1092"><span class="linenos">1092</span></a><span class="sd">                Defaults to False.</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1093"><a href="#NiftiViewer.show_workspace_nii_dialog-1093"><span class="linenos">1093</span></a>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1094"><a href="#NiftiViewer.show_workspace_nii_dialog-1094"><span class="linenos">1094</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1095"><a href="#NiftiViewer.show_workspace_nii_dialog-1095"><span class="linenos">1095</span></a><span class="sd">            None: If a file is selected, it triggers `open_file()` automatically.</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1096"><a href="#NiftiViewer.show_workspace_nii_dialog-1096"><span class="linenos">1096</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1097"><a href="#NiftiViewer.show_workspace_nii_dialog-1097"><span class="linenos">1097</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1098"><a href="#NiftiViewer.show_workspace_nii_dialog-1098"><span class="linenos">1098</span></a>        <span class="c1"># Select file using NiftiFileDialog, filtering appropriately</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1099"><a href="#NiftiViewer.show_workspace_nii_dialog-1099"><span class="linenos">1099</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1100"><a href="#NiftiViewer.show_workspace_nii_dialog-1100"><span class="linenos">1100</span></a>        <span class="k">if</span> <span class="n">is_overlay</span><span class="p">:</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1101"><a href="#NiftiViewer.show_workspace_nii_dialog-1101"><span class="linenos">1101</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">NiftiFileDialog</span><span class="o">.</span><span class="n">get_files</span><span class="p">(</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1102"><a href="#NiftiViewer.show_workspace_nii_dialog-1102"><span class="linenos">1102</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1103"><a href="#NiftiViewer.show_workspace_nii_dialog-1103"><span class="linenos">1103</span></a>                <span class="n">allow_multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1104"><a href="#NiftiViewer.show_workspace_nii_dialog-1104"><span class="linenos">1104</span></a>                <span class="n">has_existing_func</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1105"><a href="#NiftiViewer.show_workspace_nii_dialog-1105"><span class="linenos">1105</span></a>                <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1106"><a href="#NiftiViewer.show_workspace_nii_dialog-1106"><span class="linenos">1106</span></a>                <span class="n">forced_filters</span><span class="o">=</span><span class="kc">None</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1107"><a href="#NiftiViewer.show_workspace_nii_dialog-1107"><span class="linenos">1107</span></a>            <span class="p">)</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1108"><a href="#NiftiViewer.show_workspace_nii_dialog-1108"><span class="linenos">1108</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1109"><a href="#NiftiViewer.show_workspace_nii_dialog-1109"><span class="linenos">1109</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">NiftiFileDialog</span><span class="o">.</span><span class="n">get_files</span><span class="p">(</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1110"><a href="#NiftiViewer.show_workspace_nii_dialog-1110"><span class="linenos">1110</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1111"><a href="#NiftiViewer.show_workspace_nii_dialog-1111"><span class="linenos">1111</span></a>                <span class="n">allow_multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1112"><a href="#NiftiViewer.show_workspace_nii_dialog-1112"><span class="linenos">1112</span></a>                <span class="n">has_existing_func</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1113"><a href="#NiftiViewer.show_workspace_nii_dialog-1113"><span class="linenos">1113</span></a>                <span class="n">label</span><span class="o">=</span><span class="kc">None</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1114"><a href="#NiftiViewer.show_workspace_nii_dialog-1114"><span class="linenos">1114</span></a>            <span class="p">)</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1115"><a href="#NiftiViewer.show_workspace_nii_dialog-1115"><span class="linenos">1115</span></a>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1116"><a href="#NiftiViewer.show_workspace_nii_dialog-1116"><span class="linenos">1116</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1117"><a href="#NiftiViewer.show_workspace_nii_dialog-1117"><span class="linenos">1117</span></a>        <span class="c1"># Open file if a valid selection was made</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1118"><a href="#NiftiViewer.show_workspace_nii_dialog-1118"><span class="linenos">1118</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1119"><a href="#NiftiViewer.show_workspace_nii_dialog-1119"><span class="linenos">1119</span></a>        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
</span><span id="NiftiViewer.show_workspace_nii_dialog-1120"><a href="#NiftiViewer.show_workspace_nii_dialog-1120"><span class="linenos">1120</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">is_overlay</span><span class="o">=</span><span class="n">is_overlay</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Open a workspace-aware file selection dialog for NIfTI files.</p>

<p>Depending on the mode (<code>is_overlay</code>), this dialog either selects
a base anatomical image or a secondary overlay image from the users workspace.</p>

<p>Args:
    is_overlay (bool, optional): Whether the dialog is for selecting an overlay file.
        Defaults to False.</p>

<p>Returns:
    None: If a file is selected, it triggers <code><a href="#NiftiViewer.open_file">open_file()</a></code> automatically.</p>
</div>


                            </div>
                            <div id="NiftiViewer.open_file" class="classattr">
                                        <input id="NiftiViewer.open_file-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">open_file</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">file_path</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">is_overlay</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.open_file-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.open_file"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.open_file-1122"><a href="#NiftiViewer.open_file-1122"><span class="linenos">1122</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">open_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_overlay</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="NiftiViewer.open_file-1123"><a href="#NiftiViewer.open_file-1123"><span class="linenos">1123</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.open_file-1124"><a href="#NiftiViewer.open_file-1124"><span class="linenos">1124</span></a><span class="sd">        Load a NIfTI file (base or overlay) using a background thread.</span>
</span><span id="NiftiViewer.open_file-1125"><a href="#NiftiViewer.open_file-1125"><span class="linenos">1125</span></a>
</span><span id="NiftiViewer.open_file-1126"><a href="#NiftiViewer.open_file-1126"><span class="linenos">1126</span></a><span class="sd">        This method either opens a file dialog for selecting a NIfTI file</span>
</span><span id="NiftiViewer.open_file-1127"><a href="#NiftiViewer.open_file-1127"><span class="linenos">1127</span></a><span class="sd">        or loads a specified path directly. The loading process runs in a</span>
</span><span id="NiftiViewer.open_file-1128"><a href="#NiftiViewer.open_file-1128"><span class="linenos">1128</span></a><span class="sd">        separate thread to keep the UI responsive, with progress reported</span>
</span><span id="NiftiViewer.open_file-1129"><a href="#NiftiViewer.open_file-1129"><span class="linenos">1129</span></a><span class="sd">        via a modal progress dialog.</span>
</span><span id="NiftiViewer.open_file-1130"><a href="#NiftiViewer.open_file-1130"><span class="linenos">1130</span></a>
</span><span id="NiftiViewer.open_file-1131"><a href="#NiftiViewer.open_file-1131"><span class="linenos">1131</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.open_file-1132"><a href="#NiftiViewer.open_file-1132"><span class="linenos">1132</span></a><span class="sd">            file_path (str, optional): Path to the NIfTI file to load. If None,</span>
</span><span id="NiftiViewer.open_file-1133"><a href="#NiftiViewer.open_file-1133"><span class="linenos">1133</span></a><span class="sd">                a file dialog will be displayed.</span>
</span><span id="NiftiViewer.open_file-1134"><a href="#NiftiViewer.open_file-1134"><span class="linenos">1134</span></a><span class="sd">            is_overlay (bool, optional): Whether the file being opened is an overlay</span>
</span><span id="NiftiViewer.open_file-1135"><a href="#NiftiViewer.open_file-1135"><span class="linenos">1135</span></a><span class="sd">                (requires a base image to be already loaded). Defaults to False.</span>
</span><span id="NiftiViewer.open_file-1136"><a href="#NiftiViewer.open_file-1136"><span class="linenos">1136</span></a>
</span><span id="NiftiViewer.open_file-1137"><a href="#NiftiViewer.open_file-1137"><span class="linenos">1137</span></a><span class="sd">        Raises:</span>
</span><span id="NiftiViewer.open_file-1138"><a href="#NiftiViewer.open_file-1138"><span class="linenos">1138</span></a><span class="sd">            RuntimeError: If the overlay is loaded without a base image.</span>
</span><span id="NiftiViewer.open_file-1139"><a href="#NiftiViewer.open_file-1139"><span class="linenos">1139</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.open_file-1140"><a href="#NiftiViewer.open_file-1140"><span class="linenos">1140</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.open_file-1141"><a href="#NiftiViewer.open_file-1141"><span class="linenos">1141</span></a>        <span class="c1"># Prevent overlay loading without a base image</span>
</span><span id="NiftiViewer.open_file-1142"><a href="#NiftiViewer.open_file-1142"><span class="linenos">1142</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.open_file-1143"><a href="#NiftiViewer.open_file-1143"><span class="linenos">1143</span></a>        <span class="k">if</span> <span class="n">is_overlay</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.open_file-1144"><a href="#NiftiViewer.open_file-1144"><span class="linenos">1144</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="NiftiViewer.open_file-1145"><a href="#NiftiViewer.open_file-1145"><span class="linenos">1145</span></a>                <span class="bp">self</span><span class="p">,</span>
</span><span id="NiftiViewer.open_file-1146"><a href="#NiftiViewer.open_file-1146"><span class="linenos">1146</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Warning&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer.open_file-1147"><a href="#NiftiViewer.open_file-1147"><span class="linenos">1147</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Please load a base image first!&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.open_file-1148"><a href="#NiftiViewer.open_file-1148"><span class="linenos">1148</span></a>            <span class="p">)</span>
</span><span id="NiftiViewer.open_file-1149"><a href="#NiftiViewer.open_file-1149"><span class="linenos">1149</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No base image&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.open_file-1150"><a href="#NiftiViewer.open_file-1150"><span class="linenos">1150</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer.open_file-1151"><a href="#NiftiViewer.open_file-1151"><span class="linenos">1151</span></a>
</span><span id="NiftiViewer.open_file-1152"><a href="#NiftiViewer.open_file-1152"><span class="linenos">1152</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.open_file-1153"><a href="#NiftiViewer.open_file-1153"><span class="linenos">1153</span></a>        <span class="c1"># Show file dialog if no path is provided</span>
</span><span id="NiftiViewer.open_file-1154"><a href="#NiftiViewer.open_file-1154"><span class="linenos">1154</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.open_file-1155"><a href="#NiftiViewer.open_file-1155"><span class="linenos">1155</span></a>        <span class="k">if</span> <span class="n">file_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.open_file-1156"><a href="#NiftiViewer.open_file-1156"><span class="linenos">1156</span></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_workspace_nii_dialog</span><span class="p">(</span><span class="n">is_overlay</span><span class="o">=</span><span class="n">is_overlay</span><span class="p">)</span>
</span><span id="NiftiViewer.open_file-1157"><a href="#NiftiViewer.open_file-1157"><span class="linenos">1157</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="p">:</span>  <span class="c1"># User canceled the dialog</span>
</span><span id="NiftiViewer.open_file-1158"><a href="#NiftiViewer.open_file-1158"><span class="linenos">1158</span></a>                <span class="k">return</span>
</span><span id="NiftiViewer.open_file-1159"><a href="#NiftiViewer.open_file-1159"><span class="linenos">1159</span></a>
</span><span id="NiftiViewer.open_file-1160"><a href="#NiftiViewer.open_file-1160"><span class="linenos">1160</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.open_file-1161"><a href="#NiftiViewer.open_file-1161"><span class="linenos">1161</span></a>        <span class="c1"># Start file loading process</span>
</span><span id="NiftiViewer.open_file-1162"><a href="#NiftiViewer.open_file-1162"><span class="linenos">1162</span></a>        <span class="c1"># ----------------------------</span>
</span><span id="NiftiViewer.open_file-1163"><a href="#NiftiViewer.open_file-1163"><span class="linenos">1163</span></a>        <span class="k">if</span> <span class="n">file_path</span><span class="p">:</span>
</span><span id="NiftiViewer.open_file-1164"><a href="#NiftiViewer.open_file-1164"><span class="linenos">1164</span></a>            <span class="c1"># Create and configure progress dialog</span>
</span><span id="NiftiViewer.open_file-1165"><a href="#NiftiViewer.open_file-1165"><span class="linenos">1165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span> <span class="o">=</span> <span class="n">QProgressDialog</span><span class="p">(</span>
</span><span id="NiftiViewer.open_file-1166"><a href="#NiftiViewer.open_file-1166"><span class="linenos">1166</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Loading NIfTI file...&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer.open_file-1167"><a href="#NiftiViewer.open_file-1167"><span class="linenos">1167</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Cancel&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="bp">self</span>
</span><span id="NiftiViewer.open_file-1168"><a href="#NiftiViewer.open_file-1168"><span class="linenos">1168</span></a>            <span class="p">)</span>
</span><span id="NiftiViewer.open_file-1169"><a href="#NiftiViewer.open_file-1169"><span class="linenos">1169</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">setWindowModality</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WindowModality</span><span class="o">.</span><span class="n">WindowModal</span><span class="p">)</span>
</span><span id="NiftiViewer.open_file-1170"><a href="#NiftiViewer.open_file-1170"><span class="linenos">1170</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">setMinimumDuration</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.open_file-1171"><a href="#NiftiViewer.open_file-1171"><span class="linenos">1171</span></a>
</span><span id="NiftiViewer.open_file-1172"><a href="#NiftiViewer.open_file-1172"><span class="linenos">1172</span></a>            <span class="c1"># Launch threaded image loading</span>
</span><span id="NiftiViewer.open_file-1173"><a href="#NiftiViewer.open_file-1173"><span class="linenos">1173</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ImageLoadThread</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">is_overlay</span><span class="p">))</span>
</span><span id="NiftiViewer.open_file-1174"><a href="#NiftiViewer.open_file-1174"><span class="linenos">1174</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_file_loaded</span><span class="p">)</span>
</span><span id="NiftiViewer.open_file-1175"><a href="#NiftiViewer.open_file-1175"><span class="linenos">1175</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_load_error</span><span class="p">)</span>
</span><span id="NiftiViewer.open_file-1176"><a href="#NiftiViewer.open_file-1176"><span class="linenos">1176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span><span id="NiftiViewer.open_file-1177"><a href="#NiftiViewer.open_file-1177"><span class="linenos">1177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="NiftiViewer.open_file-1178"><a href="#NiftiViewer.open_file-1178"><span class="linenos">1178</span></a>
</span><span id="NiftiViewer.open_file-1179"><a href="#NiftiViewer.open_file-1179"><span class="linenos">1179</span></a>            <span class="c1"># Allow user to cancel the loading process</span>
</span><span id="NiftiViewer.open_file-1180"><a href="#NiftiViewer.open_file-1180"><span class="linenos">1180</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">canceled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_load_canceled</span><span class="p">)</span>
</span><span id="NiftiViewer.open_file-1181"><a href="#NiftiViewer.open_file-1181"><span class="linenos">1181</span></a>
</span><span id="NiftiViewer.open_file-1182"><a href="#NiftiViewer.open_file-1182"><span class="linenos">1182</span></a>            <span class="c1"># Save file path to appropriate variable</span>
</span><span id="NiftiViewer.open_file-1183"><a href="#NiftiViewer.open_file-1183"><span class="linenos">1183</span></a>            <span class="k">if</span> <span class="n">is_overlay</span><span class="p">:</span>
</span><span id="NiftiViewer.open_file-1184"><a href="#NiftiViewer.open_file-1184"><span class="linenos">1184</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">overlay_file_path</span> <span class="o">=</span> <span class="n">file_path</span>
</span><span id="NiftiViewer.open_file-1185"><a href="#NiftiViewer.open_file-1185"><span class="linenos">1185</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.open_file-1186"><a href="#NiftiViewer.open_file-1186"><span class="linenos">1186</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span>
</span></pre></div>


            <div class="docstring"><p>Load a NIfTI file (base or overlay) using a background thread.</p>

<p>This method either opens a file dialog for selecting a NIfTI file
or loads a specified path directly. The loading process runs in a
separate thread to keep the UI responsive, with progress reported
via a modal progress dialog.</p>

<p>Args:
    file_path (str, optional): Path to the NIfTI file to load. If None,
        a file dialog will be displayed.
    is_overlay (bool, optional): Whether the file being opened is an overlay
        (requires a base image to be already loaded). Defaults to False.</p>

<p>Raises:
    RuntimeError: If the overlay is loaded without a base image.</p>
</div>


                            </div>
                            <div id="NiftiViewer.on_file_loaded" class="classattr">
                                        <input id="NiftiViewer.on_file_loaded-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_file_loaded</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">img_data</span>, </span><span class="param"><span class="n">dims</span>, </span><span class="param"><span class="n">affine</span>, </span><span class="param"><span class="n">is_4d</span>, </span><span class="param"><span class="n">is_overlay</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.on_file_loaded-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.on_file_loaded"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.on_file_loaded-1188"><a href="#NiftiViewer.on_file_loaded-1188"><span class="linenos">1188</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_file_loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_data</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">affine</span><span class="p">,</span> <span class="n">is_4d</span><span class="p">,</span> <span class="n">is_overlay</span><span class="p">):</span>
</span><span id="NiftiViewer.on_file_loaded-1189"><a href="#NiftiViewer.on_file_loaded-1189"><span class="linenos">1189</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.on_file_loaded-1190"><a href="#NiftiViewer.on_file_loaded-1190"><span class="linenos">1190</span></a><span class="sd">        Handle successful completion of a NIfTI file loading operation.</span>
</span><span id="NiftiViewer.on_file_loaded-1191"><a href="#NiftiViewer.on_file_loaded-1191"><span class="linenos">1191</span></a>
</span><span id="NiftiViewer.on_file_loaded-1192"><a href="#NiftiViewer.on_file_loaded-1192"><span class="linenos">1192</span></a><span class="sd">        This method is called when the background loading thread finishes without errors.</span>
</span><span id="NiftiViewer.on_file_loaded-1193"><a href="#NiftiViewer.on_file_loaded-1193"><span class="linenos">1193</span></a><span class="sd">        It manages both base image and overlay image loading results.</span>
</span><span id="NiftiViewer.on_file_loaded-1194"><a href="#NiftiViewer.on_file_loaded-1194"><span class="linenos">1194</span></a>
</span><span id="NiftiViewer.on_file_loaded-1195"><a href="#NiftiViewer.on_file_loaded-1195"><span class="linenos">1195</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.on_file_loaded-1196"><a href="#NiftiViewer.on_file_loaded-1196"><span class="linenos">1196</span></a><span class="sd">            img_data (numpy.ndarray): Loaded image data array.</span>
</span><span id="NiftiViewer.on_file_loaded-1197"><a href="#NiftiViewer.on_file_loaded-1197"><span class="linenos">1197</span></a><span class="sd">            dims (tuple): Dimensions of the loaded image (e.g., (X, Y, Z) or (X, Y, Z, T)).</span>
</span><span id="NiftiViewer.on_file_loaded-1198"><a href="#NiftiViewer.on_file_loaded-1198"><span class="linenos">1198</span></a><span class="sd">            affine (numpy.ndarray): Affine transformation matrix defining voxel-to-world mapping.</span>
</span><span id="NiftiViewer.on_file_loaded-1199"><a href="#NiftiViewer.on_file_loaded-1199"><span class="linenos">1199</span></a><span class="sd">            is_4d (bool): Whether the loaded image is a 4D time series.</span>
</span><span id="NiftiViewer.on_file_loaded-1200"><a href="#NiftiViewer.on_file_loaded-1200"><span class="linenos">1200</span></a><span class="sd">            is_overlay (bool): Whether the loaded file is an overlay rather than a base image.</span>
</span><span id="NiftiViewer.on_file_loaded-1201"><a href="#NiftiViewer.on_file_loaded-1201"><span class="linenos">1201</span></a>
</span><span id="NiftiViewer.on_file_loaded-1202"><a href="#NiftiViewer.on_file_loaded-1202"><span class="linenos">1202</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer.on_file_loaded-1203"><a href="#NiftiViewer.on_file_loaded-1203"><span class="linenos">1203</span></a><span class="sd">            None</span>
</span><span id="NiftiViewer.on_file_loaded-1204"><a href="#NiftiViewer.on_file_loaded-1204"><span class="linenos">1204</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.on_file_loaded-1205"><a href="#NiftiViewer.on_file_loaded-1205"><span class="linenos">1205</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading NIfTI image...&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1206"><a href="#NiftiViewer.on_file_loaded-1206"><span class="linenos">1206</span></a>        <span class="c1"># Disconnect progress dialog cancel signal and close it</span>
</span><span id="NiftiViewer.on_file_loaded-1207"><a href="#NiftiViewer.on_file_loaded-1207"><span class="linenos">1207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">canceled</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</span><span id="NiftiViewer.on_file_loaded-1208"><a href="#NiftiViewer.on_file_loaded-1208"><span class="linenos">1208</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="NiftiViewer.on_file_loaded-1209"><a href="#NiftiViewer.on_file_loaded-1209"><span class="linenos">1209</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Remove the finished thread&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1210"><a href="#NiftiViewer.on_file_loaded-1210"><span class="linenos">1210</span></a>        <span class="c1"># Remove the finished thread from active threads list</span>
</span><span id="NiftiViewer.on_file_loaded-1211"><a href="#NiftiViewer.on_file_loaded-1211"><span class="linenos">1211</span></a>        <span class="n">thread_to_cancel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span>
</span><span id="NiftiViewer.on_file_loaded-1212"><a href="#NiftiViewer.on_file_loaded-1212"><span class="linenos">1212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread_to_cancel</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1213"><a href="#NiftiViewer.on_file_loaded-1213"><span class="linenos">1213</span></a>
</span><span id="NiftiViewer.on_file_loaded-1214"><a href="#NiftiViewer.on_file_loaded-1214"><span class="linenos">1214</span></a>        <span class="c1"># ---------------------------------------------------</span>
</span><span id="NiftiViewer.on_file_loaded-1215"><a href="#NiftiViewer.on_file_loaded-1215"><span class="linenos">1215</span></a>        <span class="c1"># Handle overlay image loading</span>
</span><span id="NiftiViewer.on_file_loaded-1216"><a href="#NiftiViewer.on_file_loaded-1216"><span class="linenos">1216</span></a>        <span class="c1"># ---------------------------------------------------</span>
</span><span id="NiftiViewer.on_file_loaded-1217"><a href="#NiftiViewer.on_file_loaded-1217"><span class="linenos">1217</span></a>        <span class="k">if</span> <span class="n">is_overlay</span><span class="p">:</span>
</span><span id="NiftiViewer.on_file_loaded-1218"><a href="#NiftiViewer.on_file_loaded-1218"><span class="linenos">1218</span></a>            <span class="c1"># Store overlay data and its dimensions</span>
</span><span id="NiftiViewer.on_file_loaded-1219"><a href="#NiftiViewer.on_file_loaded-1219"><span class="linenos">1219</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">=</span> <span class="n">img_data</span>
</span><span id="NiftiViewer.on_file_loaded-1220"><a href="#NiftiViewer.on_file_loaded-1220"><span class="linenos">1220</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_dims</span> <span class="o">=</span> <span class="n">dims</span>
</span><span id="NiftiViewer.on_file_loaded-1221"><a href="#NiftiViewer.on_file_loaded-1221"><span class="linenos">1221</span></a>
</span><span id="NiftiViewer.on_file_loaded-1222"><a href="#NiftiViewer.on_file_loaded-1222"><span class="linenos">1222</span></a>            <span class="c1"># Check for dimension mismatch and apply padding if necessary</span>
</span><span id="NiftiViewer.on_file_loaded-1223"><a href="#NiftiViewer.on_file_loaded-1223"><span class="linenos">1223</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;dims&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
</span><span id="NiftiViewer.on_file_loaded-1224"><a href="#NiftiViewer.on_file_loaded-1224"><span class="linenos">1224</span></a>                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="NiftiViewer.on_file_loaded-1225"><a href="#NiftiViewer.on_file_loaded-1225"><span class="linenos">1225</span></a>                    <span class="bp">self</span><span class="p">,</span>
</span><span id="NiftiViewer.on_file_loaded-1226"><a href="#NiftiViewer.on_file_loaded-1226"><span class="linenos">1226</span></a>                    <span class="s2">&quot;Dimensions mismatch!&quot;</span><span class="p">,</span>
</span><span id="NiftiViewer.on_file_loaded-1227"><a href="#NiftiViewer.on_file_loaded-1227"><span class="linenos">1227</span></a>                    <span class="sa">f</span><span class="s2">&quot;The main image has dimensions </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> and the overlay has dimensions </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="NiftiViewer.on_file_loaded-1228"><a href="#NiftiViewer.on_file_loaded-1228"><span class="linenos">1228</span></a>                <span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1229"><a href="#NiftiViewer.on_file_loaded-1229"><span class="linenos">1229</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_volume_to_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="NiftiViewer.on_file_loaded-1230"><a href="#NiftiViewer.on_file_loaded-1230"><span class="linenos">1230</span></a>
</span><span id="NiftiViewer.on_file_loaded-1231"><a href="#NiftiViewer.on_file_loaded-1231"><span class="linenos">1231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="NiftiViewer.on_file_loaded-1232"><a href="#NiftiViewer.on_file_loaded-1232"><span class="linenos">1232</span></a>
</span><span id="NiftiViewer.on_file_loaded-1233"><a href="#NiftiViewer.on_file_loaded-1233"><span class="linenos">1233</span></a>            <span class="c1"># Update overlay information label</span>
</span><span id="NiftiViewer.on_file_loaded-1234"><a href="#NiftiViewer.on_file_loaded-1234"><span class="linenos">1234</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_file_path</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1235"><a href="#NiftiViewer.on_file_loaded-1235"><span class="linenos">1235</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
</span><span id="NiftiViewer.on_file_loaded-1236"><a href="#NiftiViewer.on_file_loaded-1236"><span class="linenos">1236</span></a>                <span class="sa">f</span><span class="s2">&quot;Overlay: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
</span><span id="NiftiViewer.on_file_loaded-1237"><a href="#NiftiViewer.on_file_loaded-1237"><span class="linenos">1237</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span> <span class="o">+</span>
</span><span id="NiftiViewer.on_file_loaded-1238"><a href="#NiftiViewer.on_file_loaded-1238"><span class="linenos">1238</span></a>                <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_dims</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="NiftiViewer.on_file_loaded-1239"><a href="#NiftiViewer.on_file_loaded-1239"><span class="linenos">1239</span></a>            <span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1240"><a href="#NiftiViewer.on_file_loaded-1240"><span class="linenos">1240</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Activate the UI&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1241"><a href="#NiftiViewer.on_file_loaded-1241"><span class="linenos">1241</span></a>            <span class="c1"># Enable and activate overlay in UI</span>
</span><span id="NiftiViewer.on_file_loaded-1242"><a href="#NiftiViewer.on_file_loaded-1242"><span class="linenos">1242</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">toggle_overlay</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1243"><a href="#NiftiViewer.on_file_loaded-1243"><span class="linenos">1243</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Update overlay threshold&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1244"><a href="#NiftiViewer.on_file_loaded-1244"><span class="linenos">1244</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_overlay_threshold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1245"><a href="#NiftiViewer.on_file_loaded-1245"><span class="linenos">1245</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Update display settings&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1246"><a href="#NiftiViewer.on_file_loaded-1246"><span class="linenos">1246</span></a>            <span class="c1"># Refresh display with updated overlay settings</span>
</span><span id="NiftiViewer.on_file_loaded-1247"><a href="#NiftiViewer.on_file_loaded-1247"><span class="linenos">1247</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_overlay_settings</span><span class="p">(</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1248"><a href="#NiftiViewer.on_file_loaded-1248"><span class="linenos">1248</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Update all displays&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1249"><a href="#NiftiViewer.on_file_loaded-1249"><span class="linenos">1249</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer.on_file_loaded-1250"><a href="#NiftiViewer.on_file_loaded-1250"><span class="linenos">1250</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Finished loading NIfTI image, updating checkbox&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1251"><a href="#NiftiViewer.on_file_loaded-1251"><span class="linenos">1251</span></a>
</span><span id="NiftiViewer.on_file_loaded-1252"><a href="#NiftiViewer.on_file_loaded-1252"><span class="linenos">1252</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1253"><a href="#NiftiViewer.on_file_loaded-1253"><span class="linenos">1253</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1254"><a href="#NiftiViewer.on_file_loaded-1254"><span class="linenos">1254</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating status bar&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1255"><a href="#NiftiViewer.on_file_loaded-1255"><span class="linenos">1255</span></a>            <span class="c1"># Update status bar message</span>
</span><span id="NiftiViewer.on_file_loaded-1256"><a href="#NiftiViewer.on_file_loaded-1256"><span class="linenos">1256</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
</span><span id="NiftiViewer.on_file_loaded-1257"><a href="#NiftiViewer.on_file_loaded-1257"><span class="linenos">1257</span></a>                <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlay loaded&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="NiftiViewer.on_file_loaded-1258"><a href="#NiftiViewer.on_file_loaded-1258"><span class="linenos">1258</span></a>            <span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1259"><a href="#NiftiViewer.on_file_loaded-1259"><span class="linenos">1259</span></a>
</span><span id="NiftiViewer.on_file_loaded-1260"><a href="#NiftiViewer.on_file_loaded-1260"><span class="linenos">1260</span></a>        <span class="c1"># ---------------------------------------------------</span>
</span><span id="NiftiViewer.on_file_loaded-1261"><a href="#NiftiViewer.on_file_loaded-1261"><span class="linenos">1261</span></a>        <span class="c1"># Handle base image loading</span>
</span><span id="NiftiViewer.on_file_loaded-1262"><a href="#NiftiViewer.on_file_loaded-1262"><span class="linenos">1262</span></a>        <span class="c1"># ---------------------------------------------------</span>
</span><span id="NiftiViewer.on_file_loaded-1263"><a href="#NiftiViewer.on_file_loaded-1263"><span class="linenos">1263</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.on_file_loaded-1264"><a href="#NiftiViewer.on_file_loaded-1264"><span class="linenos">1264</span></a>            <span class="c1"># Reset any existing overlay and ROI tools</span>
</span><span id="NiftiViewer.on_file_loaded-1265"><a href="#NiftiViewer.on_file_loaded-1265"><span class="linenos">1265</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reset_overlay</span><span class="p">()</span>
</span><span id="NiftiViewer.on_file_loaded-1266"><a href="#NiftiViewer.on_file_loaded-1266"><span class="linenos">1266</span></a>
</span><span id="NiftiViewer.on_file_loaded-1267"><a href="#NiftiViewer.on_file_loaded-1267"><span class="linenos">1267</span></a>            <span class="c1"># Store loaded base image attributes</span>
</span><span id="NiftiViewer.on_file_loaded-1268"><a href="#NiftiViewer.on_file_loaded-1268"><span class="linenos">1268</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span>
</span><span id="NiftiViewer.on_file_loaded-1269"><a href="#NiftiViewer.on_file_loaded-1269"><span class="linenos">1269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="n">dims</span>
</span><span id="NiftiViewer.on_file_loaded-1270"><a href="#NiftiViewer.on_file_loaded-1270"><span class="linenos">1270</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">affine</span> <span class="o">=</span> <span class="n">affine</span>
</span><span id="NiftiViewer.on_file_loaded-1271"><a href="#NiftiViewer.on_file_loaded-1271"><span class="linenos">1271</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="o">=</span> <span class="n">is_4d</span>
</span><span id="NiftiViewer.on_file_loaded-1272"><a href="#NiftiViewer.on_file_loaded-1272"><span class="linenos">1272</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">affine</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># Compute voxel size in mm</span>
</span><span id="NiftiViewer.on_file_loaded-1273"><a href="#NiftiViewer.on_file_loaded-1273"><span class="linenos">1273</span></a>
</span><span id="NiftiViewer.on_file_loaded-1274"><a href="#NiftiViewer.on_file_loaded-1274"><span class="linenos">1274</span></a>            <span class="c1"># Compose file information text</span>
</span><span id="NiftiViewer.on_file_loaded-1275"><a href="#NiftiViewer.on_file_loaded-1275"><span class="linenos">1275</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1276"><a href="#NiftiViewer.on_file_loaded-1276"><span class="linenos">1276</span></a>            <span class="k">if</span> <span class="n">is_4d</span><span class="p">:</span>
</span><span id="NiftiViewer.on_file_loaded-1277"><a href="#NiftiViewer.on_file_loaded-1277"><span class="linenos">1277</span></a>                <span class="c1"># 4D image information</span>
</span><span id="NiftiViewer.on_file_loaded-1278"><a href="#NiftiViewer.on_file_loaded-1278"><span class="linenos">1278</span></a>                <span class="n">info_text</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;File&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
</span><span id="NiftiViewer.on_file_loaded-1279"><a href="#NiftiViewer.on_file_loaded-1279"><span class="linenos">1279</span></a>                            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="NiftiViewer.on_file_loaded-1280"><a href="#NiftiViewer.on_file_loaded-1280"><span class="linenos">1280</span></a>                            <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
</span><span id="NiftiViewer.on_file_loaded-1281"><a href="#NiftiViewer.on_file_loaded-1281"><span class="linenos">1281</span></a>                            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;4D Time Series&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1282"><a href="#NiftiViewer.on_file_loaded-1282"><span class="linenos">1282</span></a>
</span><span id="NiftiViewer.on_file_loaded-1283"><a href="#NiftiViewer.on_file_loaded-1283"><span class="linenos">1283</span></a>                <span class="c1"># Enable time-series group and plot setup</span>
</span><span id="NiftiViewer.on_file_loaded-1284"><a href="#NiftiViewer.on_file_loaded-1284"><span class="linenos">1284</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1285"><a href="#NiftiViewer.on_file_loaded-1285"><span class="linenos">1285</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1286"><a href="#NiftiViewer.on_file_loaded-1286"><span class="linenos">1286</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1287"><a href="#NiftiViewer.on_file_loaded-1287"><span class="linenos">1287</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">setup_time_series_plot</span><span class="p">()</span>
</span><span id="NiftiViewer.on_file_loaded-1288"><a href="#NiftiViewer.on_file_loaded-1288"><span class="linenos">1288</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.on_file_loaded-1289"><a href="#NiftiViewer.on_file_loaded-1289"><span class="linenos">1289</span></a>                <span class="c1"># 3D volume information</span>
</span><span id="NiftiViewer.on_file_loaded-1290"><a href="#NiftiViewer.on_file_loaded-1290"><span class="linenos">1290</span></a>                <span class="n">info_text</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;File&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
</span><span id="NiftiViewer.on_file_loaded-1291"><a href="#NiftiViewer.on_file_loaded-1291"><span class="linenos">1291</span></a>                            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="NiftiViewer.on_file_loaded-1292"><a href="#NiftiViewer.on_file_loaded-1292"><span class="linenos">1292</span></a>                            <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"></span><span class="si">{</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
</span><span id="NiftiViewer.on_file_loaded-1293"><a href="#NiftiViewer.on_file_loaded-1293"><span class="linenos">1293</span></a>                            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;3D Volume&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1294"><a href="#NiftiViewer.on_file_loaded-1294"><span class="linenos">1294</span></a>
</span><span id="NiftiViewer.on_file_loaded-1295"><a href="#NiftiViewer.on_file_loaded-1295"><span class="linenos">1295</span></a>                <span class="c1"># Disable time controls for 3D data</span>
</span><span id="NiftiViewer.on_file_loaded-1296"><a href="#NiftiViewer.on_file_loaded-1296"><span class="linenos">1296</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1297"><a href="#NiftiViewer.on_file_loaded-1297"><span class="linenos">1297</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1298"><a href="#NiftiViewer.on_file_loaded-1298"><span class="linenos">1298</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1299"><a href="#NiftiViewer.on_file_loaded-1299"><span class="linenos">1299</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hide_time_series_plot</span><span class="p">()</span>
</span><span id="NiftiViewer.on_file_loaded-1300"><a href="#NiftiViewer.on_file_loaded-1300"><span class="linenos">1300</span></a>
</span><span id="NiftiViewer.on_file_loaded-1301"><a href="#NiftiViewer.on_file_loaded-1301"><span class="linenos">1301</span></a>            <span class="c1"># Update status bar layout and messages</span>
</span><span id="NiftiViewer.on_file_loaded-1302"><a href="#NiftiViewer.on_file_loaded-1302"><span class="linenos">1302</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">clearMessage</span><span class="p">()</span>
</span><span id="NiftiViewer.on_file_loaded-1303"><a href="#NiftiViewer.on_file_loaded-1303"><span class="linenos">1303</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1304"><a href="#NiftiViewer.on_file_loaded-1304"><span class="linenos">1304</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">addPermanentWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_info_label</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1305"><a href="#NiftiViewer.on_file_loaded-1305"><span class="linenos">1305</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">addPermanentWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value_label</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1306"><a href="#NiftiViewer.on_file_loaded-1306"><span class="linenos">1306</span></a>
</span><span id="NiftiViewer.on_file_loaded-1307"><a href="#NiftiViewer.on_file_loaded-1307"><span class="linenos">1307</span></a>            <span class="c1"># Enable ROI controls</span>
</span><span id="NiftiViewer.on_file_loaded-1308"><a href="#NiftiViewer.on_file_loaded-1308"><span class="linenos">1308</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1309"><a href="#NiftiViewer.on_file_loaded-1309"><span class="linenos">1309</span></a>
</span><span id="NiftiViewer.on_file_loaded-1310"><a href="#NiftiViewer.on_file_loaded-1310"><span class="linenos">1310</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic ROI&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.on_file_loaded-1311"><a href="#NiftiViewer.on_file_loaded-1311"><span class="linenos">1311</span></a>
</span><span id="NiftiViewer.on_file_loaded-1312"><a href="#NiftiViewer.on_file_loaded-1312"><span class="linenos">1312</span></a>            <span class="c1"># Update information panel</span>
</span><span id="NiftiViewer.on_file_loaded-1313"><a href="#NiftiViewer.on_file_loaded-1313"><span class="linenos">1313</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">info_text</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1314"><a href="#NiftiViewer.on_file_loaded-1314"><span class="linenos">1314</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">info_text</span><span class="p">)</span>
</span><span id="NiftiViewer.on_file_loaded-1315"><a href="#NiftiViewer.on_file_loaded-1315"><span class="linenos">1315</span></a>
</span><span id="NiftiViewer.on_file_loaded-1316"><a href="#NiftiViewer.on_file_loaded-1316"><span class="linenos">1316</span></a>            <span class="c1"># Initialize visual display of loaded data</span>
</span><span id="NiftiViewer.on_file_loaded-1317"><a href="#NiftiViewer.on_file_loaded-1317"><span class="linenos">1317</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_display</span><span class="p">()</span>
</span><span id="NiftiViewer.on_file_loaded-1318"><a href="#NiftiViewer.on_file_loaded-1318"><span class="linenos">1318</span></a>
</span><span id="NiftiViewer.on_file_loaded-1319"><a href="#NiftiViewer.on_file_loaded-1319"><span class="linenos">1319</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">resetROI</span><span class="p">()</span>
</span><span id="NiftiViewer.on_file_loaded-1320"><a href="#NiftiViewer.on_file_loaded-1320"><span class="linenos">1320</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reset_overlay</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Handle successful completion of a NIfTI file loading operation.</p>

<p>This method is called when the background loading thread finishes without errors.
It manages both base image and overlay image loading results.</p>

<p>Args:
    img_data (numpy.ndarray): Loaded image data array.
    dims (tuple): Dimensions of the loaded image (e.g., (X, Y, Z) or (X, Y, Z, T)).
    affine (numpy.ndarray): Affine transformation matrix defining voxel-to-world mapping.
    is_4d (bool): Whether the loaded image is a 4D time series.
    is_overlay (bool): Whether the loaded file is an overlay rather than a base image.</p>

<p>Returns:
    None</p>
</div>


                            </div>
                            <div id="NiftiViewer.on_load_error" class="classattr">
                                        <input id="NiftiViewer.on_load_error-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_load_error</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">error_message</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.on_load_error-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.on_load_error"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.on_load_error-1322"><a href="#NiftiViewer.on_load_error-1322"><span class="linenos">1322</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_load_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_message</span><span class="p">):</span>
</span><span id="NiftiViewer.on_load_error-1323"><a href="#NiftiViewer.on_load_error-1323"><span class="linenos">1323</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.on_load_error-1324"><a href="#NiftiViewer.on_load_error-1324"><span class="linenos">1324</span></a><span class="sd">        Handle errors during NIfTI file loading.</span>
</span><span id="NiftiViewer.on_load_error-1325"><a href="#NiftiViewer.on_load_error-1325"><span class="linenos">1325</span></a>
</span><span id="NiftiViewer.on_load_error-1326"><a href="#NiftiViewer.on_load_error-1326"><span class="linenos">1326</span></a><span class="sd">        Displays an error message, logs the issue, and cleans up any pending thread.</span>
</span><span id="NiftiViewer.on_load_error-1327"><a href="#NiftiViewer.on_load_error-1327"><span class="linenos">1327</span></a>
</span><span id="NiftiViewer.on_load_error-1328"><a href="#NiftiViewer.on_load_error-1328"><span class="linenos">1328</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.on_load_error-1329"><a href="#NiftiViewer.on_load_error-1329"><span class="linenos">1329</span></a><span class="sd">            error_message (str): Error message returned by the worker thread.</span>
</span><span id="NiftiViewer.on_load_error-1330"><a href="#NiftiViewer.on_load_error-1330"><span class="linenos">1330</span></a>
</span><span id="NiftiViewer.on_load_error-1331"><a href="#NiftiViewer.on_load_error-1331"><span class="linenos">1331</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer.on_load_error-1332"><a href="#NiftiViewer.on_load_error-1332"><span class="linenos">1332</span></a><span class="sd">            None</span>
</span><span id="NiftiViewer.on_load_error-1333"><a href="#NiftiViewer.on_load_error-1333"><span class="linenos">1333</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.on_load_error-1334"><a href="#NiftiViewer.on_load_error-1334"><span class="linenos">1334</span></a>        <span class="c1"># Disconnect cancel signal and close progress dialog</span>
</span><span id="NiftiViewer.on_load_error-1335"><a href="#NiftiViewer.on_load_error-1335"><span class="linenos">1335</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">canceled</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</span><span id="NiftiViewer.on_load_error-1336"><a href="#NiftiViewer.on_load_error-1336"><span class="linenos">1336</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="NiftiViewer.on_load_error-1337"><a href="#NiftiViewer.on_load_error-1337"><span class="linenos">1337</span></a>
</span><span id="NiftiViewer.on_load_error-1338"><a href="#NiftiViewer.on_load_error-1338"><span class="linenos">1338</span></a>        <span class="c1"># Display critical error dialog</span>
</span><span id="NiftiViewer.on_load_error-1339"><a href="#NiftiViewer.on_load_error-1339"><span class="linenos">1339</span></a>        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
</span><span id="NiftiViewer.on_load_error-1340"><a href="#NiftiViewer.on_load_error-1340"><span class="linenos">1340</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="NiftiViewer.on_load_error-1341"><a href="#NiftiViewer.on_load_error-1341"><span class="linenos">1341</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Error Loading File&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer.on_load_error-1342"><a href="#NiftiViewer.on_load_error-1342"><span class="linenos">1342</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Failed to load NIfTI file&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="se">\n</span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="NiftiViewer.on_load_error-1343"><a href="#NiftiViewer.on_load_error-1343"><span class="linenos">1343</span></a>        <span class="p">)</span>
</span><span id="NiftiViewer.on_load_error-1344"><a href="#NiftiViewer.on_load_error-1344"><span class="linenos">1344</span></a>
</span><span id="NiftiViewer.on_load_error-1345"><a href="#NiftiViewer.on_load_error-1345"><span class="linenos">1345</span></a>        <span class="c1"># Log the critical error message</span>
</span><span id="NiftiViewer.on_load_error-1346"><a href="#NiftiViewer.on_load_error-1346"><span class="linenos">1346</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading NIfTI file: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.on_load_error-1347"><a href="#NiftiViewer.on_load_error-1347"><span class="linenos">1347</span></a>
</span><span id="NiftiViewer.on_load_error-1348"><a href="#NiftiViewer.on_load_error-1348"><span class="linenos">1348</span></a>        <span class="c1"># Remove failed thread from thread list</span>
</span><span id="NiftiViewer.on_load_error-1349"><a href="#NiftiViewer.on_load_error-1349"><span class="linenos">1349</span></a>        <span class="n">thread_to_cancel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">()</span>
</span><span id="NiftiViewer.on_load_error-1350"><a href="#NiftiViewer.on_load_error-1350"><span class="linenos">1350</span></a>        <span class="k">if</span> <span class="n">thread_to_cancel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
</span><span id="NiftiViewer.on_load_error-1351"><a href="#NiftiViewer.on_load_error-1351"><span class="linenos">1351</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread_to_cancel</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Handle errors during NIfTI file loading.</p>

<p>Displays an error message, logs the issue, and cleans up any pending thread.</p>

<p>Args:
    error_message (str): Error message returned by the worker thread.</p>

<p>Returns:
    None</p>
</div>


                            </div>
                            <div id="NiftiViewer.on_load_canceled" class="classattr">
                                        <input id="NiftiViewer.on_load_canceled-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_load_canceled</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.on_load_canceled-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.on_load_canceled"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.on_load_canceled-1353"><a href="#NiftiViewer.on_load_canceled-1353"><span class="linenos">1353</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_load_canceled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.on_load_canceled-1354"><a href="#NiftiViewer.on_load_canceled-1354"><span class="linenos">1354</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.on_load_canceled-1355"><a href="#NiftiViewer.on_load_canceled-1355"><span class="linenos">1355</span></a><span class="sd">        Handle manual cancellation of the NIfTI file loading process.</span>
</span><span id="NiftiViewer.on_load_canceled-1356"><a href="#NiftiViewer.on_load_canceled-1356"><span class="linenos">1356</span></a>
</span><span id="NiftiViewer.on_load_canceled-1357"><a href="#NiftiViewer.on_load_canceled-1357"><span class="linenos">1357</span></a><span class="sd">        Terminates the most recent loading thread and removes it from</span>
</span><span id="NiftiViewer.on_load_canceled-1358"><a href="#NiftiViewer.on_load_canceled-1358"><span class="linenos">1358</span></a><span class="sd">        the active thread list to prevent resource leakage.</span>
</span><span id="NiftiViewer.on_load_canceled-1359"><a href="#NiftiViewer.on_load_canceled-1359"><span class="linenos">1359</span></a>
</span><span id="NiftiViewer.on_load_canceled-1360"><a href="#NiftiViewer.on_load_canceled-1360"><span class="linenos">1360</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer.on_load_canceled-1361"><a href="#NiftiViewer.on_load_canceled-1361"><span class="linenos">1361</span></a><span class="sd">            None</span>
</span><span id="NiftiViewer.on_load_canceled-1362"><a href="#NiftiViewer.on_load_canceled-1362"><span class="linenos">1362</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.on_load_canceled-1363"><a href="#NiftiViewer.on_load_canceled-1363"><span class="linenos">1363</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="NiftiViewer.on_load_canceled-1364"><a href="#NiftiViewer.on_load_canceled-1364"><span class="linenos">1364</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Handle manual cancellation of the NIfTI file loading process.</p>

<p>Terminates the most recent loading thread and removes it from
the active thread list to prevent resource leakage.</p>

<p>Returns:
    None</p>
</div>


                            </div>
                            <div id="NiftiViewer.initialize_display" class="classattr">
                                        <input id="NiftiViewer.initialize_display-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">initialize_display</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.initialize_display-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.initialize_display"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.initialize_display-1366"><a href="#NiftiViewer.initialize_display-1366"><span class="linenos">1366</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.initialize_display-1367"><a href="#NiftiViewer.initialize_display-1367"><span class="linenos">1367</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.initialize_display-1368"><a href="#NiftiViewer.initialize_display-1368"><span class="linenos">1368</span></a><span class="sd">        Initialize and configure the viewer display after a NIfTI file is loaded.</span>
</span><span id="NiftiViewer.initialize_display-1369"><a href="#NiftiViewer.initialize_display-1369"><span class="linenos">1369</span></a>
</span><span id="NiftiViewer.initialize_display-1370"><a href="#NiftiViewer.initialize_display-1370"><span class="linenos">1370</span></a><span class="sd">        Sets up slice navigation controls, initializes time-series sliders for 4D data,</span>
</span><span id="NiftiViewer.initialize_display-1371"><a href="#NiftiViewer.initialize_display-1371"><span class="linenos">1371</span></a><span class="sd">        updates current coordinates, and enables overlay controls.</span>
</span><span id="NiftiViewer.initialize_display-1372"><a href="#NiftiViewer.initialize_display-1372"><span class="linenos">1372</span></a>
</span><span id="NiftiViewer.initialize_display-1373"><a href="#NiftiViewer.initialize_display-1373"><span class="linenos">1373</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer.initialize_display-1374"><a href="#NiftiViewer.initialize_display-1374"><span class="linenos">1374</span></a><span class="sd">            None</span>
</span><span id="NiftiViewer.initialize_display-1375"><a href="#NiftiViewer.initialize_display-1375"><span class="linenos">1375</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.initialize_display-1376"><a href="#NiftiViewer.initialize_display-1376"><span class="linenos">1376</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.initialize_display-1377"><a href="#NiftiViewer.initialize_display-1377"><span class="linenos">1377</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer.initialize_display-1378"><a href="#NiftiViewer.initialize_display-1378"><span class="linenos">1378</span></a>
</span><span id="NiftiViewer.initialize_display-1379"><a href="#NiftiViewer.initialize_display-1379"><span class="linenos">1379</span></a>        <span class="c1"># Determine spatial dimension order (reverse for display consistency)</span>
</span><span id="NiftiViewer.initialize_display-1380"><a href="#NiftiViewer.initialize_display-1380"><span class="linenos">1380</span></a>        <span class="n">spatial_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="NiftiViewer.initialize_display-1381"><a href="#NiftiViewer.initialize_display-1381"><span class="linenos">1381</span></a>
</span><span id="NiftiViewer.initialize_display-1382"><a href="#NiftiViewer.initialize_display-1382"><span class="linenos">1382</span></a>        <span class="c1"># Configure slice sliders and spin boxes</span>
</span><span id="NiftiViewer.initialize_display-1383"><a href="#NiftiViewer.initialize_display-1383"><span class="linenos">1383</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="NiftiViewer.initialize_display-1384"><a href="#NiftiViewer.initialize_display-1384"><span class="linenos">1384</span></a>            <span class="n">max_slice</span> <span class="o">=</span> <span class="n">spatial_dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="NiftiViewer.initialize_display-1385"><a href="#NiftiViewer.initialize_display-1385"><span class="linenos">1385</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">max_slice</span><span class="p">)</span>
</span><span id="NiftiViewer.initialize_display-1386"><a href="#NiftiViewer.initialize_display-1386"><span class="linenos">1386</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">max_slice</span><span class="p">)</span>
</span><span id="NiftiViewer.initialize_display-1387"><a href="#NiftiViewer.initialize_display-1387"><span class="linenos">1387</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_slice</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># Start in the middle slice</span>
</span><span id="NiftiViewer.initialize_display-1388"><a href="#NiftiViewer.initialize_display-1388"><span class="linenos">1388</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="NiftiViewer.initialize_display-1389"><a href="#NiftiViewer.initialize_display-1389"><span class="linenos">1389</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="NiftiViewer.initialize_display-1390"><a href="#NiftiViewer.initialize_display-1390"><span class="linenos">1390</span></a>
</span><span id="NiftiViewer.initialize_display-1391"><a href="#NiftiViewer.initialize_display-1391"><span class="linenos">1391</span></a>        <span class="c1"># Configure time slider and spinbox for 4D datasets</span>
</span><span id="NiftiViewer.initialize_display-1392"><a href="#NiftiViewer.initialize_display-1392"><span class="linenos">1392</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="NiftiViewer.initialize_display-1393"><a href="#NiftiViewer.initialize_display-1393"><span class="linenos">1393</span></a>            <span class="n">max_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="NiftiViewer.initialize_display-1394"><a href="#NiftiViewer.initialize_display-1394"><span class="linenos">1394</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">max_time</span><span class="p">)</span>
</span><span id="NiftiViewer.initialize_display-1395"><a href="#NiftiViewer.initialize_display-1395"><span class="linenos">1395</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="n">max_time</span><span class="p">)</span>
</span><span id="NiftiViewer.initialize_display-1396"><a href="#NiftiViewer.initialize_display-1396"><span class="linenos">1396</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="NiftiViewer.initialize_display-1397"><a href="#NiftiViewer.initialize_display-1397"><span class="linenos">1397</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.initialize_display-1398"><a href="#NiftiViewer.initialize_display-1398"><span class="linenos">1398</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.initialize_display-1399"><a href="#NiftiViewer.initialize_display-1399"><span class="linenos">1399</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">toggle_time_controls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_checkbox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span>
</span><span id="NiftiViewer.initialize_display-1400"><a href="#NiftiViewer.initialize_display-1400"><span class="linenos">1400</span></a>
</span><span id="NiftiViewer.initialize_display-1401"><a href="#NiftiViewer.initialize_display-1401"><span class="linenos">1401</span></a>        <span class="c1"># Initialize coordinate tracking</span>
</span><span id="NiftiViewer.initialize_display-1402"><a href="#NiftiViewer.initialize_display-1402"><span class="linenos">1402</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="NiftiViewer.initialize_display-1403"><a href="#NiftiViewer.initialize_display-1403"><span class="linenos">1403</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>  <span class="c1"># X coordinate</span>
</span><span id="NiftiViewer.initialize_display-1404"><a href="#NiftiViewer.initialize_display-1404"><span class="linenos">1404</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># Y coordinate</span>
</span><span id="NiftiViewer.initialize_display-1405"><a href="#NiftiViewer.initialize_display-1405"><span class="linenos">1405</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Z coordinate</span>
</span><span id="NiftiViewer.initialize_display-1406"><a href="#NiftiViewer.initialize_display-1406"><span class="linenos">1406</span></a>        <span class="p">]</span>
</span><span id="NiftiViewer.initialize_display-1407"><a href="#NiftiViewer.initialize_display-1407"><span class="linenos">1407</span></a>
</span><span id="NiftiViewer.initialize_display-1408"><a href="#NiftiViewer.initialize_display-1408"><span class="linenos">1408</span></a>        <span class="c1"># Update all displays and coordinate readouts</span>
</span><span id="NiftiViewer.initialize_display-1409"><a href="#NiftiViewer.initialize_display-1409"><span class="linenos">1409</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer.initialize_display-1410"><a href="#NiftiViewer.initialize_display-1410"><span class="linenos">1410</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_coordinate_displays</span><span class="p">()</span>
</span><span id="NiftiViewer.initialize_display-1411"><a href="#NiftiViewer.initialize_display-1411"><span class="linenos">1411</span></a>
</span><span id="NiftiViewer.initialize_display-1412"><a href="#NiftiViewer.initialize_display-1412"><span class="linenos">1412</span></a>        <span class="c1"># Enable overlay loading button after successful image load</span>
</span><span id="NiftiViewer.initialize_display-1413"><a href="#NiftiViewer.initialize_display-1413"><span class="linenos">1413</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize and configure the viewer display after a NIfTI file is loaded.</p>

<p>Sets up slice navigation controls, initializes time-series sliders for 4D data,
updates current coordinates, and enables overlay controls.</p>

<p>Returns:
    None</p>
</div>


                            </div>
                            <div id="NiftiViewer.toggle_overlay" class="classattr">
                                        <input id="NiftiViewer.toggle_overlay-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">toggle_overlay</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">enabled</span>, </span><span class="param"><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.toggle_overlay-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.toggle_overlay"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.toggle_overlay-1415"><a href="#NiftiViewer.toggle_overlay-1415"><span class="linenos">1415</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_overlay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="NiftiViewer.toggle_overlay-1416"><a href="#NiftiViewer.toggle_overlay-1416"><span class="linenos">1416</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.toggle_overlay-1417"><a href="#NiftiViewer.toggle_overlay-1417"><span class="linenos">1417</span></a><span class="sd">        Enable or disable the overlay display on top of the base image.</span>
</span><span id="NiftiViewer.toggle_overlay-1418"><a href="#NiftiViewer.toggle_overlay-1418"><span class="linenos">1418</span></a>
</span><span id="NiftiViewer.toggle_overlay-1419"><a href="#NiftiViewer.toggle_overlay-1419"><span class="linenos">1419</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.toggle_overlay-1420"><a href="#NiftiViewer.toggle_overlay-1420"><span class="linenos">1420</span></a><span class="sd">            enabled (bool): Whether to enable (True) or disable (False) the overlay display.</span>
</span><span id="NiftiViewer.toggle_overlay-1421"><a href="#NiftiViewer.toggle_overlay-1421"><span class="linenos">1421</span></a>
</span><span id="NiftiViewer.toggle_overlay-1422"><a href="#NiftiViewer.toggle_overlay-1422"><span class="linenos">1422</span></a><span class="sd">        Behavior:</span>
</span><span id="NiftiViewer.toggle_overlay-1423"><a href="#NiftiViewer.toggle_overlay-1423"><span class="linenos">1423</span></a><span class="sd">            - Toggles transparency and threshold controls.</span>
</span><span id="NiftiViewer.toggle_overlay-1424"><a href="#NiftiViewer.toggle_overlay-1424"><span class="linenos">1424</span></a><span class="sd">            - Refreshes all active views if overlay data exists.</span>
</span><span id="NiftiViewer.toggle_overlay-1425"><a href="#NiftiViewer.toggle_overlay-1425"><span class="linenos">1425</span></a>
</span><span id="NiftiViewer.toggle_overlay-1426"><a href="#NiftiViewer.toggle_overlay-1426"><span class="linenos">1426</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer.toggle_overlay-1427"><a href="#NiftiViewer.toggle_overlay-1427"><span class="linenos">1427</span></a><span class="sd">            None</span>
</span><span id="NiftiViewer.toggle_overlay-1428"><a href="#NiftiViewer.toggle_overlay-1428"><span class="linenos">1428</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.toggle_overlay-1429"><a href="#NiftiViewer.toggle_overlay-1429"><span class="linenos">1429</span></a>        <span class="c1"># Update internal overlay state</span>
</span><span id="NiftiViewer.toggle_overlay-1430"><a href="#NiftiViewer.toggle_overlay-1430"><span class="linenos">1430</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="o">=</span> <span class="n">enabled</span>
</span><span id="NiftiViewer.toggle_overlay-1431"><a href="#NiftiViewer.toggle_overlay-1431"><span class="linenos">1431</span></a>
</span><span id="NiftiViewer.toggle_overlay-1432"><a href="#NiftiViewer.toggle_overlay-1432"><span class="linenos">1432</span></a>        <span class="c1"># Enable or disable overlay-related UI controls</span>
</span><span id="NiftiViewer.toggle_overlay-1433"><a href="#NiftiViewer.toggle_overlay-1433"><span class="linenos">1433</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_overlay-1434"><a href="#NiftiViewer.toggle_overlay-1434"><span class="linenos">1434</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_overlay-1435"><a href="#NiftiViewer.toggle_overlay-1435"><span class="linenos">1435</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_overlay-1436"><a href="#NiftiViewer.toggle_overlay-1436"><span class="linenos">1436</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_overlay-1437"><a href="#NiftiViewer.toggle_overlay-1437"><span class="linenos">1437</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_overlay-1438"><a href="#NiftiViewer.toggle_overlay-1438"><span class="linenos">1438</span></a>
</span><span id="NiftiViewer.toggle_overlay-1439"><a href="#NiftiViewer.toggle_overlay-1439"><span class="linenos">1439</span></a>
</span><span id="NiftiViewer.toggle_overlay-1440"><a href="#NiftiViewer.toggle_overlay-1440"><span class="linenos">1440</span></a>        <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="NiftiViewer.toggle_overlay-1441"><a href="#NiftiViewer.toggle_overlay-1441"><span class="linenos">1441</span></a>            <span class="c1"># Redraw display if overlay data is available</span>
</span><span id="NiftiViewer.toggle_overlay-1442"><a href="#NiftiViewer.toggle_overlay-1442"><span class="linenos">1442</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Update all display.&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_overlay-1443"><a href="#NiftiViewer.toggle_overlay-1443"><span class="linenos">1443</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer.toggle_overlay-1444"><a href="#NiftiViewer.toggle_overlay-1444"><span class="linenos">1444</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Update time series plot&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_overlay-1445"><a href="#NiftiViewer.toggle_overlay-1445"><span class="linenos">1445</span></a>            <span class="c1"># Update time series plot if available</span>
</span><span id="NiftiViewer.toggle_overlay-1446"><a href="#NiftiViewer.toggle_overlay-1446"><span class="linenos">1446</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_time_series_plot</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Enable or disable the overlay display on top of the base image.</p>

<p>Args:
    enabled (bool): Whether to enable (True) or disable (False) the overlay display.</p>

<p>Behavior:
    - Toggles transparency and threshold controls.
    - Refreshes all active views if overlay data exists.</p>

<p>Returns:
    None</p>
</div>


                            </div>
                            <div id="NiftiViewer.update_overlay_alpha" class="classattr">
                                        <input id="NiftiViewer.update_overlay_alpha-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_overlay_alpha</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">value</span>, </span><span class="param"><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.update_overlay_alpha-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.update_overlay_alpha"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.update_overlay_alpha-1448"><a href="#NiftiViewer.update_overlay_alpha-1448"><span class="linenos">1448</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_overlay_alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="NiftiViewer.update_overlay_alpha-1449"><a href="#NiftiViewer.update_overlay_alpha-1449"><span class="linenos">1449</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.update_overlay_alpha-1450"><a href="#NiftiViewer.update_overlay_alpha-1450"><span class="linenos">1450</span></a><span class="sd">        Update overlay transparency (alpha blending).</span>
</span><span id="NiftiViewer.update_overlay_alpha-1451"><a href="#NiftiViewer.update_overlay_alpha-1451"><span class="linenos">1451</span></a>
</span><span id="NiftiViewer.update_overlay_alpha-1452"><a href="#NiftiViewer.update_overlay_alpha-1452"><span class="linenos">1452</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.update_overlay_alpha-1453"><a href="#NiftiViewer.update_overlay_alpha-1453"><span class="linenos">1453</span></a><span class="sd">            value (int): Slider value representing overlay opacity (0100).</span>
</span><span id="NiftiViewer.update_overlay_alpha-1454"><a href="#NiftiViewer.update_overlay_alpha-1454"><span class="linenos">1454</span></a>
</span><span id="NiftiViewer.update_overlay_alpha-1455"><a href="#NiftiViewer.update_overlay_alpha-1455"><span class="linenos">1455</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer.update_overlay_alpha-1456"><a href="#NiftiViewer.update_overlay_alpha-1456"><span class="linenos">1456</span></a><span class="sd">            Converts the integer slider value to a float ratio (0.01.0) and</span>
</span><span id="NiftiViewer.update_overlay_alpha-1457"><a href="#NiftiViewer.update_overlay_alpha-1457"><span class="linenos">1457</span></a><span class="sd">            refreshes the display only if the overlay is active and data is loaded.</span>
</span><span id="NiftiViewer.update_overlay_alpha-1458"><a href="#NiftiViewer.update_overlay_alpha-1458"><span class="linenos">1458</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.update_overlay_alpha-1459"><a href="#NiftiViewer.update_overlay_alpha-1459"><span class="linenos">1459</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="NiftiViewer.update_overlay_alpha-1460"><a href="#NiftiViewer.update_overlay_alpha-1460"><span class="linenos">1460</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="NiftiViewer.update_overlay_alpha-1461"><a href="#NiftiViewer.update_overlay_alpha-1461"><span class="linenos">1461</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Update overlay transparency (alpha blending).</p>

<p>Args:
    value (int): Slider value representing overlay opacity (0100).</p>

<p>Notes:
    Converts the integer slider value to a float ratio (0.01.0) and
    refreshes the display only if the overlay is active and data is loaded.</p>
</div>


                            </div>
                            <div id="NiftiViewer.update_overlay_threshold" class="classattr">
                                        <input id="NiftiViewer.update_overlay_threshold-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_overlay_threshold</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">value</span>, </span><span class="param"><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.update_overlay_threshold-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.update_overlay_threshold"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.update_overlay_threshold-1463"><a href="#NiftiViewer.update_overlay_threshold-1463"><span class="linenos">1463</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_overlay_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="NiftiViewer.update_overlay_threshold-1464"><a href="#NiftiViewer.update_overlay_threshold-1464"><span class="linenos">1464</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.update_overlay_threshold-1465"><a href="#NiftiViewer.update_overlay_threshold-1465"><span class="linenos">1465</span></a><span class="sd">        Update overlay intensity threshold.</span>
</span><span id="NiftiViewer.update_overlay_threshold-1466"><a href="#NiftiViewer.update_overlay_threshold-1466"><span class="linenos">1466</span></a>
</span><span id="NiftiViewer.update_overlay_threshold-1467"><a href="#NiftiViewer.update_overlay_threshold-1467"><span class="linenos">1467</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.update_overlay_threshold-1468"><a href="#NiftiViewer.update_overlay_threshold-1468"><span class="linenos">1468</span></a><span class="sd">            value (int): Slider value representing overlay threshold (0100).</span>
</span><span id="NiftiViewer.update_overlay_threshold-1469"><a href="#NiftiViewer.update_overlay_threshold-1469"><span class="linenos">1469</span></a>
</span><span id="NiftiViewer.update_overlay_threshold-1470"><a href="#NiftiViewer.update_overlay_threshold-1470"><span class="linenos">1470</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer.update_overlay_threshold-1471"><a href="#NiftiViewer.update_overlay_threshold-1471"><span class="linenos">1471</span></a><span class="sd">            Adjusts visibility cutoff for overlay voxels and refreshes display</span>
</span><span id="NiftiViewer.update_overlay_threshold-1472"><a href="#NiftiViewer.update_overlay_threshold-1472"><span class="linenos">1472</span></a><span class="sd">            when overlay is active and data is present.</span>
</span><span id="NiftiViewer.update_overlay_threshold-1473"><a href="#NiftiViewer.update_overlay_threshold-1473"><span class="linenos">1473</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.update_overlay_threshold-1474"><a href="#NiftiViewer.update_overlay_threshold-1474"><span class="linenos">1474</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="NiftiViewer.update_overlay_threshold-1475"><a href="#NiftiViewer.update_overlay_threshold-1475"><span class="linenos">1475</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.update_overlay_threshold-1476"><a href="#NiftiViewer.update_overlay_threshold-1476"><span class="linenos">1476</span></a>            <span class="c1"># Determine overlay threshold</span>
</span><span id="NiftiViewer.update_overlay_threshold-1477"><a href="#NiftiViewer.update_overlay_threshold-1477"><span class="linenos">1477</span></a>            <span class="n">threshold_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_max</span>
</span><span id="NiftiViewer.update_overlay_threshold-1478"><a href="#NiftiViewer.update_overlay_threshold-1478"><span class="linenos">1478</span></a>            <span class="c1"># Create boolean mask of overlay pixels above threshold</span>
</span><span id="NiftiViewer.update_overlay_threshold-1479"><a href="#NiftiViewer.update_overlay_threshold-1479"><span class="linenos">1479</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">&gt;</span> <span class="n">threshold_value</span>
</span><span id="NiftiViewer.update_overlay_threshold-1480"><a href="#NiftiViewer.update_overlay_threshold-1480"><span class="linenos">1480</span></a>            <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="NiftiViewer.update_overlay_threshold-1481"><a href="#NiftiViewer.update_overlay_threshold-1481"><span class="linenos">1481</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Update overlay intensity threshold.</p>

<p>Args:
    value (int): Slider value representing overlay threshold (0100).</p>

<p>Notes:
    Adjusts visibility cutoff for overlay voxels and refreshes display
    when overlay is active and data is present.</p>
</div>


                            </div>
                            <div id="NiftiViewer.update_overlay_settings" class="classattr">
                                        <input id="NiftiViewer.update_overlay_settings-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_overlay_settings</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.update_overlay_settings-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.update_overlay_settings"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.update_overlay_settings-1483"><a href="#NiftiViewer.update_overlay_settings-1483"><span class="linenos">1483</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_overlay_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="NiftiViewer.update_overlay_settings-1484"><a href="#NiftiViewer.update_overlay_settings-1484"><span class="linenos">1484</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.update_overlay_settings-1485"><a href="#NiftiViewer.update_overlay_settings-1485"><span class="linenos">1485</span></a><span class="sd">        Synchronize overlay alpha and threshold values from the UI controls.</span>
</span><span id="NiftiViewer.update_overlay_settings-1486"><a href="#NiftiViewer.update_overlay_settings-1486"><span class="linenos">1486</span></a>
</span><span id="NiftiViewer.update_overlay_settings-1487"><a href="#NiftiViewer.update_overlay_settings-1487"><span class="linenos">1487</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer.update_overlay_settings-1488"><a href="#NiftiViewer.update_overlay_settings-1488"><span class="linenos">1488</span></a><span class="sd">            Reads the slider positions for alpha and threshold,</span>
</span><span id="NiftiViewer.update_overlay_settings-1489"><a href="#NiftiViewer.update_overlay_settings-1489"><span class="linenos">1489</span></a><span class="sd">            updates their internal numeric equivalents, and refreshes</span>
</span><span id="NiftiViewer.update_overlay_settings-1490"><a href="#NiftiViewer.update_overlay_settings-1490"><span class="linenos">1490</span></a><span class="sd">            the image view if the overlay is active.</span>
</span><span id="NiftiViewer.update_overlay_settings-1491"><a href="#NiftiViewer.update_overlay_settings-1491"><span class="linenos">1491</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.update_overlay_settings-1492"><a href="#NiftiViewer.update_overlay_settings-1492"><span class="linenos">1492</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;overlay_alpha_slider&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;overlay_threshold_slider&#39;</span><span class="p">):</span>
</span><span id="NiftiViewer.update_overlay_settings-1493"><a href="#NiftiViewer.update_overlay_settings-1493"><span class="linenos">1493</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="NiftiViewer.update_overlay_settings-1494"><a href="#NiftiViewer.update_overlay_settings-1494"><span class="linenos">1494</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="NiftiViewer.update_overlay_settings-1495"><a href="#NiftiViewer.update_overlay_settings-1495"><span class="linenos">1495</span></a>
</span><span id="NiftiViewer.update_overlay_settings-1496"><a href="#NiftiViewer.update_overlay_settings-1496"><span class="linenos">1496</span></a>            <span class="c1"># Update visualization only if overlay is active and available</span>
</span><span id="NiftiViewer.update_overlay_settings-1497"><a href="#NiftiViewer.update_overlay_settings-1497"><span class="linenos">1497</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;overlay_data&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="NiftiViewer.update_overlay_settings-1498"><a href="#NiftiViewer.update_overlay_settings-1498"><span class="linenos">1498</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Synchronize overlay alpha and threshold values from the UI controls.</p>

<p>Notes:
    Reads the slider positions for alpha and threshold,
    updates their internal numeric equivalents, and refreshes
    the image view if the overlay is active.</p>
</div>


                            </div>
                            <div id="NiftiViewer.slice_changed" class="classattr">
                                        <input id="NiftiViewer.slice_changed-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">slice_changed</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">plane_idx</span>, </span><span class="param"><span class="n">value</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.slice_changed-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.slice_changed"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.slice_changed-1500"><a href="#NiftiViewer.slice_changed-1500"><span class="linenos">1500</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">slice_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="NiftiViewer.slice_changed-1501"><a href="#NiftiViewer.slice_changed-1501"><span class="linenos">1501</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.slice_changed-1502"><a href="#NiftiViewer.slice_changed-1502"><span class="linenos">1502</span></a><span class="sd">        Handle slice navigation events from sliders or spinboxes.</span>
</span><span id="NiftiViewer.slice_changed-1503"><a href="#NiftiViewer.slice_changed-1503"><span class="linenos">1503</span></a>
</span><span id="NiftiViewer.slice_changed-1504"><a href="#NiftiViewer.slice_changed-1504"><span class="linenos">1504</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.slice_changed-1505"><a href="#NiftiViewer.slice_changed-1505"><span class="linenos">1505</span></a><span class="sd">            plane_idx (int): Index of the anatomical plane (0=axial, 1=coronal, 2=sagittal).</span>
</span><span id="NiftiViewer.slice_changed-1506"><a href="#NiftiViewer.slice_changed-1506"><span class="linenos">1506</span></a><span class="sd">            value (int): New slice index within the volume.</span>
</span><span id="NiftiViewer.slice_changed-1507"><a href="#NiftiViewer.slice_changed-1507"><span class="linenos">1507</span></a>
</span><span id="NiftiViewer.slice_changed-1508"><a href="#NiftiViewer.slice_changed-1508"><span class="linenos">1508</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer.slice_changed-1509"><a href="#NiftiViewer.slice_changed-1509"><span class="linenos">1509</span></a><span class="sd">            Updates the current slice, synchronizes the corresponding slider and spinbox,</span>
</span><span id="NiftiViewer.slice_changed-1510"><a href="#NiftiViewer.slice_changed-1510"><span class="linenos">1510</span></a><span class="sd">            recalculates coordinates, and refreshes the associated 2D view.</span>
</span><span id="NiftiViewer.slice_changed-1511"><a href="#NiftiViewer.slice_changed-1511"><span class="linenos">1511</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.slice_changed-1512"><a href="#NiftiViewer.slice_changed-1512"><span class="linenos">1512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="NiftiViewer.slice_changed-1513"><a href="#NiftiViewer.slice_changed-1513"><span class="linenos">1513</span></a>
</span><span id="NiftiViewer.slice_changed-1514"><a href="#NiftiViewer.slice_changed-1514"><span class="linenos">1514</span></a>        <span class="c1"># Keep slider and spinbox synchronized</span>
</span><span id="NiftiViewer.slice_changed-1515"><a href="#NiftiViewer.slice_changed-1515"><span class="linenos">1515</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer.slice_changed-1516"><a href="#NiftiViewer.slice_changed-1516"><span class="linenos">1516</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer.slice_changed-1517"><a href="#NiftiViewer.slice_changed-1517"><span class="linenos">1517</span></a>
</span><span id="NiftiViewer.slice_changed-1518"><a href="#NiftiViewer.slice_changed-1518"><span class="linenos">1518</span></a>        <span class="c1"># Update coordinate system based on selected plane</span>
</span><span id="NiftiViewer.slice_changed-1519"><a href="#NiftiViewer.slice_changed-1519"><span class="linenos">1519</span></a>        <span class="k">if</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Axial</span>
</span><span id="NiftiViewer.slice_changed-1520"><a href="#NiftiViewer.slice_changed-1520"><span class="linenos">1520</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="NiftiViewer.slice_changed-1521"><a href="#NiftiViewer.slice_changed-1521"><span class="linenos">1521</span></a>        <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Coronal</span>
</span><span id="NiftiViewer.slice_changed-1522"><a href="#NiftiViewer.slice_changed-1522"><span class="linenos">1522</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="NiftiViewer.slice_changed-1523"><a href="#NiftiViewer.slice_changed-1523"><span class="linenos">1523</span></a>        <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sagittal</span>
</span><span id="NiftiViewer.slice_changed-1524"><a href="#NiftiViewer.slice_changed-1524"><span class="linenos">1524</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="NiftiViewer.slice_changed-1525"><a href="#NiftiViewer.slice_changed-1525"><span class="linenos">1525</span></a>
</span><span id="NiftiViewer.slice_changed-1526"><a href="#NiftiViewer.slice_changed-1526"><span class="linenos">1526</span></a>        <span class="c1"># Refresh the corresponding view and UI indicators</span>
</span><span id="NiftiViewer.slice_changed-1527"><a href="#NiftiViewer.slice_changed-1527"><span class="linenos">1527</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_display</span><span class="p">(</span><span class="n">plane_idx</span><span class="p">)</span>
</span><span id="NiftiViewer.slice_changed-1528"><a href="#NiftiViewer.slice_changed-1528"><span class="linenos">1528</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_coordinate_displays</span><span class="p">()</span>
</span><span id="NiftiViewer.slice_changed-1529"><a href="#NiftiViewer.slice_changed-1529"><span class="linenos">1529</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_cross_view_lines</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Handle slice navigation events from sliders or spinboxes.</p>

<p>Args:
    plane_idx (int): Index of the anatomical plane (0=axial, 1=coronal, 2=sagittal).
    value (int): New slice index within the volume.</p>

<p>Notes:
    Updates the current slice, synchronizes the corresponding slider and spinbox,
    recalculates coordinates, and refreshes the associated 2D view.</p>
</div>


                            </div>
                            <div id="NiftiViewer.time_changed" class="classattr">
                                        <input id="NiftiViewer.time_changed-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">time_changed</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">value</span>, </span><span class="param"><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.time_changed-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.time_changed"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.time_changed-1531"><a href="#NiftiViewer.time_changed-1531"><span class="linenos">1531</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">time_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="NiftiViewer.time_changed-1532"><a href="#NiftiViewer.time_changed-1532"><span class="linenos">1532</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.time_changed-1533"><a href="#NiftiViewer.time_changed-1533"><span class="linenos">1533</span></a><span class="sd">        Handle time slider or spinbox change for 4D data.</span>
</span><span id="NiftiViewer.time_changed-1534"><a href="#NiftiViewer.time_changed-1534"><span class="linenos">1534</span></a>
</span><span id="NiftiViewer.time_changed-1535"><a href="#NiftiViewer.time_changed-1535"><span class="linenos">1535</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.time_changed-1536"><a href="#NiftiViewer.time_changed-1536"><span class="linenos">1536</span></a><span class="sd">            value (int): New time index.</span>
</span><span id="NiftiViewer.time_changed-1537"><a href="#NiftiViewer.time_changed-1537"><span class="linenos">1537</span></a>
</span><span id="NiftiViewer.time_changed-1538"><a href="#NiftiViewer.time_changed-1538"><span class="linenos">1538</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer.time_changed-1539"><a href="#NiftiViewer.time_changed-1539"><span class="linenos">1539</span></a><span class="sd">            Updates the current time frame and refreshes all views.</span>
</span><span id="NiftiViewer.time_changed-1540"><a href="#NiftiViewer.time_changed-1540"><span class="linenos">1540</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.time_changed-1541"><a href="#NiftiViewer.time_changed-1541"><span class="linenos">1541</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="NiftiViewer.time_changed-1542"><a href="#NiftiViewer.time_changed-1542"><span class="linenos">1542</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer.time_changed-1543"><a href="#NiftiViewer.time_changed-1543"><span class="linenos">1543</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer.time_changed-1544"><a href="#NiftiViewer.time_changed-1544"><span class="linenos">1544</span></a>        <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="NiftiViewer.time_changed-1545"><a href="#NiftiViewer.time_changed-1545"><span class="linenos">1545</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Handle time slider or spinbox change for 4D data.</p>

<p>Args:
    value (int): New time index.</p>

<p>Notes:
    Updates the current time frame and refreshes all views.</p>
</div>


                            </div>
                            <div id="NiftiViewer.toggle_time_controls" class="classattr">
                                        <input id="NiftiViewer.toggle_time_controls-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">toggle_time_controls</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">enabled</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.toggle_time_controls-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.toggle_time_controls"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.toggle_time_controls-1547"><a href="#NiftiViewer.toggle_time_controls-1547"><span class="linenos">1547</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_time_controls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">):</span>
</span><span id="NiftiViewer.toggle_time_controls-1548"><a href="#NiftiViewer.toggle_time_controls-1548"><span class="linenos">1548</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.toggle_time_controls-1549"><a href="#NiftiViewer.toggle_time_controls-1549"><span class="linenos">1549</span></a><span class="sd">        Enable or disable time navigation controls based on data dimensionality.</span>
</span><span id="NiftiViewer.toggle_time_controls-1550"><a href="#NiftiViewer.toggle_time_controls-1550"><span class="linenos">1550</span></a>
</span><span id="NiftiViewer.toggle_time_controls-1551"><a href="#NiftiViewer.toggle_time_controls-1551"><span class="linenos">1551</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.toggle_time_controls-1552"><a href="#NiftiViewer.toggle_time_controls-1552"><span class="linenos">1552</span></a><span class="sd">            enabled (bool): Whether to show and enable time controls.</span>
</span><span id="NiftiViewer.toggle_time_controls-1553"><a href="#NiftiViewer.toggle_time_controls-1553"><span class="linenos">1553</span></a>
</span><span id="NiftiViewer.toggle_time_controls-1554"><a href="#NiftiViewer.toggle_time_controls-1554"><span class="linenos">1554</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer.toggle_time_controls-1555"><a href="#NiftiViewer.toggle_time_controls-1555"><span class="linenos">1555</span></a><span class="sd">            Time controls are visible only when both 4D data is loaded and</span>
</span><span id="NiftiViewer.toggle_time_controls-1556"><a href="#NiftiViewer.toggle_time_controls-1556"><span class="linenos">1556</span></a><span class="sd">            the toggle checkbox is active.</span>
</span><span id="NiftiViewer.toggle_time_controls-1557"><a href="#NiftiViewer.toggle_time_controls-1557"><span class="linenos">1557</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.toggle_time_controls-1558"><a href="#NiftiViewer.toggle_time_controls-1558"><span class="linenos">1558</span></a>        <span class="n">value</span> <span class="o">=</span> <span class="n">enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span>
</span><span id="NiftiViewer.toggle_time_controls-1559"><a href="#NiftiViewer.toggle_time_controls-1559"><span class="linenos">1559</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_time_controls-1560"><a href="#NiftiViewer.toggle_time_controls-1560"><span class="linenos">1560</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_time_controls-1561"><a href="#NiftiViewer.toggle_time_controls-1561"><span class="linenos">1561</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_time_controls-1562"><a href="#NiftiViewer.toggle_time_controls-1562"><span class="linenos">1562</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_time_controls-1563"><a href="#NiftiViewer.toggle_time_controls-1563"><span class="linenos">1563</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_point_label</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Enable or disable time navigation controls based on data dimensionality.</p>

<p>Args:
    enabled (bool): Whether to show and enable time controls.</p>

<p>Notes:
    Time controls are visible only when both 4D data is loaded and
    the toggle checkbox is active.</p>
</div>


                            </div>
                            <div id="NiftiViewer.colormap_changed" class="classattr">
                                        <input id="NiftiViewer.colormap_changed-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">colormap_changed</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">colormap_name</span>, </span><span class="param"><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.colormap_changed-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.colormap_changed"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.colormap_changed-1565"><a href="#NiftiViewer.colormap_changed-1565"><span class="linenos">1565</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">colormap_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colormap_name</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="NiftiViewer.colormap_changed-1566"><a href="#NiftiViewer.colormap_changed-1566"><span class="linenos">1566</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.colormap_changed-1567"><a href="#NiftiViewer.colormap_changed-1567"><span class="linenos">1567</span></a><span class="sd">        Handle colormap selection change from the dropdown.</span>
</span><span id="NiftiViewer.colormap_changed-1568"><a href="#NiftiViewer.colormap_changed-1568"><span class="linenos">1568</span></a>
</span><span id="NiftiViewer.colormap_changed-1569"><a href="#NiftiViewer.colormap_changed-1569"><span class="linenos">1569</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.colormap_changed-1570"><a href="#NiftiViewer.colormap_changed-1570"><span class="linenos">1570</span></a><span class="sd">            colormap_name (str): Name of the selected colormap.</span>
</span><span id="NiftiViewer.colormap_changed-1571"><a href="#NiftiViewer.colormap_changed-1571"><span class="linenos">1571</span></a>
</span><span id="NiftiViewer.colormap_changed-1572"><a href="#NiftiViewer.colormap_changed-1572"><span class="linenos">1572</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer.colormap_changed-1573"><a href="#NiftiViewer.colormap_changed-1573"><span class="linenos">1573</span></a><span class="sd">            Updates the active colormap for display and refreshes all views.</span>
</span><span id="NiftiViewer.colormap_changed-1574"><a href="#NiftiViewer.colormap_changed-1574"><span class="linenos">1574</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.colormap_changed-1575"><a href="#NiftiViewer.colormap_changed-1575"><span class="linenos">1575</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span> <span class="o">=</span> <span class="n">colormap_name</span>
</span><span id="NiftiViewer.colormap_changed-1576"><a href="#NiftiViewer.colormap_changed-1576"><span class="linenos">1576</span></a>        <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="NiftiViewer.colormap_changed-1577"><a href="#NiftiViewer.colormap_changed-1577"><span class="linenos">1577</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Handle colormap selection change from the dropdown.</p>

<p>Args:
    colormap_name (str): Name of the selected colormap.</p>

<p>Notes:
    Updates the active colormap for display and refreshes all views.</p>
</div>


                            </div>
                            <div id="NiftiViewer.handle_click_coordinates" class="classattr">
                                        <input id="NiftiViewer.handle_click_coordinates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">handle_click_coordinates</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">view_idx</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">y</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.handle_click_coordinates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.handle_click_coordinates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.handle_click_coordinates-1579"><a href="#NiftiViewer.handle_click_coordinates-1579"><span class="linenos">1579</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_click_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="NiftiViewer.handle_click_coordinates-1580"><a href="#NiftiViewer.handle_click_coordinates-1580"><span class="linenos">1580</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.handle_click_coordinates-1581"><a href="#NiftiViewer.handle_click_coordinates-1581"><span class="linenos">1581</span></a><span class="sd">        Handle user mouse clicks within a 2D slice view.</span>
</span><span id="NiftiViewer.handle_click_coordinates-1582"><a href="#NiftiViewer.handle_click_coordinates-1582"><span class="linenos">1582</span></a>
</span><span id="NiftiViewer.handle_click_coordinates-1583"><a href="#NiftiViewer.handle_click_coordinates-1583"><span class="linenos">1583</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.handle_click_coordinates-1584"><a href="#NiftiViewer.handle_click_coordinates-1584"><span class="linenos">1584</span></a><span class="sd">            view_idx (int): Index of the view where the click occurred (0=axial, 1=coronal, 2=sagittal).</span>
</span><span id="NiftiViewer.handle_click_coordinates-1585"><a href="#NiftiViewer.handle_click_coordinates-1585"><span class="linenos">1585</span></a><span class="sd">            x (float): X coordinate in screen space.</span>
</span><span id="NiftiViewer.handle_click_coordinates-1586"><a href="#NiftiViewer.handle_click_coordinates-1586"><span class="linenos">1586</span></a><span class="sd">            y (float): Y coordinate in screen space.</span>
</span><span id="NiftiViewer.handle_click_coordinates-1587"><a href="#NiftiViewer.handle_click_coordinates-1587"><span class="linenos">1587</span></a>
</span><span id="NiftiViewer.handle_click_coordinates-1588"><a href="#NiftiViewer.handle_click_coordinates-1588"><span class="linenos">1588</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer.handle_click_coordinates-1589"><a href="#NiftiViewer.handle_click_coordinates-1589"><span class="linenos">1589</span></a><span class="sd">            Converts screen coordinates to image voxel coordinates,</span>
</span><span id="NiftiViewer.handle_click_coordinates-1590"><a href="#NiftiViewer.handle_click_coordinates-1590"><span class="linenos">1590</span></a><span class="sd">            updates slice positions accordingly, and synchronizes all views.</span>
</span><span id="NiftiViewer.handle_click_coordinates-1591"><a href="#NiftiViewer.handle_click_coordinates-1591"><span class="linenos">1591</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.handle_click_coordinates-1592"><a href="#NiftiViewer.handle_click_coordinates-1592"><span class="linenos">1592</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.handle_click_coordinates-1593"><a href="#NiftiViewer.handle_click_coordinates-1593"><span class="linenos">1593</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer.handle_click_coordinates-1594"><a href="#NiftiViewer.handle_click_coordinates-1594"><span class="linenos">1594</span></a>
</span><span id="NiftiViewer.handle_click_coordinates-1595"><a href="#NiftiViewer.handle_click_coordinates-1595"><span class="linenos">1595</span></a>        <span class="c1"># Convert click from display to image coordinate space</span>
</span><span id="NiftiViewer.handle_click_coordinates-1596"><a href="#NiftiViewer.handle_click_coordinates-1596"><span class="linenos">1596</span></a>        <span class="n">img_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen_to_image_coords</span><span class="p">(</span><span class="n">view_idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="NiftiViewer.handle_click_coordinates-1597"><a href="#NiftiViewer.handle_click_coordinates-1597"><span class="linenos">1597</span></a>        <span class="k">if</span> <span class="n">img_coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.handle_click_coordinates-1598"><a href="#NiftiViewer.handle_click_coordinates-1598"><span class="linenos">1598</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer.handle_click_coordinates-1599"><a href="#NiftiViewer.handle_click_coordinates-1599"><span class="linenos">1599</span></a>
</span><span id="NiftiViewer.handle_click_coordinates-1600"><a href="#NiftiViewer.handle_click_coordinates-1600"><span class="linenos">1600</span></a>        <span class="c1"># Update global coordinates</span>
</span><span id="NiftiViewer.handle_click_coordinates-1601"><a href="#NiftiViewer.handle_click_coordinates-1601"><span class="linenos">1601</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span> <span class="o">=</span> <span class="n">img_coords</span>
</span><span id="NiftiViewer.handle_click_coordinates-1602"><a href="#NiftiViewer.handle_click_coordinates-1602"><span class="linenos">1602</span></a>
</span><span id="NiftiViewer.handle_click_coordinates-1603"><a href="#NiftiViewer.handle_click_coordinates-1603"><span class="linenos">1603</span></a>        <span class="c1"># Update slice positions based on clicked voxel</span>
</span><span id="NiftiViewer.handle_click_coordinates-1604"><a href="#NiftiViewer.handle_click_coordinates-1604"><span class="linenos">1604</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Axial (Z)</span>
</span><span id="NiftiViewer.handle_click_coordinates-1605"><a href="#NiftiViewer.handle_click_coordinates-1605"><span class="linenos">1605</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Coronal (Y)</span>
</span><span id="NiftiViewer.handle_click_coordinates-1606"><a href="#NiftiViewer.handle_click_coordinates-1606"><span class="linenos">1606</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Sagittal (X)</span>
</span><span id="NiftiViewer.handle_click_coordinates-1607"><a href="#NiftiViewer.handle_click_coordinates-1607"><span class="linenos">1607</span></a>
</span><span id="NiftiViewer.handle_click_coordinates-1608"><a href="#NiftiViewer.handle_click_coordinates-1608"><span class="linenos">1608</span></a>        <span class="c1"># Synchronize controls for all planes</span>
</span><span id="NiftiViewer.handle_click_coordinates-1609"><a href="#NiftiViewer.handle_click_coordinates-1609"><span class="linenos">1609</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="NiftiViewer.handle_click_coordinates-1610"><a href="#NiftiViewer.handle_click_coordinates-1610"><span class="linenos">1610</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="NiftiViewer.handle_click_coordinates-1611"><a href="#NiftiViewer.handle_click_coordinates-1611"><span class="linenos">1611</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="NiftiViewer.handle_click_coordinates-1612"><a href="#NiftiViewer.handle_click_coordinates-1612"><span class="linenos">1612</span></a>
</span><span id="NiftiViewer.handle_click_coordinates-1613"><a href="#NiftiViewer.handle_click_coordinates-1613"><span class="linenos">1613</span></a>        <span class="c1"># Refresh display and coordinate info</span>
</span><span id="NiftiViewer.handle_click_coordinates-1614"><a href="#NiftiViewer.handle_click_coordinates-1614"><span class="linenos">1614</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer.handle_click_coordinates-1615"><a href="#NiftiViewer.handle_click_coordinates-1615"><span class="linenos">1615</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_coordinate_displays</span><span class="p">()</span>
</span><span id="NiftiViewer.handle_click_coordinates-1616"><a href="#NiftiViewer.handle_click_coordinates-1616"><span class="linenos">1616</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_cross_view_lines</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Handle user mouse clicks within a 2D slice view.</p>

<p>Args:
    view_idx (int): Index of the view where the click occurred (0=axial, 1=coronal, 2=sagittal).
    x (float): X coordinate in screen space.
    y (float): Y coordinate in screen space.</p>

<p>Notes:
    Converts screen coordinates to image voxel coordinates,
    updates slice positions accordingly, and synchronizes all views.</p>
</div>


                            </div>
                            <div id="NiftiViewer.screen_to_image_coords" class="classattr">
                                        <input id="NiftiViewer.screen_to_image_coords-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">screen_to_image_coords</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">view_idx</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">y</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.screen_to_image_coords-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.screen_to_image_coords"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.screen_to_image_coords-1618"><a href="#NiftiViewer.screen_to_image_coords-1618"><span class="linenos">1618</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">screen_to_image_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="NiftiViewer.screen_to_image_coords-1619"><a href="#NiftiViewer.screen_to_image_coords-1619"><span class="linenos">1619</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.screen_to_image_coords-1620"><a href="#NiftiViewer.screen_to_image_coords-1620"><span class="linenos">1620</span></a><span class="sd">        Convert 2D screen coordinates from a slice view into 3D voxel coordinates.</span>
</span><span id="NiftiViewer.screen_to_image_coords-1621"><a href="#NiftiViewer.screen_to_image_coords-1621"><span class="linenos">1621</span></a>
</span><span id="NiftiViewer.screen_to_image_coords-1622"><a href="#NiftiViewer.screen_to_image_coords-1622"><span class="linenos">1622</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.screen_to_image_coords-1623"><a href="#NiftiViewer.screen_to_image_coords-1623"><span class="linenos">1623</span></a><span class="sd">            view_idx (int): View index (0=axial, 1=coronal, 2=sagittal).</span>
</span><span id="NiftiViewer.screen_to_image_coords-1624"><a href="#NiftiViewer.screen_to_image_coords-1624"><span class="linenos">1624</span></a><span class="sd">            x (float): X coordinate in view space.</span>
</span><span id="NiftiViewer.screen_to_image_coords-1625"><a href="#NiftiViewer.screen_to_image_coords-1625"><span class="linenos">1625</span></a><span class="sd">            y (float): Y coordinate in view space.</span>
</span><span id="NiftiViewer.screen_to_image_coords-1626"><a href="#NiftiViewer.screen_to_image_coords-1626"><span class="linenos">1626</span></a>
</span><span id="NiftiViewer.screen_to_image_coords-1627"><a href="#NiftiViewer.screen_to_image_coords-1627"><span class="linenos">1627</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer.screen_to_image_coords-1628"><a href="#NiftiViewer.screen_to_image_coords-1628"><span class="linenos">1628</span></a><span class="sd">            list[int] | None: Image-space voxel indices [x, y, z] or None if invalid.</span>
</span><span id="NiftiViewer.screen_to_image_coords-1629"><a href="#NiftiViewer.screen_to_image_coords-1629"><span class="linenos">1629</span></a>
</span><span id="NiftiViewer.screen_to_image_coords-1630"><a href="#NiftiViewer.screen_to_image_coords-1630"><span class="linenos">1630</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer.screen_to_image_coords-1631"><a href="#NiftiViewer.screen_to_image_coords-1631"><span class="linenos">1631</span></a><span class="sd">            Applies stretch factor correction, flips orientation for proper display,</span>
</span><span id="NiftiViewer.screen_to_image_coords-1632"><a href="#NiftiViewer.screen_to_image_coords-1632"><span class="linenos">1632</span></a><span class="sd">            and clamps coordinates to valid volume bounds.</span>
</span><span id="NiftiViewer.screen_to_image_coords-1633"><a href="#NiftiViewer.screen_to_image_coords-1633"><span class="linenos">1633</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.screen_to_image_coords-1634"><a href="#NiftiViewer.screen_to_image_coords-1634"><span class="linenos">1634</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.screen_to_image_coords-1635"><a href="#NiftiViewer.screen_to_image_coords-1635"><span class="linenos">1635</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="NiftiViewer.screen_to_image_coords-1636"><a href="#NiftiViewer.screen_to_image_coords-1636"><span class="linenos">1636</span></a>
</span><span id="NiftiViewer.screen_to_image_coords-1637"><a href="#NiftiViewer.screen_to_image_coords-1637"><span class="linenos">1637</span></a>        <span class="c1"># Compensate for view stretching</span>
</span><span id="NiftiViewer.screen_to_image_coords-1638"><a href="#NiftiViewer.screen_to_image_coords-1638"><span class="linenos">1638</span></a>        <span class="n">stretch_x</span><span class="p">,</span> <span class="n">stretch_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_factors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">view_idx</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
</span><span id="NiftiViewer.screen_to_image_coords-1639"><a href="#NiftiViewer.screen_to_image_coords-1639"><span class="linenos">1639</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">stretch_x</span>
</span><span id="NiftiViewer.screen_to_image_coords-1640"><a href="#NiftiViewer.screen_to_image_coords-1640"><span class="linenos">1640</span></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">stretch_y</span>
</span><span id="NiftiViewer.screen_to_image_coords-1641"><a href="#NiftiViewer.screen_to_image_coords-1641"><span class="linenos">1641</span></a>
</span><span id="NiftiViewer.screen_to_image_coords-1642"><a href="#NiftiViewer.screen_to_image_coords-1642"><span class="linenos">1642</span></a>        <span class="c1"># Determine image dimensions (ignore time axis if 4D)</span>
</span><span id="NiftiViewer.screen_to_image_coords-1643"><a href="#NiftiViewer.screen_to_image_coords-1643"><span class="linenos">1643</span></a>        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="NiftiViewer.screen_to_image_coords-1644"><a href="#NiftiViewer.screen_to_image_coords-1644"><span class="linenos">1644</span></a>
</span><span id="NiftiViewer.screen_to_image_coords-1645"><a href="#NiftiViewer.screen_to_image_coords-1645"><span class="linenos">1645</span></a>        <span class="c1"># Map view-specific coordinates to image indices</span>
</span><span id="NiftiViewer.screen_to_image_coords-1646"><a href="#NiftiViewer.screen_to_image_coords-1646"><span class="linenos">1646</span></a>        <span class="k">if</span> <span class="n">view_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Axial (XY plane)</span>
</span><span id="NiftiViewer.screen_to_image_coords-1647"><a href="#NiftiViewer.screen_to_image_coords-1647"><span class="linenos">1647</span></a>            <span class="n">img_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer.screen_to_image_coords-1648"><a href="#NiftiViewer.screen_to_image_coords-1648"><span class="linenos">1648</span></a>            <span class="n">img_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Flip Y-axis</span>
</span><span id="NiftiViewer.screen_to_image_coords-1649"><a href="#NiftiViewer.screen_to_image_coords-1649"><span class="linenos">1649</span></a>            <span class="n">img_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="NiftiViewer.screen_to_image_coords-1650"><a href="#NiftiViewer.screen_to_image_coords-1650"><span class="linenos">1650</span></a>        <span class="k">elif</span> <span class="n">view_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Coronal (XZ plane)</span>
</span><span id="NiftiViewer.screen_to_image_coords-1651"><a href="#NiftiViewer.screen_to_image_coords-1651"><span class="linenos">1651</span></a>            <span class="n">img_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer.screen_to_image_coords-1652"><a href="#NiftiViewer.screen_to_image_coords-1652"><span class="linenos">1652</span></a>            <span class="n">img_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="NiftiViewer.screen_to_image_coords-1653"><a href="#NiftiViewer.screen_to_image_coords-1653"><span class="linenos">1653</span></a>            <span class="n">img_z</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Flip Z-axis</span>
</span><span id="NiftiViewer.screen_to_image_coords-1654"><a href="#NiftiViewer.screen_to_image_coords-1654"><span class="linenos">1654</span></a>        <span class="k">elif</span> <span class="n">view_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sagittal (YZ plane)</span>
</span><span id="NiftiViewer.screen_to_image_coords-1655"><a href="#NiftiViewer.screen_to_image_coords-1655"><span class="linenos">1655</span></a>            <span class="n">img_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="NiftiViewer.screen_to_image_coords-1656"><a href="#NiftiViewer.screen_to_image_coords-1656"><span class="linenos">1656</span></a>            <span class="n">img_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer.screen_to_image_coords-1657"><a href="#NiftiViewer.screen_to_image_coords-1657"><span class="linenos">1657</span></a>            <span class="n">img_z</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Flip Z-axis</span>
</span><span id="NiftiViewer.screen_to_image_coords-1658"><a href="#NiftiViewer.screen_to_image_coords-1658"><span class="linenos">1658</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.screen_to_image_coords-1659"><a href="#NiftiViewer.screen_to_image_coords-1659"><span class="linenos">1659</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="NiftiViewer.screen_to_image_coords-1660"><a href="#NiftiViewer.screen_to_image_coords-1660"><span class="linenos">1660</span></a>
</span><span id="NiftiViewer.screen_to_image_coords-1661"><a href="#NiftiViewer.screen_to_image_coords-1661"><span class="linenos">1661</span></a>        <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">img_x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_y</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_z</span><span class="p">)]</span>
</span></pre></div>


            <div class="docstring"><p>Convert 2D screen coordinates from a slice view into 3D voxel coordinates.</p>

<p>Args:
    view_idx (int): View index (0=axial, 1=coronal, 2=sagittal).
    x (float): X coordinate in view space.
    y (float): Y coordinate in view space.</p>

<p>Returns:
    list[int] | None: Image-space voxel indices [x, y, z] or None if invalid.</p>

<p>Notes:
    Applies stretch factor correction, flips orientation for proper display,
    and clamps coordinates to valid volume bounds.</p>
</div>


                            </div>
                            <div id="NiftiViewer.update_coordinates" class="classattr">
                                        <input id="NiftiViewer.update_coordinates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_coordinates</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">view_idx</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">y</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.update_coordinates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.update_coordinates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.update_coordinates-1663"><a href="#NiftiViewer.update_coordinates-1663"><span class="linenos">1663</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="NiftiViewer.update_coordinates-1664"><a href="#NiftiViewer.update_coordinates-1664"><span class="linenos">1664</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.update_coordinates-1665"><a href="#NiftiViewer.update_coordinates-1665"><span class="linenos">1665</span></a><span class="sd">        Update displayed voxel coordinates and value from mouse movement.</span>
</span><span id="NiftiViewer.update_coordinates-1666"><a href="#NiftiViewer.update_coordinates-1666"><span class="linenos">1666</span></a>
</span><span id="NiftiViewer.update_coordinates-1667"><a href="#NiftiViewer.update_coordinates-1667"><span class="linenos">1667</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.update_coordinates-1668"><a href="#NiftiViewer.update_coordinates-1668"><span class="linenos">1668</span></a><span class="sd">            view_idx (int): Index of the active view.</span>
</span><span id="NiftiViewer.update_coordinates-1669"><a href="#NiftiViewer.update_coordinates-1669"><span class="linenos">1669</span></a><span class="sd">            x (float): X mouse position.</span>
</span><span id="NiftiViewer.update_coordinates-1670"><a href="#NiftiViewer.update_coordinates-1670"><span class="linenos">1670</span></a><span class="sd">            y (float): Y mouse position.</span>
</span><span id="NiftiViewer.update_coordinates-1671"><a href="#NiftiViewer.update_coordinates-1671"><span class="linenos">1671</span></a>
</span><span id="NiftiViewer.update_coordinates-1672"><a href="#NiftiViewer.update_coordinates-1672"><span class="linenos">1672</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer.update_coordinates-1673"><a href="#NiftiViewer.update_coordinates-1673"><span class="linenos">1673</span></a><span class="sd">            Displays current voxel indices and intensity in the status bar</span>
</span><span id="NiftiViewer.update_coordinates-1674"><a href="#NiftiViewer.update_coordinates-1674"><span class="linenos">1674</span></a><span class="sd">            as the user moves the mouse across an image slice.</span>
</span><span id="NiftiViewer.update_coordinates-1675"><a href="#NiftiViewer.update_coordinates-1675"><span class="linenos">1675</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.update_coordinates-1676"><a href="#NiftiViewer.update_coordinates-1676"><span class="linenos">1676</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.update_coordinates-1677"><a href="#NiftiViewer.update_coordinates-1677"><span class="linenos">1677</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer.update_coordinates-1678"><a href="#NiftiViewer.update_coordinates-1678"><span class="linenos">1678</span></a>
</span><span id="NiftiViewer.update_coordinates-1679"><a href="#NiftiViewer.update_coordinates-1679"><span class="linenos">1679</span></a>        <span class="n">img_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen_to_image_coords</span><span class="p">(</span><span class="n">view_idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="NiftiViewer.update_coordinates-1680"><a href="#NiftiViewer.update_coordinates-1680"><span class="linenos">1680</span></a>        <span class="k">if</span> <span class="n">img_coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.update_coordinates-1681"><a href="#NiftiViewer.update_coordinates-1681"><span class="linenos">1681</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer.update_coordinates-1682"><a href="#NiftiViewer.update_coordinates-1682"><span class="linenos">1682</span></a>
</span><span id="NiftiViewer.update_coordinates-1683"><a href="#NiftiViewer.update_coordinates-1683"><span class="linenos">1683</span></a>        <span class="c1"># Retrieve voxel value safely</span>
</span><span id="NiftiViewer.update_coordinates-1684"><a href="#NiftiViewer.update_coordinates-1684"><span class="linenos">1684</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NiftiViewer.update_coordinates-1685"><a href="#NiftiViewer.update_coordinates-1685"><span class="linenos">1685</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="NiftiViewer.update_coordinates-1686"><a href="#NiftiViewer.update_coordinates-1686"><span class="linenos">1686</span></a>                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">]</span>
</span><span id="NiftiViewer.update_coordinates-1687"><a href="#NiftiViewer.update_coordinates-1687"><span class="linenos">1687</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.update_coordinates-1688"><a href="#NiftiViewer.update_coordinates-1688"><span class="linenos">1688</span></a>                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</span><span id="NiftiViewer.update_coordinates-1689"><a href="#NiftiViewer.update_coordinates-1689"><span class="linenos">1689</span></a>
</span><span id="NiftiViewer.update_coordinates-1690"><a href="#NiftiViewer.update_coordinates-1690"><span class="linenos">1690</span></a>            <span class="c1"># Update coordinate and voxel value display</span>
</span><span id="NiftiViewer.update_coordinates-1691"><a href="#NiftiViewer.update_coordinates-1691"><span class="linenos">1691</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
</span><span id="NiftiViewer.update_coordinates-1692"><a href="#NiftiViewer.update_coordinates-1692"><span class="linenos">1692</span></a>                <span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coordinates&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: (</span><span class="si">{</span><span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">img_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">img_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.update_coordinates-1693"><a href="#NiftiViewer.update_coordinates-1693"><span class="linenos">1693</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
</span><span id="NiftiViewer.update_coordinates-1694"><a href="#NiftiViewer.update_coordinates-1694"><span class="linenos">1694</span></a>                <span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.update_coordinates-1695"><a href="#NiftiViewer.update_coordinates-1695"><span class="linenos">1695</span></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span id="NiftiViewer.update_coordinates-1696"><a href="#NiftiViewer.update_coordinates-1696"><span class="linenos">1696</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to update coordinates&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Update displayed voxel coordinates and value from mouse movement.</p>

<p>Args:
    view_idx (int): Index of the active view.
    x (float): X mouse position.
    y (float): Y mouse position.</p>

<p>Notes:
    Displays current voxel indices and intensity in the status bar
    as the user moves the mouse across an image slice.</p>
</div>


                            </div>
                            <div id="NiftiViewer.update_coordinate_displays" class="classattr">
                                        <input id="NiftiViewer.update_coordinate_displays-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_coordinate_displays</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.update_coordinate_displays-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.update_coordinate_displays"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.update_coordinate_displays-1698"><a href="#NiftiViewer.update_coordinate_displays-1698"><span class="linenos">1698</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_coordinate_displays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.update_coordinate_displays-1699"><a href="#NiftiViewer.update_coordinate_displays-1699"><span class="linenos">1699</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.update_coordinate_displays-1700"><a href="#NiftiViewer.update_coordinate_displays-1700"><span class="linenos">1700</span></a><span class="sd">        Update coordinate display labels beside each view and in the status bar.</span>
</span><span id="NiftiViewer.update_coordinate_displays-1701"><a href="#NiftiViewer.update_coordinate_displays-1701"><span class="linenos">1701</span></a>
</span><span id="NiftiViewer.update_coordinate_displays-1702"><a href="#NiftiViewer.update_coordinate_displays-1702"><span class="linenos">1702</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer.update_coordinate_displays-1703"><a href="#NiftiViewer.update_coordinate_displays-1703"><span class="linenos">1703</span></a><span class="sd">            Shows current voxel positions (X, Y, Z) and value, ensuring real-time</span>
</span><span id="NiftiViewer.update_coordinate_displays-1704"><a href="#NiftiViewer.update_coordinate_displays-1704"><span class="linenos">1704</span></a><span class="sd">            synchronization with slice sliders and mouse navigation.</span>
</span><span id="NiftiViewer.update_coordinate_displays-1705"><a href="#NiftiViewer.update_coordinate_displays-1705"><span class="linenos">1705</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.update_coordinate_displays-1706"><a href="#NiftiViewer.update_coordinate_displays-1706"><span class="linenos">1706</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.update_coordinate_displays-1707"><a href="#NiftiViewer.update_coordinate_displays-1707"><span class="linenos">1707</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer.update_coordinate_displays-1708"><a href="#NiftiViewer.update_coordinate_displays-1708"><span class="linenos">1708</span></a>
</span><span id="NiftiViewer.update_coordinate_displays-1709"><a href="#NiftiViewer.update_coordinate_displays-1709"><span class="linenos">1709</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span>
</span><span id="NiftiViewer.update_coordinate_displays-1710"><a href="#NiftiViewer.update_coordinate_displays-1710"><span class="linenos">1710</span></a>
</span><span id="NiftiViewer.update_coordinate_displays-1711"><a href="#NiftiViewer.update_coordinate_displays-1711"><span class="linenos">1711</span></a>        <span class="c1"># Update per-view coordinate readouts</span>
</span><span id="NiftiViewer.update_coordinate_displays-1712"><a href="#NiftiViewer.update_coordinate_displays-1712"><span class="linenos">1712</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_displays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>  <span class="c1"># Axial</span>
</span><span id="NiftiViewer.update_coordinate_displays-1713"><a href="#NiftiViewer.update_coordinate_displays-1713"><span class="linenos">1713</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_displays</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>  <span class="c1"># Coronal</span>
</span><span id="NiftiViewer.update_coordinate_displays-1714"><a href="#NiftiViewer.update_coordinate_displays-1714"><span class="linenos">1714</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_displays</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>  <span class="c1"># Sagittal</span>
</span><span id="NiftiViewer.update_coordinate_displays-1715"><a href="#NiftiViewer.update_coordinate_displays-1715"><span class="linenos">1715</span></a>
</span><span id="NiftiViewer.update_coordinate_displays-1716"><a href="#NiftiViewer.update_coordinate_displays-1716"><span class="linenos">1716</span></a>        <span class="c1"># Update global coordinate display in status bar</span>
</span><span id="NiftiViewer.update_coordinate_displays-1717"><a href="#NiftiViewer.update_coordinate_displays-1717"><span class="linenos">1717</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coord_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
</span><span id="NiftiViewer.update_coordinate_displays-1718"><a href="#NiftiViewer.update_coordinate_displays-1718"><span class="linenos">1718</span></a>            <span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Coordinates&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: (</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.update_coordinate_displays-1719"><a href="#NiftiViewer.update_coordinate_displays-1719"><span class="linenos">1719</span></a>
</span><span id="NiftiViewer.update_coordinate_displays-1720"><a href="#NiftiViewer.update_coordinate_displays-1720"><span class="linenos">1720</span></a>        <span class="c1"># Update value label safely</span>
</span><span id="NiftiViewer.update_coordinate_displays-1721"><a href="#NiftiViewer.update_coordinate_displays-1721"><span class="linenos">1721</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NiftiViewer.update_coordinate_displays-1722"><a href="#NiftiViewer.update_coordinate_displays-1722"><span class="linenos">1722</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="NiftiViewer.update_coordinate_displays-1723"><a href="#NiftiViewer.update_coordinate_displays-1723"><span class="linenos">1723</span></a>                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">]</span>
</span><span id="NiftiViewer.update_coordinate_displays-1724"><a href="#NiftiViewer.update_coordinate_displays-1724"><span class="linenos">1724</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.update_coordinate_displays-1725"><a href="#NiftiViewer.update_coordinate_displays-1725"><span class="linenos">1725</span></a>                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</span><span id="NiftiViewer.update_coordinate_displays-1726"><a href="#NiftiViewer.update_coordinate_displays-1726"><span class="linenos">1726</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
</span><span id="NiftiViewer.update_coordinate_displays-1727"><a href="#NiftiViewer.update_coordinate_displays-1727"><span class="linenos">1727</span></a>                <span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.update_coordinate_displays-1728"><a href="#NiftiViewer.update_coordinate_displays-1728"><span class="linenos">1728</span></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span id="NiftiViewer.update_coordinate_displays-1729"><a href="#NiftiViewer.update_coordinate_displays-1729"><span class="linenos">1729</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">value_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;: -&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Update coordinate display labels beside each view and in the status bar.</p>

<p>Notes:
    Shows current voxel positions (X, Y, Z) and value, ensuring real-time
    synchronization with slice sliders and mouse navigation.</p>
</div>


                            </div>
                            <div id="NiftiViewer.update_cross_view_lines" class="classattr">
                                        <input id="NiftiViewer.update_cross_view_lines-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_cross_view_lines</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.update_cross_view_lines-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.update_cross_view_lines"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.update_cross_view_lines-1731"><a href="#NiftiViewer.update_cross_view_lines-1731"><span class="linenos">1731</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_cross_view_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.update_cross_view_lines-1732"><a href="#NiftiViewer.update_cross_view_lines-1732"><span class="linenos">1732</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.update_cross_view_lines-1733"><a href="#NiftiViewer.update_cross_view_lines-1733"><span class="linenos">1733</span></a><span class="sd">        Update crosshair positions across all views to indicate current voxel location.</span>
</span><span id="NiftiViewer.update_cross_view_lines-1734"><a href="#NiftiViewer.update_cross_view_lines-1734"><span class="linenos">1734</span></a>
</span><span id="NiftiViewer.update_cross_view_lines-1735"><a href="#NiftiViewer.update_cross_view_lines-1735"><span class="linenos">1735</span></a><span class="sd">        Notes:</span>
</span><span id="NiftiViewer.update_cross_view_lines-1736"><a href="#NiftiViewer.update_cross_view_lines-1736"><span class="linenos">1736</span></a><span class="sd">            Crosshair lines are synchronized in all 2D projections (axial, coronal, sagittal),</span>
</span><span id="NiftiViewer.update_cross_view_lines-1737"><a href="#NiftiViewer.update_cross_view_lines-1737"><span class="linenos">1737</span></a><span class="sd">            taking into account stretching factors and coordinate flipping.</span>
</span><span id="NiftiViewer.update_cross_view_lines-1738"><a href="#NiftiViewer.update_cross_view_lines-1738"><span class="linenos">1738</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.update_cross_view_lines-1739"><a href="#NiftiViewer.update_cross_view_lines-1739"><span class="linenos">1739</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.update_cross_view_lines-1740"><a href="#NiftiViewer.update_cross_view_lines-1740"><span class="linenos">1740</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer.update_cross_view_lines-1741"><a href="#NiftiViewer.update_cross_view_lines-1741"><span class="linenos">1741</span></a>
</span><span id="NiftiViewer.update_cross_view_lines-1742"><a href="#NiftiViewer.update_cross_view_lines-1742"><span class="linenos">1742</span></a>        <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span>
</span><span id="NiftiViewer.update_cross_view_lines-1743"><a href="#NiftiViewer.update_cross_view_lines-1743"><span class="linenos">1743</span></a>
</span><span id="NiftiViewer.update_cross_view_lines-1744"><a href="#NiftiViewer.update_cross_view_lines-1744"><span class="linenos">1744</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">):</span>
</span><span id="NiftiViewer.update_cross_view_lines-1745"><a href="#NiftiViewer.update_cross_view_lines-1745"><span class="linenos">1745</span></a>            <span class="c1"># Retrieve stretch correction factors (default to 1.0)</span>
</span><span id="NiftiViewer.update_cross_view_lines-1746"><a href="#NiftiViewer.update_cross_view_lines-1746"><span class="linenos">1746</span></a>            <span class="n">stretch_x</span><span class="p">,</span> <span class="n">stretch_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_factors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
</span><span id="NiftiViewer.update_cross_view_lines-1747"><a href="#NiftiViewer.update_cross_view_lines-1747"><span class="linenos">1747</span></a>
</span><span id="NiftiViewer.update_cross_view_lines-1748"><a href="#NiftiViewer.update_cross_view_lines-1748"><span class="linenos">1748</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Axial view</span>
</span><span id="NiftiViewer.update_cross_view_lines-1749"><a href="#NiftiViewer.update_cross_view_lines-1749"><span class="linenos">1749</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">stretch_x</span>
</span><span id="NiftiViewer.update_cross_view_lines-1750"><a href="#NiftiViewer.update_cross_view_lines-1750"><span class="linenos">1750</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">stretch_y</span>
</span><span id="NiftiViewer.update_cross_view_lines-1751"><a href="#NiftiViewer.update_cross_view_lines-1751"><span class="linenos">1751</span></a>                <span class="n">view</span><span class="o">.</span><span class="n">set_crosshair_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="NiftiViewer.update_cross_view_lines-1752"><a href="#NiftiViewer.update_cross_view_lines-1752"><span class="linenos">1752</span></a>
</span><span id="NiftiViewer.update_cross_view_lines-1753"><a href="#NiftiViewer.update_cross_view_lines-1753"><span class="linenos">1753</span></a>            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Coronal view</span>
</span><span id="NiftiViewer.update_cross_view_lines-1754"><a href="#NiftiViewer.update_cross_view_lines-1754"><span class="linenos">1754</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">stretch_x</span>
</span><span id="NiftiViewer.update_cross_view_lines-1755"><a href="#NiftiViewer.update_cross_view_lines-1755"><span class="linenos">1755</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">stretch_y</span>
</span><span id="NiftiViewer.update_cross_view_lines-1756"><a href="#NiftiViewer.update_cross_view_lines-1756"><span class="linenos">1756</span></a>                <span class="n">view</span><span class="o">.</span><span class="n">set_crosshair_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="NiftiViewer.update_cross_view_lines-1757"><a href="#NiftiViewer.update_cross_view_lines-1757"><span class="linenos">1757</span></a>
</span><span id="NiftiViewer.update_cross_view_lines-1758"><a href="#NiftiViewer.update_cross_view_lines-1758"><span class="linenos">1758</span></a>            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sagittal view</span>
</span><span id="NiftiViewer.update_cross_view_lines-1759"><a href="#NiftiViewer.update_cross_view_lines-1759"><span class="linenos">1759</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">stretch_x</span>
</span><span id="NiftiViewer.update_cross_view_lines-1760"><a href="#NiftiViewer.update_cross_view_lines-1760"><span class="linenos">1760</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">stretch_y</span>
</span><span id="NiftiViewer.update_cross_view_lines-1761"><a href="#NiftiViewer.update_cross_view_lines-1761"><span class="linenos">1761</span></a>                <span class="n">view</span><span class="o">.</span><span class="n">set_crosshair_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Update crosshair positions across all views to indicate current voxel location.</p>

<p>Notes:
    Crosshair lines are synchronized in all 2D projections (axial, coronal, sagittal),
    taking into account stretching factors and coordinate flipping.</p>
</div>


                            </div>
                            <div id="NiftiViewer.update_display" class="classattr">
                                        <input id="NiftiViewer.update_display-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_display</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">plane_idx</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.update_display-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.update_display"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.update_display-1763"><a href="#NiftiViewer.update_display-1763"><span class="linenos">1763</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_idx</span><span class="p">):</span>
</span><span id="NiftiViewer.update_display-1764"><a href="#NiftiViewer.update_display-1764"><span class="linenos">1764</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update a specific plane display with matplotlib-style rendering in mm scale&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.update_display-1765"><a href="#NiftiViewer.update_display-1765"><span class="linenos">1765</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.update_display-1766"><a href="#NiftiViewer.update_display-1766"><span class="linenos">1766</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer.update_display-1767"><a href="#NiftiViewer.update_display-1767"><span class="linenos">1767</span></a>
</span><span id="NiftiViewer.update_display-1768"><a href="#NiftiViewer.update_display-1768"><span class="linenos">1768</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NiftiViewer.update_display-1769"><a href="#NiftiViewer.update_display-1769"><span class="linenos">1769</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Update display: </span><span class="si">{</span><span class="n">plane_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.update_display-1770"><a href="#NiftiViewer.update_display-1770"><span class="linenos">1770</span></a>            <span class="c1"># Select current 3D volume (for 4D data, use the selected time frame)</span>
</span><span id="NiftiViewer.update_display-1771"><a href="#NiftiViewer.update_display-1771"><span class="linenos">1771</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="NiftiViewer.update_display-1772"><a href="#NiftiViewer.update_display-1772"><span class="linenos">1772</span></a>                <span class="n">current_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">]</span>
</span><span id="NiftiViewer.update_display-1773"><a href="#NiftiViewer.update_display-1773"><span class="linenos">1773</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.update_display-1774"><a href="#NiftiViewer.update_display-1774"><span class="linenos">1774</span></a>                <span class="n">current_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span>
</span><span id="NiftiViewer.update_display-1775"><a href="#NiftiViewer.update_display-1775"><span class="linenos">1775</span></a>
</span><span id="NiftiViewer.update_display-1776"><a href="#NiftiViewer.update_display-1776"><span class="linenos">1776</span></a>            <span class="c1"># Get current slice index for the selected plane</span>
</span><span id="NiftiViewer.update_display-1777"><a href="#NiftiViewer.update_display-1777"><span class="linenos">1777</span></a>            <span class="n">slice_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span>
</span><span id="NiftiViewer.update_display-1778"><a href="#NiftiViewer.update_display-1778"><span class="linenos">1778</span></a>
</span><span id="NiftiViewer.update_display-1779"><a href="#NiftiViewer.update_display-1779"><span class="linenos">1779</span></a>            <span class="c1"># Extract the corresponding slice depending on the plane</span>
</span><span id="NiftiViewer.update_display-1780"><a href="#NiftiViewer.update_display-1780"><span class="linenos">1780</span></a>            <span class="k">if</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Axial (XY plane)</span>
</span><span id="NiftiViewer.update_display-1781"><a href="#NiftiViewer.update_display-1781"><span class="linenos">1781</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">current_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">slice_idx</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># transpose to match orientation</span>
</span><span id="NiftiViewer.update_display-1782"><a href="#NiftiViewer.update_display-1782"><span class="linenos">1782</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">slice_data</span><span class="p">)</span>  <span class="c1"># flip vertically for correct visualization</span>
</span><span id="NiftiViewer.update_display-1783"><a href="#NiftiViewer.update_display-1783"><span class="linenos">1783</span></a>                <span class="n">pixel_spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># spacing in X and Y directions</span>
</span><span id="NiftiViewer.update_display-1784"><a href="#NiftiViewer.update_display-1784"><span class="linenos">1784</span></a>
</span><span id="NiftiViewer.update_display-1785"><a href="#NiftiViewer.update_display-1785"><span class="linenos">1785</span></a>            <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Coronal (XZ plane)</span>
</span><span id="NiftiViewer.update_display-1786"><a href="#NiftiViewer.update_display-1786"><span class="linenos">1786</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">current_data</span><span class="p">[:,</span> <span class="n">slice_idx</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
</span><span id="NiftiViewer.update_display-1787"><a href="#NiftiViewer.update_display-1787"><span class="linenos">1787</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">slice_data</span><span class="p">)</span>
</span><span id="NiftiViewer.update_display-1788"><a href="#NiftiViewer.update_display-1788"><span class="linenos">1788</span></a>                <span class="n">pixel_spacing</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># X and Z spacing</span>
</span><span id="NiftiViewer.update_display-1789"><a href="#NiftiViewer.update_display-1789"><span class="linenos">1789</span></a>
</span><span id="NiftiViewer.update_display-1790"><a href="#NiftiViewer.update_display-1790"><span class="linenos">1790</span></a>            <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sagittal (YZ plane)</span>
</span><span id="NiftiViewer.update_display-1791"><a href="#NiftiViewer.update_display-1791"><span class="linenos">1791</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">current_data</span><span class="p">[</span><span class="n">slice_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
</span><span id="NiftiViewer.update_display-1792"><a href="#NiftiViewer.update_display-1792"><span class="linenos">1792</span></a>                <span class="n">slice_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">slice_data</span><span class="p">)</span>
</span><span id="NiftiViewer.update_display-1793"><a href="#NiftiViewer.update_display-1793"><span class="linenos">1793</span></a>                <span class="n">pixel_spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># Y and Z spacing</span>
</span><span id="NiftiViewer.update_display-1794"><a href="#NiftiViewer.update_display-1794"><span class="linenos">1794</span></a>
</span><span id="NiftiViewer.update_display-1795"><a href="#NiftiViewer.update_display-1795"><span class="linenos">1795</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.update_display-1796"><a href="#NiftiViewer.update_display-1796"><span class="linenos">1796</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Plane index out of range&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.update_display-1797"><a href="#NiftiViewer.update_display-1797"><span class="linenos">1797</span></a>                <span class="k">return</span>  <span class="c1"># Invalid plane index</span>
</span><span id="NiftiViewer.update_display-1798"><a href="#NiftiViewer.update_display-1798"><span class="linenos">1798</span></a>
</span><span id="NiftiViewer.update_display-1799"><a href="#NiftiViewer.update_display-1799"><span class="linenos">1799</span></a>            <span class="n">automaticROI_slice</span> <span class="o">=</span> <span class="n">_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span><span class="p">,</span> <span class="n">plane_idx</span><span class="p">,</span> <span class="n">slice_idx</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="NiftiViewer.update_display-1800"><a href="#NiftiViewer.update_display-1800"><span class="linenos">1800</span></a>
</span><span id="NiftiViewer.update_display-1801"><a href="#NiftiViewer.update_display-1801"><span class="linenos">1801</span></a>            <span class="c1"># Prepare overlay if available and enabled</span>
</span><span id="NiftiViewer.update_display-1802"><a href="#NiftiViewer.update_display-1802"><span class="linenos">1802</span></a>            <span class="n">overlay_slice</span> <span class="o">=</span> <span class="n">_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span><span class="p">,</span><span class="n">plane_idx</span><span class="p">,</span> <span class="n">slice_idx</span><span class="p">)</span>  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="NiftiViewer.update_display-1803"><a href="#NiftiViewer.update_display-1803"><span class="linenos">1803</span></a>
</span><span id="NiftiViewer.update_display-1804"><a href="#NiftiViewer.update_display-1804"><span class="linenos">1804</span></a>            <span class="n">incrementalROI_slice</span> <span class="o">=</span> <span class="n">_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span><span class="p">,</span><span class="n">plane_idx</span><span class="p">,</span> <span class="n">slice_idx</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="NiftiViewer.update_display-1805"><a href="#NiftiViewer.update_display-1805"><span class="linenos">1805</span></a>
</span><span id="NiftiViewer.update_display-1806"><a href="#NiftiViewer.update_display-1806"><span class="linenos">1806</span></a>            <span class="c1"># Prepare RGBA composite for display</span>
</span><span id="NiftiViewer.update_display-1807"><a href="#NiftiViewer.update_display-1807"><span class="linenos">1807</span></a>            <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">slice_data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="NiftiViewer.update_display-1808"><a href="#NiftiViewer.update_display-1808"><span class="linenos">1808</span></a>            <span class="n">rgba_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_colormap_matplotlib</span><span class="p">(</span><span class="n">slice_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="NiftiViewer.update_display-1809"><a href="#NiftiViewer.update_display-1809"><span class="linenos">1809</span></a>
</span><span id="NiftiViewer.update_display-1810"><a href="#NiftiViewer.update_display-1810"><span class="linenos">1810</span></a>            <span class="k">if</span> <span class="n">automaticROI_slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.update_display-1811"><a href="#NiftiViewer.update_display-1811"><span class="linenos">1811</span></a>                <span class="n">rgba_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_overlay_composite</span><span class="p">(</span><span class="n">rgba_image</span><span class="p">,</span> <span class="n">automaticROI_slice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="NiftiViewer.update_display-1812"><a href="#NiftiViewer.update_display-1812"><span class="linenos">1812</span></a>
</span><span id="NiftiViewer.update_display-1813"><a href="#NiftiViewer.update_display-1813"><span class="linenos">1813</span></a>            <span class="k">if</span> <span class="n">overlay_slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.update_display-1814"><a href="#NiftiViewer.update_display-1814"><span class="linenos">1814</span></a>                <span class="n">rgba_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_overlay_composite</span><span class="p">(</span><span class="n">rgba_image</span><span class="p">,</span> <span class="n">overlay_slice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="NiftiViewer.update_display-1815"><a href="#NiftiViewer.update_display-1815"><span class="linenos">1815</span></a>
</span><span id="NiftiViewer.update_display-1816"><a href="#NiftiViewer.update_display-1816"><span class="linenos">1816</span></a>            <span class="k">if</span> <span class="n">incrementalROI_slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.update_display-1817"><a href="#NiftiViewer.update_display-1817"><span class="linenos">1817</span></a>                <span class="n">rgba_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_overlay_composite</span><span class="p">(</span><span class="n">rgba_image</span><span class="p">,</span> <span class="n">incrementalROI_slice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="NiftiViewer.update_display-1818"><a href="#NiftiViewer.update_display-1818"><span class="linenos">1818</span></a>
</span><span id="NiftiViewer.update_display-1819"><a href="#NiftiViewer.update_display-1819"><span class="linenos">1819</span></a>            <span class="c1"># Convert RGBA data to 8-bit format for QImage</span>
</span><span id="NiftiViewer.update_display-1820"><a href="#NiftiViewer.update_display-1820"><span class="linenos">1820</span></a>            <span class="n">rgba_data_uint8</span> <span class="o">=</span> <span class="p">(</span><span class="n">rgba_image</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="NiftiViewer.update_display-1821"><a href="#NiftiViewer.update_display-1821"><span class="linenos">1821</span></a>            <span class="n">qimage</span> <span class="o">=</span> <span class="n">QImage</span><span class="p">(</span><span class="n">rgba_data_uint8</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">QImage</span><span class="o">.</span><span class="n">Format</span><span class="o">.</span><span class="n">Format_RGBA8888</span><span class="p">)</span>
</span><span id="NiftiViewer.update_display-1822"><a href="#NiftiViewer.update_display-1822"><span class="linenos">1822</span></a>
</span><span id="NiftiViewer.update_display-1823"><a href="#NiftiViewer.update_display-1823"><span class="linenos">1823</span></a>            <span class="k">if</span> <span class="n">qimage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.update_display-1824"><a href="#NiftiViewer.update_display-1824"><span class="linenos">1824</span></a>                <span class="n">img_w</span><span class="p">,</span> <span class="n">img_h</span> <span class="o">=</span> <span class="n">qimage</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span> <span class="n">qimage</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
</span><span id="NiftiViewer.update_display-1825"><a href="#NiftiViewer.update_display-1825"><span class="linenos">1825</span></a>
</span><span id="NiftiViewer.update_display-1826"><a href="#NiftiViewer.update_display-1826"><span class="linenos">1826</span></a>                <span class="c1"># Scale the image according to voxel size ratio (convert to mm scale)</span>
</span><span id="NiftiViewer.update_display-1827"><a href="#NiftiViewer.update_display-1827"><span class="linenos">1827</span></a>                <span class="n">qimage_scaled</span> <span class="o">=</span> <span class="n">qimage</span><span class="o">.</span><span class="n">scaled</span><span class="p">(</span>
</span><span id="NiftiViewer.update_display-1828"><a href="#NiftiViewer.update_display-1828"><span class="linenos">1828</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="n">img_w</span><span class="p">),</span>
</span><span id="NiftiViewer.update_display-1829"><a href="#NiftiViewer.update_display-1829"><span class="linenos">1829</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="n">img_h</span> <span class="o">*</span> <span class="p">(</span><span class="n">pixel_spacing</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">pixel_spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
</span><span id="NiftiViewer.update_display-1830"><a href="#NiftiViewer.update_display-1830"><span class="linenos">1830</span></a>                    <span class="n">Qt</span><span class="o">.</span><span class="n">AspectRatioMode</span><span class="o">.</span><span class="n">IgnoreAspectRatio</span><span class="p">,</span>
</span><span id="NiftiViewer.update_display-1831"><a href="#NiftiViewer.update_display-1831"><span class="linenos">1831</span></a>                    <span class="n">Qt</span><span class="o">.</span><span class="n">TransformationMode</span><span class="o">.</span><span class="n">SmoothTransformation</span>
</span><span id="NiftiViewer.update_display-1832"><a href="#NiftiViewer.update_display-1832"><span class="linenos">1832</span></a>                <span class="p">)</span>
</span><span id="NiftiViewer.update_display-1833"><a href="#NiftiViewer.update_display-1833"><span class="linenos">1833</span></a>
</span><span id="NiftiViewer.update_display-1834"><a href="#NiftiViewer.update_display-1834"><span class="linenos">1834</span></a>                <span class="c1"># Store stretch factors for coordinate conversion later</span>
</span><span id="NiftiViewer.update_display-1835"><a href="#NiftiViewer.update_display-1835"><span class="linenos">1835</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stretch_factors</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pixel_spacing</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">pixel_spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="NiftiViewer.update_display-1836"><a href="#NiftiViewer.update_display-1836"><span class="linenos">1836</span></a>
</span><span id="NiftiViewer.update_display-1837"><a href="#NiftiViewer.update_display-1837"><span class="linenos">1837</span></a>                <span class="c1"># Update QGraphicsScene and QGraphicsView with new image</span>
</span><span id="NiftiViewer.update_display-1838"><a href="#NiftiViewer.update_display-1838"><span class="linenos">1838</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pixmap_items</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">setPixmap</span><span class="p">(</span><span class="n">QPixmap</span><span class="o">.</span><span class="n">fromImage</span><span class="p">(</span><span class="n">qimage_scaled</span><span class="p">))</span>
</span><span id="NiftiViewer.update_display-1839"><a href="#NiftiViewer.update_display-1839"><span class="linenos">1839</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">setSceneRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qimage_scaled</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span> <span class="n">qimage_scaled</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>
</span><span id="NiftiViewer.update_display-1840"><a href="#NiftiViewer.update_display-1840"><span class="linenos">1840</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">fitInView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="p">[</span><span class="n">plane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">sceneRect</span><span class="p">(),</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AspectRatioMode</span><span class="o">.</span><span class="n">KeepAspectRatio</span><span class="p">)</span>
</span><span id="NiftiViewer.update_display-1841"><a href="#NiftiViewer.update_display-1841"><span class="linenos">1841</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated display ended&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.update_display-1842"><a href="#NiftiViewer.update_display-1842"><span class="linenos">1842</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="NiftiViewer.update_display-1843"><a href="#NiftiViewer.update_display-1843"><span class="linenos">1843</span></a>            <span class="c1"># Log any display update errors (e.g. shape mismatch or memory issue)</span>
</span><span id="NiftiViewer.update_display-1844"><a href="#NiftiViewer.update_display-1844"><span class="linenos">1844</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating display </span><span class="si">{</span><span class="n">plane_idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Update a specific plane display with matplotlib-style rendering in mm scale</p>
</div>


                            </div>
                            <div id="NiftiViewer.setup_time_series_plot" class="classattr">
                                        <input id="NiftiViewer.setup_time_series_plot-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_time_series_plot</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.setup_time_series_plot-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.setup_time_series_plot"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.setup_time_series_plot-1846"><a href="#NiftiViewer.setup_time_series_plot-1846"><span class="linenos">1846</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_time_series_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.setup_time_series_plot-1847"><a href="#NiftiViewer.setup_time_series_plot-1847"><span class="linenos">1847</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup time series plot for 4D data&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.setup_time_series_plot-1848"><a href="#NiftiViewer.setup_time_series_plot-1848"><span class="linenos">1848</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.setup_time_series_plot-1849"><a href="#NiftiViewer.setup_time_series_plot-1849"><span class="linenos">1849</span></a>            <span class="k">return</span>  <span class="c1"># Skip if plot is already initialized</span>
</span><span id="NiftiViewer.setup_time_series_plot-1850"><a href="#NiftiViewer.setup_time_series_plot-1850"><span class="linenos">1850</span></a>
</span><span id="NiftiViewer.setup_time_series_plot-1851"><a href="#NiftiViewer.setup_time_series_plot-1851"><span class="linenos">1851</span></a>        <span class="c1"># Hide static info text to make room for plot</span>
</span><span id="NiftiViewer.setup_time_series_plot-1852"><a href="#NiftiViewer.setup_time_series_plot-1852"><span class="linenos">1852</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
</span><span id="NiftiViewer.setup_time_series_plot-1853"><a href="#NiftiViewer.setup_time_series_plot-1853"><span class="linenos">1853</span></a>
</span><span id="NiftiViewer.setup_time_series_plot-1854"><a href="#NiftiViewer.setup_time_series_plot-1854"><span class="linenos">1854</span></a>        <span class="c1"># Initialize matplotlib figure for time series</span>
</span><span id="NiftiViewer.setup_time_series_plot-1855"><a href="#NiftiViewer.setup_time_series_plot-1855"><span class="linenos">1855</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_time_series_plot-1856"><a href="#NiftiViewer.setup_time_series_plot-1856"><span class="linenos">1856</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span><span class="o">.</span><span class="n">set_layout_engine</span><span class="p">(</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_time_series_plot-1857"><a href="#NiftiViewer.setup_time_series_plot-1857"><span class="linenos">1857</span></a>
</span><span id="NiftiViewer.setup_time_series_plot-1858"><a href="#NiftiViewer.setup_time_series_plot-1858"><span class="linenos">1858</span></a>        <span class="c1"># Embed matplotlib canvas inside PyQt interface</span>
</span><span id="NiftiViewer.setup_time_series_plot-1859"><a href="#NiftiViewer.setup_time_series_plot-1859"><span class="linenos">1859</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_time_series_plot-1860"><a href="#NiftiViewer.setup_time_series_plot-1860"><span class="linenos">1860</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_time_series_plot-1861"><a href="#NiftiViewer.setup_time_series_plot-1861"><span class="linenos">1861</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer.setup_time_series_plot-1862"><a href="#NiftiViewer.setup_time_series_plot-1862"><span class="linenos">1862</span></a>
</span><span id="NiftiViewer.setup_time_series_plot-1863"><a href="#NiftiViewer.setup_time_series_plot-1863"><span class="linenos">1863</span></a>        <span class="c1"># Update section title and add canvas widget to layout</span>
</span><span id="NiftiViewer.setup_time_series_plot-1864"><a href="#NiftiViewer.setup_time_series_plot-1864"><span class="linenos">1864</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Tracer Concentration Curve&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.setup_time_series_plot-1865"><a href="#NiftiViewer.setup_time_series_plot-1865"><span class="linenos">1865</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_content_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Setup time series plot for 4D data</p>
</div>


                            </div>
                            <div id="NiftiViewer.hide_time_series_plot" class="classattr">
                                        <input id="NiftiViewer.hide_time_series_plot-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">hide_time_series_plot</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.hide_time_series_plot-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.hide_time_series_plot"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.hide_time_series_plot-1867"><a href="#NiftiViewer.hide_time_series_plot-1867"><span class="linenos">1867</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">hide_time_series_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.hide_time_series_plot-1868"><a href="#NiftiViewer.hide_time_series_plot-1868"><span class="linenos">1868</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Hide time series plot for 3D data&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.hide_time_series_plot-1869"><a href="#NiftiViewer.hide_time_series_plot-1869"><span class="linenos">1869</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.hide_time_series_plot-1870"><a href="#NiftiViewer.hide_time_series_plot-1870"><span class="linenos">1870</span></a>            <span class="c1"># Clean up plot canvas from layout and delete</span>
</span><span id="NiftiViewer.hide_time_series_plot-1871"><a href="#NiftiViewer.hide_time_series_plot-1871"><span class="linenos">1871</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fourth_content_layout</span><span class="o">.</span><span class="n">removeWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span><span class="p">)</span>
</span><span id="NiftiViewer.hide_time_series_plot-1872"><a href="#NiftiViewer.hide_time_series_plot-1872"><span class="linenos">1872</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="NiftiViewer.hide_time_series_plot-1873"><a href="#NiftiViewer.hide_time_series_plot-1873"><span class="linenos">1873</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
</span><span id="NiftiViewer.hide_time_series_plot-1874"><a href="#NiftiViewer.hide_time_series_plot-1874"><span class="linenos">1874</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.hide_time_series_plot-1875"><a href="#NiftiViewer.hide_time_series_plot-1875"><span class="linenos">1875</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.hide_time_series_plot-1876"><a href="#NiftiViewer.hide_time_series_plot-1876"><span class="linenos">1876</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_figure</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.hide_time_series_plot-1877"><a href="#NiftiViewer.hide_time_series_plot-1877"><span class="linenos">1877</span></a>
</span><span id="NiftiViewer.hide_time_series_plot-1878"><a href="#NiftiViewer.hide_time_series_plot-1878"><span class="linenos">1878</span></a>        <span class="c1"># Restore title and info text for non-4D files</span>
</span><span id="NiftiViewer.hide_time_series_plot-1879"><a href="#NiftiViewer.hide_time_series_plot-1879"><span class="linenos">1879</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fourth_title</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Image Information&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.hide_time_series_plot-1880"><a href="#NiftiViewer.hide_time_series_plot-1880"><span class="linenos">1880</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Hide time series plot for 3D data</p>
</div>


                            </div>
                            <div id="NiftiViewer.update_time_series_plot" class="classattr">
                                        <input id="NiftiViewer.update_time_series_plot-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_time_series_plot</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.update_time_series_plot-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.update_time_series_plot"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.update_time_series_plot-1882"><a href="#NiftiViewer.update_time_series_plot-1882"><span class="linenos">1882</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_time_series_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.update_time_series_plot-1883"><a href="#NiftiViewer.update_time_series_plot-1883"><span class="linenos">1883</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the time series plot with current voxel or ROI data&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.update_time_series_plot-1884"><a href="#NiftiViewer.update_time_series_plot-1884"><span class="linenos">1884</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.update_time_series_plot-1885"><a href="#NiftiViewer.update_time_series_plot-1885"><span class="linenos">1885</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer.update_time_series_plot-1886"><a href="#NiftiViewer.update_time_series_plot-1886"><span class="linenos">1886</span></a>
</span><span id="NiftiViewer.update_time_series_plot-1887"><a href="#NiftiViewer.update_time_series_plot-1887"><span class="linenos">1887</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NiftiViewer.update_time_series_plot-1888"><a href="#NiftiViewer.update_time_series_plot-1888"><span class="linenos">1888</span></a>            <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span>
</span><span id="NiftiViewer.update_time_series_plot-1889"><a href="#NiftiViewer.update_time_series_plot-1889"><span class="linenos">1889</span></a>            <span class="n">bool_in_mask</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="NiftiViewer.update_time_series_plot-1890"><a href="#NiftiViewer.update_time_series_plot-1890"><span class="linenos">1890</span></a>
</span><span id="NiftiViewer.update_time_series_plot-1891"><a href="#NiftiViewer.update_time_series_plot-1891"><span class="linenos">1891</span></a>            <span class="c1"># Check if overlay is active and apply ROI-based averaging</span>
</span><span id="NiftiViewer.update_time_series_plot-1892"><a href="#NiftiViewer.update_time_series_plot-1892"><span class="linenos">1892</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">:</span>
</span><span id="NiftiViewer.update_time_series_plot-1893"><a href="#NiftiViewer.update_time_series_plot-1893"><span class="linenos">1893</span></a>                <span class="n">overlay_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="NiftiViewer.update_time_series_plot-1894"><a href="#NiftiViewer.update_time_series_plot-1894"><span class="linenos">1894</span></a>                <span class="n">threshold_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span> <span class="o">*</span> <span class="n">overlay_max</span>
</span><span id="NiftiViewer.update_time_series_plot-1895"><a href="#NiftiViewer.update_time_series_plot-1895"><span class="linenos">1895</span></a>                <span class="n">threshold_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">&gt;</span> <span class="n">threshold_value</span>
</span><span id="NiftiViewer.update_time_series_plot-1896"><a href="#NiftiViewer.update_time_series_plot-1896"><span class="linenos">1896</span></a>
</span><span id="NiftiViewer.update_time_series_plot-1897"><a href="#NiftiViewer.update_time_series_plot-1897"><span class="linenos">1897</span></a>                <span class="c1"># If current voxel is inside the thresholded ROI mask</span>
</span><span id="NiftiViewer.update_time_series_plot-1898"><a href="#NiftiViewer.update_time_series_plot-1898"><span class="linenos">1898</span></a>                <span class="k">if</span> <span class="n">threshold_mask</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]]:</span>
</span><span id="NiftiViewer.update_time_series_plot-1899"><a href="#NiftiViewer.update_time_series_plot-1899"><span class="linenos">1899</span></a>                    <span class="n">bool_in_mask</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="NiftiViewer.update_time_series_plot-1900"><a href="#NiftiViewer.update_time_series_plot-1900"><span class="linenos">1900</span></a>                    <span class="n">roi_voxels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">threshold_mask</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># extract time series from ROI voxels</span>
</span><span id="NiftiViewer.update_time_series_plot-1901"><a href="#NiftiViewer.update_time_series_plot-1901"><span class="linenos">1901</span></a>                    <span class="n">time_series</span> <span class="o">=</span> <span class="n">roi_voxels</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># mean intensity over ROI</span>
</span><span id="NiftiViewer.update_time_series_plot-1902"><a href="#NiftiViewer.update_time_series_plot-1902"><span class="linenos">1902</span></a>                    <span class="n">std_series</span> <span class="o">=</span> <span class="n">roi_voxels</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># standard deviation for shaded region</span>
</span><span id="NiftiViewer.update_time_series_plot-1903"><a href="#NiftiViewer.update_time_series_plot-1903"><span class="linenos">1903</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.update_time_series_plot-1904"><a href="#NiftiViewer.update_time_series_plot-1904"><span class="linenos">1904</span></a>                    <span class="c1"># Outside mask: show only single voxel time series</span>
</span><span id="NiftiViewer.update_time_series_plot-1905"><a href="#NiftiViewer.update_time_series_plot-1905"><span class="linenos">1905</span></a>                    <span class="n">time_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="NiftiViewer.update_time_series_plot-1906"><a href="#NiftiViewer.update_time_series_plot-1906"><span class="linenos">1906</span></a>                    <span class="n">std_series</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.update_time_series_plot-1907"><a href="#NiftiViewer.update_time_series_plot-1907"><span class="linenos">1907</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.update_time_series_plot-1908"><a href="#NiftiViewer.update_time_series_plot-1908"><span class="linenos">1908</span></a>                <span class="c1"># If overlay is not enabled, show voxel intensity over time</span>
</span><span id="NiftiViewer.update_time_series_plot-1909"><a href="#NiftiViewer.update_time_series_plot-1909"><span class="linenos">1909</span></a>                <span class="n">time_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="NiftiViewer.update_time_series_plot-1910"><a href="#NiftiViewer.update_time_series_plot-1910"><span class="linenos">1910</span></a>                <span class="n">std_series</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.update_time_series_plot-1911"><a href="#NiftiViewer.update_time_series_plot-1911"><span class="linenos">1911</span></a>
</span><span id="NiftiViewer.update_time_series_plot-1912"><a href="#NiftiViewer.update_time_series_plot-1912"><span class="linenos">1912</span></a>            <span class="c1"># X-axis values = time points</span>
</span><span id="NiftiViewer.update_time_series_plot-1913"><a href="#NiftiViewer.update_time_series_plot-1913"><span class="linenos">1913</span></a>            <span class="n">time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="NiftiViewer.update_time_series_plot-1914"><a href="#NiftiViewer.update_time_series_plot-1914"><span class="linenos">1914</span></a>
</span><span id="NiftiViewer.update_time_series_plot-1915"><a href="#NiftiViewer.update_time_series_plot-1915"><span class="linenos">1915</span></a>            <span class="c1"># Clear previous plot content</span>
</span><span id="NiftiViewer.update_time_series_plot-1916"><a href="#NiftiViewer.update_time_series_plot-1916"><span class="linenos">1916</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="NiftiViewer.update_time_series_plot-1917"><a href="#NiftiViewer.update_time_series_plot-1917"><span class="linenos">1917</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer.update_time_series_plot-1918"><a href="#NiftiViewer.update_time_series_plot-1918"><span class="linenos">1918</span></a>
</span><span id="NiftiViewer.update_time_series_plot-1919"><a href="#NiftiViewer.update_time_series_plot-1919"><span class="linenos">1919</span></a>            <span class="c1"># Plot time series curve</span>
</span><span id="NiftiViewer.update_time_series_plot-1920"><a href="#NiftiViewer.update_time_series_plot-1920"><span class="linenos">1920</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span> <span class="n">time_series</span><span class="p">,</span> <span class="s1">&#39;c-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="NiftiViewer.update_time_series_plot-1921"><a href="#NiftiViewer.update_time_series_plot-1921"><span class="linenos">1921</span></a>                                     <span class="n">label</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s1">&#39;Concentration&#39;</span><span class="p">))</span>
</span><span id="NiftiViewer.update_time_series_plot-1922"><a href="#NiftiViewer.update_time_series_plot-1922"><span class="linenos">1922</span></a>
</span><span id="NiftiViewer.update_time_series_plot-1923"><a href="#NiftiViewer.update_time_series_plot-1923"><span class="linenos">1923</span></a>            <span class="c1"># Optional shaded error region (ROI variability)</span>
</span><span id="NiftiViewer.update_time_series_plot-1924"><a href="#NiftiViewer.update_time_series_plot-1924"><span class="linenos">1924</span></a>            <span class="k">if</span> <span class="n">std_series</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.update_time_series_plot-1925"><a href="#NiftiViewer.update_time_series_plot-1925"><span class="linenos">1925</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span> <span class="n">time_series</span> <span class="o">-</span> <span class="n">std_series</span><span class="p">,</span>
</span><span id="NiftiViewer.update_time_series_plot-1926"><a href="#NiftiViewer.update_time_series_plot-1926"><span class="linenos">1926</span></a>                                                 <span class="n">time_series</span> <span class="o">+</span> <span class="n">std_series</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer.update_time_series_plot-1927"><a href="#NiftiViewer.update_time_series_plot-1927"><span class="linenos">1927</span></a>
</span><span id="NiftiViewer.update_time_series_plot-1928"><a href="#NiftiViewer.update_time_series_plot-1928"><span class="linenos">1928</span></a>            <span class="c1"># Add vertical yellow line showing current time index</span>
</span><span id="NiftiViewer.update_time_series_plot-1929"><a href="#NiftiViewer.update_time_series_plot-1929"><span class="linenos">1929</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_indicator_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
</span><span id="NiftiViewer.update_time_series_plot-1930"><a href="#NiftiViewer.update_time_series_plot-1930"><span class="linenos">1930</span></a>                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="NiftiViewer.update_time_series_plot-1931"><a href="#NiftiViewer.update_time_series_plot-1931"><span class="linenos">1931</span></a>                <span class="n">label</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s1">&#39;Current Time&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer.update_time_series_plot-1932"><a href="#NiftiViewer.update_time_series_plot-1932"><span class="linenos">1932</span></a>            <span class="p">)</span>
</span><span id="NiftiViewer.update_time_series_plot-1933"><a href="#NiftiViewer.update_time_series_plot-1933"><span class="linenos">1933</span></a>
</span><span id="NiftiViewer.update_time_series_plot-1934"><a href="#NiftiViewer.update_time_series_plot-1934"><span class="linenos">1934</span></a>            <span class="c1"># Set axis labels and title</span>
</span><span id="NiftiViewer.update_time_series_plot-1935"><a href="#NiftiViewer.update_time_series_plot-1935"><span class="linenos">1935</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Time Point&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer.update_time_series_plot-1936"><a href="#NiftiViewer.update_time_series_plot-1936"><span class="linenos">1936</span></a>                                           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer.update_time_series_plot-1937"><a href="#NiftiViewer.update_time_series_plot-1937"><span class="linenos">1937</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Signal Intensity&quot;</span><span class="p">),</span>
</span><span id="NiftiViewer.update_time_series_plot-1938"><a href="#NiftiViewer.update_time_series_plot-1938"><span class="linenos">1938</span></a>                                           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer.update_time_series_plot-1939"><a href="#NiftiViewer.update_time_series_plot-1939"><span class="linenos">1939</span></a>
</span><span id="NiftiViewer.update_time_series_plot-1940"><a href="#NiftiViewer.update_time_series_plot-1940"><span class="linenos">1940</span></a>            <span class="c1"># Title reflects whether inside ROI or single voxel</span>
</span><span id="NiftiViewer.update_time_series_plot-1941"><a href="#NiftiViewer.update_time_series_plot-1941"><span class="linenos">1941</span></a>            <span class="k">if</span> <span class="n">bool_in_mask</span><span class="p">:</span>
</span><span id="NiftiViewer.update_time_series_plot-1942"><a href="#NiftiViewer.update_time_series_plot-1942"><span class="linenos">1942</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean in overlay mask&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer.update_time_series_plot-1943"><a href="#NiftiViewer.update_time_series_plot-1943"><span class="linenos">1943</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.update_time_series_plot-1944"><a href="#NiftiViewer.update_time_series_plot-1944"><span class="linenos">1944</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Voxel (</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer.update_time_series_plot-1945"><a href="#NiftiViewer.update_time_series_plot-1945"><span class="linenos">1945</span></a>
</span><span id="NiftiViewer.update_time_series_plot-1946"><a href="#NiftiViewer.update_time_series_plot-1946"><span class="linenos">1946</span></a>            <span class="c1"># Style axes and legend</span>
</span><span id="NiftiViewer.update_time_series_plot-1947"><a href="#NiftiViewer.update_time_series_plot-1947"><span class="linenos">1947</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer.update_time_series_plot-1948"><a href="#NiftiViewer.update_time_series_plot-1948"><span class="linenos">1948</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="NiftiViewer.update_time_series_plot-1949"><a href="#NiftiViewer.update_time_series_plot-1949"><span class="linenos">1949</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_axes</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</span><span id="NiftiViewer.update_time_series_plot-1950"><a href="#NiftiViewer.update_time_series_plot-1950"><span class="linenos">1950</span></a>
</span><span id="NiftiViewer.update_time_series_plot-1951"><a href="#NiftiViewer.update_time_series_plot-1951"><span class="linenos">1951</span></a>            <span class="c1"># Redraw updated plot on canvas</span>
</span><span id="NiftiViewer.update_time_series_plot-1952"><a href="#NiftiViewer.update_time_series_plot-1952"><span class="linenos">1952</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_plot_canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</span><span id="NiftiViewer.update_time_series_plot-1953"><a href="#NiftiViewer.update_time_series_plot-1953"><span class="linenos">1953</span></a>
</span><span id="NiftiViewer.update_time_series_plot-1954"><a href="#NiftiViewer.update_time_series_plot-1954"><span class="linenos">1954</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="NiftiViewer.update_time_series_plot-1955"><a href="#NiftiViewer.update_time_series_plot-1955"><span class="linenos">1955</span></a>            <span class="c1"># Log error if plotting fails (e.g., index error)</span>
</span><span id="NiftiViewer.update_time_series_plot-1956"><a href="#NiftiViewer.update_time_series_plot-1956"><span class="linenos">1956</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating time series plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Update the time series plot with current voxel or ROI data</p>
</div>


                            </div>
                            <div id="NiftiViewer.apply_colormap_matplotlib" class="classattr">
                                        <input id="NiftiViewer.apply_colormap_matplotlib-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">apply_colormap_matplotlib</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">data</span>, </span><span class="param"><span class="n">colormap_name</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.apply_colormap_matplotlib-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.apply_colormap_matplotlib"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.apply_colormap_matplotlib-1958"><a href="#NiftiViewer.apply_colormap_matplotlib-1958"><span class="linenos">1958</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_colormap_matplotlib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">colormap_name</span><span class="p">):</span>
</span><span id="NiftiViewer.apply_colormap_matplotlib-1959"><a href="#NiftiViewer.apply_colormap_matplotlib-1959"><span class="linenos">1959</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply colormap using matplotlib and return QImage&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.apply_colormap_matplotlib-1960"><a href="#NiftiViewer.apply_colormap_matplotlib-1960"><span class="linenos">1960</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NiftiViewer.apply_colormap_matplotlib-1961"><a href="#NiftiViewer.apply_colormap_matplotlib-1961"><span class="linenos">1961</span></a>            <span class="c1"># Retrieve selected colormap from matplotlib</span>
</span><span id="NiftiViewer.apply_colormap_matplotlib-1962"><a href="#NiftiViewer.apply_colormap_matplotlib-1962"><span class="linenos">1962</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap_name</span><span class="p">)</span>
</span><span id="NiftiViewer.apply_colormap_matplotlib-1963"><a href="#NiftiViewer.apply_colormap_matplotlib-1963"><span class="linenos">1963</span></a>
</span><span id="NiftiViewer.apply_colormap_matplotlib-1964"><a href="#NiftiViewer.apply_colormap_matplotlib-1964"><span class="linenos">1964</span></a>            <span class="c1"># Apply colormap to normalized image data</span>
</span><span id="NiftiViewer.apply_colormap_matplotlib-1965"><a href="#NiftiViewer.apply_colormap_matplotlib-1965"><span class="linenos">1965</span></a>            <span class="n">colored_data</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="NiftiViewer.apply_colormap_matplotlib-1966"><a href="#NiftiViewer.apply_colormap_matplotlib-1966"><span class="linenos">1966</span></a>
</span><span id="NiftiViewer.apply_colormap_matplotlib-1967"><a href="#NiftiViewer.apply_colormap_matplotlib-1967"><span class="linenos">1967</span></a>            <span class="k">return</span> <span class="n">colored_data</span>
</span><span id="NiftiViewer.apply_colormap_matplotlib-1968"><a href="#NiftiViewer.apply_colormap_matplotlib-1968"><span class="linenos">1968</span></a>
</span><span id="NiftiViewer.apply_colormap_matplotlib-1969"><a href="#NiftiViewer.apply_colormap_matplotlib-1969"><span class="linenos">1969</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="NiftiViewer.apply_colormap_matplotlib-1970"><a href="#NiftiViewer.apply_colormap_matplotlib-1970"><span class="linenos">1970</span></a>            <span class="c1"># Log errors (e.g., invalid colormap name)</span>
</span><span id="NiftiViewer.apply_colormap_matplotlib-1971"><a href="#NiftiViewer.apply_colormap_matplotlib-1971"><span class="linenos">1971</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error applying colormap: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.apply_colormap_matplotlib-1972"><a href="#NiftiViewer.apply_colormap_matplotlib-1972"><span class="linenos">1972</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Apply colormap using matplotlib and return QImage</p>
</div>


                            </div>
                            <div id="NiftiViewer.update_all_displays" class="classattr">
                                        <input id="NiftiViewer.update_all_displays-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_all_displays</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.update_all_displays-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.update_all_displays"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.update_all_displays-1974"><a href="#NiftiViewer.update_all_displays-1974"><span class="linenos">1974</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_all_displays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.update_all_displays-1975"><a href="#NiftiViewer.update_all_displays-1975"><span class="linenos">1975</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update all plane displays&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.update_all_displays-1976"><a href="#NiftiViewer.update_all_displays-1976"><span class="linenos">1976</span></a>        <span class="c1"># Loop over all 3 orthogonal views (axial, coronal, sagittal)</span>
</span><span id="NiftiViewer.update_all_displays-1977"><a href="#NiftiViewer.update_all_displays-1977"><span class="linenos">1977</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="NiftiViewer.update_all_displays-1978"><a href="#NiftiViewer.update_all_displays-1978"><span class="linenos">1978</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_display</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="NiftiViewer.update_all_displays-1979"><a href="#NiftiViewer.update_all_displays-1979"><span class="linenos">1979</span></a>
</span><span id="NiftiViewer.update_all_displays-1980"><a href="#NiftiViewer.update_all_displays-1980"><span class="linenos">1980</span></a>        <span class="c1"># If data is 4D, also update the time-series plot</span>
</span><span id="NiftiViewer.update_all_displays-1981"><a href="#NiftiViewer.update_all_displays-1981"><span class="linenos">1981</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="NiftiViewer.update_all_displays-1982"><a href="#NiftiViewer.update_all_displays-1982"><span class="linenos">1982</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_time_series_plot</span><span class="p">()</span>
</span><span id="NiftiViewer.update_all_displays-1983"><a href="#NiftiViewer.update_all_displays-1983"><span class="linenos">1983</span></a>
</span><span id="NiftiViewer.update_all_displays-1984"><a href="#NiftiViewer.update_all_displays-1984"><span class="linenos">1984</span></a>        <span class="c1"># Update slice information label in the status bar</span>
</span><span id="NiftiViewer.update_all_displays-1985"><a href="#NiftiViewer.update_all_displays-1985"><span class="linenos">1985</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.update_all_displays-1986"><a href="#NiftiViewer.update_all_displays-1986"><span class="linenos">1986</span></a>            <span class="n">spatial_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span>
</span><span id="NiftiViewer.update_all_displays-1987"><a href="#NiftiViewer.update_all_displays-1987"><span class="linenos">1987</span></a>            <span class="c1"># Construct slice position string for each plane (1-based indexing)</span>
</span><span id="NiftiViewer.update_all_displays-1988"><a href="#NiftiViewer.update_all_displays-1988"><span class="linenos">1988</span></a>            <span class="n">slice_info</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Slices&quot;</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="NiftiViewer.update_all_displays-1989"><a href="#NiftiViewer.update_all_displays-1989"><span class="linenos">1989</span></a>                         <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">spatial_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> | &quot;</span> \
</span><span id="NiftiViewer.update_all_displays-1990"><a href="#NiftiViewer.update_all_displays-1990"><span class="linenos">1990</span></a>                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">spatial_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> | &quot;</span> \
</span><span id="NiftiViewer.update_all_displays-1991"><a href="#NiftiViewer.update_all_displays-1991"><span class="linenos">1991</span></a>                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">spatial_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="NiftiViewer.update_all_displays-1992"><a href="#NiftiViewer.update_all_displays-1992"><span class="linenos">1992</span></a>            <span class="c1"># Add current time info if applicable</span>
</span><span id="NiftiViewer.update_all_displays-1993"><a href="#NiftiViewer.update_all_displays-1993"><span class="linenos">1993</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span><span class="p">:</span>
</span><span id="NiftiViewer.update_all_displays-1994"><a href="#NiftiViewer.update_all_displays-1994"><span class="linenos">1994</span></a>                <span class="n">slice_info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; | &quot;</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Time&quot;</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="NiftiViewer.update_all_displays-1995"><a href="#NiftiViewer.update_all_displays-1995"><span class="linenos">1995</span></a>                              <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="NiftiViewer.update_all_displays-1996"><a href="#NiftiViewer.update_all_displays-1996"><span class="linenos">1996</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">slice_info</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Update all plane displays</p>
</div>


                            </div>
                            <div id="NiftiViewer.create_overlay_composite" class="classattr">
                                        <input id="NiftiViewer.create_overlay_composite-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_overlay_composite</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">rgba_image</span>, </span><span class="param"><span class="n">overlay_slice</span>, </span><span class="param"><span class="n">colormap</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.create_overlay_composite-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.create_overlay_composite"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.create_overlay_composite-1998"><a href="#NiftiViewer.create_overlay_composite-1998"><span class="linenos">1998</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_overlay_composite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rgba_image</span><span class="p">,</span> <span class="n">overlay_slice</span><span class="p">,</span> <span class="n">colormap</span><span class="p">):</span>
</span><span id="NiftiViewer.create_overlay_composite-1999"><a href="#NiftiViewer.create_overlay_composite-1999"><span class="linenos">1999</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a composite image with colormap base and red overlay.&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.create_overlay_composite-2000"><a href="#NiftiViewer.create_overlay_composite-2000"><span class="linenos">2000</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NiftiViewer.create_overlay_composite-2001"><a href="#NiftiViewer.create_overlay_composite-2001"><span class="linenos">2001</span></a>            <span class="c1"># Convert RGBA base image to float for blending</span>
</span><span id="NiftiViewer.create_overlay_composite-2002"><a href="#NiftiViewer.create_overlay_composite-2002"><span class="linenos">2002</span></a>            <span class="n">rgba_image_float</span> <span class="o">=</span> <span class="n">rgba_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1"># shape (H, W, 4)</span>
</span><span id="NiftiViewer.create_overlay_composite-2003"><a href="#NiftiViewer.create_overlay_composite-2003"><span class="linenos">2003</span></a>
</span><span id="NiftiViewer.create_overlay_composite-2004"><a href="#NiftiViewer.create_overlay_composite-2004"><span class="linenos">2004</span></a>            <span class="k">if</span> <span class="n">overlay_slice</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NiftiViewer.create_overlay_composite-2005"><a href="#NiftiViewer.create_overlay_composite-2005"><span class="linenos">2005</span></a>
</span><span id="NiftiViewer.create_overlay_composite-2006"><a href="#NiftiViewer.create_overlay_composite-2006"><span class="linenos">2006</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">overlay_slice</span><span class="p">):</span>
</span><span id="NiftiViewer.create_overlay_composite-2007"><a href="#NiftiViewer.create_overlay_composite-2007"><span class="linenos">2007</span></a>                    <span class="c1"># Apply transparency scaling (based on user alpha)</span>
</span><span id="NiftiViewer.create_overlay_composite-2008"><a href="#NiftiViewer.create_overlay_composite-2008"><span class="linenos">2008</span></a>                    <span class="n">overlay_intensity</span> <span class="o">=</span> <span class="n">overlay_slice</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha</span>
</span><span id="NiftiViewer.create_overlay_composite-2009"><a href="#NiftiViewer.create_overlay_composite-2009"><span class="linenos">2009</span></a>
</span><span id="NiftiViewer.create_overlay_composite-2010"><a href="#NiftiViewer.create_overlay_composite-2010"><span class="linenos">2010</span></a>                    <span class="c1"># Retrieve overlay color from dictionary or default (green)</span>
</span><span id="NiftiViewer.create_overlay_composite-2011"><a href="#NiftiViewer.create_overlay_composite-2011"><span class="linenos">2011</span></a>                    <span class="n">overlay_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]))</span>
</span><span id="NiftiViewer.create_overlay_composite-2012"><a href="#NiftiViewer.create_overlay_composite-2012"><span class="linenos">2012</span></a>
</span><span id="NiftiViewer.create_overlay_composite-2013"><a href="#NiftiViewer.create_overlay_composite-2013"><span class="linenos">2013</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Blending overlay color into base image&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_overlay_composite-2014"><a href="#NiftiViewer.create_overlay_composite-2014"><span class="linenos">2014</span></a>                    <span class="c1"># Blend overlay into base image using a numba-accelerated function</span>
</span><span id="NiftiViewer.create_overlay_composite-2015"><a href="#NiftiViewer.create_overlay_composite-2015"><span class="linenos">2015</span></a>                    <span class="n">rgba_image_float</span> <span class="o">=</span> <span class="n">apply_overlay_numba</span><span class="p">(</span><span class="n">rgba_image</span><span class="p">,</span> <span class="n">overlay_slice</span><span class="p">,</span>
</span><span id="NiftiViewer.create_overlay_composite-2016"><a href="#NiftiViewer.create_overlay_composite-2016"><span class="linenos">2016</span></a>                                                           <span class="n">overlay_intensity</span><span class="p">,</span> <span class="n">overlay_color</span><span class="p">)</span>
</span><span id="NiftiViewer.create_overlay_composite-2017"><a href="#NiftiViewer.create_overlay_composite-2017"><span class="linenos">2017</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Blended overlay color into base image&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_overlay_composite-2018"><a href="#NiftiViewer.create_overlay_composite-2018"><span class="linenos">2018</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Clipping values to a valid range&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_overlay_composite-2019"><a href="#NiftiViewer.create_overlay_composite-2019"><span class="linenos">2019</span></a>            <span class="c1"># Clip values to valid range [0, 1]</span>
</span><span id="NiftiViewer.create_overlay_composite-2020"><a href="#NiftiViewer.create_overlay_composite-2020"><span class="linenos">2020</span></a>            <span class="n">rgba_image_overlay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rgba_image_float</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer.create_overlay_composite-2021"><a href="#NiftiViewer.create_overlay_composite-2021"><span class="linenos">2021</span></a>
</span><span id="NiftiViewer.create_overlay_composite-2022"><a href="#NiftiViewer.create_overlay_composite-2022"><span class="linenos">2022</span></a>            <span class="k">return</span> <span class="n">rgba_image_overlay</span>
</span><span id="NiftiViewer.create_overlay_composite-2023"><a href="#NiftiViewer.create_overlay_composite-2023"><span class="linenos">2023</span></a>
</span><span id="NiftiViewer.create_overlay_composite-2024"><a href="#NiftiViewer.create_overlay_composite-2024"><span class="linenos">2024</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="NiftiViewer.create_overlay_composite-2025"><a href="#NiftiViewer.create_overlay_composite-2025"><span class="linenos">2025</span></a>            <span class="c1"># Log errors and return unmodified base image as fallback</span>
</span><span id="NiftiViewer.create_overlay_composite-2026"><a href="#NiftiViewer.create_overlay_composite-2026"><span class="linenos">2026</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating overlay composite: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.create_overlay_composite-2027"><a href="#NiftiViewer.create_overlay_composite-2027"><span class="linenos">2027</span></a>            <span class="k">return</span> <span class="n">rgba_image</span>
</span></pre></div>


            <div class="docstring"><p>Create a composite image with colormap base and red overlay.</p>
</div>


                            </div>
                            <div id="NiftiViewer.resizeEvent" class="classattr">
                                        <input id="NiftiViewer.resizeEvent-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">resizeEvent</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">event</span><span class="p">:</span> <span class="n">PyQt6</span><span class="o">.</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QResizeEvent</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.resizeEvent-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.resizeEvent"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.resizeEvent-2029"><a href="#NiftiViewer.resizeEvent-2029"><span class="linenos">2029</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">resizeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">QResizeEvent</span><span class="p">):</span>
</span><span id="NiftiViewer.resizeEvent-2030"><a href="#NiftiViewer.resizeEvent-2030"><span class="linenos">2030</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle window resize to maintain aspect ratios&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.resizeEvent-2031"><a href="#NiftiViewer.resizeEvent-2031"><span class="linenos">2031</span></a>        <span class="c1"># Call parent resize handler</span>
</span><span id="NiftiViewer.resizeEvent-2032"><a href="#NiftiViewer.resizeEvent-2032"><span class="linenos">2032</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">resizeEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="NiftiViewer.resizeEvent-2033"><a href="#NiftiViewer.resizeEvent-2033"><span class="linenos">2033</span></a>        <span class="c1"># Refit all 2D slice views after short delay to prevent flickering</span>
</span><span id="NiftiViewer.resizeEvent-2034"><a href="#NiftiViewer.resizeEvent-2034"><span class="linenos">2034</span></a>        <span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_all_views</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Handle window resize to maintain aspect ratios</p>
</div>


                            </div>
                            <div id="NiftiViewer.fit_all_views" class="classattr">
                                        <input id="NiftiViewer.fit_all_views-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fit_all_views</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.fit_all_views-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.fit_all_views"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.fit_all_views-2036"><a href="#NiftiViewer.fit_all_views-2036"><span class="linenos">2036</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit_all_views</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.fit_all_views-2037"><a href="#NiftiViewer.fit_all_views-2037"><span class="linenos">2037</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit all views to their scenes while maintaining aspect ratio&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.fit_all_views-2038"><a href="#NiftiViewer.fit_all_views-2038"><span class="linenos">2038</span></a>        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">:</span>
</span><span id="NiftiViewer.fit_all_views-2039"><a href="#NiftiViewer.fit_all_views-2039"><span class="linenos">2039</span></a>            <span class="k">if</span> <span class="n">view</span><span class="o">.</span><span class="n">scene</span><span class="p">():</span>
</span><span id="NiftiViewer.fit_all_views-2040"><a href="#NiftiViewer.fit_all_views-2040"><span class="linenos">2040</span></a>                <span class="c1"># Adjust zoom to fit entire image in view with correct aspect ratio</span>
</span><span id="NiftiViewer.fit_all_views-2041"><a href="#NiftiViewer.fit_all_views-2041"><span class="linenos">2041</span></a>                <span class="n">view</span><span class="o">.</span><span class="n">fitInView</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">scene</span><span class="p">()</span><span class="o">.</span><span class="n">sceneRect</span><span class="p">(),</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AspectRatioMode</span><span class="o">.</span><span class="n">KeepAspectRatio</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Fit all views to their scenes while maintaining aspect ratio</p>
</div>


                            </div>
                            <div id="NiftiViewer.update_automaticROI" class="classattr">
                                        <input id="NiftiViewer.update_automaticROI-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_automaticROI</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.update_automaticROI-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.update_automaticROI"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.update_automaticROI-2043"><a href="#NiftiViewer.update_automaticROI-2043"><span class="linenos">2043</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_automaticROI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.update_automaticROI-2044"><a href="#NiftiViewer.update_automaticROI-2044"><span class="linenos">2044</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the automatic ROI overlay dynamically when parameters change&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.update_automaticROI-2045"><a href="#NiftiViewer.update_automaticROI-2045"><span class="linenos">2045</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span><span class="p">:</span>
</span><span id="NiftiViewer.update_automaticROI-2046"><a href="#NiftiViewer.update_automaticROI-2046"><span class="linenos">2046</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_drawing</span><span class="p">()</span>
</span><span id="NiftiViewer.update_automaticROI-2047"><a href="#NiftiViewer.update_automaticROI-2047"><span class="linenos">2047</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Update the automatic ROI overlay dynamically when parameters change</p>
</div>


                            </div>
                            <div id="NiftiViewer.automaticROI_clicked" class="classattr">
                                        <input id="NiftiViewer.automaticROI_clicked-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">automaticROI_clicked</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.automaticROI_clicked-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.automaticROI_clicked"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.automaticROI_clicked-2049"><a href="#NiftiViewer.automaticROI_clicked-2049"><span class="linenos">2049</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">automaticROI_clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.automaticROI_clicked-2050"><a href="#NiftiViewer.automaticROI_clicked-2050"><span class="linenos">2050</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle click on &#39;Automatic ROI&#39; button to start or reset the ROI tool&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.automaticROI_clicked-2051"><a href="#NiftiViewer.automaticROI_clicked-2051"><span class="linenos">2051</span></a>        <span class="c1"># Save current voxel coordinates as ROI seed point</span>
</span><span id="NiftiViewer.automaticROI_clicked-2052"><a href="#NiftiViewer.automaticROI_clicked-2052"><span class="linenos">2052</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_seed_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span>
</span><span id="NiftiViewer.automaticROI_clicked-2053"><a href="#NiftiViewer.automaticROI_clicked-2053"><span class="linenos">2053</span></a>
</span><span id="NiftiViewer.automaticROI_clicked-2054"><a href="#NiftiViewer.automaticROI_clicked-2054"><span class="linenos">2054</span></a>        <span class="c1"># Compute the maximum allowed ROI radius in millimeters</span>
</span><span id="NiftiViewer.automaticROI_clicked-2055"><a href="#NiftiViewer.automaticROI_clicked-2055"><span class="linenos">2055</span></a>        <span class="n">dims_voxel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># voxel counts along X, Y, Z</span>
</span><span id="NiftiViewer.automaticROI_clicked-2056"><a href="#NiftiViewer.automaticROI_clicked-2056"><span class="linenos">2056</span></a>        <span class="n">dims_mm</span> <span class="o">=</span> <span class="n">dims_voxel</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span>  <span class="c1"># real-world dimensions in mm</span>
</span><span id="NiftiViewer.automaticROI_clicked-2057"><a href="#NiftiViewer.automaticROI_clicked-2057"><span class="linenos">2057</span></a>        <span class="n">max_radius_mm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dims_mm</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># use half of shortest image dimension</span>
</span><span id="NiftiViewer.automaticROI_clicked-2058"><a href="#NiftiViewer.automaticROI_clicked-2058"><span class="linenos">2058</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_radius_mm</span><span class="p">))</span>
</span><span id="NiftiViewer.automaticROI_clicked-2059"><a href="#NiftiViewer.automaticROI_clicked-2059"><span class="linenos">2059</span></a>
</span><span id="NiftiViewer.automaticROI_clicked-2060"><a href="#NiftiViewer.automaticROI_clicked-2060"><span class="linenos">2060</span></a>        <span class="c1"># Initialize radius slider (32 mm default for new ROI)</span>
</span><span id="NiftiViewer.automaticROI_clicked-2061"><a href="#NiftiViewer.automaticROI_clicked-2061"><span class="linenos">2061</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span>
</span><span id="NiftiViewer.automaticROI_clicked-2062"><a href="#NiftiViewer.automaticROI_clicked-2062"><span class="linenos">2062</span></a>            <span class="mi">32</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
</span><span id="NiftiViewer.automaticROI_clicked-2063"><a href="#NiftiViewer.automaticROI_clicked-2063"><span class="linenos">2063</span></a>        <span class="p">)</span>
</span><span id="NiftiViewer.automaticROI_clicked-2064"><a href="#NiftiViewer.automaticROI_clicked-2064"><span class="linenos">2064</span></a>
</span><span id="NiftiViewer.automaticROI_clicked-2065"><a href="#NiftiViewer.automaticROI_clicked-2065"><span class="linenos">2065</span></a>        <span class="c1"># Initialize difference (intensity tolerance) slider</span>
</span><span id="NiftiViewer.automaticROI_clicked-2066"><a href="#NiftiViewer.automaticROI_clicked-2066"><span class="linenos">2066</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="NiftiViewer.automaticROI_clicked-2067"><a href="#NiftiViewer.automaticROI_clicked-2067"><span class="linenos">2067</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span>
</span><span id="NiftiViewer.automaticROI_clicked-2068"><a href="#NiftiViewer.automaticROI_clicked-2068"><span class="linenos">2068</span></a>            <span class="nb">int</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
</span><span id="NiftiViewer.automaticROI_clicked-2069"><a href="#NiftiViewer.automaticROI_clicked-2069"><span class="linenos">2069</span></a>        <span class="p">)</span>
</span><span id="NiftiViewer.automaticROI_clicked-2070"><a href="#NiftiViewer.automaticROI_clicked-2070"><span class="linenos">2070</span></a>
</span><span id="NiftiViewer.automaticROI_clicked-2071"><a href="#NiftiViewer.automaticROI_clicked-2071"><span class="linenos">2071</span></a>        <span class="c1"># Show and enable ROI parameter controls</span>
</span><span id="NiftiViewer.automaticROI_clicked-2072"><a href="#NiftiViewer.automaticROI_clicked-2072"><span class="linenos">2072</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.automaticROI_clicked-2073"><a href="#NiftiViewer.automaticROI_clicked-2073"><span class="linenos">2073</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.automaticROI_clicked-2074"><a href="#NiftiViewer.automaticROI_clicked-2074"><span class="linenos">2074</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Reset Origin&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.automaticROI_clicked-2075"><a href="#NiftiViewer.automaticROI_clicked-2075"><span class="linenos">2075</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="NiftiViewer.automaticROI_clicked-2076"><a href="#NiftiViewer.automaticROI_clicked-2076"><span class="linenos">2076</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.automaticROI_clicked-2077"><a href="#NiftiViewer.automaticROI_clicked-2077"><span class="linenos">2077</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.automaticROI_clicked-2078"><a href="#NiftiViewer.automaticROI_clicked-2078"><span class="linenos">2078</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.automaticROI_clicked-2079"><a href="#NiftiViewer.automaticROI_clicked-2079"><span class="linenos">2079</span></a>
</span><span id="NiftiViewer.automaticROI_clicked-2080"><a href="#NiftiViewer.automaticROI_clicked-2080"><span class="linenos">2080</span></a>        <span class="c1"># Generate initial automatic ROI mask</span>
</span><span id="NiftiViewer.automaticROI_clicked-2081"><a href="#NiftiViewer.automaticROI_clicked-2081"><span class="linenos">2081</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_drawing</span><span class="p">()</span>
</span><span id="NiftiViewer.automaticROI_clicked-2082"><a href="#NiftiViewer.automaticROI_clicked-2082"><span class="linenos">2082</span></a>
</span><span id="NiftiViewer.automaticROI_clicked-2083"><a href="#NiftiViewer.automaticROI_clicked-2083"><span class="linenos">2083</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.automaticROI_clicked-2084"><a href="#NiftiViewer.automaticROI_clicked-2084"><span class="linenos">2084</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.automaticROI_clicked-2085"><a href="#NiftiViewer.automaticROI_clicked-2085"><span class="linenos">2085</span></a>        <span class="c1"># Ensure overlay display is active</span>
</span><span id="NiftiViewer.automaticROI_clicked-2086"><a href="#NiftiViewer.automaticROI_clicked-2086"><span class="linenos">2086</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_automaticROI</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.automaticROI_clicked-2087"><a href="#NiftiViewer.automaticROI_clicked-2087"><span class="linenos">2087</span></a>        <span class="c1">#self.overlay_checkbox.setChecked(True)</span>
</span><span id="NiftiViewer.automaticROI_clicked-2088"><a href="#NiftiViewer.automaticROI_clicked-2088"><span class="linenos">2088</span></a>        <span class="c1">#self.overlay_checkbox.setEnabled(True)</span>
</span><span id="NiftiViewer.automaticROI_clicked-2089"><a href="#NiftiViewer.automaticROI_clicked-2089"><span class="linenos">2089</span></a>
</span><span id="NiftiViewer.automaticROI_clicked-2090"><a href="#NiftiViewer.automaticROI_clicked-2090"><span class="linenos">2090</span></a>        <span class="c1"># Refresh all displays</span>
</span><span id="NiftiViewer.automaticROI_clicked-2091"><a href="#NiftiViewer.automaticROI_clicked-2091"><span class="linenos">2091</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Handle click on 'Automatic ROI' button to start or reset the ROI tool</p>
</div>


                            </div>
                            <div id="NiftiViewer.toggle_automaticROI" class="classattr">
                                        <input id="NiftiViewer.toggle_automaticROI-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">toggle_automaticROI</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">enabled</span>, </span><span class="param"><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.toggle_automaticROI-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.toggle_automaticROI"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.toggle_automaticROI-2094"><a href="#NiftiViewer.toggle_automaticROI-2094"><span class="linenos">2094</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_automaticROI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="NiftiViewer.toggle_automaticROI-2095"><a href="#NiftiViewer.toggle_automaticROI-2095"><span class="linenos">2095</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.toggle_automaticROI-2096"><a href="#NiftiViewer.toggle_automaticROI-2096"><span class="linenos">2096</span></a><span class="sd">        Enable or disable the overlay for the automatic ROI on top of the base image.</span>
</span><span id="NiftiViewer.toggle_automaticROI-2097"><a href="#NiftiViewer.toggle_automaticROI-2097"><span class="linenos">2097</span></a>
</span><span id="NiftiViewer.toggle_automaticROI-2098"><a href="#NiftiViewer.toggle_automaticROI-2098"><span class="linenos">2098</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.toggle_automaticROI-2099"><a href="#NiftiViewer.toggle_automaticROI-2099"><span class="linenos">2099</span></a><span class="sd">            enabled (bool): Whether to enable (True) or disable (False) the overlay display.</span>
</span><span id="NiftiViewer.toggle_automaticROI-2100"><a href="#NiftiViewer.toggle_automaticROI-2100"><span class="linenos">2100</span></a>
</span><span id="NiftiViewer.toggle_automaticROI-2101"><a href="#NiftiViewer.toggle_automaticROI-2101"><span class="linenos">2101</span></a><span class="sd">        Behavior:</span>
</span><span id="NiftiViewer.toggle_automaticROI-2102"><a href="#NiftiViewer.toggle_automaticROI-2102"><span class="linenos">2102</span></a><span class="sd">            - Toggles transparency and threshold controls.</span>
</span><span id="NiftiViewer.toggle_automaticROI-2103"><a href="#NiftiViewer.toggle_automaticROI-2103"><span class="linenos">2103</span></a><span class="sd">            - Refreshes all active views if overlay data exists.</span>
</span><span id="NiftiViewer.toggle_automaticROI-2104"><a href="#NiftiViewer.toggle_automaticROI-2104"><span class="linenos">2104</span></a>
</span><span id="NiftiViewer.toggle_automaticROI-2105"><a href="#NiftiViewer.toggle_automaticROI-2105"><span class="linenos">2105</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer.toggle_automaticROI-2106"><a href="#NiftiViewer.toggle_automaticROI-2106"><span class="linenos">2106</span></a><span class="sd">            None</span>
</span><span id="NiftiViewer.toggle_automaticROI-2107"><a href="#NiftiViewer.toggle_automaticROI-2107"><span class="linenos">2107</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.toggle_automaticROI-2108"><a href="#NiftiViewer.toggle_automaticROI-2108"><span class="linenos">2108</span></a>
</span><span id="NiftiViewer.toggle_automaticROI-2109"><a href="#NiftiViewer.toggle_automaticROI-2109"><span class="linenos">2109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_automaticROI-2110"><a href="#NiftiViewer.toggle_automaticROI-2110"><span class="linenos">2110</span></a>        <span class="c1"># Update internal overlay state</span>
</span><span id="NiftiViewer.toggle_automaticROI-2111"><a href="#NiftiViewer.toggle_automaticROI-2111"><span class="linenos">2111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="o">=</span> <span class="n">enabled</span>
</span><span id="NiftiViewer.toggle_automaticROI-2112"><a href="#NiftiViewer.toggle_automaticROI-2112"><span class="linenos">2112</span></a>        <span class="c1"># Enable or disable overlay-related UI controls</span>
</span><span id="NiftiViewer.toggle_automaticROI-2113"><a href="#NiftiViewer.toggle_automaticROI-2113"><span class="linenos">2113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_automaticROI-2114"><a href="#NiftiViewer.toggle_automaticROI-2114"><span class="linenos">2114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_automaticROI-2115"><a href="#NiftiViewer.toggle_automaticROI-2115"><span class="linenos">2115</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_automaticROI-2116"><a href="#NiftiViewer.toggle_automaticROI-2116"><span class="linenos">2116</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_automaticROI-2117"><a href="#NiftiViewer.toggle_automaticROI-2117"><span class="linenos">2117</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_automaticROI-2118"><a href="#NiftiViewer.toggle_automaticROI-2118"><span class="linenos">2118</span></a>
</span><span id="NiftiViewer.toggle_automaticROI-2119"><a href="#NiftiViewer.toggle_automaticROI-2119"><span class="linenos">2119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_automaticROI-2120"><a href="#NiftiViewer.toggle_automaticROI-2120"><span class="linenos">2120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_automaticROI-2121"><a href="#NiftiViewer.toggle_automaticROI-2121"><span class="linenos">2121</span></a>
</span><span id="NiftiViewer.toggle_automaticROI-2122"><a href="#NiftiViewer.toggle_automaticROI-2122"><span class="linenos">2122</span></a>        <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="NiftiViewer.toggle_automaticROI-2123"><a href="#NiftiViewer.toggle_automaticROI-2123"><span class="linenos">2123</span></a>            <span class="c1"># Redraw display if overlay data is available</span>
</span><span id="NiftiViewer.toggle_automaticROI-2124"><a href="#NiftiViewer.toggle_automaticROI-2124"><span class="linenos">2124</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer.toggle_automaticROI-2125"><a href="#NiftiViewer.toggle_automaticROI-2125"><span class="linenos">2125</span></a>
</span><span id="NiftiViewer.toggle_automaticROI-2126"><a href="#NiftiViewer.toggle_automaticROI-2126"><span class="linenos">2126</span></a>            <span class="c1"># Update time series plot if available</span>
</span><span id="NiftiViewer.toggle_automaticROI-2127"><a href="#NiftiViewer.toggle_automaticROI-2127"><span class="linenos">2127</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_time_series_plot</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Enable or disable the overlay for the automatic ROI on top of the base image.</p>

<p>Args:
    enabled (bool): Whether to enable (True) or disable (False) the overlay display.</p>

<p>Behavior:
    - Toggles transparency and threshold controls.
    - Refreshes all active views if overlay data exists.</p>

<p>Returns:
    None</p>
</div>


                            </div>
                            <div id="NiftiViewer.automaticROI_drawing" class="classattr">
                                        <input id="NiftiViewer.automaticROI_drawing-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">automaticROI_drawing</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.automaticROI_drawing-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.automaticROI_drawing"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.automaticROI_drawing-2129"><a href="#NiftiViewer.automaticROI_drawing-2129"><span class="linenos">2129</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">automaticROI_drawing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.automaticROI_drawing-2130"><a href="#NiftiViewer.automaticROI_drawing-2130"><span class="linenos">2130</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate automatic ROI mask around selected seed voxel&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.automaticROI_drawing-2131"><a href="#NiftiViewer.automaticROI_drawing-2131"><span class="linenos">2131</span></a>        <span class="n">radius_mm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>  <span class="c1"># ROI radius in mm</span>
</span><span id="NiftiViewer.automaticROI_drawing-2132"><a href="#NiftiViewer.automaticROI_drawing-2132"><span class="linenos">2132</span></a>        <span class="n">difference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span>  <span class="c1"># intensity tolerance</span>
</span><span id="NiftiViewer.automaticROI_drawing-2133"><a href="#NiftiViewer.automaticROI_drawing-2133"><span class="linenos">2133</span></a>        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_seed_coordinates</span>  <span class="c1"># seed voxel coordinates</span>
</span><span id="NiftiViewer.automaticROI_drawing-2134"><a href="#NiftiViewer.automaticROI_drawing-2134"><span class="linenos">2134</span></a>
</span><span id="NiftiViewer.automaticROI_drawing-2135"><a href="#NiftiViewer.automaticROI_drawing-2135"><span class="linenos">2135</span></a>        <span class="c1"># Select proper 3D volume if data is 4D</span>
</span><span id="NiftiViewer.automaticROI_drawing-2136"><a href="#NiftiViewer.automaticROI_drawing-2136"><span class="linenos">2136</span></a>        <span class="n">img_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_4d</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span>
</span><span id="NiftiViewer.automaticROI_drawing-2137"><a href="#NiftiViewer.automaticROI_drawing-2137"><span class="linenos">2137</span></a>
</span><span id="NiftiViewer.automaticROI_drawing-2138"><a href="#NiftiViewer.automaticROI_drawing-2138"><span class="linenos">2138</span></a>        <span class="c1"># Intensity value at the seed voxel</span>
</span><span id="NiftiViewer.automaticROI_drawing-2139"><a href="#NiftiViewer.automaticROI_drawing-2139"><span class="linenos">2139</span></a>        <span class="n">seed_intensity</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">]</span>
</span><span id="NiftiViewer.automaticROI_drawing-2140"><a href="#NiftiViewer.automaticROI_drawing-2140"><span class="linenos">2140</span></a>
</span><span id="NiftiViewer.automaticROI_drawing-2141"><a href="#NiftiViewer.automaticROI_drawing-2141"><span class="linenos">2141</span></a>        <span class="c1"># Convert radius in mm to radius in voxel units per axis</span>
</span><span id="NiftiViewer.automaticROI_drawing-2142"><a href="#NiftiViewer.automaticROI_drawing-2142"><span class="linenos">2142</span></a>        <span class="n">rx_vox</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">radius_mm</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="NiftiViewer.automaticROI_drawing-2143"><a href="#NiftiViewer.automaticROI_drawing-2143"><span class="linenos">2143</span></a>        <span class="n">ry_vox</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">radius_mm</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="NiftiViewer.automaticROI_drawing-2144"><a href="#NiftiViewer.automaticROI_drawing-2144"><span class="linenos">2144</span></a>        <span class="n">rz_vox</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">radius_mm</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span><span id="NiftiViewer.automaticROI_drawing-2145"><a href="#NiftiViewer.automaticROI_drawing-2145"><span class="linenos">2145</span></a>
</span><span id="NiftiViewer.automaticROI_drawing-2146"><a href="#NiftiViewer.automaticROI_drawing-2146"><span class="linenos">2146</span></a>        <span class="c1"># Compute subvolume limits (ROI bounding box)</span>
</span><span id="NiftiViewer.automaticROI_drawing-2147"><a href="#NiftiViewer.automaticROI_drawing-2147"><span class="linenos">2147</span></a>        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">rx_vox</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">rx_vox</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer.automaticROI_drawing-2148"><a href="#NiftiViewer.automaticROI_drawing-2148"><span class="linenos">2148</span></a>        <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">ry_vox</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">ry_vox</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer.automaticROI_drawing-2149"><a href="#NiftiViewer.automaticROI_drawing-2149"><span class="linenos">2149</span></a>        <span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">-</span> <span class="n">rz_vox</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">img_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">rz_vox</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer.automaticROI_drawing-2150"><a href="#NiftiViewer.automaticROI_drawing-2150"><span class="linenos">2150</span></a>
</span><span id="NiftiViewer.automaticROI_drawing-2151"><a href="#NiftiViewer.automaticROI_drawing-2151"><span class="linenos">2151</span></a>        <span class="c1"># Compute ROI mask using parallelized Numba function</span>
</span><span id="NiftiViewer.automaticROI_drawing-2152"><a href="#NiftiViewer.automaticROI_drawing-2152"><span class="linenos">2152</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">compute_mask_numba_mm</span><span class="p">(</span><span class="n">img_data</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span>
</span><span id="NiftiViewer.automaticROI_drawing-2153"><a href="#NiftiViewer.automaticROI_drawing-2153"><span class="linenos">2153</span></a>                                     <span class="n">radius_mm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel_sizes</span><span class="p">,</span>
</span><span id="NiftiViewer.automaticROI_drawing-2154"><a href="#NiftiViewer.automaticROI_drawing-2154"><span class="linenos">2154</span></a>                                     <span class="n">seed_intensity</span><span class="p">,</span> <span class="n">difference</span><span class="p">,</span>
</span><span id="NiftiViewer.automaticROI_drawing-2155"><a href="#NiftiViewer.automaticROI_drawing-2155"><span class="linenos">2155</span></a>                                     <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span><span class="p">)</span>
</span><span id="NiftiViewer.automaticROI_drawing-2156"><a href="#NiftiViewer.automaticROI_drawing-2156"><span class="linenos">2156</span></a>
</span><span id="NiftiViewer.automaticROI_drawing-2157"><a href="#NiftiViewer.automaticROI_drawing-2157"><span class="linenos">2157</span></a>        <span class="c1"># Store result as overlay for visualization</span>
</span><span id="NiftiViewer.automaticROI_drawing-2158"><a href="#NiftiViewer.automaticROI_drawing-2158"><span class="linenos">2158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="o">=</span> <span class="n">mask</span>
</span></pre></div>


            <div class="docstring"><p>Generate automatic ROI mask around selected seed voxel</p>
</div>


                            </div>
                            <div id="NiftiViewer.ROI_save" class="classattr">
                                        <input id="NiftiViewer.ROI_save-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ROI_save</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.ROI_save-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.ROI_save"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.ROI_save-2160"><a href="#NiftiViewer.ROI_save-2160"><span class="linenos">2160</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ROI_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.ROI_save-2161"><a href="#NiftiViewer.ROI_save-2161"><span class="linenos">2161</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the automatically generated ROI mask to disk&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.ROI_save-2162"><a href="#NiftiViewer.ROI_save-2162"><span class="linenos">2162</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Saving ROI mask to disk&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2163"><a href="#NiftiViewer.ROI_save-2163"><span class="linenos">2163</span></a>        <span class="n">original_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span>
</span><span id="NiftiViewer.ROI_save-2164"><a href="#NiftiViewer.ROI_save-2164"><span class="linenos">2164</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">original_path</span><span class="p">:</span>
</span><span id="NiftiViewer.ROI_save-2165"><a href="#NiftiViewer.ROI_save-2165"><span class="linenos">2165</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;No file loaded.&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2166"><a href="#NiftiViewer.ROI_save-2166"><span class="linenos">2166</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;No file loaded&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2167"><a href="#NiftiViewer.ROI_save-2167"><span class="linenos">2167</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer.ROI_save-2168"><a href="#NiftiViewer.ROI_save-2168"><span class="linenos">2168</span></a>        <span class="c1"># Retrieve workspace path from context</span>
</span><span id="NiftiViewer.ROI_save-2169"><a href="#NiftiViewer.ROI_save-2169"><span class="linenos">2169</span></a>        <span class="n">workspace_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workspace_path&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2170"><a href="#NiftiViewer.ROI_save-2170"><span class="linenos">2170</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">workspace_path</span><span class="p">:</span>
</span><span id="NiftiViewer.ROI_save-2171"><a href="#NiftiViewer.ROI_save-2171"><span class="linenos">2171</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;Workspace path is not set.&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2172"><a href="#NiftiViewer.ROI_save-2172"><span class="linenos">2172</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Workspace path not set&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2173"><a href="#NiftiViewer.ROI_save-2173"><span class="linenos">2173</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer.ROI_save-2174"><a href="#NiftiViewer.ROI_save-2174"><span class="linenos">2174</span></a>
</span><span id="NiftiViewer.ROI_save-2175"><a href="#NiftiViewer.ROI_save-2175"><span class="linenos">2175</span></a>        <span class="c1"># Try to infer subject identifier (sub-XX) from relative file path</span>
</span><span id="NiftiViewer.ROI_save-2176"><a href="#NiftiViewer.ROI_save-2176"><span class="linenos">2176</span></a>        <span class="n">relative_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">original_path</span><span class="p">,</span> <span class="n">workspace_path</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2177"><a href="#NiftiViewer.ROI_save-2177"><span class="linenos">2177</span></a>        <span class="n">parts</span> <span class="o">=</span> <span class="n">relative_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2178"><a href="#NiftiViewer.ROI_save-2178"><span class="linenos">2178</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NiftiViewer.ROI_save-2179"><a href="#NiftiViewer.ROI_save-2179"><span class="linenos">2179</span></a>            <span class="n">subject</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">part</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span> <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sub-&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.ROI_save-2180"><a href="#NiftiViewer.ROI_save-2180"><span class="linenos">2180</span></a>        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
</span><span id="NiftiViewer.ROI_save-2181"><a href="#NiftiViewer.ROI_save-2181"><span class="linenos">2181</span></a>            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;Could not determine subject from path.&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2182"><a href="#NiftiViewer.ROI_save-2182"><span class="linenos">2182</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not determine subject from path.&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2183"><a href="#NiftiViewer.ROI_save-2183"><span class="linenos">2183</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer.ROI_save-2184"><a href="#NiftiViewer.ROI_save-2184"><span class="linenos">2184</span></a>
</span><span id="NiftiViewer.ROI_save-2185"><a href="#NiftiViewer.ROI_save-2185"><span class="linenos">2185</span></a>
</span><span id="NiftiViewer.ROI_save-2186"><a href="#NiftiViewer.ROI_save-2186"><span class="linenos">2186</span></a>        <span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workspace_path</span><span class="p">,</span> <span class="s2">&quot;derivatives&quot;</span><span class="p">,</span> <span class="s2">&quot;manual_masks&quot;</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;anat&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2187"><a href="#NiftiViewer.ROI_save-2187"><span class="linenos">2187</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Save dir: </span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2188"><a href="#NiftiViewer.ROI_save-2188"><span class="linenos">2188</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">original_path</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2189"><a href="#NiftiViewer.ROI_save-2189"><span class="linenos">2189</span></a>        <span class="n">base_name</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nii.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nii&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2190"><a href="#NiftiViewer.ROI_save-2190"><span class="linenos">2190</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base filename: </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2191"><a href="#NiftiViewer.ROI_save-2191"><span class="linenos">2191</span></a>        <span class="c1"># Prepare filenames and output paths</span>
</span><span id="NiftiViewer.ROI_save-2192"><a href="#NiftiViewer.ROI_save-2192"><span class="linenos">2192</span></a>        <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_next_file_id</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2193"><a href="#NiftiViewer.ROI_save-2193"><span class="linenos">2193</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Obtained version: </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2194"><a href="#NiftiViewer.ROI_save-2194"><span class="linenos">2194</span></a>        <span class="n">new_base</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_ROI_v</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">_mask&quot;</span>
</span><span id="NiftiViewer.ROI_save-2195"><a href="#NiftiViewer.ROI_save-2195"><span class="linenos">2195</span></a>        <span class="n">new_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_base</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span>
</span><span id="NiftiViewer.ROI_save-2196"><a href="#NiftiViewer.ROI_save-2196"><span class="linenos">2196</span></a>
</span><span id="NiftiViewer.ROI_save-2197"><a href="#NiftiViewer.ROI_save-2197"><span class="linenos">2197</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Show confirmation dialog&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2198"><a href="#NiftiViewer.ROI_save-2198"><span class="linenos">2198</span></a>        <span class="c1"># Show confirmation dialog before saving</span>
</span><span id="NiftiViewer.ROI_save-2199"><a href="#NiftiViewer.ROI_save-2199"><span class="linenos">2199</span></a>        <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2200"><a href="#NiftiViewer.ROI_save-2200"><span class="linenos">2200</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Icon</span><span class="o">.</span><span class="n">Question</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2201"><a href="#NiftiViewer.ROI_save-2201"><span class="linenos">2201</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Confirm Save&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2202"><a href="#NiftiViewer.ROI_save-2202"><span class="linenos">2202</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Do you want to save the automatic ROI?&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2203"><a href="#NiftiViewer.ROI_save-2203"><span class="linenos">2203</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setInformativeText</span><span class="p">(</span>
</span><span id="NiftiViewer.ROI_save-2204"><a href="#NiftiViewer.ROI_save-2204"><span class="linenos">2204</span></a>            <span class="sa">f</span><span class="s2">&quot;File will be saved as:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="NiftiViewer.ROI_save-2205"><a href="#NiftiViewer.ROI_save-2205"><span class="linenos">2205</span></a>            <span class="sa">f</span><span class="s2">&quot;Location:</span><span class="se">\n</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="NiftiViewer.ROI_save-2206"><a href="#NiftiViewer.ROI_save-2206"><span class="linenos">2206</span></a>        <span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2207"><a href="#NiftiViewer.ROI_save-2207"><span class="linenos">2207</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2208"><a href="#NiftiViewer.ROI_save-2208"><span class="linenos">2208</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">setDefaultButton</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2209"><a href="#NiftiViewer.ROI_save-2209"><span class="linenos">2209</span></a>
</span><span id="NiftiViewer.ROI_save-2210"><a href="#NiftiViewer.ROI_save-2210"><span class="linenos">2210</span></a>        <span class="c1"># Wait for user response</span>
</span><span id="NiftiViewer.ROI_save-2211"><a href="#NiftiViewer.ROI_save-2211"><span class="linenos">2211</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
</span><span id="NiftiViewer.ROI_save-2212"><a href="#NiftiViewer.ROI_save-2212"><span class="linenos">2212</span></a>        <span class="k">if</span> <span class="n">response</span> <span class="o">!=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
</span><span id="NiftiViewer.ROI_save-2213"><a href="#NiftiViewer.ROI_save-2213"><span class="linenos">2213</span></a>            <span class="k">return</span>  <span class="c1"># User canceled</span>
</span><span id="NiftiViewer.ROI_save-2214"><a href="#NiftiViewer.ROI_save-2214"><span class="linenos">2214</span></a>
</span><span id="NiftiViewer.ROI_save-2215"><a href="#NiftiViewer.ROI_save-2215"><span class="linenos">2215</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Make dir&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2216"><a href="#NiftiViewer.ROI_save-2216"><span class="linenos">2216</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2217"><a href="#NiftiViewer.ROI_save-2217"><span class="linenos">2217</span></a>        <span class="n">full_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2218"><a href="#NiftiViewer.ROI_save-2218"><span class="linenos">2218</span></a>        <span class="n">json_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_base</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2219"><a href="#NiftiViewer.ROI_save-2219"><span class="linenos">2219</span></a>
</span><span id="NiftiViewer.ROI_save-2220"><a href="#NiftiViewer.ROI_save-2220"><span class="linenos">2220</span></a>        <span class="n">origin_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="NiftiViewer.ROI_save-2221"><a href="#NiftiViewer.ROI_save-2221"><span class="linenos">2221</span></a>
</span><span id="NiftiViewer.ROI_save-2222"><a href="#NiftiViewer.ROI_save-2222"><span class="linenos">2222</span></a>        <span class="n">total_ROI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2223"><a href="#NiftiViewer.ROI_save-2223"><span class="linenos">2223</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.ROI_save-2224"><a href="#NiftiViewer.ROI_save-2224"><span class="linenos">2224</span></a>            <span class="n">total_ROI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_thresholded_data</span><span class="p">,</span> <span class="n">total_ROI</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2225"><a href="#NiftiViewer.ROI_save-2225"><span class="linenos">2225</span></a>            <span class="n">origin_dict</span><span class="p">[</span><span class="s2">&quot;Original overlay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_file_path</span>
</span><span id="NiftiViewer.ROI_save-2226"><a href="#NiftiViewer.ROI_save-2226"><span class="linenos">2226</span></a>            <span class="n">origin_dict</span><span class="p">[</span><span class="s2">&quot;Original overlay threshold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold</span>
</span><span id="NiftiViewer.ROI_save-2227"><a href="#NiftiViewer.ROI_save-2227"><span class="linenos">2227</span></a>            
</span><span id="NiftiViewer.ROI_save-2228"><a href="#NiftiViewer.ROI_save-2228"><span class="linenos">2228</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span><span class="p">:</span>
</span><span id="NiftiViewer.ROI_save-2229"><a href="#NiftiViewer.ROI_save-2229"><span class="linenos">2229</span></a>            <span class="n">total_ROI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span><span class="p">,</span><span class="n">total_ROI</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2230"><a href="#NiftiViewer.ROI_save-2230"><span class="linenos">2230</span></a>            <span class="n">origin_dict</span><span class="p">[</span><span class="s2">&quot;Automatic drawing parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_origins</span>
</span><span id="NiftiViewer.ROI_save-2231"><a href="#NiftiViewer.ROI_save-2231"><span class="linenos">2231</span></a>
</span><span id="NiftiViewer.ROI_save-2232"><a href="#NiftiViewer.ROI_save-2232"><span class="linenos">2232</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span><span class="p">:</span>
</span><span id="NiftiViewer.ROI_save-2233"><a href="#NiftiViewer.ROI_save-2233"><span class="linenos">2233</span></a>            <span class="n">total_ROI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span><span class="p">,</span> <span class="n">total_ROI</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2234"><a href="#NiftiViewer.ROI_save-2234"><span class="linenos">2234</span></a>            <span class="n">new_params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="NiftiViewer.ROI_save-2235"><a href="#NiftiViewer.ROI_save-2235"><span class="linenos">2235</span></a>                <span class="s2">&quot;Seed&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_seed_coordinates</span><span class="p">),</span>  <span class="c1"># assicurati che sia JSON-safe</span>
</span><span id="NiftiViewer.ROI_save-2236"><a href="#NiftiViewer.ROI_save-2236"><span class="linenos">2236</span></a>                <span class="s2">&quot;Radius&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
</span><span id="NiftiViewer.ROI_save-2237"><a href="#NiftiViewer.ROI_save-2237"><span class="linenos">2237</span></a>                <span class="s2">&quot;Difference&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
</span><span id="NiftiViewer.ROI_save-2238"><a href="#NiftiViewer.ROI_save-2238"><span class="linenos">2238</span></a>            <span class="p">}</span>
</span><span id="NiftiViewer.ROI_save-2239"><a href="#NiftiViewer.ROI_save-2239"><span class="linenos">2239</span></a>            <span class="k">if</span> <span class="s2">&quot;Automatic drawing parameters&quot;</span> <span class="ow">in</span> <span class="n">origin_dict</span><span class="p">:</span>
</span><span id="NiftiViewer.ROI_save-2240"><a href="#NiftiViewer.ROI_save-2240"><span class="linenos">2240</span></a>                <span class="n">origin_dict</span><span class="p">[</span><span class="s2">&quot;Automatic drawing parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2241"><a href="#NiftiViewer.ROI_save-2241"><span class="linenos">2241</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.ROI_save-2242"><a href="#NiftiViewer.ROI_save-2242"><span class="linenos">2242</span></a>                <span class="n">origin_dict</span><span class="p">[</span><span class="s2">&quot;Automatic drawing parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_params</span><span class="p">]</span>
</span><span id="NiftiViewer.ROI_save-2243"><a href="#NiftiViewer.ROI_save-2243"><span class="linenos">2243</span></a>
</span><span id="NiftiViewer.ROI_save-2244"><a href="#NiftiViewer.ROI_save-2244"><span class="linenos">2244</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Start thread&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2245"><a href="#NiftiViewer.ROI_save-2245"><span class="linenos">2245</span></a>        <span class="c1"># Start threaded save operation</span>
</span><span id="NiftiViewer.ROI_save-2246"><a href="#NiftiViewer.ROI_save-2246"><span class="linenos">2246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SaveNiftiThread</span><span class="p">(</span><span class="n">total_ROI</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span>
</span><span id="NiftiViewer.ROI_save-2247"><a href="#NiftiViewer.ROI_save-2247"><span class="linenos">2247</span></a>                                            <span class="n">full_save_path</span><span class="p">,</span> <span class="n">json_save_path</span><span class="p">,</span>
</span><span id="NiftiViewer.ROI_save-2248"><a href="#NiftiViewer.ROI_save-2248"><span class="linenos">2248</span></a>                                            <span class="n">relative_path</span><span class="p">,</span> <span class="n">origin_dict</span><span class="p">))</span>
</span><span id="NiftiViewer.ROI_save-2249"><a href="#NiftiViewer.ROI_save-2249"><span class="linenos">2249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">success</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_ROI_saved</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2250"><a href="#NiftiViewer.ROI_save-2250"><span class="linenos">2250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_ROI_saving_error</span><span class="p">)</span>
</span><span id="NiftiViewer.ROI_save-2251"><a href="#NiftiViewer.ROI_save-2251"><span class="linenos">2251</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Save the automatically generated ROI mask to disk</p>
</div>


                            </div>
                            <div id="NiftiViewer.addOrigin_clicked" class="classattr">
                                        <input id="NiftiViewer.addOrigin_clicked-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">addOrigin_clicked</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.addOrigin_clicked-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.addOrigin_clicked"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.addOrigin_clicked-2297"><a href="#NiftiViewer.addOrigin_clicked-2297"><span class="linenos">2297</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">addOrigin_clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.addOrigin_clicked-2298"><a href="#NiftiViewer.addOrigin_clicked-2298"><span class="linenos">2298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="NiftiViewer.addOrigin_clicked-2299"><a href="#NiftiViewer.addOrigin_clicked-2299"><span class="linenos">2299</span></a>
</span><span id="NiftiViewer.addOrigin_clicked-2300"><a href="#NiftiViewer.addOrigin_clicked-2300"><span class="linenos">2300</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NiftiViewer.addOrigin_clicked-2301"><a href="#NiftiViewer.addOrigin_clicked-2301"><span class="linenos">2301</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="NiftiViewer.addOrigin_clicked-2302"><a href="#NiftiViewer.addOrigin_clicked-2302"><span class="linenos">2302</span></a>
</span><span id="NiftiViewer.addOrigin_clicked-2303"><a href="#NiftiViewer.addOrigin_clicked-2303"><span class="linenos">2303</span></a>        <span class="c1">#if self.overlay_enabled and self.overlay_data is not None:</span>
</span><span id="NiftiViewer.addOrigin_clicked-2304"><a href="#NiftiViewer.addOrigin_clicked-2304"><span class="linenos">2304</span></a>        <span class="c1">#    self.incrementalROI_data = np.logical_or(self.incrementalROI_data, self.overlay_data).astype(np.uint8)</span>
</span><span id="NiftiViewer.addOrigin_clicked-2305"><a href="#NiftiViewer.addOrigin_clicked-2305"><span class="linenos">2305</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.addOrigin_clicked-2306"><a href="#NiftiViewer.addOrigin_clicked-2306"><span class="linenos">2306</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.addOrigin_clicked-2307"><a href="#NiftiViewer.addOrigin_clicked-2307"><span class="linenos">2307</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_incrementalROI</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.addOrigin_clicked-2308"><a href="#NiftiViewer.addOrigin_clicked-2308"><span class="linenos">2308</span></a>
</span><span id="NiftiViewer.addOrigin_clicked-2309"><a href="#NiftiViewer.addOrigin_clicked-2309"><span class="linenos">2309</span></a>        <span class="n">new_params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="NiftiViewer.addOrigin_clicked-2310"><a href="#NiftiViewer.addOrigin_clicked-2310"><span class="linenos">2310</span></a>            <span class="s2">&quot;Seed&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_seed_coordinates</span><span class="p">),</span>
</span><span id="NiftiViewer.addOrigin_clicked-2311"><a href="#NiftiViewer.addOrigin_clicked-2311"><span class="linenos">2311</span></a>            <span class="s2">&quot;Radius&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_radius_slider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
</span><span id="NiftiViewer.addOrigin_clicked-2312"><a href="#NiftiViewer.addOrigin_clicked-2312"><span class="linenos">2312</span></a>            <span class="s2">&quot;Difference&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_diff_slider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
</span><span id="NiftiViewer.addOrigin_clicked-2313"><a href="#NiftiViewer.addOrigin_clicked-2313"><span class="linenos">2313</span></a>        <span class="p">}</span>
</span><span id="NiftiViewer.addOrigin_clicked-2314"><a href="#NiftiViewer.addOrigin_clicked-2314"><span class="linenos">2314</span></a>
</span><span id="NiftiViewer.addOrigin_clicked-2315"><a href="#NiftiViewer.addOrigin_clicked-2315"><span class="linenos">2315</span></a>        <span class="c1"># Mantieni lista incrementale</span>
</span><span id="NiftiViewer.addOrigin_clicked-2316"><a href="#NiftiViewer.addOrigin_clicked-2316"><span class="linenos">2316</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="NiftiViewer.toggle_incrementalROI" class="classattr">
                                        <input id="NiftiViewer.toggle_incrementalROI-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">toggle_incrementalROI</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">enabled</span>, </span><span class="param"><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.toggle_incrementalROI-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.toggle_incrementalROI"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.toggle_incrementalROI-2318"><a href="#NiftiViewer.toggle_incrementalROI-2318"><span class="linenos">2318</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_incrementalROI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">enabled</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="NiftiViewer.toggle_incrementalROI-2319"><a href="#NiftiViewer.toggle_incrementalROI-2319"><span class="linenos">2319</span></a>
</span><span id="NiftiViewer.toggle_incrementalROI-2320"><a href="#NiftiViewer.toggle_incrementalROI-2320"><span class="linenos">2320</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_enabled</span> <span class="o">=</span> <span class="n">enabled</span>
</span><span id="NiftiViewer.toggle_incrementalROI-2321"><a href="#NiftiViewer.toggle_incrementalROI-2321"><span class="linenos">2321</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_incrementalROI-2322"><a href="#NiftiViewer.toggle_incrementalROI-2322"><span class="linenos">2322</span></a>
</span><span id="NiftiViewer.toggle_incrementalROI-2323"><a href="#NiftiViewer.toggle_incrementalROI-2323"><span class="linenos">2323</span></a>        <span class="c1"># Enable or disable overlay-related UI controls</span>
</span><span id="NiftiViewer.toggle_incrementalROI-2324"><a href="#NiftiViewer.toggle_incrementalROI-2324"><span class="linenos">2324</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_incrementalROI-2325"><a href="#NiftiViewer.toggle_incrementalROI-2325"><span class="linenos">2325</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_alpha_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_incrementalROI-2326"><a href="#NiftiViewer.toggle_incrementalROI-2326"><span class="linenos">2326</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_slider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_incrementalROI-2327"><a href="#NiftiViewer.toggle_incrementalROI-2327"><span class="linenos">2327</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_threshold_spin</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_incrementalROI-2328"><a href="#NiftiViewer.toggle_incrementalROI-2328"><span class="linenos">2328</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_enabled</span><span class="p">)</span>
</span><span id="NiftiViewer.toggle_incrementalROI-2329"><a href="#NiftiViewer.toggle_incrementalROI-2329"><span class="linenos">2329</span></a>
</span><span id="NiftiViewer.toggle_incrementalROI-2330"><a href="#NiftiViewer.toggle_incrementalROI-2330"><span class="linenos">2330</span></a>        <span class="k">if</span> <span class="n">update_all</span><span class="p">:</span>
</span><span id="NiftiViewer.toggle_incrementalROI-2331"><a href="#NiftiViewer.toggle_incrementalROI-2331"><span class="linenos">2331</span></a>            <span class="c1"># Redraw display if overlay data is available</span>
</span><span id="NiftiViewer.toggle_incrementalROI-2332"><a href="#NiftiViewer.toggle_incrementalROI-2332"><span class="linenos">2332</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_all_displays</span><span class="p">()</span>
</span><span id="NiftiViewer.toggle_incrementalROI-2333"><a href="#NiftiViewer.toggle_incrementalROI-2333"><span class="linenos">2333</span></a>
</span><span id="NiftiViewer.toggle_incrementalROI-2334"><a href="#NiftiViewer.toggle_incrementalROI-2334"><span class="linenos">2334</span></a>            <span class="c1"># Update time series plot if available</span>
</span><span id="NiftiViewer.toggle_incrementalROI-2335"><a href="#NiftiViewer.toggle_incrementalROI-2335"><span class="linenos">2335</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_time_series_plot</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="NiftiViewer.closeEvent" class="classattr">
                                        <input id="NiftiViewer.closeEvent-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">closeEvent</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">event</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.closeEvent-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.closeEvent"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.closeEvent-2337"><a href="#NiftiViewer.closeEvent-2337"><span class="linenos">2337</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span id="NiftiViewer.closeEvent-2338"><a href="#NiftiViewer.closeEvent-2338"><span class="linenos">2338</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up on application exit&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.closeEvent-2339"><a href="#NiftiViewer.closeEvent-2339"><span class="linenos">2339</span></a>        <span class="c1"># Stop and delete all active threads</span>
</span><span id="NiftiViewer.closeEvent-2340"><a href="#NiftiViewer.closeEvent-2340"><span class="linenos">2340</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;threads&#39;</span><span class="p">):</span>
</span><span id="NiftiViewer.closeEvent-2341"><a href="#NiftiViewer.closeEvent-2341"><span class="linenos">2341</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
</span><span id="NiftiViewer.closeEvent-2342"><a href="#NiftiViewer.closeEvent-2342"><span class="linenos">2342</span></a>                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">isRunning</span><span class="p">():</span>
</span><span id="NiftiViewer.closeEvent-2343"><a href="#NiftiViewer.closeEvent-2343"><span class="linenos">2343</span></a>                    <span class="n">t</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="NiftiViewer.closeEvent-2344"><a href="#NiftiViewer.closeEvent-2344"><span class="linenos">2344</span></a>                    <span class="n">t</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</span><span id="NiftiViewer.closeEvent-2345"><a href="#NiftiViewer.closeEvent-2345"><span class="linenos">2345</span></a>                <span class="n">t</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
</span><span id="NiftiViewer.closeEvent-2346"><a href="#NiftiViewer.closeEvent-2346"><span class="linenos">2346</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="NiftiViewer.closeEvent-2347"><a href="#NiftiViewer.closeEvent-2347"><span class="linenos">2347</span></a>
</span><span id="NiftiViewer.closeEvent-2348"><a href="#NiftiViewer.closeEvent-2348"><span class="linenos">2348</span></a>        <span class="c1"># Clear large data arrays to release memory</span>
</span><span id="NiftiViewer.closeEvent-2349"><a href="#NiftiViewer.closeEvent-2349"><span class="linenos">2349</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">img_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.closeEvent-2350"><a href="#NiftiViewer.closeEvent-2350"><span class="linenos">2350</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.closeEvent-2351"><a href="#NiftiViewer.closeEvent-2351"><span class="linenos">2351</span></a>
</span><span id="NiftiViewer.closeEvent-2352"><a href="#NiftiViewer.closeEvent-2352"><span class="linenos">2352</span></a>        <span class="c1"># Trigger garbage collection</span>
</span><span id="NiftiViewer.closeEvent-2353"><a href="#NiftiViewer.closeEvent-2353"><span class="linenos">2353</span></a>        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="NiftiViewer.closeEvent-2354"><a href="#NiftiViewer.closeEvent-2354"><span class="linenos">2354</span></a>
</span><span id="NiftiViewer.closeEvent-2355"><a href="#NiftiViewer.closeEvent-2355"><span class="linenos">2355</span></a>        <span class="c1"># Accept the close event to exit</span>
</span><span id="NiftiViewer.closeEvent-2356"><a href="#NiftiViewer.closeEvent-2356"><span class="linenos">2356</span></a>        <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Clean up on application exit</p>
</div>


                            </div>
                            <div id="NiftiViewer.reset_overlay" class="classattr">
                                        <input id="NiftiViewer.reset_overlay-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reset_overlay</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.reset_overlay-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.reset_overlay"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.reset_overlay-2358"><a href="#NiftiViewer.reset_overlay-2358"><span class="linenos">2358</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset_overlay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.reset_overlay-2359"><a href="#NiftiViewer.reset_overlay-2359"><span class="linenos">2359</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset all overlay-related UI elements and internal variables.&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.reset_overlay-2360"><a href="#NiftiViewer.reset_overlay-2360"><span class="linenos">2360</span></a>        <span class="c1"># Disable the automatic ROI overlay mode</span>
</span><span id="NiftiViewer.reset_overlay-2361"><a href="#NiftiViewer.reset_overlay-2361"><span class="linenos">2361</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_overlay</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="NiftiViewer.reset_overlay-2362"><a href="#NiftiViewer.reset_overlay-2362"><span class="linenos">2362</span></a>        <span class="c1"># Disable the &quot;Save ROI&quot; button since theres no active overlay</span>
</span><span id="NiftiViewer.reset_overlay-2363"><a href="#NiftiViewer.reset_overlay-2363"><span class="linenos">2363</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.reset_overlay-2364"><a href="#NiftiViewer.reset_overlay-2364"><span class="linenos">2364</span></a>        <span class="c1"># Clear all overlay-related data</span>
</span><span id="NiftiViewer.reset_overlay-2365"><a href="#NiftiViewer.reset_overlay-2365"><span class="linenos">2365</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.reset_overlay-2366"><a href="#NiftiViewer.reset_overlay-2366"><span class="linenos">2366</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.reset_overlay-2367"><a href="#NiftiViewer.reset_overlay-2367"><span class="linenos">2367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_dims</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.reset_overlay-2368"><a href="#NiftiViewer.reset_overlay-2368"><span class="linenos">2368</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_file_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.reset_overlay-2369"><a href="#NiftiViewer.reset_overlay-2369"><span class="linenos">2369</span></a>        <span class="c1"># Hide and disable the overlay parameter sliders group (radius/difference)</span>
</span><span id="NiftiViewer.reset_overlay-2370"><a href="#NiftiViewer.reset_overlay-2370"><span class="linenos">2370</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.reset_overlay-2371"><a href="#NiftiViewer.reset_overlay-2371"><span class="linenos">2371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.reset_overlay-2372"><a href="#NiftiViewer.reset_overlay-2372"><span class="linenos">2372</span></a>        <span class="c1"># Ensure overlay visualization is turned off</span>
</span><span id="NiftiViewer.reset_overlay-2373"><a href="#NiftiViewer.reset_overlay-2373"><span class="linenos">2373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_overlay</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.reset_overlay-2374"><a href="#NiftiViewer.reset_overlay-2374"><span class="linenos">2374</span></a>        <span class="c1"># Disable and uncheck the overlay checkbox in UI</span>
</span><span id="NiftiViewer.reset_overlay-2375"><a href="#NiftiViewer.reset_overlay-2375"><span class="linenos">2375</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.reset_overlay-2376"><a href="#NiftiViewer.reset_overlay-2376"><span class="linenos">2376</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.reset_overlay-2377"><a href="#NiftiViewer.reset_overlay-2377"><span class="linenos">2377</span></a>        <span class="c1"># Reset overlay info label to default text</span>
</span><span id="NiftiViewer.reset_overlay-2378"><a href="#NiftiViewer.reset_overlay-2378"><span class="linenos">2378</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overlay_info_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
</span><span id="NiftiViewer.reset_overlay-2379"><a href="#NiftiViewer.reset_overlay-2379"><span class="linenos">2379</span></a>            <span class="sa">f</span><span class="s2">&quot;Overlay:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
</span><span id="NiftiViewer.reset_overlay-2380"><a href="#NiftiViewer.reset_overlay-2380"><span class="linenos">2380</span></a>            <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Dimensions&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.reset_overlay-2381"><a href="#NiftiViewer.reset_overlay-2381"><span class="linenos">2381</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Reset all overlay-related UI elements and internal variables.</p>
</div>


                            </div>
                            <div id="NiftiViewer.resetROI" class="classattr">
                                        <input id="NiftiViewer.resetROI-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">resetROI</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.resetROI-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.resetROI"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.resetROI-2383"><a href="#NiftiViewer.resetROI-2383"><span class="linenos">2383</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">resetROI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NiftiViewer.resetROI-2384"><a href="#NiftiViewer.resetROI-2384"><span class="linenos">2384</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset all ROI-related UI elements and internal variables.&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.resetROI-2385"><a href="#NiftiViewer.resetROI-2385"><span class="linenos">2385</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_save_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.resetROI-2386"><a href="#NiftiViewer.resetROI-2386"><span class="linenos">2386</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelROI_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.resetROI-2387"><a href="#NiftiViewer.resetROI-2387"><span class="linenos">2387</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addOrigin_btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.resetROI-2388"><a href="#NiftiViewer.resetROI-2388"><span class="linenos">2388</span></a>
</span><span id="NiftiViewer.resetROI-2389"><a href="#NiftiViewer.resetROI-2389"><span class="linenos">2389</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_incrementalROI</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.resetROI-2390"><a href="#NiftiViewer.resetROI-2390"><span class="linenos">2390</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.resetROI-2391"><a href="#NiftiViewer.resetROI-2391"><span class="linenos">2391</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.resetROI-2392"><a href="#NiftiViewer.resetROI-2392"><span class="linenos">2392</span></a>
</span><span id="NiftiViewer.resetROI-2393"><a href="#NiftiViewer.resetROI-2393"><span class="linenos">2393</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_automaticROI</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="n">update_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.resetROI-2394"><a href="#NiftiViewer.resetROI-2394"><span class="linenos">2394</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.resetROI-2395"><a href="#NiftiViewer.resetROI-2395"><span class="linenos">2395</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_checkbox</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.resetROI-2396"><a href="#NiftiViewer.resetROI-2396"><span class="linenos">2396</span></a>
</span><span id="NiftiViewer.resetROI-2397"><a href="#NiftiViewer.resetROI-2397"><span class="linenos">2397</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.resetROI-2398"><a href="#NiftiViewer.resetROI-2398"><span class="linenos">2398</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_data</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NiftiViewer.resetROI-2399"><a href="#NiftiViewer.resetROI-2399"><span class="linenos">2399</span></a>
</span><span id="NiftiViewer.resetROI-2400"><a href="#NiftiViewer.resetROI-2400"><span class="linenos">2400</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.resetROI-2401"><a href="#NiftiViewer.resetROI-2401"><span class="linenos">2401</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROI_sliders_group</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="NiftiViewer.resetROI-2402"><a href="#NiftiViewer.resetROI-2402"><span class="linenos">2402</span></a>
</span><span id="NiftiViewer.resetROI-2403"><a href="#NiftiViewer.resetROI-2403"><span class="linenos">2403</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s2">&quot;NIfTIViewer&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic ROI&quot;</span><span class="p">))</span>
</span><span id="NiftiViewer.resetROI-2404"><a href="#NiftiViewer.resetROI-2404"><span class="linenos">2404</span></a>
</span><span id="NiftiViewer.resetROI-2405"><a href="#NiftiViewer.resetROI-2405"><span class="linenos">2405</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">automaticROIbtn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NiftiViewer.resetROI-2406"><a href="#NiftiViewer.resetROI-2406"><span class="linenos">2406</span></a>
</span><span id="NiftiViewer.resetROI-2407"><a href="#NiftiViewer.resetROI-2407"><span class="linenos">2407</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">incrementalROI_origins</span> <span class="o">=</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>Reset all ROI-related UI elements and internal variables.</p>
</div>


                            </div>
                            <div id="NiftiViewer.pad_volume_to_shape" class="classattr">
                                        <input id="NiftiViewer.pad_volume_to_shape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pad_volume_to_shape</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">volume</span>, </span><span class="param"><span class="n">target_shape</span>, </span><span class="param"><span class="n">constant_value</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.pad_volume_to_shape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.pad_volume_to_shape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.pad_volume_to_shape-2411"><a href="#NiftiViewer.pad_volume_to_shape-2411"><span class="linenos">2411</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pad_volume_to_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">,</span> <span class="n">constant_value</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2412"><a href="#NiftiViewer.pad_volume_to_shape-2412"><span class="linenos">2412</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2413"><a href="#NiftiViewer.pad_volume_to_shape-2413"><span class="linenos">2413</span></a><span class="sd">        Pad a 3D volume (NumPy array) symmetrically to match a desired target shape.</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2414"><a href="#NiftiViewer.pad_volume_to_shape-2414"><span class="linenos">2414</span></a>
</span><span id="NiftiViewer.pad_volume_to_shape-2415"><a href="#NiftiViewer.pad_volume_to_shape-2415"><span class="linenos">2415</span></a><span class="sd">        Args:</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2416"><a href="#NiftiViewer.pad_volume_to_shape-2416"><span class="linenos">2416</span></a><span class="sd">            volume (np.ndarray): Input 3D volume to pad.</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2417"><a href="#NiftiViewer.pad_volume_to_shape-2417"><span class="linenos">2417</span></a><span class="sd">            target_shape (tuple[int]): Desired (X, Y, Z) dimensions after padding.</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2418"><a href="#NiftiViewer.pad_volume_to_shape-2418"><span class="linenos">2418</span></a><span class="sd">            constant_value (int or float, optional): Value used for padding. Defaults to 0.</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2419"><a href="#NiftiViewer.pad_volume_to_shape-2419"><span class="linenos">2419</span></a>
</span><span id="NiftiViewer.pad_volume_to_shape-2420"><a href="#NiftiViewer.pad_volume_to_shape-2420"><span class="linenos">2420</span></a><span class="sd">        Returns:</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2421"><a href="#NiftiViewer.pad_volume_to_shape-2421"><span class="linenos">2421</span></a><span class="sd">            np.ndarray: The padded 3D array with dimensions matching target_shape.</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2422"><a href="#NiftiViewer.pad_volume_to_shape-2422"><span class="linenos">2422</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2423"><a href="#NiftiViewer.pad_volume_to_shape-2423"><span class="linenos">2423</span></a>        <span class="n">current_shape</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">shape</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2424"><a href="#NiftiViewer.pad_volume_to_shape-2424"><span class="linenos">2424</span></a>        <span class="n">pads</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store pad widths for each axis</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2425"><a href="#NiftiViewer.pad_volume_to_shape-2425"><span class="linenos">2425</span></a>
</span><span id="NiftiViewer.pad_volume_to_shape-2426"><a href="#NiftiViewer.pad_volume_to_shape-2426"><span class="linenos">2426</span></a>        <span class="c1"># Compute symmetric padding for each axis</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2427"><a href="#NiftiViewer.pad_volume_to_shape-2427"><span class="linenos">2427</span></a>        <span class="k">for</span> <span class="n">cur</span><span class="p">,</span> <span class="n">tgt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">current_shape</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">):</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2428"><a href="#NiftiViewer.pad_volume_to_shape-2428"><span class="linenos">2428</span></a>            <span class="n">diff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tgt</span> <span class="o">-</span> <span class="n">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Calculate missing voxels along this axis</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2429"><a href="#NiftiViewer.pad_volume_to_shape-2429"><span class="linenos">2429</span></a>            <span class="n">pad_before</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># Padding before the data</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2430"><a href="#NiftiViewer.pad_volume_to_shape-2430"><span class="linenos">2430</span></a>            <span class="n">pad_after</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">-</span> <span class="n">pad_before</span>  <span class="c1"># Padding after the data</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2431"><a href="#NiftiViewer.pad_volume_to_shape-2431"><span class="linenos">2431</span></a>            <span class="n">pads</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pad_before</span><span class="p">,</span> <span class="n">pad_after</span><span class="p">))</span>  <span class="c1"># Add as (before, after) pair</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2432"><a href="#NiftiViewer.pad_volume_to_shape-2432"><span class="linenos">2432</span></a>
</span><span id="NiftiViewer.pad_volume_to_shape-2433"><a href="#NiftiViewer.pad_volume_to_shape-2433"><span class="linenos">2433</span></a>        <span class="c1"># Apply constant padding and return result</span>
</span><span id="NiftiViewer.pad_volume_to_shape-2434"><a href="#NiftiViewer.pad_volume_to_shape-2434"><span class="linenos">2434</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">volume</span><span class="p">,</span> <span class="n">pads</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="n">constant_value</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Pad a 3D volume (NumPy array) symmetrically to match a desired target shape.</p>

<p>Args:
    volume (np.ndarray): Input 3D volume to pad.
    target_shape (tuple[int]): Desired (X, Y, Z) dimensions after padding.
    constant_value (int or float, optional): Value used for padding. Defaults to 0.</p>

<p>Returns:
    np.ndarray: The padded 3D array with dimensions matching target_shape.</p>
</div>


                            </div>
                            <div id="NiftiViewer.handle_scroll" class="classattr">
                                        <input id="NiftiViewer.handle_scroll-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">handle_scroll</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">plane_idx</span>, </span><span class="param"><span class="n">delta</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NiftiViewer.handle_scroll-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NiftiViewer.handle_scroll"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NiftiViewer.handle_scroll-2436"><a href="#NiftiViewer.handle_scroll-2436"><span class="linenos">2436</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_scroll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">plane_idx</span><span class="p">,</span><span class="n">delta</span><span class="p">):</span>
</span><span id="NiftiViewer.handle_scroll-2437"><a href="#NiftiViewer.handle_scroll-2437"><span class="linenos">2437</span></a>        <span class="k">if</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Axial (XY plane)</span>
</span><span id="NiftiViewer.handle_scroll-2438"><a href="#NiftiViewer.handle_scroll-2438"><span class="linenos">2438</span></a>            <span class="k">if</span> <span class="n">delta</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="NiftiViewer.handle_scroll-2439"><a href="#NiftiViewer.handle_scroll-2439"><span class="linenos">2439</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer.handle_scroll-2440"><a href="#NiftiViewer.handle_scroll-2440"><span class="linenos">2440</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer.handle_scroll-2441"><a href="#NiftiViewer.handle_scroll-2441"><span class="linenos">2441</span></a>            <span class="k">elif</span> <span class="n">delta</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="NiftiViewer.handle_scroll-2442"><a href="#NiftiViewer.handle_scroll-2442"><span class="linenos">2442</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.handle_scroll-2443"><a href="#NiftiViewer.handle_scroll-2443"><span class="linenos">2443</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.handle_scroll-2444"><a href="#NiftiViewer.handle_scroll-2444"><span class="linenos">2444</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.handle_scroll-2445"><a href="#NiftiViewer.handle_scroll-2445"><span class="linenos">2445</span></a>                <span class="k">return</span>
</span><span id="NiftiViewer.handle_scroll-2446"><a href="#NiftiViewer.handle_scroll-2446"><span class="linenos">2446</span></a>        <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Coronal (XZ plane)</span>
</span><span id="NiftiViewer.handle_scroll-2447"><a href="#NiftiViewer.handle_scroll-2447"><span class="linenos">2447</span></a>            <span class="k">if</span> <span class="n">delta</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="NiftiViewer.handle_scroll-2448"><a href="#NiftiViewer.handle_scroll-2448"><span class="linenos">2448</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer.handle_scroll-2449"><a href="#NiftiViewer.handle_scroll-2449"><span class="linenos">2449</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer.handle_scroll-2450"><a href="#NiftiViewer.handle_scroll-2450"><span class="linenos">2450</span></a>            <span class="k">elif</span> <span class="n">delta</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="NiftiViewer.handle_scroll-2451"><a href="#NiftiViewer.handle_scroll-2451"><span class="linenos">2451</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.handle_scroll-2452"><a href="#NiftiViewer.handle_scroll-2452"><span class="linenos">2452</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.handle_scroll-2453"><a href="#NiftiViewer.handle_scroll-2453"><span class="linenos">2453</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.handle_scroll-2454"><a href="#NiftiViewer.handle_scroll-2454"><span class="linenos">2454</span></a>                <span class="k">return</span>
</span><span id="NiftiViewer.handle_scroll-2455"><a href="#NiftiViewer.handle_scroll-2455"><span class="linenos">2455</span></a>        <span class="k">elif</span> <span class="n">plane_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sagittal (YZ plane)</span>
</span><span id="NiftiViewer.handle_scroll-2456"><a href="#NiftiViewer.handle_scroll-2456"><span class="linenos">2456</span></a>            <span class="k">if</span> <span class="n">delta</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="NiftiViewer.handle_scroll-2457"><a href="#NiftiViewer.handle_scroll-2457"><span class="linenos">2457</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer.handle_scroll-2458"><a href="#NiftiViewer.handle_scroll-2458"><span class="linenos">2458</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NiftiViewer.handle_scroll-2459"><a href="#NiftiViewer.handle_scroll-2459"><span class="linenos">2459</span></a>            <span class="k">elif</span> <span class="n">delta</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="NiftiViewer.handle_scroll-2460"><a href="#NiftiViewer.handle_scroll-2460"><span class="linenos">2460</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.handle_scroll-2461"><a href="#NiftiViewer.handle_scroll-2461"><span class="linenos">2461</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NiftiViewer.handle_scroll-2462"><a href="#NiftiViewer.handle_scroll-2462"><span class="linenos">2462</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.handle_scroll-2463"><a href="#NiftiViewer.handle_scroll-2463"><span class="linenos">2463</span></a>                <span class="k">return</span>
</span><span id="NiftiViewer.handle_scroll-2464"><a href="#NiftiViewer.handle_scroll-2464"><span class="linenos">2464</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NiftiViewer.handle_scroll-2465"><a href="#NiftiViewer.handle_scroll-2465"><span class="linenos">2465</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Plane index out of range&quot;</span><span class="p">)</span>
</span><span id="NiftiViewer.handle_scroll-2466"><a href="#NiftiViewer.handle_scroll-2466"><span class="linenos">2466</span></a>            <span class="k">return</span>
</span><span id="NiftiViewer.handle_scroll-2467"><a href="#NiftiViewer.handle_scroll-2467"><span class="linenos">2467</span></a>            <span class="c1"># Synchronize controls for all planes</span>
</span><span id="NiftiViewer.handle_scroll-2468"><a href="#NiftiViewer.handle_scroll-2468"><span class="linenos">2468</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="NiftiViewer.handle_scroll-2469"><a href="#NiftiViewer.handle_scroll-2469"><span class="linenos">2469</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_sliders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="NiftiViewer.handle_scroll-2470"><a href="#NiftiViewer.handle_scroll-2470"><span class="linenos">2470</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">slice_spins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_slices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="NiftiViewer.handle_scroll-2471"><a href="#NiftiViewer.handle_scroll-2471"><span class="linenos">2471</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_cross_view_lines</span><span class="p">()</span>
</span><span id="NiftiViewer.handle_scroll-2472"><a href="#NiftiViewer.handle_scroll-2472"><span class="linenos">2472</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_coordinate_displays</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>